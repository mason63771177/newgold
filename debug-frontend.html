<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>前端激活调试页面</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .debug-section {
            background: white;
            padding: 20px;
            margin: 10px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .debug-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }
        .debug-content {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .success {
            color: #28a745;
        }
        .error {
            color: #dc3545;
        }
    </style>
</head>
<body>
    <h1>前端激活功能调试</h1>
    
    <div class="debug-section">
        <div class="debug-title">1. 检查Token状态</div>
        <div class="debug-content" id="tokenStatus">点击下方按钮检查token...</div>
        <button onclick="checkToken()">检查Token</button>
    </div>
    
    <div class="debug-section">
        <div class="debug-title">2. 测试激活API调用</div>
        <div class="debug-content" id="apiResult">点击下方按钮测试API...</div>
        <button onclick="testActivationAPI()">测试激活API</button>
    </div>
    
    <div class="debug-section">
        <div class="debug-title">3. 设置测试Token</div>
        <div class="debug-content">
            <button onclick="setTestToken()">设置测试Token到localStorage</button>
            <button onclick="clearToken()">清除Token</button>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:3000';
        
        // 获取认证token
        function getAuthToken() {
            return localStorage.getItem('token') || localStorage.getItem('authToken');
        }
        
        // 检查token状态
        function checkToken() {
            const tokenEl = document.getElementById('tokenStatus');
            
            const token = localStorage.getItem('token');
            const authToken = localStorage.getItem('authToken');
            const currentToken = getAuthToken();
            
            let status = '';
            status += `localStorage.getItem('token'): ${token ? '存在' : '不存在'}\n`;
            status += `localStorage.getItem('authToken'): ${authToken ? '存在' : '不存在'}\n`;
            status += `getAuthToken()返回: ${currentToken ? '有效token' : '无token'}\n\n`;
            
            if (currentToken) {
                status += `当前token: ${currentToken.substring(0, 50)}...\n`;
                status += `token长度: ${currentToken.length}\n`;
                
                // 尝试解析JWT
                try {
                    const parts = currentToken.split('.');
                    if (parts.length === 3) {
                        const payload = JSON.parse(atob(parts[1]));
                        status += `JWT payload: ${JSON.stringify(payload, null, 2)}\n`;
                        
                        const now = Math.floor(Date.now() / 1000);
                        if (payload.exp && payload.exp < now) {
                            status += `⚠️ Token已过期!\n`;
                        } else {
                            status += `✅ Token有效\n`;
                        }
                    }
                } catch (e) {
                    status += `❌ Token格式无效: ${e.message}\n`;
                }
            } else {
                status += `❌ 没有找到有效的token\n`;
            }
            
            tokenEl.textContent = status;
        }
        
        // API请求封装
        async function apiRequest(endpoint, options = {}) {
            const token = getAuthToken();
            const url = `${API_BASE_URL}/api${endpoint}`;
            
            const config = {
                headers: {
                    'Content-Type': 'application/json',
                    ...(token && { 'Authorization': `Bearer ${token}` })
                },
                ...options
            };
            
            console.log('发送请求到:', url);
            console.log('请求配置:', config);
            
            try {
                const response = await fetch(url, config);
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.message || `HTTP error! status: ${response.status}`);
                }
                
                return data;
            } catch (error) {
                console.error('API请求失败:', error);
                throw error;
            }
        }
        
        // 测试激活API
        async function testActivationAPI() {
            const resultEl = document.getElementById('apiResult');
            resultEl.textContent = '正在测试激活API...';
            
            try {
                const response = await apiRequest('/activation/activate', {
                    method: 'POST'
                });
                
                if (response.success && response.data) {
                    let result = '✅ 激活API调用成功!\n\n';
                    result += `响应数据:\n${JSON.stringify(response.data, null, 2)}`;
                    resultEl.textContent = result;
                    resultEl.className = 'debug-content success';
                } else {
                    let result = '❌ 激活API返回失败\n\n';
                    result += `响应: ${JSON.stringify(response, null, 2)}`;
                    resultEl.textContent = result;
                    resultEl.className = 'debug-content error';
                }
                
            } catch (error) {
                let result = '❌ 激活API调用失败\n\n';
                result += `错误信息: ${error.message}\n`;
                result += `错误类型: ${error.name}\n`;
                result += `完整错误: ${JSON.stringify(error, Object.getOwnPropertyNames(error), 2)}`;
                resultEl.textContent = result;
                resultEl.className = 'debug-content error';
            }
        }
        
        // 设置测试token
        function setTestToken() {
            // 使用生成的有效JWT token
            const validToken = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOiJ0ZXN0LXVzZXItMTIzIiwidXNlcm5hbWUiOiJ0ZXN0dXNlciIsImVtYWlsIjoidGVzdEBleGFtcGxlLmNvbSIsInJvbGUiOiJ1c2VyIiwiaWF0IjoxNzU5MzcwMTc2LCJleHAiOjE3NTk0NTY1NzYsImlzcyI6ImdvbGQ3LXN5c3RlbSJ9.Au5iKFykMC8_BNCWN27OzMngDrpsunZOC7jo_0O3Rgc";
            localStorage.setItem('token', validToken);
            alert('✅ 有效测试Token已设置到localStorage');
            checkToken();
        }
        
        // 清除token
        function clearToken() {
            localStorage.removeItem('token');
            localStorage.removeItem('authToken');
            alert('Token已清除');
            checkToken();
        }
        
        // 页面加载时自动检查token
        window.onload = function() {
            checkToken();
        };
    </script>
</body>
</html>