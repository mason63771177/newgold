# ğŸ” ç®¡ç†åå°å®‰å…¨å’Œæƒé™ç³»ç»Ÿè®¾è®¡

## æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è®¾è®¡äº†æ•°å­—é’±åŒ…ç®¡ç†åå°çš„å®‰å…¨å’Œæƒé™ç³»ç»Ÿï¼Œé‡‡ç”¨åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶(RBAC)æ¨¡å‹ï¼Œç»“åˆå¤šå±‚å®‰å…¨é˜²æŠ¤æœºåˆ¶ï¼Œç¡®ä¿ç®¡ç†åå°ç³»ç»Ÿçš„å®‰å…¨æ€§ã€å¯æ§æ€§å’Œåˆè§„æ€§ã€‚

## å®‰å…¨æ¶æ„è®¾è®¡

### 1. å¤šå±‚å®‰å…¨é˜²æŠ¤æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç½‘ç»œå®‰å…¨å±‚                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚   é˜²ç«å¢™    â”‚  â”‚   WAFé˜²æŠ¤   â”‚  â”‚  DDoSé˜²æŠ¤   â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åº”ç”¨å®‰å…¨å±‚                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  APIç½‘å…³    â”‚  â”‚  é€Ÿç‡é™åˆ¶   â”‚  â”‚  è¯·æ±‚éªŒè¯   â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    è®¤è¯æˆæƒå±‚                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  èº«ä»½è®¤è¯   â”‚  â”‚  æƒé™éªŒè¯   â”‚  â”‚  ä¼šè¯ç®¡ç†   â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ•°æ®å®‰å…¨å±‚                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  æ•°æ®åŠ å¯†   â”‚  â”‚  æ•°æ®è„±æ•   â”‚  â”‚  å®¡è®¡æ—¥å¿—   â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. æ ¸å¿ƒå®‰å…¨ç»„ä»¶

#### èº«ä»½è®¤è¯æœåŠ¡ (Authentication Service)
```javascript
/**
 * èº«ä»½è®¤è¯æœåŠ¡
 * æ”¯æŒå¤šç§è®¤è¯æ–¹å¼ï¼šç”¨æˆ·åå¯†ç ã€åŒå› ç´ è®¤è¯ã€SSO
 */
class AuthenticationService {
  /**
   * ç”¨æˆ·ç™»å½•è®¤è¯
   * @param {string} username - ç”¨æˆ·å
   * @param {string} password - å¯†ç 
   * @param {string} totpCode - TOTPéªŒè¯ç (å¯é€‰)
   * @returns {Object} è®¤è¯ç»“æœ
   */
  async authenticate(username, password, totpCode = null) {
    // 1. åŸºç¡€è®¤è¯
    const user = await this.validateCredentials(username, password);
    if (!user) {
      throw new AuthenticationError('ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯');
    }
    
    // 2. è´¦æˆ·çŠ¶æ€æ£€æŸ¥
    if (user.status !== 'active') {
      throw new AuthenticationError('è´¦æˆ·å·²è¢«ç¦ç”¨');
    }
    
    // 3. åŒå› ç´ è®¤è¯
    if (user.twoFactorEnabled && !totpCode) {
      throw new TwoFactorRequiredError('éœ€è¦åŒå› ç´ è®¤è¯');
    }
    
    if (user.twoFactorEnabled) {
      const isValidTotp = await this.verifyTOTP(user.id, totpCode);
      if (!isValidTotp) {
        throw new AuthenticationError('åŒå› ç´ è®¤è¯ç é”™è¯¯');
      }
    }
    
    // 4. ç™»å½•é™åˆ¶æ£€æŸ¥
    await this.checkLoginRestrictions(user.id);
    
    // 5. ç”Ÿæˆè®¿é—®ä»¤ç‰Œ
    const tokens = await this.generateTokens(user);
    
    // 6. è®°å½•ç™»å½•æ—¥å¿—
    await this.logLoginAttempt(user.id, 'success');
    
    return {
      user: this.sanitizeUserData(user),
      tokens,
      permissions: await this.getUserPermissions(user.id)
    };
  }
  
  /**
   * éªŒè¯è®¿é—®ä»¤ç‰Œ
   * @param {string} token - JWTä»¤ç‰Œ
   * @returns {Object} ç”¨æˆ·ä¿¡æ¯å’Œæƒé™
   */
  async verifyToken(token) {
    try {
      const decoded = jwt.verify(token, process.env.JWT_SECRET);
      
      // æ£€æŸ¥ä»¤ç‰Œæ˜¯å¦åœ¨é»‘åå•ä¸­
      const isBlacklisted = await redis.get(`blacklist:${token}`);
      if (isBlacklisted) {
        throw new TokenError('ä»¤ç‰Œå·²å¤±æ•ˆ');
      }
      
      // è·å–ç”¨æˆ·æœ€æ–°ä¿¡æ¯
      const user = await User.findById(decoded.userId);
      if (!user || user.status !== 'active') {
        throw new TokenError('ç”¨æˆ·ä¸å­˜åœ¨æˆ–å·²è¢«ç¦ç”¨');
      }
      
      return {
        user: this.sanitizeUserData(user),
        permissions: await this.getUserPermissions(user.id)
      };
      
    } catch (error) {
      throw new TokenError('ä»¤ç‰ŒéªŒè¯å¤±è´¥');
    }
  }
}
```

#### æƒé™ç®¡ç†æœåŠ¡ (Authorization Service)
```javascript
/**
 * æƒé™ç®¡ç†æœåŠ¡
 * å®ç°RBACæƒé™æ§åˆ¶æ¨¡å‹
 */
class AuthorizationService {
  /**
   * æ£€æŸ¥ç”¨æˆ·æƒé™
   * @param {number} userId - ç”¨æˆ·ID
   * @param {string} permission - æƒé™æ ‡è¯†
   * @param {Object} context - ä¸Šä¸‹æ–‡ä¿¡æ¯
   * @returns {boolean} æ˜¯å¦æœ‰æƒé™
   */
  async checkPermission(userId, permission, context = {}) {
    // 1. è·å–ç”¨æˆ·è§’è‰²
    const userRoles = await this.getUserRoles(userId);
    
    // 2. è·å–è§’è‰²æƒé™
    const rolePermissions = await this.getRolePermissions(userRoles);
    
    // 3. æ£€æŸ¥ç›´æ¥æƒé™
    if (rolePermissions.includes(permission)) {
      return true;
    }
    
    // 4. æ£€æŸ¥ä¸Šä¸‹æ–‡æƒé™
    const contextPermissions = await this.getContextPermissions(
      userId, permission, context
    );
    
    return contextPermissions.some(p => p.permission === permission);
  }
  
  /**
   * è·å–ç”¨æˆ·æ‰€æœ‰æƒé™
   * @param {number} userId - ç”¨æˆ·ID
   * @returns {Array} æƒé™åˆ—è¡¨
   */
  async getUserPermissions(userId) {
    const cacheKey = `user_permissions:${userId}`;
    
    // å°è¯•ä»ç¼“å­˜è·å–
    let permissions = await redis.get(cacheKey);
    if (permissions) {
      return JSON.parse(permissions);
    }
    
    // ä»æ•°æ®åº“è·å–
    const query = `
      SELECT DISTINCT p.code, p.name, p.resource, p.action
      FROM permissions p
      JOIN role_permissions rp ON p.id = rp.permission_id
      JOIN user_roles ur ON rp.role_id = ur.role_id
      WHERE ur.user_id = ? AND ur.status = 'active'
      AND p.status = 'active'
    `;
    
    permissions = await db.query(query, [userId]);
    
    // ç¼“å­˜æƒé™ä¿¡æ¯(5åˆ†é’Ÿ)
    await redis.setex(cacheKey, 300, JSON.stringify(permissions));
    
    return permissions;
  }
  
  /**
   * æƒé™éªŒè¯ä¸­é—´ä»¶
   * @param {string} permission - éœ€è¦çš„æƒé™
   * @returns {Function} Expressä¸­é—´ä»¶
   */
  requirePermission(permission) {
    return async (req, res, next) => {
      try {
        const hasPermission = await this.checkPermission(
          req.user.id, 
          permission, 
          req.context
        );
        
        if (!hasPermission) {
          return res.status(403).json({
            success: false,
            code: 403,
            message: 'æƒé™ä¸è¶³',
            error: {
              type: 'PERMISSION_DENIED',
              permission: permission
            }
          });
        }
        
        next();
      } catch (error) {
        return res.status(500).json({
          success: false,
          code: 500,
          message: 'æƒé™éªŒè¯å¤±è´¥'
        });
      }
    };
  }
}
```

## RBACæƒé™æ¨¡å‹è®¾è®¡

### 1. æ•°æ®åº“è¡¨ç»“æ„

#### ç”¨æˆ·è¡¨ (admin_users)
```sql
CREATE TABLE admin_users (
  id INT PRIMARY KEY AUTO_INCREMENT,
  username VARCHAR(50) UNIQUE NOT NULL COMMENT 'ç”¨æˆ·å',
  email VARCHAR(100) UNIQUE NOT NULL COMMENT 'é‚®ç®±',
  password_hash VARCHAR(255) NOT NULL COMMENT 'å¯†ç å“ˆå¸Œ',
  salt VARCHAR(32) NOT NULL COMMENT 'å¯†ç ç›å€¼',
  real_name VARCHAR(50) COMMENT 'çœŸå®å§“å',
  phone VARCHAR(20) COMMENT 'æ‰‹æœºå·',
  avatar_url VARCHAR(255) COMMENT 'å¤´åƒURL',
  status ENUM('active', 'inactive', 'locked') DEFAULT 'active' COMMENT 'çŠ¶æ€',
  two_factor_enabled BOOLEAN DEFAULT FALSE COMMENT 'æ˜¯å¦å¯ç”¨åŒå› ç´ è®¤è¯',
  two_factor_secret VARCHAR(32) COMMENT 'åŒå› ç´ è®¤è¯å¯†é’¥',
  last_login_at TIMESTAMP COMMENT 'æœ€åç™»å½•æ—¶é—´',
  last_login_ip VARCHAR(45) COMMENT 'æœ€åç™»å½•IP',
  login_attempts INT DEFAULT 0 COMMENT 'ç™»å½•å°è¯•æ¬¡æ•°',
  locked_until TIMESTAMP NULL COMMENT 'é”å®šåˆ°æœŸæ—¶é—´',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  created_by INT COMMENT 'åˆ›å»ºè€…ID',
  
  INDEX idx_username (username),
  INDEX idx_email (email),
  INDEX idx_status (status),
  INDEX idx_last_login (last_login_at)
) COMMENT 'ç®¡ç†å‘˜ç”¨æˆ·è¡¨';
```

#### è§’è‰²è¡¨ (admin_roles)
```sql
CREATE TABLE admin_roles (
  id INT PRIMARY KEY AUTO_INCREMENT,
  code VARCHAR(50) UNIQUE NOT NULL COMMENT 'è§’è‰²ä»£ç ',
  name VARCHAR(100) NOT NULL COMMENT 'è§’è‰²åç§°',
  description TEXT COMMENT 'è§’è‰²æè¿°',
  level INT DEFAULT 0 COMMENT 'è§’è‰²çº§åˆ«(æ•°å­—è¶Šå¤§æƒé™è¶Šé«˜)',
  status ENUM('active', 'inactive') DEFAULT 'active' COMMENT 'çŠ¶æ€',
  is_system BOOLEAN DEFAULT FALSE COMMENT 'æ˜¯å¦ç³»ç»Ÿè§’è‰²',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  created_by INT COMMENT 'åˆ›å»ºè€…ID',
  
  INDEX idx_code (code),
  INDEX idx_status (status),
  INDEX idx_level (level)
) COMMENT 'ç®¡ç†å‘˜è§’è‰²è¡¨';
```

#### æƒé™è¡¨ (admin_permissions)
```sql
CREATE TABLE admin_permissions (
  id INT PRIMARY KEY AUTO_INCREMENT,
  code VARCHAR(100) UNIQUE NOT NULL COMMENT 'æƒé™ä»£ç ',
  name VARCHAR(100) NOT NULL COMMENT 'æƒé™åç§°',
  description TEXT COMMENT 'æƒé™æè¿°',
  resource VARCHAR(50) NOT NULL COMMENT 'èµ„æºç±»å‹',
  action VARCHAR(50) NOT NULL COMMENT 'æ“ä½œç±»å‹',
  module VARCHAR(50) NOT NULL COMMENT 'æ‰€å±æ¨¡å—',
  status ENUM('active', 'inactive') DEFAULT 'active' COMMENT 'çŠ¶æ€',
  is_system BOOLEAN DEFAULT FALSE COMMENT 'æ˜¯å¦ç³»ç»Ÿæƒé™',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  INDEX idx_code (code),
  INDEX idx_resource (resource),
  INDEX idx_module (module),
  INDEX idx_status (status),
  UNIQUE KEY uk_resource_action (resource, action)
) COMMENT 'ç®¡ç†å‘˜æƒé™è¡¨';
```

#### ç”¨æˆ·è§’è‰²å…³è”è¡¨ (admin_user_roles)
```sql
CREATE TABLE admin_user_roles (
  id INT PRIMARY KEY AUTO_INCREMENT,
  user_id INT NOT NULL COMMENT 'ç”¨æˆ·ID',
  role_id INT NOT NULL COMMENT 'è§’è‰²ID',
  status ENUM('active', 'inactive') DEFAULT 'active' COMMENT 'çŠ¶æ€',
  granted_by INT COMMENT 'æˆæƒè€…ID',
  granted_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'æˆæƒæ—¶é—´',
  expires_at TIMESTAMP NULL COMMENT 'è¿‡æœŸæ—¶é—´',
  
  FOREIGN KEY (user_id) REFERENCES admin_users(id) ON DELETE CASCADE,
  FOREIGN KEY (role_id) REFERENCES admin_roles(id) ON DELETE CASCADE,
  UNIQUE KEY uk_user_role (user_id, role_id),
  INDEX idx_user_id (user_id),
  INDEX idx_role_id (role_id),
  INDEX idx_status (status)
) COMMENT 'ç”¨æˆ·è§’è‰²å…³è”è¡¨';
```

#### è§’è‰²æƒé™å…³è”è¡¨ (admin_role_permissions)
```sql
CREATE TABLE admin_role_permissions (
  id INT PRIMARY KEY AUTO_INCREMENT,
  role_id INT NOT NULL COMMENT 'è§’è‰²ID',
  permission_id INT NOT NULL COMMENT 'æƒé™ID',
  status ENUM('active', 'inactive') DEFAULT 'active' COMMENT 'çŠ¶æ€',
  granted_by INT COMMENT 'æˆæƒè€…ID',
  granted_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'æˆæƒæ—¶é—´',
  
  FOREIGN KEY (role_id) REFERENCES admin_roles(id) ON DELETE CASCADE,
  FOREIGN KEY (permission_id) REFERENCES admin_permissions(id) ON DELETE CASCADE,
  UNIQUE KEY uk_role_permission (role_id, permission_id),
  INDEX idx_role_id (role_id),
  INDEX idx_permission_id (permission_id),
  INDEX idx_status (status)
) COMMENT 'è§’è‰²æƒé™å…³è”è¡¨';
```

### 2. é¢„å®šä¹‰è§’è‰²å’Œæƒé™

#### ç³»ç»Ÿè§’è‰²å®šä¹‰
```javascript
const SYSTEM_ROLES = {
  SUPER_ADMIN: {
    code: 'super_admin',
    name: 'è¶…çº§ç®¡ç†å‘˜',
    description: 'æ‹¥æœ‰ç³»ç»Ÿæ‰€æœ‰æƒé™ï¼Œå¯ä»¥ç®¡ç†å…¶ä»–ç®¡ç†å‘˜',
    level: 100,
    permissions: ['*'] // æ‰€æœ‰æƒé™
  },
  
  ADMIN: {
    code: 'admin',
    name: 'ç³»ç»Ÿç®¡ç†å‘˜',
    description: 'æ‹¥æœ‰å¤§éƒ¨åˆ†ç®¡ç†æƒé™ï¼Œä¸èƒ½ç®¡ç†å…¶ä»–ç®¡ç†å‘˜',
    level: 80,
    permissions: [
      'user:*', 'wallet:*', 'transaction:*', 
      'task:*', 'redpacket:*', 'team:*', 
      'ranking:*', 'monitoring:read'
    ]
  },
  
  FINANCE_MANAGER: {
    code: 'finance_manager',
    name: 'è´¢åŠ¡ç®¡ç†å‘˜',
    description: 'è´Ÿè´£è´¢åŠ¡ç›¸å…³åŠŸèƒ½ç®¡ç†',
    level: 60,
    permissions: [
      'wallet:read', 'wallet:manage', 'transaction:*',
      'user:read', 'monitoring:read'
    ]
  },
  
  OPERATION_MANAGER: {
    code: 'operation_manager',
    name: 'è¿è¥ç®¡ç†å‘˜',
    description: 'è´Ÿè´£è¿è¥æ´»åŠ¨ç®¡ç†',
    level: 50,
    permissions: [
      'task:*', 'redpacket:*', 'team:read', 
      'ranking:*', 'user:read', 'monitoring:read'
    ]
  },
  
  CUSTOMER_SERVICE: {
    code: 'customer_service',
    name: 'å®¢æœä¸“å‘˜',
    description: 'è´Ÿè´£ç”¨æˆ·æœåŠ¡å’ŒåŸºç¡€æŸ¥è¯¢',
    level: 30,
    permissions: [
      'user:read', 'user:update_basic', 'wallet:read',
      'transaction:read', 'team:read'
    ]
  },
  
  AUDITOR: {
    code: 'auditor',
    name: 'å®¡è®¡ä¸“å‘˜',
    description: 'è´Ÿè´£å®¡è®¡å’Œç›‘æ§ï¼Œåªè¯»æƒé™',
    level: 40,
    permissions: [
      'user:read', 'wallet:read', 'transaction:read',
      'task:read', 'redpacket:read', 'team:read',
      'ranking:read', 'monitoring:read', 'audit:*'
    ]
  }
};
```

#### æƒé™å®šä¹‰
```javascript
const SYSTEM_PERMISSIONS = {
  // ç”¨æˆ·ç®¡ç†æƒé™
  USER_READ: { code: 'user:read', name: 'æŸ¥çœ‹ç”¨æˆ·', resource: 'user', action: 'read' },
  USER_CREATE: { code: 'user:create', name: 'åˆ›å»ºç”¨æˆ·', resource: 'user', action: 'create' },
  USER_UPDATE: { code: 'user:update', name: 'æ›´æ–°ç”¨æˆ·', resource: 'user', action: 'update' },
  USER_DELETE: { code: 'user:delete', name: 'åˆ é™¤ç”¨æˆ·', resource: 'user', action: 'delete' },
  USER_UPDATE_BASIC: { code: 'user:update_basic', name: 'æ›´æ–°åŸºç¡€ä¿¡æ¯', resource: 'user', action: 'update_basic' },
  USER_FREEZE: { code: 'user:freeze', name: 'å†»ç»“ç”¨æˆ·', resource: 'user', action: 'freeze' },
  USER_EXPORT: { code: 'user:export', name: 'å¯¼å‡ºç”¨æˆ·æ•°æ®', resource: 'user', action: 'export' },
  
  // é’±åŒ…ç®¡ç†æƒé™
  WALLET_READ: { code: 'wallet:read', name: 'æŸ¥çœ‹é’±åŒ…', resource: 'wallet', action: 'read' },
  WALLET_MANAGE: { code: 'wallet:manage', name: 'ç®¡ç†é’±åŒ…', resource: 'wallet', action: 'manage' },
  WALLET_COLLECT: { code: 'wallet:collect', name: 'èµ„é‡‘å½’é›†', resource: 'wallet', action: 'collect' },
  WALLET_EXPORT: { code: 'wallet:export', name: 'å¯¼å‡ºé’±åŒ…æ•°æ®', resource: 'wallet', action: 'export' },
  
  // äº¤æ˜“ç®¡ç†æƒé™
  TRANSACTION_READ: { code: 'transaction:read', name: 'æŸ¥çœ‹äº¤æ˜“', resource: 'transaction', action: 'read' },
  TRANSACTION_APPROVE: { code: 'transaction:approve', name: 'å®¡æ‰¹äº¤æ˜“', resource: 'transaction', action: 'approve' },
  TRANSACTION_REJECT: { code: 'transaction:reject', name: 'æ‹’ç»äº¤æ˜“', resource: 'transaction', action: 'reject' },
  TRANSACTION_EXPORT: { code: 'transaction:export', name: 'å¯¼å‡ºäº¤æ˜“æ•°æ®', resource: 'transaction', action: 'export' },
  
  // ä»»åŠ¡ç®¡ç†æƒé™
  TASK_READ: { code: 'task:read', name: 'æŸ¥çœ‹ä»»åŠ¡', resource: 'task', action: 'read' },
  TASK_CREATE: { code: 'task:create', name: 'åˆ›å»ºä»»åŠ¡', resource: 'task', action: 'create' },
  TASK_UPDATE: { code: 'task:update', name: 'æ›´æ–°ä»»åŠ¡', resource: 'task', action: 'update' },
  TASK_DELETE: { code: 'task:delete', name: 'åˆ é™¤ä»»åŠ¡', resource: 'task', action: 'delete' },
  TASK_PUBLISH: { code: 'task:publish', name: 'å‘å¸ƒä»»åŠ¡', resource: 'task', action: 'publish' },
  
  // çº¢åŒ…ç®¡ç†æƒé™
  REDPACKET_READ: { code: 'redpacket:read', name: 'æŸ¥çœ‹çº¢åŒ…', resource: 'redpacket', action: 'read' },
  REDPACKET_CREATE: { code: 'redpacket:create', name: 'åˆ›å»ºçº¢åŒ…', resource: 'redpacket', action: 'create' },
  REDPACKET_UPDATE: { code: 'redpacket:update', name: 'æ›´æ–°çº¢åŒ…', resource: 'redpacket', action: 'update' },
  REDPACKET_DELETE: { code: 'redpacket:delete', name: 'åˆ é™¤çº¢åŒ…', resource: 'redpacket', action: 'delete' },
  
  // å›¢é˜Ÿç®¡ç†æƒé™
  TEAM_READ: { code: 'team:read', name: 'æŸ¥çœ‹å›¢é˜Ÿ', resource: 'team', action: 'read' },
  TEAM_MANAGE: { code: 'team:manage', name: 'ç®¡ç†å›¢é˜Ÿ', resource: 'team', action: 'manage' },
  TEAM_EXPORT: { code: 'team:export', name: 'å¯¼å‡ºå›¢é˜Ÿæ•°æ®', resource: 'team', action: 'export' },
  
  // æ’è¡Œæ¦œç®¡ç†æƒé™
  RANKING_READ: { code: 'ranking:read', name: 'æŸ¥çœ‹æ’è¡Œæ¦œ', resource: 'ranking', action: 'read' },
  RANKING_MANAGE: { code: 'ranking:manage', name: 'ç®¡ç†æ’è¡Œæ¦œ', resource: 'ranking', action: 'manage' },
  RANKING_RESET: { code: 'ranking:reset', name: 'é‡ç½®æ’è¡Œæ¦œ', resource: 'ranking', action: 'reset' },
  
  // ç›‘æ§ç®¡ç†æƒé™
  MONITORING_READ: { code: 'monitoring:read', name: 'æŸ¥çœ‹ç›‘æ§', resource: 'monitoring', action: 'read' },
  MONITORING_MANAGE: { code: 'monitoring:manage', name: 'ç®¡ç†ç›‘æ§', resource: 'monitoring', action: 'manage' },
  MONITORING_ALERT: { code: 'monitoring:alert', name: 'ç®¡ç†å‘Šè­¦', resource: 'monitoring', action: 'alert' },
  
  // ç³»ç»Ÿç®¡ç†æƒé™
  SYSTEM_CONFIG: { code: 'system:config', name: 'ç³»ç»Ÿé…ç½®', resource: 'system', action: 'config' },
  SYSTEM_BACKUP: { code: 'system:backup', name: 'ç³»ç»Ÿå¤‡ä»½', resource: 'system', action: 'backup' },
  SYSTEM_MAINTENANCE: { code: 'system:maintenance', name: 'ç³»ç»Ÿç»´æŠ¤', resource: 'system', action: 'maintenance' },
  
  // ç®¡ç†å‘˜ç®¡ç†æƒé™
  ADMIN_READ: { code: 'admin:read', name: 'æŸ¥çœ‹ç®¡ç†å‘˜', resource: 'admin', action: 'read' },
  ADMIN_CREATE: { code: 'admin:create', name: 'åˆ›å»ºç®¡ç†å‘˜', resource: 'admin', action: 'create' },
  ADMIN_UPDATE: { code: 'admin:update', name: 'æ›´æ–°ç®¡ç†å‘˜', resource: 'admin', action: 'update' },
  ADMIN_DELETE: { code: 'admin:delete', name: 'åˆ é™¤ç®¡ç†å‘˜', resource: 'admin', action: 'delete' },
  
  // è§’è‰²æƒé™ç®¡ç†
  ROLE_READ: { code: 'role:read', name: 'æŸ¥çœ‹è§’è‰²', resource: 'role', action: 'read' },
  ROLE_CREATE: { code: 'role:create', name: 'åˆ›å»ºè§’è‰²', resource: 'role', action: 'create' },
  ROLE_UPDATE: { code: 'role:update', name: 'æ›´æ–°è§’è‰²', resource: 'role', action: 'update' },
  ROLE_DELETE: { code: 'role:delete', name: 'åˆ é™¤è§’è‰²', resource: 'role', action: 'delete' },
  
  // å®¡è®¡æƒé™
  AUDIT_READ: { code: 'audit:read', name: 'æŸ¥çœ‹å®¡è®¡æ—¥å¿—', resource: 'audit', action: 'read' },
  AUDIT_EXPORT: { code: 'audit:export', name: 'å¯¼å‡ºå®¡è®¡æ—¥å¿—', resource: 'audit', action: 'export' }
};
```

## å®‰å…¨é˜²æŠ¤æœºåˆ¶

### 1. èº«ä»½è®¤è¯å®‰å…¨

#### å¯†ç å®‰å…¨ç­–ç•¥
```javascript
/**
 * å¯†ç å®‰å…¨ç®¡ç†
 */
class PasswordSecurity {
  /**
   * å¯†ç å¼ºåº¦éªŒè¯
   * @param {string} password - å¯†ç 
   * @returns {Object} éªŒè¯ç»“æœ
   */
  validatePasswordStrength(password) {
    const rules = {
      minLength: 8,
      maxLength: 128,
      requireUppercase: true,
      requireLowercase: true,
      requireNumbers: true,
      requireSpecialChars: true,
      forbiddenPatterns: [
        /(.)\1{2,}/, // è¿ç»­ç›¸åŒå­—ç¬¦
        /123456|654321|qwerty|password/i, // å¸¸è§å¼±å¯†ç 
      ]
    };
    
    const errors = [];
    
    if (password.length < rules.minLength) {
      errors.push(`å¯†ç é•¿åº¦ä¸èƒ½å°‘äº${rules.minLength}ä½`);
    }
    
    if (password.length > rules.maxLength) {
      errors.push(`å¯†ç é•¿åº¦ä¸èƒ½è¶…è¿‡${rules.maxLength}ä½`);
    }
    
    if (rules.requireUppercase && !/[A-Z]/.test(password)) {
      errors.push('å¯†ç å¿…é¡»åŒ…å«å¤§å†™å­—æ¯');
    }
    
    if (rules.requireLowercase && !/[a-z]/.test(password)) {
      errors.push('å¯†ç å¿…é¡»åŒ…å«å°å†™å­—æ¯');
    }
    
    if (rules.requireNumbers && !/\d/.test(password)) {
      errors.push('å¯†ç å¿…é¡»åŒ…å«æ•°å­—');
    }
    
    if (rules.requireSpecialChars && !/[!@#$%^&*(),.?":{}|<>]/.test(password)) {
      errors.push('å¯†ç å¿…é¡»åŒ…å«ç‰¹æ®Šå­—ç¬¦');
    }
    
    for (const pattern of rules.forbiddenPatterns) {
      if (pattern.test(password)) {
        errors.push('å¯†ç åŒ…å«ä¸å®‰å…¨çš„æ¨¡å¼');
        break;
      }
    }
    
    return {
      isValid: errors.length === 0,
      errors,
      strength: this.calculatePasswordStrength(password)
    };
  }
  
  /**
   * å¯†ç å“ˆå¸Œ
   * @param {string} password - æ˜æ–‡å¯†ç 
   * @returns {Object} å“ˆå¸Œç»“æœ
   */
  async hashPassword(password) {
    const salt = crypto.randomBytes(16).toString('hex');
    const hash = await bcrypt.hash(password + salt, 12);
    
    return { hash, salt };
  }
  
  /**
   * å¯†ç éªŒè¯
   * @param {string} password - æ˜æ–‡å¯†ç 
   * @param {string} hash - å­˜å‚¨çš„å“ˆå¸Œ
   * @param {string} salt - ç›å€¼
   * @returns {boolean} éªŒè¯ç»“æœ
   */
  async verifyPassword(password, hash, salt) {
    return await bcrypt.compare(password + salt, hash);
  }
}
```

#### åŒå› ç´ è®¤è¯ (2FA)
```javascript
/**
 * åŒå› ç´ è®¤è¯ç®¡ç†
 */
class TwoFactorAuth {
  /**
   * ç”Ÿæˆ2FAå¯†é’¥
   * @param {string} username - ç”¨æˆ·å
   * @returns {Object} 2FAé…ç½®
   */
  generateSecret(username) {
    const secret = speakeasy.generateSecret({
      name: `æ•°å­—é’±åŒ…ç®¡ç†åå° (${username})`,
      issuer: 'æ•°å­—é’±åŒ…',
      length: 32
    });
    
    return {
      secret: secret.base32,
      qrCode: qrcode.toDataURL(secret.otpauth_url),
      backupCodes: this.generateBackupCodes()
    };
  }
  
  /**
   * éªŒè¯TOTPç 
   * @param {string} secret - 2FAå¯†é’¥
   * @param {string} token - TOTPç 
   * @returns {boolean} éªŒè¯ç»“æœ
   */
  verifyTOTP(secret, token) {
    return speakeasy.totp.verify({
      secret,
      encoding: 'base32',
      token,
      window: 2 // å…è®¸æ—¶é—´çª—å£åå·®
    });
  }
  
  /**
   * ç”Ÿæˆå¤‡ç”¨ç 
   * @returns {Array} å¤‡ç”¨ç åˆ—è¡¨
   */
  generateBackupCodes() {
    const codes = [];
    for (let i = 0; i < 10; i++) {
      codes.push(crypto.randomBytes(4).toString('hex').toUpperCase());
    }
    return codes;
  }
}
```

### 2. ä¼šè¯ç®¡ç†å®‰å…¨

#### JWTä»¤ç‰Œç®¡ç†
```javascript
/**
 * JWTä»¤ç‰Œç®¡ç†
 */
class TokenManager {
  /**
   * ç”Ÿæˆè®¿é—®ä»¤ç‰Œ
   * @param {Object} user - ç”¨æˆ·ä¿¡æ¯
   * @returns {Object} ä»¤ç‰Œä¿¡æ¯
   */
  generateTokens(user) {
    const payload = {
      userId: user.id,
      username: user.username,
      roles: user.roles,
      sessionId: crypto.randomUUID()
    };
    
    // è®¿é—®ä»¤ç‰Œ - 15åˆ†é’Ÿ
    const accessToken = jwt.sign(payload, process.env.JWT_SECRET, {
      expiresIn: '15m',
      issuer: 'wallet-admin',
      audience: 'wallet-admin-client'
    });
    
    // åˆ·æ–°ä»¤ç‰Œ - 7å¤©
    const refreshToken = jwt.sign(
      { userId: user.id, sessionId: payload.sessionId },
      process.env.JWT_REFRESH_SECRET,
      { expiresIn: '7d' }
    );
    
    return {
      accessToken,
      refreshToken,
      expiresIn: 15 * 60, // 15åˆ†é’Ÿ
      tokenType: 'Bearer'
    };
  }
  
  /**
   * åˆ·æ–°è®¿é—®ä»¤ç‰Œ
   * @param {string} refreshToken - åˆ·æ–°ä»¤ç‰Œ
   * @returns {Object} æ–°çš„ä»¤ç‰Œä¿¡æ¯
   */
  async refreshAccessToken(refreshToken) {
    try {
      const decoded = jwt.verify(refreshToken, process.env.JWT_REFRESH_SECRET);
      
      // æ£€æŸ¥åˆ·æ–°ä»¤ç‰Œæ˜¯å¦åœ¨é»‘åå•ä¸­
      const isBlacklisted = await redis.get(`refresh_blacklist:${refreshToken}`);
      if (isBlacklisted) {
        throw new Error('åˆ·æ–°ä»¤ç‰Œå·²å¤±æ•ˆ');
      }
      
      // è·å–ç”¨æˆ·ä¿¡æ¯
      const user = await User.findById(decoded.userId);
      if (!user || user.status !== 'active') {
        throw new Error('ç”¨æˆ·ä¸å­˜åœ¨æˆ–å·²è¢«ç¦ç”¨');
      }
      
      // ç”Ÿæˆæ–°çš„è®¿é—®ä»¤ç‰Œ
      const newTokens = this.generateTokens(user);
      
      // å°†æ—§çš„åˆ·æ–°ä»¤ç‰ŒåŠ å…¥é»‘åå•
      await redis.setex(
        `refresh_blacklist:${refreshToken}`,
        7 * 24 * 60 * 60, // 7å¤©
        '1'
      );
      
      return newTokens;
      
    } catch (error) {
      throw new Error('åˆ·æ–°ä»¤ç‰ŒéªŒè¯å¤±è´¥');
    }
  }
  
  /**
   * æ’¤é”€ä»¤ç‰Œ
   * @param {string} token - è®¿é—®ä»¤ç‰Œ
   * @param {string} refreshToken - åˆ·æ–°ä»¤ç‰Œ
   */
  async revokeTokens(token, refreshToken) {
    const decoded = jwt.decode(token);
    const expiresIn = decoded.exp - Math.floor(Date.now() / 1000);
    
    // å°†è®¿é—®ä»¤ç‰ŒåŠ å…¥é»‘åå•
    if (expiresIn > 0) {
      await redis.setex(`blacklist:${token}`, expiresIn, '1');
    }
    
    // å°†åˆ·æ–°ä»¤ç‰ŒåŠ å…¥é»‘åå•
    await redis.setex(
      `refresh_blacklist:${refreshToken}`,
      7 * 24 * 60 * 60,
      '1'
    );
  }
}
```

### 3. è®¿é—®æ§åˆ¶å®‰å…¨

#### IPç™½åå•ç®¡ç†
```javascript
/**
 * IPè®¿é—®æ§åˆ¶
 */
class IPAccessControl {
  /**
   * IPç™½åå•éªŒè¯ä¸­é—´ä»¶
   * @returns {Function} Expressä¸­é—´ä»¶
   */
  ipWhitelistMiddleware() {
    return async (req, res, next) => {
      const clientIP = this.getClientIP(req);
      
      // æ£€æŸ¥IPæ˜¯å¦åœ¨ç™½åå•ä¸­
      const isAllowed = await this.isIPAllowed(clientIP);
      
      if (!isAllowed) {
        // è®°å½•éæ³•è®¿é—®
        await this.logUnauthorizedAccess(clientIP, req);
        
        return res.status(403).json({
          success: false,
          code: 403,
          message: 'IPåœ°å€ä¸åœ¨å…è®¸èŒƒå›´å†…'
        });
      }
      
      next();
    };
  }
  
  /**
   * è·å–å®¢æˆ·ç«¯çœŸå®IP
   * @param {Object} req - è¯·æ±‚å¯¹è±¡
   * @returns {string} IPåœ°å€
   */
  getClientIP(req) {
    return req.headers['x-forwarded-for'] ||
           req.headers['x-real-ip'] ||
           req.connection.remoteAddress ||
           req.socket.remoteAddress ||
           req.ip;
  }
  
  /**
   * æ£€æŸ¥IPæ˜¯å¦è¢«å…è®¸
   * @param {string} ip - IPåœ°å€
   * @returns {boolean} æ˜¯å¦å…è®¸
   */
  async isIPAllowed(ip) {
    // æ£€æŸ¥IPç™½åå•
    const whitelist = await redis.smembers('ip_whitelist');
    
    for (const allowedIP of whitelist) {
      if (this.matchIP(ip, allowedIP)) {
        return true;
      }
    }
    
    return false;
  }
  
  /**
   * IPåŒ¹é…æ£€æŸ¥(æ”¯æŒCIDR)
   * @param {string} ip - å®¢æˆ·ç«¯IP
   * @param {string} pattern - åŒ¹é…æ¨¡å¼
   * @returns {boolean} æ˜¯å¦åŒ¹é…
   */
  matchIP(ip, pattern) {
    if (pattern.includes('/')) {
      // CIDRæ ¼å¼
      const [network, prefixLength] = pattern.split('/');
      return this.isIPInCIDR(ip, network, parseInt(prefixLength));
    } else {
      // ç²¾ç¡®åŒ¹é…
      return ip === pattern;
    }
  }
}
```

#### é€Ÿç‡é™åˆ¶
```javascript
/**
 * é€Ÿç‡é™åˆ¶ç®¡ç†
 */
class RateLimiter {
  /**
   * åˆ›å»ºé€Ÿç‡é™åˆ¶ä¸­é—´ä»¶
   * @param {Object} options - é…ç½®é€‰é¡¹
   * @returns {Function} Expressä¸­é—´ä»¶
   */
  createLimiter(options = {}) {
    const {
      windowMs = 15 * 60 * 1000, // 15åˆ†é’Ÿ
      max = 100, // æœ€å¤§è¯·æ±‚æ•°
      keyGenerator = (req) => req.ip,
      skipSuccessfulRequests = false,
      skipFailedRequests = false
    } = options;
    
    return async (req, res, next) => {
      const key = `rate_limit:${keyGenerator(req)}`;
      const now = Date.now();
      const windowStart = now - windowMs;
      
      // æ¸…ç†è¿‡æœŸè®°å½•
      await redis.zremrangebyscore(key, 0, windowStart);
      
      // è·å–å½“å‰çª—å£å†…çš„è¯·æ±‚æ•°
      const requestCount = await redis.zcard(key);
      
      if (requestCount >= max) {
        return res.status(429).json({
          success: false,
          code: 429,
          message: 'è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•',
          retryAfter: Math.ceil(windowMs / 1000)
        });
      }
      
      // è®°å½•å½“å‰è¯·æ±‚
      await redis.zadd(key, now, `${now}-${Math.random()}`);
      await redis.expire(key, Math.ceil(windowMs / 1000));
      
      // è®¾ç½®å“åº”å¤´
      res.set({
        'X-RateLimit-Limit': max,
        'X-RateLimit-Remaining': Math.max(0, max - requestCount - 1),
        'X-RateLimit-Reset': new Date(now + windowMs).toISOString()
      });
      
      next();
    };
  }
  
  /**
   * æ•æ„Ÿæ“ä½œé™åˆ¶
   * @returns {Function} Expressä¸­é—´ä»¶
   */
  sensitiveOperationLimiter() {
    return this.createLimiter({
      windowMs: 60 * 60 * 1000, // 1å°æ—¶
      max: 10, // æœ€å¤š10æ¬¡
      keyGenerator: (req) => `${req.ip}:${req.user?.id || 'anonymous'}`,
      message: 'æ•æ„Ÿæ“ä½œè¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•'
    });
  }
}
```

### 4. æ•°æ®å®‰å…¨é˜²æŠ¤

#### æ•°æ®è„±æ•
```javascript
/**
 * æ•°æ®è„±æ•å¤„ç†
 */
class DataMasking {
  /**
   * æ ¹æ®ç”¨æˆ·æƒé™è„±æ•æ•°æ®
   * @param {Object} data - åŸå§‹æ•°æ®
   * @param {Array} userPermissions - ç”¨æˆ·æƒé™
   * @returns {Object} è„±æ•åçš„æ•°æ®
   */
  maskDataByPermissions(data, userPermissions) {
    const sensitiveFields = {
      phone: {
        permission: 'user:view_phone',
        mask: (value) => value.replace(/(\d{3})\d{4}(\d{4})/, '$1****$2')
      },
      email: {
        permission: 'user:view_email',
        mask: (value) => value.replace(/(.{2}).*(@.*)/, '$1***$2')
      },
      walletAddress: {
        permission: 'wallet:view_full_address',
        mask: (value) => `${value.slice(0, 6)}...${value.slice(-6)}`
      },
      idCard: {
        permission: 'user:view_id_card',
        mask: (value) => value.replace(/(\d{6})\d{8}(\d{4})/, '$1********$2')
      },
      realName: {
        permission: 'user:view_real_name',
        mask: (value) => value.replace(/(.{1}).*(.{1})/, '$1***$2')
      }
    };
    
    const maskedData = { ...data };
    
    Object.keys(sensitiveFields).forEach(field => {
      if (maskedData[field]) {
        const fieldConfig = sensitiveFields[field];
        const hasPermission = userPermissions.some(p => 
          p.code === fieldConfig.permission || p.code === '*'
        );
        
        if (!hasPermission) {
          maskedData[field] = fieldConfig.mask(maskedData[field]);
        }
      }
    });
    
    return maskedData;
  }
  
  /**
   * æ‰¹é‡æ•°æ®è„±æ•
   * @param {Array} dataList - æ•°æ®åˆ—è¡¨
   * @param {Array} userPermissions - ç”¨æˆ·æƒé™
   * @returns {Array} è„±æ•åçš„æ•°æ®åˆ—è¡¨
   */
  maskDataList(dataList, userPermissions) {
    return dataList.map(data => this.maskDataByPermissions(data, userPermissions));
  }
}
```

#### æ•°æ®åŠ å¯†
```javascript
/**
 * æ•°æ®åŠ å¯†ç®¡ç†
 */
class DataEncryption {
  constructor() {
    this.algorithm = 'aes-256-gcm';
    this.keyLength = 32;
    this.ivLength = 16;
    this.tagLength = 16;
  }
  
  /**
   * åŠ å¯†æ•æ„Ÿæ•°æ®
   * @param {string} plaintext - æ˜æ–‡
   * @param {string} key - åŠ å¯†å¯†é’¥
   * @returns {string} åŠ å¯†ç»“æœ
   */
  encrypt(plaintext, key = process.env.DATA_ENCRYPTION_KEY) {
    const iv = crypto.randomBytes(this.ivLength);
    const cipher = crypto.createCipher(this.algorithm, key);
    cipher.setAAD(Buffer.from('wallet-admin', 'utf8'));
    
    let encrypted = cipher.update(plaintext, 'utf8', 'hex');
    encrypted += cipher.final('hex');
    
    const tag = cipher.getAuthTag();
    
    return `${iv.toString('hex')}:${tag.toString('hex')}:${encrypted}`;
  }
  
  /**
   * è§£å¯†æ•æ„Ÿæ•°æ®
   * @param {string} encryptedData - åŠ å¯†æ•°æ®
   * @param {string} key - è§£å¯†å¯†é’¥
   * @returns {string} æ˜æ–‡
   */
  decrypt(encryptedData, key = process.env.DATA_ENCRYPTION_KEY) {
    const [ivHex, tagHex, encrypted] = encryptedData.split(':');
    
    const iv = Buffer.from(ivHex, 'hex');
    const tag = Buffer.from(tagHex, 'hex');
    
    const decipher = crypto.createDecipher(this.algorithm, key);
    decipher.setAAD(Buffer.from('wallet-admin', 'utf8'));
    decipher.setAuthTag(tag);
    
    let decrypted = decipher.update(encrypted, 'hex', 'utf8');
    decrypted += decipher.final('utf8');
    
    return decrypted;
  }
}
```

## å®¡è®¡æ—¥å¿—ç³»ç»Ÿ

### 1. æ“ä½œæ—¥å¿—è®°å½•

#### å®¡è®¡æ—¥å¿—è¡¨ç»“æ„
```sql
CREATE TABLE admin_audit_logs (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  user_id INT COMMENT 'æ“ä½œç”¨æˆ·ID',
  username VARCHAR(50) COMMENT 'æ“ä½œç”¨æˆ·å',
  action VARCHAR(100) NOT NULL COMMENT 'æ“ä½œç±»å‹',
  resource VARCHAR(50) COMMENT 'æ“ä½œèµ„æº',
  resource_id VARCHAR(100) COMMENT 'èµ„æºID',
  method VARCHAR(10) COMMENT 'HTTPæ–¹æ³•',
  url VARCHAR(500) COMMENT 'è¯·æ±‚URL',
  ip_address VARCHAR(45) COMMENT 'IPåœ°å€',
  user_agent TEXT COMMENT 'ç”¨æˆ·ä»£ç†',
  request_data JSON COMMENT 'è¯·æ±‚æ•°æ®',
  response_data JSON COMMENT 'å“åº”æ•°æ®',
  status_code INT COMMENT 'å“åº”çŠ¶æ€ç ',
  duration INT COMMENT 'æ‰§è¡Œæ—¶é—´(æ¯«ç§’)',
  success BOOLEAN COMMENT 'æ˜¯å¦æˆåŠŸ',
  error_message TEXT COMMENT 'é”™è¯¯ä¿¡æ¯',
  session_id VARCHAR(100) COMMENT 'ä¼šè¯ID',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  
  INDEX idx_user_id (user_id),
  INDEX idx_action (action),
  INDEX idx_resource (resource),
  INDEX idx_ip_address (ip_address),
  INDEX idx_created_at (created_at),
  INDEX idx_success (success)
) COMMENT 'ç®¡ç†å‘˜æ“ä½œå®¡è®¡æ—¥å¿—';
```

#### å®¡è®¡æ—¥å¿—è®°å½•å™¨
```javascript
/**
 * å®¡è®¡æ—¥å¿—è®°å½•å™¨
 */
class AuditLogger {
  /**
   * å®¡è®¡æ—¥å¿—ä¸­é—´ä»¶
   * @returns {Function} Expressä¸­é—´ä»¶
   */
  auditMiddleware() {
    return (req, res, next) => {
      const startTime = Date.now();
      const originalSend = res.send;
      
      // è®°å½•è¯·æ±‚ä¿¡æ¯
      const auditData = {
        userId: req.user?.id,
        username: req.user?.username,
        method: req.method,
        url: req.originalUrl,
        ipAddress: this.getClientIP(req),
        userAgent: req.get('User-Agent'),
        sessionId: req.user?.sessionId,
        requestData: this.sanitizeRequestData(req)
      };
      
      // æ‹¦æˆªå“åº”
      res.send = function(data) {
        const duration = Date.now() - startTime;
        
        auditData.responseData = this.sanitizeResponseData(data);
        auditData.statusCode = res.statusCode;
        auditData.duration = duration;
        auditData.success = res.statusCode < 400;
        
        // å¼‚æ­¥è®°å½•æ—¥å¿—
        setImmediate(() => {
          this.logAuditEvent(auditData);
        });
        
        return originalSend.call(this, data);
      }.bind(this);
      
      next();
    };
  }
  
  /**
   * è®°å½•å®¡è®¡äº‹ä»¶
   * @param {Object} auditData - å®¡è®¡æ•°æ®
   */
  async logAuditEvent(auditData) {
    try {
      // ç¡®å®šæ“ä½œç±»å‹
      auditData.action = this.determineAction(auditData);
      auditData.resource = this.determineResource(auditData.url);
      auditData.resourceId = this.extractResourceId(auditData.url);
      
      // æ’å…¥æ•°æ®åº“
      await db.query(`
        INSERT INTO admin_audit_logs (
          user_id, username, action, resource, resource_id,
          method, url, ip_address, user_agent, request_data,
          response_data, status_code, duration, success,
          error_message, session_id, created_at
        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, NOW())
      `, [
        auditData.userId, auditData.username, auditData.action,
        auditData.resource, auditData.resourceId, auditData.method,
        auditData.url, auditData.ipAddress, auditData.userAgent,
        JSON.stringify(auditData.requestData),
        JSON.stringify(auditData.responseData),
        auditData.statusCode, auditData.duration, auditData.success,
        auditData.errorMessage, auditData.sessionId
      ]);
      
      // å®æ—¶å‘Šè­¦æ£€æŸ¥
      await this.checkSecurityAlerts(auditData);
      
    } catch (error) {
      console.error('å®¡è®¡æ—¥å¿—è®°å½•å¤±è´¥:', error);
    }
  }
  
  /**
   * ç¡®å®šæ“ä½œç±»å‹
   * @param {Object} auditData - å®¡è®¡æ•°æ®
   * @returns {string} æ“ä½œç±»å‹
   */
  determineAction(auditData) {
    const { method, url } = auditData;
    
    const actionMap = {
      'POST /api/admin/login': 'admin_login',
      'POST /api/admin/logout': 'admin_logout',
      'GET /api/admin/users': 'view_users',
      'POST /api/admin/users': 'create_user',
      'PUT /api/admin/users': 'update_user',
      'DELETE /api/admin/users': 'delete_user',
      'POST /api/admin/users/*/freeze': 'freeze_user',
      'POST /api/admin/wallet/collect-funds': 'collect_funds',
      'PUT /api/admin/transactions/*/approve': 'approve_transaction',
      'PUT /api/admin/transactions/*/reject': 'reject_transaction'
    };
    
    // ç²¾ç¡®åŒ¹é…
    const exactMatch = actionMap[`${method} ${url}`];
    if (exactMatch) return exactMatch;
    
    // æ¨¡å¼åŒ¹é…
    for (const [pattern, action] of Object.entries(actionMap)) {
      const regex = new RegExp(pattern.replace(/\*/g, '[^/]+'));
      if (regex.test(`${method} ${url}`)) {
        return action;
      }
    }
    
    return `${method.toLowerCase()}_${this.determineResource(url)}`;
  }
  
  /**
   * å®‰å…¨å‘Šè­¦æ£€æŸ¥
   * @param {Object} auditData - å®¡è®¡æ•°æ®
   */
  async checkSecurityAlerts(auditData) {
    // æ£€æŸ¥å¤±è´¥ç™»å½•å°è¯•
    if (auditData.action === 'admin_login' && !auditData.success) {
      await this.checkFailedLoginAttempts(auditData.ipAddress);
    }
    
    // æ£€æŸ¥æ•æ„Ÿæ“ä½œ
    const sensitiveActions = [
      'delete_user', 'freeze_user', 'collect_funds',
      'approve_transaction', 'create_admin'
    ];
    
    if (sensitiveActions.includes(auditData.action)) {
      await this.alertSensitiveOperation(auditData);
    }
    
    // æ£€æŸ¥å¼‚å¸¸IPè®¿é—®
    await this.checkAnomalousIPAccess(auditData);
  }
}
```

### 2. å®‰å…¨äº‹ä»¶ç›‘æ§

#### å®‰å…¨å‘Šè­¦ç³»ç»Ÿ
```javascript
/**
 * å®‰å…¨å‘Šè­¦ç³»ç»Ÿ
 */
class SecurityAlertSystem {
  /**
   * æ£€æŸ¥å¤±è´¥ç™»å½•å°è¯•
   * @param {string} ipAddress - IPåœ°å€
   */
  async checkFailedLoginAttempts(ipAddress) {
    const key = `failed_login:${ipAddress}`;
    const attempts = await redis.incr(key);
    
    if (attempts === 1) {
      await redis.expire(key, 3600); // 1å°æ—¶è¿‡æœŸ
    }
    
    // 5æ¬¡å¤±è´¥å°è¯•è§¦å‘å‘Šè­¦
    if (attempts >= 5) {
      await this.sendAlert({
        type: 'FAILED_LOGIN_ATTEMPTS',
        severity: 'HIGH',
        message: `IP ${ipAddress} åœ¨1å°æ—¶å†…ç™»å½•å¤±è´¥${attempts}æ¬¡`,
        data: { ipAddress, attempts }
      });
      
      // ä¸´æ—¶å°ç¦IP
      await redis.setex(`blocked_ip:${ipAddress}`, 3600, '1');
    }
  }
  
  /**
   * æ•æ„Ÿæ“ä½œå‘Šè­¦
   * @param {Object} auditData - å®¡è®¡æ•°æ®
   */
  async alertSensitiveOperation(auditData) {
    await this.sendAlert({
      type: 'SENSITIVE_OPERATION',
      severity: 'MEDIUM',
      message: `ç”¨æˆ· ${auditData.username} æ‰§è¡Œäº†æ•æ„Ÿæ“ä½œ: ${auditData.action}`,
      data: auditData
    });
  }
  
  /**
   * å¼‚å¸¸IPè®¿é—®æ£€æŸ¥
   * @param {Object} auditData - å®¡è®¡æ•°æ®
   */
  async checkAnomalousIPAccess(auditData) {
    if (!auditData.userId) return;
    
    // è·å–ç”¨æˆ·å†å²IP
    const historicalIPs = await redis.smembers(`user_ips:${auditData.userId}`);
    
    if (historicalIPs.length > 0 && !historicalIPs.includes(auditData.ipAddress)) {
      await this.sendAlert({
        type: 'ANOMALOUS_IP_ACCESS',
        severity: 'MEDIUM',
        message: `ç”¨æˆ· ${auditData.username} ä»æ–°IPåœ°å€ ${auditData.ipAddress} è®¿é—®ç³»ç»Ÿ`,
        data: { 
          userId: auditData.userId,
          newIP: auditData.ipAddress,
          historicalIPs 
        }
      });
    }
    
    // è®°å½•å½“å‰IP
    await redis.sadd(`user_ips:${auditData.userId}`, auditData.ipAddress);
    await redis.expire(`user_ips:${auditData.userId}`, 30 * 24 * 3600); // 30å¤©
  }
  
  /**
   * å‘é€å‘Šè­¦
   * @param {Object} alert - å‘Šè­¦ä¿¡æ¯
   */
  async sendAlert(alert) {
    const alertData = {
      ...alert,
      id: crypto.randomUUID(),
      timestamp: new Date().toISOString(),
      status: 'active'
    };
    
    // å­˜å‚¨å‘Šè­¦
    await redis.lpush('security_alerts', JSON.stringify(alertData));
    await redis.ltrim('security_alerts', 0, 999); // ä¿ç•™æœ€è¿‘1000æ¡
    
    // å®æ—¶æ¨é€å‘Šè­¦
    this.broadcastAlert(alertData);
    
    // å‘é€é€šçŸ¥
    await this.sendNotification(alertData);
  }
  
  /**
   * å®æ—¶æ¨é€å‘Šè­¦
   * @param {Object} alert - å‘Šè­¦ä¿¡æ¯
   */
  broadcastAlert(alert) {
    // WebSocketæ¨é€ç»™åœ¨çº¿ç®¡ç†å‘˜
    const io = require('../socket');
    io.to('admins').emit('security_alert', alert);
  }
}
```

## é…ç½®ç®¡ç†

### 1. å®‰å…¨é…ç½®

#### ç³»ç»Ÿå®‰å…¨é…ç½®
```javascript
const SECURITY_CONFIG = {
  // å¯†ç ç­–ç•¥
  password: {
    minLength: 8,
    maxLength: 128,
    requireUppercase: true,
    requireLowercase: true,
    requireNumbers: true,
    requireSpecialChars: true,
    maxAge: 90 * 24 * 60 * 60 * 1000, // 90å¤©
    historyCount: 5 // ä¸èƒ½é‡å¤ä½¿ç”¨æœ€è¿‘5ä¸ªå¯†ç 
  },
  
  // ä¼šè¯ç®¡ç†
  session: {
    accessTokenExpiry: 15 * 60, // 15åˆ†é’Ÿ
    refreshTokenExpiry: 7 * 24 * 60 * 60, // 7å¤©
    maxConcurrentSessions: 3, // æœ€å¤§å¹¶å‘ä¼šè¯æ•°
    idleTimeout: 30 * 60 // 30åˆ†é’Ÿæ— æ“ä½œè‡ªåŠ¨ç™»å‡º
  },
  
  // ç™»å½•å®‰å…¨
  login: {
    maxFailedAttempts: 5,
    lockoutDuration: 60 * 60, // 1å°æ—¶
    requireTwoFactor: false, // æ˜¯å¦å¼ºåˆ¶2FA
    allowedIPRanges: [] // å…è®¸çš„IPèŒƒå›´
  },
  
  // æ“ä½œé™åˆ¶
  operations: {
    sensitiveOperationLimit: 10, // æ¯å°æ—¶æ•æ„Ÿæ“ä½œæ¬¡æ•°é™åˆ¶
    bulkOperationLimit: 100, // æ‰¹é‡æ“ä½œæ•°é‡é™åˆ¶
    exportLimit: 10000 // å¯¼å‡ºæ•°æ®æ¡æ•°é™åˆ¶
  },
  
  // æ•°æ®ä¿æŠ¤
  dataProtection: {
    encryptSensitiveData: true,
    maskingEnabled: true,
    auditLogRetention: 365 * 24 * 60 * 60, // å®¡è®¡æ—¥å¿—ä¿ç•™1å¹´
    backupEncryption: true
  }
};
```

### 2. æƒé™é…ç½®ç®¡ç†

#### åŠ¨æ€æƒé™é…ç½®
```javascript
/**
 * æƒé™é…ç½®ç®¡ç†
 */
class PermissionConfigManager {
  /**
   * è·å–æƒé™é…ç½®
   * @returns {Object} æƒé™é…ç½®
   */
  async getPermissionConfig() {
    const config = await redis.get('permission_config');
    return config ? JSON.parse(config) : this.getDefaultConfig();
  }
  
  /**
   * æ›´æ–°æƒé™é…ç½®
   * @param {Object} config - æ–°é…ç½®
   */
  async updatePermissionConfig(config) {
    // éªŒè¯é…ç½®æ ¼å¼
    this.validateConfig(config);
    
    // ä¿å­˜é…ç½®
    await redis.set('permission_config', JSON.stringify(config));
    
    // æ¸…é™¤æƒé™ç¼“å­˜
    await this.clearPermissionCache();
    
    // è®°å½•é…ç½®å˜æ›´
    await this.logConfigChange(config);
  }
  
  /**
   * è·å–é»˜è®¤é…ç½®
   * @returns {Object} é»˜è®¤æƒé™é…ç½®
   */
  getDefaultConfig() {
    return {
      roles: SYSTEM_ROLES,
      permissions: SYSTEM_PERMISSIONS,
      rules: {
        // æƒé™ç»§æ‰¿è§„åˆ™
        inheritance: {
          'super_admin': ['admin', 'finance_manager', 'operation_manager'],
          'admin': ['finance_manager', 'operation_manager', 'customer_service'],
          'finance_manager': ['auditor'],
          'operation_manager': ['customer_service']
        },
        
        // æƒé™çº¦æŸè§„åˆ™
        constraints: {
          // ä¸èƒ½åˆ é™¤è‡ªå·±
          'admin:delete': {
            condition: 'target_id != user_id',
            message: 'ä¸èƒ½åˆ é™¤è‡ªå·±çš„è´¦æˆ·'
          },
          
          // ä¸èƒ½ä¿®æ”¹æ›´é«˜çº§åˆ«çš„ç”¨æˆ·
          'admin:update': {
            condition: 'target_level <= user_level',
            message: 'ä¸èƒ½ä¿®æ”¹æ›´é«˜çº§åˆ«çš„ç®¡ç†å‘˜'
          }
        }
      }
    };
  }
}
```

## éƒ¨ç½²å’Œè¿ç»´

### 1. å®‰å…¨éƒ¨ç½²é…ç½®

#### Dockerå®‰å…¨é…ç½®
```dockerfile
# Dockerfile
FROM node:18-alpine

# åˆ›å»ºérootç”¨æˆ·
RUN addgroup -g 1001 -S nodejs
RUN adduser -S nextjs -u 1001

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å¤åˆ¶ä¾èµ–æ–‡ä»¶
COPY package*.json ./
RUN npm ci --only=production && npm cache clean --force

# å¤åˆ¶åº”ç”¨ä»£ç 
COPY --chown=nextjs:nodejs . .

# åˆ‡æ¢åˆ°érootç”¨æˆ·
USER nextjs

# æš´éœ²ç«¯å£
EXPOSE 3000

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD curl -f http://localhost:3000/api/health || exit 1

# å¯åŠ¨åº”ç”¨
CMD ["npm", "start"]
```

#### Nginxå®‰å…¨é…ç½®
```nginx
# nginx.conf
server {
    listen 443 ssl http2;
    server_name admin.wallet.com;
    
    # SSLé…ç½®
    ssl_certificate /etc/ssl/certs/admin.wallet.com.crt;
    ssl_certificate_key /etc/ssl/private/admin.wallet.com.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512;
    ssl_prefer_server_ciphers off;
    
    # å®‰å…¨å¤´
    add_header Strict-Transport-Security "max-age=63072000" always;
    add_header X-Frame-Options DENY always;
    add_header X-Content-Type-Options nosniff always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';" always;
    
    # éšè—æœåŠ¡å™¨ä¿¡æ¯
    server_tokens off;
    
    # é™åˆ¶è¯·æ±‚å¤§å°
    client_max_body_size 10M;
    
    # é€Ÿç‡é™åˆ¶
    limit_req_zone $binary_remote_addr zone=admin:10m rate=10r/m;
    limit_req zone=admin burst=20 nodelay;
    
    # ä»£ç†é…ç½®
    location /api/ {
        proxy_pass http://backend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # è¶…æ—¶è®¾ç½®
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }
    
    # é™æ€æ–‡ä»¶
    location / {
        root /var/www/admin;
        index index.html;
        try_files $uri $uri/ /index.html;
        
        # ç¼“å­˜è®¾ç½®
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }
}

# HTTPé‡å®šå‘åˆ°HTTPS
server {
    listen 80;
    server_name admin.wallet.com;
    return 301 https://$server_name$request_uri;
}
```

### 2. ç›‘æ§å’Œå‘Šè­¦

#### å®‰å…¨ç›‘æ§æŒ‡æ ‡
```javascript
/**
 * å®‰å…¨ç›‘æ§æŒ‡æ ‡æ”¶é›†
 */
class SecurityMetrics {
  /**
   * æ”¶é›†ç™»å½•æŒ‡æ ‡
   */
  async collectLoginMetrics() {
    const metrics = {
      totalLogins: await this.getTotalLogins(),
      failedLogins: await this.getFailedLogins(),
      uniqueUsers: await this.getUniqueUsers(),
      suspiciousIPs: await this.getSuspiciousIPs(),
      twoFactorUsage: await this.getTwoFactorUsage()
    };
    
    return metrics;
  }
  
  /**
   * æ”¶é›†æƒé™æŒ‡æ ‡
   */
  async collectPermissionMetrics() {
    const metrics = {
      permissionDenials: await this.getPermissionDenials(),
      privilegeEscalations: await this.getPrivilegeEscalations(),
      roleChanges: await this.getRoleChanges(),
      sensitiveOperations: await this.getSensitiveOperations()
    };
    
    return metrics;
  }
  
  /**
   * æ”¶é›†ç³»ç»Ÿå®‰å…¨æŒ‡æ ‡
   */
  async collectSystemSecurityMetrics() {
    const metrics = {
      activeAlerts: await this.getActiveAlerts(),
      blockedIPs: await this.getBlockedIPs(),
      sessionCount: await this.getActiveSessionCount(),
      dataBreachAttempts: await this.getDataBreachAttempts()
    };
    
    return metrics;
  }
}
```

### 3. å¤‡ä»½å’Œæ¢å¤

#### å®‰å…¨æ•°æ®å¤‡ä»½
```javascript
/**
 * å®‰å…¨æ•°æ®å¤‡ä»½ç®¡ç†
 */
class SecurityBackupManager {
  /**
   * å¤‡ä»½å®‰å…¨é…ç½®
   */
  async backupSecurityConfig() {
    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
    const backupData = {
      timestamp,
      roles: await this.exportRoles(),
      permissions: await this.exportPermissions(),
      userRoles: await this.exportUserRoles(),
      securityConfig: await this.exportSecurityConfig(),
      auditLogs: await this.exportRecentAuditLogs()
    };
    
    // åŠ å¯†å¤‡ä»½æ•°æ®
    const encryptedData = this.encryptBackupData(backupData);
    
    // ä¿å­˜åˆ°å®‰å…¨å­˜å‚¨
    await this.saveBackupToSecureStorage(
      `security-backup-${timestamp}.enc`,
      encryptedData
    );
    
    return {
      success: true,
      backupId: `security-backup-${timestamp}`,
      size: encryptedData.length
    };
  }
  
  /**
   * æ¢å¤å®‰å…¨é…ç½®
   * @param {string} backupId - å¤‡ä»½ID
   */
  async restoreSecurityConfig(backupId) {
    // ä»å®‰å…¨å­˜å‚¨è·å–å¤‡ä»½
    const encryptedData = await this.getBackupFromSecureStorage(backupId);
    
    // è§£å¯†å¤‡ä»½æ•°æ®
    const backupData = this.decryptBackupData(encryptedData);
    
    // éªŒè¯å¤‡ä»½å®Œæ•´æ€§
    if (!this.validateBackupIntegrity(backupData)) {
      throw new Error('å¤‡ä»½æ•°æ®å®Œæ•´æ€§éªŒè¯å¤±è´¥');
    }
    
    // å¼€å§‹æ¢å¤è¿‡ç¨‹
    await this.performRestore(backupData);
    
    return {
      success: true,
      restoredAt: new Date().toISOString()
    };
  }
}
```

## å®‰å…¨æµ‹è¯•å’ŒéªŒè¯

### 1. å®‰å…¨æµ‹è¯•ç”¨ä¾‹

#### è®¤è¯å®‰å…¨æµ‹è¯•
```javascript
/**
 * è®¤è¯å®‰å…¨æµ‹è¯•å¥—ä»¶
 */
describe('è®¤è¯å®‰å…¨æµ‹è¯•', () => {
  test('å¯†ç å¼ºåº¦éªŒè¯', async () => {
    const weakPasswords = [
      '123456',
      'password',
      'qwerty',
      'abc123',
      '111111'
    ];
    
    for (const password of weakPasswords) {
      const result = passwordSecurity.validatePasswordStrength(password);
      expect(result.isValid).toBe(false);
    }
  });
  
  test('ç™»å½•å¤±è´¥é”å®š', async () => {
    const testIP = '192.168.1.100';
    
    // æ¨¡æ‹Ÿ5æ¬¡å¤±è´¥ç™»å½•
    for (let i = 0; i < 5; i++) {
      await request(app)
        .post('/api/admin/login')
        .send({ username: 'test', password: 'wrong' })
        .set('X-Forwarded-For', testIP);
    }
    
    // ç¬¬6æ¬¡åº”è¯¥è¢«é˜»æ­¢
    const response = await request(app)
      .post('/api/admin/login')
      .send({ username: 'test', password: 'correct' })
      .set('X-Forwarded-For', testIP);
    
    expect(response.status).toBe(429);
  });
  
  test('åŒå› ç´ è®¤è¯', async () => {
    const user = await createTestUser({ twoFactorEnabled: true });
    const secret = user.twoFactorSecret;
    
    // ç”Ÿæˆæœ‰æ•ˆçš„TOTPç 
    const validToken = speakeasy.totp({
      secret,
      encoding: 'base32'
    });
    
    const response = await request(app)
      .post('/api/admin/login')
      .send({
        username: user.username,
        password: 'correct',
        totpCode: validToken
      });
    
    expect(response.status).toBe(200);
    expect(response.body.success).toBe(true);
  });
});
```

#### æƒé™æ§åˆ¶æµ‹è¯•
```javascript
/**
 * æƒé™æ§åˆ¶æµ‹è¯•å¥—ä»¶
 */
describe('æƒé™æ§åˆ¶æµ‹è¯•', () => {
  test('è§’è‰²æƒé™éªŒè¯', async () => {
    const customerService = await createTestUser({ role: 'customer_service' });
    const token = generateTestToken(customerService);
    
    // å®¢æœä¸åº”è¯¥èƒ½å¤Ÿåˆ é™¤ç”¨æˆ·
    const response = await request(app)
      .delete('/api/admin/users/123')
      .set('Authorization', `Bearer ${token}`);
    
    expect(response.status).toBe(403);
  });
  
  test('æ•°æ®è®¿é—®æƒé™', async () => {
    const auditor = await createTestUser({ role: 'auditor' });
    const token = generateTestToken(auditor);
    
    // å®¡è®¡å‘˜åº”è¯¥åªèƒ½æŸ¥çœ‹æ•°æ®ï¼Œä¸èƒ½ä¿®æ”¹
    const getResponse = await request(app)
      .get('/api/admin/users')
      .set('Authorization', `Bearer ${token}`);
    
    expect(getResponse.status).toBe(200);
    
    const updateResponse = await request(app)
      .put('/api/admin/users/123')
      .set('Authorization', `Bearer ${token}`)
      .send({ status: 'inactive' });
    
    expect(updateResponse.status).toBe(403);
  });
  
  test('ä¸Šä¸‹æ–‡æƒé™éªŒè¯', async () => {
    const admin = await createTestUser({ role: 'admin' });
    const superAdmin = await createTestUser({ role: 'super_admin' });
    const adminToken = generateTestToken(admin);
    
    // æ™®é€šç®¡ç†å‘˜ä¸èƒ½ä¿®æ”¹è¶…çº§ç®¡ç†å‘˜
    const response = await request(app)
      .put(`/api/admin/users/${superAdmin.id}`)
      .set('Authorization', `Bearer ${adminToken}`)
      .send({ status: 'inactive' });
    
    expect(response.status).toBe(403);
  });
});
```

### 2. å®‰å…¨æ¼æ´æ£€æµ‹

#### è‡ªåŠ¨åŒ–å®‰å…¨æ‰«æ
```javascript
/**
 * å®‰å…¨æ¼æ´æ‰«æå™¨
 */
class SecurityScanner {
  /**
   * SQLæ³¨å…¥æ£€æµ‹
   */
  async scanSQLInjection() {
    const testPayloads = [
      "' OR '1'='1",
      "'; DROP TABLE users; --",
      "' UNION SELECT * FROM admin_users --",
      "1' AND (SELECT COUNT(*) FROM admin_users) > 0 --"
    ];
    
    const vulnerabilities = [];
    
    for (const payload of testPayloads) {
      try {
        const response = await request(app)
          .get('/api/admin/users')
          .query({ search: payload });
        
        if (response.status === 200 && this.detectSQLInjectionSuccess(response.body)) {
          vulnerabilities.push({
            type: 'SQL_INJECTION',
            payload,
            endpoint: '/api/admin/users',
            severity: 'HIGH'
          });
        }
      } catch (error) {
        // é¢„æœŸçš„é”™è¯¯ï¼Œè¯´æ˜æœ‰é˜²æŠ¤
      }
    }
    
    return vulnerabilities;
  }
  
  /**
   * XSSæ¼æ´æ£€æµ‹
   */
  async scanXSS() {
    const testPayloads = [
      '<script>alert("XSS")</script>',
      '"><script>alert("XSS")</script>',
      'javascript:alert("XSS")',
      '<img src=x onerror=alert("XSS")>'
    ];
    
    const vulnerabilities = [];
    
    for (const payload of testPayloads) {
      const response = await request(app)
        .post('/api/admin/users')
        .send({ name: payload });
      
      if (response.body && response.body.toString().includes(payload)) {
        vulnerabilities.push({
          type: 'XSS',
          payload,
          endpoint: '/api/admin/users',
          severity: 'MEDIUM'
        });
      }
    }
    
    return vulnerabilities;
  }
  
  /**
   * æƒé™ç»•è¿‡æ£€æµ‹
   */
  async scanPrivilegeEscalation() {
    const vulnerabilities = [];
    
    // æµ‹è¯•æœªæˆæƒè®¿é—®
    const unauthorizedEndpoints = [
      '/api/admin/system/config',
      '/api/admin/users/export',
      '/api/admin/backup'
    ];
    
    for (const endpoint of unauthorizedEndpoints) {
      const response = await request(app).get(endpoint);
      
      if (response.status === 200) {
        vulnerabilities.push({
          type: 'UNAUTHORIZED_ACCESS',
          endpoint,
          severity: 'HIGH'
        });
      }
    }
    
    return vulnerabilities;
  }
}
```

## æ€»ç»“

æœ¬å®‰å…¨å’Œæƒé™ç³»ç»Ÿè®¾è®¡æ–‡æ¡£æä¾›äº†å®Œæ•´çš„ç®¡ç†åå°å®‰å…¨è§£å†³æ–¹æ¡ˆï¼ŒåŒ…æ‹¬ï¼š

### æ ¸å¿ƒç‰¹æ€§
1. **å¤šå±‚å®‰å…¨é˜²æŠ¤** - ç½‘ç»œã€åº”ç”¨ã€è®¤è¯ã€æ•°æ®å››å±‚å®‰å…¨æ¶æ„
2. **RBACæƒé™æ¨¡å‹** - åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼Œæ”¯æŒç»†ç²’åº¦æƒé™ç®¡ç†
3. **å¼ºèº«ä»½è®¤è¯** - å¯†ç ç­–ç•¥ã€åŒå› ç´ è®¤è¯ã€ä¼šè¯ç®¡ç†
4. **å…¨é¢å®¡è®¡** - æ“ä½œæ—¥å¿—ã€å®‰å…¨äº‹ä»¶ç›‘æ§ã€å®æ—¶å‘Šè­¦
5. **æ•°æ®ä¿æŠ¤** - æ•°æ®åŠ å¯†ã€è„±æ•ã€å¤‡ä»½æ¢å¤

### å®‰å…¨ä¿éšœ
- é˜²æ­¢å¸¸è§Webæ”»å‡»ï¼ˆSQLæ³¨å…¥ã€XSSã€CSRFç­‰ï¼‰
- å®æ—¶å®‰å…¨ç›‘æ§å’Œå‘Šè­¦
- å®Œæ•´çš„å®¡è®¡è¿½è¸ª
- è‡ªåŠ¨åŒ–å®‰å…¨æµ‹è¯•å’Œæ¼æ´æ£€æµ‹
- ç¾éš¾æ¢å¤å’Œä¸šåŠ¡è¿ç»­æ€§

### åˆè§„æ€§
- ç¬¦åˆé‡‘èè¡Œä¸šå®‰å…¨æ ‡å‡†
- æ»¡è¶³æ•°æ®ä¿æŠ¤æ³•è§„è¦æ±‚
- å®Œæ•´çš„æ“ä½œå®¡è®¡è®°å½•
- æ•°æ®è®¿é—®æƒé™æ§åˆ¶

è¯¥ç³»ç»Ÿè®¾è®¡ç¡®ä¿äº†ç®¡ç†åå°çš„é«˜å®‰å…¨æ€§ã€å¯æ§æ€§å’Œåˆè§„æ€§ï¼Œä¸ºæ•°å­—é’±åŒ…ä¸šåŠ¡æä¾›äº†åšå®çš„å®‰å…¨åŸºç¡€ã€‚