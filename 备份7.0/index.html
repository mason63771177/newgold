<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>è£‚é‡‘7æ—¥ H5 é¡µé¢</title>
  
  <!-- Google Tag Manager -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-K7WCTWLM');</script>
  <!-- End Google Tag Manager -->
  
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-QQ6GQ79K7G"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-QQ6GQ79K7G');
  </script>
  
  <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- iOS Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="è£‚é‡‘7æ—¥">
    
    <!-- iOS Icons -->
    <link rel="apple-touch-icon" sizes="152x152" href="å›¾æ ‡æ–‡ä»¶/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="å›¾æ ‡æ–‡ä»¶/icon-192x192.png">
    
    <!-- Android Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="å›¾æ ‡æ–‡ä»¶/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="å›¾æ ‡æ–‡ä»¶/icon-512x512.png">
    
    <!-- Splash Screens -->
    <link rel="apple-touch-startup-image" href="å›¾æ ‡æ–‡ä»¶/splash-390x844.png" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3)">
    <link rel="apple-touch-startup-image" href="å›¾æ ‡æ–‡ä»¶/splash-414x896.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2)">
    
    <!-- Theme Color -->
    <meta name="theme-color" content="#0b0f14">
    <meta name="msapplication-navbutton-color" content="#0b0f14">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <link rel="stylesheet" href="public/themes.css">
    <link rel="stylesheet" href="public/css/global-background.css">
    <link rel="stylesheet" href="public/css/native-optimization.css">
    <link rel="stylesheet" href="public/websocket.css">
  
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100vh;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
        "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      font-size: 16px;
      overflow: hidden;
    }

    /* åº”ç”¨å®¹å™¨ 100vh ä¸‰æ®µå¼å¸ƒå±€ */
    .app {
      height: 100vh;
      display: flex;
      flex-direction: column;
      position: relative;
      z-index: 1;
    }



    /* é¡¶éƒ¨åŒºåŸŸ - å›ºå®šé«˜åº¦ */
    .header {
      flex: 0 0 65px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
      padding-top: 0px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-color);
      z-index: 100;
    }
    
    .header-main {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
      margin: 0;
      padding: 0 20px;
      position: relative;
      width: 100%;
    }
    
    .status-info {
      display: none; /* éšè—çŠ¶æ€ä¿¡æ¯åŒºåŸŸ */
      align-items: center;
      gap: 6px;
    }
    .logo {
      font-size: 32px;
      font-weight: 700;
      letter-spacing: 1px;
      background: var(--btn-gradient);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      filter: var(--logo-filter);
    }

    /* æ–°çš„ logo å›¾ç‰‡æ ·å¼ - å±…ä¸­æ˜¾ç¤º */
    .logo-img {
      width: 80px;
      height: 80px;
      object-fit: contain;
      filter: var(--logo-filter);
      margin: 0 auto;
    }
    .state-label {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-secondary);
    }

    /* æ¶ˆæ¯å›¾æ ‡æ ·å¼ */
    .message-icon {
      position: fixed !important;
      left: 10px !important;
      top: 10px !important;
      width: 48px;
      height: 48px;
      cursor: pointer;
      z-index: 101;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      touch-action: none;
    }

    /* æ‹–æ‹½çŠ¶æ€æ ·å¼ */
    .message-icon.dragging {
      transition: none;
      transform: scale(1.1);
      opacity: 0.8;
      cursor: grabbing;
    }

    .message-icon:hover:not(.dragging) {
      transform: scale(1.1);
    }

    .message-icon img {
      width: 36px;
      height: 36px;
      transition: all 0.3s ease;
    }

    .message-icon svg {
      width: 36px;
      height: 36px;
      transition: all 0.3s ease;
    }

    .message-icon:hover:not(.dragging) img,
    .message-icon:hover:not(.dragging) svg {
      filter: brightness(1.1);
    }

    /* æœªè¯»æ¶ˆæ¯æç¤ºç‚¹ */
    .unread-dot {
      position: absolute;
      top: -3px;
      right: -3px;
      width: 14px;
      height: 14px;
      background: #ff4444;
      border-radius: 50%;
      border: 2px solid var(--bg-secondary);
      opacity: 0;
      transform: scale(0);
      transition: all 0.3s ease;
      box-shadow: 0 0 8px rgba(255, 68, 68, 0.6);
    }

    .unread-dot.show {
      opacity: 1;
      transform: scale(1);
      /* ç§»é™¤è¿‡åº¦çš„è„‰å†²åŠ¨ç”»ï¼Œä¿æŒä¸“ä¸šæ„Ÿ */
    }

    /* ç§»é™¤æŠ–åŠ¨åŠ¨ç”» - ä¿æŒä¸“ä¸šæ„Ÿ */
    .message-icon.shake {
      /* ç§»é™¤æŠ–åŠ¨æ•ˆæœï¼Œä¿æŒä¸“ä¸šå•†åŠ¡æ„Ÿ */
    }

    /* ç§»é™¤æŒç»­è½»å¾®æŠ–åŠ¨æ•ˆæœ */
    .message-icon.has-unread {
      /* ç§»é™¤æŒç»­æŠ–åŠ¨ï¼Œä¿æŒä¸“ä¸šæ„Ÿ */
    }

    .state-label {
      text-shadow: 0 0 6px var(--accent-color);
    }
    .subtitle {
      font-size: 11px;
      color: var(--text-secondary);
      opacity: 0.8;
    }
    /* å¼€å‘æµ‹è¯•æŒ‰é’®ï¼Œå¯éšè—äºç”Ÿäº§ç¯å¢ƒ */
    .test-btn {
      position: fixed;
      top: 70px;
      right: 10px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      color: var(--accent-color);
      font-size: 12px;
      padding: 3px 6px;
      z-index: 998;
    }
    
    .reset-btn {
      position: fixed;
      top: 120px;
      right: 10px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      color: #ff6464;
      font-size: 12px;
      padding: 3px 6px;
      cursor: pointer;
      transition: all 0.3s ease;
      z-index: 998;
    }
    
    .reset-btn:hover {
      background: linear-gradient(135deg, #ff6464, #ff4444);
      color: var(--text-primary);
      transform: translateY(-1px);
    }
    
    .settings-btn {
      background: rgba(255,255,255,0.2) !important;
      color: #ffffff !important;
      border: 1px solid rgba(255,255,255,0.4) !important;
      border-radius: 8px !important;
      padding: 6px 10px !important;
      font-size: 14px !important;
      cursor: pointer !important;
      position: fixed !important;
      top: 10px !important;
      right: 10px !important;
      z-index: 999 !important;
      opacity: 0.9 !important;
      transition: all 0.3s ease !important;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3) !important;
    }
    
    .settings-btn:hover {
      opacity: 1 !important;
      background: rgba(255,255,255,0.3) !important;
      border-color: rgba(255,255,255,0.6) !important;
      transform: scale(1.05) !important;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4) !important;
    }
    
    .theme-demo-btn {
      position: absolute;
      top: 8px;
      left: 12px;
      background: var(--btn-gradient);
      border: none;
      border-radius: 6px;
      color: var(--text-primary);
      font-size: 12px;
      padding: 3px 6px;
      cursor: pointer;
      box-shadow: var(--btn-shadow);
      transition: all 0.3s ease;
    }
    
    .theme-demo-btn:hover {
       transform: translateY(-1px);
       filter: brightness(1.1);
     }
     
     .test-btn {
       cursor: pointer;
       transition: all 0.3s ease;
    }
    .test-btn:hover {
      background: var(--btn-gradient);
      color: var(--text-primary);
    }

    /* ä¸­éƒ¨å†…å®¹å¡ç‰‡åŒºåŸŸ - å¯æ»šåŠ¨ */
    .content {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden; /* ç¦æ­¢æ°´å¹³æ»šåŠ¨ */
      padding: 16px;
      padding-bottom: 100px; /* ä¸ºåº•éƒ¨å›ºå®šæŒ‰é’®ç•™å‡ºç©ºé—´ */
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .card {
      width: 100%;
      max-width: 480px;
      background: var(--bg-card);
      border-radius: 24px;
      padding: 24px;
      border: 1px solid var(--border-color);
      box-shadow: var(--btn-shadow);
      backdrop-filter: blur(16px);
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    .section {
      margin-bottom: 16px;
      position: relative;
    }
    .section:last-child {
      margin-bottom: 0;
    }
    /* å…‰æ•ˆåˆ†å‰²çº¿ */
    .section:not(:last-child)::after {
      content: "";
      position: absolute;
      bottom: -8px;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, var(--accent-color), transparent);
      opacity: 0.4;
    }
    .section-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 6px;
      color: var(--text-secondary);
    }
    .section-content {
      font-size: 14px;
      line-height: 1.4;
      color: var(--text-primary);
      opacity: 0.9;
    }
    /* ä»»åŠ¡åˆ—è¡¨æ ·å¼ */
    .task-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .task-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 0;
    }
    .task-item:not(:last-child) {
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }
    .task-title {
      flex: 1;
      font-size: 14px;
      color: #e0e5fb;
    }
    .task-status {
      font-size: 12px;
      padding: 2px 6px;
      border-radius: 12px;
      background: linear-gradient(45deg, #00eaff, #0088ff);
      box-shadow: 0 0 6px rgba(0, 136, 255, 0.6);
      color: #031e2e;
    }
    .task-status.done {
      background: linear-gradient(45deg, #9be15d, #00e3ae);
      box-shadow: 0 0 6px rgba(0, 227, 174, 0.6);
    }
    
    /* ä»»åŠ¡ä¸­å¿ƒæ ·å¼ */
    .task-overview {
      margin-bottom: 20px;
      padding: 16px;
      background: linear-gradient(135deg, rgba(0, 136, 255, 0.1), rgba(0, 234, 255, 0.05));
      border-radius: 12px;
      border: 1px solid rgba(0, 136, 255, 0.2);
    }
    
    .task-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }
    
    .stat-item {
      text-align: center;
      padding: 8px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .stat-label {
      display: block;
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }
    
    .stat-value {
      display: block;
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .task-sections {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    .task-section {
      background: rgba(255, 255, 255, 0.03);
      border-radius: 12px;
      padding: 16px;
      border: 1px solid rgba(255, 255, 255, 0.08);
    }
    
    .task-section h4 {
      margin: 0 0 12px 0;
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .task-item.completed {
      background: linear-gradient(135deg, rgba(155, 225, 93, 0.15), rgba(0, 227, 174, 0.1));
      border-color: rgba(0, 227, 174, 0.3);
    }
    
    .task-item.current {
      background: linear-gradient(135deg, rgba(0, 234, 255, 0.15), rgba(0, 136, 255, 0.1));
      border-color: rgba(0, 136, 255, 0.4);
      box-shadow: 0 0 12px rgba(0, 136, 255, 0.3);
    }
    
    .task-item.available {
      background: linear-gradient(135deg, rgba(255, 193, 7, 0.15), rgba(255, 152, 0, 0.1));
      border-color: rgba(255, 193, 7, 0.3);
    }
    
    .task-item.locked {
      background: rgba(255, 255, 255, 0.02);
      border-color: rgba(255, 255, 255, 0.05);
      opacity: 0.6;
    }
    
    .task-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .task-reward {
      font-size: 12px;
      color: var(--accent-color);
      font-weight: 600;
    }
    
    .task-item.completed .task-status {
      background: linear-gradient(45deg, #9be15d, #00e3ae);
      color: #031e2e;
      box-shadow: 0 0 6px rgba(0, 227, 174, 0.4);
    }
    
    .task-item.current .task-status {
      background: linear-gradient(45deg, #00eaff, #0088ff);
      color: #031e2e;
      box-shadow: 0 0 6px rgba(0, 136, 255, 0.4);
    }
    
    .task-item.available .task-status {
      background: linear-gradient(45deg, #ffc107, #ff9800);
      color: #1a1a1a;
      box-shadow: 0 0 6px rgba(255, 193, 7, 0.4);
    }
    
    .task-item.locked .task-status {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-secondary);
    }
    
    /* é€šçŸ¥ä¸­å¿ƒæ ·å¼ */
    .notification-center {
      max-height: 400px;
      overflow-y: auto;
    }
    
    .notification-item {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 12px;
      margin-bottom: 8px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .notification-item:hover {
      background: rgba(255, 255, 255, 0.08);
      transform: translateY(-1px);
    }
    
    .notification-item.redpacket_notification {
      border-color: rgba(255, 107, 107, 0.3);
      background: linear-gradient(135deg, rgba(255, 107, 107, 0.1), rgba(255, 193, 7, 0.05));
    }
    
    .notification-item.task_complete {
      border-color: rgba(0, 227, 174, 0.3);
      background: linear-gradient(135deg, rgba(155, 225, 93, 0.1), rgba(0, 227, 174, 0.05));
    }
    
    .notification-item.balance_update {
      border-color: rgba(0, 136, 255, 0.3);
      background: linear-gradient(135deg, rgba(0, 234, 255, 0.1), rgba(0, 136, 255, 0.05));
    }
    
    .notification-icon {
      font-size: 20px;
      line-height: 1;
      margin-top: 2px;
    }
    
    .notification-content {
      flex: 1;
    }
    
    .notification-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 4px;
    }
    
    .notification-message {
      font-size: 13px;
      color: var(--text-secondary);
      line-height: 1.4;
      margin-bottom: 4px;
    }
    
    .notification-time {
      font-size: 11px;
      color: var(--text-muted);
    }
    
    .no-notifications {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-secondary);
      font-size: 14px;
    }
    
    /* æµ®åŠ¨é€šçŸ¥æ ·å¼ */
    .floating-notification {
      position: fixed;
      top: 20px;
      right: 20px;
      max-width: 300px;
      background: rgba(0, 0, 0, 0.9);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(10px);
      z-index: 10000;
      animation: slideInRight 0.3s ease-out;
      cursor: pointer;
    }
    
    @keyframes slideInRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    .floating-notification.slide-out {
      animation: slideOutRight 0.3s ease-in forwards;
    }
    
    @keyframes slideOutRight {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(100%);
        opacity: 0;
      }
    }
    
    .floating-notification-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }
    
    .floating-notification-icon {
      font-size: 18px;
    }
    
    .floating-notification-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      flex: 1;
    }
    
    .floating-notification-close {
      background: none;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 16px;
      padding: 0;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .floating-notification-message {
      font-size: 13px;
      color: var(--text-secondary);
      line-height: 1.4;
    }
    
    /* å†æ¬¡æ¿€æ´»çªå‡ºæ ·å¼ */
    .reactivate-highlight {
      background: linear-gradient(135deg, rgba(255, 107, 107, 0.15), rgba(255, 193, 7, 0.15));
      border: 2px solid rgba(255, 107, 107, 0.3);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
      position: relative;
      overflow: hidden;
    }
    .reactivate-highlight::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
      animation: shimmer 2s infinite;
    }
    @keyframes shimmer {
      0% { left: -100%; }
      100% { left: 100%; }
    }
    .reactivate-highlight .section-title {
      color: #ff6b6b;
      font-size: 18px;
      font-weight: 700;
      text-shadow: 0 0 10px rgba(255, 107, 107, 0.5);
    }
    .reactivate-btn {
      background: linear-gradient(45deg, #ff6b6b, #ffc107);
      border: none;
      border-radius: 25px;
      padding: 12px 24px;
      font-size: 16px;
      font-weight: 600;
      color: white;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
      transition: all 0.3s ease;
      width: 100%;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    }
    .reactivate-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 107, 107, 0.6);
    }
    .reactivate-btn:active {
       transform: translateY(0);
     }

    /* åº•éƒ¨æŒ‰é’®åŒºåŸŸ - å›ºå®šåœ¨å±å¹•åº•éƒ¨ */
    .bottom {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 12px 16px calc(20px + env(safe-area-inset-bottom, 0px));
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      /* åŠé€æ˜èƒŒæ™¯ä¸æ¨¡ç³Šï¼Œä»¿åŸç”Ÿåº•éƒ¨æ  */
      background: rgba(255, 255, 255, 0.06);
      backdrop-filter: blur(16px);
      border-top: 1px solid rgba(255, 255, 255, 0.12);
      margin: 0 12px 12px;
      border-radius: 24px 24px 0 0;
      z-index: 100;
      /* æ·»åŠ å¾®å¦™çš„å†…é˜´å½±å¢å¼ºå±‚æ¬¡æ„Ÿ */
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.1),
                  0 -4px 20px rgba(0, 0, 0, 0.1);
    }
    
    /* åŸºç¡€æŒ‰é’®æ ·å¼ - ç°ä»£å•†åŠ¡è®¾è®¡ */
    .bottom button {
      flex: 1;
      min-width: 0;
      min-height: 36px;
      border: none;
      border-radius: 18px;
      padding: 10px 8px;
      font-size: 13px;
      font-weight: 700;
      color: var(--text-primary);
      cursor: pointer;
      transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      position: relative;
      background: var(--btn-gradient);
      box-shadow: var(--btn-shadow);
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.25);
      border: 1px solid rgba(255, 255, 255, 0.15);
    }
    
    /* ä¸»è¦æŒ‰é’® - ç®€åŒ–ä¸ºä¸“ä¸šå•†åŠ¡é£æ ¼ */
    .bottom button.primary {
      font-size: 15px;
      font-weight: 800;
      padding: 17px 14px;
      min-height: 52px;
      background: var(--btn-gradient);
      box-shadow: var(--btn-shadow);
      border: 1px solid rgba(255, 255, 255, 0.15);
      /* ç§»é™¤è„‰å†²åŠ¨ç”»ï¼Œä¿æŒä¸“ä¸šæ„Ÿ */
    }
    
    /* é‡‘èç›¸å…³æŒ‰é’® - ä¸“ä¸šç¨³é‡çš„è®¾è®¡ */
    .bottom button.financial {
      background: var(--btn-gradient);
      box-shadow: var(--btn-shadow);
      font-weight: 800;
      position: relative;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    /* é‡‘èæŒ‰é’®å®‰å…¨æŒ‡ç¤ºå™¨ - æ›´ç²¾è‡´ */
    .bottom button.financial::before {
      content: "ğŸ”’";
      position: absolute;
      top: 3px;
      right: 6px;
      font-size: 11px;
      opacity: 0.9;
      filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.3));
    }
    
    /* æ¸¸æˆåŒ–æŒ‰é’® - ç®€åŒ–ä¸ºå•†åŠ¡é£æ ¼ */
    .bottom button.gaming {
      background: var(--btn-gradient);
      box-shadow: var(--btn-shadow);
      position: relative;
      border: 1px solid rgba(255, 255, 255, 0.15);
      /* ç§»é™¤è„‰å†²åŠ¨ç”»å’Œèƒ½é‡æµåŠ¨æ•ˆæœï¼Œä¿æŒä¸“ä¸šæ„Ÿ */
    }
    
    /* æ¬¡è¦æŒ‰é’® - æ›´æŸ”å’Œä½†ä¿æŒè´¨æ„Ÿ */
    .bottom button.secondary {
      background-image: linear-gradient(135deg, #78909C, #546E7A, #455A64);
      box-shadow: 0 4px 20px rgba(120, 144, 156, 0.25), 
                  inset 0 1px 0 rgba(255, 255, 255, 0.25),
                  0 2px 8px rgba(0, 0, 0, 0.1);
      font-size: 13px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    /* å½“æŒ‰é’®è¶…è¿‡6ä¸ªæ—¶ï¼Œè°ƒæ•´å¸ƒå±€ - ç§»åŠ¨ç«¯ä¼˜åŒ– */
    .bottom.many-buttons {
      justify-content: center;
      gap: 10px;
      padding: 16px 18px calc(26px + env(safe-area-inset-bottom, 0px));
    }
    .bottom.many-buttons button {
      flex: 0 1 calc(33.333% - 7px);
      margin: 2px;
      padding: 14px 10px;
      font-size: 12px;
      border-radius: 16px;
      min-height: 44px;
    }
    
    /* æŒ‰é’®é¢œè‰²æ¸å˜ - ä¿æŒå…¼å®¹æ€§ */
    .bottom button.red,
    .bottom button.orange,
    .bottom button.green,
    .bottom button.purple,
    .bottom button.blue {
      background: var(--btn-gradient);
      box-shadow: var(--btn-shadow), var(--btn-glow);
    }
    
    .bottom button:disabled {
      opacity: 0.4;
      cursor: default;
      filter: grayscale(0.8) brightness(0.7);
      transform: none !important;
      animation: none !important;
    }
    
    /* æ‚¬åœæ•ˆæœ - å¢å¼ºåé¦ˆå’Œæµ®èµ·æ„Ÿ */
    .bottom button:not(:disabled):hover {
      transform: translateY(-6px) scale(1.03);
      filter: brightness(1.2) saturate(1.15);
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    /* ä¸»è¦æŒ‰é’®æ‚¬åœæ•ˆæœ */
    .bottom button.primary:not(:disabled):hover {
      box-shadow: 0 14px 40px rgba(74, 144, 226, 0.6), 
                  inset 0 1px 0 rgba(255, 255, 255, 0.5),
                  0 5px 20px rgba(0, 0, 0, 0.25),
                  0 0 0 1px rgba(74, 144, 226, 0.4);
      animation: none; /* æ‚¬åœæ—¶æš‚åœè„‰å†² */
    }
    
    /* é‡‘èæŒ‰é’®æ‚¬åœæ•ˆæœ */
    .bottom button.financial:not(:disabled):hover {
      box-shadow: 0 12px 36px rgba(212, 175, 55, 0.5), 
                  inset 0 1px 0 rgba(255, 255, 255, 0.55),
                  0 4px 18px rgba(0, 0, 0, 0.25),
                  0 0 0 1px rgba(212, 175, 55, 0.4);
    }
    
    /* æ¸¸æˆåŒ–æŒ‰é’®æ‚¬åœæ•ˆæœ */
    .bottom button.gaming:not(:disabled):hover {
      box-shadow: 0 14px 40px rgba(156, 39, 176, 0.6), 
                  inset 0 1px 0 rgba(255, 255, 255, 0.45),
                  0 5px 20px rgba(0, 0, 0, 0.25),
                  0 0 0 1px rgba(156, 39, 176, 0.5);
      animation: none; /* æ‚¬åœæ—¶æš‚åœè„‰å†² */
    }
    
    /* æ¬¡è¦æŒ‰é’®æ‚¬åœæ•ˆæœ */
    .bottom button.secondary:not(:disabled):hover {
      box-shadow: 0 8px 28px rgba(120, 144, 156, 0.4), 
                  inset 0 1px 0 rgba(255, 255, 255, 0.35),
                  0 3px 14px rgba(0, 0, 0, 0.15);
    }
    
    /* ç‚¹å‡»æ•ˆæœ - æ›´æ˜æ˜¾çš„åé¦ˆ */
    .bottom button:not(:disabled):active {
      transform: translateY(-2px) scale(0.97);
      filter: brightness(0.85) saturate(1.1);
      transition: all 0.08s ease;
    }
    
    /* ç§»åŠ¨ç«¯è§¦æ‘¸ä¼˜åŒ– */
    @media (hover: none) and (pointer: coarse) {
      .bottom button:not(:disabled):active {
        transform: scale(0.95);
        filter: brightness(0.9);
        transition: all 0.1s ease;
      }
    }
    


    /* å€’è®¡æ—¶ä¼˜åŒ–æ ·å¼ */
    @keyframes countdownPulse {
      0%, 100% { 
        box-shadow: 0 8px 32px rgba(47, 128, 237, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.1);
      }
      50% { 
        box-shadow: 0 12px 40px rgba(47, 128, 237, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.15);
      }
    }
    
    @keyframes rotate {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }
    
    /* ç´§æ€¥çŠ¶æ€åŠ¨ç”» */
    @keyframes urgentPulse {
      0%, 100% { 
        box-shadow: 0 8px 32px rgba(255, 69, 58, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.1);
        border-color: #ff453a;
      }
      50% { 
        box-shadow: 0 12px 40px rgba(255, 69, 58, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.15);
        border-color: #ff6961;
      }
    }
    
    @keyframes urgentBlink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.1; }
    }
    
    /* è¿›åº¦æ¡é«˜çº§ç§‘æŠ€æµå…‰åŠ¨ç”» */
        @keyframes slideRight {
          0% {
            transform: translateX(-100%);
          }
          100% {
            transform: translateX(400%);
          }
        }
    
    /* å€’è®¡æ—¶å“åº”å¼è®¾è®¡ */
    @media (max-width: 480px) {
      .countdown-container {
        padding: 16px !important;
        margin: 0 -4px 16px -4px !important;
      }
      
      .countdown-container .time-display {
        font-size: 28px !important;
        letter-spacing: 1px !important;
      }
      
      .countdown-container .progress-ring {
        width: 70px !important;
        height: 70px !important;
      }
      
      .countdown-container .progress-ring svg {
        width: 70px !important;
        height: 70px !important;
      }
      
      .countdown-container .progress-ring circle {
        r: 30 !important;
        stroke-dasharray: 188 !important;
      }
      
      /* ç§»åŠ¨ç«¯æ—¶é—´æ˜¾ç¤ºåŒºåŸŸè°ƒæ•´ */
      .countdown-container .time-area {
        gap: 12px !important;
      }
      
      /* ç§»åŠ¨ç«¯çŠ¶æ€æç¤ºè°ƒæ•´ */
      .countdown-container #countdownStatus {
        font-size: 11px !important;
        padding: 6px 10px !important;
      }
      
      /* ç§»åŠ¨ç«¯æˆ˜ç»©å¡è°ƒæ•´ */
      .grid-stats {
        grid-template-columns: 1fr !important;
        gap: 8px !important;
        font-size: 11px !important;
      }
      
      .stat-item {
        padding: 8px !important;
        font-size: 11px !important;
      }
      
      .stat-value {
        font-size: 13px !important;
      }
    }
    
    @media (max-width: 360px) {
      .countdown-container {
        padding: 12px !important;
      }
      
      .countdown-container .time-display {
        font-size: 24px !important;
      }
      
      .countdown-container .progress-ring {
        width: 60px !important;
        height: 60px !important;
      }
      
      .countdown-container .progress-ring svg {
        width: 60px !important;
        height: 60px !important;
      }
      
      .countdown-container .progress-ring circle {
        r: 25 !important;
        stroke-dasharray: 157 !important;
      }
      
      .countdown-container .time-labels {
        gap: 8px !important;
        font-size: 10px !important;
      }
    }
    /* é‚€è¯·æŒ‰é’®çªå‡ºæ˜¾ç¤ºï¼Œå¢åŠ å…‰æ™• */
    .bottom button[data-key="invite"],
    .bottom button[data-key="inviteNew"] {
      box-shadow: 0 12px 32px rgba(86, 204, 242, 0.55), inset 0 1px 0 rgba(255, 255, 255, 0.3);
    }
    /* ä¸»è¦çªå‡ºæŒ‰é’®æ ·å¼ - æ¿€æ´»è´¦å·ä¸“ç”¨ */
    .bottom button.primary-highlight {
      font-size: 18px !important;
      font-weight: bold !important;
      padding: 16px 24px !important;
      background: linear-gradient(135deg, #00ff88, #00cc66, #009944) !important;
      box-shadow: 0 8px 24px rgba(0, 255, 136, 0.4), 0 4px 12px rgba(0, 204, 102, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.4) !important;
      border: 2px solid rgba(0, 255, 136, 0.6) !important;
      animation: pulse-glow 2s ease-in-out infinite !important;
    }
    .bottom button.primary-highlight:hover {
      transform: translateY(-4px) !important;
      box-shadow: 0 12px 32px rgba(0, 255, 136, 0.5), 0 6px 16px rgba(0, 204, 102, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.5) !important;
    }
    @keyframes pulse-glow {
      0%, 100% { box-shadow: 0 8px 24px rgba(0, 255, 136, 0.4), 0 4px 12px rgba(0, 204, 102, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.4); }
      50% { box-shadow: 0 12px 32px rgba(0, 255, 136, 0.6), 0 6px 16px rgba(0, 204, 102, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.5); }
    }
    /* é«˜çº§å¼¹çª—æ ·å¼ */
    .dialog {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      backdrop-filter: blur(8px);
    }
    .dialog.show {
      opacity: 1;
      visibility: visible;
    }
    .dialog .dialog-box {
      background: var(--bg-card);
      border-radius: 20px;
      padding: 28px 32px;
      max-width: 85%;
      min-width: 280px;
      color: var(--text-primary);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3), 0 8px 24px rgba(0, 0, 0, 0.2);
      border: 1px solid var(--border-color);
      transform: scale(0.7) translateY(20px);
      transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      position: relative;
      overflow: hidden;
    }
    .dialog.show .dialog-box {
      transform: scale(1) translateY(0);
    }
    .dialog .dialog-box::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
      transition: left 0.6s;
    }
    .dialog.show .dialog-box::before {
      left: 100%;
    }
    .dialog .dialog-box h3 {
      margin: 0 0 16px 0;
      font-size: 20px;
      font-weight: 600;
      text-align: center;
    }

    /* æ”¯ä»˜å¯¹è¯æ¡†ä¸“ç”¨æ ·å¼ */
    .payment-dialog {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1001;
      opacity: 0;
      visibility: hidden;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      backdrop-filter: blur(12px);
    }
    .payment-dialog.show {
      opacity: 1;
      visibility: visible;
    }
    .payment-dialog .payment-box {
      background: linear-gradient(145deg, var(--bg-card), rgba(255, 255, 255, 0.05));
      border-radius: 24px;
      padding: 32px;
      max-width: 90%;
      width: 400px;
      color: var(--text-primary);
      box-shadow: 0 24px 80px rgba(0, 0, 0, 0.4), 0 12px 32px rgba(0, 0, 0, 0.3);
      border: 2px solid rgba(47, 128, 237, 0.3);
      transform: scale(0.8) translateY(30px);
      transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
      position: relative;
      overflow: hidden;
    }
    .payment-dialog.show .payment-box {
      transform: scale(1) translateY(0);
    }
    .payment-dialog .payment-box::before {
      content: '';
      position: absolute;
      top: -2px;
      left: -2px;
      right: -2px;
      bottom: -2px;
      background: linear-gradient(45deg, var(--brand), var(--brand-2), var(--brand));
      border-radius: 24px;
      z-index: -1;
      animation: payment-border-glow 3s ease-in-out infinite;
    }
    @keyframes payment-border-glow {
      0%, 100% { opacity: 0.5; }
      50% { opacity: 1; }
    }
    .payment-header {
      text-align: center;
      margin-bottom: 24px;
      position: relative;
    }
    .payment-header h3 {
      margin: 0 0 8px 0;
      font-size: 22px;
      font-weight: 700;
      background: linear-gradient(135deg, var(--brand), var(--brand-2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .payment-amount {
      font-size: 32px;
      font-weight: 800;
      color: #00ff88;
      text-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
      margin: 8px 0;
      animation: amount-pulse 2s ease-in-out infinite;
    }
    @keyframes amount-pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    .payment-info {
      background: rgba(47, 128, 237, 0.1);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
      border: 1px solid rgba(47, 128, 237, 0.2);
    }
    .payment-field {
      margin-bottom: 16px;
    }
    .payment-field:last-child {
      margin-bottom: 0;
    }
    .payment-label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 6px;
    }
    .payment-value {
      display: flex;
      align-items: center;
      gap: 8px;
      background: var(--bg-secondary);
      border-radius: 12px;
      padding: 12px 16px;
      border: 1px solid var(--border-color);
      font-family: 'Courier New', monospace;
      font-size: 14px;
      word-break: break-all;
    }
    .copy-btn {
      background: var(--brand);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 6px 12px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      flex-shrink: 0;
    }
    .copy-btn:hover {
      background: var(--brand-2);
      transform: translateY(-1px);
    }
    .qr-container {
      text-align: center;
      margin: 20px 0;
      padding: 20px;
      background: white;
      border-radius: 16px;
      border: 2px solid var(--border-color);
    }
    .qr-code {
      width: 200px;
      height: 200px;
      margin: 0 auto;
      border-radius: 12px;
      background: #f8f9fa;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      color: #666;
    }
    .countdown-container {
      text-align: center;
      margin: 20px 0;
      padding: 16px;
      background: linear-gradient(135deg, rgba(255, 107, 107, 0.1), rgba(255, 193, 7, 0.1));
      border-radius: 12px;
      border: 1px solid rgba(255, 107, 107, 0.2);
    }
    .countdown-label {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }
    .countdown-time {
      font-size: 24px;
      font-weight: 700;
      color: #ff6b6b;
      font-family: 'Courier New', monospace;
      text-shadow: 0 0 10px rgba(255, 107, 107, 0.3);
    }
    .payment-actions {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }
    .payment-btn {
      flex: 1;
      padding: 14px 20px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    .payment-btn.primary {
      background: linear-gradient(135deg, var(--brand), var(--brand-2));
      color: white;
      box-shadow: 0 8px 24px rgba(47, 128, 237, 0.3);
    }
    .payment-btn.primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 32px rgba(47, 128, 237, 0.4);
    }
    .payment-btn.secondary {
      background: var(--bg-secondary);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
    }
    .payment-btn.secondary:hover {
      background: var(--bg-card);
      transform: translateY(-1px);
    }
    .payment-status {
      text-align: center;
      margin-top: 16px;
      padding: 12px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
    }
    .payment-status.waiting {
      background: rgba(255, 193, 7, 0.1);
      color: #ffc107;
      border: 1px solid rgba(255, 193, 7, 0.2);
    }
    .payment-status.success {
      background: rgba(40, 167, 69, 0.1);
      color: #28a745;
      border: 1px solid rgba(40, 167, 69, 0.2);
    }
    .payment-status.error {
      background: rgba(220, 53, 69, 0.1);
      color: #dc3545;
      border: 1px solid rgba(220, 53, 69, 0.2);
    }

    /* æ”¯ä»˜å¯¹è¯æ¡†ç‰¹å®šæ ·å¼ */
    .payment-info {
      background: rgba(47, 128, 237, 0.1);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
      border: 1px solid rgba(47, 128, 237, 0.2);
    }
    
    .amount-section, .wallet-section, .qr-section, .countdown-section, .order-section {
      margin-bottom: 16px;
    }
    
    .amount-section:last-child, .wallet-section:last-child, .qr-section:last-child, 
    .countdown-section:last-child, .order-section:last-child {
      margin-bottom: 0;
    }
    
    .amount-label, .wallet-label, .qr-label, .countdown-label, .order-label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }
    
    .amount-value {
      font-size: 32px;
      font-weight: 800;
      color: #00ff88;
      text-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
      text-align: center;
      animation: amount-pulse 2s ease-in-out infinite;
    }
    
    .wallet-address {
      background: var(--bg-secondary);
      border-radius: 12px;
      padding: 12px 16px;
      border: 1px solid var(--border-color);
      font-family: 'Courier New', monospace;
      font-size: 14px;
      word-break: break-all;
      margin-bottom: 8px;
    }
    
    .qr-code {
      text-align: center;
      margin: 16px 0;
      padding: 20px;
      background: white;
      border-radius: 16px;
      border: 2px solid var(--border-color);
    }
    
    .countdown-timer {
      font-size: 24px;
      font-weight: 700;
      color: #ff6b6b;
      font-family: 'Courier New', monospace;
      text-shadow: 0 0 10px rgba(255, 107, 107, 0.3);
      text-align: center;
    }
    
    .order-id {
      background: var(--bg-secondary);
      border-radius: 12px;
      padding: 12px 16px;
      border: 1px solid var(--border-color);
      font-family: 'Courier New', monospace;
      font-size: 14px;
      word-break: break-all;
    }
    
    .status-indicator {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      background: rgba(255, 193, 7, 0.1);
      color: #ffc107;
      border: 1px solid rgba(255, 193, 7, 0.2);
    }
    
    .loading-spinner {
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 193, 7, 0.3);
      border-top: 2px solid #ffc107;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    .payment-tips {
      margin-top: 16px;
      padding: 16px;
      background: rgba(255, 193, 7, 0.1);
      border-radius: 12px;
      border: 1px solid rgba(255, 193, 7, 0.2);
    }
    
    .payment-tips p {
      margin: 8px 0;
      font-size: 14px;
      color: var(--text-secondary);
    }
    
    .payment-tips p:first-child {
      margin-top: 0;
    }
    
    .payment-tips p:last-child {
      margin-bottom: 0;
    }
    
    .close-btn {
      position: absolute;
      top: 16px;
      right: 16px;
      background: none;
      border: none;
      font-size: 24px;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 4px;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }
    
    .close-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-primary);
    }

    /* æ¨¡æ€æ¡†åŸºç¡€æ ·å¼ */
    .modal {
      position: fixed;
      top: 20px;
      left: 20px;
      width: auto;
      height: auto;
      background: transparent;
      display: flex;
      align-items: flex-start;
      justify-content: flex-start;
      padding: 0;
      z-index: 1000;
    }
    .modal-content {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 24px;
      position: relative;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      border: 1px solid var(--border-color);
      max-height: 90vh;
      overflow-y: auto;
    }
    .modal-close {
      background: none;
      border: none;
      font-size: 20px;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 4px;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      flex-shrink: 0;
    }
    .modal-close:hover {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-primary);
    }

    /* è®¾ç½®é¢æ¿æ ·å¼ */
    .settings-panel {
      padding: 0;
    }
    
    /* è®¾ç½®æ ‡é¢˜ */
    .settings-header {
      text-align: center;
      margin-bottom: 24px;
      padding-bottom: 20px;
      border-bottom: 2px solid var(--border-color);
    }
    .settings-header h2 {
      margin: 0;
      font-size: 20px;
      color: var(--text-primary);
      font-weight: 700;
    }
    
    /* ä¸ªäººèµ„æ–™å¡ç‰‡ */
    .profile-card {
      background: linear-gradient(135deg, var(--brand), var(--brand-2));
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      gap: 16px;
      box-shadow: 0 8px 24px rgba(47, 128, 237, 0.2);
    }
    .profile-avatar {
      flex-shrink: 0;
    }
    .avatar-circle {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      backdrop-filter: blur(10px);
    }
    .profile-info {
      flex: 1;
      color: white;
    }
    .profile-name {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .profile-code {
      font-size: 13px;
      opacity: 0.9;
    }
    .profile-level {
      flex-shrink: 0;
    }
    .level-badge {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      backdrop-filter: blur(10px);
    }
    
    /* è®¾ç½®åŒºåŸŸ */
    .settings-section {
      margin-bottom: 24px;
    }
    .settings-section h3 {
      margin: 0 0 12px 0;
      font-size: 16px;
      color: var(--text-primary);
      font-weight: 600;
    }
    
    /* è®¾ç½®å¡ç‰‡ */
    .settings-card {
      background: var(--bg-card);
      border-radius: 12px;
      border: 1px solid var(--border-color);
      overflow: hidden;
    }
    
    /* è®¾ç½®é¡¹ */
    .setting-item {
      display: flex;
      align-items: center;
      padding: 16px 20px;
      border-bottom: 1px solid var(--border-color);
      transition: background-color 0.2s ease;
    }
    .setting-item:last-child {
      border-bottom: none;
    }
    .setting-item.clickable {
      cursor: pointer;
    }
    .setting-item.clickable:hover {
      background: rgba(47, 128, 237, 0.05);
    }
    .setting-info {
      flex: 1;
    }
    .setting-title {
      display: block;
      font-size: 15px;
      font-weight: 500;
      color: var(--text-primary);
      margin-bottom: 2px;
    }
    .setting-desc {
      display: block;
      font-size: 13px;
      color: var(--text-secondary);
    }
    .arrow {
      font-size: 18px;
      color: var(--text-secondary);
      font-weight: bold;
    }
    
    /* ä¸»é¢˜æŒ‰é’® */
    .theme-btn {
      background: var(--brand);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 8px 16px;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s ease;
    }
    .theme-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(47, 128, 237, 0.3);
    }
    .theme-preview {
      width: 16px;
      height: 16px;
      border-radius: 4px;
      background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1);
    }
    
    /* ç°ä»£åŒ–é€‰æ‹©æ¡† */
    .modern-select {
      background: var(--bg-secondary);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 14px;
      cursor: pointer;
      min-width: 140px;
      transition: all 0.2s ease;
    }
    .modern-select:focus {
      outline: none;
      border-color: var(--brand);
      box-shadow: 0 0 0 3px rgba(47, 128, 237, 0.1);
    }
    
    /* Toggleå¼€å…³ */
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 28px;
    }
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: 0.3s;
      border-radius: 28px;
    }
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: 0.3s;
      border-radius: 50%;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    input:checked + .toggle-slider {
      background-color: var(--brand);
    }
    input:checked + .toggle-slider:before {
      transform: translateX(22px);
    }
    
    /* æ“ä½œæŒ‰é’® */
    .action-btn {
      background: var(--bg-secondary);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 6px 12px;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .action-btn:hover {
      background: var(--brand);
      color: white;
      border-color: var(--brand);
    }
    
    /* å±é™©æ“ä½œåŒºåŸŸ */
    .danger-zone {
      margin: 32px 0 24px 0;
    }
    .danger-zone h3 {
      margin: 0 0 12px 0;
      font-size: 16px;
      color: #ff6b6b;
      font-weight: 600;
    }
    .danger-card {
      background: rgba(255, 107, 107, 0.05);
      border: 1px solid rgba(255, 107, 107, 0.2);
      border-radius: 12px;
      padding: 20px;
    }
    .danger-warning {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 16px;
      padding: 12px;
      background: rgba(255, 107, 107, 0.1);
      border-radius: 8px;
    }
    .warning-icon {
      font-size: 20px;
      flex-shrink: 0;
    }
    .warning-text {
      font-size: 13px;
      color: var(--text-secondary);
      line-height: 1.4;
    }
    .danger-btn {
      background: linear-gradient(135deg, #ff6b6b, #ee5a52);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px 24px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      transition: all 0.2s ease;
      box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3);
    }
    .danger-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(255, 107, 107, 0.4);
    }
    .danger-btn:active {
      transform: translateY(0);
    }
    
    /* è®¾ç½®é¡µè„š */
    .settings-footer {
      margin-top: 32px;
      padding-top: 20px;
      border-top: 2px solid var(--border-color);
      text-align: center;
    }
    .back-btn {
      background: linear-gradient(135deg, #4a90e2, #357abd);
      color: white;
      border: none;
      border-radius: 10px;
      padding: 14px 32px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 4px 12px rgba(74, 144, 226, 0.3);
      min-width: 200px;
    }
    .back-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(74, 144, 226, 0.4);
    }
    .back-btn:active {
      transform: translateY(0);
    }
    
    /* å…¼å®¹æ—§æ ·å¼ */
    .settings-select:focus {
      outline: none;
      border-color: var(--brand);
      box-shadow: 0 0 0 2px rgba(47, 128, 237, 0.2);
    }
    .dialog .dialog-box p {
      margin: 0 0 24px 0;
      line-height: 1.6;
      text-align: center;
      font-size: 16px;
      white-space: pre-line;
    }
    .dialog .dialog-box button {
      background: linear-gradient(135deg, var(--btn-primary), #0066cc);
      color: white;
      border: none;
      padding: 14px 28px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      margin: 0 6px;
      box-shadow: 0 4px 16px rgba(0, 102, 204, 0.3);
      position: relative;
      overflow: hidden;
    }
    .dialog .dialog-box button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0, 102, 204, 0.4);
    }
    .dialog .dialog-box button:active {
      transform: translateY(0);
      color: var(--text-primary);
      font-weight: 600;
      cursor: pointer;
      box-shadow: var(--btn-shadow);
      margin: 0 5px;
    }
    
    .dialog .dialog-box .secondary-btn {
      background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
      color: white;
    }
    
    .dialog .dialog-box .danger-btn {
      background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
      color: white;
    }
    
    #dialogButtons {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-top: 20px;
    }
    
    /* ä»»åŠ¡å®Œæˆå¼¹çª—ç‰¹æ®Šæ ·å¼ */
    .dialog.success .dialog-box {
      background: linear-gradient(135deg, var(--bg-card) 0%, rgba(0, 255, 136, 0.05) 100%);
      border: 2px solid rgba(0, 255, 136, 0.3);
      box-shadow: 0 20px 60px rgba(0, 255, 136, 0.2), 0 8px 24px rgba(0, 0, 0, 0.2);
    }
    .dialog.success .dialog-box h3 {
      color: #00ff88;
      text-shadow: 0 0 10px rgba(0, 255, 136, 0.3);
    }
    .dialog.success .dialog-box::after {
      content: 'ğŸ‰';
      position: absolute;
      top: -10px;
      right: -10px;
      font-size: 24px;
      animation: celebrate 0.6s ease-out;
    }
    @keyframes celebrate {
      0% { transform: scale(0) rotate(0deg); opacity: 0; }
      50% { transform: scale(1.2) rotate(180deg); opacity: 1; }
      100% { transform: scale(1) rotate(360deg); opacity: 1; }
    }
    
    /* ç²’å­æ•ˆæœ */
     .dialog.success .dialog-box::before {
       background: linear-gradient(90deg, transparent, rgba(0, 255, 136, 0.2), transparent);
     }
     
     /* æˆåŠŸå¼¹çª—çš„è„‰å†²åŠ¨ç”» */
     .dialog.success .dialog-box {
       animation: successPulse 2s ease-in-out infinite;
     }
     @keyframes successPulse {
       0%, 100% { 
         box-shadow: 0 20px 60px rgba(0, 255, 136, 0.2), 0 8px 24px rgba(0, 0, 0, 0.2);
       }
       50% { 
         box-shadow: 0 20px 60px rgba(0, 255, 136, 0.4), 0 8px 24px rgba(0, 255, 136, 0.1);
       }
     }
     
     /* æˆåŠŸå¼¹çª—æŒ‰é’®ç‰¹æ®Šæ•ˆæœ */
     .dialog.success button {
       background: linear-gradient(135deg, #00ff88, #00cc66);
       box-shadow: 0 4px 16px rgba(0, 255, 136, 0.4);
     }
     .dialog.success button:hover {
       box-shadow: 0 8px 24px rgba(0, 255, 136, 0.6);
       transform: translateY(-3px);
     }
    /* é‚€è¯·åŒºé«˜äº®æ ·å¼ */
    .invite-highlight {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      padding: 12px;
      margin-top: 12px;
      box-shadow: var(--btn-glow);
    }
    .invite-highlight .section-title {
      color: var(--accent-color);
    }
    
    .invite-link-container {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .invite-link-container input {
      flex: 1;
      min-width: 0;
    }
    
    .invite-link-container button:hover {
      background: linear-gradient(135deg, #45a049, #3d8b40) !important;
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    /* ç§»åŠ¨ç«¯å­—ä½“ä¼˜åŒ– */
    @media (max-width: 768px) {
      html, body {
        font-size: 18px; /* åŸºç¡€å­—ä½“ä»16pxå¢åŠ åˆ°18px */
      }
      
      /* é¡¶éƒ¨åŒºåŸŸå­—ä½“ä¼˜åŒ– */
      .state-label {
        font-size: 15px !important; /* ä»13pxå¢åŠ åˆ°15px */
      }
      
      .subtitle {
        font-size: 13px !important; /* ä»11pxå¢åŠ åˆ°13px */
      }
      
      /* æŒ‰é’®å­—ä½“ä¼˜åŒ– */
      .bottom button {
        font-size: 16px !important; /* ä»14pxå¢åŠ åˆ°16px */
      }
      
      .btn, button {
        font-size: 16px !important; /* ä»14pxå¢åŠ åˆ°16px */
      }
      
      /* è®¾ç½®ç›¸å…³å­—ä½“ä¼˜åŒ– */
      .setting-title {
        font-size: 17px !important; /* ä»15pxå¢åŠ åˆ°17px */
      }
      
      .setting-desc {
        font-size: 15px !important; /* ä»13pxå¢åŠ åˆ°15px */
      }
      
      .theme-btn {
        font-size: 16px !important; /* ä»14pxå¢åŠ åˆ°16px */
      }
      
      .modern-select {
        font-size: 16px !important; /* ä»14pxå¢åŠ åˆ°16px */
      }
      
      /* æµ‹è¯•æŒ‰é’®å­—ä½“ä¼˜åŒ– */
      .test-btn, .reset-btn, .settings-btn {
        font-size: 14px !important; /* ä»12pxå¢åŠ åˆ°14px */
      }
      
      /* æµ‹è¯•æŒ‰é’®å®¹å™¨æ ·å¼ */
      .test-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 8px;
      }
      
      /* å°å°ºå¯¸æµ‹è¯•æŒ‰é’® */
      .test-btn.small {
        padding: 6px 12px;
        font-size: 12px;
        min-width: 60px;
      }
      
      /* å†…å®¹åŒºåŸŸå­—ä½“ä¼˜åŒ– */
      .section-title {
        font-size: 18px !important; /* ä»16pxå¢åŠ åˆ°18px */
      }
      
      /* å°å­—ä½“ä¼˜åŒ– */
      .info, .detail-row, .txn-item {
        font-size: 16px !important; /* ä»14pxå¢åŠ åˆ°16px */
      }
      
      /* éå¸¸å°çš„å­—ä½“ä¼˜åŒ– */
      .note, .caption {
        font-size: 14px !important; /* ä»12pxå¢åŠ åˆ°14px */
      }
      
      /* å€’è®¡æ—¶å­—ä½“ä¼˜åŒ– */
      #countdown, .countdown {
        font-size: 26px !important; /* ä»24pxå¢åŠ åˆ°26px */
      }
      
      /* é‡‘é¢æ˜¾ç¤ºå­—ä½“ä¼˜åŒ– */
      .balance, .amount, .price, .value {
        font-size: 20px !important; /* ä»18pxå¢åŠ åˆ°20px */
      }
      
      /* é‚€è¯·ç å’Œé“¾æ¥å­—ä½“ä¼˜åŒ– */
      #myInviteCode {
        font-size: 18px !important; /* ä»16pxå¢åŠ åˆ°18px */
      }
      
      #inviteLink {
        font-size: 13px !important; /* ä»11pxå¢åŠ åˆ°13px */
      }
      
      /* å¤åˆ¶æŒ‰é’®å­—ä½“ä¼˜åŒ– */
      button[onclick*="copy"] {
        font-size: 13px !important; /* ä»11pxå¢åŠ åˆ°13px */
      }
      
      /* æˆ˜ç»©å¡å­—ä½“ä¼˜åŒ– */
      .stats-card {
        font-size: 13px !important; /* ä»11pxå¢åŠ åˆ°13px */
      }
      
      /* ä»»åŠ¡ç›¸å…³å­—ä½“ä¼˜åŒ– */
      .task-item {
        font-size: 14px !important; /* ä»12pxå¢åŠ åˆ°14px */
      }
      
      /* çŠ¶æ€æ ‡ç­¾å­—ä½“ä¼˜åŒ– */
      .status-badge {
        font-size: 12px !important; /* ä»10pxå¢åŠ åˆ°12px */
      }
      
      /* çŠ¶æ€2å€’è®¡æ—¶åŒºåŸŸç‰¹æ®Šå­—ä½“ä¼˜åŒ– */
      .countdown-container span[style*="font-size: 11px"] {
        font-size: 14px !important; /* æŒ‘æˆ˜å€’è®¡æ—¶æ ‡ç­¾ä»11pxå¢åŠ åˆ°14px */
      }
      
      .countdown-container div[style*="font-size: 9px"] {
        font-size: 12px !important; /* 168å°æ—¶æŒ‘æˆ˜æ ‡ç­¾ä»9pxå¢åŠ åˆ°12px */
      }
      
      .countdown-container span[style*="font-size: 10px"] {
        font-size: 13px !important; /* å‰©ä½™å¤©æ•°ä»10pxå¢åŠ åˆ°13px */
      }
      
      /* æˆ˜ç»©å¡åŒºåŸŸå­—ä½“ä¼˜åŒ– */
      .grid-stats .stat-item div[style*="color: var(--text-secondary)"] {
        font-size: 14px !important; /* æˆ˜ç»©å¡æ ‡ç­¾ä»12pxå¢åŠ åˆ°14px */
      }
      
      .grid-stats .stat-value {
        font-size: 16px !important; /* æˆ˜ç»©å¡æ•°å€¼ä»14pxå¢åŠ åˆ°16px */
      }
      
      /* é‚€è¯·é“¾æ¥åŒºåŸŸå­—ä½“ä¼˜åŒ– */
      div[style*="font-size: 12px"][style*="ğŸ’ æˆ‘çš„ä¸“å±é‚€è¯·ç "] {
        font-size: 15px !important; /* é‚€è¯·ç æ ‡é¢˜ä»12pxå¢åŠ åˆ°15px */
      }
      
      div[style*="font-size: 12px"][style*="ğŸ”— é‚€è¯·é“¾æ¥"] {
        font-size: 15px !important; /* é‚€è¯·é“¾æ¥æ ‡é¢˜ä»12pxå¢åŠ åˆ°15px */
      }
      
      /* é€šç”¨å°å­—ä½“ä¼˜åŒ– - é’ˆå¯¹å†…è”æ ·å¼ */
      [style*="font-size: 9px"] {
        font-size: 12px !important;
      }
      
      [style*="font-size: 10px"] {
        font-size: 13px !important;
      }
      
      [style*="font-size: 11px"] {
        font-size: 14px !important;
      }
      
      [style*="font-size: 12px"] {
        font-size: 15px !important;
      }
    }
    
    /* æ¶ˆæ¯å¼¹çª—æ ·å¼ */
    .message-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 20px 16px 20px;
      border-bottom: 1px solid var(--border-color);
    }
    
    .message-title {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
    }
    
    /* æ ‡é¢˜æ æ“ä½œæŒ‰é’®åŒºåŸŸ */
    .header-actions {
      display: flex;
      align-items: center;
      gap: 16px;
      flex-shrink: 0;
    }
    
    .mark-all-read-btn-header {
      background: rgba(47, 128, 237, 0.1);
      color: var(--brand);
      border: 1px solid rgba(47, 128, 237, 0.2);
      border-radius: 6px;
      padding: 6px 12px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 36px;
      height: 28px;
      white-space: nowrap;
      flex-shrink: 0;
    }
    
    .mark-all-read-btn-header:hover {
      background: rgba(47, 128, 237, 0.15);
      border-color: rgba(47, 128, 237, 0.3);
      transform: translateY(-1px);
    }
    
    .mark-all-read-btn-header:active {
      transform: translateY(0);
      background: rgba(47, 128, 237, 0.2);
    }
    
    /* æ ‡ç­¾é¡µåˆ‡æ¢ */
    .message-tabs {
      display: flex;
      background: var(--bg-secondary);
      border-radius: 8px;
      margin: 16px 20px;
      padding: 4px;
      gap: 4px;
    }
    
    .tab-btn {
      flex: 1;
      padding: 12px 16px;
      background: transparent;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .tab-btn.active {
      background: var(--brand);
      color: white;
      box-shadow: 0 2px 8px rgba(47, 128, 237, 0.3);
    }
    
    .tab-btn:hover:not(.active) {
      background: rgba(47, 128, 237, 0.1);
      color: var(--brand);
    }
    
    /* åŠŸèƒ½æŒ‰é’®åŒºåŸŸ */
    .message-actions {
      display: flex;
      justify-content: center;
      padding: 0 20px 16px 20px;
    }
    
    .mark-all-read-btn {
      background: linear-gradient(135deg, #28a745, #20c997);
      color: white;
      border: none;
      border-radius: 20px;
      padding: 8px 16px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
    }
    
    .mark-all-read-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
    }
    
    .mark-all-read-btn:active {
      transform: translateY(0);
    }
    
    /* æœªè¯»æ¶ˆæ¯è®¡æ•° */
    .unread-count {
      background: #ff4757;
      color: white;
      font-size: 11px;
      font-weight: 600;
      padding: 2px 6px;
      border-radius: 10px;
      min-width: 16px;
      height: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
    }
    
    /* æ¶ˆæ¯å†…å®¹åŒºåŸŸ */
    .message-content {
      height: 400px;
      overflow-y: auto;
      padding: 0 20px 20px 20px;
    }
    
    .message-list {
      display: none;
    }
    
    .message-list.active {
      display: block;
    }
    
    /* ç©ºæ¶ˆæ¯çŠ¶æ€ */
    .empty-message {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 200px;
      color: var(--text-secondary);
    }
    
    .empty-icon {
      font-size: 48px;
      margin-bottom: 12px;
      opacity: 0.6;
    }
    
    .empty-text {
      font-size: 14px;
      opacity: 0.8;
    }
    
    /* æ¶ˆæ¯é¡¹æ ·å¼ */
    .message-item {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      transition: all 0.2s ease;
      position: relative;
    }
    
    .message-item:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .message-item.unread {
      border-left: 4px solid var(--brand);
      background: rgba(47, 128, 237, 0.05);
    }
    
    .message-item.unread::before {
      content: '';
      position: absolute;
      top: 16px;
      right: 16px;
      width: 8px;
      height: 8px;
      background: #ff4757;
      border-radius: 50%;
    }
    
    .message-header-info {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
    }
    
    .message-title-text {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0;
      line-height: 1.3;
    }
    
    .message-time {
      font-size: 12px;
      color: var(--text-secondary);
      white-space: nowrap;
      margin-left: 12px;
    }
    
    .message-content-text {
      font-size: 14px;
      color: var(--text-secondary);
      line-height: 1.5;
      margin: 0;
    }
    
    .message-category {
      display: inline-block;
      background: rgba(47, 128, 237, 0.1);
      color: var(--brand);
      font-size: 11px;
      font-weight: 500;
      padding: 2px 8px;
      border-radius: 12px;
      margin-top: 8px;
    }
    
    /* æ¶ˆæ¯æŒ‰é’®é—ªçƒåŠ¨ç”» */
    @keyframes messageFlash {
      0%, 100% {
        background: var(--btn-gradient);
        box-shadow: 0 2px 6px var(--accent-shadow);
        transform: scale(1);
      }
      50% {
        background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
        box-shadow: 0 4px 16px rgba(255, 107, 107, 0.4);
        transform: scale(1.05);
      }
    }
    
    .message-flash {
      animation: messageFlash 1.5s ease-in-out infinite;
    }
    
    /* BugæŠ¥å‘Šè¡¨å•æ ·å¼ */
    .bug-report-form {
      background: var(--bg-secondary);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .bug-report-form h4 {
      margin: 0 0 16px 0;
      color: var(--text-primary);
      font-size: 16px;
      font-weight: 600;
    }
    
    .form-group {
      margin-bottom: 16px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 6px;
      color: var(--text-primary);
      font-size: 14px;
      font-weight: 500;
    }
    
    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.05);
      color: var(--text-primary);
      font-size: 14px;
      transition: all 0.2s ease;
      box-sizing: border-box;
    }
    
    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline: none;
      border-color: var(--brand);
      box-shadow: 0 0 0 2px rgba(47, 128, 237, 0.2);
    }
    
    .submit-bug-btn {
      background: linear-gradient(135deg, #ff6b6b, #ee5a52);
      color: white;
      border: none;
      border-radius: 20px;
      padding: 10px 20px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 2px 8px rgba(255, 107, 107, 0.3);
      width: 100%;
    }
    
    .submit-bug-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(255, 107, 107, 0.4);
    }
    
    .bug-list-section {
      margin-top: 20px;
    }
    
    .bug-list-section h4 {
      margin: 0 0 12px 0;
      color: var(--text-primary);
      font-size: 16px;
      font-weight: 600;
    }
    
    .bug-item {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
      border-left: 3px solid #ff6b6b;
    }
    
    .bug-item-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
    }
    
    .bug-header-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .delete-bug-btn {
      background: rgba(255, 107, 107, 0.2);
      border: none;
      border-radius: 4px;
      color: #ff6b6b;
      font-size: 14px;
      padding: 4px 6px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 24px;
      height: 24px;
    }
    
    .delete-bug-btn:hover {
      background: rgba(255, 107, 107, 0.3);
      transform: scale(1.1);
    }
    
    .delete-bug-btn:active {
      transform: scale(0.95);
    }
    
    /* åˆ é™¤æ¶ˆæ¯æŒ‰é’®æ ·å¼ */
    .delete-message-btn {
      background: rgba(255, 107, 107, 0.2);
      border: none;
      border-radius: 4px;
      color: #ff6b6b;
      font-size: 14px;
      padding: 4px 6px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 24px;
      height: 24px;
      margin-left: 8px;
    }
    
    .delete-message-btn:hover {
      background: rgba(255, 107, 107, 0.3);
      transform: scale(1.1);
    }
    
    .delete-message-btn:active {
      transform: scale(0.95);
    }
    
    /* æ¶ˆæ¯å¤´éƒ¨å³ä¾§å®¹å™¨ */
    .message-header-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .bug-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0;
    }
    
    .bug-time {
      font-size: 12px;
      color: var(--text-secondary);
    }
    
    .bug-description {
      font-size: 13px;
      color: var(--text-secondary);
      line-height: 1.4;
      margin: 8px 0;
    }
    
    .bug-type {
      display: inline-block;
      background: rgba(255, 107, 107, 0.2);
      color: #ff6b6b;
      font-size: 11px;
      font-weight: 500;
      padding: 2px 8px;
      border-radius: 12px;
    }
    
    /* æ¶ˆæ¯æŒ‰é’®æœªè¯»æç¤ºå°çº¢ç‚¹ */
    .bottom button[data-key="message"] {
      position: relative;
    }
    
    .bottom button[data-key="message"].has-unread::after {
      content: '';
      position: absolute;
      top: -2px;
      right: -2px;
      width: 8px;
      height: 8px;
      background: #ff4757;
      border-radius: 50%;
      border: 2px solid var(--bg-primary);
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% {
        transform: scale(1);
        opacity: 1;
      }
      50% {
        transform: scale(1.2);
        opacity: 0.7;
      }
      100% {
        transform: scale(1);
        opacity: 1;
      }
    }
  </style>
</head>
<body>
  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-K7WCTWLM"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->
  
  <div id="app" class="app">
    <!-- æ¶ˆæ¯å›¾æ ‡ - ç§»åˆ°æœ€å¤–å±‚é¿å…flexå¸ƒå±€å½±å“ -->
    <div id="messageIcon" class="message-icon" onclick="showMessages()">
      <img src="å›¾æ ‡æ–‡ä»¶/message_optimized.png" alt="æ¶ˆæ¯" width="36" height="36" />
      <div id="messageUnreadDot" class="unread-dot" style="display: none;"></div>
    </div>
    
    <div class="header">
      <div class="header-main">
        <!-- æ”¾å¤§çš„logo -->
        <img src="logo_gold7.png" alt="Logo" class="logo-img" />
        <div class="status-info">
          <div id="stateLabel" class="state-label">çŠ¶æ€1</div>
          <div id="subtitle" class="subtitle">æ¬¢è¿åŠ å…¥è£‚é‡‘7æ—¥</div>
        </div>
      </div>
      <button class="settings-btn" onclick="console.log('è®¾ç½®æŒ‰é’®è¢«ç‚¹å‡»'); openSettings();">âš™ï¸</button>
    </div>
    <div class="content">
      <div id="card" class="card">
        <!-- åŠ¨æ€å†…å®¹å°†åœ¨è¿™é‡Œæ³¨å…¥ -->
      </div>
    </div>
    <div id="bottomButtons" class="bottom">
      <!-- åº•éƒ¨æŒ‰é’®åŠ¨æ€ç”Ÿæˆ -->
    </div>
  </div>
  <!-- æ¨¡æ€å¼¹çª— -->
  <div id="modal" class="modal" style="display:none;">
    <div class="modal-content">
      <button id="modalClose" class="modal-close">âœ•</button>
      <div id="modalBody"></div>
    </div>
  </div>
  <div id="dialog" class="dialog" style="display:none;">
    <div class="dialog-box">
      <h3 id="dialogTitle">æç¤º</h3>
      <p id="dialogMsg">å†…å®¹</p>
      <div id="dialogButtons">
        <button onclick="closeDialog()">ç¡®å®š</button>
      </div>
    </div>
  </div>

  <!-- è®¾ç½®é¢æ¿ -->
  <div id="settingsModal" class="modal" style="display:none;">
    <div class="modal-content" style="max-width: 420px; width: 95%; max-height: 90vh; overflow-y: auto;">
      <button class="modal-close" onclick="closeSettings()">âœ•</button>
      <div class="settings-panel">
        <!-- æ ‡é¢˜ -->
        <div class="settings-header">
          <h2>âš™ï¸ è®¾ç½®ä¸­å¿ƒ</h2>
        </div>
        
        <!-- ä¸ªäººèµ„æ–™å¡ç‰‡ -->
        <div class="profile-card">
          <div class="profile-avatar">
            <div class="avatar-circle">ğŸ‘¤</div>
          </div>
          <div class="profile-info">
            <div class="profile-name" id="userEmailDisplay">æœªç™»å½•</div>
            <div class="profile-code">é‚€è¯·ç ï¼š<span id="userInviteCodeDisplay">-</span></div>
          </div>
        </div>

        <!-- å¤–è§‚è®¾ç½® -->
        <div class="settings-section">
          <h3>ğŸ¨ å¤–è§‚è®¾ç½®</h3>
          <div class="settings-card">

            <div class="setting-item">
              <div class="setting-info">
                <span class="setting-title">ğŸŒ è¯­è¨€</span>
                <span class="setting-desc">é€‰æ‹©ç•Œé¢æ˜¾ç¤ºè¯­è¨€</span>
              </div>
              <select id="languageSelect" class="modern-select">
                <option value="zh-CN" selected>ğŸ‡¨ğŸ‡³ ç®€ä½“ä¸­æ–‡</option>
                <option value="zh-TW">ğŸ‡¨ğŸ‡³ ç¹é«”ä¸­æ–‡</option>
                <option value="en-US">ğŸ‡ºğŸ‡¸ English</option>
                <option value="ja-JP">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª</option>
                <option value="ko-KR">ğŸ‡°ğŸ‡· í•œêµ­ì–´</option>
                <option value="th-TH">ğŸ‡¹ğŸ‡­ à¹„à¸—à¸¢</option>
                <option value="hi-IN">ğŸ‡®ğŸ‡³ à¤¹à¤¿à¤¨à¥à¤¦à¥€</option>
                <option value="vi-VN">ğŸ‡»ğŸ‡³ Tiáº¿ng Viá»‡t</option>
                <option value="km-KH">ğŸ‡°ğŸ‡­ ááŸ’á˜áŸ‚áš</option>
                <option value="ru-RU">ğŸ‡·ğŸ‡º Ğ ÑƒÑÑĞºĞ¸Ğ¹</option>
                <option value="mn-MN">ğŸ‡²ğŸ‡³ ĞœĞ¾Ğ½Ğ³Ğ¾Ğ»</option>
                <option value="my-MM">ğŸ‡²ğŸ‡² á€™á€¼á€”á€ºá€™á€¬</option>
                <option value="lo-LA">ğŸ‡±ğŸ‡¦ àº¥àº²àº§</option>
                <option value="ar-SA">ğŸ‡¸ğŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
              </select>
            </div>
          </div>
        </div>

        <!-- åŠŸèƒ½è®¾ç½® -->
        <div class="settings-section">
          <h3>ğŸ”§ åŠŸèƒ½è®¾ç½®</h3>
          <div class="settings-card">



            <div class="setting-item">
              <div class="setting-info">
                <span class="setting-title">ğŸ”„ çŠ¶æ€åˆ‡æ¢</span>
                <span class="setting-desc">åˆ‡æ¢ç”¨æˆ·çŠ¶æ€è¿›è¡Œæµ‹è¯•</span>
              </div>
              <select id="stateSelect" class="modern-select" onchange="switchToState(this.value)">
                <option value="">é€‰æ‹©çŠ¶æ€</option>
                <option value="1">çŠ¶æ€1 - æ–°æ‰‹æœªå…¥é‡‘</option>
                <option value="2">çŠ¶æ€2 - æ–°æ‰‹å·²å…¥é‡‘</option>
                <option value="3">çŠ¶æ€3 - æœ¬æœŸæŒ‘æˆ˜ç»“æŸ</option>
              </select>
            </div>

          </div>
        </div>

        <!-- å¸®åŠ©ä¸æ”¯æŒ -->
        <div class="settings-section">
          <h3>â“ å¸®åŠ©ä¸æ”¯æŒ</h3>
          <div class="settings-card">

            <div class="setting-item clickable" onclick="showBugReport()">
              <div class="setting-info">
                <span class="setting-title">ğŸ› BugæŠ¥å‘Š</span>
                <span class="setting-desc">æäº¤BugæŠ¥å‘Šå’Œé—®é¢˜åé¦ˆ</span>
              </div>
              <span class="arrow">â€º</span>
            </div>
            <div class="setting-item clickable" onclick="showAbout()">
              <div class="setting-info">
                <span class="setting-title">â„¹ï¸ å…³äºæˆ‘ä»¬</span>
                <span class="setting-desc">ç‰ˆæœ¬ä¿¡æ¯å’Œå¼€å‘å›¢é˜Ÿ</span>
              </div>
              <span class="arrow">â€º</span>
            </div>
          </div>
        </div>

        <!-- å±é™©æ“ä½œåŒºåŸŸ -->
        <div class="danger-zone">
          <div class="danger-card">
            <button class="danger-btn" onclick="confirmLogout()">
              ğŸšª é€€å‡ºç™»å½•
            </button>
          </div>
        </div>

        <!-- è¿”å›æŒ‰é’® -->
        <div class="settings-footer">
          <button class="back-btn" onclick="closeSettings()">
            â† è¿”å›ä¸»é¡µ
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- æ¶ˆæ¯å¼¹çª— -->
  <div id="messageModal" class="modal" style="display:none;">
    <div class="modal-content" style="max-width: 420px; width: 95%; max-height: 80vh; overflow: hidden;">
      <div class="message-header">
        <h3 class="message-title">ğŸ’¬ æ¶ˆæ¯ä¸­å¿ƒ</h3>
        <div class="header-actions">
          <button class="mark-all-read-btn-header" onclick="markAllAsRead()" title="æ ‡è®°æ‰€æœ‰æ¶ˆæ¯ä¸ºå·²è¯»">
            âœ“
          </button>
          <button class="modal-close" onclick="closeMessages()">âœ•</button>
        </div>
      </div>
      
      <!-- æ ‡ç­¾é¡µåˆ‡æ¢ -->
      <div class="message-tabs">
        <button class="tab-btn active" onclick="switchMessageTab('official')" id="officialTab">
          ğŸ“¢ å®˜æ–¹å…¬å‘Š
          <span class="unread-count" id="officialUnreadCount" style="display:none;">0</span>
        </button>
        <button class="tab-btn" onclick="switchMessageTab('team')" id="teamTab">
          ğŸ‘¥ å›¢é˜Ÿæ¶ˆæ¯
          <span class="unread-count" id="teamUnreadCount" style="display:none;">0</span>
        </button>
        <button class="tab-btn" onclick="switchMessageTab('bug')" id="bugTab">
          ğŸ› BugæŠ¥å‘Š
        </button>
      </div>
      
      <!-- æ¶ˆæ¯åˆ—è¡¨å®¹å™¨ -->
      <div class="message-content">
        <!-- å®˜æ–¹å…¬å‘Šåˆ—è¡¨ -->
        <div id="officialMessages" class="message-list active">
          <div class="empty-message">
            <div class="empty-icon">ğŸ“­</div>
            <div class="empty-text">æš‚æ— å®˜æ–¹å…¬å‘Š</div>
          </div>
        </div>
        
        <!-- å›¢é˜Ÿæ¶ˆæ¯åˆ—è¡¨ -->
        <div id="teamMessages" class="message-list">
          <div class="empty-message">
            <div class="empty-icon">ğŸ‘¥</div>
            <div class="empty-text">æš‚æ— å›¢é˜Ÿæ¶ˆæ¯</div>
          </div>
        </div>
        
        <!-- BugæŠ¥å‘Šåˆ—è¡¨ -->
        <div id="bugMessages" class="message-list">
          <div class="bug-report-form">
            <h4>ğŸ› æäº¤BugæŠ¥å‘Š</h4>
            <form onsubmit="submitBugReport(event)">
              <div class="form-group">
                <label for="bugTitle">Bugæ ‡é¢˜ï¼š</label>
                <input type="text" id="bugTitle" placeholder="è¯·ç®€è¦æè¿°é‡åˆ°çš„é—®é¢˜" required>
              </div>
              <div class="form-group">
                <label for="bugDescription">è¯¦ç»†æè¿°ï¼š</label>
                <textarea id="bugDescription" rows="4" placeholder="è¯·è¯¦ç»†æè¿°é—®é¢˜çš„å…·ä½“æƒ…å†µã€å¤ç°æ­¥éª¤ç­‰" required></textarea>
              </div>
              <div class="form-group">
                <label for="bugType">é—®é¢˜ç±»å‹ï¼š</label>
                <select id="bugType" required>
                  <option value="">è¯·é€‰æ‹©é—®é¢˜ç±»å‹</option>
                  <option value="åŠŸèƒ½å¼‚å¸¸">åŠŸèƒ½å¼‚å¸¸</option>
                  <option value="ç•Œé¢æ˜¾ç¤º">ç•Œé¢æ˜¾ç¤º</option>
                  <option value="æ€§èƒ½é—®é¢˜">æ€§èƒ½é—®é¢˜</option>
                  <option value="å…¶ä»–">å…¶ä»–</option>
                </select>
              </div>
              <button type="submit" class="submit-bug-btn">ğŸ“ æäº¤æŠ¥å‘Š</button>
            </form>
          </div>
          
          <div class="bug-list-section">
            <h4>ğŸ“‹ å·²æäº¤çš„BugæŠ¥å‘Š</h4>
            <div id="bugReportList">
              <div class="empty-message">
                <div class="empty-icon">ğŸ›</div>
                <div class="empty-text">æš‚æ— BugæŠ¥å‘Š</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // è®¾ç½®é¢æ¿åŠŸèƒ½ - æå‰å®šä¹‰ç¡®ä¿onclickå¯ä»¥æ‰¾åˆ°
    function openSettings() {
      console.log('openSettingså‡½æ•°è¢«è°ƒç”¨');
      const settingsModal = document.getElementById('settingsModal');
      console.log('settingsModalå…ƒç´ :', settingsModal);
      
      if (!settingsModal) {
        console.error('æ‰¾ä¸åˆ°settingsModalå…ƒç´ ');
        alert('è®¾ç½®é¢æ¿å…ƒç´ æœªæ‰¾åˆ°ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
        return;
      }
      
      settingsModal.style.display = 'flex';
      console.log('è®¾ç½®é¢æ¿å·²æ˜¾ç¤º');
      
      // æ›´æ–°ä¸ªäººä¿¡æ¯æ˜¾ç¤º
      updateSettingsInfo();
      
      // åŠ è½½ä¿å­˜çš„è®¾ç½®
      loadSettingsFromStorage();
    }

    function closeSettings() {
      const settingsModal = document.getElementById('settingsModal');
      settingsModal.style.display = 'none';
    }

    function updateSettingsInfo() {
      const userEmail = localStorage.getItem('userEmail') || 'æœªç™»å½•';
      const userInviteCode = localStorage.getItem('userInviteCode') || '-';
      const currentLanguage = localStorage.getItem('language') || 'zh-CN';
      
      document.getElementById('userEmailDisplay').textContent = userEmail;
      document.getElementById('userInviteCodeDisplay').textContent = userInviteCode;
      document.getElementById('languageSelect').value = currentLanguage;
    }

    /* çŠ¶æ€æ•°æ®ä¸é€»è¾‘å®šä¹‰ */
    // ä» localStorage åŠ è½½åº”ç”¨çŠ¶æ€
    const appState = JSON.parse(localStorage.getItem('appState') || '{}');
    
    const STATES = {
      1: {
        name: 'çŠ¶æ€1',
        subtitle: 'æ–°æ‰‹æœªå…¥é‡‘',
        card: function() {
          return `
            <div class="section reactivate-highlight">
              <div class="section-title">æ¿€æ´»è´¦å·</div>
              <div class="section-content" style="margin-bottom: 16px;">ç«‹å³å…¥é‡‘100 USDTï¼Œå¼€å¯168å°æ—¶æŒ‘æˆ˜æœŸï¼Œè§£é”ä»»åŠ¡ç³»ç»Ÿå’Œæ”¶ç›Šæœºä¼šã€‚</div>
              <button class="reactivate-btn" onclick="activateAccount()">ç«‹å³æ¿€æ´» 100 USDT</button>
            </div>
            <div class="section">
              <div class="section-title">æ”¶ç›Šé¢„è§ˆ</div>
              <div class="section-content">æŸ¥çœ‹å‰10åæ”¶ç›Šæ’è¡Œæ¦œï¼Œäº†è§£æ½œåœ¨æ”¶ç›Šæœºä¼šã€‚</div>
              <button onclick="showRanking()" style="margin-top: 12px; padding: 8px 16px; background: var(--btn-gradient); color: white; border: none; border-radius: 8px; font-size: 14px; cursor: pointer; width: 100%; font-weight: 500; box-shadow: 0 2px 6px var(--accent-shadow); transition: all 0.2s ease;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px var(--accent-shadow-hover)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 6px var(--accent-shadow)'">æŸ¥çœ‹æ’è¡Œæ¦œ</button>
            </div>
          `;
        },
        buttons: []
      },
      2: {
        name: 'çŠ¶æ€2',
        subtitle: '168å°æ—¶å€’è®¡æ—¶ä¸­',
        card: function() {
          // å½“å‰æ–°æ‰‹ä»»åŠ¡ï¼šåªæ˜¾ç¤ºå°šæœªå®Œæˆçš„ç¬¬ä¸€ä¸ªä»»åŠ¡
          const currentTask = newTasks.find(t => !t.done);
          let taskSection;
          if (currentTask) {
            taskSection = `
            <div class="section">
              <div class="section-title">å½“å‰ä»»åŠ¡</div>
              <div class="section-content">${currentTask.title}</div>
            </div>
            `;
          } else {
            taskSection = `
            <div class="section">
              <div class="section-title">å½“å‰ä»»åŠ¡</div>
              <div class="section-content">æ‰€æœ‰æ–°æ‰‹ä»»åŠ¡å·²å®Œæˆ</div>
            </div>
            `;
          }
          const completedTasks = newTasks.filter(t => t.done).length;
          
          // å¯æ¥çš„ä»»åŠ¡åŒºåŸŸï¼šæ˜¾ç¤ºæ‰€æœ‰æœªå®Œæˆçš„æ–°æ‰‹ä»»åŠ¡
          const availableTasks = newTasks.filter(t => !t.done);
          let availableTasksSection = '';
          if (availableTasks.length > 0) {
            availableTasksSection = `
            <div class="section" style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; padding: 8px; margin-bottom: 8px; cursor: pointer;" onclick="window.location.href='tasks.html'">
              <div class="section-title" style="font-size: 14px; font-weight: bold; color: var(--accent-color); margin-bottom: 6px;">ğŸ“‹ å¯æ¥çš„ä»»åŠ¡</div>
              <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">ç‚¹å‡»æŸ¥çœ‹è¯¦ç»†ä»»åŠ¡åˆ—è¡¨</div>
              <div style="display: flex; flex-direction: column; gap: 4px;">
                ${availableTasks.map(task => `
                  <div style="display: flex; justify-content: space-between; align-items: center; padding: 4px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                    <span style="font-size: 12px; color: var(--text);">${task.title}</span>
                    <span style="font-size: 10px; padding: 2px 6px; background: linear-gradient(45deg, #00eaff, #0088ff); color: #031e2e; border-radius: 8px;">å¾…å®Œæˆ</span>
                  </div>
                `).join('')}
              </div>
            </div>
            `;
          }
          
          // ç­”é¢˜ä»»åŠ¡åŒºåŸŸï¼šå®Œæˆè‡³å°‘ä¸€ä¸ªæ–°æ‰‹ä»»åŠ¡åå‡ºç°ï¼Œä¸”æœªå®Œæˆç­”é¢˜ä»»åŠ¡
          const firstDone = newTasks[0] && newTasks[0].done;
          const quizCorrect = parseInt(localStorage.getItem('quizCorrect')) || 0;
          const quizCompleted = appState.quizCompleted || false;
          let quizSection = '';
          if (firstDone && !quizCompleted) {
            quizSection = `
            <div class="section" style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; padding: 8px; margin-bottom: 8px; box-shadow: var(--btn-glow); cursor: pointer;" onclick="window.location.href='quiz.html'">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <div style="font-size: 14px; font-weight: bold; color: var(--accent-color); margin-bottom: 2px;">ğŸ“ ç­”é¢˜ä»»åŠ¡</div>
                  <div style="font-size: 12px; color: var(--text-secondary);">é™ä½æç°æ‰‹ç»­è´¹</div>
                </div>
                <div style="text-align: right;">
                  <div style="font-size: 12px; color: var(--text-secondary);">è¿›åº¦</div>
                  <div style="font-weight: bold; color: var(--accent-color);">è¿›åº¦: ${appState.quizCompleted ? 'å·²å®Œæˆ' : 'è¿›è¡Œä¸­'}</div>
                </div>
              </div>
            </div>
            `;
          }
          
          // å¤§ç¥ä»»åŠ¡åŒºåŸŸï¼šå®Œæˆæ‰€æœ‰æ–°æ‰‹ä»»åŠ¡ä¸”å®Œæˆç­”é¢˜ä»»åŠ¡åæ˜¾ç¤º
          const allNewTasksCompleted = newTasks.every(task => task.done);
          let masterTasksSection = '';
          if (allNewTasksCompleted && quizCompleted) {
            // è·å–å¤§ç¥ä»»åŠ¡å®ŒæˆçŠ¶æ€
            const godTasksCompleted = parseInt(localStorage.getItem('godTasksCompleted')) || 0;
            const currentMasterTask = godTasks.find(task => !task.done);
            
            masterTasksSection = `
            <div class="section" style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; padding: 8px; margin-bottom: 8px; box-shadow: var(--btn-glow); cursor: pointer;" onclick="window.location.href='tasks.html?tab=master'">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <div style="font-size: 14px; font-weight: bold; color: var(--accent-color); margin-bottom: 2px;">ğŸ† å¤§ç¥ä»»åŠ¡</div>
                  <div style="font-size: 12px; color: var(--text-secondary);">${currentMasterTask ? currentMasterTask.title : 'æ‰€æœ‰å¤§ç¥ä»»åŠ¡å·²å®Œæˆ'}</div>
                </div>
                <div style="text-align: right;">
                  <div style="font-size: 12px; color: var(--text-secondary);">è¿›åº¦</div>
                  <div style="font-weight: bold; color: var(--accent-color);">${godTasksCompleted}/6</div>
                </div>
              </div>
            </div>
            `;
          }
          
          return `
            <!-- ä¼˜åŒ–åçš„å€’è®¡æ—¶åŒºåŸŸ -->
            <div class="section" style="margin-bottom: 16px;">
              <div class="countdown-container" style="
                background: linear-gradient(135deg, var(--bg-secondary) 0%, rgba(47, 128, 237, 0.1) 100%);
                border: 2px solid var(--accent-color);
                border-radius: 10px;
                padding: 6px 10px;
                position: relative;
                overflow: hidden;
                box-shadow: 0 8px 32px rgba(47, 128, 237, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.1);
                animation: countdownPulse 3s ease-in-out infinite;
              ">
                
                <!-- å€’è®¡æ—¶ä¸»ä½“ -->
                <div style="position: relative; z-index: 2;">
                  <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 4px;">
                    <div style="display: flex; align-items: center; gap: 4px;">
                      <div style="
                        width: 5px;
                        height: 5px;
                        background: var(--accent-color);
                        border-radius: 50%;
                        animation: blink 1.5s ease-in-out infinite;
                      "></div>
                      <span style="font-size: 11px; color: var(--accent-color); font-weight: 600;">âš¡ æŒ‘æˆ˜å€’è®¡æ—¶</span>
                    </div>
                    <div style="
                      background: rgba(47, 128, 237, 0.2);
                      padding: 1px 4px;
                      border-radius: 6px;
                      font-size: 9px;
                      color: var(--accent-color);
                      font-weight: 500;
                    ">168å°æ—¶æŒ‘æˆ˜</div>
                  </div>
                  
                  <!-- æ—¶é—´æ˜¾ç¤ºåŒºåŸŸ -->
                  <div class="time-area" style="display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 6px; margin-bottom: 2px;">
                    <!-- æ—¶é—´æ•°å­— -->
                    <div style="text-align: center;">
                      <div class="time-display" style="
                        font-size: 28px;
                        font-weight: 700;
                        color: var(--accent-color);
                        text-shadow: 0 0 20px rgba(47, 128, 237, 0.5);
                        font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
                        letter-spacing: 1px;
                        margin-bottom: 2px;
                      ">
                        <span id="countdown">--:--:--</span>
                      </div>
                    </div>
                    
                    <!-- ç›´çº¿è¿›åº¦æ¡ -->
                    <div style="width: 100%; margin-top: 4px;">
                      <div style="
                        width: 100%;
                        height: 4px;
                        background: rgba(47, 128, 237, 0.2);
                        border-radius: 2px;
                        overflow: hidden;
                        position: relative;
                      ">
                        <div 
                          id="countdownProgress" 
                          style="
                            height: 100%;
                            width: 100%;
                            background: var(--accent-color);
                            border-radius: 2px;
                            transition: width 1s ease-in-out;
                            box-shadow: 0 0 12px rgba(109, 213, 237, 0.6), 0 0 24px rgba(109, 213, 237, 0.3);
                            margin-left: auto;
                            position: relative;
                            overflow: hidden;
                          "
                        >
                          <div style="
                            position: absolute;
                            top: 0;
                            left: 0;
                            width: 30%;
                            height: 100%;
                            background: linear-gradient(90deg, transparent 0%, rgba(255, 255, 255, 0.3) 50%, transparent 100%);
                            animation: slideRight 3s linear infinite;
                          "></div>
                        </div>
                      </div>
                      <div style="
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        margin-top: 2px;
                        font-size: 10px;
                        color: var(--text-secondary);
                      ">
                        <span id="remainingDays" style="color: var(--accent-color); font-weight: 600;">å‰©ä½™ -- å¤©</span>
                      </div>
                    </div>
                  </div>
                  
                  <!-- çŠ¶æ€æç¤º -->
                  <div id="countdownStatus" style="
                    text-align: center;
                    font-size: 12px;
                    color: var(--text-secondary);
                    background: rgba(47, 128, 237, 0.1);
                    padding: 8px 12px;
                    border-radius: 12px;
                    border: 1px solid rgba(47, 128, 237, 0.2);
                    display: none;
                  ">
                  </div>
                </div>
              </div>
            </div>
            
            <!-- é‚€è¯·é“¾æ¥åŒºåŸŸ -->
            <div class="section invite-highlight" style="margin-bottom: 16px;">
              <div class="section-title">é‚€è¯·é“¾æ¥</div>
              <div class="section-content">
                <!-- ä¸“å±é‚€è¯·ç åŒºåŸŸ -->
                <div style="margin-bottom: 12px; padding: 12px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 10px; box-shadow: 0 2px 8px var(--accent-shadow);">
                  <div style="font-size: 12px; color: var(--accent-color); margin-bottom: 8px; text-align: center; font-weight: 500;">ğŸ’ æˆ‘çš„ä¸“å±é‚€è¯·ç </div>
                  <div style="display: flex; align-items: center; gap: 8px;">
                    <div style="flex: 1; font-weight: bold; color: var(--accent-color); font-size: 16px; text-align: center; padding: 10px; background: var(--input-bg); border-radius: 8px; border: 1px solid var(--border-color); box-shadow: inset 0 1px 3px var(--accent-shadow);" id="myInviteCode">--</div>
                    <button onclick="copyInviteCode()" style="padding: 10px 16px; background: var(--btn-gradient); color: white; border: none; border-radius: 8px; font-size: 11px; cursor: pointer; white-space: nowrap; font-weight: 600; box-shadow: 0 2px 6px var(--accent-shadow); transition: all 0.2s ease;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px var(--accent-shadow-hover)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 6px var(--accent-shadow)'">å¤åˆ¶ç </button>
                  </div>
                </div>
                
                <!-- é‚€è¯·é“¾æ¥åŒºåŸŸ -->
                <div style="padding: 12px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 10px; box-shadow: 0 2px 8px var(--accent-shadow);">
                  <div style="font-size: 12px; color: var(--accent-color); margin-bottom: 8px; text-align: center; font-weight: 500;">ğŸ”— é‚€è¯·é“¾æ¥</div>
                  <div class="invite-link-container" style="display: flex; gap: 8px;">
                    <input type="text" id="inviteLink" value="https://gold7.com/invite?code=--" readonly style="flex: 1; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--input-bg); font-size: 11px; color: var(--accent-color); box-shadow: inset 0 1px 3px var(--accent-shadow);">
                    <button onclick="copyInviteLink()" style="padding: 10px 16px; background: var(--btn-gradient); color: white; border: none; border-radius: 8px; font-size: 11px; cursor: pointer; white-space: nowrap; font-weight: 600; box-shadow: 0 2px 6px var(--accent-shadow); transition: all 0.2s ease;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px var(--accent-shadow-hover)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 6px var(--accent-shadow)'">å¤åˆ¶é“¾æ¥</button>
                  </div>
                </div>
              </div>
            </div>
            
            ${availableTasksSection}
            ${quizSection}
            ${masterTasksSection}
            
            <!-- æˆ˜ç»©å¡åŒºåŸŸ - ç§»åŠ¨åˆ°æœ€ä¸‹æ–¹ -->
            <div class="section" style="margin-bottom: 16px;">
              <div style="
                background: var(--bg-secondary); 
                border-radius: 16px; 
                padding: 16px;
                border: 1px solid rgba(47, 128, 237, 0.1);
                box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
              ">
                <div style="
                  font-size: 14px; 
                  color: var(--accent-color); 
                  margin-bottom: 12px; 
                  text-align: center;
                  font-weight: 600;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  gap: 8px;
                ">
                  <span>ğŸ†</span>
                  <span>æˆ‘çš„æˆ˜ç»©</span>
                </div>
                <div class="grid-stats" style="
                   display: grid;
                   grid-template-columns: 1fr 1fr;
                   gap: 12px;
                   font-size: 12px;
                   line-height: 1.4;
                 ">
                   <!-- æ–°æ‰‹ä»»åŠ¡å¡ç‰‡ - å¢å¼ºç‰ˆ -->
                   <div class="stat-item" style="
                     background: rgba(47, 128, 237, 0.05);
                     padding: 12px;
                     border-radius: 12px;
                     border: 1px solid rgba(47, 128, 237, 0.1);
                     position: relative;
                     transition: all 0.2s ease;
                   " onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 6px 20px rgba(47, 128, 237, 0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                     <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                       <div style="color: var(--text-secondary); font-size: 11px;">ğŸ“š æ–°æ‰‹ä»»åŠ¡</div>
                       <div style="font-size: 10px; color: var(--accent-color); font-weight: 500;">
                         ${completedTasks === 3 ? 'âœ… å·²å®Œæˆ' : 'è¿›è¡Œä¸­'}
                       </div>
                     </div>
                     <div class="stat-value" style="color: var(--accent-color); font-weight: bold; font-size: 16px; margin-bottom: 4px;">
                       <span id="taskProgress">${completedTasks}</span>/3
                       <span style="font-size: 12px; color: var(--text-secondary); margin-left: 4px;">
                         (${Math.round(completedTasks/3*100)}%)
                       </span>
                     </div>
                     <div style="
                       width: 100%;
                       height: 4px;
                       background: rgba(47, 128, 237, 0.1);
                       border-radius: 2px;
                       overflow: hidden;
                       margin-bottom: 4px;
                     ">
                       <div style="
                         width: ${completedTasks/3*100}%;
                         height: 100%;
                         background: var(--accent-color);
                         border-radius: 2px;
                         transition: width 0.3s ease;
                       "></div>
                     </div>
                     <div style="font-size: 10px; color: var(--text-secondary);">
                       ${completedTasks < 3 ? `è¿˜éœ€å®Œæˆ ${3-completedTasks} ä¸ªä»»åŠ¡` : 'ğŸ‰ å…¨éƒ¨å®Œæˆï¼'}
                     </div>
                   </div>
                   
                   <!-- ç­”é¢˜è¿›åº¦å¡ç‰‡ - å¢å¼ºç‰ˆ -->
                   <div class="stat-item" style="
                     background: rgba(47, 128, 237, 0.05);
                     padding: 12px;
                     border-radius: 12px;
                     border: 1px solid rgba(47, 128, 237, 0.1);
                     position: relative;
                     transition: all 0.2s ease;
                   " onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 6px 20px rgba(47, 128, 237, 0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                     <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                       <div style="color: var(--text-secondary); font-size: 11px;">ğŸ§  ç­”é¢˜è¿›åº¦</div>
                       <div style="font-size: 10px; color: var(--accent-color); font-weight: 500;">
                         ${quizCorrect >= 16 ? 'âœ… é€šè¿‡' : (completedTasks >= 1 ? 'å¯ç­”é¢˜' : 'ğŸ”’ æœªè§£é”')}
                       </div>
                     </div>
                     <div class="stat-value" style="color: var(--accent-color); font-weight: bold; font-size: 16px; margin-bottom: 4px;">
                       ${quizCorrect}/20
                       <span style="font-size: 12px; color: var(--text-secondary); margin-left: 4px;">
                         (${Math.round(quizCorrect/20*100)}%)
                       </span>
                     </div>
                     <div style="
                       width: 100%;
                       height: 4px;
                       background: rgba(47, 128, 237, 0.1);
                       border-radius: 2px;
                       overflow: hidden;
                       margin-bottom: 4px;
                     ">
                       <div style="
                         width: ${quizCorrect/20*100}%;
                         height: 100%;
                         background: var(--accent-color);
                         border-radius: 2px;
                         transition: width 0.3s ease;
                       "></div>
                     </div>
                     <div style="font-size: 10px; color: var(--text-secondary);">
                       ${completedTasks < 1 ? 'éœ€å®Œæˆæ–°æ‰‹ä»»åŠ¡1è§£é”' : (quizCorrect < 16 ? `éœ€ç­”å¯¹ ${16-quizCorrect} é¢˜é€šè¿‡` : 'ğŸ éå›ºå®šå·²æ‰‹ç»­è´¹æ°¸ä¹…å·²é™ä½è‡³1%')}
                     </div>
                   </div>
                   
                   <!-- å›¢é˜Ÿäººæ•°å¡ç‰‡ - å¢å¼ºç‰ˆ -->
                   <div class="stat-item" style="
                     background: rgba(47, 128, 237, 0.05);
                     padding: 12px;
                     border-radius: 12px;
                     border: 1px solid rgba(47, 128, 237, 0.1);
                     position: relative;
                     transition: all 0.2s ease;
                   " onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 6px 20px rgba(47, 128, 237, 0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                     <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                       <div style="color: var(--text-secondary); font-size: 11px;">ğŸ‘¥ å›¢é˜Ÿè§„æ¨¡</div>
                       <div style="font-size: 10px; color: var(--success-color); font-weight: 500;">
                         ${teamMembers > 0 ? 'â†—ï¸ å¢é•¿ä¸­' : 'å¾…å‘å±•'}
                       </div>
                     </div>
                     <div class="stat-value" style="color: var(--accent-color); font-weight: bold; font-size: 16px; margin-bottom: 4px;">
                       <span id="teamCount">${teamMembers}</span>äºº
                     </div>
                     <div style="font-size: 10px; color: var(--text-secondary); margin-bottom: 4px;">
                       ${teamMembers < 2 ? 'è·ç¦»å¤§ç¥ä»»åŠ¡ä¸€è¿˜éœ€' + (2-teamMembers) + 'äºº' : 'å·²è¾¾æˆå¤§ç¥ä»»åŠ¡ä¸€æ¡ä»¶ ğŸ¯'}
                     </div>
                     <div style="font-size: 10px; color: var(--text-secondary);">
                       ğŸ’¡ é‚€è¯·æ›´å¤šå¥½å‹åŠ å…¥å›¢é˜Ÿ
                     </div>
                   </div>
                   
                   <!-- æ€»æ”¶ç›Šå¡ç‰‡ - å¢å¼ºç‰ˆ -->
                   <div class="stat-item" style="
                     background: rgba(40, 167, 69, 0.1);
                     padding: 12px;
                     border-radius: 12px;
                     border: 1px solid rgba(40, 167, 69, 0.2);
                     position: relative;
                     transition: all 0.2s ease;
                   " onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 6px 20px rgba(40, 167, 69, 0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                     <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                       <div style="color: var(--text-secondary); font-size: 11px;">ğŸ’° æ€»æ”¶ç›Š</div>
                       <div style="font-size: 10px; color: var(--success-color); font-weight: 500;">
                         ${totalEarnings > 0 ? 'ğŸ“ˆ ç›ˆåˆ©ä¸­' : 'å¾…æ¿€æ´»'}
                       </div>
                     </div>
                     <div class="stat-value" style="color: var(--success-color); font-weight: bold; font-size: 16px; margin-bottom: 4px;">
                       <span id="totalEarnings">${totalEarnings.toFixed(2)}</span> USDT
                     </div>
                     <div style="font-size: 10px; color: var(--text-secondary); margin-bottom: 2px;">
                       æ”¶ç›Šç‡: ${totalEarnings > 0 ? (totalEarnings/100*100).toFixed(1) + '%' : '0%'}
                       ${totalEarnings > 0 ? ' | æ—¥å‡: ' + (totalEarnings/7).toFixed(2) + ' USDT' : ''}
                     </div>
                     <div style="font-size: 10px; color: var(--text-secondary);">
                       ${totalEarnings === 0 ? 'ğŸ’¡ å®Œæˆä»»åŠ¡å¼€å§‹èµšå–æ”¶ç›Š' : 'ğŸš€ ç»§ç»­å®Œæˆä»»åŠ¡æå‡æ”¶ç›Š'}
                     </div>
                   </div>
                 </div>
              </div>
            </div>
          `;
        },
        buttons: [
          { text: 'å›¢é˜Ÿ', color: 'orange', key: 'team', action: () => showTeam() },
          { text: 'æŠ¢çº¢åŒ…', color: 'red', key: 'red', action: () => grabRedPacket() },
          { text: 'é’±åŒ…', color: 'purple', key: 'wallet', action: () => showWallet() },
          { text: 'æ’è¡Œæ¦œ', color: 'green', key: 'rank', action: () => showRanking() }
        ]
      },
      3: {
        name: 'çŠ¶æ€3',
        subtitle: 'å€’è®¡æ—¶ç»“æŸæœªå¤è´­',
        card: function() {
          const completedTasks = newTasks.filter(t => t.done).length;
          return `
            <div class="section reactivate-highlight">
              <div class="section-title">ğŸ”¥ å†æ¬¡æ¿€æ´»</div>
              <div class="section-content">
                <p style="margin-bottom: 12px;">é‡æ–°å¼€å¯168å°æ—¶æŒ‘æˆ˜ï¼Œç»§ç»­èµšå–æ”¶ç›Šï¼</p>
                <button class="reactivate-btn" onclick="repurchase()">ç«‹å³æ¿€æ´» 100 USDT</button>
              </div>
            </div>
            <div class="section">
              <div class="section-title">æˆ˜ç»©å¡</div>
              <div class="section-content">æœ¬æœŸæ”¶ç›Šï¼š<strong>${totalEarnings.toFixed(2)} USDT</strong><br/>æ–°æ‰‹ä»»åŠ¡ï¼š${completedTasks}/3 å®Œæˆ<br/>å›¢é˜Ÿäººæ•°ï¼š${teamMembers}äºº</div>
            </div>
            <div class="section">
              <div class="section-title">æˆ‘çš„å›¢é˜Ÿ</div>
              <div class="section-content">æŸ¥çœ‹ä¸ƒå±‚å›¢é˜Ÿç»“æ„å’Œäººæ•°ã€‚</div>
            </div>
          `;
        },
        buttons: [
          { text: 'å†æ¬¡æ¿€æ´»', color: 'blue', key: 'reactivate', action: () => repurchase() },
          { text: 'å›¢é˜Ÿ', color: 'orange', key: 'team', action: () => showTeam() },
          { text: 'é’±åŒ…', color: 'purple', key: 'wallet', action: () => showWallet() },
          { text: 'æ’è¡Œæ¦œ', color: 'green', key: 'rank', action: () => showRanking() }
        ]
      }
    };

    /* æŒ‰é’®åˆ†ç±»ç³»ç»Ÿ */
    function getButtonCategory(buttonKey) {
      // ä¸»è¦åŠŸèƒ½æŒ‰é’®
      const primaryButtons = ['activate', 'reactivate', 'invite', 'wallet', 'team'];
      // é‡‘èç›¸å…³æŒ‰é’®
      const financialButtons = ['wallet', 'grab-red-packet'];
      // æ¸¸æˆåŒ–æŒ‰é’®
      const gamificationButtons = ['tasks', 'god-tasks', 'leaderboard'];
      
      if (primaryButtons.includes(buttonKey)) {
        return 'btn-primary';
      } else if (financialButtons.includes(buttonKey)) {
        return 'btn-financial';
      } else if (gamificationButtons.includes(buttonKey)) {
        return 'btn-gamification';
      }
      return 'btn-default';
    }
    
    /* ä»»åŠ¡æ•°æ® */
    const newTasks = [
      { id: 1, title: 'ç›´æ¥æ¨è1äºº', desc: 'é‚€è¯·1ä½å¥½å‹æ³¨å†Œå¹¶æ¿€æ´»è´¦å·', done: false, reward: 10 },
      { id: 2, title: 'å¸®åŠ©ä¸‹çº§æ¨è1äºº', desc: 'æŒ‡å¯¼ä½ çš„ä¸‹çº§æˆåŠŸé‚€è¯·1ä½æ–°ç”¨æˆ·', done: false, reward: 10 },
      { id: 3, title: 'æ•™ä¸‹çº§å¦‚ä½•æ•™ä»–çš„ä¸‹çº§æ¨è1äºº', desc: 'åŸ¹è®­ä¸‹çº§çš„æ¨å¹¿æŠ€å·§ï¼Œå¸®åŠ©ä¸‰çº§æ¨å¹¿', done: false, reward: 10 }
    ];
    
    // ç­”é¢˜ä»»åŠ¡æ•°æ®
    const quizTasks = [
      { id: 'quiz1', title: 'åŸºç¡€çŸ¥è¯†ç­”é¢˜', desc: 'å®Œæˆ20é“åŸºç¡€é¢˜ç›®ï¼Œæ­£ç¡®ç‡è¾¾åˆ°80%', done: false, reward: 20, feeReduction: 0.02 }
    ];
    
    const godTasks = [
      { id: 1, title: 'å¤§ç¥ä»»åŠ¡ä¸€ï¼šç›´æ¨2äºº Ã— 2å±‚ = 6äºº', desc: 'å»ºç«‹2å±‚å›¢é˜Ÿç»“æ„ï¼Œæ¯å±‚2äºº', done: false, reward: 50 },
      { id: 2, title: 'å¤§ç¥ä»»åŠ¡äºŒï¼šç›´æ¨3äºº Ã— 3å±‚ = 39äºº', desc: 'å»ºç«‹3å±‚å›¢é˜Ÿç»“æ„ï¼Œæ¯å±‚3äºº', done: false, reward: 250 },
      { id: 3, title: 'å¤§ç¥ä»»åŠ¡ä¸‰ï¼šç›´æ¨4äºº Ã— 4å±‚ = 340äºº', desc: 'å»ºç«‹4å±‚å›¢é˜Ÿç»“æ„ï¼Œæ¯å±‚4äºº', done: false, reward: 1250 },
      { id: 4, title: 'å¤§ç¥ä»»åŠ¡å››ï¼šç›´æ¨5äºº Ã— 5å±‚ = 3905äºº', desc: 'å»ºç«‹5å±‚å›¢é˜Ÿç»“æ„ï¼Œæ¯å±‚5äºº', done: false, reward: 6250 },
      { id: 5, title: 'å¤§ç¥ä»»åŠ¡äº”ï¼šç›´æ¨6äºº Ã— 6å±‚ = 55986äºº', desc: 'å»ºç«‹6å±‚å›¢é˜Ÿç»“æ„ï¼Œæ¯å±‚6äºº', done: false, reward: 31250 },
      { id: 6, title: 'å¤§ç¥ä»»åŠ¡å…­ï¼šç›´æ¨7äºº Ã— 7å±‚ = 960799äºº', desc: 'å»ºç«‹7å±‚å›¢é˜Ÿç»“æ„ï¼Œæ¯å±‚7äºº', done: false, reward: 156250 }
    ];

    // ===== API è°ƒç”¨å·¥å…·å‡½æ•° =====
    const API_BASE_URL = 'http://localhost:3000';
    
    // è·å–è®¤è¯token
    function getAuthToken() {
      // ä»localStorageè·å–çœŸå®çš„JWT token
      const token = localStorage.getItem('token') || localStorage.getItem('authToken');
      
      // å¦‚æœæ²¡æœ‰æœ‰æ•ˆtokenï¼Œä½¿ç”¨é»˜è®¤çš„æ¨¡æ‹Ÿtoken
      if (!token || token === 'demo-token') {
        return 'mock-token-1';
      }
      
      return token;
    }
    
    // APIè¯·æ±‚å°è£…
    async function apiRequest(endpoint, options = {}) {
      const token = getAuthToken();
      const url = `${API_BASE_URL}/api${endpoint}`;
      
      const config = {
        headers: {
          'Content-Type': 'application/json',
          ...(token && { 'Authorization': `Bearer ${token}` })
        },
        ...options
      };
      
      try {
        const response = await fetch(url, config);
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.message || `HTTP error! status: ${response.status}`);
        }
        
        return data;
      } catch (error) {
        console.error('APIè¯·æ±‚å¤±è´¥:', error);
        throw error;
      }
    }
    
    // çŠ¶æ€ç®¡ç†APIè°ƒç”¨
    const StateAPI = {
      // è·å–ç”¨æˆ·çŠ¶æ€
      async getStatus() {
        return await apiRequest('/state/status');
      },
      
      // æ¿€æ´»è´¦å·
      async activate() {
        return await apiRequest('/state/activate', {
          method: 'POST'
        });
      },
      
      // å¤è´­
      async repurchase() {
        return await apiRequest('/state/repurchase', {
          method: 'POST'
        });
      },
      
      // åŒæ­¥çŠ¶æ€
      async syncState(localState) {
        return await apiRequest('/state/sync', {
          method: 'PUT',
          body: JSON.stringify(localState)
        });
      },
      
      // åˆ‡æ¢çŠ¶æ€ï¼ˆå¼€å‘ç”¨ï¼‰
      async switchState(newState) {
        return await apiRequest('/state/switch', {
          method: 'POST',
          body: JSON.stringify({ state: newState })
        });
      }
    };

    /* å…¨å±€çŠ¶æ€å˜é‡ */
    let currentState = 1;
    let countdownStart = null; // å¼€å¯å€’è®¡æ—¶çš„æ—¶é—´æˆ³
    let inviteStart = null;    // é‚€è¯·é“¾æ¥ç”Ÿæ•ˆæ—¶é—´æˆ³
    let countdownTimer = null;

    // æ¨¡æ‹Ÿç”¨æˆ·é’±åŒ…ä½™é¢ï¼Œç”¨äºçº¢åŒ…å’Œæç°åŠŸèƒ½
    let walletBalance = 0;

    // äº¤æ˜“è®°å½•åˆ—è¡¨
    let transactions = [];

    // æç°æ‰‹ç»­è´¹æ¯”ä¾‹ï¼Œé»˜è®¤ä¸º 5%ï¼ˆ0.05ï¼‰ï¼Œå¯é€šè¿‡ç­”é¢˜ä»»åŠ¡é™ä½ï¼Œæœ€ä½ 1%ï¼ˆ0.01ï¼‰
    let withdrawFeeRate = 0.05;

    // æ–°å¢çŠ¶æ€ç®¡ç†å˜é‡
    let userLevel = 0; // ç”¨æˆ·ç­‰çº§ 0:æœªæ¿€æ´» 1:å·²æ¿€æ´»
    let completedNewbieTasks = 0; // å·²å®Œæˆæ–°æ‰‹ä»»åŠ¡æ•°é‡
    let quizCompleted = false; // ç­”é¢˜ä»»åŠ¡æ˜¯å¦å®Œæˆ
    let godTasksUnlocked = false; // å¤§ç¥ä»»åŠ¡æ˜¯å¦è§£é”
    let teamMembers = 0; // å›¢é˜Ÿæˆå‘˜æ•°é‡
    let totalEarnings = 0; // æ€»æ”¶ç›Š

    /**
     * ä» localStorage åˆå§‹åŒ–çŠ¶æ€ï¼ŒåŒ…æ‹¬ä½™é¢ã€ä»»åŠ¡å®ŒæˆçŠ¶æ€å’Œäº¤æ˜“è®°å½•ã€‚
     */
    function loadState() {
      const savedState = localStorage.getItem('appState');
      if (savedState) {
        try {
          const state = JSON.parse(savedState);
          currentState = state.currentState || 1;
          countdownStart = state.countdownStart;
          inviteStart = state.inviteStart;
          walletBalance = state.walletBalance || 0;
          transactions = state.transactions || [];
          userLevel = state.userLevel || 0;
          completedNewbieTasks = state.completedNewbieTasks || 0;
          quizCompleted = state.quizCompleted || false;
          godTasksUnlocked = state.godTasksUnlocked || false;
          teamMembers = state.teamMembers || 0;
          totalEarnings = state.totalEarnings || 0;
          withdrawFeeRate = state.withdrawFeeRate || 0.05;
          
          // æ£€æŸ¥quizå®ŒæˆçŠ¶æ€ï¼Œç¡®ä¿ä¸quiz.htmlçš„çŠ¶æ€åŒæ­¥
          const quizProgress = JSON.parse(localStorage.getItem('quizProgress') || '{}');
          if (quizProgress.correctCount >= 20) {
            quizCompleted = true;
            state.quizCompleted = true;
          }
          
          // åŒæ­¥å›¢é˜Ÿæ”¶ç›Šï¼šæ€»æ”¶ç›Š = å›¢é˜Ÿäººæ•° * 10
          const teamData = JSON.parse(localStorage.getItem('teamData') || '{}');
          if (teamData.totalMembers) {
            totalEarnings = teamData.totalMembers * 10;
            teamMembers = teamData.totalMembers;
          }
          
          // æ¢å¤ä»»åŠ¡çŠ¶æ€
          if (state.newTasks) {
            state.newTasks.forEach((task, index) => {
              if (newTasks[index]) newTasks[index].done = task.done;
            });
            // åŒæ­¥completedNewbieTaskså˜é‡ï¼Œç¡®ä¿ä¸newTasksæ•°ç»„çŠ¶æ€ä¸€è‡´
            completedNewbieTasks = newTasks.filter(t => t.done).length;
          }
          if (state.quizTasks) {
            state.quizTasks.forEach((task, index) => {
              if (quizTasks[index]) quizTasks[index].done = task.done;
            });
          }
          if (state.godTasks) {
            state.godTasks.forEach((task, index) => {
              if (godTasks[index]) godTasks[index].done = task.done;
            });
          }
        } catch (e) {
          console.warn('æ— æ³•è§£æ appState', e);
        }
      }
    }

    /**
     * å°†å½“å‰çŠ¶æ€ä¿å­˜åˆ° localStorageã€‚
     */
    function saveState() {
      // åŒæ­¥å›¢é˜Ÿæ”¶ç›Šï¼šæ€»æ”¶ç›Š = å›¢é˜Ÿäººæ•° * 10
      const teamData = JSON.parse(localStorage.getItem('teamData') || '{}');
      if (teamData.totalMembers) {
        totalEarnings = teamData.totalMembers * 10;
      }
      
      const state = {
        currentState,
        countdownStart,
        inviteStart,
        walletBalance,
        transactions,
        userLevel,
        completedNewbieTasks,
        quizCompleted,
        godTasksUnlocked,
        teamMembers,
        totalEarnings,
        withdrawFeeRate,
        newTasks: newTasks.map(t => ({ ...t })),
        quizTasks: quizTasks.map(t => ({ ...t })),
        godTasks: godTasks.map(t => ({ ...t }))
      };
      localStorage.setItem('appState', JSON.stringify(state));
    }

    // ä¸åç«¯åŒæ­¥çŠ¶æ€
    async function syncWithBackend() {
      try {
        console.log('æ­£åœ¨ä¸åç«¯åŒæ­¥çŠ¶æ€...');
        const response = await StateAPI.getStatus();
        
        if (response.success && response.data) {
          const backendState = response.data;
          
          // æ›´æ–°å‰ç«¯çŠ¶æ€
          currentState = backendState.status;
          
          // å¦‚æœåç«¯æœ‰å€’è®¡æ—¶ä¿¡æ¯ï¼ŒåŒæ­¥å€’è®¡æ—¶
          if (backendState.countdown_end_time) {
            const endTime = new Date(backendState.countdown_end_time);
            const now = new Date();
            if (endTime > now) {
              countdownStart = now.getTime();
              // è®¡ç®—å€’è®¡æ—¶å¼€å§‹æ—¶é—´ï¼ˆ168å°æ—¶å‰ï¼‰
              const startTime = new Date(endTime.getTime() - 168 * 60 * 60 * 1000);
              countdownStart = startTime.getTime();
            }
          }
          
          // åŒæ­¥å…¶ä»–æ•°æ®
          if (backendState.balance !== undefined) {
            walletBalance = backendState.balance;
          }
          if (backendState.total_earnings !== undefined) {
            totalEarnings = backendState.total_earnings;
          }
          if (backendState.team_count !== undefined) {
            teamMembers = backendState.team_count;
          }
          
          console.log('åç«¯çŠ¶æ€åŒæ­¥æˆåŠŸ:', backendState);
          
          // ä¿å­˜åŒæ­¥åçš„çŠ¶æ€
          saveState();
          
          // é‡æ–°æ¸²æŸ“é¡µé¢
          renderState();
        }
      } catch (error) {
        console.warn('åç«¯çŠ¶æ€åŒæ­¥å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°çŠ¶æ€:', error.message);
        // ç»§ç»­ä½¿ç”¨æœ¬åœ°çŠ¶æ€ï¼Œä¸å½±å“ç”¨æˆ·ä½“éªŒ
      }
    }

    // ç”Ÿæˆç”¨æˆ·ä¸“å±é‚€è¯·ç  - ä»åç«¯APIè·å–
    async function generateUserInviteCode() {
      try {
        const response = await apiRequest('/user/invite-code');
        if (response.success && response.data.inviteCode) {
          return response.data.inviteCode;
        }
      } catch (error) {
        console.error('è·å–é‚€è¯·ç å¤±è´¥:', error);
      }
      
      // å¦‚æœAPIè°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨é‚®ç®±ç”Ÿæˆå¤‡ç”¨é‚€è¯·ç 
      const userEmail = localStorage.getItem('userEmail');
      if (userEmail) {
        const emailPrefix = userEmail.split('@')[0].substring(0, 6).toUpperCase();
        return emailPrefix + Date.now().toString().slice(-6);
      }
      return 'USER' + Date.now().toString().slice(-6);
    }

    // é€šçŸ¥ç³»ç»Ÿå¢å¼º
    let notifications = []; // é€šçŸ¥å†å²è®°å½•
    let unreadNotifications = 0; // æœªè¯»é€šçŸ¥æ•°é‡

    /**
     * æ·»åŠ é€šçŸ¥åˆ°å†å²è®°å½•
     * @param {string} type - é€šçŸ¥ç±»å‹
     * @param {string} title - é€šçŸ¥æ ‡é¢˜
     * @param {string} message - é€šçŸ¥å†…å®¹
     * @param {Object} data - é™„åŠ æ•°æ®
     */
    function addNotification(type, title, message, data = {}) {
      const notification = {
        id: Date.now(),
        type,
        title,
        message,
        data,
        timestamp: new Date(),
        read: false
      };
      
      notifications.unshift(notification);
      unreadNotifications++;
      
      // é™åˆ¶é€šçŸ¥å†å²è®°å½•æ•°é‡
      if (notifications.length > 50) {
        notifications = notifications.slice(0, 50);
      }
      
      // ä¿å­˜åˆ°localStorage
      localStorage.setItem('notifications', JSON.stringify(notifications));
      localStorage.setItem('unreadNotifications', unreadNotifications.toString());
      
      // æ›´æ–°é€šçŸ¥æŒ‰é’®æ˜¾ç¤º
      updateNotificationButton();
      
      // æ˜¾ç¤ºæµ®åŠ¨é€šçŸ¥
      showFloatingNotification(notification);
    }

    /**
     * æ˜¾ç¤ºæµ®åŠ¨é€šçŸ¥
     * @param {Object} notification - é€šçŸ¥å¯¹è±¡
     */
    function showFloatingNotification(notification) {
      // åˆ›å»ºæµ®åŠ¨é€šçŸ¥å…ƒç´ 
      const floatingNotification = document.createElement('div');
      floatingNotification.className = `floating-notification ${notification.type}`;
      floatingNotification.innerHTML = `
        <div class="notification-icon">
          ${getNotificationIcon(notification.type)}
        </div>
        <div class="notification-content">
          <div class="notification-title">${notification.title}</div>
          <div class="notification-message">${notification.message}</div>
        </div>
        <div class="notification-close" onclick="closeFloatingNotification(this)">Ã—</div>
      `;
      
      // æ·»åŠ åˆ°é¡µé¢
      document.body.appendChild(floatingNotification);
      
      // åŠ¨ç”»æ˜¾ç¤º
      setTimeout(() => {
        floatingNotification.classList.add('show');
      }, 100);
      
      // è‡ªåŠ¨éšè—
      setTimeout(() => {
        closeFloatingNotification(floatingNotification);
      }, 5000);
      
      // ç‚¹å‡»äº‹ä»¶
      floatingNotification.addEventListener('click', () => {
        handleNotificationClick(notification);
        closeFloatingNotification(floatingNotification);
      });
    }

    /**
     * å…³é—­æµ®åŠ¨é€šçŸ¥
     * @param {Element} element - é€šçŸ¥å…ƒç´ æˆ–å…³é—­æŒ‰é’®
     */
    function closeFloatingNotification(element) {
      const notification = element.classList.contains('floating-notification') ? element : element.closest('.floating-notification');
      if (notification) {
        notification.classList.remove('show');
        setTimeout(() => {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 300);
      }
    }

    /**
     * è·å–é€šçŸ¥å›¾æ ‡
     * @param {string} type - é€šçŸ¥ç±»å‹
     * @returns {string} å›¾æ ‡HTML
     */
    function getNotificationIcon(type) {
      const icons = {
        'redpacket_notification': 'ğŸ§§',
        'balance_update': 'ğŸ’°',
        'task_reminder': 'ğŸ“‹',
        'task_complete': 'âœ…',
        'system_notification': 'ğŸ””',
        'team_update': 'ğŸ‘¥',
        'level_up': 'ğŸ‰',
        'withdrawal_status': 'ğŸ’³',
        'deposit_confirmed': 'ğŸ’'
      };
      return icons[type] || 'ğŸ””';
    }

    /**
     * å¤„ç†é€šçŸ¥ç‚¹å‡»äº‹ä»¶
     * @param {Object} notification - é€šçŸ¥å¯¹è±¡
     */
    function handleNotificationClick(notification) {
      switch (notification.type) {
        case 'redpacket_notification':
          grabRedPacket();
          break;
        case 'task_reminder':
        case 'task_complete':
          showTasks();
          break;
        case 'balance_update':
        case 'withdrawal_status':
        case 'deposit_confirmed':
          showWallet();
          break;
        case 'team_update':
          showTeam();
          break;
        default:
          // é»˜è®¤è¡Œä¸ºï¼šæ ‡è®°ä¸ºå·²è¯»
          markNotificationAsRead(notification.id);
      }
    }

    /**
     * æ ‡è®°é€šçŸ¥ä¸ºå·²è¯»
     * @param {number} notificationId - é€šçŸ¥ID
     */
    function markNotificationAsRead(notificationId) {
      const notification = notifications.find(n => n.id === notificationId);
      if (notification && !notification.read) {
        notification.read = true;
        unreadNotifications = Math.max(0, unreadNotifications - 1);
        
        // ä¿å­˜åˆ°localStorage
        localStorage.setItem('notifications', JSON.stringify(notifications));
        localStorage.setItem('unreadNotifications', unreadNotifications.toString());
        
        // æ›´æ–°é€šçŸ¥æŒ‰é’®æ˜¾ç¤º
        updateNotificationButton();
      }
    }

    /**
     * æ›´æ–°é€šçŸ¥æŒ‰é’®æ˜¾ç¤º
     */
    function updateNotificationButton() {
      const notificationButton = document.querySelector('.notification-button');
      if (notificationButton) {
        const badge = notificationButton.querySelector('.notification-badge');
        if (unreadNotifications > 0) {
          if (!badge) {
            const newBadge = document.createElement('span');
            newBadge.className = 'notification-badge';
            notificationButton.appendChild(newBadge);
          }
          notificationButton.querySelector('.notification-badge').textContent = unreadNotifications > 99 ? '99+' : unreadNotifications;
          notificationButton.classList.add('has-unread');
        } else {
          if (badge) {
            badge.remove();
          }
          notificationButton.classList.remove('has-unread');
        }
      }
    }

    /**
     * æ˜¾ç¤ºé€šçŸ¥ä¸­å¿ƒ
     */
    function showNotificationCenter() {
      // æ ‡è®°æ‰€æœ‰é€šçŸ¥ä¸ºå·²è¯»
      notifications.forEach(n => n.read = true);
      unreadNotifications = 0;
      localStorage.setItem('notifications', JSON.stringify(notifications));
      localStorage.setItem('unreadNotifications', '0');
      updateNotificationButton();
      
      // æ„å»ºé€šçŸ¥åˆ—è¡¨HTML
      const notificationListHTML = notifications.length > 0 ? 
        notifications.map(notification => `
          <div class="notification-item ${notification.type}">
            <div class="notification-icon">${getNotificationIcon(notification.type)}</div>
            <div class="notification-content">
              <div class="notification-title">${notification.title}</div>
              <div class="notification-message">${notification.message}</div>
              <div class="notification-time">${formatNotificationTime(notification.timestamp)}</div>
            </div>
          </div>
        `).join('') :
        '<div class="no-notifications">æš‚æ— é€šçŸ¥</div>';
      
      showDialog(
        'é€šçŸ¥ä¸­å¿ƒ',
        `<div class="notification-center">${notificationListHTML}</div>`,
        [
          { text: 'æ¸…ç©ºé€šçŸ¥', action: () => clearAllNotifications() },
          { text: 'å…³é—­', action: 'close' }
        ],
        'notification'
      );
    }

    /**
     * æ¸…ç©ºæ‰€æœ‰é€šçŸ¥
     */
    function clearAllNotifications() {
      notifications = [];
      unreadNotifications = 0;
      localStorage.removeItem('notifications');
      localStorage.removeItem('unreadNotifications');
      updateNotificationButton();
      
      showDialog(
        'é€šçŸ¥ä¸­å¿ƒ',
        '<div class="notification-center"><div class="no-notifications">æš‚æ— é€šçŸ¥</div></div>',
        [{ text: 'å…³é—­', action: 'close' }],
        'notification'
      );
    }

    /**
     * æ ¼å¼åŒ–é€šçŸ¥æ—¶é—´
     * @param {Date} timestamp - æ—¶é—´æˆ³
     * @returns {string} æ ¼å¼åŒ–çš„æ—¶é—´å­—ç¬¦ä¸²
     */
    function formatNotificationTime(timestamp) {
      const now = new Date();
      const diff = now - new Date(timestamp);
      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(diff / 3600000);
      const days = Math.floor(diff / 86400000);
      
      if (minutes < 1) return 'åˆšåˆš';
      if (minutes < 60) return `${minutes}åˆ†é’Ÿå‰`;
      if (hours < 24) return `${hours}å°æ—¶å‰`;
      if (days < 7) return `${days}å¤©å‰`;
      
      return new Date(timestamp).toLocaleDateString();
    }

    /**
     * åŠ è½½é€šçŸ¥å†å²è®°å½•
     */
    function loadNotifications() {
      const savedNotifications = localStorage.getItem('notifications');
      const savedUnreadCount = localStorage.getItem('unreadNotifications');
      
      if (savedNotifications) {
        try {
          notifications = JSON.parse(savedNotifications);
          unreadNotifications = parseInt(savedUnreadCount) || 0;
        } catch (e) {
          console.warn('æ— æ³•è§£æé€šçŸ¥å†å²è®°å½•', e);
          notifications = [];
          unreadNotifications = 0;
        }
      }
      
      updateNotificationButton();
    }

    // WebSocketè¿æ¥å’Œå®æ—¶é€šçŸ¥åŠŸèƒ½
    let websocket = null;
    
    function initWebSocket() {
      // è·å–JWT token
      const token = getAuthToken();
      if (!token) {
        console.log('æœªæ‰¾åˆ°tokenï¼Œè·³è¿‡WebSocketè¿æ¥');
        return;
      }
      
      // è¿æ¥WebSocketæœåŠ¡å™¨ï¼ˆä½¿ç”¨æ­£ç¡®çš„è·¯å¾„å’Œtokenï¼‰
      websocket = new WebSocket(`ws://localhost:3000/ws?token=${encodeURIComponent(token)}`);
      
      websocket.onopen = function(event) {
        console.log('WebSocketè¿æ¥å·²å»ºç«‹');
      };
      
      websocket.onmessage = function(event) {
        try {
          const data = JSON.parse(event.data);
          handleWebSocketMessage(data);
        } catch (error) {
          console.error('è§£æWebSocketæ¶ˆæ¯å¤±è´¥:', error);
        }
      };
      
      websocket.onclose = function(event) {
        console.log('WebSocketè¿æ¥å·²å…³é—­');
        // 5ç§’åå°è¯•é‡è¿
        setTimeout(initWebSocket, 5000);
      };
      
      websocket.onerror = function(error) {
        console.error('WebSocketé”™è¯¯:', error);
      };
    }
    
    function handleWebSocketMessage(data) {
      switch (data.type) {
        case 'redpacket_notification':
          // çº¢åŒ…é€šçŸ¥
          addNotification(
            'redpacket_notification',
            'çº¢åŒ…æé†’',
            'æ–°çš„çº¢åŒ…æ´»åŠ¨å¼€å§‹äº†ï¼å¿«å»æŠ¢çº¢åŒ…å§ï¼',
            data
          );
          showDialog(
            'çº¢åŒ…æé†’',
            `æ–°çš„çº¢åŒ…æ´»åŠ¨å¼€å§‹äº†ï¼å¿«å»æŠ¢çº¢åŒ…å§ï¼`,
            [{ text: 'ç«‹å³æŠ¢çº¢åŒ…', action: 'grabRedPacket' }, { text: 'ç¨åå†è¯´', action: 'close' }],
            'redpacket'
          );
          break;
          
        case 'balance_update':
          // ä½™é¢æ›´æ–°é€šçŸ¥
          addNotification(
            'balance_update',
            'ä½™é¢å˜åŒ–',
            `${data.reason || 'ä½™é¢æ›´æ–°'}: ${data.newBalance} USDT`,
            data
          );
          updateWalletBalance(data.newBalance, data.reason);
          break;
          
        case 'task_reminder':
          // ä»»åŠ¡æé†’
          addNotification(
            'task_reminder',
            'ä»»åŠ¡æé†’',
            data.message,
            data
          );
          showDialog(
            'ä»»åŠ¡æé†’',
            data.message,
            [{ text: 'æŸ¥çœ‹ä»»åŠ¡', action: 'showTasks' }, { text: 'ç¨åå†è¯´', action: 'close' }],
            'success'
          );
          break;
          
        case 'task_complete':
          // ä»»åŠ¡å®Œæˆé€šçŸ¥
          addNotification(
            'task_complete',
            'ä»»åŠ¡å®Œæˆ',
            data.message || 'æ­å–œæ‚¨å®Œæˆäº†ä¸€ä¸ªä»»åŠ¡ï¼',
            data
          );
          // æ’­æ”¾æˆåŠŸéŸ³æ•ˆ
          playSound('success');
          break;
          
        case 'team_update':
          // å›¢é˜Ÿæ›´æ–°é€šçŸ¥
          addNotification(
            'team_update',
            'å›¢é˜Ÿæ›´æ–°',
            data.message || 'æ‚¨çš„å›¢é˜Ÿæœ‰æ–°çš„å˜åŒ–',
            data
          );
          break;
          
        case 'level_up':
          // ç­‰çº§æå‡é€šçŸ¥
          addNotification(
            'level_up',
            'ç­‰çº§æå‡',
            data.message || 'æ­å–œæ‚¨çš„ç­‰çº§æå‡äº†ï¼',
            data
          );
          showDialog(
            'ğŸ‰ ç­‰çº§æå‡',
            data.message || 'æ­å–œæ‚¨çš„ç­‰çº§æå‡äº†ï¼',
            [{ text: 'å¤ªæ£’äº†ï¼', action: 'close' }],
            'success'
          );
          break;
          
        case 'withdrawal_status':
          // æç°çŠ¶æ€æ›´æ–°
          addNotification(
            'withdrawal_status',
            'æç°çŠ¶æ€æ›´æ–°',
            data.message || 'æ‚¨çš„æç°çŠ¶æ€å·²æ›´æ–°',
            data
          );
          break;
          
        case 'deposit_confirmed':
          // å…¥é‡‘ç¡®è®¤
          addNotification(
            'deposit_confirmed',
            'å…¥é‡‘ç¡®è®¤',
            data.message || 'æ‚¨çš„å…¥é‡‘å·²ç¡®è®¤',
            data
          );
          break;
          
        case 'system_notification':
          // ç³»ç»Ÿé€šçŸ¥
          addNotification(
            'system_notification',
            'ç³»ç»Ÿé€šçŸ¥',
            data.message,
            data
          );
          showDialog(
            'ç³»ç»Ÿé€šçŸ¥',
            data.message,
            [{ text: 'ç¡®å®š', action: 'close' }],
            'success'
          );
          break;
          
        default:
          console.log('æœªçŸ¥çš„WebSocketæ¶ˆæ¯ç±»å‹:', data.type);
      }
    }
    
    // æ›´æ–°é’±åŒ…ä½™é¢å‡½æ•°
    function updateWalletBalance(newBalance, reason = '') {
      const oldBalance = walletBalance;
      walletBalance = newBalance;
      
      // ä¿å­˜åˆ°localStorage
      localStorage.setItem('walletBalance', walletBalance.toString());
      
      // é‡æ–°æ¸²æŸ“é¡µé¢ä»¥æ›´æ–°æ˜¾ç¤º
      renderState();
      
      // æ˜¾ç¤ºä½™é¢å˜åŒ–é€šçŸ¥
      if (reason) {
        const changeAmount = newBalance - oldBalance;
        const changeText = changeAmount > 0 ? `+${changeAmount}` : changeAmount.toString();
        showDialog(
          'ä½™é¢å˜åŒ–',
          `${reason}\nä½™é¢å˜åŒ–: ${changeText}å…ƒ\nå½“å‰ä½™é¢: ${newBalance}å…ƒ`,
          [{ text: 'ç¡®å®š', action: 'close' }],
          'success'
        );
      }
    }
    
    // æ˜¾ç¤ºä»»åŠ¡é¡µé¢å‡½æ•°
    function showTasks() {
      if (currentState === 1) {
        showDialog('ä»»åŠ¡ç³»ç»Ÿ', 'è¯·å…ˆæ¿€æ´»è´¦å·åæŸ¥çœ‹ä»»åŠ¡', [{ text: 'çŸ¥é“äº†', action: 'close' }]);
        return;
      }

      // è·å–ä»»åŠ¡æ•°æ®
      const taskData = getTaskData();
      
      // æ„å»ºä»»åŠ¡åˆ—è¡¨HTML
      let taskListHTML = `
        <div class="task-overview">
          <div class="task-stats">
            <div class="stat-item">
              <span class="stat-label">æ–°æ‰‹ä»»åŠ¡</span>
              <span class="stat-value">${taskData.completedNewbieTasks}/4</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">ç­”é¢˜ä»»åŠ¡</span>
              <span class="stat-value">${taskData.quizCompleted ? 'å·²å®Œæˆ' : 'æœªå®Œæˆ'}</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">å¤§ç¥ä»»åŠ¡</span>
              <span class="stat-value">${taskData.godTasksCompleted}/6</span>
            </div>
          </div>
        </div>
        
        <div class="task-sections">
          <div class="task-section">
            <h4>ğŸ¯ æ–°æ‰‹ä»»åŠ¡ (${taskData.completedNewbieTasks}/4)</h4>
            <div class="task-list">
              ${taskData.newbieTasks.map(task => `
                <div class="task-item ${task.done ? 'completed' : (task.id === taskData.completedNewbieTasks + 1 ? 'current' : 'locked')}">
                  <div class="task-info">
                    <span class="task-title">${task.title}</span>
                    <span class="task-reward">+${task.reward} USDT</span>
                  </div>
                  <div class="task-status">
                    ${task.done ? 'âœ… å·²å®Œæˆ' : (task.id === taskData.completedNewbieTasks + 1 ? 'ğŸ”„ è¿›è¡Œä¸­' : 'ğŸ”’ æœªå¼€å§‹')}
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
          
          <div class="task-section">
            <h4>ğŸ“ ç­”é¢˜ä»»åŠ¡ ${taskData.completedNewbieTasks >= 1 ? '' : '(éœ€å®Œæˆæ–°æ‰‹ä»»åŠ¡1)'}</h4>
            <div class="task-list">
              <div class="task-item ${taskData.quizCompleted ? 'completed' : (taskData.completedNewbieTasks >= 1 ? 'available' : 'locked')}">
                <div class="task-info">
                  <span class="task-title">å®Œæˆ20é“é¢˜ç›® (æ­£ç¡®ç‡â‰¥80%)</span>
                  <span class="task-reward">é™ä½æç°æ‰‹ç»­è´¹</span>
                </div>
                <div class="task-status">
                  ${taskData.quizCompleted ? 'âœ… å·²å®Œæˆ' : (taskData.completedNewbieTasks >= 1 ? 'ğŸ“ å¯ç­”é¢˜' : 'ğŸ”’ æœªè§£é”')}
                </div>
              </div>
            </div>
          </div>
          
          <div class="task-section">
            <h4>ğŸ† å¤§ç¥ä»»åŠ¡ ${taskData.godTasksUnlocked ? `(${taskData.godTasksCompleted}/6)` : '(éœ€å®Œæˆæ‰€æœ‰æ–°æ‰‹ä»»åŠ¡+ç­”é¢˜ä»»åŠ¡)'}</h4>
            <div class="task-list">
              ${taskData.godTasks.map(task => `
                <div class="task-item ${task.done ? 'completed' : (taskData.godTasksUnlocked ? 'available' : 'locked')}">
                  <div class="task-info">
                    <span class="task-title">${task.title}</span>
                    <span class="task-reward">+${task.reward} USDT</span>
                  </div>
                  <div class="task-status">
                    ${task.done ? 'âœ… å·²å®Œæˆ' : (taskData.godTasksUnlocked ? 'ğŸ¯ å¯å®Œæˆ' : 'ğŸ”’ æœªè§£é”')}
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        </div>
      `;

      // æ„å»ºæŒ‰é’®
      let buttons = [];
      
      // å¦‚æœæœ‰å¯æ‰§è¡Œçš„æ–°æ‰‹ä»»åŠ¡
      const nextNewbieTask = taskData.newbieTasks.find(t => !t.done && t.id === taskData.completedNewbieTasks + 1);
      if (nextNewbieTask) {
        buttons.push({ text: 'æ‰§è¡Œå½“å‰ä»»åŠ¡', action: () => executeTask('newbie', nextNewbieTask.id) });
      }
      
      // å¦‚æœç­”é¢˜ä»»åŠ¡å¯ç”¨ä¸”æœªå®Œæˆ
      if (taskData.completedNewbieTasks >= 1 && !taskData.quizCompleted) {
        buttons.push({ text: 'å¼€å§‹ç­”é¢˜', action: () => startQuiz() });
      }
      
      // å¦‚æœå¤§ç¥ä»»åŠ¡å·²è§£é”
      if (taskData.godTasksUnlocked) {
        const nextGodTask = taskData.godTasks.find(t => !t.done);
        if (nextGodTask) {
          buttons.push({ text: 'æŸ¥çœ‹å¤§ç¥ä»»åŠ¡', action: () => executeTask('god', nextGodTask.id) });
        }
      }
      
      buttons.push({ text: 'å…³é—­', action: 'close' });

      // æ˜¾ç¤ºä»»åŠ¡å¯¹è¯æ¡†
      showDialog('ä»»åŠ¡ä¸­å¿ƒ', '', buttons, 'normal', null, taskListHTML);
    }

    /**
     * è·å–ä»»åŠ¡æ•°æ®
     */
    function getTaskData() {
      // è®¡ç®—å®Œæˆçš„æ–°æ‰‹ä»»åŠ¡æ•°é‡
      const completedNewbieTasks = newTasks.filter(task => task.done).length;
      
      // æ£€æŸ¥ç­”é¢˜ä»»åŠ¡æ˜¯å¦å®Œæˆ
      const quizCompleted = appState.quizCompleted || false;
      
      // æ£€æŸ¥å¤§ç¥ä»»åŠ¡æ˜¯å¦è§£é”ï¼ˆéœ€è¦å®Œæˆæ‰€æœ‰æ–°æ‰‹ä»»åŠ¡å’Œç­”é¢˜ä»»åŠ¡ï¼‰
      const godTasksUnlocked = completedNewbieTasks >= 3 && quizCompleted;
      
      // è®¡ç®—å®Œæˆçš„å¤§ç¥ä»»åŠ¡æ•°é‡
      const godTasksCompleted = godTasks.filter(task => task.done).length;

      return {
        newbieTasks: newTasks,
        godTasks,
        completedNewbieTasks,
        quizCompleted,
        godTasksUnlocked,
        godTasksCompleted
      };
    }

    /**
     * æ‰§è¡Œä»»åŠ¡
     */
    function executeTask(taskType, taskId) {
      if (taskType === 'newbie') {
        openTasks();
      } else if (taskType === 'god') {
        openGodTasks();
      }
    }

    /**
     * å¼€å§‹ç­”é¢˜ä»»åŠ¡
     */
    function startQuiz() {
      // æ£€æŸ¥æ˜¯å¦å·²è§£é”ç­”é¢˜ä»»åŠ¡
      const completedNewbieTasks = newTasks.filter(task => task.done).length;
      if (completedNewbieTasks < 1) {
        showDialog('ç­”é¢˜ä»»åŠ¡æœªè§£é”', 'è¯·å…ˆå®Œæˆè‡³å°‘ä¸€ä¸ªæ–°æ‰‹ä»»åŠ¡åå†å¼€å§‹ç­”é¢˜ã€‚');
        return;
      }

      // æ£€æŸ¥æ˜¯å¦å·²å®Œæˆç­”é¢˜ä»»åŠ¡
      const quizCorrect = parseInt(localStorage.getItem('quizCorrect')) || 0;
      if (quizCorrect >= 20) {
        showDialog('ç­”é¢˜ä»»åŠ¡å·²å®Œæˆ', `æ‚¨å·²å®Œæˆç­”é¢˜ä»»åŠ¡ï¼Œæ­£ç¡®ç‡ï¼š${quizCorrect}/20\nå½“å‰æç°æ‰‹ç»­è´¹ï¼š${(parseFloat(localStorage.getItem('withdrawFeeRate') || '0.05') * 100).toFixed(1)}%`);
        return;
      }

      // ä¿å­˜å½“å‰çŠ¶æ€åˆ°localStorage
      saveState();
      
      // è·³è½¬åˆ°ç­”é¢˜é¡µé¢
      window.location.href = 'quiz.html';
    }

    async function init() {
      // ä» localStorage åŠ è½½å†å²çŠ¶æ€
      loadState();
      
      // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•
      const isActivated = localStorage.getItem('isActivated') === 'true';
      const userToken = localStorage.getItem('userToken');
      
      if (!isActivated || !userToken) {
        // æœªæ¿€æ´»æˆ–æ— tokenï¼Œæ˜¾ç¤ºç™»å½•æ³¨å†Œç•Œé¢
        showLoginRegister();
        return;
      }
      
      // å°è¯•ä»åç«¯åŒæ­¥çŠ¶æ€
      syncWithBackend();
      
      // ç”Ÿæˆæˆ–è·å–ç”¨æˆ·é‚€è¯·ç 
      let userInviteCode = localStorage.getItem('userInviteCode');
      if (!userInviteCode) {
        try {
          userInviteCode = await generateUserInviteCode();
          localStorage.setItem('userInviteCode', userInviteCode);
        } catch (error) {
          console.error('ç”Ÿæˆé‚€è¯·ç å¤±è´¥:', error);
          // ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ
          userInviteCode = 'USER' + Date.now().toString().slice(-6);
          localStorage.setItem('userInviteCode', userInviteCode);
        }
      }
      
      // åˆå§‹åŒ–éŸ³æ•ˆç³»ç»Ÿ
      initAudioSystem();
      
      // åˆå§‹åŒ–æ¶ˆæ¯ç³»ç»Ÿ
      initMessages();
      
      // åˆå§‹åŒ–BugæŠ¥å‘Šç³»ç»Ÿ
      initBugReports();
      
      // åˆå§‹åŒ–æ¶ˆæ¯å›¾æ ‡æ‹–æ‹½åŠŸèƒ½
      initMessageIconDrag();
      
      // åˆå§‹åŒ–WebSocketè¿æ¥
      initWebSocket();
      
      // åŠ è½½é€šçŸ¥å†å²
      loadNotifications();
      
      renderState();
      
      // åˆå§‹åŒ–è®¾ç½®é¢æ¿äº‹ä»¶ç›‘å¬å™¨
      initSettingsEvents();
    }

    function renderState() {
      const state = STATES[currentState];
      // æ³¨é‡Šæ‰çŠ¶æ€æ ‡ç­¾å’Œå‰¯æ ‡é¢˜çš„æ›´æ–°ï¼Œå› ä¸ºè¿™äº›å…ƒç´ å·²è¢«éšè—
      // document.getElementById('stateLabel').innerText = state.name;
      // document.getElementById('subtitle').innerText = state.subtitle;
      // æ¸²æŸ“å¡ç‰‡å†…å®¹
      document.getElementById('card').innerHTML = state.card();
      
      // æ›´æ–°æˆ˜ç»©å¡æ•°æ®
      updateStatsDisplay();
      
      // æ¸²æŸ“åº•éƒ¨æŒ‰é’®
      const bottom = document.getElementById('bottomButtons');
      bottom.innerHTML = '';
      
      // ä¸¥æ ¼æŒ‰çŠ¶æ€æ§åˆ¶æŒ‰é’®æ˜¾ç¤º
      const buttonsToShow = getButtonsForState(currentState);
      
      // å¦‚æœæŒ‰é’®è¶…è¿‡6ä¸ªï¼Œæ·»åŠ many-buttonsç±»
      if (buttonsToShow.length > 6) {
        bottom.classList.add('many-buttons');
      } else {
        bottom.classList.remove('many-buttons');
      }
      
      buttonsToShow.forEach(btnConfig => {
        const b = document.createElement('button');
        b.innerText = btnConfig.text;
        
        // åº”ç”¨æ–°çš„æŒ‰é’®åˆ†ç±»ç³»ç»Ÿ
        const buttonCategory = getButtonCategory(btnConfig.key || btnConfig.text);
        b.classList.add(buttonCategory);
        
        // ä¿æŒåŸæœ‰é¢œè‰²ç±»ï¼ˆå‘åå…¼å®¹ï¼‰
        if (btnConfig.color) {
          b.classList.add(btnConfig.color);
        }
        
        b.onclick = btnConfig.action;
        
        // è®¾ç½® data-key ä»¥ä¾¿æ ·å¼å®šåˆ¶
        if (btnConfig.key) {
          b.dataset.key = btnConfig.key;
        }
        
        bottom.appendChild(b);
      });
      
      // æ§åˆ¶å€’è®¡æ—¶
      if (currentState === 2) {
        if (!countdownStart) {
          countdownStart = Date.now();
          inviteStart = countdownStart;
        }
        updateCountdown();
        countdownTimer = setInterval(updateCountdown, 1000);
      } else {
        if (countdownTimer) clearInterval(countdownTimer);
      }
      
      // æ›´æ–°æ¶ˆæ¯æŒ‰é’®çŠ¶æ€
      updateMessageButton();
    }
    
    // æ ¹æ®çŠ¶æ€ä¸¥æ ¼æ§åˆ¶æŒ‰é’®æ˜¾ç¤º
    function getButtonsForState(state) {
      const baseButtons = STATES[state].buttons;
      const result = [...baseButtons];
      

      
      return result;
    }
    
    // æ›´æ–°æˆ˜ç»©å¡æ˜¾ç¤º
    function updateStatsDisplay() {
      const taskProgressEl = document.getElementById('taskProgress');
      const teamCountEl = document.getElementById('teamCount');
      const totalEarningsEl = document.getElementById('totalEarnings');
      
      // ä½¿ç”¨newTasksæ•°ç»„çš„å®é™…å®ŒæˆçŠ¶æ€ï¼Œç¡®ä¿ä¸å†…å®¹æ æ˜¾ç¤ºä¸€è‡´
      const actualCompletedTasks = newTasks.filter(t => t.done).length;
      if (taskProgressEl) taskProgressEl.innerText = actualCompletedTasks;
      if (teamCountEl) teamCountEl.innerText = teamMembers;
      if (totalEarningsEl) totalEarningsEl.innerText = totalEarnings.toFixed(2);
    }

    function updateCountdown(wsData = null) {
      const total = 168 * 3600 * 1000; // æ€»æ—¶é•¿ï¼š168å°æ—¶
      let remaining;
      
      if (wsData && wsData.remaining !== undefined) {
        // ä½¿ç”¨WebSocketæ¨é€çš„å€’è®¡æ—¶æ•°æ®
        remaining = wsData.remaining;
      } else {
        // ä½¿ç”¨æœ¬åœ°è®¡ç®—çš„å€’è®¡æ—¶
        const now = Date.now();
        const elapsed = now - countdownStart;
        remaining = total - elapsed;
        if (remaining < 0) remaining = 0;
      }
      
      // è®¡ç®—æ€»å°æ—¶æ•°ã€åˆ†é’Ÿæ•°ã€ç§’æ•°
      const totalHours = Math.floor(remaining / (3600 * 1000));
      const mins = Math.floor((remaining % 3600000) / 60000);
      const secs = Math.floor((remaining % 60000) / 1000);
      
      // æ ¼å¼åŒ–ä¸º XX:XX:XX æ ¼å¼ï¼ˆå°æ—¶ä¸è¡¥å‰å¯¼0ï¼‰
      const timeStr = `${totalHours}:${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
      
      // æ›´æ–°å€’è®¡æ—¶æ˜¾ç¤º
      const countdownEl = document.getElementById('countdown');
      if (countdownEl) countdownEl.innerText = timeStr;
      
      // æ›´æ–°è¿›åº¦æ¡ï¼ˆå€’è®¡æ—¶è¿›åº¦ï¼šä»æ»¡é€æ¸å˜ç©ºï¼‰
      const progressEl = document.getElementById('countdownProgress');
      const remainingDaysEl = document.getElementById('remainingDays');
      if (progressEl && remainingDaysEl) {
        // å€’è®¡æ—¶è¿›åº¦æ¡ï¼šæ˜¾ç¤ºå‰©ä½™æ—¶é—´è¿›åº¦ï¼ˆä»100%é€’å‡åˆ°0%ï¼Œä»æ»¡é€æ¸å˜ç©ºï¼‰
        const remainingProgress = (remaining / total);
        const remainingPercent = remainingProgress * 100;
        progressEl.style.width = `${remainingPercent}%`;
        
        // è®¡ç®—å‰©ä½™å¤©æ•°ã€å°æ—¶æ•°å’Œåˆ†é’Ÿæ•°
        const remainingDays = Math.floor(remaining / (24 * 3600 * 1000));
        const remainingHours = Math.floor((remaining % (24 * 3600 * 1000)) / (3600 * 1000));
        const remainingMinutes = Math.floor((remaining % (3600 * 1000)) / (60 * 1000));
        
        // æ ¹æ®å‰©ä½™æ—¶é—´æ˜¾ç¤ºä¸åŒæ ¼å¼
        if (remainingDays > 0) {
          remainingDaysEl.textContent = `å‰©ä½™${remainingDays}å¤©${remainingHours}å°æ—¶${remainingMinutes}åˆ†`;
        } else {
          remainingDaysEl.textContent = `ä»…å‰©ä½™${remainingHours}å°æ—¶${remainingMinutes}åˆ†`;
        }
      }
      
      // æ›´æ–°çŠ¶æ€æç¤ºå’ŒåŠ¨ç”»æ•ˆæœ
      const statusEl = document.getElementById('countdownStatus');
      const containerEl = document.querySelector('.countdown-container');
      
      if (statusEl && containerEl) {
        const hoursLeft = remaining / (3600 * 1000);
        
        if (hoursLeft <= 24) {
          // æœ€å24å°æ—¶ - ç´§æ€¥çŠ¶æ€
          statusEl.innerHTML = 'ğŸš¨ æœ€å24å°æ—¶ï¼ç«‹å³å®Œæˆä»»åŠ¡è·å¾—å¥–åŠ±';
          statusEl.style.background = 'rgba(255, 69, 58, 0.2)';
          statusEl.style.borderColor = 'rgba(255, 69, 58, 0.4)';
          statusEl.style.color = '#ff453a';
          containerEl.style.animation = 'urgentPulse 1.5s ease-in-out infinite';
          
          // è¿›åº¦ç¯å˜çº¢è‰²
          if (progressEl) {
            progressEl.style.stroke = '#ff453a';
            progressEl.style.filter = 'drop-shadow(0 0 8px #ff453a)';
          }
        } else if (hoursLeft <= 72) {
          // æœ€å72å°æ—¶ - è­¦å‘ŠçŠ¶æ€
          statusEl.innerHTML = 'âš ï¸ æ—¶é—´ç´§è¿«ï¼ŒæŠ“ç´§å®Œæˆä»»åŠ¡è·å¾—æ”¶ç›Š';
          statusEl.style.background = 'rgba(255, 193, 7, 0.2)';
          statusEl.style.borderColor = 'rgba(255, 193, 7, 0.4)';
          statusEl.style.color = '#ffc107';
          containerEl.style.animation = 'countdownPulse 2s ease-in-out infinite';
          
          // è¿›åº¦ç¯å˜æ©™è‰²
          if (progressEl) {
            progressEl.style.stroke = '#ffc107';
            progressEl.style.filter = 'drop-shadow(0 0 8px #ffc107)';
          }
        } else {
          // æ­£å¸¸çŠ¶æ€ - ä¸æ˜¾ç¤ºä»»ä½•æç¤º
          if (statusEl) {
            statusEl.style.display = 'none';
          }
          containerEl.style.animation = 'countdownPulse 3s ease-in-out infinite';
          
          // è¿›åº¦ç¯ä¿æŒè“è‰²
          if (progressEl) {
            progressEl.style.stroke = 'var(--accent-color)';
            progressEl.style.filter = 'drop-shadow(0 0 8px var(--accent-color))';
          }
        }
      }
      
      // æ›´æ–°é‚€è¯·é“¾æ¥æ˜¾ç¤º
      updateInviteDisplay();
      
      // å½“å€’è®¡æ—¶ç»“æŸï¼Œè‡ªåŠ¨è¿›å…¥çŠ¶æ€3
      if (remaining === 0 && currentState === 2) {
        currentState = 3;
        countdownStart = null;
        renderState();
      }
    }
    
    // æ›´æ–°é‚€è¯·é“¾æ¥æ˜¾ç¤º
    function updateInviteDisplay() {
      // æ›´æ–°é‚€è¯·ç å’Œé‚€è¯·é“¾æ¥å†…å®¹
      const userInviteCode = localStorage.getItem('userInviteCode') || '';
      
      // æ›´æ–°ä¸“å±é‚€è¯·ç æ˜¾ç¤º
      const inviteCodeEl = document.getElementById('myInviteCode');
      if (inviteCodeEl) {
        inviteCodeEl.textContent = userInviteCode;
      }
      
      // æ›´æ–°é‚€è¯·é“¾æ¥
      const inviteLinkEl = document.getElementById('inviteLink');
      if (inviteLinkEl) {
        inviteLinkEl.value = `https://gold7.com/login.html?invite=${userInviteCode}`;
      }
    }

    // æ˜¾ç¤ºé‚€è¯·é“¾æ¥å¼¹çª—
    function showInviteLink() {
      const userInviteCode = localStorage.getItem('userInviteCode') || 'ABC123';
      const inviteLink = `https://gold7.com/login.html?invite=${userInviteCode}`;
      
      // è®¡ç®—é‚€è¯·é“¾æ¥å‰©ä½™æœ‰æ•ˆæœŸ
      const detailedTime = getDetailedCountdown();
      
      const message = `ğŸ”— æ‚¨çš„ä¸“å±é‚€è¯·é“¾æ¥ï¼š\n${inviteLink}\n\nğŸ’ é‚€è¯·ç ï¼š${userInviteCode}\n\nâ° æœ‰æ•ˆæœŸå‰©ä½™ï¼š${detailedTime}\n\nğŸ’¡ åˆ†äº«æ­¤é“¾æ¥é‚€è¯·å¥½å‹æ³¨å†Œï¼Œè·å¾—ä¸°åšå¥–åŠ±ï¼`;
      
      const buttons = [
        {
          text: 'å¤åˆ¶é“¾æ¥',
          action: () => {
            if (navigator.clipboard) {
              navigator.clipboard.writeText(inviteLink).then(() => {
                showDialog('é‚€è¯·é“¾æ¥å·²å¤åˆ¶', `æœ‰æ•ˆæœŸå‰©ä½™ ${detailedTime}`);
              }).catch(() => {
                fallbackCopy(inviteLink);
              });
            } else {
              fallbackCopy(inviteLink);
            }
          }
        },
        {
          text: 'å¤åˆ¶é‚€è¯·ç ',
          action: () => {
            if (navigator.clipboard) {
              navigator.clipboard.writeText(userInviteCode).then(() => {
                showDialog('é‚€è¯·ç å·²å¤åˆ¶', `ä¸“å±é‚€è¯·ç : ${userInviteCode}\næœ‰æ•ˆæœŸå‰©ä½™ ${detailedTime}`);
              }).catch(() => {
                fallbackCopyCode(userInviteCode);
              });
            } else {
              fallbackCopyCode(userInviteCode);
            }
          }
        },
        {
          text: 'å…³é—­',
          style: 'secondary',
          action: 'close'
        }
      ];
      
      showDialog('é‚€è¯·é“¾æ¥', message, buttons);
    }

    // å¼€å‘æµ‹è¯•å¾ªç¯çŠ¶æ€
    function cycleState() {
      currentState++;
      if (currentState > 3) currentState = 1;
      countdownStart = null;
      renderState();
    }

    // åˆ‡æ¢åˆ°æŒ‡å®šçŠ¶æ€
    function switchToState(state) {
      if (state === '') return; // å¦‚æœé€‰æ‹©äº†ç©ºé€‰é¡¹ï¼Œä¸æ‰§è¡Œä»»ä½•æ“ä½œ
      
      currentState = parseInt(state);
      countdownStart = null;
      renderState();
      
      // é‡ç½®ä¸‹æ‹‰èœå•
      document.getElementById('stateSelect').value = '';
      
      // è‡ªåŠ¨å…³é—­è®¾ç½®é¢æ¿
      closeSettings();
    }

    // æ¿€æ´»è´¦å·/é¦–æ¬¡å…¥é‡‘ - é›†æˆçœŸå®Tatumæ”¯ä»˜æµç¨‹
    async function activateAccount() {
      try {
        // æ˜¾ç¤ºåŠ è½½æç¤º
        showDialog('æ­£åœ¨å¤„ç†', 'æ­£åœ¨ç”Ÿæˆæ”¯ä»˜ä¿¡æ¯ï¼Œè¯·ç¨å€™...', null, 'loading');
        
        // è°ƒç”¨çœŸå®çš„æ¿€æ´»API
        const response = await apiRequest('/activation/activate', {
          method: 'POST'
        });
        
        if (response.success && response.data) {
          const activationData = response.data;
          
          // å…³é—­åŠ è½½å¯¹è¯æ¡†
          closeDialog();
          
          // æ˜¾ç¤ºæ”¯ä»˜ä¿¡æ¯ç•Œé¢
          showPaymentDialog(activationData);
          
        } else {
          throw new Error(response.message || 'æ¿€æ´»è¯·æ±‚å¤±è´¥');
        }
        
      } catch (error) {
        console.error('æ¿€æ´»APIè°ƒç”¨å¤±è´¥:', error);
        
        // å…³é—­åŠ è½½å¯¹è¯æ¡†
        closeDialog();
        
        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ï¼Œä¸å†è‡ªåŠ¨è·³è½¬åˆ°çŠ¶æ€2
        showDialog('æ¿€æ´»å¤±è´¥', 'æ— æ³•è¿æ¥åˆ°æ”¯ä»˜æœåŠ¡å™¨ï¼Œè¯·ç¨åé‡è¯•ã€‚å¦‚æœé—®é¢˜æŒç»­å­˜åœ¨ï¼Œè¯·è”ç³»å®¢æœã€‚', null, 'error');
      }
    }

    // å†æ¬¡å…¥é‡‘ï¼ˆå¤è´­ï¼‰
    async function repurchase() {
      // ä½¿ç”¨å›è°ƒæœºåˆ¶ï¼Œç¡®ä¿ç”¨æˆ·ç¡®è®¤åæ‰æ‰§è¡ŒçŠ¶æ€åˆ‡æ¢
      showDialog('å†æ¬¡æ¿€æ´»', 'è¯·å‘ç³»ç»Ÿæä¾›çš„æ–°USDTåœ°å€æ”¯ä»˜100 USDTä»¥é‡æ–°æ¿€æ´»ã€‚é‡æ–°æ¿€æ´»åå°†å¼€å¯æ–°çš„168å°æ—¶æŒ‘æˆ˜æœŸã€‚', null, 'normal', async () => {
        try {
          // å°è¯•è°ƒç”¨åç«¯API
          const response = await StateAPI.repurchase();
          
          if (response.success) {
            // ä½¿ç”¨åç«¯è¿”å›çš„æ•°æ®æ›´æ–°çŠ¶æ€
            currentState = response.data.status;
            countdownStart = new Date(response.data.countdown_end_time).getTime() - (168 * 60 * 60 * 1000);
            inviteStart = countdownStart;
            
            // è®°å½•äº¤æ˜“
            transactions.push({ 
              type: 'å¤è´­ç¼´è´¹', 
              amount: -100, 
              fee: 0, 
              net: -100, 
              time: new Date().toISOString(),
              desc: 'å¤è´­æ¿€æ´»ç¼´è´¹' 
            });
            
            // è®¾ç½®æ¿€æ´»æ—¶é—´ä¾›quiz.htmlä½¿ç”¨
            localStorage.setItem('activationTime', new Date().toISOString());
            
            saveState();
            renderState();
            
            showDialog('å¤è´­æˆåŠŸ', 'å¤è´­æ¿€æ´»æˆåŠŸï¼æ–°çš„168å°æ—¶æŒ‘æˆ˜æœŸå·²å¼€å§‹ã€‚');
          }
        } catch (error) {
          console.warn('åç«¯APIè°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ¨¡å¼:', error);
          
          // å›é€€åˆ°æœ¬åœ°æ¨¡å¼ - ç§»é™¤å»¶è¿Ÿï¼Œç«‹å³æ‰§è¡Œ
          // å¤è´­è®°å½•äº¤æ˜“
          transactions.push({ 
            type: 'å¤è´­ç¼´è´¹', 
            amount: -100, 
            fee: 0, 
            net: -100, 
            time: new Date().toISOString(),
            desc: 'å¤è´­æ¿€æ´»ç¼´è´¹' 
          });
          
          // æ›´æ–°çŠ¶æ€
          currentState = 2;
          countdownStart = Date.now();
          inviteStart = countdownStart;
          
          // è®¾ç½®æ¿€æ´»æ—¶é—´ä¾›quiz.htmlä½¿ç”¨
          localStorage.setItem('activationTime', new Date().toISOString());
          
          saveState();
          renderState();
          
          showDialog('å¤è´­æˆåŠŸ', 'å¤è´­æ¿€æ´»æˆåŠŸï¼æ–°çš„168å°æ—¶æŒ‘æˆ˜æœŸå·²å¼€å§‹ã€‚');
        }
      });
    }

    // ä»»åŠ¡æŒ‰é’® - å®ç°æŒ‰åºè§¦å‘é€»è¾‘
    function openTasks() {
      // æ‰¾åˆ°ä¸‹ä¸€ä¸ªæœªå®Œæˆçš„ä»»åŠ¡ï¼ˆæŒ‰IDé¡ºåºï¼‰
      const nextTask = newTasks.find(t => !t.done && t.id === completedNewbieTasks + 1);
      
      if (nextTask) {
        // æ˜¾ç¤ºä»»åŠ¡è¯¦æƒ…
        showDialog('å½“å‰ä»»åŠ¡', `ä»»åŠ¡${nextTask.id}ï¼š${nextTask.title}\n\n${nextTask.desc}\n\nå®Œæˆå¥–åŠ±ï¼š${nextTask.reward} USDT\n\nç‚¹å‡»ç¡®å®šæ ‡è®°å®Œæˆ`, [
          { text: 'å®Œæˆä»»åŠ¡', action: () => completeNewbieTask(nextTask) },
          { text: 'å–æ¶ˆ', action: 'close' }
        ]);
      } else if (completedNewbieTasks >= 3) {
        // æ‰€æœ‰æ–°æ‰‹ä»»åŠ¡å·²å®Œæˆï¼Œæ£€æŸ¥ç­”é¢˜ä»»åŠ¡çŠ¶æ€
        const quizCorrect = parseInt(localStorage.getItem('quizCorrect')) || 0;
        const quizCompleted = quizCorrect >= 20;
        
        if (!quizCompleted) {
          showDialog('ç­”é¢˜ä»»åŠ¡', 'æ‰€æœ‰æ–°æ‰‹ä»»åŠ¡å·²å®Œæˆï¼\n\nç­”é¢˜ä»»åŠ¡å¯ç”¨ï¼Œå®Œæˆ20é¢˜å¯é™ä½æç°æ‰‹ç»­è´¹ã€‚\n\nå½“å‰æ‰‹ç»­è´¹ï¼š' + ((withdrawFeeRate * 100).toFixed(1)) + '%', [
            { text: 'å¼€å§‹ç­”é¢˜', action: () => { saveState(); window.location.href = 'quiz.html'; } },
            { text: 'ç¨åå†è¯´', action: 'close' }
          ]);
        } else {
          // æ£€æŸ¥å¤§ç¥ä»»åŠ¡æ˜¯å¦è§£é”
          const godTasksUnlocked = completedNewbieTasks >= 3 && quizCompleted;
          if (godTasksUnlocked) {
            const nextGodTask = godTasks.find(t => !t.done);
            if (nextGodTask) {
              showDialog('å¤§ç¥ä»»åŠ¡', 'æ–°æ‰‹ä»»åŠ¡å’Œç­”é¢˜ä»»åŠ¡å·²å®Œæˆï¼\n\nå¤§ç¥ä»»åŠ¡å·²è§£é”ï¼Œå¯è·å¾—æ›´é«˜å¥–åŠ±ã€‚', [
                { text: 'æŸ¥çœ‹å¤§ç¥ä»»åŠ¡', action: () => openGodTasks() },
                { text: 'å…³é—­', action: 'close' }
              ]);
            } else {
              showDialog('ä»»åŠ¡å®Œæˆ', 'æ­å–œï¼æ‰€æœ‰ä»»åŠ¡å·²å®Œæˆï¼\n\nç»§ç»­é‚€è¯·å¥½å‹è·å¾—æ›´å¤šå¥–åŠ±ã€‚');
            }
          } else {
            showDialog('æ–°æ‰‹ä»»åŠ¡', 'æ‰€æœ‰æ–°æ‰‹ä»»åŠ¡å·²å®Œæˆï¼\n\nç­”é¢˜ä»»åŠ¡ä¹Ÿå·²å®Œæˆï¼Œæ‰‹ç»­è´¹å·²é™è‡³æœ€ä½ã€‚');
          }
        }
      } else {
        showDialog('ä»»åŠ¡ç³»ç»Ÿ', 'è¯·æŒ‰é¡ºåºå®Œæˆä»»åŠ¡ã€‚å½“å‰å¯å®Œæˆä»»åŠ¡ï¼š' + (completedNewbieTasks + 1));
      }
    }

    /**
     * å®Œæˆæ–°æ‰‹ä»»åŠ¡
     */
    function completeNewbieTask(task) {
      // æ¨¡æ‹Ÿä»»åŠ¡å®Œæˆ
      setTimeout(() => {
        task.done = true;
        // åŒæ­¥completedNewbieTaskså˜é‡ï¼Œç¡®ä¿ä¸newTasksæ•°ç»„çŠ¶æ€ä¸€è‡´
        completedNewbieTasks = newTasks.filter(t => t.done).length;
        
        // ä»»åŠ¡å¥–åŠ±
        walletBalance += task.reward;
        totalEarnings += task.reward;
        
        // è®°å½•äº¤æ˜“
        transactions.push({ 
          type: 'ä»»åŠ¡å¥–åŠ±', 
          amount: task.reward, 
          fee: 0, 
          net: task.reward, 
          time: new Date().toISOString(),
          desc: `å®Œæˆ${task.title}` 
        });
        
        saveState();
        renderState();
        
        // æ˜¾ç¤ºä»»åŠ¡å®Œæˆå¼¹çª—
        showDialog('ä»»åŠ¡å®Œæˆ', `æ­å–œå®Œæˆä»»åŠ¡ï¼š${task.title}ï¼\nå¥–åŠ±ï¼š${task.reward} USDT\nå½“å‰ä½™é¢ï¼š${walletBalance.toFixed(2)} USDT`);
        
        // æ£€æŸ¥æ˜¯å¦è§£é”ç­”é¢˜ä»»åŠ¡
        if (completedNewbieTasks >= 1 && !quizCompleted) {
          setTimeout(() => {
            showDialog('è§£é”ç­”é¢˜ä»»åŠ¡', 'æ­å–œï¼è§£é”ç­”é¢˜ä»»åŠ¡ï¼Œå®Œæˆå¯é™ä½æç°æ‰‹ç»­è´¹ï¼\n\nå½“å‰æ‰‹ç»­è´¹ï¼š' + ((withdrawFeeRate * 100).toFixed(1)) + '%', [
              { text: 'å¼€å§‹ç­”é¢˜', action: () => { saveState(); window.location.href = 'quiz.html'; } },
              { text: 'ç¨åå†è¯´', action: 'close' }
            ]);
          }, 2000);
        }
        
        // æ£€æŸ¥æ˜¯å¦è§£é”å¤§ç¥ä»»åŠ¡
        if (completedNewbieTasks >= 3) {
          const quizCorrect = parseInt(localStorage.getItem('quizCorrect')) || 0;
          const quizCompleted = quizCorrect >= 20;
          
          if (quizCompleted) {
            setTimeout(() => {
              showDialog('è§£é”å¤§ç¥ä»»åŠ¡', 'æ­å–œï¼å¤§ç¥ä»»åŠ¡å·²è§£é”ï¼\n\nå®Œæˆå¤§ç¥ä»»åŠ¡å¯è·å¾—æ›´é«˜å¥–åŠ±ã€‚', [
                { text: 'æŸ¥çœ‹å¤§ç¥ä»»åŠ¡', action: () => openGodTasks() },
                { text: 'ç¨åå†è¯´', action: 'close' }
              ]);
            }, 2000);
          }
        }
      }, 1500);
    }
    

    
    // å¤åˆ¶é‚€è¯·é“¾æ¥
    function copyInvite() {
      const userInviteCode = localStorage.getItem('userInviteCode') || '';
      const link = `https://gold7.com/invite?code=${userInviteCode}`;
      navigator.clipboard.writeText(link).then(() => {
        showDialog('é‚€è¯·é“¾æ¥å·²å¤åˆ¶', `æœ‰æ•ˆæœŸå‰©ä½™ ${document.getElementById('inviteLeft').innerText}ã€‚`);
      });
    }
    
    // æ–°çš„å¤åˆ¶é‚€è¯·é“¾æ¥å‡½æ•°
    function copyInviteLink() {
      const linkInput = document.getElementById('inviteLink');
      const link = linkInput.value;
      
      if (navigator.clipboard) {
        navigator.clipboard.writeText(link).then(() => {
          const detailedTime = getDetailedCountdown();
          showDialog('é‚€è¯·é“¾æ¥å·²å¤åˆ¶', `æœ‰æ•ˆæœŸå‰©ä½™ ${detailedTime}`);
        }).catch(() => {
          fallbackCopy(link);
        });
      } else {
        fallbackCopy(link);
      }
    }
    
    // å¤åˆ¶ä¸“å±é‚€è¯·ç å‡½æ•°
    function copyInviteCode() {
      const codeEl = document.getElementById('myInviteCode');
      const code = codeEl.textContent;
      
      if (navigator.clipboard) {
        navigator.clipboard.writeText(code).then(() => {
          const detailedTime = getDetailedCountdown();
          showDialog('é‚€è¯·ç å·²å¤åˆ¶', `ä¸“å±é‚€è¯·ç : ${code}\næœ‰æ•ˆæœŸå‰©ä½™ ${detailedTime}`);
        }).catch(() => {
          fallbackCopyCode(code);
        });
      } else {
        fallbackCopyCode(code);
      }
    }
    
    // è·å–è¯¦ç»†å€’è®¡æ—¶æ—¶é—´
    function getDetailedCountdown() {
      const total = 168 * 3600 * 1000;
      const now = Date.now();
      const inviteRemainingMs = Math.max(0, (inviteStart + total) - now);
      const days = Math.floor(inviteRemainingMs / (24 * 3600000));
      const hrs = Math.floor((inviteRemainingMs % (24 * 3600000)) / 3600000);
      const mins = Math.floor((inviteRemainingMs % 3600000) / 60000);
      
      let result = '';
      if (days > 0) result += `${days}å¤©`;
      if (hrs > 0) result += `${hrs}å°æ—¶`;
      if (mins > 0) result += `${mins}åˆ†é’Ÿ`;
      if (result === '') result = 'ä¸è¶³1åˆ†é’Ÿ';
      
      return result;
    }
    
    // é™çº§å¤åˆ¶æ–¹æ¡ˆ
    function fallbackCopy(text) {
      const textArea = document.createElement('textarea');
      textArea.value = text;
      document.body.appendChild(textArea);
      textArea.select();
      try {
        document.execCommand('copy');
        const detailedTime = getDetailedCountdown();
        showDialog('é‚€è¯·é“¾æ¥å·²å¤åˆ¶', `æœ‰æ•ˆæœŸå‰©ä½™ ${detailedTime}`);
      } catch (err) {
        showDialog('å¤åˆ¶å¤±è´¥', 'è¯·æ‰‹åŠ¨å¤åˆ¶é“¾æ¥');
      }
      document.body.removeChild(textArea);
    }
    
    // é™çº§å¤åˆ¶é‚€è¯·ç æ–¹æ¡ˆ
    function fallbackCopyCode(code) {
      const textArea = document.createElement('textarea');
      textArea.value = code;
      document.body.appendChild(textArea);
      textArea.select();
      try {
        document.execCommand('copy');
        const detailedTime = getDetailedCountdown();
        showDialog('é‚€è¯·ç å·²å¤åˆ¶', `ä¸“å±é‚€è¯·ç : ${code}\næœ‰æ•ˆæœŸå‰©ä½™ ${detailedTime}`);
      } catch (err) {
        showDialog('å¤åˆ¶å¤±è´¥', 'è¯·æ‰‹åŠ¨å¤åˆ¶é‚€è¯·ç ');
      }
      document.body.removeChild(textArea);
    }
    /**
     * æŠ¢çº¢åŒ…åŠŸèƒ½
     * æ£€æŸ¥æ—¶é—´çª—å£ã€ç”¨æˆ·èµ„æ ¼ï¼Œå¹¶å¤„ç†æŠ¢çº¢åŒ…é€»è¾‘
     */
    function grabRedPacket() {
      // æ£€æŸ¥èµ„æ ¼ï¼šä»…çŠ¶æ€2æœ‰çº¢åŒ…æŒ‰é’®
      if (currentState !== 2) {
        showDialog('æ— æŠ¢çº¢åŒ…èµ„æ ¼', 'åªæœ‰åœ¨æ¿€æ´»çŠ¶æ€æ‰å¯ä»¥æŠ¢çº¢åŒ…ã€‚');
        return;
      }
      
      // ä¿å­˜å½“å‰çŠ¶æ€åˆ°localStorage
      saveState();
      
      // è·³è½¬åˆ°çº¢åŒ…é¡µé¢
      window.location.href = 'redpacket.html';
    }
    
    /**
     * è·å–å½“å‰çº¢åŒ…æ—¶é—´çª—å£çŠ¶æ€
     */
    function getCurrentRedPacketTimeWindow() {
      const now = new Date();
      const currentHour = now.getHours();
      const currentMinute = now.getMinutes();
      const currentSecond = now.getSeconds();
      
      // çº¢åŒ…æ—¶é—´ï¼š9:00, 12:00, 20:00ï¼Œæ¯æ¬¡æŒç»­77ç§’
      const redPacketTimes = [
        { hour: 9, minute: 0 },
        { hour: 12, minute: 0 },
        { hour: 20, minute: 0 }
      ];
      
      for (const time of redPacketTimes) {
        if (currentHour === time.hour && currentMinute === time.minute && currentSecond < 77) {
          return {
            isActive: true,
            remainingSeconds: 77 - currentSecond,
            nextWindow: null
          };
        }
      }
      
      return {
        isActive: false,
        remainingSeconds: 0,
        nextWindow: getNextRedPacketTime()
      };
    }
    
    /**
     * è·å–ä¸‹ä¸€ä¸ªçº¢åŒ…æ—¶é—´
     */
    function getNextRedPacketTime() {
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      
      const redPacketTimes = [
        new Date(today.getTime() + 9 * 60 * 60 * 1000),   // 9:00
        new Date(today.getTime() + 12 * 60 * 60 * 1000),  // 12:00
        new Date(today.getTime() + 20 * 60 * 60 * 1000)   // 20:00
      ];
      
      // æ‰¾åˆ°ä¸‹ä¸€ä¸ªæ—¶é—´
      for (const time of redPacketTimes) {
        if (now < time) {
          return time.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
        }
      }
      
      // å¦‚æœä»Šå¤©çš„æ—¶é—´éƒ½è¿‡äº†ï¼Œè¿”å›æ˜å¤©çš„ç¬¬ä¸€ä¸ªæ—¶é—´
      const tomorrow = new Date(today.getTime() + 24 * 60 * 60 * 1000);
      const tomorrowFirst = new Date(tomorrow.getTime() + 9 * 60 * 60 * 1000);
      return `æ˜å¤© ${tomorrowFirst.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })}`;
    }
    
    /**
     * æ‰§è¡ŒæŠ¢çº¢åŒ…æ“ä½œ
     */
    function performRedPacketGrab() {
      // æ˜¾ç¤ºæŠ¢çº¢åŒ…åŠ¨ç”»
      showDialog('æŠ¢çº¢åŒ…ä¸­...', 'æ­£åœ¨ä¸ºæ‚¨æŠ¢å¤ºçº¢åŒ…ï¼Œè¯·ç¨å€™...', null, 'redpacket');
      
      // æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ
      setTimeout(() => {
        // éšæœºç”Ÿæˆçº¢åŒ…é‡‘é¢ï¼ˆ1-100 USDTï¼‰
        const amount = Math.floor(Math.random() * 100) + 1;
        const isSuccess = Math.random() > 0.3; // 70%æˆåŠŸç‡
        
        if (isSuccess) {
          // æŠ¢çº¢åŒ…æˆåŠŸ
          walletBalance += amount;
          
          // è®°å½•çº¢åŒ…æ”¶å…¥
          const record = {
            id: Date.now(),
            amount: amount,
            timestamp: new Date().toISOString(),
            type: 'grab'
          };
          
          redPacketRecords.unshift(record);
          
          // æ·»åŠ äº¤æ˜“è®°å½•
          transactions.unshift({
            type: 'income',
            amount: amount,
            description: 'æŠ¢çº¢åŒ…æ”¶å…¥',
            timestamp: new Date().toISOString()
          });
          
          // ç”Ÿæˆå›¢é˜Ÿæ¶ˆæ¯
          generateTeamMessage('redpacket_success', {
            amount: amount
          });
          
          // ä¿å­˜çŠ¶æ€
          saveState();
          renderState();
          
          // æ˜¾ç¤ºæˆåŠŸæç¤º
          showDialog('æŠ¢çº¢åŒ…æˆåŠŸï¼', `æ­å–œæ‚¨æŠ¢åˆ° ${amount} USDTï¼`, [{ text: 'å¤ªæ£’äº†', action: 'close' }], 'success');
          
        } else {
          // æŠ¢çº¢åŒ…å¤±è´¥
          showDialog('æ‰‹æ…¢äº†', 'çº¢åŒ…è¢«æŠ¢å®Œäº†ï¼Œä¸‹æ¬¡è¦æ›´å¿«å“¦ï¼', [{ text: 'ä¸‹æ¬¡ä¸€å®š', action: 'close' }], 'info');
        }
      }, 2000);
    }
    
    // çº¢åŒ…è®°å½•æ•°ç»„
    let redPacketRecords = [];
    
    /**
     * åˆå§‹åŒ–çº¢åŒ…è®°å½•
     */
    function initRedPacketRecords() {
      const saved = localStorage.getItem('redPacketRecords');
      if (saved) {
        redPacketRecords = JSON.parse(saved);
      }
    }
    
    /**
     * ä¿å­˜çº¢åŒ…è®°å½•
     */
    function saveRedPacketRecords() {
      localStorage.setItem('redPacketRecords', JSON.stringify(redPacketRecords));
    }
    /**
     * æˆ‘çš„å›¢é˜ŸåŠŸèƒ½
     * æ˜¾ç¤ºå›¢é˜Ÿç»“æ„ã€æˆå‘˜ä¿¡æ¯å’Œåˆ†ä½£æ•°æ®
     */
    function showTeam() {
      // ä¿å­˜å½“å‰çŠ¶æ€åˆ°localStorage
      saveState();
      
      // è·³è½¬åˆ°å›¢é˜Ÿé¡µé¢
      window.location.href = 'team.html';
    }
    
    /**
     * è·å–å›¢é˜Ÿæ•°æ®
     */
    function getTeamData() {
      // ä»localStorageè·å–æˆ–ç”Ÿæˆå›¢é˜Ÿæ•°æ®
      let teamData = JSON.parse(localStorage.getItem('teamData') || '{}');
      
      if (!teamData.inviteCode) {
        teamData = {
          totalMembers: teamMembers || 0,
          directMembers: Math.floor((teamMembers || 0) * 0.3), // 30%ä¸ºç›´æ¨
          totalEarnings: totalEarnings || 0,
          inviteCode: generateInviteCode(),
          inviteLink: '',
          levels: generateTeamLevels()
        };
        
        teamData.inviteLink = `https://gold7.com/login.html?invite=${teamData.inviteCode}`;
        localStorage.setItem('teamData', JSON.stringify(teamData));
      }
      
      return teamData;
    }
    
    /**
     * ç”Ÿæˆé‚€è¯·ç  - ä»åç«¯APIè·å–
     */
    async function generateInviteCode() {
      try {
        const response = await apiRequest('/user/invite-code');
        if (response.success && response.data.inviteCode) {
          return response.data.inviteCode;
        }
      } catch (error) {
        console.error('è·å–é‚€è¯·ç å¤±è´¥:', error);
      }
      
      // å¦‚æœAPIè°ƒç”¨å¤±è´¥ï¼Œç”ŸæˆåŸºäºæ—¶é—´æˆ³çš„å¤‡ç”¨é‚€è¯·ç 
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      const timestamp = Date.now().toString();
      let result = '';
      for (let i = 0; i < 6; i++) {
        const index = parseInt(timestamp.charAt(i % timestamp.length)) % chars.length;
        result += chars.charAt(index);
      }
      return result + timestamp.slice(-2);
    }
    
    /**
     * ç”Ÿæˆå›¢é˜Ÿå±‚çº§æ•°æ®
     */
    function generateTeamLevels() {
      const levels = [];
      const totalMembers = teamMembers || 0;
      
      if (totalMembers === 0) return levels;
      
      // æŒ‰å±‚çº§åˆ†é…æˆå‘˜æ•°é‡
      const levelNames = ['ç›´æ¨', 'äºŒçº§', 'ä¸‰çº§', 'å››çº§', 'äº”çº§', 'å…­çº§', 'ä¸ƒçº§'];
      const levelRatios = [0.3, 0.25, 0.2, 0.15, 0.05, 0.03, 0.02]; // å„å±‚çº§å æ¯”
      
      for (let i = 0; i < 7; i++) {
        const memberCount = Math.floor(totalMembers * levelRatios[i]);
        if (memberCount > 0) {
          levels.push({
            level: i + 1,
            name: levelNames[i],
            count: memberCount,
            commission: getCommissionRate(i + 1),
            earnings: (memberCount * 10 * getCommissionRate(i + 1)).toFixed(2)
          });
        }
      }
      
      return levels;
    }
    
    /**
     * è·å–å„å±‚çº§åˆ†ä½£æ¯”ä¾‹
     */
    function getCommissionRate(level) {
      const rates = [0.15, 0.10, 0.08, 0.05, 0.03, 0.02, 0.01]; // 15%, 10%, 8%, 5%, 3%, 2%, 1%
      return rates[level - 1] || 0;
    }
    
    /**
     * ç”Ÿæˆå›¢é˜Ÿå±‚çº§HTML
     */
    function generateTeamLevelsHTML(levels) {
      if (!levels || levels.length === 0) {
        return '<div class="no-team">æš‚æ— å›¢é˜Ÿæˆå‘˜</div>';
      }
      
      return levels.map(level => `
        <div class="level-item">
          <div class="level-header">
            <span class="level-name">${level.name}</span>
            <span class="level-count">${level.count}äºº</span>
            <span class="level-commission">10 USDT</span>
            <span class="level-earnings">${level.earnings} USDT</span>
          </div>
        </div>
      `).join('');
    }
    
    /**
     * å¤åˆ¶å›¢é˜Ÿé‚€è¯·é“¾æ¥
     */
    function copyTeamInviteLink() {
      const linkInput = document.getElementById('teamInviteLink');
      if (linkInput) {
        const link = linkInput.value;
        if (navigator.clipboard) {
          navigator.clipboard.writeText(link).then(() => {
            showDialog('å¤åˆ¶æˆåŠŸ', 'é‚€è¯·é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', [{ text: 'ç¡®å®š', action: 'close' }], 'success');
          }).catch(() => {
            fallbackCopyText(link, 'é‚€è¯·é“¾æ¥');
          });
        } else {
          fallbackCopyText(link, 'é‚€è¯·é“¾æ¥');
        }
      }
    }
    
    /**
     * å¤åˆ¶å›¢é˜Ÿé‚€è¯·ç 
     */
    function copyTeamInviteCode() {
      const codeEl = document.getElementById('teamInviteCode');
      if (codeEl) {
        const code = codeEl.textContent;
        if (navigator.clipboard) {
          navigator.clipboard.writeText(code).then(() => {
            showDialog('å¤åˆ¶æˆåŠŸ', `é‚€è¯·ç  ${code} å·²å¤åˆ¶åˆ°å‰ªè´´æ¿`, [{ text: 'ç¡®å®š', action: 'close' }], 'success');
          }).catch(() => {
            fallbackCopyText(code, 'é‚€è¯·ç ');
          });
        } else {
          fallbackCopyText(code, 'é‚€è¯·ç ');
        }
      }
    }
    
    /**
     * é™çº§å¤åˆ¶æ–¹æ¡ˆ
     */
    function fallbackCopyText(text, type) {
      const textArea = document.createElement('textarea');
      textArea.value = text;
      document.body.appendChild(textArea);
      textArea.select();
      try {
        document.execCommand('copy');
        showDialog('å¤åˆ¶æˆåŠŸ', `${type}å·²å¤åˆ¶åˆ°å‰ªè´´æ¿`, [{ text: 'ç¡®å®š', action: 'close' }], 'success');
      } catch (err) {
        showDialog('å¤åˆ¶å¤±è´¥', `è¯·æ‰‹åŠ¨å¤åˆ¶${type}`, [{ text: 'ç¡®å®š', action: 'close' }], 'info');
      }
      document.body.removeChild(textArea);
    }
    /**
     * æˆ‘çš„é’±åŒ…åŠŸèƒ½
     * æ˜¾ç¤ºä½™é¢ã€äº¤æ˜“è®°å½•å’Œæç°åŠŸèƒ½
     */
    function showWallet() {
      // ä¿å­˜å½“å‰çŠ¶æ€åˆ°localStorage
      saveState();
      
      // è·³è½¬åˆ°é’±åŒ…é¡µé¢
      window.location.href = 'wallet.html';
    }
    
    /**
     * è·å–é’±åŒ…æ•°æ®
     */
    function getWalletData() {
      const address = localStorage.getItem('walletAddress') || 'æœªç»‘å®š';
      const displayAddress = address === 'æœªç»‘å®š' ? 'æœªç»‘å®š' : 
        `${address.substring(0, 8)}...${address.substring(address.length - 6)}`;
      
      return {
        balance: walletBalance || 0,
        address: displayAddress,
        withdrawFeeRate: withdrawFeeRate || 0.05,
        transactions: transactions.slice(0, 5) // æ˜¾ç¤ºæœ€è¿‘5æ¡è®°å½•
      };
    }
    
    /**
     * ç”Ÿæˆäº¤æ˜“è®°å½•HTML
     */
    function generateTransactionListHTML(transactionList) {
      if (!transactionList || transactionList.length === 0) {
        return '<div class="no-transactions">æš‚æ— äº¤æ˜“è®°å½•</div>';
      }
      
      return transactionList.map(tx => {
        const isIncome = tx.type === 'income' || tx.amount > 0;
        const amountClass = isIncome ? 'amount-positive' : 'amount-negative';
        const amountPrefix = isIncome ? '+' : '-';
        
        return `
          <div class="transaction-item">
            <div class="tx-info">
              <div class="tx-description">${tx.description || tx.type}</div>
              <div class="tx-time">${formatTransactionTime(tx.timestamp)}</div>
            </div>
            <div class="tx-amount ${amountClass}">
              ${amountPrefix}${Math.abs(tx.amount).toFixed(2)} USDT
            </div>
          </div>
        `;
      }).join('');
    }
    
    /**
     * æ ¼å¼åŒ–äº¤æ˜“æ—¶é—´
     */
    function formatTransactionTime(timestamp) {
      const date = new Date(timestamp);
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / (1000 * 60));
      const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
      const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
      
      if (diffMins < 1) return 'åˆšåˆš';
      if (diffMins < 60) return `${diffMins}åˆ†é’Ÿå‰`;
      if (diffHours < 24) return `${diffHours}å°æ—¶å‰`;
      if (diffDays < 7) return `${diffDays}å¤©å‰`;
      
      return date.toLocaleDateString('zh-CN');
    }
    
    /**
     * æ˜¾ç¤ºæç°å¯¹è¯æ¡†
     */
    function showWithdrawDialog() {
      const maxWithdraw = Math.max(0, (walletBalance - 2) / (1 + withdrawFeeRate));
      
      const withdrawContent = `
        <div class="withdraw-form">
          <div class="form-group">
            <label>æç°é‡‘é¢ (USDT)</label>
            <input type="number" id="withdrawAmount" placeholder="è¯·è¾“å…¥æç°é‡‘é¢" 
                   max="${maxWithdraw.toFixed(2)}" min="1" step="0.01">
            <div class="amount-tips">
              <button onclick="setWithdrawAmount(10)" class="quick-amount">10</button>
              <button onclick="setWithdrawAmount(50)" class="quick-amount">50</button>
              <button onclick="setWithdrawAmount(100)" class="quick-amount">100</button>
              <button onclick="setWithdrawAmount('max')" class="quick-amount">å…¨éƒ¨</button>
            </div>
          </div>
          
          <div class="fee-calculation">
            <div class="fee-row">
              <span>æç°é‡‘é¢ï¼š</span>
              <span id="withdrawAmountDisplay">0.00 USDT</span>
            </div>
            <div class="fee-row">
              <span>æ‰‹ç»­è´¹ (${(withdrawFeeRate * 100).toFixed(1)}%)ï¼š</span>
              <span id="percentFeeDisplay">0.00 USDT</span>
            </div>
            <div class="fee-row">
              <span>å›ºå®šæ‰‹ç»­è´¹ï¼š</span>
              <span>2.00 USDT</span>
            </div>
            <div class="fee-row total">
              <span>æ€»æ‰£é™¤ï¼š</span>
              <span id="totalDeductDisplay">0.00 USDT</span>
            </div>
          </div>
          
          <div class="wallet-address-check">
            <div>æç°åœ°å€ï¼š${localStorage.getItem('walletAddress') || 'æœªç»‘å®š'}</div>
            ${!localStorage.getItem('walletAddress') ? 
              '<div class="address-warning">è¯·å…ˆç»‘å®šé’±åŒ…åœ°å€</div>' : ''}
          </div>
        </div>
      `;
      
      showDialog('æç°ç”³è¯·', withdrawContent, [
        { text: 'ç¡®è®¤æç°', action: () => processWithdraw(), style: 'primary' },
        { text: 'å–æ¶ˆ', action: 'close' }
      ], 'withdraw');
      
      // ç»‘å®šè¾“å…¥äº‹ä»¶
      setTimeout(() => {
        const amountInput = document.getElementById('withdrawAmount');
        if (amountInput) {
          amountInput.addEventListener('input', updateWithdrawCalculation);
        }
      }, 100);
    }
    
    /**
     * è®¾ç½®æç°é‡‘é¢
     */
    function setWithdrawAmount(amount) {
      const amountInput = document.getElementById('withdrawAmount');
      if (!amountInput) return;
      
      if (amount === 'max') {
        const maxWithdraw = Math.max(0, (walletBalance - 2) / (1 + withdrawFeeRate));
        amountInput.value = maxWithdraw.toFixed(2);
      } else {
        amountInput.value = amount;
      }
      
      updateWithdrawCalculation();
    }
    
    /**
     * æ›´æ–°æç°è®¡ç®—
     */
    function updateWithdrawCalculation() {
      const amountInput = document.getElementById('withdrawAmount');
      const amount = parseFloat(amountInput?.value || 0);
      
      const percentFee = amount * withdrawFeeRate;
      const fixedFee = 2;
      const totalDeduct = amount + percentFee + fixedFee;
      
      document.getElementById('withdrawAmountDisplay').textContent = `${amount.toFixed(2)} USDT`;
      document.getElementById('percentFeeDisplay').textContent = `${percentFee.toFixed(2)} USDT`;
      document.getElementById('totalDeductDisplay').textContent = `${totalDeduct.toFixed(2)} USDT`;
    }
    
    /**
     * å¤„ç†æç°
     */
    function processWithdraw() {
      const amountInput = document.getElementById('withdrawAmount');
      const amount = parseFloat(amountInput?.value || 0);
      const walletAddress = localStorage.getItem('walletAddress');
      
      // éªŒè¯
      if (!walletAddress) {
        showDialog('æç°å¤±è´¥', 'è¯·å…ˆç»‘å®šé’±åŒ…åœ°å€', [{ text: 'ç¡®å®š', action: 'close' }], 'error');
        return;
      }
      
      if (amount <= 0) {
        showDialog('æç°å¤±è´¥', 'è¯·è¾“å…¥æœ‰æ•ˆçš„æç°é‡‘é¢', [{ text: 'ç¡®å®š', action: 'close' }], 'error');
        return;
      }
      
      const percentFee = amount * withdrawFeeRate;
      const fixedFee = 2;
      const totalDeduct = amount + percentFee + fixedFee;
      
      if (totalDeduct > walletBalance) {
        showDialog('æç°å¤±è´¥', 'ä½™é¢ä¸è¶³ï¼Œè¯·å‡å°‘æç°é‡‘é¢', [{ text: 'ç¡®å®š', action: 'close' }], 'error');
        return;
      }
      
      // æ‰§è¡Œæç°
      walletBalance -= totalDeduct;
      
      // æ·»åŠ æç°è®°å½•
      transactions.unshift({
        type: 'withdraw',
        amount: -amount,
        description: 'æç°ç”³è¯·',
        timestamp: new Date().toISOString(),
        fee: percentFee + fixedFee,
        address: walletAddress,
        status: 'processing'
      });
      
      // ä¿å­˜çŠ¶æ€
      saveState();
      renderState();
      
      showDialog('æç°æˆåŠŸ', 
        `æç°ç”³è¯·å·²æäº¤\næç°é‡‘é¢ï¼š${amount.toFixed(2)} USDT\næ‰‹ç»­è´¹ï¼š${(percentFee + fixedFee).toFixed(2)} USDT\né¢„è®¡24å°æ—¶å†…åˆ°è´¦`, 
        [{ text: 'ç¡®å®š', action: 'close' }], 'success');
    }
    
    /**
     * æ˜¾ç¤ºåœ°å€ç»‘å®šå¯¹è¯æ¡†
     */
    function showAddressBinding() {
      const currentAddress = localStorage.getItem('walletAddress') || '';
      
      const addressContent = `
        <div class="address-form">
          <div class="form-group">
            <label>USDT TRC20 é’±åŒ…åœ°å€</label>
            <input type="text" id="walletAddressInput" placeholder="è¯·è¾“å…¥USDT TRC20é’±åŒ…åœ°å€" 
                   value="${currentAddress}">
            <div class="address-tips">
              <div>â€¢ ä»…æ”¯æŒUSDT TRC20åœ°å€</div>
              <div>â€¢ åœ°å€ä»¥Tå¼€å¤´ï¼Œé•¿åº¦ä¸º34ä½</div>
              <div>â€¢ è¯·ç¡®ä¿åœ°å€æ­£ç¡®ï¼Œé”™è¯¯åœ°å€å°†å¯¼è‡´èµ„äº§ä¸¢å¤±</div>
            </div>
          </div>
        </div>
      `;
      
      showDialog('ç»‘å®šé’±åŒ…åœ°å€', addressContent, [
        { text: 'ç¡®è®¤ç»‘å®š', action: () => saveWalletAddress(), style: 'primary' },
        { text: 'å–æ¶ˆ', action: 'close' }
      ], 'address');
    }
    
    /**
     * ä¿å­˜é’±åŒ…åœ°å€
     */
    function saveWalletAddress() {
      const addressInput = document.getElementById('walletAddressInput');
      const address = addressInput?.value.trim();
      
      if (!address) {
        showDialog('ç»‘å®šå¤±è´¥', 'è¯·è¾“å…¥é’±åŒ…åœ°å€', [{ text: 'ç¡®å®š', action: 'close' }], 'error');
        return;
      }
      
      // éªŒè¯USDT TRC20åœ°å€æ ¼å¼
      if (!address.startsWith('T') || address.length !== 34) {
        showDialog('ç»‘å®šå¤±è´¥', 'è¯·è¾“å…¥æœ‰æ•ˆçš„USDT TRC20é’±åŒ…åœ°å€', [{ text: 'ç¡®å®š', action: 'close' }], 'error');
        return;
      }
      
      // ä¿å­˜åœ°å€
      localStorage.setItem('walletAddress', address);
      
      showDialog('ç»‘å®šæˆåŠŸ', 'é’±åŒ…åœ°å€ç»‘å®šæˆåŠŸï¼', [{ text: 'ç¡®å®š', action: 'close' }], 'success');
    }
    // æ’è¡Œæ¦œ
    /**
     * æ’è¡Œæ¦œç³»ç»Ÿ - æ˜¾ç¤ºå†…åµŒæ’è¡Œæ¦œå¼¹çª—
     */
    function showRanking() {
      // ä¿å­˜å½“å‰çŠ¶æ€åˆ°localStorage
      saveState();
      
      // ç›´æ¥è·³è½¬åˆ°æ’è¡Œæ¦œé¡µé¢
      window.location.href = 'ranking.html';
    }
    function showRedRanking() {
      showDialog('çº¢åŒ…æ’è¡Œæ¦œ', 'æŒ‰çº¢åŒ…æ”¶å…¥USDTæ€»é¢æ’è¡Œã€‚');
    }
    function showGodRanking() {
      showDialog('å¤§ç¥æ’è¡Œæ¦œ', 'æŒ‰å¤§ç¥ç­‰çº§æ’è¡Œã€‚');
    }
    /**
     * å¤§ç¥ä»»åŠ¡ç³»ç»Ÿ
     */
    function openGodTasks() {
      // æ£€æŸ¥å¤§ç¥ä»»åŠ¡æ˜¯å¦è§£é”
      const completedNewbieTasks = newTasks.filter(task => task.done).length;
      const quizCorrect = parseInt(localStorage.getItem('quizCorrect')) || 0;
      const quizCompleted = quizCorrect >= 20;
      const godTasksUnlocked = completedNewbieTasks >= 3 && quizCompleted;
      
      if (!godTasksUnlocked) {
        showDialog('å¤§ç¥ä»»åŠ¡æœªè§£é”', 'éœ€è¦å®Œæˆæ‰€æœ‰æ–°æ‰‹ä»»åŠ¡å’Œç­”é¢˜ä»»åŠ¡æ‰èƒ½è§£é”å¤§ç¥ä»»åŠ¡ã€‚', [
          { text: 'çŸ¥é“äº†', action: 'close' }
        ]);
        return;
      }
      
      // æ‰¾åˆ°ä¸‹ä¸€ä¸ªæœªå®Œæˆçš„å¤§ç¥ä»»åŠ¡
      const nextGodTask = godTasks.find(t => !t.done);
      
      if (nextGodTask) {
        // æ˜¾ç¤ºå¤§ç¥ä»»åŠ¡è¯¦æƒ…
        showDialog('å¤§ç¥ä»»åŠ¡', `${nextGodTask.title}\n\n${nextGodTask.desc}\n\nå®Œæˆå¥–åŠ±ï¼š${nextGodTask.reward} USDT\n\nç‚¹å‡»ç¡®å®šæ ‡è®°å®Œæˆ`, [
          { text: 'å®Œæˆä»»åŠ¡', action: () => completeGodTask(nextGodTask) },
          { text: 'å–æ¶ˆ', action: 'close' }
        ]);
      } else {
        // æ‰€æœ‰å¤§ç¥ä»»åŠ¡å·²å®Œæˆ
        const completedGodTasks = godTasks.filter(t => t.done).length;
        showDialog('å¤§ç¥ä»»åŠ¡', `æ­å–œï¼æ‰€æœ‰å¤§ç¥ä»»åŠ¡å·²å®Œæˆï¼\n\nå·²å®Œæˆï¼š${completedGodTasks}/6\n\nç»§ç»­é‚€è¯·å¥½å‹è·å¾—æ›´å¤šå¥–åŠ±ã€‚`, [
          { text: 'çŸ¥é“äº†', action: 'close' }
        ]);
      }
    }

    /**
     * å®Œæˆå¤§ç¥ä»»åŠ¡
     */
    function completeGodTask(task) {
      // æ¨¡æ‹Ÿä»»åŠ¡å®Œæˆ
      setTimeout(() => {
        task.done = true;
        
        // ä»»åŠ¡å¥–åŠ±
        walletBalance += task.reward;
        totalEarnings += task.reward;
        
        // è®°å½•äº¤æ˜“
        transactions.push({ 
          type: 'å¤§ç¥ä»»åŠ¡å¥–åŠ±', 
          amount: task.reward, 
          fee: 0, 
          net: task.reward, 
          time: new Date().toISOString(),
          desc: `å®Œæˆ${task.title}` 
        });
        
        saveState();
        renderState();
        
        // æ˜¾ç¤ºä»»åŠ¡å®Œæˆå¼¹çª—
        const completedGodTasks = godTasks.filter(t => t.done).length;
        showDialog('å¤§ç¥ä»»åŠ¡å®Œæˆ', `æ­å–œå®Œæˆå¤§ç¥ä»»åŠ¡ï¼š${task.title}ï¼\nå¥–åŠ±ï¼š${task.reward} USDT\nå½“å‰ä½™é¢ï¼š${walletBalance.toFixed(2)} USDT\n\nå¤§ç¥ä»»åŠ¡è¿›åº¦ï¼š${completedGodTasks}/6`);
        
        // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰å¤§ç¥ä»»åŠ¡éƒ½å®Œæˆäº†
        if (completedGodTasks >= 6) {
          setTimeout(() => {
            showDialog('å…¨éƒ¨å®Œæˆ', 'ğŸ‰ æ­å–œï¼æ‰€æœ‰å¤§ç¥ä»»åŠ¡å·²å®Œæˆï¼\n\næ‚¨å·²æˆä¸ºçœŸæ­£çš„å¤§ç¥ï¼\nç»§ç»­é‚€è¯·å¥½å‹è·å¾—æ›´å¤šå¥–åŠ±ã€‚', [
              { text: 'å¤ªæ£’äº†ï¼', action: 'close' }
            ]);
          }, 2000);
        }
      }, 1500);
    }
    /* é«˜çº§å¯¹è¯æ¡† */
    // å¼¹çª—é˜Ÿåˆ—ç®¡ç†
    let dialogQueue = [];
    let isDialogShowing = false;
    
    function showDialog(title, msg, buttons = null, type = 'normal', callback = null) {
      // å¦‚æœå½“å‰æœ‰å¼¹çª—æ­£åœ¨æ˜¾ç¤ºï¼Œå°†æ–°å¼¹çª—åŠ å…¥é˜Ÿåˆ—
      if (isDialogShowing) {
        dialogQueue.push({ title, msg, buttons, type, callback });
        return;
      }
      
      isDialogShowing = true;
      const dialog = document.getElementById('dialog');
      const dialogTitle = document.getElementById('dialogTitle');
      const dialogMsg = document.getElementById('dialogMsg');
      const dialogButtons = document.getElementById('dialogButtons');
      
      dialogTitle.innerText = title;
      dialogMsg.innerText = msg;
      
      // æ ¹æ®ç±»å‹æ·»åŠ ç‰¹æ®Šæ ·å¼
       dialog.className = 'dialog';
       if (title.includes('ä»»åŠ¡å®Œæˆ') || title.includes('æ­å–œ') || title.includes('æˆåŠŸ') || title.includes('æŠ¢çº¢åŒ…æˆåŠŸ') || title.includes('æ¿€æ´»æˆåŠŸ') || type === 'success') {
         dialog.classList.add('success');
       }
       if (type === 'redpacket') {
         dialog.classList.add('redpacket');
       }
       if (type === 'countdown') {
         dialog.classList.add('countdown');
       }
      
      if (buttons && Array.isArray(buttons)) {
        // è‡ªå®šä¹‰æŒ‰é’®
        dialogButtons.innerHTML = '';
        buttons.forEach(button => {
          const btn = document.createElement('button');
          btn.textContent = button.text;
          btn.className = button.style === 'danger' ? 'danger-btn' : (button.style === 'secondary' ? 'secondary-btn' : '');
          btn.onclick = () => {
            closeDialog(() => {
              // å¤„ç†WebSocketæ¶ˆæ¯ä¸­çš„ç‰¹æ®ŠåŠ¨ä½œ
              if (button.action === 'grabRedPacket') {
                grabRedPacket();
              } else if (button.action === 'showTasks') {
                // æ˜¾ç¤ºä»»åŠ¡é¡µé¢æˆ–ä»»åŠ¡å¼¹çª—
                showTasks();
              } else if (button.action === 'close') {
                // ä»…å…³é—­å¼¹çª—ï¼Œæ— å…¶ä»–åŠ¨ä½œ
              } else if (button.action) {
                button.action();
              }
              if (callback) {
                callback();
              }
            });
          };
          dialogButtons.appendChild(btn);
        });
      } else {
        // é»˜è®¤ç¡®å®šæŒ‰é’®
        dialogButtons.innerHTML = '';
        const defaultBtn = document.createElement('button');
        defaultBtn.textContent = 'ç¡®å®š';
        defaultBtn.onclick = () => {
          closeDialog(callback);
        };
        dialogButtons.appendChild(defaultBtn);
      }
      
      // æ˜¾ç¤ºå¼¹çª—å¹¶æ·»åŠ åŠ¨ç”»
      dialog.style.display = 'flex';
      setTimeout(() => {
        dialog.classList.add('show');
      }, 10);
    }
    
    function closeDialog(callback = null) {
      const dialog = document.getElementById('dialog');
      dialog.classList.remove('show');
      setTimeout(() => {
        dialog.style.display = 'none';
        dialog.className = 'dialog'; // é‡ç½®ç±»å
        isDialogShowing = false;
        
        if (callback) {
          callback();
        }
        
        // å¤„ç†é˜Ÿåˆ—ä¸­çš„ä¸‹ä¸€ä¸ªå¼¹çª—ï¼Œæ·»åŠ 500mså»¶è¿Ÿé¿å…è§†è§‰å†²çª
        if (dialogQueue.length > 0) {
          setTimeout(() => {
            const nextDialog = dialogQueue.shift();
            showDialog(nextDialog.title, nextDialog.msg, nextDialog.buttons, nextDialog.type, nextDialog.callback);
          }, 500);
        }
      }, 300);
    }

    /**
     * æ˜¾ç¤ºæ”¯ä»˜å¯¹è¯æ¡†
     * @param {Object} activationData - æ¿€æ´»æ•°æ®ï¼ŒåŒ…å«é’±åŒ…åœ°å€ã€é‡‘é¢ã€è®¢å•IDç­‰
     */
    function showPaymentDialog(activationData) {
      const { walletAddress, amount, orderId, expiresAt } = activationData;
      
      // åˆ›å»ºæ”¯ä»˜å¯¹è¯æ¡†HTML
      const paymentDialogHTML = `
        <div id="paymentDialog" class="payment-dialog">
          <div class="payment-box">
            <div class="payment-header">
              <h3>ğŸ’° æ¿€æ´»è´¦å·æ”¯ä»˜</h3>
              <button class="close-btn" onclick="closePaymentDialog()">Ã—</button>
            </div>
            
            <div class="payment-info">
              <div class="amount-section">
                <div class="amount-label">æ”¯ä»˜é‡‘é¢</div>
                <div class="amount-value">${amount} USDT</div>
              </div>
              
              <div class="wallet-section">
                <div class="wallet-label">æ”¶æ¬¾åœ°å€ (TRC20)</div>
                <div class="wallet-address" id="paymentWalletAddress">${walletAddress}</div>
                <button class="copy-btn" onclick="copyWalletAddress()">å¤åˆ¶åœ°å€</button>
              </div>
              
              <div class="qr-section">
                <div class="qr-label">æ‰«ç æ”¯ä»˜</div>
                <div class="qr-code" id="paymentQRCode">
                  <canvas id="qrCanvas"></canvas>
                </div>
              </div>
              
              <div class="countdown-section">
                <div class="countdown-label">æ”¯ä»˜å‰©ä½™æ—¶é—´</div>
                <div class="countdown-timer" id="paymentCountdown">30:00</div>
              </div>
              
              <div class="order-section">
                <div class="order-label">è®¢å•å·</div>
                <div class="order-id">${orderId}</div>
              </div>
            </div>
            
            <div class="payment-status">
              <div class="status-indicator" id="paymentStatus">
                <div class="loading-spinner"></div>
                <span>ç­‰å¾…æ”¯ä»˜ä¸­...</span>
              </div>
            </div>
            
            <div class="payment-tips">
              <p>âš ï¸ è¯·åŠ¡å¿…ä½¿ç”¨TRC20ç½‘ç»œè½¬è´¦</p>
              <p>ğŸ’¡ æ”¯ä»˜å®Œæˆåç³»ç»Ÿå°†è‡ªåŠ¨ç¡®è®¤</p>
              <p>ğŸ”„ æ”¯ä»˜çŠ¶æ€æ¯10ç§’è‡ªåŠ¨æ£€æŸ¥ä¸€æ¬¡</p>
            </div>
          </div>
        </div>
      `;
      
      // æ·»åŠ åˆ°é¡µé¢
      document.body.insertAdjacentHTML('beforeend', paymentDialogHTML);
      
      // ç”ŸæˆäºŒç»´ç 
      generatePaymentQRCode(walletAddress, amount);
      
      // å¼€å§‹å€’è®¡æ—¶
      startPaymentCountdown(expiresAt);
      
      // å¼€å§‹ç›‘æ§æ”¯ä»˜çŠ¶æ€
      startPaymentMonitoring(orderId);
      
      // æ˜¾ç¤ºå¯¹è¯æ¡†
      const paymentDialog = document.getElementById('paymentDialog');
      setTimeout(() => {
        paymentDialog.classList.add('show');
      }, 100);
    }

    /**
     * ç”Ÿæˆæ”¯ä»˜äºŒç»´ç 
     * @param {string} walletAddress - é’±åŒ…åœ°å€
     * @param {number} amount - æ”¯ä»˜é‡‘é¢
     */
    function generatePaymentQRCode(walletAddress, amount) {
      try {
        // æ„å»ºTRONæ”¯ä»˜é“¾æ¥
        const qrText = `tron:${walletAddress}?amount=${amount}&token=TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t`;
        const canvas = document.getElementById('qrCanvas');
        
        // ä½¿ç”¨åœ¨çº¿äºŒç»´ç ç”ŸæˆæœåŠ¡ä½œä¸ºä¸´æ—¶è§£å†³æ–¹æ¡ˆ
        const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(qrText)}`;
        
        // åˆ›å»ºäºŒç»´ç å›¾ç‰‡
        const qrImage = document.createElement('img');
        qrImage.src = qrCodeUrl;
        qrImage.style.width = '200px';
        qrImage.style.height = '200px';
        qrImage.alt = 'æ”¯ä»˜äºŒç»´ç ';
        
        // æ›¿æ¢canvasä¸ºå›¾ç‰‡
        const qrContainer = document.getElementById('paymentQRCode');
        qrContainer.innerHTML = '';
        qrContainer.appendChild(qrImage);
        
        // æ·»åŠ æç¤ºä¿¡æ¯
        const qrTip = document.createElement('div');
        qrTip.style.marginTop = '10px';
        qrTip.style.fontSize = '12px';
        qrTip.style.color = '#666';
        qrTip.textContent = `æ‰«ç æ”¯ä»˜ ${amount} USDT`;
        qrContainer.appendChild(qrTip);
        
      } catch (error) {
        console.error('ç”ŸæˆäºŒç»´ç å¤±è´¥:', error);
        document.getElementById('paymentQRCode').innerHTML = '<div class="qr-error">äºŒç»´ç ç”Ÿæˆå¤±è´¥</div>';
      }
    }

    /**
     * å¼€å§‹æ”¯ä»˜å€’è®¡æ—¶
     * @param {string} expiresAt - è¿‡æœŸæ—¶é—´
     */
    /**
     * å¼€å§‹æ”¯ä»˜å€’è®¡æ—¶
     * @param {string|Date|number} expiresAt - è¿‡æœŸæ—¶é—´
     */
    function startPaymentCountdown(expiresAt) {
      const countdownElement = document.getElementById('paymentCountdown');
      
      // å¤„ç†ä¸åŒæ ¼å¼çš„è¿‡æœŸæ—¶é—´
      let expiryTime;
      if (!expiresAt) {
        // å¦‚æœæ²¡æœ‰æä¾›è¿‡æœŸæ—¶é—´ï¼Œé»˜è®¤30åˆ†é’Ÿ
        expiryTime = Date.now() + (30 * 60 * 1000);
      } else if (typeof expiresAt === 'number') {
        expiryTime = expiresAt;
      } else {
        expiryTime = new Date(expiresAt).getTime();
      }
      
      // éªŒè¯æ—¶é—´æ˜¯å¦æœ‰æ•ˆ
      if (isNaN(expiryTime)) {
        console.warn('æ— æ•ˆçš„è¿‡æœŸæ—¶é—´ï¼Œä½¿ç”¨é»˜è®¤30åˆ†é’Ÿ:', expiresAt);
        expiryTime = Date.now() + (30 * 60 * 1000);
      }
      
      const countdownInterval = setInterval(() => {
        const now = Date.now();
        const timeLeft = expiryTime - now;
        
        if (timeLeft <= 0) {
          clearInterval(countdownInterval);
          countdownElement.textContent = 'å·²è¿‡æœŸ';
          countdownElement.style.color = '#ff4444';
          
          // æ˜¾ç¤ºè¿‡æœŸæç¤º
          const statusElement = document.getElementById('paymentStatus');
          if (statusElement) {
            statusElement.innerHTML = '<span style="color: #ff4444;">â° æ”¯ä»˜å·²è¿‡æœŸ</span>';
          }
          
          return;
        }
        
        const minutes = Math.floor(timeLeft / (1000 * 60));
        const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
        
        // ç¡®ä¿æ•°å­—æœ‰æ•ˆ
        const displayMinutes = isNaN(minutes) ? 0 : minutes;
        const displaySeconds = isNaN(seconds) ? 0 : seconds;
        
        countdownElement.textContent = `${displayMinutes.toString().padStart(2, '0')}:${displaySeconds.toString().padStart(2, '0')}`;
      }, 1000);
      
      // ä¿å­˜å€’è®¡æ—¶IDä»¥ä¾¿æ¸…ç†
      window.paymentCountdownInterval = countdownInterval;
    }

    /**
     * å¼€å§‹ç›‘æ§æ”¯ä»˜çŠ¶æ€
     * @param {string} orderId - è®¢å•ID
     */
    function startPaymentMonitoring(orderId) {
      let checkCount = 0;
      const maxChecks = 180; // æœ€å¤šæ£€æŸ¥30åˆ†é’Ÿï¼ˆæ¯10ç§’ä¸€æ¬¡ï¼‰
      
      const monitoringInterval = setInterval(async () => {
        checkCount++;
        
        if (checkCount > maxChecks) {
          clearInterval(monitoringInterval);
          const statusElement = document.getElementById('paymentStatus');
          statusElement.innerHTML = '<span style="color: #ff4444;">â° ç›‘æ§è¶…æ—¶</span>';
          return;
        }
        
        try {
          // è°ƒç”¨åç«¯APIæ£€æŸ¥æ”¯ä»˜çŠ¶æ€
          const response = await fetch(`/api/activation/status/${orderId}`, {
            method: 'GET',
            headers: {
              'Authorization': `Bearer ${localStorage.getItem('authToken') || 'demo-token'}`,
              'Content-Type': 'application/json'
            }
          });
          
          if (response.ok) {
            const statusData = await response.json();
            const { status, txHash } = statusData;
            
            const statusElement = document.getElementById('paymentStatus');
            
            switch (status) {
              case 'pending':
                statusElement.innerHTML = '<div class="loading-spinner"></div><span>ç­‰å¾…æ”¯ä»˜ä¸­...</span>';
                break;
              case 'confirming':
                statusElement.innerHTML = '<div class="loading-spinner"></div><span>ğŸ”„ äº¤æ˜“ç¡®è®¤ä¸­...</span>';
                break;
              case 'confirmed':
                // æ”¯ä»˜æˆåŠŸ
                clearInterval(monitoringInterval);
                if (window.paymentCountdownInterval) {
                  clearInterval(window.paymentCountdownInterval);
                }
                
                statusElement.innerHTML = '<span style="color: #00ff88;">âœ… æ”¯ä»˜æˆåŠŸï¼</span>';
                
                // å»¶è¿Ÿå…³é—­æ”¯ä»˜å¯¹è¯æ¡†å¹¶æ›´æ–°ç”¨æˆ·çŠ¶æ€
                setTimeout(() => {
                  closePaymentDialog();
                  handlePaymentSuccess(txHash);
                }, 2000);
                break;
              case 'failed':
                clearInterval(monitoringInterval);
                statusElement.innerHTML = '<span style="color: #ff4444;">âŒ æ”¯ä»˜å¤±è´¥</span>';
                break;
            }
          }
        } catch (error) {
          console.error('æ£€æŸ¥æ”¯ä»˜çŠ¶æ€å¤±è´¥:', error);
          // ç»§ç»­ç›‘æ§ï¼Œä¸ä¸­æ–­
        }
      }, 10000); // æ¯10ç§’æ£€æŸ¥ä¸€æ¬¡
      
      // ä¿å­˜ç›‘æ§IDä»¥ä¾¿æ¸…ç†
      window.paymentMonitoringInterval = monitoringInterval;
    }

    /**
     * å¤„ç†æ”¯ä»˜æˆåŠŸ
     * @param {string} txHash - äº¤æ˜“å“ˆå¸Œ
     */
    function handlePaymentSuccess(txHash) {
      // æ›´æ–°ç”¨æˆ·çŠ¶æ€åˆ°çŠ¶æ€2
      currentState = 2;
      countdownStart = Date.now();
      inviteStart = Date.now();
      
      // è®°å½•äº¤æ˜“
      const transaction = {
        id: Date.now().toString(),
        type: 'activation',
        amount: 100,
        status: 'completed',
        txHash: txHash,
        timestamp: Date.now(),
        description: 'è´¦å·æ¿€æ´»'
      };
      
      transactions.unshift(transaction);
      
      // ä¿å­˜çŠ¶æ€
      saveState();
      
      // é‡æ–°æ¸²æŸ“é¡µé¢
      renderState();
      
      // æ˜¾ç¤ºæˆåŠŸæç¤º
      showDialog('æ¿€æ´»æˆåŠŸ', 'ğŸ‰ æ­å–œï¼è´¦å·æ¿€æ´»æˆåŠŸï¼\n\næ‚¨ç°åœ¨å¯ä»¥å¼€å§‹æŒ‘æˆ˜ä»»åŠ¡ï¼Œé‚€è¯·å¥½å‹è·å¾—å¥–åŠ±ï¼', [
        { text: 'å¼€å§‹æŒ‘æˆ˜', action: 'close' }
      ], 'success');
    }

    /**
     * å¤åˆ¶é’±åŒ…åœ°å€
     */
    function copyWalletAddress() {
      const walletAddress = document.getElementById('paymentWalletAddress').textContent;
      
      if (navigator.clipboard) {
        navigator.clipboard.writeText(walletAddress).then(() => {
          showDialog('å¤åˆ¶æˆåŠŸ', 'é’±åŒ…åœ°å€å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
        }).catch(() => {
          fallbackCopyWalletAddress(walletAddress);
        });
      } else {
        fallbackCopyWalletAddress(walletAddress);
      }
    }

    /**
     * é™çº§å¤åˆ¶é’±åŒ…åœ°å€æ–¹æ¡ˆ
     * @param {string} address - é’±åŒ…åœ°å€
     */
    function fallbackCopyWalletAddress(address) {
      const textArea = document.createElement('textarea');
      textArea.value = address;
      document.body.appendChild(textArea);
      textArea.select();
      
      try {
        document.execCommand('copy');
        showDialog('å¤åˆ¶æˆåŠŸ', 'é’±åŒ…åœ°å€å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
      } catch (err) {
        showDialog('å¤åˆ¶å¤±è´¥', 'è¯·æ‰‹åŠ¨å¤åˆ¶é’±åŒ…åœ°å€');
      }
      
      document.body.removeChild(textArea);
    }

    /**
     * å…³é—­æ”¯ä»˜å¯¹è¯æ¡†
     */
    function closePaymentDialog() {
      const paymentDialog = document.getElementById('paymentDialog');
      if (paymentDialog) {
        paymentDialog.classList.remove('show');
        
        // æ¸…ç†å®šæ—¶å™¨
        if (window.paymentCountdownInterval) {
          clearInterval(window.paymentCountdownInterval);
        }
        if (window.paymentMonitoringInterval) {
          clearInterval(window.paymentMonitoringInterval);
        }
        
        setTimeout(() => {
          paymentDialog.remove();
        }, 300);
      }
    }

    /**
     * é‡ç½®æµ‹è¯•æ•°æ®
     */
    /**
     * é‡ç½®ç”¨æˆ·æ•°æ® - å·²ç§»é™¤åŠŸèƒ½
     */
    /*
    async function resetTestData() {
      if(confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
        try {
          // è°ƒç”¨åç«¯APIé‡ç½®ç”¨æˆ·æ•°æ®
          const response = await apiRequest('/api/user/reset', {
            method: 'POST'
          });
          
          if (response.success) {
            // æ¸…ç©ºæœ¬åœ°å­˜å‚¨
            localStorage.removeItem('userTasks');
            localStorage.removeItem('quizCompleted');
            localStorage.removeItem('godTasksCompleted');
            localStorage.removeItem('userBalance');
            localStorage.removeItem('teamSize');
            localStorage.removeItem('quizIndex');
            localStorage.removeItem('quizCorrect');
            localStorage.removeItem('transactions');
            localStorage.removeItem('appState');
            localStorage.removeItem('teamData');
            localStorage.removeItem('recentRed');
            
            // é‡ç½®å…¨å±€å˜é‡åˆ°åˆå§‹çŠ¶æ€
            transactions = [];
            userLevel = 0;
            completedNewbieTasks = 0;
            godTasksUnlocked = false;
            teamMembers = 0;
            totalEarnings = 0;
            withdrawFeeRate = 0.05;
            walletBalance = 0;
            countdownStart = null;
            inviteStart = null;
            
            // é‡ç½®åˆ°çŠ¶æ€1
            currentState = 1;
            
            // é‡æ–°åŒæ­¥æ•°æ®å¹¶æ¸²æŸ“é¡µé¢
            await syncWithBackend();
            renderState();
            
            showDialog('é‡ç½®æˆåŠŸ', 'ç”¨æˆ·æ•°æ®å·²é‡ç½®ï¼Œè¯·é‡æ–°å¼€å§‹æŒ‘æˆ˜ã€‚');
          } else {
            throw new Error(response.message || 'é‡ç½®å¤±è´¥');
          }
        } catch (error) {
          console.error('é‡ç½®æ•°æ®å¤±è´¥:', error);
          showDialog('é‡ç½®å¤±è´¥', 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•ã€‚');
        }
      }
    }
    */

    /**
     * å¼ºåˆ¶é£æ ¼é€‰æ‹©å¼¹çª—
     */
    function showForceThemeSelection(teamSize, balance) {
      const themes = {
        'cyberpunk': { name: 'èµ›åšæœ‹å…‹', icon: 'ğŸŒ†', description: 'æœªæ¥ç§‘æŠ€æ„Ÿ' },

        'business': { name: 'å•†åŠ¡è“', icon: 'ğŸ’¼', description: 'ä¸“ä¸šç¨³é‡' },
        'dark-tech': { name: 'æš—é»‘ç§‘æŠ€', icon: 'âš¡', description: 'ç¥ç§˜é…·ç‚«' },
        'fresh': { name: 'æ¸…æ–°ç»¿', icon: 'ğŸŒ¿', description: 'è‡ªç„¶æ¸…æ–°' }
      };
      
      const themeOptionsHTML = Object.entries(themes).map(([key, theme]) => `
        <div class="force-theme-option" data-theme="${key}">
          <span class="force-theme-icon">${theme.icon}</span>
          <div class="force-theme-info">
            <div class="force-theme-name">${theme.name}</div>
            <div class="force-theme-desc">${theme.description}</div>
          </div>
        </div>
      `).join('');
      
      const modalHTML = `
        <div id="forceThemeModal" class="force-theme-modal">
          <div class="force-theme-content">
            <div class="force-theme-header">
              <h2>ğŸ¨ é€‰æ‹©æ‚¨çš„ä¸“å±é£æ ¼</h2>
              <p>æ•°æ®é‡ç½®æˆåŠŸï¼è¯·é€‰æ‹©ä¸€ä¸ªé£æ ¼ä¸»é¢˜ç»§ç»­ä½¿ç”¨</p>
            </div>
            <div class="force-theme-options">
              ${themeOptionsHTML}
            </div>
            <div class="force-theme-footer">
              <p class="force-theme-info-text">å›¢é˜Ÿäººæ•°ï¼š${teamSize}äºº | ä½™é¢ï¼š${balance} USDT | æ‰€æœ‰ä»»åŠ¡å·²é‡ç½®</p>
            </div>
          </div>
        </div>
      `;
      
      // æ·»åŠ æ ·å¼
      const styleHTML = `
        <style>
        .force-theme-modal {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.8);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 10000;
          backdrop-filter: blur(10px);
        }
        .force-theme-content {
          background: var(--bg-card);
          border-radius: 20px;
          padding: 24px;
          max-width: 400px;
          width: 90%;
          box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
          border: 1px solid var(--border-color);
        }
        .force-theme-header {
          text-align: center;
          margin-bottom: 20px;
        }
        .force-theme-header h2 {
          color: var(--text-primary);
          margin: 0 0 8px 0;
          font-size: 20px;
        }
        .force-theme-header p {
          color: var(--text-secondary);
          margin: 0;
          font-size: 14px;
        }
        .force-theme-options {
          display: flex;
          flex-direction: column;
          gap: 8px;
          margin-bottom: 20px;
        }
        .force-theme-option {
          display: flex;
          align-items: center;
          gap: 12px;
          padding: 12px;
          border: 2px solid var(--border-color);
          border-radius: 12px;
          cursor: pointer;
          transition: all 0.3s ease;
          background: var(--bg-secondary);
        }
        .force-theme-option:hover {
          border-color: var(--accent-color);
          transform: translateY(-2px);
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        .force-theme-option.selected {
          border-color: var(--accent-color);
          background: var(--btn-gradient);
          color: var(--text-primary);
        }
        .force-theme-icon {
          font-size: 24px;
          width: 32px;
          text-align: center;
        }
        .force-theme-info {
          flex: 1;
        }
        .force-theme-name {
          font-weight: 600;
          font-size: 16px;
          margin-bottom: 2px;
        }
        .force-theme-desc {
          font-size: 12px;
          opacity: 0.8;
        }
        .force-theme-footer {
          text-align: center;
        }
        .force-theme-info-text {
          font-size: 12px;
          color: var(--text-secondary);
          margin: 0;
        }
        </style>
      `;
      
      // æ’å…¥æ ·å¼å’Œæ¨¡æ€æ¡†
      document.head.insertAdjacentHTML('beforeend', styleHTML);
      document.body.insertAdjacentHTML('beforeend', modalHTML);
      
      // ç»‘å®šäº‹ä»¶
      const modal = document.getElementById('forceThemeModal');
      const options = document.querySelectorAll('.force-theme-option');
      
      options.forEach(option => {
        option.addEventListener('click', () => {
          const selectedTheme = option.getAttribute('data-theme');
          
          // åº”ç”¨é€‰ä¸­çš„ä¸»é¢˜
          if (window.themeSwitcher) {
            window.themeSwitcher.switchTheme(selectedTheme);
          } else {
            document.documentElement.setAttribute('data-theme', selectedTheme === 'cyberpunk' ? '' : selectedTheme);
            localStorage.setItem('selectedTheme', selectedTheme);
          }
          
          // å…³é—­æ¨¡æ€æ¡†
          modal.remove();
          
          // æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
          const themeName = themes[selectedTheme].name;
          showDialog('é£æ ¼è®¾ç½®æˆåŠŸ', `å·²åˆ‡æ¢è‡³${themeName}é£æ ¼\nå›¢é˜Ÿäººæ•°ï¼š${teamSize}äºº\nä½™é¢ï¼š${balance} USDT\næ‰€æœ‰ä»»åŠ¡å·²é‡ç½®`);
        });
      });
    }

    /**
     * æ¨¡æ€å¼¹çª—ç®¡ç†
     */
    const modal = document.getElementById('modal');
    const modalClose = document.getElementById('modalClose');
    const modalBody = document.getElementById('modalBody');
    modalClose.addEventListener('click', () => {
      modal.style.display = 'none';
    });
    function openModal(type) {
      let html = '';
      if(type === 'task') {
        const currentTask = newTasks.find(t => !t.done);
        if(currentTask) {
          html += `<h3 style="margin-top:0;color:var(--brand)">${currentTask.title}</h3>`;
          html += `<p style="font-size:14px;color:var(--muted)">${currentTask.desc ? currentTask.desc : 'å®Œæˆæ­¤ä»»åŠ¡å¯æ¨è¿›è¿›åº¦ã€‚'}</p>`;
          html += `<button class="btn" id="modalTaskDone" style="margin-top:16px;width:100%">æ ‡è®°å®Œæˆ</button>`;
        } else {
          html += `<h3 style="margin-top:0;color:var(--brand)">æ‰€æœ‰æ–°æ‰‹ä»»åŠ¡å·²å®Œæˆ</h3>`;
          html += `<p style="font-size:14px;color:var(--muted)">æ— éœ€å†æ‰§è¡Œæ–°æ‰‹ä»»åŠ¡ã€‚</p>`;
        }
      } else if(type === 'wallet') {
        html += `<h3 style="margin-top:0;color:var(--brand)">æˆ‘çš„é’±åŒ…</h3>`;
        html += `<p style="font-size:14px;color:var(--muted)">å½“å‰ä½™é¢ï¼š-- USDT</p>`;
        html += `<button class="btn" style="margin-top:16px;width:100%">æç°</button>`;
      } else if(type === 'team') {
        html += `<h3 style="margin-top:0;color:var(--brand)">æˆ‘çš„å›¢é˜Ÿ</h3>`;
        html += `<div style="font-size:14px;color:var(--muted)">
          <p>å›¢é˜Ÿæ€»äººæ•°ï¼š<span id="teamTotalCount">--</span></p>
          <p>ç›´æ¨äººæ•°ï¼š<span id="directCount">--</span></p>
          <p>å›¢é˜Ÿä¸šç»©ï¼š<span id="teamPerformance">-- USDT</span></p>
        </div>`;
      } else if(type === 'ranking') {
        html += `<h3 style="margin-top:0;color:var(--brand)">æ’è¡Œæ¦œ</h3>`;
        html += `<div style="font-size:14px;color:var(--muted)">
          <div style="margin-bottom:16px">
            <h4 style="margin:0 0 8px 0;color:var(--brand)">å›¢é˜Ÿæ’è¡Œ</h4>
            <p>æš‚æ— æ•°æ®</p>
          </div>
          <div style="margin-bottom:16px">
            <h4 style="margin:0 0 8px 0;color:var(--brand)">çº¢åŒ…æ’è¡Œ</h4>
            <p>æš‚æ— æ•°æ®</p>
          </div>
          <div>
            <h4 style="margin:0 0 8px 0;color:var(--brand)">å¤§ç¥æ’è¡Œ</h4>
            <p>æš‚æ— æ•°æ®</p>
          </div>
        </div>`;
      }
      modalBody.innerHTML = html;
      modal.style.display = 'flex';
      // ç»‘å®šä»»åŠ¡å®ŒæˆæŒ‰é’®
      const completeBtn = document.getElementById('modalTaskDone');
      if(completeBtn) {
        completeBtn.addEventListener('click', () => {
          const task = newTasks.find(t => !t.done);
          if(task) task.done = true;
          modal.style.display = 'none';
          renderState();
        });
      }
    }

    // é€€å‡ºç™»å½•åŠŸèƒ½
    // ç¡®è®¤é€€å‡ºç™»å½•
    function confirmLogout() {
      // å…ˆå…³é—­è®¾ç½®ç•Œé¢
      closeSettings();
      
      // ç„¶åæ˜¾ç¤ºç¡®è®¤é€€å‡ºå¯¹è¯æ¡†
      showDialog('ç¡®è®¤é€€å‡º', 'é€€å‡ºç™»å½•å°†æ¸…é™¤æ‰€æœ‰æœ¬åœ°æ•°æ®ï¼Œç¡®å®šè¦ç»§ç»­å—ï¼Ÿ', [
        {
          text: 'å–æ¶ˆ',
          style: 'secondary',
          action: () => {}
        },
        {
          text: 'ç¡®è®¤é€€å‡º',
          style: 'danger',
          action: logout
        }
      ]);
    }
    
    function logout() {
      // æ¸…é™¤æ‰€æœ‰ç”¨æˆ·ç›¸å…³çš„æœ¬åœ°å­˜å‚¨æ•°æ®
      localStorage.removeItem('userEmail');
      localStorage.removeItem('userPassword');
      localStorage.removeItem('appState');
      localStorage.removeItem('userInviteCode');
      localStorage.removeItem('teamData');
      localStorage.removeItem('language');
      localStorage.removeItem('userStatus');
      localStorage.removeItem('inviteCode');
      
      // ç›´æ¥è·³è½¬åˆ°ç™»å½•é¡µé¢
      window.location.href = 'login.html';
    }
    
    // æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯

    
    // æ˜¾ç¤ºBugæŠ¥å‘Š
    function showBugReport() {
      closeSettings();
      // æ˜¾ç¤ºBugæŠ¥å‘Šå¼¹çª—
      const modal = document.getElementById('messageModal');
      modal.style.display = 'flex';
      // ç›´æ¥åˆ‡æ¢åˆ°BugæŠ¥å‘Šæ ‡ç­¾é¡µ
      switchMessageTab('bug');
    }
    
    // æ˜¾ç¤ºå…³äºä¿¡æ¯
    function showAbout() {
      closeSettings();
      showDialog('å…³äºæˆ‘ä»¬', 'è£‚é‡‘7æ—¥ H5åº”ç”¨\n\nç‰ˆæœ¬ï¼šv1.0.0\næ›´æ–°æ—¶é—´ï¼š2024å¹´1æœˆ\n\nå¼€å‘å›¢é˜Ÿè‡´åŠ›äºä¸ºç”¨æˆ·æä¾›\næœ€ä½³çš„äº’åŠ¨ä½“éªŒ');
    }

    // è®¾ç½®é¢æ¿åŠŸèƒ½å·²ç§»è‡³scriptå¼€å¤´

    // ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½
    function selectTheme(theme) {
      // ç§»é™¤æ‰€æœ‰ä¸»é¢˜æŒ‰é’®çš„activeçŠ¶æ€
      document.querySelectorAll('.theme-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      
      // æ¿€æ´»é€‰ä¸­çš„ä¸»é¢˜æŒ‰é’®
      event.target.classList.add('active');
      
      // ä¿å­˜ä¸»é¢˜è®¾ç½®
      localStorage.setItem('theme', theme);
      
      // åº”ç”¨ä¸»é¢˜ï¼ˆè¿™é‡Œå¯ä»¥æ·»åŠ å®é™…çš„ä¸»é¢˜åˆ‡æ¢é€»è¾‘ï¼‰
      showDialog('ä¸»é¢˜è®¾ç½®', `å·²åˆ‡æ¢åˆ°${theme}ä¸»é¢˜`);
    }
    
    // Toggleå¼€å…³åŠŸèƒ½
    function toggleSwitch(switchId) {
      const toggle = document.getElementById(switchId);
      const isChecked = toggle.checked;
      
      // ä¿å­˜è®¾ç½®
      localStorage.setItem(switchId, isChecked);
      
      // æ ¹æ®ä¸åŒçš„å¼€å…³æ‰§è¡Œä¸åŒçš„é€»è¾‘
      switch(switchId) {
        case 'soundToggle':
          showDialog('å£°éŸ³è®¾ç½®', isChecked ? 'å·²å¼€å¯å£°éŸ³æ•ˆæœ' : 'å·²å…³é—­å£°éŸ³æ•ˆæœ');
          break;
        case 'vibrationToggle':
          showDialog('éœ‡åŠ¨è®¾ç½®', isChecked ? 'å·²å¼€å¯éœ‡åŠ¨åé¦ˆ' : 'å·²å…³é—­éœ‡åŠ¨åé¦ˆ');
          break;
        case 'notificationToggle':
          showDialog('é€šçŸ¥è®¾ç½®', isChecked ? 'å·²å¼€å¯æ¨é€é€šçŸ¥' : 'å·²å…³é—­æ¨é€é€šçŸ¥');
          break;
      }
    }
    
    // è¯­è¨€åˆ‡æ¢åŠŸèƒ½
    function changeLanguage() {
      const select = document.getElementById('languageSelect');
      const selectedLanguage = select.value;
      const selectedText = select.options[select.selectedIndex].text;
      
      localStorage.setItem('language', selectedLanguage);
      showDialog('è¯­è¨€è®¾ç½®', `å·²åˆ‡æ¢åˆ°ï¼š${selectedText}`);
    }

    // åˆå§‹åŒ–è®¾ç½®é¢æ¿äº‹ä»¶ç›‘å¬å™¨
    function initSettingsEvents() {
      // åŠ è½½ä¿å­˜çš„è®¾ç½®
      loadSettingsFromStorage();
      
      // è¯­è¨€é€‰æ‹©å™¨äº‹ä»¶ç›‘å¬
      const languageSelect = document.getElementById('languageSelect');
      if (languageSelect) {
        languageSelect.addEventListener('change', changeLanguage);
      }
      
      // åˆå§‹åŒ–éŸ³æ•ˆå¼€å…³çŠ¶æ€
      const soundToggle = document.getElementById('soundToggle');
      if (soundToggle) {
        const savedSoundEnabled = localStorage.getItem('soundEnabled');
        if (savedSoundEnabled !== null) {
          soundEnabled = savedSoundEnabled === 'true';
          soundToggle.checked = soundEnabled;
        }
      }
      
      // ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯å…³é—­è®¾ç½®é¢æ¿
      document.addEventListener('click', function(e) {
        const settingsModal = document.getElementById('settingsModal');
        if (e.target === settingsModal) {
          closeSettings();
        }
      });
    }
    
    // ä»æœ¬åœ°å­˜å‚¨åŠ è½½è®¾ç½®
    function loadSettingsFromStorage() {
      // åŠ è½½ä¸»é¢˜è®¾ç½®
      const savedTheme = localStorage.getItem('theme') || 'light';
      const themeBtn = document.querySelector(`[onclick="selectTheme('${savedTheme}')"]`);
      if (themeBtn) {
        themeBtn.classList.add('active');
      }
      
      // åŠ è½½è¯­è¨€è®¾ç½®
      const savedLanguage = localStorage.getItem('language') || 'zh-CN';
      const languageSelect = document.getElementById('languageSelect');
      if (languageSelect) {
        languageSelect.value = savedLanguage;
      }
      
      // åŠ è½½å¼€å…³è®¾ç½®
      const switches = ['soundToggle', 'vibrationToggle', 'notificationToggle'];
      switches.forEach(switchId => {
        const toggle = document.getElementById(switchId);
        if (toggle) {
          const savedState = localStorage.getItem(switchId);
          toggle.checked = savedState === 'true';
        }
      });
    }
    
    // æ›´æ–°ä¸ªäººèµ„æ–™æ˜¾ç¤º
    function updateProfileDisplay() {
      const userEmail = localStorage.getItem('userEmail') || 'user@example.com';
      const profileEmail = document.getElementById('profileEmail');
      if (profileEmail) {
        profileEmail.textContent = userEmail;
      }
      
      // å¯ä»¥æ·»åŠ æ›´å¤šä¸ªäººä¿¡æ¯çš„æ›´æ–°é€»è¾‘
    }

    /**
     * å®Œæˆæ–°æ‰‹ä»»åŠ¡
     * @param {number} taskId - ä»»åŠ¡ID
     */
    function completeNewbieTask(taskId) {
      const task = newTasks.find(t => t.id === taskId);
      if (!task) {
        showDialog('é”™è¯¯', 'ä»»åŠ¡ä¸å­˜åœ¨ï¼', [{ text: 'ç¡®å®š', action: 'close' }], 'error');
        return false;
      }
      
      if (task.done) {
        showDialog('æç¤º', 'è¯¥ä»»åŠ¡å·²å®Œæˆï¼', [{ text: 'ç¡®å®š', action: 'close' }], 'info');
        return false;
      }
      
      // æ£€æŸ¥ä»»åŠ¡å®Œæˆæ¡ä»¶ï¼ˆæŒ‰é¡ºåºå®Œæˆï¼‰
      const taskIndex = newTasks.findIndex(t => t.id === taskId);
      if (taskIndex > 0) {
        const previousTask = newTasks[taskIndex - 1];
        if (!previousTask.done) {
          showDialog('æç¤º', 'è¯·å…ˆå®Œæˆå‰é¢çš„ä»»åŠ¡ï¼', [{ text: 'ç¡®å®š', action: 'close' }], 'info');
          return false;
        }
      }
      
      // æ ‡è®°ä»»åŠ¡å®Œæˆ
      task.done = true;
      completedNewbieTasks = newTasks.filter(t => t.done).length;
      
      // æ›´æ–°é’±åŒ…ä½™é¢
      walletBalance += task.reward;
      
      // æ·»åŠ äº¤æ˜“è®°å½•
      transactions.unshift({
        type: 'income',
        amount: task.reward,
        description: `å®Œæˆ${task.title}`,
        timestamp: new Date().toISOString()
      });
      
      // æ£€æŸ¥æ˜¯å¦è§£é”ç­”é¢˜ä»»åŠ¡
      if (completedNewbieTasks >= 1 && !quizCompleted) {
        // ç¬¬ä¸€ä¸ªæ–°æ‰‹ä»»åŠ¡å®Œæˆåè§£é”ç­”é¢˜ä»»åŠ¡
        showDialog('æ­å–œ', 'è§£é”ç­”é¢˜ä»»åŠ¡ï¼å®Œæˆç­”é¢˜å¯é™ä½æç°æ‰‹ç»­è´¹ã€‚', [{ text: 'å»ç­”é¢˜', action: () => { saveState(); window.location.href = 'quiz.html'; } }, { text: 'ç¨å', action: 'close' }], 'success');
      }
      
      // æ£€æŸ¥æ˜¯å¦è§£é”å¤§ç¥ä»»åŠ¡
      if (completedNewbieTasks >= 3 && quizCompleted && !godTasksUnlocked) {
        godTasksUnlocked = true;
        showDialog('æ­å–œ', 'è§£é”å¤§ç¥ä»»åŠ¡ï¼å®Œæˆå¤§ç¥ä»»åŠ¡å¯è·å¾—æ›´é«˜å¥–åŠ±ã€‚', [{ text: 'æŸ¥çœ‹', action: () => window.location.href = 'tasks.html?tab=master' }, { text: 'ç¨å', action: 'close' }], 'success');
      }
      
      // ç”Ÿæˆå›¢é˜Ÿæ¶ˆæ¯
      generateTeamMessage('task_complete', {
        taskName: task.title,
        reward: task.reward
      });
      
      // ä¿å­˜çŠ¶æ€å¹¶é‡æ–°æ¸²æŸ“
      saveState();
      renderState();
      
      // æ˜¾ç¤ºå®Œæˆæç¤º
      showDialog('ä»»åŠ¡å®Œæˆ', `æ­å–œå®Œæˆ"${task.title}"ï¼Œè·å¾—${task.reward}å…ƒå¥–åŠ±ï¼`, [{ text: 'ç¡®å®š', action: 'close' }], 'success');
      
      return true;
    }
    
    /**
     * å®Œæˆç­”é¢˜ä»»åŠ¡
     * @param {number} correctAnswers - æ­£ç¡®ç­”æ¡ˆæ•°é‡
     */
    function completeQuizTask(correctAnswers = 20) {
      if (quizCompleted) {
        showDialog('æç¤º', 'ç­”é¢˜ä»»åŠ¡å·²å®Œæˆï¼', [{ text: 'ç¡®å®š', action: 'close' }], 'info');
        return false;
      }
      
      // æ£€æŸ¥æ˜¯å¦å®Œæˆè‡³å°‘ä¸€ä¸ªæ–°æ‰‹ä»»åŠ¡
      if (completedNewbieTasks < 1) {
        showDialog('æç¤º', 'è¯·å…ˆå®Œæˆè‡³å°‘ä¸€ä¸ªæ–°æ‰‹ä»»åŠ¡ï¼', [{ text: 'ç¡®å®š', action: 'close' }], 'info');
        return false;
      }
      
      // æ£€æŸ¥ç­”é¢˜æ•°é‡
      if (correctAnswers < 20) {
        showDialog('æç¤º', `ç­”é¢˜æ­£ç¡®ç‡ä¸è¶³ï¼éœ€è¦ç­”å¯¹20é¢˜ï¼Œå½“å‰ç­”å¯¹${correctAnswers}é¢˜ã€‚`, [{ text: 'ç»§ç»­ç­”é¢˜', action: () => { saveState(); window.location.href = 'quiz.html'; } }, { text: 'ç¨å', action: 'close' }], 'info');
        return false;
      }
      
      // æ ‡è®°ç­”é¢˜ä»»åŠ¡å®Œæˆ
      quizCompleted = true;
      const quizTask = quizTasks[0];
      if (quizTask) {
        quizTask.done = true;
        
        // æ›´æ–°é’±åŒ…ä½™é¢
        walletBalance += quizTask.reward;
        
        // æ·»åŠ äº¤æ˜“è®°å½•
        transactions.unshift({
          type: 'income',
          amount: quizTask.reward,
          description: `å®Œæˆ${quizTask.title}`,
          timestamp: new Date().toISOString()
        });
        
        // é™ä½æç°æ‰‹ç»­è´¹
        withdrawFeeRate = Math.max(0.01, withdrawFeeRate - quizTask.feeReduction);
      }
      
      // æ£€æŸ¥æ˜¯å¦è§£é”å¤§ç¥ä»»åŠ¡
      if (completedNewbieTasks >= 3 && !godTasksUnlocked) {
        godTasksUnlocked = true;
        showDialog('æ­å–œ', 'è§£é”å¤§ç¥ä»»åŠ¡ï¼å®Œæˆå¤§ç¥ä»»åŠ¡å¯è·å¾—æ›´é«˜å¥–åŠ±ã€‚', [{ text: 'æŸ¥çœ‹', action: () => window.location.href = 'tasks.html?tab=master' }, { text: 'ç¨å', action: 'close' }], 'success');
      }
      
      // ç”Ÿæˆå›¢é˜Ÿæ¶ˆæ¯
      generateTeamMessage('task_complete', {
        taskName: 'ç­”é¢˜ä»»åŠ¡',
        reward: quizTask ? quizTask.reward : 20
      });
      
      // ä¿å­˜çŠ¶æ€å¹¶é‡æ–°æ¸²æŸ“
      saveState();
      renderState();
      
      // æ˜¾ç¤ºå®Œæˆæç¤º
      showDialog('ç­”é¢˜å®Œæˆ', `æ­å–œå®Œæˆç­”é¢˜ä»»åŠ¡ï¼Œè·å¾—${quizTask ? quizTask.reward : 20}å…ƒå¥–åŠ±ï¼æç°æ‰‹ç»­è´¹å·²é™ä½è‡³${(withdrawFeeRate * 100).toFixed(1)}%`, [{ text: 'ç¡®å®š', action: 'close' }], 'success');
      
      return true;
    }
    
    /**
     * å®Œæˆå¤§ç¥ä»»åŠ¡
     * @param {number} taskId - ä»»åŠ¡ID
     */
    function completeGodTask(taskId) {
      const task = godTasks.find(t => t.id === taskId);
      if (!task) {
        showDialog('é”™è¯¯', 'ä»»åŠ¡ä¸å­˜åœ¨ï¼', [{ text: 'ç¡®å®š', action: 'close' }], 'error');
        return false;
      }
      
      if (task.done) {
        showDialog('æç¤º', 'è¯¥ä»»åŠ¡å·²å®Œæˆï¼', [{ text: 'ç¡®å®š', action: 'close' }], 'info');
        return false;
      }
      
      // æ£€æŸ¥æ˜¯å¦è§£é”å¤§ç¥ä»»åŠ¡
      if (!godTasksUnlocked) {
        showDialog('æç¤º', 'è¯·å…ˆå®Œæˆæ‰€æœ‰æ–°æ‰‹ä»»åŠ¡å’Œç­”é¢˜ä»»åŠ¡ï¼', [{ text: 'ç¡®å®š', action: 'close' }], 'info');
        return false;
      }
      
      // æ£€æŸ¥ä»»åŠ¡å®Œæˆæ¡ä»¶ï¼ˆæŒ‰é¡ºåºå®Œæˆï¼‰
      const taskIndex = godTasks.findIndex(t => t.id === taskId);
      if (taskIndex > 0) {
        const previousTask = godTasks[taskIndex - 1];
        if (!previousTask.done) {
          showDialog('æç¤º', 'è¯·å…ˆå®Œæˆå‰é¢çš„å¤§ç¥ä»»åŠ¡ï¼', [{ text: 'ç¡®å®š', action: 'close' }], 'info');
          return false;
        }
      }
      
      // æ ‡è®°ä»»åŠ¡å®Œæˆ
      task.done = true;
      
      // æ›´æ–°é’±åŒ…ä½™é¢
      walletBalance += task.reward;
      
      // æ·»åŠ äº¤æ˜“è®°å½•
      transactions.unshift({
        type: 'income',
        amount: task.reward,
        description: `å®Œæˆ${task.title}`,
        timestamp: new Date().toISOString()
      });
      
      // ç”Ÿæˆå›¢é˜Ÿæ¶ˆæ¯
      generateTeamMessage('task_complete', {
        taskName: task.title,
        reward: task.reward
      });
      
      // ä¿å­˜çŠ¶æ€å¹¶é‡æ–°æ¸²æŸ“
      saveState();
      renderState();
      
      // æ˜¾ç¤ºå®Œæˆæç¤º
      showDialog('å¤§ç¥ä»»åŠ¡å®Œæˆ', `æ­å–œå®Œæˆ"${task.title}"ï¼Œè·å¾—${task.reward}å…ƒå¥–åŠ±ï¼`, [{ text: 'ç¡®å®š', action: 'close' }], 'success');
      
      return true;
    }
    
    /**
     * è·å–å½“å‰å¯æ‰§è¡Œçš„ä»»åŠ¡
     */
    function getAvailableTasks() {
      const available = {
        newbie: [],
        quiz: [],
        god: []
      };
      
      // æ–°æ‰‹ä»»åŠ¡ï¼šæŒ‰é¡ºåºè§£é”
      for (let i = 0; i < newTasks.length; i++) {
        const task = newTasks[i];
        if (!task.done) {
          if (i === 0 || newTasks[i - 1].done) {
            available.newbie.push(task);
            break; // åªæ˜¾ç¤ºä¸‹ä¸€ä¸ªå¯å®Œæˆçš„ä»»åŠ¡
          }
        }
      }
      
      // ç­”é¢˜ä»»åŠ¡ï¼šå®Œæˆè‡³å°‘ä¸€ä¸ªæ–°æ‰‹ä»»åŠ¡åè§£é”
      if (completedNewbieTasks >= 1 && !quizCompleted) {
        available.quiz = quizTasks.filter(t => !t.done);
      }
      
      // å¤§ç¥ä»»åŠ¡ï¼šå®Œæˆæ‰€æœ‰æ–°æ‰‹ä»»åŠ¡å’Œç­”é¢˜ä»»åŠ¡åè§£é”
      if (godTasksUnlocked) {
        for (let i = 0; i < godTasks.length; i++) {
          const task = godTasks[i];
          if (!task.done) {
            if (i === 0 || godTasks[i - 1].done) {
              available.god.push(task);
              break; // åªæ˜¾ç¤ºä¸‹ä¸€ä¸ªå¯å®Œæˆçš„ä»»åŠ¡
            }
          }
        }
      }
      
      return available;
    }
    
    /**
     * è·å–ä»»åŠ¡å®Œæˆè¿›åº¦
     */
    function getTaskProgress() {
      const newbieProgress = {
        completed: newTasks.filter(t => t.done).length,
        total: newTasks.length
      };
      
      const quizProgress = {
        completed: quizCompleted ? 1 : 0,
        total: 1
      };
      
      const godProgress = {
        completed: godTasks.filter(t => t.done).length,
        total: godTasks.length
      };
      
      return {
        newbie: newbieProgress,
        quiz: quizProgress,
        god: godProgress,
        overall: {
          completed: newbieProgress.completed + quizProgress.completed + godProgress.completed,
          total: newbieProgress.total + quizProgress.total + godProgress.total
        }
      };
    }


    


    // ==================== æ¶ˆæ¯ç³»ç»Ÿ ====================
    
    // éŸ³æ•ˆç®¡ç†
    let audioContext = null;
    let soundEnabled = true;
    
    // åˆå§‹åŒ–éŸ³æ•ˆç³»ç»Ÿ
    function initAudioSystem() {
      try {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        // ä»æœ¬åœ°å­˜å‚¨è¯»å–éŸ³æ•ˆè®¾ç½®
        const savedSoundSetting = localStorage.getItem('soundEnabled');
        if (savedSoundSetting !== null) {
          soundEnabled = JSON.parse(savedSoundSetting);
        }
      } catch (error) {
        console.warn('éŸ³æ•ˆç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥:', error);
        soundEnabled = false;
      }
    }
    
    // æ’­æ”¾æ¶ˆæ¯æç¤ºéŸ³
    function playMessageSound() {
      if (!soundEnabled) return;
      
      try {
        // åˆ›å»ºéŸ³é¢‘å…ƒç´ æ’­æ”¾é‡‘å¸å£°æ•ˆ
        const audio = new Audio('é‡‘å¸å£°æ•ˆ.mp3');
        audio.volume = 0.5; // è®¾ç½®éŸ³é‡ä¸º50%
        
        // æ’­æ”¾éŸ³æ•ˆ
        const playPromise = audio.play();
        
        // å¤„ç†æ’­æ”¾Promiseï¼ˆç°ä»£æµè§ˆå™¨è¦æ±‚ï¼‰
        if (playPromise !== undefined) {
          playPromise.catch(error => {
            console.log('éŸ³æ•ˆæ’­æ”¾å¤±è´¥:', error);
          });
        }
        
      } catch (error) {
        console.warn('æ’­æ”¾æ¶ˆæ¯éŸ³æ•ˆå¤±è´¥:', error);
      }
    }
    
    // åˆ‡æ¢éŸ³æ•ˆå¼€å…³ - å·²ç§»é™¤åŠŸèƒ½
    /*
    function toggleSound() {
      soundEnabled = !soundEnabled;
      localStorage.setItem('soundEnabled', JSON.stringify(soundEnabled));
      
      // æ›´æ–°è®¾ç½®é¢æ¿ä¸­çš„å¼€å…³çŠ¶æ€
      const soundToggle = document.querySelector('#soundToggle');
      if (soundToggle) {
        soundToggle.checked = soundEnabled;
      }
      
      // æ’­æ”¾æµ‹è¯•éŸ³æ•ˆï¼ˆå¦‚æœå¼€å¯ï¼‰
      if (soundEnabled) {
        playMessageSound();
      }
    }
    */
    
    // æ¶ˆæ¯æ•°æ®ç®¡ç†
    let messages = {
      official: [],
      team: []
    };
    
    let messageReadStatus = {};
    
    // BugæŠ¥å‘Šæ•°æ®ç®¡ç†
    let bugReports = [];
    
    // åˆå§‹åŒ–BugæŠ¥å‘Šæ•°æ®
    function initBugReports() {
      const savedBugReports = localStorage.getItem('bugReports');
      if (savedBugReports) {
        bugReports = JSON.parse(savedBugReports);
      }
    }
    
    // ä¿å­˜BugæŠ¥å‘Šæ•°æ®
    function saveBugReports() {
      localStorage.setItem('bugReports', JSON.stringify(bugReports));
    }
    
    // åˆå§‹åŒ–æ¶ˆæ¯æ•°æ®
    function initMessages() {
      const savedMessages = localStorage.getItem('messages');
      const savedReadStatus = localStorage.getItem('messageReadStatus');
      
      if (savedMessages) {
        messages = JSON.parse(savedMessages);
      } else {
        // åˆå§‹åŒ–é»˜è®¤æ¶ˆæ¯
        messages = {
          official: [
            {
              id: 'official_1',
              title: 'æ¬¢è¿åŠ å…¥å¹³å°',
              content: 'æ¬¢è¿æ‚¨åŠ å…¥æˆ‘ä»¬çš„å¹³å°ï¼å®Œæˆæ–°æ‰‹ä»»åŠ¡å¯è·å¾—ä¸°åšå¥–åŠ±ï¼Œå¿«æ¥ä½“éªŒå§ï¼',
              time: new Date(Date.now() - 2 * 60 * 60 * 1000).toISOString(),
              category: 'ç³»ç»Ÿé€šçŸ¥'
            },
            {
              id: 'official_2', 
              title: 'æŠ¢çº¢åŒ…æ´»åŠ¨å¼€å¯',
              content: 'æ¯æ—¥ä¸‰åœºçº¢åŒ…é›¨æ´»åŠ¨å·²å¼€å¯ï¼æ—¶é—´ï¼š9:00ã€12:00ã€20:00ï¼Œæ¯åœºæŒç»­77ç§’ï¼Œä¸è¦é”™è¿‡å“¦ï¼',
              time: new Date(Date.now() - 1 * 60 * 60 * 1000).toISOString(),
              category: 'æ´»åŠ¨å…¬å‘Š'
            },
            {
              id: 'official_3',
              title: 'å¹³å°å‡çº§å…¬å‘Š',
              content: 'ä¸ºäº†ç»™æ‚¨æä¾›æ›´å¥½çš„æœåŠ¡ä½“éªŒï¼Œå¹³å°å°†åœ¨ä»Šæ™š23:00-24:00è¿›è¡Œç³»ç»Ÿç»´æŠ¤å‡çº§ï¼ŒæœŸé—´å¯èƒ½å½±å“éƒ¨åˆ†åŠŸèƒ½ä½¿ç”¨ï¼Œæ•¬è¯·è°…è§£ï¼',
              time: new Date(Date.now() - 30 * 60 * 1000).toISOString(),
              category: 'ç³»ç»Ÿå…¬å‘Š'
            }
          ],
          team: [
            {
              id: 'team_1',
              title: 'å›¢é˜Ÿæ”¶ç›Šæé†’',
              content: 'æ‚¨çš„å›¢é˜Ÿä»Šæ—¥æ”¶ç›Šå·²æ›´æ–°ï¼Œå½“å‰å›¢é˜Ÿæ€»æ”¶ç›Šï¼š156.8å…ƒï¼Œç»§ç»­åŠªåŠ›ï¼',
              time: new Date(Date.now() - 45 * 60 * 1000).toISOString(),
              category: 'æ”¶ç›Šé€šçŸ¥'
            }
          ]
        };
        saveMessages();
      }
      
      if (savedReadStatus) {
        messageReadStatus = JSON.parse(savedReadStatus);
      }
    }
    
    // ä¿å­˜æ¶ˆæ¯æ•°æ®
    function saveMessages() {
      localStorage.setItem('messages', JSON.stringify(messages));
      localStorage.setItem('messageReadStatus', JSON.stringify(messageReadStatus));
    }
    
    // æ·»åŠ æ–°æ¶ˆæ¯
    function addMessage(type, messageData) {
      const message = {
        id: `${type}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
        title: messageData.title,
        content: messageData.content,
        time: new Date().toISOString(),
        category: messageData.category || 'ç³»ç»Ÿæ¶ˆæ¯'
      };
      
      messages[type].unshift(message);
      saveMessages();
      updateMessageButton();
      
      // æ’­æ”¾æ–°æ¶ˆæ¯éŸ³æ•ˆ
      playMessageSound();
      
      // è§¦å‘æ¶ˆæ¯å›¾æ ‡æŠ–åŠ¨æ•ˆæœ
      const messageIcon = document.querySelector('.message-icon');
      if (messageIcon) {
        messageIcon.classList.add('shake');
        setTimeout(() => {
          messageIcon.classList.remove('shake');
        }, 600);
      }
    }
    
    // ç”Ÿæˆå›¢é˜Ÿæ¶ˆæ¯
    function generateTeamMessage(action, data) {
      let title, content, category;
      
      switch (action) {
        case 'member_join':
          title = 'æ–°æˆå‘˜åŠ å…¥';
          content = `æ­å–œï¼æ‚¨çš„å›¢é˜Ÿæ–°å¢äº†ä¸€åæˆå‘˜ï¼Œå½“å‰å›¢é˜Ÿäººæ•°ï¼š${data.teamSize}äºº`;
          category = 'å›¢é˜ŸåŠ¨æ€';
          break;
        case 'balance_change':
          title = 'æ”¶ç›Šæ›´æ–°';
          content = `æ‚¨çš„è´¦æˆ·ä½™é¢å‘ç”Ÿå˜åŒ–ï¼Œå½“å‰ä½™é¢ï¼š${data.balance}å…ƒ`;
          category = 'æ”¶ç›Šé€šçŸ¥';
          break;
        case 'task_complete':
          title = 'ä»»åŠ¡å®Œæˆ';
          content = `æ­å–œå®Œæˆä»»åŠ¡"${data.taskName}"ï¼Œè·å¾—å¥–åŠ±${data.reward}å…ƒ`;
          category = 'ä»»åŠ¡å¥–åŠ±';
          break;
        default:
          return;
      }
      
      addMessage('team', { title, content, category });
    }
    
    // æ˜¾ç¤ºæ¶ˆæ¯å¼¹çª—
    function showMessages() {
      const modal = document.getElementById('messageModal');
      modal.style.display = 'flex';
      
      // é»˜è®¤æ˜¾ç¤ºå®˜æ–¹å…¬å‘Š
      switchMessageTab('official');
    }
    
    // éšè—æ¶ˆæ¯å¼¹çª—
    function hideMessages() {
      const modal = document.getElementById('messageModal');
      modal.style.display = 'none';
    }
    
    // å…³é—­æ¶ˆæ¯å¼¹çª—ï¼ˆä¸hideMessagesåŠŸèƒ½ç›¸åŒï¼Œç”¨äºæŒ‰é’®ç‚¹å‡»ï¼‰
    function closeMessages() {
      hideMessages();
    }
    
    // åˆ‡æ¢æ¶ˆæ¯æ ‡ç­¾é¡µ
    function switchMessageTab(type) {
      // æ›´æ–°æ ‡ç­¾æŒ‰é’®çŠ¶æ€
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      document.querySelector(`[onclick="switchMessageTab('${type}')"]`).classList.add('active');
      
      // æ›´æ–°æ¶ˆæ¯åˆ—è¡¨æ˜¾ç¤º
      document.querySelectorAll('.message-list').forEach(list => {
        list.classList.remove('active');
      });
      document.getElementById(`${type}Messages`).classList.add('active');
      
      // æ¸²æŸ“å¯¹åº”å†…å®¹
      if (type === 'bug') {
        renderBugReportList();
      } else {
        renderMessageList(type);
      }
    }
    
    // æ¸²æŸ“æ¶ˆæ¯åˆ—è¡¨
    function renderMessageList(type) {
      const container = document.getElementById(`${type}Messages`);
      const messageList = messages[type];
      
      if (messageList.length === 0) {
        container.innerHTML = `
          <div class="empty-message">
            <div class="empty-icon">ğŸ“­</div>
            <div class="empty-text">æš‚æ— ${type === 'official' ? 'å®˜æ–¹å…¬å‘Š' : 'å›¢é˜Ÿæ¶ˆæ¯'}</div>
          </div>
        `;
        return;
      }
      
      container.innerHTML = messageList.map(message => {
        const isUnread = !messageReadStatus[message.id];
        const timeStr = formatMessageTime(message.time);
        
        // ä¸ºå›¢é˜Ÿæ¶ˆæ¯æ·»åŠ åˆ é™¤æŒ‰é’®
        const deleteButton = type === 'team' ? `
          <button class="delete-message-btn" onclick="event.stopPropagation(); deleteMessage('${type}', '${message.id}')" title="åˆ é™¤æ¶ˆæ¯">
            ğŸ—‘ï¸
          </button>
        ` : '';
        
        return `
          <div class="message-item ${isUnread ? 'unread' : ''}" onclick="markMessageAsRead('${message.id}')">
            <div class="message-header-info">
              <h4 class="message-title-text">${message.title}</h4>
              <div class="message-header-right">
                <span class="message-time">${timeStr}</span>
                ${deleteButton}
              </div>
            </div>
            <p class="message-content-text">${message.content}</p>
            <span class="message-category">${message.category}</span>
          </div>
        `;
      }).join('');
    }
    
    // æ ¼å¼åŒ–æ¶ˆæ¯æ—¶é—´
    function formatMessageTime(timeStr) {
      const time = new Date(timeStr);
      const now = new Date();
      const diff = now - time;
      
      if (diff < 60 * 1000) {
        return 'åˆšåˆš';
      } else if (diff < 60 * 60 * 1000) {
        return `${Math.floor(diff / (60 * 1000))}åˆ†é’Ÿå‰`;
      } else if (diff < 24 * 60 * 60 * 1000) {
        return `${Math.floor(diff / (60 * 60 * 1000))}å°æ—¶å‰`;
      } else {
        return time.toLocaleDateString();
      }
    }
    
    // æ ‡è®°æ¶ˆæ¯ä¸ºå·²è¯»
    function markMessageAsRead(messageId) {
      messageReadStatus[messageId] = true;
      saveMessages();
      updateMessageButton();
      
      // é‡æ–°æ¸²æŸ“å½“å‰æ ‡ç­¾é¡µ
      const activeTab = document.querySelector('.tab-btn.active');
      if (activeTab) {
        const type = activeTab.onclick.toString().includes('official') ? 'official' : 'team';
        renderMessageList(type);
      }
    }
    
    // åˆ é™¤æ¶ˆæ¯åŠŸèƒ½
    function deleteMessage(type, messageId) {
      // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡æ¶ˆæ¯å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
        return;
      }

      // ä»å¯¹åº”ç±»å‹çš„æ¶ˆæ¯æ•°ç»„ä¸­æ‰¾åˆ°å¹¶åˆ é™¤æ¶ˆæ¯
      const messageList = messages[type];
      const index = messageList.findIndex(message => message.id === messageId);
      
      if (index !== -1) {
        // åˆ é™¤æ¶ˆæ¯
        messageList.splice(index, 1);
        
        // åˆ é™¤å¯¹åº”çš„å·²è¯»çŠ¶æ€
        delete messageReadStatus[messageId];
        
        // ä¿å­˜æ›´æ–°åçš„æ•°æ®
        saveMessages();
        
        // æ›´æ–°æ¶ˆæ¯æŒ‰é’®çŠ¶æ€
        updateMessageButton();
        
        // é‡æ–°æ¸²æŸ“å½“å‰æ¶ˆæ¯åˆ—è¡¨
        renderMessageList(type);
        
        // æ˜¾ç¤ºåˆ é™¤æˆåŠŸæç¤º
        alert('æ¶ˆæ¯å·²åˆ é™¤ï¼');
      } else {
        alert('æœªæ‰¾åˆ°è¦åˆ é™¤çš„æ¶ˆæ¯ï¼');
      }
    }
    
    // ä¸€é”®å·²è¯»åŠŸèƒ½ - æ ‡è®°æ‰€æœ‰æ¶ˆæ¯ä¸ºå·²è¯»
    function markAllAsRead() {
      // è·å–å½“å‰æ´»è·ƒçš„æ ‡ç­¾é¡µç±»å‹
      const activeTab = document.querySelector('.tab-btn.active');
      if (!activeTab) return;
      
      // æ£€æŸ¥æ˜¯å¦åœ¨BugæŠ¥å‘Šé¡µé¢
      if (activeTab.onclick.toString().includes('bug')) {
        // BugæŠ¥å‘Šé¡µé¢ä¸éœ€è¦å·²è¯»åŠŸèƒ½
        alert('BugæŠ¥å‘Šæ— éœ€æ ‡è®°å·²è¯»');
        return;
      }
      
      // æ ‡è®°æ‰€æœ‰å®˜æ–¹å…¬å‘Šå’Œå›¢é˜Ÿæ¶ˆæ¯ä¸ºå·²è¯»
      let totalMarked = 0;
      
      // æ ‡è®°å®˜æ–¹å…¬å‘Šä¸ºå·²è¯»
      messages.official.forEach(message => {
        if (!messageReadStatus[message.id]) {
          messageReadStatus[message.id] = true;
          totalMarked++;
        }
      });
      
      // æ ‡è®°å›¢é˜Ÿæ¶ˆæ¯ä¸ºå·²è¯»
      messages.team.forEach(message => {
        if (!messageReadStatus[message.id]) {
          messageReadStatus[message.id] = true;
          totalMarked++;
        }
      });
      
      // ä¿å­˜æ•°æ®å¹¶æ›´æ–°ç•Œé¢
      saveMessages();
      updateMessageButton();
      updateTabUnreadCount();
      
      // é‡æ–°æ¸²æŸ“å½“å‰æ˜¾ç¤ºçš„æ¶ˆæ¯åˆ—è¡¨
      const currentType = activeTab.onclick.toString().includes('team') ? 'team' : 'official';
      renderMessageList(currentType);
      
      // æ˜¾ç¤ºæˆåŠŸæç¤º
      if (totalMarked > 0) {
        alert(`å·²å°†æ‰€æœ‰æ¶ˆæ¯æ ‡è®°ä¸ºå·²è¯»ï¼ˆå…±${totalMarked}æ¡ï¼‰`);
      } else {
        alert('æ‰€æœ‰æ¶ˆæ¯å·²ç»æ˜¯å·²è¯»çŠ¶æ€');
      }
    }
    
    // æ›´æ–°æ¶ˆæ¯æŒ‰é’®çŠ¶æ€ï¼ˆç°åœ¨æ›´æ–°æ¶ˆæ¯å›¾æ ‡çŠ¶æ€ï¼‰
    function updateMessageButton() {
      const messageIcon = document.querySelector('.message-icon');
      const unreadDot = document.querySelector('#messageUnreadDot');
      
      if (!messageIcon || !unreadDot) return;
      
      // æ£€æŸ¥æ˜¯å¦æœ‰æœªè¯»æ¶ˆæ¯
      const hasUnread = [...messages.official, ...messages.team].some(msg => !messageReadStatus[msg.id]);
      
      if (hasUnread) {
        messageIcon.classList.add('has-unread');
        unreadDot.style.display = 'block';
      } else {
        messageIcon.classList.remove('has-unread');
        unreadDot.style.display = 'none';
      }
    }
    
    // æ›´æ–°æ ‡ç­¾é¡µæœªè¯»è®¡æ•°
    function updateTabUnreadCount() {
      const officialCount = messages.official.filter(msg => !messageReadStatus[msg.id]).length;
      const teamCount = messages.team.filter(msg => !messageReadStatus[msg.id]).length;
      
      // æ›´æ–°å®˜æ–¹å…¬å‘Šæ ‡ç­¾
      const officialTab = document.querySelector('[onclick="switchMessageTab(\'official\')"]');
      if (officialTab) {
        const countEl = officialTab.querySelector('.unread-count');
        if (officialCount > 0) {
          if (!countEl) {
            officialTab.innerHTML += `<span class="unread-count">${officialCount}</span>`;
          } else {
            countEl.textContent = officialCount;
          }
        } else if (countEl) {
          countEl.remove();
        }
      }
      
      // æ›´æ–°å›¢é˜Ÿæ¶ˆæ¯æ ‡ç­¾
      const teamTab = document.querySelector('[onclick="switchMessageTab(\'team\')"]');
      if (teamTab) {
        const countEl = teamTab.querySelector('.unread-count');
        if (teamCount > 0) {
          if (!countEl) {
            teamTab.innerHTML += `<span class="unread-count">${teamCount}</span>`;
          } else {
            countEl.textContent = teamCount;
          }
        } else if (countEl) {
          countEl.remove();
        }
      }
    }

    // å‘é€éšæœºå®˜æ–¹å…¬å‘Š

    
    // BugæŠ¥å‘Šç›¸å…³å‡½æ•°
    
    // æäº¤BugæŠ¥å‘Š
    function submitBugReport(event) {
      event.preventDefault();
      
      const title = document.getElementById('bugTitle').value.trim();
      const description = document.getElementById('bugDescription').value.trim();
      const type = document.getElementById('bugType').value;
      
      if (!title || !description || !type) {
        alert('è¯·å¡«å†™å®Œæ•´çš„BugæŠ¥å‘Šä¿¡æ¯');
        return;
      }
      
      const bugReport = {
        id: `bug_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
        title: title,
        description: description,
        type: type,
        time: new Date().toISOString(),
        status: 'å·²æäº¤'
      };
      
      bugReports.unshift(bugReport);
      saveBugReports();
      
      // æ¸…ç©ºè¡¨å•
      document.getElementById('bugTitle').value = '';
      document.getElementById('bugDescription').value = '';
      document.getElementById('bugType').value = '';
      
      // é‡æ–°æ¸²æŸ“BugæŠ¥å‘Šåˆ—è¡¨
      renderBugReportList();
      
      // æ˜¾ç¤ºæˆåŠŸæç¤º
      alert('BugæŠ¥å‘Šæäº¤æˆåŠŸï¼æ„Ÿè°¢æ‚¨çš„åé¦ˆã€‚');
    }
    
    // æ¸²æŸ“BugæŠ¥å‘Šåˆ—è¡¨
    function renderBugReportList() {
      const container = document.getElementById('bugReportList');
      
      if (bugReports.length === 0) {
        container.innerHTML = `
          <div class="empty-message">
            <div class="empty-icon">ğŸ›</div>
            <div class="empty-text">æš‚æ— BugæŠ¥å‘Š</div>
          </div>
        `;
        return;
      }
      
      container.innerHTML = bugReports.map(bug => {
        const timeStr = formatMessageTime(bug.time);
        
        return `
          <div class="bug-item">
            <div class="bug-item-header">
              <h5 class="bug-title">${bug.title}</h5>
              <div class="bug-header-right">
                <span class="bug-time">${timeStr}</span>
                <button class="delete-bug-btn" onclick="deleteBugReport('${bug.id}')" title="åˆ é™¤BugæŠ¥å‘Š">
                  ğŸ—‘ï¸
                </button>
              </div>
            </div>
            <p class="bug-description">${bug.description}</p>
            <span class="bug-type">${bug.type}</span>
          </div>
        `;
      }).join('');
    }
    
    // æ ¼å¼åŒ–æ—¶é—´ï¼ˆå¤ç”¨æ¶ˆæ¯ç³»ç»Ÿçš„å‡½æ•°ï¼‰
    function formatBugTime(timeStr) {
      return formatMessageTime(timeStr);
    }

    // åˆ é™¤BugæŠ¥å‘Š
    function deleteBugReport(bugId) {
      // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªBugæŠ¥å‘Šå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
        return;
      }

      // ä»æ•°ç»„ä¸­æ‰¾åˆ°å¹¶åˆ é™¤å¯¹åº”çš„BugæŠ¥å‘Š
      const index = bugReports.findIndex(bug => bug.id === bugId);
      if (index !== -1) {
        bugReports.splice(index, 1);
        
        // ä¿å­˜æ›´æ–°åçš„æ•°æ®
        saveBugReports();
        
        // é‡æ–°æ¸²æŸ“åˆ—è¡¨
        renderBugReportList();
        
        // æ˜¾ç¤ºåˆ é™¤æˆåŠŸæç¤º
        alert('BugæŠ¥å‘Šå·²åˆ é™¤ï¼');
      } else {
        alert('æœªæ‰¾åˆ°è¦åˆ é™¤çš„BugæŠ¥å‘Šï¼');
      }
    }

    // æ¶ˆæ¯å›¾æ ‡æ‹–æ‹½åŠŸèƒ½
    function initMessageIconDrag() {
      const messageIcon = document.getElementById('messageIcon');
      if (!messageIcon) return;

      let isDragging = false;
      let startY = 0;
      let startTop = 0;
      let currentY = 0;

      // æ¸…é™¤localStorageä¸­ä¿å­˜çš„ä½ç½®ï¼Œç¡®ä¿å›¾æ ‡åœ¨å·¦ä¸Šè§’
      localStorage.removeItem('messageIconTop');
      localStorage.removeItem('messageIconLeft');
      
      // ç¡®ä¿å›¾æ ‡åœ¨å·¦ä¸Šè§’ï¼Œæ¸…é™¤ä»»ä½•å†…è”æ ·å¼
      messageIcon.style.top = '';
      messageIcon.style.left = '';
      messageIcon.style.position = '';

      // é¼ æ ‡äº‹ä»¶
      messageIcon.addEventListener('mousedown', startDrag);
      document.addEventListener('mousemove', drag);
      document.addEventListener('mouseup', endDrag);

      // è§¦æ‘¸äº‹ä»¶
      messageIcon.addEventListener('touchstart', startDragTouch, { passive: false });
      document.addEventListener('touchmove', dragTouch, { passive: false });
      document.addEventListener('touchend', endDragTouch);

      function startDrag(e) {
        e.preventDefault();
        e.stopPropagation();
        isDragging = true;
        startY = e.clientY;
        startTop = parseInt(window.getComputedStyle(messageIcon).top, 10);
        messageIcon.classList.add('dragging');
      }

      function startDragTouch(e) {
        isDragging = true;
        startY = e.touches[0].clientY;
        startTop = parseInt(window.getComputedStyle(messageIcon).top, 10);
        currentY = 0; // é‡ç½®ç§»åŠ¨è·ç¦»
      }

      function drag(e) {
        if (!isDragging) return;
        e.preventDefault();
        e.stopPropagation();
        
        currentY = e.clientY - startY;
        const newTop = startTop + currentY;
        
        // è¾¹ç•Œæ£€æŸ¥
        const maxTop = window.innerHeight - messageIcon.offsetHeight;
        const constrainedTop = Math.max(0, Math.min(newTop, maxTop));
        
        // ä½¿ç”¨requestAnimationFrameä¼˜åŒ–æ€§èƒ½
        requestAnimationFrame(() => {
          messageIcon.style.top = constrainedTop + 'px';
        });
      }

      function dragTouch(e) {
        if (!isDragging) return;
        
        currentY = e.touches[0].clientY - startY;
        
        // åªæœ‰åœ¨ç§»åŠ¨è·ç¦»è¶…è¿‡é˜ˆå€¼æ—¶æ‰å¼€å§‹çœŸæ­£çš„æ‹–åŠ¨
        if (Math.abs(currentY) > 5) {
          e.preventDefault();
          e.stopPropagation();
          messageIcon.classList.add('dragging');
          
          const newTop = startTop + currentY;
          
          // è¾¹ç•Œæ£€æŸ¥
          const maxTop = window.innerHeight - messageIcon.offsetHeight;
          const constrainedTop = Math.max(0, Math.min(newTop, maxTop));
          
          // ä½¿ç”¨requestAnimationFrameä¼˜åŒ–æ€§èƒ½
          requestAnimationFrame(() => {
            messageIcon.style.top = constrainedTop + 'px';
          });
        }
      }

      function endDrag(e) {
        if (!isDragging) return;
        isDragging = false;
        messageIcon.classList.remove('dragging');
        
        // ä¿å­˜ä½ç½®åˆ°localStorage
        const finalTop = parseInt(messageIcon.style.top, 10);
        localStorage.setItem('messageIconTop', finalTop);
        
        // ç§»é™¤è‡ªåŠ¨è§¦å‘ç‚¹å‡»äº‹ä»¶çš„é€»è¾‘ï¼Œæ‹–åŠ¨åä¸è‡ªåŠ¨æ‰“å¼€æ¶ˆæ¯ä¸­å¿ƒ
      }

      function endDragTouch(e) {
        if (!isDragging) return;
        isDragging = false;
        messageIcon.classList.remove('dragging');
        
        // å¦‚æœç§»åŠ¨è·ç¦»å¾ˆå°ï¼Œè¯´æ˜æ˜¯ç‚¹å‡»è€Œä¸æ˜¯æ‹–åŠ¨
        if (Math.abs(currentY) <= 5) {
          // æ‰‹åŠ¨è§¦å‘ç‚¹å‡»äº‹ä»¶
          showMessages();
        } else {
          // ä¿å­˜ä½ç½®åˆ°localStorage
          const finalTop = parseInt(messageIcon.style.top, 10);
          localStorage.setItem('messageIconTop', finalTop);
        }
      }
    }

    // æ—¶é—´è°ƒè¯•åŠŸèƒ½
    let debugTimeOffset = 0; // è°ƒè¯•æ—¶é—´åç§»é‡ï¼ˆæ¯«ç§’ï¼‰
    


    window.onload = init;
  </script>
  <script src="public/js/global-background.js"></script>
  <script src="public/js/performance-optimization.js"></script>
</body>
</html>