# Tatum 钱包服务监控系统使用指南

## 概述

Tatum 钱包服务监控系统提供全面的系统监控、性能分析、健康检查和告警功能，帮助运维人员实时了解服务状态并及时处理异常情况。

## 功能特性

### 1. 系统监控
- **CPU 使用率监控**：实时监控 CPU 使用情况
- **内存使用率监控**：跟踪内存消耗和泄漏
- **磁盘使用率监控**：监控存储空间使用情况
- **系统负载监控**：监控系统负载平均值
- **网络连接监控**：跟踪数据库和 Redis 连接状态

### 2. 应用性能监控
- **响应时间监控**：跟踪 API 响应时间
- **请求频率统计**：监控请求量和分布
- **错误率监控**：统计和分析错误请求
- **慢查询检测**：识别性能瓶颈

### 3. 健康检查
- **数据库连接检查**：验证 MySQL 连接状态
- **Redis 连接检查**：验证 Redis 服务状态
- **Tatum API 检查**：验证外部 API 可用性
- **磁盘空间检查**：检查存储空间是否充足

### 4. 告警系统
- **多渠道通知**：支持邮件、Webhook、Slack、企业微信
- **分级告警**：警告和严重两个级别
- **告警抑制**：防止重复告警
- **告警升级**：长时间未处理的告警自动升级

## 配置说明

### 1. 监控配置

编辑 `config/monitoring.js` 文件：

```javascript
const monitoringConfig = {
    basic: {
        interval: 30000,        // 监控间隔（毫秒）
        retentionHours: 24,     // 数据保留时间（小时）
        verbose: false          // 详细日志
    },
    system: {
        cpu: {
            warning: 70,        // CPU 警告阈值
            critical: 90        // CPU 严重阈值
        },
        memory: {
            warning: 80,        // 内存警告阈值
            critical: 95        // 内存严重阈值
        }
    }
};
```

### 2. 告警配置

配置告警通道：

```javascript
const alertConfig = {
    channels: {
        email: {
            enabled: true,
            smtp: {
                host: 'smtp.gmail.com',
                port: 587,
                auth: {
                    user: 'your-email@gmail.com',
                    pass: 'your-password'
                }
            },
            recipients: ['admin@example.com']
        },
        slack: {
            enabled: true,
            webhookUrl: 'https://hooks.slack.com/...',
            channel: '#alerts'
        }
    }
};
```

### 3. 环境变量配置

在 `.env` 文件中添加：

```bash
# 告警配置
ALERT_EMAIL_ENABLED=true
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-password
ALERT_EMAIL_RECIPIENTS=admin@example.com,ops@example.com

# Slack 告警
ALERT_SLACK_ENABLED=true
SLACK_WEBHOOK_URL=https://hooks.slack.com/services/...
SLACK_CHANNEL=#alerts

# 企业微信告警
ALERT_WECHAT_ENABLED=true
WECHAT_WEBHOOK_URL=https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=...
WECHAT_MENTIONED_USERS=@all

# Webhook 告警
ALERT_WEBHOOK_ENABLED=true
ALERT_WEBHOOK_URLS=https://your-webhook-url.com/alerts
```

## API 接口

### 1. 健康检查

```bash
GET /api/monitoring/health
```

返回服务健康状态：

```json
{
    "status": "healthy",
    "timestamp": 1640995200000,
    "uptime": 3600,
    "system": {
        "cpu": 45.2,
        "memory": 67.8,
        "loadAverage": 1.2
    },
    "health": {
        "total": 4,
        "healthy": 4,
        "unhealthy": 0
    }
}
```

### 2. 监控指标

```bash
GET /api/monitoring/metrics
Authorization: Bearer <token>
```

获取详细监控指标。

### 3. 监控摘要

```bash
GET /api/monitoring/summary
Authorization: Bearer <token>
```

获取监控数据摘要。

### 4. 告警管理

```bash
# 获取告警列表
GET /api/monitoring/alerts?level=critical&limit=20

# 清除特定告警
DELETE /api/monitoring/alerts/:alertId

# 清除所有告警
DELETE /api/monitoring/alerts

# 测试告警
POST /api/monitoring/test-alert
{
    "level": "warning",
    "message": "测试告警消息"
}
```

### 5. 性能数据

```bash
GET /api/monitoring/performance?path=/api/wallet&limit=100
```

获取性能监控数据。

### 6. 监控仪表板

```bash
GET /api/monitoring/dashboard
Authorization: Bearer <token>
```

获取仪表板数据，包含所有监控信息的汇总。

## 监控仪表板

### 1. 交互式仪表板

启动实时监控仪表板：

```bash
node scripts/monitoring-dashboard.js
```

功能特性：
- 实时系统指标显示（CPU、内存、负载）
- 健康检查状态表格
- 响应时间折线图
- 请求量柱状图
- 告警列表
- 性能统计表格

快捷键：
- `q` 或 `Esc`：退出
- `r` 或 `F5`：手动刷新

### 2. 简单模式

终端表格显示模式：

```bash
node scripts/monitoring-dashboard.js --simple
```

### 3. 命令行选项

```bash
node scripts/monitoring-dashboard.js [选项]

选项:
  -u, --url <url>        API 服务地址 (默认: http://localhost:3000)
  -t, --token <token>    认证令牌
  -s, --simple           简单模式 (终端表格显示)
  -i, --interval <sec>   更新间隔秒数 (默认: 5)
  -h, --help             显示帮助信息
```

示例：

```bash
# 使用默认配置
node scripts/monitoring-dashboard.js

# 简单模式，每10秒更新
node scripts/monitoring-dashboard.js --simple --interval 10

# 连接远程服务
node scripts/monitoring-dashboard.js --url https://api.example.com --token your-jwt-token
```

## 告警规则

### 1. 系统告警

| 指标 | 警告阈值 | 严重阈值 | 说明 |
|------|----------|----------|------|
| CPU 使用率 | 70% | 90% | 持续高 CPU 使用率 |
| 内存使用率 | 80% | 95% | 内存不足或泄漏 |
| 磁盘使用率 | 80% | 90% | 存储空间不足 |
| 系统负载 | CPU核数×0.8 | CPU核数×1.2 | 系统负载过高 |

### 2. 应用告警

| 指标 | 警告阈值 | 严重阈值 | 说明 |
|------|----------|----------|------|
| 响应时间 | 1000ms | 3000ms | API 响应缓慢 |
| 错误率 | 5% | 10% | 错误请求过多 |
| 请求频率 | 1000/min | 2000/min | 请求量异常 |

### 3. 钱包服务告警

| 指标 | 警告阈值 | 严重阈值 | 说明 |
|------|----------|----------|------|
| 交易处理时间 | 30s | 120s | 交易处理缓慢 |
| 余额查询失败率 | 5% | 15% | 余额查询异常 |
| 提现失败率 | 2% | 5% | 提现功能异常 |
| API 调用失败率 | 3% | 10% | Tatum API 异常 |

## 日志管理

### 1. 监控日志

监控系统会生成以下日志文件：

- `logs/monitoring.log`：监控系统日志
- `logs/alerts.log`：告警日志
- `logs/performance.log`：性能监控日志
- `logs/health.log`：健康检查日志

### 2. 日志轮转

日志文件会自动轮转：
- 最大文件大小：10MB
- 保留文件数：5个
- 按日期模式：YYYY-MM-DD

### 3. 日志查看

```bash
# 查看监控日志
tail -f logs/monitoring.log

# 查看告警日志
tail -f logs/alerts.log

# 搜索特定告警
grep "critical" logs/alerts.log

# 查看性能日志
tail -f logs/performance.log
```

## 性能优化

### 1. 监控配置优化

```javascript
// 生产环境配置
const performanceConfig = {
    enabled: true,
    sampleRate: 0.1,        // 10% 采样率
    slowRequestThreshold: 1000,
    metrics: {
        http: {
            enabled: true,
            collectHeaders: false,  // 不收集请求头
            collectBody: false      // 不收集请求体
        }
    }
};
```

### 2. 数据清理

监控系统会自动清理过期数据：
- 性能数据保留：24小时
- 告警数据保留：24小时
- 系统指标保留：24小时

### 3. 内存管理

- 性能数据限制：最多1000条记录
- 自动清理：每小时执行一次
- 内存监控：检测内存泄漏

## 故障排除

### 1. 监控服务无法启动

检查配置文件：
```bash
node -c config/monitoring.js
```

检查依赖：
```bash
npm list nodemailer axios
```

### 2. 告警无法发送

检查邮件配置：
```bash
# 测试 SMTP 连接
node -e "
const nodemailer = require('nodemailer');
const transporter = nodemailer.createTransporter({
    host: 'smtp.gmail.com',
    port: 587,
    auth: { user: 'user', pass: 'pass' }
});
transporter.verify().then(console.log).catch(console.error);
"
```

检查 Webhook 连接：
```bash
curl -X POST https://your-webhook-url.com/test
```

### 3. 性能数据缺失

检查中间件配置：
```javascript
// 确保在 server.js 中正确配置
const { performanceMiddleware } = require('./middleware/monitoring');
app.use(performanceMiddleware);
```

### 4. 健康检查失败

检查服务依赖：
```bash
# 检查数据库连接
mysql -u root -p -e "SELECT 1"

# 检查 Redis 连接
redis-cli ping

# 检查 Tatum API
curl https://api.tatum.io/v3/tron/info
```

## 最佳实践

### 1. 监控策略

- **分层监控**：系统层、应用层、业务层
- **关键指标**：专注于影响用户体验的指标
- **告警分级**：避免告警疲劳
- **定期回顾**：调整阈值和规则

### 2. 告警管理

- **及时响应**：建立告警响应流程
- **根因分析**：记录和分析告警原因
- **预防措施**：根据告警优化系统
- **文档更新**：维护故障处理文档

### 3. 性能优化

- **采样控制**：生产环境使用适当的采样率
- **数据清理**：定期清理过期数据
- **资源限制**：控制监控系统资源消耗
- **异步处理**：告警发送使用异步方式

### 4. 安全考虑

- **访问控制**：监控接口需要认证
- **敏感信息**：不记录敏感数据
- **网络安全**：使用 HTTPS 传输
- **日志安全**：保护日志文件访问权限

## 扩展功能

### 1. 自定义指标

```javascript
// 添加自定义业务指标
monitoringService.recordCustomMetric('wallet_balance_total', totalBalance);
monitoringService.recordCustomMetric('active_users_count', activeUsers);
```

### 2. 自定义告警

```javascript
// 触发自定义告警
await monitoringService.triggerAlert(
    'custom_business_alert',
    '业务指标异常：用户余额总额下降超过10%',
    'warning'
);
```

### 3. 第三方集成

- **Prometheus**：导出指标到 Prometheus
- **Grafana**：创建可视化仪表板
- **ELK Stack**：日志聚合和分析
- **APM 工具**：应用性能监控

通过本监控系统，您可以全面了解 Tatum 钱包服务的运行状态，及时发现和处理问题，确保服务的稳定性和可靠性。