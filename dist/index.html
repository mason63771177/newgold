<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>裂金7日 H5 页面</title>
  
  <!-- Google Tag Manager -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-K7WCTWLM');</script>
  <!-- End Google Tag Manager -->
  
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-QQ6GQ79K7G"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-QQ6GQ79K7G');
  </script>
  
  <!-- PWA Manifest -->
    <link rel="manifest" href="/newgold/assets/json/manifest-CmBET5qe.json">
    
    <!-- iOS Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="裂金7日">
    
    <!-- iOS Icons -->
    <link rel="apple-touch-icon" sizes="152x152" href="图标文件/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="图标文件/icon-192x192.png">
    
    <!-- Android Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="图标文件/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="图标文件/icon-512x512.png">
    
    <!-- Splash Screens -->
    <link rel="apple-touch-startup-image" href="图标文件/splash-390x844.png" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3)">
    <link rel="apple-touch-startup-image" href="图标文件/splash-414x896.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2)">
    
    <!-- Theme Color -->
  <meta name="theme-color" content="#0b0f14">
  <meta name="msapplication-navbutton-color" content="#0b0f14">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  
  <!-- 记录页面加载开始时间 -->
  <script>
    window.loadStartTime = Date.now();
  </script>
    
  
  <style>body,html{color:var(--text-primary);font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,PingFang SC,Hiragino Sans GB,Microsoft YaHei,sans-serif;font-size:16px;height:100vh;margin:0;overflow:hidden;padding:0}.loading-screen,body,html{background:var(--bg-primary)}.loading-screen{align-items:center;display:flex;flex-direction:column;height:100%;justify-content:center;left:0;position:fixed;top:0;transition:opacity .3s ease-out;width:100%;z-index:9999}.loading-screen.hidden{opacity:0;pointer-events:none}.loading-logo{align-items:center;animation:pulse 2s ease-in-out infinite;display:flex;height:80px;justify-content:center;margin-bottom:20px;width:80px}.loading-logo img{border-radius:20px;height:100%;-o-object-fit:contain;object-fit:contain;width:100%}.loading-text{color:var(--text-secondary);font-size:16px;margin-bottom:30px}.loading-spinner{border-top:3px solid var(--border-color);border:3px solid var(--border-color);border-top-color:var(--accent-color);height:40px;width:40px}@keyframes spin{0%{transform:rotate(0deg)}to{transform:rotate(1turn)}}.app.loading{opacity:0;pointer-events:none}.app{display:flex;flex-direction:column;height:100vh;position:relative;z-index:1}.header{background:var(--bg-secondary);border-bottom:1px solid var(--border-color);flex:0 0 65px;flex-direction:column;padding-top:0;z-index:100}.header,.header-main{align-items:center;display:flex;justify-content:center;position:relative}.header-main{gap:15px;margin:0;padding:0 20px;width:100%}.status-info{align-items:center;display:none;gap:6px}.logo{background:var(--btn-gradient);-webkit-background-clip:text;background-clip:text;font-size:32px;font-weight:700;letter-spacing:1px;-webkit-text-fill-color:transparent}.logo,.logo-img{filter:var(--logo-filter)}.logo-img{height:80px;margin:0 auto;-o-object-fit:contain;object-fit:contain;width:80px}.state-label{color:var(--text-secondary);font-size:13px;font-weight:600}.message-icon{align-items:center;cursor:pointer;display:flex;height:48px;justify-content:center;left:10px!important;position:fixed!important;top:10px!important;touch-action:none;transition:all .3s ease;user-select:none;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;width:48px;z-index:101}.message-icon.dragging{cursor:grabbing;opacity:.8;transform:scale(1.1);transition:none}.message-icon:hover:not(.dragging){transform:scale(1.1)}.message-icon img,.message-icon svg{height:36px;transition:all .3s ease;width:36px}.message-icon:hover:not(.dragging) img,.message-icon:hover:not(.dragging) svg{filter:brightness(1.1)}.unread-dot{background:#f44;border:2px solid var(--bg-secondary);border-radius:50%;box-shadow:0 0 8px rgba(255,68,68,.6);height:14px;opacity:0;position:absolute;right:-3px;top:-3px;transform:scale(0);transition:all .3s ease;width:14px}.unread-dot.show{opacity:1;transform:scale(1)}.state-label{text-shadow:0 0 6px var(--accent-color)}.subtitle{color:var(--text-secondary);font-size:11px;opacity:.8}.test-btn{color:var(--accent-color);top:70px}.reset-btn,.test-btn{background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:6px;font-size:12px;padding:3px 6px;position:fixed;right:10px;z-index:998}.reset-btn{color:#ff6464;cursor:pointer;top:120px;transition:all .3s ease}.reset-btn:hover{background:linear-gradient(135deg,#ff6464,#f44);color:var(--text-primary);transform:translateY(-1px)}.settings-btn{background:hsla(0,0%,100%,.2)!important;border:1px solid hsla(0,0%,100%,.4)!important;border-radius:8px!important;box-shadow:0 2px 8px rgba(0,0,0,.3)!important;color:#fff!important;cursor:pointer!important;font-size:14px!important;opacity:.9!important;padding:6px 10px!important;position:fixed!important;right:10px!important;top:10px!important;transition:all .3s ease!important;z-index:999!important}.settings-btn:hover{background:hsla(0,0%,100%,.3)!important;border-color:hsla(0,0%,100%,.6)!important;box-shadow:0 4px 12px rgba(0,0,0,.4)!important;opacity:1!important;transform:scale(1.05)!important}.theme-demo-btn{background:var(--btn-gradient);border:none;border-radius:6px;box-shadow:var(--btn-shadow);color:var(--text-primary);cursor:pointer;font-size:12px;left:12px;padding:3px 6px;position:absolute;top:8px;transition:all .3s ease}.theme-demo-btn:hover{filter:brightness(1.1);transform:translateY(-1px)}.test-btn{cursor:pointer;transition:all .3s ease}.test-btn:hover{background:var(--btn-gradient);color:var(--text-primary)}.content{align-items:center;flex:1;overflow-x:hidden;overflow-y:auto;padding:16px 16px 100px}.card,.content{display:flex;flex-direction:column}.card{backdrop-filter:blur(16px);background:var(--bg-card);border:1px solid var(--border-color);border-radius:24px;box-shadow:var(--btn-shadow);justify-content:center;max-width:480px;padding:24px;width:100%}.section{margin-bottom:16px;position:relative}.section:last-child{margin-bottom:0}.section:not(:last-child):after{background:linear-gradient(90deg,transparent,var(--accent-color),transparent);bottom:-8px;content:"";height:1px;left:0;opacity:.4;position:absolute;right:0}.section-title{color:var(--text-secondary);font-size:16px;font-weight:600;margin-bottom:6px}.section-content{color:var(--text-primary);font-size:14px;line-height:1.4;opacity:.9}.task-list{list-style:none;margin:0;padding:0}.task-item{align-items:center;display:flex;justify-content:space-between;padding:8px 0}.task-item:not(:last-child){border-bottom:1px solid hsla(0,0%,100%,.05)}.task-title{color:#e0e5fb;flex:1;font-size:14px}.task-status{background:linear-gradient(45deg,#00eaff,#08f);border-radius:12px;box-shadow:0 0 6px rgba(0,136,255,.6);color:#031e2e;font-size:12px;padding:2px 6px}.task-status.done{background:linear-gradient(45deg,#9be15d,#00e3ae);box-shadow:0 0 6px rgba(0,227,174,.6)}.task-overview{background:linear-gradient(135deg,rgba(0,136,255,.1),rgba(0,234,255,.05));border:1px solid rgba(0,136,255,.2);border-radius:12px;margin-bottom:20px;padding:16px}.task-stats{display:grid;gap:12px;grid-template-columns:repeat(3,1fr)}.stat-item{background:hsla(0,0%,100%,.05);border:1px solid hsla(0,0%,100%,.1);border-radius:8px;padding:8px;text-align:center}.stat-label{color:var(--text-secondary);display:block;font-size:12px;margin-bottom:4px}.stat-value{color:var(--text-primary);display:block;font-size:16px;font-weight:600}.task-sections{display:flex;flex-direction:column;gap:16px}.task-section{background:hsla(0,0%,100%,.03);border:1px solid hsla(0,0%,100%,.08);border-radius:12px;padding:16px}.task-section h4{align-items:center;color:var(--text-primary);display:flex;font-size:16px;font-weight:600;gap:8px;margin:0 0 12px}.task-item.completed{background:linear-gradient(135deg,rgba(155,225,93,.15),rgba(0,227,174,.1));border-color:rgba(0,227,174,.3)}.task-item.current{background:linear-gradient(135deg,rgba(0,234,255,.15),rgba(0,136,255,.1));border-color:rgba(0,136,255,.4);box-shadow:0 0 12px rgba(0,136,255,.3)}.task-item.available{background:linear-gradient(135deg,rgba(255,193,7,.15),rgba(255,152,0,.1));border-color:rgba(255,193,7,.3)}.task-item.locked{background:hsla(0,0%,100%,.02);border-color:hsla(0,0%,100%,.05);opacity:.6}.task-info{display:flex;flex:1;flex-direction:column;gap:4px}.task-reward{color:var(--accent-color);font-size:12px;font-weight:600}.task-item.completed .task-status{background:linear-gradient(45deg,#9be15d,#00e3ae);box-shadow:0 0 6px rgba(0,227,174,.4);color:#031e2e}.task-item.current .task-status{background:linear-gradient(45deg,#00eaff,#08f);box-shadow:0 0 6px rgba(0,136,255,.4);color:#031e2e}.task-item.available .task-status{background:linear-gradient(45deg,#ffc107,#ff9800);box-shadow:0 0 6px rgba(255,193,7,.4);color:#1a1a1a}.task-item.locked .task-status{background:hsla(0,0%,100%,.1);color:var(--text-secondary)}.notification-center{max-height:400px;overflow-y:auto}.notification-item{align-items:flex-start;background:hsla(0,0%,100%,.05);border:1px solid hsla(0,0%,100%,.1);border-radius:8px;cursor:pointer;display:flex;gap:12px;margin-bottom:8px;padding:12px;transition:all .3s ease}.notification-item:hover{background:hsla(0,0%,100%,.08);transform:translateY(-1px)}.notification-item.redpacket_notification{background:linear-gradient(135deg,hsla(0,100%,71%,.1),rgba(255,193,7,.05));border-color:hsla(0,100%,71%,.3)}.notification-item.task_complete{background:linear-gradient(135deg,rgba(155,225,93,.1),rgba(0,227,174,.05));border-color:rgba(0,227,174,.3)}.notification-item.balance_update{background:linear-gradient(135deg,rgba(0,234,255,.1),rgba(0,136,255,.05));border-color:rgba(0,136,255,.3)}.notification-icon{font-size:20px;line-height:1;margin-top:2px}.notification-content{flex:1}.notification-title{color:var(--text-primary);font-size:14px;font-weight:600;margin-bottom:4px}.notification-message{color:var(--text-secondary);font-size:13px;line-height:1.4;margin-bottom:4px}.notification-time{color:var(--text-muted);font-size:11px}.no-notifications{color:var(--text-secondary);font-size:14px;padding:40px 20px;text-align:center}.floating-notification{animation:slideInRight .3s ease-out;backdrop-filter:blur(10px);background:rgba(0,0,0,.9);border:1px solid hsla(0,0%,100%,.2);border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,.5);cursor:pointer;max-width:300px;padding:16px;position:fixed;right:20px;top:20px;z-index:10000}@keyframes slideInRight{0%{opacity:0;transform:translateX(100%)}to{opacity:1;transform:translateX(0)}}.floating-notification.slide-out{animation:slideOutRight .3s ease-in forwards}@keyframes slideOutRight{0%{opacity:1;transform:translateX(0)}to{opacity:0;transform:translateX(100%)}}.floating-notification-header{align-items:center;display:flex;gap:8px;margin-bottom:8px}.floating-notification-icon{font-size:18px}.floating-notification-title{color:var(--text-primary);flex:1;font-size:14px;font-weight:600}.floating-notification-close{align-items:center;background:none;border:none;color:var(--text-secondary);cursor:pointer;display:flex;font-size:16px;height:20px;justify-content:center;padding:0;width:20px}.floating-notification-message{color:var(--text-secondary);font-size:13px;line-height:1.4}.reactivate-highlight{background:linear-gradient(135deg,hsla(0,100%,71%,.15),rgba(255,193,7,.15));border:2px solid hsla(0,100%,71%,.3);border-radius:12px;margin-bottom:16px;overflow:hidden;padding:20px;position:relative}.reactivate-highlight:before{animation:shimmer 2s infinite;background:linear-gradient(90deg,transparent,hsla(0,0%,100%,.1),transparent);content:"";height:100%;left:-100%;position:absolute;top:0;width:100%}@keyframes shimmer{0%{left:-100%}to{left:100%}}.reactivate-highlight .section-title{color:#ff6b6b;font-size:18px;font-weight:700;text-shadow:0 0 10px hsla(0,100%,71%,.5)}.reactivate-btn{background:linear-gradient(45deg,#ff6b6b,#ffc107);border:none;border-radius:25px;box-shadow:0 4px 15px hsla(0,100%,71%,.4);color:#fff;cursor:pointer;font-size:16px;font-weight:600;padding:12px 24px;text-shadow:0 1px 2px rgba(0,0,0,.3);transition:all .3s ease;width:100%}.reactivate-btn:hover{box-shadow:0 6px 20px hsla(0,100%,71%,.6);transform:translateY(-2px)}.reactivate-btn:active{transform:translateY(0)}.bottom{backdrop-filter:blur(16px);background:hsla(0,0%,100%,.06);border-radius:24px 24px 0 0;border-top:1px solid hsla(0,0%,100%,.12);bottom:0;box-shadow:inset 0 1px 0 hsla(0,0%,100%,.1),0 -4px 20px rgba(0,0,0,.1);display:flex;flex-wrap:wrap;gap:10px;left:0;margin:0 12px 12px;padding:12px 16px calc(20px + env(safe-area-inset-bottom, 0px));position:fixed;right:0;z-index:100}.bottom button{border:none;border-radius:18px;color:var(--text-primary);cursor:pointer;flex:1;font-size:13px;font-weight:700;min-height:36px;min-width:0;overflow:hidden;padding:10px 8px;position:relative;text-overflow:ellipsis;text-shadow:0 1px 2px rgba(0,0,0,.25);transition:all .15s cubic-bezier(.4,0,.2,1);white-space:nowrap}.bottom button,.bottom button.primary{background:var(--btn-gradient);border:1px solid hsla(0,0%,100%,.15);box-shadow:var(--btn-shadow)}.bottom button.primary{font-size:15px;font-weight:800;min-height:52px;padding:17px 14px}.bottom button.financial{background:var(--btn-gradient);border:1px solid hsla(0,0%,100%,.2);box-shadow:var(--btn-shadow);font-weight:800;position:relative}.bottom button.financial:before{content:"🔒";filter:drop-shadow(0 1px 2px rgba(0,0,0,.3));font-size:11px;opacity:.9;position:absolute;right:6px;top:3px}.bottom button.gaming{background:var(--btn-gradient);border:1px solid hsla(0,0%,100%,.15);box-shadow:var(--btn-shadow);position:relative}.bottom button.secondary{background-image:linear-gradient(135deg,#78909c,#546e7a,#455a64);border:1px solid hsla(0,0%,100%,.1);box-shadow:0 4px 20px rgba(120,144,156,.25),inset 0 1px 0 hsla(0,0%,100%,.25),0 2px 8px rgba(0,0,0,.1);font-size:13px}.bottom.many-buttons{gap:10px;justify-content:center;padding:16px 18px calc(26px + env(safe-area-inset-bottom, 0px))}.bottom.many-buttons button{border-radius:16px;flex:0 1 calc(33.333% - 7px);font-size:12px;margin:2px;min-height:44px;padding:14px 10px}.bottom button.blue,.bottom button.green,.bottom button.orange,.bottom button.purple,.bottom button.red{background:var(--btn-gradient);box-shadow:var(--btn-shadow),var(--btn-glow)}.bottom button:disabled{animation:none!important;cursor:default;filter:grayscale(.8) brightness(.7);opacity:.4;transform:none!important}.bottom button:not(:disabled):hover{filter:brightness(1.2) saturate(1.15);transform:translateY(-6px) scale(1.03);transition:all .2s cubic-bezier(.4,0,.2,1)}.bottom button.primary:not(:disabled):hover{animation:none;box-shadow:0 14px 40px rgba(74,144,226,.6),inset 0 1px 0 hsla(0,0%,100%,.5),0 5px 20px rgba(0,0,0,.25),0 0 0 1px rgba(74,144,226,.4)}.bottom button.financial:not(:disabled):hover{box-shadow:0 12px 36px rgba(212,175,55,.5),inset 0 1px 0 hsla(0,0%,100%,.55),0 4px 18px rgba(0,0,0,.25),0 0 0 1px rgba(212,175,55,.4)}.bottom button.gaming:not(:disabled):hover{animation:none;box-shadow:0 14px 40px rgba(156,39,176,.6),inset 0 1px 0 hsla(0,0%,100%,.45),0 5px 20px rgba(0,0,0,.25),0 0 0 1px rgba(156,39,176,.5)}.bottom button.secondary:not(:disabled):hover{box-shadow:0 8px 28px rgba(120,144,156,.4),inset 0 1px 0 hsla(0,0%,100%,.35),0 3px 14px rgba(0,0,0,.15)}.bottom button:not(:disabled):active{filter:brightness(.85) saturate(1.1);transform:translateY(-2px) scale(.97);transition:all .08s ease}@media (hover:none) and (pointer:coarse){.bottom button:not(:disabled):active{filter:brightness(.9);transform:scale(.95);transition:all .1s ease}}@keyframes countdownPulse{0%,to{box-shadow:0 8px 32px rgba(47,128,237,.2),inset 0 1px 0 hsla(0,0%,100%,.1)}50%{box-shadow:0 12px 40px rgba(47,128,237,.3),inset 0 1px 0 hsla(0,0%,100%,.15)}}@keyframes rotate{0%{transform:rotate(0deg)}to{transform:rotate(1turn)}}@keyframes blink{0%,to{opacity:1}50%{opacity:.3}}@keyframes urgentPulse{0%,to{border-color:#ff453a;box-shadow:0 8px 32px rgba(255,69,58,.3),inset 0 1px 0 hsla(0,0%,100%,.1)}50%{border-color:#ff6961;box-shadow:0 12px 40px rgba(255,69,58,.5),inset 0 1px 0 hsla(0,0%,100%,.15)}}@keyframes urgentBlink{0%,to{opacity:1}50%{opacity:.1}}@keyframes slideRight{0%{transform:translateX(-100%)}to{transform:translateX(400%)}}@media (max-width:480px){.countdown-container{margin:0 -4px 16px!important;padding:16px!important}.countdown-container .time-display{font-size:28px!important;letter-spacing:1px!important}.countdown-container .progress-ring,.countdown-container .progress-ring svg{height:70px!important;width:70px!important}.countdown-container .progress-ring circle{r:30!important;stroke-dasharray:188!important}.countdown-container .time-area{gap:12px!important}.countdown-container #countdownStatus{font-size:11px!important;padding:6px 10px!important}.grid-stats{gap:8px!important;grid-template-columns:1fr!important}.grid-stats,.stat-item{font-size:11px!important}.stat-item{padding:8px!important}.stat-value{font-size:13px!important}}@media (max-width:360px){.countdown-container{padding:12px!important}.countdown-container .time-display{font-size:24px!important}.countdown-container .progress-ring,.countdown-container .progress-ring svg{height:60px!important;width:60px!important}.countdown-container .progress-ring circle{r:25!important;stroke-dasharray:157!important}.countdown-container .time-labels{font-size:10px!important;gap:8px!important}}.bottom button[data-key=inviteNew],.bottom button[data-key=invite]{box-shadow:0 12px 32px rgba(86,204,242,.55),inset 0 1px 0 hsla(0,0%,100%,.3)}.bottom button.primary-highlight{animation:pulse-glow 2s ease-in-out infinite!important;background:linear-gradient(135deg,#0f8,#0c6,#094)!important;border:2px solid rgba(0,255,136,.6)!important;box-shadow:0 8px 24px rgba(0,255,136,.4),0 4px 12px rgba(0,204,102,.3),inset 0 1px 0 hsla(0,0%,100%,.4)!important;font-size:18px!important;font-weight:700!important;padding:16px 24px!important}.bottom button.primary-highlight:hover{box-shadow:0 12px 32px rgba(0,255,136,.5),0 6px 16px rgba(0,204,102,.4),inset 0 1px 0 hsla(0,0%,100%,.5)!important;transform:translateY(-4px)!important}@keyframes pulse-glow{0%,to{box-shadow:0 8px 24px rgba(0,255,136,.4),0 4px 12px rgba(0,204,102,.3),inset 0 1px 0 hsla(0,0%,100%,.4)}50%{box-shadow:0 12px 32px rgba(0,255,136,.6),0 6px 16px rgba(0,204,102,.5),inset 0 1px 0 hsla(0,0%,100%,.5)}}.dialog{align-items:center;backdrop-filter:blur(8px);background:rgba(0,0,0,.7);bottom:0;display:flex;justify-content:center;left:0;opacity:0;position:fixed;right:0;top:0;transition:all .3s cubic-bezier(.4,0,.2,1);visibility:hidden;z-index:1000}.dialog.show{opacity:1;visibility:visible}.dialog .dialog-box{background:var(--bg-card);border:1px solid var(--border-color);border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,.3),0 8px 24px rgba(0,0,0,.2);color:var(--text-primary);max-width:85%;min-width:280px;overflow:hidden;padding:28px 32px;position:relative;transform:scale(.7) translateY(20px);transition:all .4s cubic-bezier(.34,1.56,.64,1)}.dialog.show .dialog-box{transform:scale(1) translateY(0)}.dialog .dialog-box:before{background:linear-gradient(90deg,transparent,hsla(0,0%,100%,.1),transparent);content:"";height:100%;left:-100%;position:absolute;top:0;transition:left .6s;width:100%}.dialog.show .dialog-box:before{left:100%}.dialog .dialog-box h3{font-size:20px;font-weight:600;margin:0 0 16px;text-align:center}.payment-dialog{align-items:center;backdrop-filter:blur(12px);background:rgba(0,0,0,.8);bottom:0;display:flex;justify-content:center;left:0;opacity:0;position:fixed;right:0;top:0;transition:all .4s cubic-bezier(.4,0,.2,1);visibility:hidden;z-index:1001}.payment-dialog.show{opacity:1;visibility:visible}.payment-dialog .payment-box{background:linear-gradient(145deg,var(--bg-card),hsla(0,0%,100%,.05));border:2px solid rgba(47,128,237,.3);border-radius:24px;box-shadow:0 24px 80px rgba(0,0,0,.4),0 12px 32px rgba(0,0,0,.3);color:var(--text-primary);max-width:90%;overflow:hidden;padding:32px;position:relative;transform:scale(.8) translateY(30px);transition:all .5s cubic-bezier(.34,1.56,.64,1);width:400px}.payment-dialog.show .payment-box{transform:scale(1) translateY(0)}.payment-dialog .payment-box:before{animation:payment-border-glow 3s ease-in-out infinite;background:linear-gradient(45deg,var(--brand),var(--brand-2),var(--brand));border-radius:24px;bottom:-2px;content:"";left:-2px;position:absolute;right:-2px;top:-2px;z-index:-1}@keyframes payment-border-glow{0%,to{opacity:.5}50%{opacity:1}}.payment-header{margin-bottom:24px;position:relative;text-align:center}.payment-header h3{background:linear-gradient(135deg,var(--brand),var(--brand-2));-webkit-background-clip:text;font-size:22px;font-weight:700;margin:0 0 8px;-webkit-text-fill-color:transparent;background-clip:text}.payment-amount{animation:amount-pulse 2s ease-in-out infinite;color:#0f8;font-size:32px;font-weight:800;margin:8px 0;text-shadow:0 0 20px rgba(0,255,136,.3)}@keyframes amount-pulse{0%,to{transform:scale(1)}50%{transform:scale(1.05)}}.payment-field{margin-bottom:16px}.payment-field:last-child{margin-bottom:0}.payment-label{color:var(--text-secondary);display:block;font-size:14px;font-weight:600;margin-bottom:6px}.payment-value{align-items:center;background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:12px;display:flex;font-family:Courier New,monospace;font-size:14px;gap:8px;padding:12px 16px;word-break:break-all}.copy-btn{background:var(--brand);border:none;border-radius:8px;color:#fff;cursor:pointer;flex-shrink:0;font-size:12px;padding:6px 12px;transition:all .2s ease}.copy-btn:hover{background:var(--brand-2);transform:translateY(-1px)}.qr-container{background:#fff;border:2px solid var(--border-color);border-radius:16px;margin:20px 0;padding:20px;text-align:center}.qr-code{align-items:center;background:#f8f9fa;border-radius:12px;color:#666;display:flex;font-size:14px;height:200px;justify-content:center;margin:0 auto;width:200px}.countdown-container{background:linear-gradient(135deg,hsla(0,100%,71%,.1),rgba(255,193,7,.1));border:1px solid hsla(0,100%,71%,.2);border-radius:12px;margin:20px 0;padding:16px;text-align:center}.countdown-label{color:var(--text-secondary);font-size:14px;margin-bottom:8px}.countdown-time{color:#ff6b6b;font-family:Courier New,monospace;font-size:24px;font-weight:700;text-shadow:0 0 10px hsla(0,100%,71%,.3)}.payment-actions{display:flex;gap:12px;margin-top:24px}.payment-btn{border:none;border-radius:12px;cursor:pointer;flex:1;font-size:16px;font-weight:600;overflow:hidden;padding:14px 20px;position:relative;transition:all .3s ease}.payment-btn.primary{background:linear-gradient(135deg,var(--brand),var(--brand-2));box-shadow:0 8px 24px rgba(47,128,237,.3);color:#fff}.payment-btn.primary:hover{box-shadow:0 12px 32px rgba(47,128,237,.4);transform:translateY(-2px)}.payment-btn.secondary{background:var(--bg-secondary);border:1px solid var(--border-color);color:var(--text-primary)}.payment-btn.secondary:hover{background:var(--bg-card);transform:translateY(-1px)}.payment-status{border-radius:8px;font-size:14px;font-weight:500;margin-top:16px;padding:12px;text-align:center}.payment-status.waiting{background:rgba(255,193,7,.1);border:1px solid rgba(255,193,7,.2);color:#ffc107}.payment-status.success{background:rgba(40,167,69,.1);border:1px solid rgba(40,167,69,.2);color:#28a745}.payment-status.error{background:rgba(220,53,69,.1);border:1px solid rgba(220,53,69,.2);color:#dc3545}.payment-info{background:rgba(47,128,237,.1);border:1px solid rgba(47,128,237,.2);border-radius:16px;margin-bottom:20px;padding:20px}.amount-section,.countdown-section,.order-section,.qr-section,.wallet-section{margin-bottom:16px}.amount-section:last-child,.countdown-section:last-child,.order-section:last-child,.qr-section:last-child,.wallet-section:last-child{margin-bottom:0}.amount-label,.countdown-label,.order-label,.qr-label,.wallet-label{color:var(--text-secondary);display:block;font-size:14px;font-weight:600;margin-bottom:8px}.amount-value{animation:amount-pulse 2s ease-in-out infinite;color:#0f8;font-size:32px;font-weight:800;text-align:center;text-shadow:0 0 20px rgba(0,255,136,.3)}.wallet-address{background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:12px;font-family:Courier New,monospace;font-size:14px;margin-bottom:8px;padding:12px 16px;word-break:break-all}.qr-code{background:#fff;border:2px solid var(--border-color);border-radius:16px;margin:16px 0;padding:20px;text-align:center}.countdown-timer{color:#ff6b6b;font-size:24px;font-weight:700;text-align:center;text-shadow:0 0 10px hsla(0,100%,71%,.3)}.countdown-timer,.order-id{font-family:Courier New,monospace}.order-id{background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:12px;font-size:14px;padding:12px 16px;word-break:break-all}.status-indicator{align-items:center;background:rgba(255,193,7,.1);border:1px solid rgba(255,193,7,.2);border-radius:8px;color:#ffc107;display:flex;font-size:14px;font-weight:500;gap:8px;justify-content:center;padding:12px}.loading-spinner{animation:spin 1s linear infinite;border:2px solid rgba(255,193,7,.3);border-radius:50%;border-top-color:#ffc107;height:16px;width:16px}.payment-tips{background:rgba(255,193,7,.1);border:1px solid rgba(255,193,7,.2);border-radius:12px;margin-top:16px;padding:16px}.payment-tips p{color:var(--text-secondary);font-size:14px;margin:8px 0}.payment-tips p:first-child{margin-top:0}.payment-tips p:last-child{margin-bottom:0}.close-btn{align-items:center;background:none;border:none;border-radius:50%;color:var(--text-secondary);cursor:pointer;display:flex;font-size:24px;height:32px;justify-content:center;padding:4px;position:absolute;right:16px;top:16px;transition:all .2s ease;width:32px}.close-btn:hover{background:hsla(0,0%,100%,.1);color:var(--text-primary)}.modal{align-items:flex-start;background:transparent;display:flex;height:auto;justify-content:flex-start;left:20px;padding:0;position:fixed;top:20px;width:auto;z-index:1000}.modal-content{background:var(--bg-card);border:1px solid var(--border-color);border-radius:16px;box-shadow:0 8px 32px rgba(0,0,0,.3);max-height:90vh;overflow-y:auto;padding:24px;position:relative}.modal-close{align-items:center;background:none;border:none;border-radius:50%;color:var(--text-secondary);cursor:pointer;display:flex;flex-shrink:0;font-size:20px;height:32px;justify-content:center;padding:4px;transition:all .2s ease;width:32px}.modal-close:hover{background:hsla(0,0%,100%,.1);color:var(--text-primary)}.settings-panel{padding:0}.settings-header{border-bottom:2px solid var(--border-color);margin-bottom:24px;padding-bottom:20px;text-align:center}.settings-header h2{color:var(--text-primary);font-size:20px;font-weight:700;margin:0}.profile-card{align-items:center;background:linear-gradient(135deg,var(--brand),var(--brand-2));border-radius:16px;box-shadow:0 8px 24px rgba(47,128,237,.2);display:flex;gap:16px;margin-bottom:24px;padding:20px}.profile-avatar{flex-shrink:0}.avatar-circle{align-items:center;backdrop-filter:blur(10px);background:hsla(0,0%,100%,.2);border-radius:50%;display:flex;font-size:24px;height:50px;justify-content:center;width:50px}.profile-info{color:#fff;flex:1}.profile-name{font-size:16px;font-weight:600;margin-bottom:4px}.profile-code{font-size:13px;opacity:.9}.profile-level{flex-shrink:0}.level-badge{backdrop-filter:blur(10px);background:hsla(0,0%,100%,.2);border-radius:20px;color:#fff;font-size:12px;font-weight:600;padding:6px 12px}.settings-section{margin-bottom:24px}.settings-section h3{color:var(--text-primary);font-size:16px;font-weight:600;margin:0 0 12px}.settings-card{background:var(--bg-card);border:1px solid var(--border-color);border-radius:12px;overflow:hidden}.setting-item{align-items:center;border-bottom:1px solid var(--border-color);display:flex;padding:16px 20px;transition:background-color .2s ease}.setting-item:last-child{border-bottom:none}.setting-item.clickable{cursor:pointer}.setting-item.clickable:hover{background:rgba(47,128,237,.05)}.setting-info{flex:1}.setting-title{color:var(--text-primary);display:block;font-size:15px;font-weight:500;margin-bottom:2px}.setting-desc{display:block;font-size:13px}.arrow,.setting-desc{color:var(--text-secondary)}.arrow{font-size:18px;font-weight:700}.theme-btn{align-items:center;background:var(--brand);border:none;border-radius:8px;color:#fff;cursor:pointer;display:flex;font-size:14px;gap:8px;padding:8px 16px;transition:all .2s ease}.theme-btn:hover{box-shadow:0 4px 12px rgba(47,128,237,.3);transform:translateY(-1px)}.theme-preview{background:linear-gradient(45deg,#ff6b6b,#4ecdc4,#45b7d1);border-radius:4px;height:16px;width:16px}.modern-select{background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:8px;color:var(--text-primary);cursor:pointer;font-size:14px;min-width:140px;padding:8px 12px;transition:all .2s ease}.modern-select:focus{border-color:var(--brand);box-shadow:0 0 0 3px rgba(47,128,237,.1);outline:none}.toggle-switch{display:inline-block;height:28px;position:relative;width:50px}.toggle-switch input{height:0;opacity:0;width:0}.toggle-slider{background-color:#ccc;border-radius:28px;bottom:0;cursor:pointer;left:0;position:absolute;right:0;top:0;transition:.3s}.toggle-slider:before{background-color:#fff;border-radius:50%;bottom:4px;box-shadow:0 2px 4px rgba(0,0,0,.2);content:"";height:20px;left:4px;position:absolute;transition:.3s;width:20px}input:checked+.toggle-slider{background-color:var(--brand)}input:checked+.toggle-slider:before{transform:translateX(22px)}.action-btn{background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:6px;color:var(--text-primary);cursor:pointer;font-size:13px;padding:6px 12px;transition:all .2s ease}.action-btn:hover{background:var(--brand);border-color:var(--brand);color:#fff}.danger-zone{margin:32px 0 24px}.danger-zone h3{color:#ff6b6b;font-size:16px;font-weight:600;margin:0 0 12px}.danger-card{background:hsla(0,100%,71%,.05);border:1px solid hsla(0,100%,71%,.2);border-radius:12px;padding:20px}.danger-warning{align-items:flex-start;background:hsla(0,100%,71%,.1);border-radius:8px;display:flex;gap:12px;margin-bottom:16px;padding:12px}.warning-icon{flex-shrink:0;font-size:20px}.warning-text{color:var(--text-secondary);font-size:13px;line-height:1.4}.danger-btn{background:linear-gradient(135deg,#ff6b6b,#ee5a52);border:none;border-radius:8px;box-shadow:0 4px 12px hsla(0,100%,71%,.3);color:#fff;cursor:pointer;font-size:15px;font-weight:600;padding:12px 24px;transition:all .2s ease;width:100%}.danger-btn:hover{box-shadow:0 6px 16px hsla(0,100%,71%,.4);transform:translateY(-2px)}.danger-btn:active{transform:translateY(0)}.settings-footer{border-top:2px solid var(--border-color);margin-top:32px;padding-top:20px;text-align:center}.back-btn{background:linear-gradient(135deg,#4a90e2,#357abd);border:none;border-radius:10px;box-shadow:0 4px 12px rgba(74,144,226,.3);color:#fff;cursor:pointer;font-size:16px;font-weight:600;min-width:200px;padding:14px 32px;transition:all .2s ease}.back-btn:hover{box-shadow:0 6px 16px rgba(74,144,226,.4);transform:translateY(-2px)}.back-btn:active{transform:translateY(0)}.settings-select:focus{border-color:var(--brand);box-shadow:0 0 0 2px rgba(47,128,237,.2);outline:none}.dialog .dialog-box p{font-size:16px;line-height:1.6;margin:0 0 24px;text-align:center;white-space:pre-line}.dialog .dialog-box button{background:linear-gradient(135deg,var(--btn-primary),#06c);border:none;border-radius:12px;box-shadow:0 4px 16px rgba(0,102,204,.3);color:#fff;cursor:pointer;font-size:16px;font-weight:600;margin:0 6px;overflow:hidden;padding:14px 28px;position:relative;transition:all .3s cubic-bezier(.4,0,.2,1)}.dialog .dialog-box button:hover{box-shadow:0 8px 24px rgba(0,102,204,.4);transform:translateY(-2px)}.dialog .dialog-box button:active{box-shadow:var(--btn-shadow);color:var(--text-primary);cursor:pointer;font-weight:600;margin:0 5px;transform:translateY(0)}.dialog .dialog-box .secondary-btn{background:linear-gradient(135deg,#95a5a6,#7f8c8d);color:#fff}.dialog .dialog-box .danger-btn{background:linear-gradient(135deg,#e74c3c,#c0392b);color:#fff}#dialogButtons{display:flex;gap:12px;justify-content:center;margin-top:20px}.dialog.success .dialog-box{background:linear-gradient(135deg,var(--bg-card) 0,rgba(0,255,136,.05) 100%);border:2px solid rgba(0,255,136,.3);box-shadow:0 20px 60px rgba(0,255,136,.2),0 8px 24px rgba(0,0,0,.2)}.dialog.success .dialog-box h3{color:#0f8;text-shadow:0 0 10px rgba(0,255,136,.3)}.dialog.success .dialog-box:after{animation:celebrate .6s ease-out;content:"🎉";font-size:24px;position:absolute;right:-10px;top:-10px}@keyframes celebrate{0%{opacity:0;transform:scale(0) rotate(0deg)}50%{opacity:1;transform:scale(1.2) rotate(180deg)}to{opacity:1;transform:scale(1) rotate(1turn)}}.dialog.success .dialog-box:before{background:linear-gradient(90deg,transparent,rgba(0,255,136,.2),transparent)}.dialog.success .dialog-box{animation:successPulse 2s ease-in-out infinite}@keyframes successPulse{0%,to{box-shadow:0 20px 60px rgba(0,255,136,.2),0 8px 24px rgba(0,0,0,.2)}50%{box-shadow:0 20px 60px rgba(0,255,136,.4),0 8px 24px rgba(0,255,136,.1)}}.dialog.success button{background:linear-gradient(135deg,#0f8,#0c6);box-shadow:0 4px 16px rgba(0,255,136,.4)}.dialog.success button:hover{box-shadow:0 8px 24px rgba(0,255,136,.6);transform:translateY(-3px)}.invite-highlight{background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:16px;box-shadow:var(--btn-glow);margin-top:12px;padding:12px}.invite-highlight .section-title{color:var(--accent-color)}.invite-link-container{align-items:center;display:flex;gap:8px}.invite-link-container input{flex:1;min-width:0}.invite-link-container button:hover{background:linear-gradient(135deg,#45a049,#3d8b40)!important;box-shadow:0 2px 4px rgba(0,0,0,.2);transform:translateY(-1px)}@media (max-width:768px){body,html{font-size:18px}.state-label{font-size:15px!important}.subtitle{font-size:13px!important}.bottom button,.btn,button{font-size:16px!important}.setting-title{font-size:17px!important}.setting-desc{font-size:15px!important}.modern-select,.theme-btn{font-size:16px!important}.reset-btn,.settings-btn,.test-btn{font-size:14px!important}.test-buttons{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}.test-btn.small{font-size:12px;min-width:60px;padding:6px 12px}.section-title{font-size:18px!important}.detail-row,.info,.txn-item{font-size:16px!important}.caption,.note{font-size:14px!important}#countdown,.countdown{font-size:26px!important}.amount,.balance,.price,.value{font-size:20px!important}#myInviteCode{font-size:18px!important}#inviteLink,.stats-card,button[onclick*=copy]{font-size:13px!important}.task-item{font-size:14px!important}.status-badge{font-size:12px!important}.countdown-container span[style*="font-size: 11px"]{font-size:14px!important}.countdown-container div[style*="font-size: 9px"]{font-size:12px!important}.countdown-container span[style*="font-size: 10px"]{font-size:13px!important}.grid-stats .stat-item div[style*="color: var(--text-secondary)"]{font-size:14px!important}.grid-stats .stat-value{font-size:16px!important}div[style*="font-size: 12px"][style*="💎 我的专属邀请码"],div[style*="font-size: 12px"][style*="🔗 邀请链接"]{font-size:15px!important}[style*="font-size: 9px"]{font-size:12px!important}[style*="font-size: 10px"]{font-size:13px!important}[style*="font-size: 11px"]{font-size:14px!important}[style*="font-size: 12px"]{font-size:15px!important}}.message-header{align-items:center;border-bottom:1px solid var(--border-color);display:flex;justify-content:space-between;padding:20px 20px 16px}.message-title{color:var(--text-primary);font-size:18px;font-weight:600;margin:0}.header-actions{gap:16px}.header-actions,.mark-all-read-btn-header{align-items:center;display:flex;flex-shrink:0}.mark-all-read-btn-header{background:rgba(47,128,237,.1);border:1px solid rgba(47,128,237,.2);border-radius:6px;color:var(--brand);cursor:pointer;font-size:13px;font-weight:500;height:28px;justify-content:center;min-width:36px;padding:6px 12px;transition:all .2s ease;white-space:nowrap}.mark-all-read-btn-header:hover{background:rgba(47,128,237,.15);border-color:rgba(47,128,237,.3);transform:translateY(-1px)}.mark-all-read-btn-header:active{background:rgba(47,128,237,.2);transform:translateY(0)}.message-tabs{background:var(--bg-secondary);border-radius:8px;display:flex;gap:4px;margin:16px 20px;padding:4px}.tab-btn{align-items:center;background:transparent;border:none;border-radius:6px;color:var(--text-secondary);cursor:pointer;display:flex;flex:1;font-size:14px;font-weight:500;gap:8px;justify-content:center;padding:12px 16px;position:relative;transition:all .2s ease}.tab-btn.active{background:var(--brand);box-shadow:0 2px 8px rgba(47,128,237,.3);color:#fff}.tab-btn:hover:not(.active){background:rgba(47,128,237,.1);color:var(--brand)}.message-actions{display:flex;justify-content:center;padding:0 20px 16px}.mark-all-read-btn{background:linear-gradient(135deg,#28a745,#20c997);border:none;border-radius:20px;box-shadow:0 2px 8px rgba(40,167,69,.3);color:#fff;cursor:pointer;font-size:13px;font-weight:500;padding:8px 16px;transition:all .2s ease}.mark-all-read-btn:hover{box-shadow:0 4px 12px rgba(40,167,69,.4);transform:translateY(-1px)}.mark-all-read-btn:active{transform:translateY(0)}.unread-count{align-items:center;background:#ff4757;border-radius:10px;color:#fff;display:flex;font-size:11px;font-weight:600;height:16px;justify-content:center;line-height:1;min-width:16px;padding:2px 6px}.message-content{height:400px;overflow-y:auto;padding:0 20px 20px}.message-list{display:none}.message-list.active{display:block}.empty-message{align-items:center;color:var(--text-secondary);display:flex;flex-direction:column;height:200px;justify-content:center}.empty-icon{font-size:48px;margin-bottom:12px;opacity:.6}.empty-text{font-size:14px;opacity:.8}.message-item{background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:12px;margin-bottom:12px;padding:16px;position:relative;transition:all .2s ease}.message-item:hover{box-shadow:0 4px 12px rgba(0,0,0,.1);transform:translateY(-1px)}.message-item.unread{background:rgba(47,128,237,.05);border-left:4px solid var(--brand)}.message-item.unread:before{background:#ff4757;border-radius:50%;content:"";height:8px;position:absolute;right:16px;top:16px;width:8px}.message-header-info{align-items:flex-start;display:flex;justify-content:space-between;margin-bottom:8px}.message-title-text{color:var(--text-primary);font-size:15px;font-weight:600;line-height:1.3;margin:0}.message-time{color:var(--text-secondary);font-size:12px;margin-left:12px;white-space:nowrap}.message-content-text{color:var(--text-secondary);font-size:14px;line-height:1.5;margin:0}.message-category{background:rgba(47,128,237,.1);border-radius:12px;color:var(--brand);display:inline-block;font-size:11px;font-weight:500;margin-top:8px;padding:2px 8px}@keyframes messageFlash{0%,to{background:var(--btn-gradient);box-shadow:0 2px 6px var(--accent-shadow);transform:scale(1)}50%{background:linear-gradient(45deg,#ff6b6b,#4ecdc4);box-shadow:0 4px 16px hsla(0,100%,71%,.4);transform:scale(1.05)}}.message-flash{animation:messageFlash 1.5s ease-in-out infinite}.bug-report-form{background:var(--bg-secondary);border-radius:12px;margin-bottom:20px;padding:20px}.bug-report-form h4{color:var(--text-primary);font-size:16px;font-weight:600;margin:0 0 16px}.form-group{margin-bottom:16px}.form-group label{color:var(--text-primary);display:block;font-size:14px;font-weight:500;margin-bottom:6px}.form-group input,.form-group select,.form-group textarea{background:hsla(0,0%,100%,.05);border:1px solid hsla(0,0%,100%,.1);border-radius:8px;box-sizing:border-box;color:var(--text-primary);font-size:14px;padding:10px 12px;transition:all .2s ease;width:100%}.form-group input:focus,.form-group select:focus,.form-group textarea:focus{border-color:var(--brand);box-shadow:0 0 0 2px rgba(47,128,237,.2);outline:none}.submit-bug-btn{background:linear-gradient(135deg,#ff6b6b,#ee5a52);border:none;border-radius:20px;box-shadow:0 2px 8px hsla(0,100%,71%,.3);color:#fff;cursor:pointer;font-size:14px;font-weight:500;padding:10px 20px;transition:all .2s ease;width:100%}.submit-bug-btn:hover{box-shadow:0 4px 12px hsla(0,100%,71%,.4);transform:translateY(-1px)}.bug-list-section{margin-top:20px}.bug-list-section h4{color:var(--text-primary);font-size:16px;font-weight:600;margin:0 0 12px}.bug-item{background:hsla(0,0%,100%,.05);border-left:3px solid #ff6b6b;border-radius:8px;margin-bottom:8px;padding:12px}.bug-item-header{align-items:flex-start;display:flex;justify-content:space-between;margin-bottom:8px}.bug-header-right{align-items:center;display:flex;gap:8px}.delete-bug-btn{align-items:center;background:hsla(0,100%,71%,.2);border:none;border-radius:4px;color:#ff6b6b;cursor:pointer;display:flex;font-size:14px;height:24px;justify-content:center;min-width:24px;padding:4px 6px;transition:all .2s ease}.delete-bug-btn:hover{background:hsla(0,100%,71%,.3);transform:scale(1.1)}.delete-bug-btn:active{transform:scale(.95)}.delete-message-btn{align-items:center;background:hsla(0,100%,71%,.2);border:none;border-radius:4px;color:#ff6b6b;cursor:pointer;display:flex;font-size:14px;height:24px;justify-content:center;margin-left:8px;min-width:24px;padding:4px 6px;transition:all .2s ease}.delete-message-btn:hover{background:hsla(0,100%,71%,.3);transform:scale(1.1)}.delete-message-btn:active{transform:scale(.95)}.message-header-right{align-items:center;display:flex;gap:8px}.bug-title{color:var(--text-primary);font-size:14px;font-weight:600;margin:0}.bug-time{font-size:12px}.bug-description,.bug-time{color:var(--text-secondary)}.bug-description{font-size:13px;line-height:1.4;margin:8px 0}.bug-type{background:hsla(0,100%,71%,.2);border-radius:12px;color:#ff6b6b;display:inline-block;font-size:11px;font-weight:500;padding:2px 8px}.bottom button[data-key=message]{position:relative}.bottom button[data-key=message].has-unread:after{animation:pulse 2s infinite;background:#ff4757;border:2px solid var(--bg-primary);border-radius:50%;content:"";height:8px;position:absolute;right:-2px;top:-2px;width:8px}@keyframes pulse{0%{opacity:1;transform:scale(1)}50%{opacity:.7;transform:scale(1.2)}to{opacity:1;transform:scale(1)}}</style>
  <link rel="stylesheet" crossorigin href="/newgold/assets/css/main-Z8MB1XKE.css">
  <link rel="stylesheet" crossorigin href="/newgold/assets/css/themes-Cd7cymCc.css">
  <link rel="stylesheet" crossorigin href="/newgold/assets/css/global-background-D97W4UkV.css">
</head>
<body>
  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-K7WCTWLM"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->
  
  <!-- 加载屏幕 -->
  <div id="loadingScreen" class="loading-screen">
    <div class="loading-logo">
      <img src="/newgold/assets/images/logo_gold7-BN-9ArRY.png" alt="裂金7日挑战" />
    </div>
    <div class="loading-text">正在加载...</div>
    <div class="loading-spinner"></div>
  </div>
  
  <div id="app" class="app loading">
    <!-- 消息图标 - 移到最外层避免flex布局影响 -->
    <div id="messageIcon" class="message-icon" onclick="showMessages()">
      <img src="/newgold/assets/images/message_optimized-mflW0grP.png" alt="消息" width="36" height="36" />
      <div id="messageUnreadDot" class="unread-dot" style="display: none;"></div>
    </div>
    
    <div class="header">
      <div class="header-main">
        <!-- 放大的logo -->
        <img src="/newgold/assets/images/logo_gold7-BN-9ArRY.png" alt="Logo" class="logo-img" />
        <div class="status-info">
          <div id="stateLabel" class="state-label">状态1</div>
          <div id="subtitle" class="subtitle">欢迎加入裂金7日</div>
        </div>
      </div>
      <button class="settings-btn" onclick="console.log('设置按钮被点击'); openSettings();">⚙️</button>
    </div>
    <div class="content">
      <div id="card" class="card">
        <!-- 动态内容将在这里注入 -->
      </div>
    </div>
    <div id="bottomButtons" class="bottom">
      <!-- 底部按钮动态生成 -->
    </div>
  </div>
  <!-- 模态弹窗 -->
  <div id="modal" class="modal" style="display:none;">
    <div class="modal-content">
      <button id="modalClose" class="modal-close">✕</button>
      <div id="modalBody"></div>
    </div>
  </div>
  <div id="dialog" class="dialog" style="display:none;">
    <div class="dialog-box">
      <h3 id="dialogTitle">提示</h3>
      <p id="dialogMsg">内容</p>
      <div id="dialogButtons">
        <button onclick="closeDialog()">确定</button>
      </div>
    </div>
  </div>

  <!-- 设置面板 -->
  <div id="settingsModal" class="modal" style="display:none;">
    <div class="modal-content" style="max-width: 420px; width: 95%; max-height: 90vh; overflow-y: auto;">
      <button class="modal-close" onclick="closeSettings()">✕</button>
      <div class="settings-panel">
        <!-- 标题 -->
        <div class="settings-header">
          <h2>⚙️ 设置中心</h2>
        </div>
        
        <!-- 个人资料卡片 -->
        <div class="profile-card">
          <div class="profile-avatar">
            <div class="avatar-circle">👤</div>
          </div>
          <div class="profile-info">
            <div class="profile-name" id="userEmailDisplay">未登录</div>
            <div class="profile-code">邀请码：<span id="userInviteCodeDisplay">-</span></div>
          </div>
        </div>

        <!-- 外观设置 -->
        <div class="settings-section">
          <h3>🎨 外观设置</h3>
          <div class="settings-card">

            <div class="setting-item">
              <div class="setting-info">
                <span class="setting-title">🌐 语言</span>
                <span class="setting-desc">选择界面显示语言</span>
              </div>
              <select id="languageSelect" class="modern-select">
                <option value="zh-CN" selected>🇨🇳 简体中文</option>
                <option value="zh-TW">🇨🇳 繁體中文</option>
                <option value="en-US">🇺🇸 English</option>
                <option value="ja-JP">🇯🇵 日本語</option>
                <option value="ko-KR">🇰🇷 한국어</option>
                <option value="th-TH">🇹🇭 ไทย</option>
                <option value="hi-IN">🇮🇳 हिन्दी</option>
                <option value="vi-VN">🇻🇳 Tiếng Việt</option>
                <option value="km-KH">🇰🇭 ខ្មែរ</option>
                <option value="ru-RU">🇷🇺 Русский</option>
                <option value="mn-MN">🇲🇳 Монгол</option>
                <option value="my-MM">🇲🇲 မြန်မာ</option>
                <option value="lo-LA">🇱🇦 ລາວ</option>
                <option value="ar-SA">🇸🇦 العربية</option>
              </select>
            </div>
          </div>
        </div>

        <!-- 功能设置 -->
        <div class="settings-section">
          <h3>🔧 功能设置</h3>
          <div class="settings-card">



            <div class="setting-item">
              <div class="setting-info">
                <span class="setting-title">🔄 状态切换</span>
                <span class="setting-desc">切换用户状态进行测试</span>
              </div>
              <select id="stateSelect" class="modern-select" onchange="switchToState(this.value)">
                <option value="">选择状态</option>
                <option value="1">状态1 - 新手未入金</option>
                <option value="2">状态2 - 新手已入金</option>
                <option value="3">状态3 - 本期挑战结束</option>
              </select>
            </div>

          </div>
        </div>

        <!-- 帮助与支持 -->
        <div class="settings-section">
          <h3>❓ 帮助与支持</h3>
          <div class="settings-card">

            <div class="setting-item clickable" onclick="showBugReport()">
              <div class="setting-info">
                <span class="setting-title">🐛 Bug报告</span>
                <span class="setting-desc">提交Bug报告和问题反馈</span>
              </div>
              <span class="arrow">›</span>
            </div>
            <div class="setting-item clickable" onclick="showAbout()">
              <div class="setting-info">
                <span class="setting-title">ℹ️ 关于我们</span>
                <span class="setting-desc">版本信息和开发团队</span>
              </div>
              <span class="arrow">›</span>
            </div>
          </div>
        </div>

        <!-- 危险操作区域 -->
        <div class="danger-zone">
          <div class="danger-card">
            <button class="danger-btn" onclick="confirmLogout()">
              🚪 退出登录
            </button>
          </div>
        </div>

        <!-- 返回按钮 -->
        <div class="settings-footer">
          <button class="back-btn" onclick="closeSettings()">
            ← 返回主页
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- 消息弹窗 -->
  <div id="messageModal" class="modal" style="display:none;">
    <div class="modal-content" style="max-width: 420px; width: 95%; max-height: 80vh; overflow: hidden;">
      <div class="message-header">
        <h3 class="message-title">💬 消息中心</h3>
        <div class="header-actions">
          <button class="mark-all-read-btn-header" onclick="markAllAsRead()" title="标记所有消息为已读">
            ✓
          </button>
          <button class="modal-close" onclick="closeMessages()">✕</button>
        </div>
      </div>
      
      <!-- 标签页切换 -->
      <div class="message-tabs">
        <button class="tab-btn active" onclick="switchMessageTab('official')" id="officialTab">
          📢 官方公告
          <span class="unread-count" id="officialUnreadCount" style="display:none;">0</span>
        </button>
        <button class="tab-btn" onclick="switchMessageTab('team')" id="teamTab">
          👥 团队消息
          <span class="unread-count" id="teamUnreadCount" style="display:none;">0</span>
        </button>
        <button class="tab-btn" onclick="switchMessageTab('bug')" id="bugTab">
          🐛 Bug报告
        </button>
      </div>
      
      <!-- 消息列表容器 -->
      <div class="message-content">
        <!-- 官方公告列表 -->
        <div id="officialMessages" class="message-list active">
          <div class="empty-message">
            <div class="empty-icon">📭</div>
            <div class="empty-text">暂无官方公告</div>
          </div>
        </div>
        
        <!-- 团队消息列表 -->
        <div id="teamMessages" class="message-list">
          <div class="empty-message">
            <div class="empty-icon">👥</div>
            <div class="empty-text">暂无团队消息</div>
          </div>
        </div>
        
        <!-- Bug报告列表 -->
        <div id="bugMessages" class="message-list">
          <div class="bug-report-form">
            <h4>🐛 提交Bug报告</h4>
            <form onsubmit="submitBugReport(event)">
              <div class="form-group">
                <label for="bugTitle">Bug标题：</label>
                <input type="text" id="bugTitle" placeholder="请简要描述遇到的问题" required>
              </div>
              <div class="form-group">
                <label for="bugDescription">详细描述：</label>
                <textarea id="bugDescription" rows="4" placeholder="请详细描述问题的具体情况、复现步骤等" required></textarea>
              </div>
              <div class="form-group">
                <label for="bugType">问题类型：</label>
                <select id="bugType" required>
                  <option value="">请选择问题类型</option>
                  <option value="功能异常">功能异常</option>
                  <option value="界面显示">界面显示</option>
                  <option value="性能问题">性能问题</option>
                  <option value="其他">其他</option>
                </select>
              </div>
              <button type="submit" class="submit-bug-btn">📝 提交报告</button>
            </form>
          </div>
          
          <div class="bug-list-section">
            <h4>📋 已提交的Bug报告</h4>
            <div id="bugReportList">
              <div class="empty-message">
                <div class="empty-icon">🐛</div>
                <div class="empty-text">暂无Bug报告</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // 设置面板功能 - 提前定义确保onclick可以找到
    function openSettings() {
      console.log('openSettings函数被调用');
      const settingsModal = document.getElementById('settingsModal');
      console.log('settingsModal元素:', settingsModal);
      
      if (!settingsModal) {
        console.error('找不到settingsModal元素');
        alert('设置面板元素未找到，请刷新页面重试');
        return;
      }
      
      settingsModal.style.display = 'flex';
      console.log('设置面板已显示');
      
      // 更新个人信息显示
      updateSettingsInfo();
      
      // 加载保存的设置
      loadSettingsFromStorage();
    }

    function closeSettings() {
      const settingsModal = document.getElementById('settingsModal');
      settingsModal.style.display = 'none';
    }

    function updateSettingsInfo() {
      const userEmail = localStorage.getItem('userEmail') || '未登录';
      const userInviteCode = localStorage.getItem('userInviteCode') || '-';
      const currentLanguage = localStorage.getItem('language') || 'zh-CN';
      
      document.getElementById('userEmailDisplay').textContent = userEmail;
      document.getElementById('userInviteCodeDisplay').textContent = userInviteCode;
      document.getElementById('languageSelect').value = currentLanguage;
    }

    /* 状态数据与逻辑定义 */
    // 从 localStorage 加载应用状态
    const appState = JSON.parse(localStorage.getItem('appState') || '{}');
    
    const STATES = {
      1: {
        name: '状态1',
        subtitle: '新手未入金',
        card: function() {
          return `
            <div class="section reactivate-highlight">
              <div class="section-title">激活账号</div>
              <div class="section-content" style="margin-bottom: 16px;">立即入金100 USDT，开启168小时挑战期，解锁任务系统和收益机会。</div>
              <button class="reactivate-btn" onclick="activateAccount()">立即激活 100 USDT</button>
            </div>
            <div class="section">
              <div class="section-title">收益预览</div>
              <div class="section-content">查看前10名收益排行榜，了解潜在收益机会。</div>
              <button onclick="showRanking()" style="margin-top: 12px; padding: 8px 16px; background: var(--btn-gradient); color: white; border: none; border-radius: 8px; font-size: 14px; cursor: pointer; width: 100%; font-weight: 500; box-shadow: 0 2px 6px var(--accent-shadow); transition: all 0.2s ease;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px var(--accent-shadow-hover)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 6px var(--accent-shadow)'">查看排行榜</button>
            </div>
          `;
        },
        buttons: []
      },
      2: {
        name: '状态2',
        subtitle: '168小时倒计时中',
        card: function() {
          // 当前新手任务：只显示尚未完成的第一个任务
          const currentTask = newTasks.find(t => !t.done);
          let taskSection;
          if (currentTask) {
            taskSection = `
            <div class="section">
              <div class="section-title">当前任务</div>
              <div class="section-content">${currentTask.title}</div>
            </div>
            `;
          } else {
            taskSection = `
            <div class="section">
              <div class="section-title">当前任务</div>
              <div class="section-content">所有新手任务已完成</div>
            </div>
            `;
          }
          const completedTasks = newTasks.filter(t => t.done).length;
          
          // 可接的任务区域：显示所有未完成的新手任务
          const availableTasks = newTasks.filter(t => !t.done);
          let availableTasksSection = '';
          if (availableTasks.length > 0) {
            availableTasksSection = `
            <div class="section" style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; padding: 8px; margin-bottom: 8px; cursor: pointer;" onclick="window.location.href='tasks.html'">
              <div class="section-title" style="font-size: 14px; font-weight: bold; color: var(--accent-color); margin-bottom: 6px;">📋 可接的任务</div>
              <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">点击查看详细任务列表</div>
              <div style="display: flex; flex-direction: column; gap: 4px;">
                ${availableTasks.map(task => `
                  <div style="display: flex; justify-content: space-between; align-items: center; padding: 4px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                    <span style="font-size: 12px; color: var(--text);">${task.title}</span>
                    <span style="font-size: 10px; padding: 2px 6px; background: linear-gradient(45deg, #00eaff, #0088ff); color: #031e2e; border-radius: 8px;">待完成</span>
                  </div>
                `).join('')}
              </div>
            </div>
            `;
          }
          
          // 答题任务区域：完成至少一个新手任务后出现，且未完成答题任务
          const firstDone = newTasks[0] && newTasks[0].done;
          const quizCorrect = parseInt(localStorage.getItem('quizCorrect')) || 0;
          const quizCompleted = appState.quizCompleted || false;
          let quizSection = '';
          if (firstDone && !quizCompleted) {
            quizSection = `
            <div class="section" style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; padding: 8px; margin-bottom: 8px; box-shadow: var(--btn-glow); cursor: pointer;" onclick="window.location.href='quiz.html'">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <div style="font-size: 14px; font-weight: bold; color: var(--accent-color); margin-bottom: 2px;">📝 答题任务</div>
                  <div style="font-size: 12px; color: var(--text-secondary);">降低提现手续费</div>
                </div>
                <div style="text-align: right;">
                  <div style="font-size: 12px; color: var(--text-secondary);">进度</div>
                  <div style="font-weight: bold; color: var(--accent-color);">进度: ${appState.quizCompleted ? '已完成' : '进行中'}</div>
                </div>
              </div>
            </div>
            `;
          }
          
          // 大神任务区域：完成所有新手任务且完成答题任务后显示
          const allNewTasksCompleted = newTasks.every(task => task.done);
          let masterTasksSection = '';
          if (allNewTasksCompleted && quizCompleted) {
            // 获取大神任务完成状态
            const godTasksCompleted = parseInt(localStorage.getItem('godTasksCompleted')) || 0;
            const currentMasterTask = godTasks.find(task => !task.done);
            
            masterTasksSection = `
            <div class="section" style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; padding: 8px; margin-bottom: 8px; box-shadow: var(--btn-glow); cursor: pointer;" onclick="window.location.href='tasks.html?tab=master'">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <div style="font-size: 14px; font-weight: bold; color: var(--accent-color); margin-bottom: 2px;">🏆 大神任务</div>
                  <div style="font-size: 12px; color: var(--text-secondary);">${currentMasterTask ? currentMasterTask.title : '所有大神任务已完成'}</div>
                </div>
                <div style="text-align: right;">
                  <div style="font-size: 12px; color: var(--text-secondary);">进度</div>
                  <div style="font-weight: bold; color: var(--accent-color);">${godTasksCompleted}/6</div>
                </div>
              </div>
            </div>
            `;
          }
          
          return `
            <!-- 优化后的倒计时区域 -->
            <div class="section" style="margin-bottom: 16px;">
              <div class="countdown-container" style="
                background: linear-gradient(135deg, var(--bg-secondary) 0%, rgba(47, 128, 237, 0.1) 100%);
                border: 2px solid var(--accent-color);
                border-radius: 10px;
                padding: 6px 10px;
                position: relative;
                overflow: hidden;
                box-shadow: 0 8px 32px rgba(47, 128, 237, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.1);
                animation: countdownPulse 3s ease-in-out infinite;
              ">
                
                <!-- 倒计时主体 -->
                <div style="position: relative; z-index: 2;">
                  <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 4px;">
                    <div style="display: flex; align-items: center; gap: 4px;">
                      <div style="
                        width: 5px;
                        height: 5px;
                        background: var(--accent-color);
                        border-radius: 50%;
                        animation: blink 1.5s ease-in-out infinite;
                      "></div>
                      <span style="font-size: 11px; color: var(--accent-color); font-weight: 600;">⚡ 挑战倒计时</span>
                    </div>
                    <div style="
                      background: rgba(47, 128, 237, 0.2);
                      padding: 1px 4px;
                      border-radius: 6px;
                      font-size: 9px;
                      color: var(--accent-color);
                      font-weight: 500;
                    ">168小时挑战</div>
                  </div>
                  
                  <!-- 时间显示区域 -->
                  <div class="time-area" style="display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 6px; margin-bottom: 2px;">
                    <!-- 时间数字 -->
                    <div style="text-align: center;">
                      <div class="time-display" style="
                        font-size: 28px;
                        font-weight: 700;
                        color: var(--accent-color);
                        text-shadow: 0 0 20px rgba(47, 128, 237, 0.5);
                        font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
                        letter-spacing: 1px;
                        margin-bottom: 2px;
                      ">
                        <span id="countdown">--:--:--</span>
                      </div>
                    </div>
                    
                    <!-- 直线进度条 -->
                    <div style="width: 100%; margin-top: 4px;">
                      <div style="
                        width: 100%;
                        height: 4px;
                        background: rgba(47, 128, 237, 0.2);
                        border-radius: 2px;
                        overflow: hidden;
                        position: relative;
                      ">
                        <div 
                          id="countdownProgress" 
                          style="
                            height: 100%;
                            width: 100%;
                            background: var(--accent-color);
                            border-radius: 2px;
                            transition: width 1s ease-in-out;
                            box-shadow: 0 0 12px rgba(109, 213, 237, 0.6), 0 0 24px rgba(109, 213, 237, 0.3);
                            margin-left: auto;
                            position: relative;
                            overflow: hidden;
                          "
                        >
                          <div style="
                            position: absolute;
                            top: 0;
                            left: 0;
                            width: 30%;
                            height: 100%;
                            background: linear-gradient(90deg, transparent 0%, rgba(255, 255, 255, 0.3) 50%, transparent 100%);
                            animation: slideRight 3s linear infinite;
                          "></div>
                        </div>
                      </div>
                      <div style="
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        margin-top: 2px;
                        font-size: 10px;
                        color: var(--text-secondary);
                      ">
                        <span id="remainingDays" style="color: var(--accent-color); font-weight: 600;">剩余 -- 天</span>
                      </div>
                    </div>
                  </div>
                  
                  <!-- 状态提示 -->
                  <div id="countdownStatus" style="
                    text-align: center;
                    font-size: 12px;
                    color: var(--text-secondary);
                    background: rgba(47, 128, 237, 0.1);
                    padding: 8px 12px;
                    border-radius: 12px;
                    border: 1px solid rgba(47, 128, 237, 0.2);
                    display: none;
                  ">
                  </div>
                </div>
              </div>
            </div>
            
            <!-- 邀请链接区域 -->
            <div class="section invite-highlight" style="margin-bottom: 16px;">
              <div class="section-title">邀请链接</div>
              <div class="section-content">
                <!-- 专属邀请码区域 -->
                <div style="margin-bottom: 12px; padding: 12px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 10px; box-shadow: 0 2px 8px var(--accent-shadow);">
                  <div style="font-size: 12px; color: var(--accent-color); margin-bottom: 8px; text-align: center; font-weight: 500;">💎 我的专属邀请码</div>
                  <div style="display: flex; align-items: center; gap: 8px;">
                    <div style="flex: 1; font-weight: bold; color: var(--accent-color); font-size: 16px; text-align: center; padding: 10px; background: var(--input-bg); border-radius: 8px; border: 1px solid var(--border-color); box-shadow: inset 0 1px 3px var(--accent-shadow);" id="myInviteCode">--</div>
                    <button onclick="copyInviteCode()" style="padding: 10px 16px; background: var(--btn-gradient); color: white; border: none; border-radius: 8px; font-size: 11px; cursor: pointer; white-space: nowrap; font-weight: 600; box-shadow: 0 2px 6px var(--accent-shadow); transition: all 0.2s ease;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px var(--accent-shadow-hover)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 6px var(--accent-shadow)'">复制码</button>
                  </div>
                </div>
                
                <!-- 邀请链接区域 -->
                <div style="padding: 12px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 10px; box-shadow: 0 2px 8px var(--accent-shadow);">
                  <div style="font-size: 12px; color: var(--accent-color); margin-bottom: 8px; text-align: center; font-weight: 500;">🔗 邀请链接</div>
                  <div class="invite-link-container" style="display: flex; gap: 8px;">
                    <input type="text" id="inviteLink" value="https://gold7.com/invite?code=--" readonly style="flex: 1; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--input-bg); font-size: 11px; color: var(--accent-color); box-shadow: inset 0 1px 3px var(--accent-shadow);">
                    <button onclick="copyInviteLink()" style="padding: 10px 16px; background: var(--btn-gradient); color: white; border: none; border-radius: 8px; font-size: 11px; cursor: pointer; white-space: nowrap; font-weight: 600; box-shadow: 0 2px 6px var(--accent-shadow); transition: all 0.2s ease;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px var(--accent-shadow-hover)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 6px var(--accent-shadow)'">复制链接</button>
                  </div>
                </div>
              </div>
            </div>
            
            ${availableTasksSection}
            ${quizSection}
            ${masterTasksSection}
            
            <!-- 战绩卡区域 - 移动到最下方 -->
            <div class="section" style="margin-bottom: 16px;">
              <div style="
                background: var(--bg-secondary); 
                border-radius: 16px; 
                padding: 16px;
                border: 1px solid rgba(47, 128, 237, 0.1);
                box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
              ">
                <div style="
                  font-size: 14px; 
                  color: var(--accent-color); 
                  margin-bottom: 12px; 
                  text-align: center;
                  font-weight: 600;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  gap: 8px;
                ">
                  <span>🏆</span>
                  <span>我的战绩</span>
                </div>
                <div class="grid-stats" style="
                   display: grid;
                   grid-template-columns: 1fr 1fr;
                   gap: 12px;
                   font-size: 12px;
                   line-height: 1.4;
                 ">
                   <!-- 新手任务卡片 - 增强版 -->
                   <div class="stat-item" style="
                     background: rgba(47, 128, 237, 0.05);
                     padding: 12px;
                     border-radius: 12px;
                     border: 1px solid rgba(47, 128, 237, 0.1);
                     position: relative;
                     transition: all 0.2s ease;
                   " onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 6px 20px rgba(47, 128, 237, 0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                     <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                       <div style="color: var(--text-secondary); font-size: 11px;">📚 新手任务</div>
                       <div style="font-size: 10px; color: var(--accent-color); font-weight: 500;">
                         ${completedTasks === 3 ? '✅ 已完成' : '进行中'}
                       </div>
                     </div>
                     <div class="stat-value" style="color: var(--accent-color); font-weight: bold; font-size: 16px; margin-bottom: 4px;">
                       <span id="taskProgress">${completedTasks}</span>/3
                       <span style="font-size: 12px; color: var(--text-secondary); margin-left: 4px;">
                         (${Math.round(completedTasks/3*100)}%)
                       </span>
                     </div>
                     <div style="
                       width: 100%;
                       height: 4px;
                       background: rgba(47, 128, 237, 0.1);
                       border-radius: 2px;
                       overflow: hidden;
                       margin-bottom: 4px;
                     ">
                       <div style="
                         width: ${completedTasks/3*100}%;
                         height: 100%;
                         background: var(--accent-color);
                         border-radius: 2px;
                         transition: width 0.3s ease;
                       "></div>
                     </div>
                     <div style="font-size: 10px; color: var(--text-secondary);">
                       ${completedTasks < 3 ? `还需完成 ${3-completedTasks} 个任务` : '🎉 全部完成！'}
                     </div>
                   </div>
                   
                   <!-- 答题进度卡片 - 增强版 -->
                   <div class="stat-item" style="
                     background: rgba(47, 128, 237, 0.05);
                     padding: 12px;
                     border-radius: 12px;
                     border: 1px solid rgba(47, 128, 237, 0.1);
                     position: relative;
                     transition: all 0.2s ease;
                   " onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 6px 20px rgba(47, 128, 237, 0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                     <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                       <div style="color: var(--text-secondary); font-size: 11px;">🧠 答题进度</div>
                       <div style="font-size: 10px; color: var(--accent-color); font-weight: 500;">
                         ${quizCorrect >= 16 ? '✅ 通过' : (completedTasks >= 1 ? '可答题' : '🔒 未解锁')}
                       </div>
                     </div>
                     <div class="stat-value" style="color: var(--accent-color); font-weight: bold; font-size: 16px; margin-bottom: 4px;">
                       ${quizCorrect}/20
                       <span style="font-size: 12px; color: var(--text-secondary); margin-left: 4px;">
                         (${Math.round(quizCorrect/20*100)}%)
                       </span>
                     </div>
                     <div style="
                       width: 100%;
                       height: 4px;
                       background: rgba(47, 128, 237, 0.1);
                       border-radius: 2px;
                       overflow: hidden;
                       margin-bottom: 4px;
                     ">
                       <div style="
                         width: ${quizCorrect/20*100}%;
                         height: 100%;
                         background: var(--accent-color);
                         border-radius: 2px;
                         transition: width 0.3s ease;
                       "></div>
                     </div>
                     <div style="font-size: 10px; color: var(--text-secondary);">
                       ${completedTasks < 1 ? '需完成新手任务1解锁' : (quizCorrect < 16 ? `需答对 ${16-quizCorrect} 题通过` : '🎁 非固定已手续费永久已降低至1%')}
                     </div>
                   </div>
                   
                   <!-- 团队人数卡片 - 增强版 -->
                   <div class="stat-item" style="
                     background: rgba(47, 128, 237, 0.05);
                     padding: 12px;
                     border-radius: 12px;
                     border: 1px solid rgba(47, 128, 237, 0.1);
                     position: relative;
                     transition: all 0.2s ease;
                   " onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 6px 20px rgba(47, 128, 237, 0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                     <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                       <div style="color: var(--text-secondary); font-size: 11px;">👥 团队规模</div>
                       <div style="font-size: 10px; color: var(--success-color); font-weight: 500;">
                         ${teamMembers > 0 ? '↗️ 增长中' : '待发展'}
                       </div>
                     </div>
                     <div class="stat-value" style="color: var(--accent-color); font-weight: bold; font-size: 16px; margin-bottom: 4px;">
                       <span id="teamCount">${teamMembers}</span>人
                     </div>
                     <div style="font-size: 10px; color: var(--text-secondary); margin-bottom: 4px;">
                       ${teamMembers < 2 ? '距离大神任务一还需' + (2-teamMembers) + '人' : '已达成大神任务一条件 🎯'}
                     </div>
                     <div style="font-size: 10px; color: var(--text-secondary);">
                       💡 邀请更多好友加入团队
                     </div>
                   </div>
                   
                   <!-- 总收益卡片 - 增强版 -->
                   <div class="stat-item" style="
                     background: rgba(40, 167, 69, 0.1);
                     padding: 12px;
                     border-radius: 12px;
                     border: 1px solid rgba(40, 167, 69, 0.2);
                     position: relative;
                     transition: all 0.2s ease;
                   " onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 6px 20px rgba(40, 167, 69, 0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                     <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                       <div style="color: var(--text-secondary); font-size: 11px;">💰 总收益</div>
                       <div style="font-size: 10px; color: var(--success-color); font-weight: 500;">
                         ${totalEarnings > 0 ? '📈 盈利中' : '待激活'}
                       </div>
                     </div>
                     <div class="stat-value" style="color: var(--success-color); font-weight: bold; font-size: 16px; margin-bottom: 4px;">
                       <span id="totalEarnings">${totalEarnings.toFixed(2)}</span> USDT
                     </div>
                     <div style="font-size: 10px; color: var(--text-secondary); margin-bottom: 2px;">
                       收益率: ${totalEarnings > 0 ? (totalEarnings/100*100).toFixed(1) + '%' : '0%'}
                       ${totalEarnings > 0 ? ' | 日均: ' + (totalEarnings/7).toFixed(2) + ' USDT' : ''}
                     </div>
                     <div style="font-size: 10px; color: var(--text-secondary);">
                       ${totalEarnings === 0 ? '💡 完成任务开始赚取收益' : '🚀 继续完成任务提升收益'}
                     </div>
                   </div>
                 </div>
              </div>
            </div>
          `;
        },
        buttons: [
          { text: '团队', color: 'orange', key: 'team', action: () => showTeam() },
          { text: '抢红包', color: 'red', key: 'red', action: () => grabRedPacket() },
          { text: '钱包', color: 'purple', key: 'wallet', action: () => showWallet() },
          { text: '排行榜', color: 'green', key: 'rank', action: () => showRanking() }
        ]
      },
      3: {
        name: '状态3',
        subtitle: '倒计时结束未复购',
        card: function() {
          const completedTasks = newTasks.filter(t => t.done).length;
          return `
            <div class="section reactivate-highlight">
              <div class="section-title">🔥 再次激活</div>
              <div class="section-content">
                <p style="margin-bottom: 12px;">重新开启168小时挑战，继续赚取收益！</p>
                <button class="reactivate-btn" onclick="repurchase()">立即激活 100 USDT</button>
              </div>
            </div>
            <div class="section">
              <div class="section-title">战绩卡</div>
              <div class="section-content">本期收益：<strong>${totalEarnings.toFixed(2)} USDT</strong><br/>新手任务：${completedTasks}/3 完成<br/>团队人数：${teamMembers}人</div>
            </div>
            <div class="section">
              <div class="section-title">我的团队</div>
              <div class="section-content">查看七层团队结构和人数。</div>
            </div>
          `;
        },
        buttons: [
          { text: '再次激活', color: 'blue', key: 'reactivate', action: () => repurchase() },
          { text: '团队', color: 'orange', key: 'team', action: () => showTeam() },
          { text: '钱包', color: 'purple', key: 'wallet', action: () => showWallet() },
          { text: '排行榜', color: 'green', key: 'rank', action: () => showRanking() }
        ]
      }
    };

    /* 按钮分类系统 */
    function getButtonCategory(buttonKey) {
      // 主要功能按钮
      const primaryButtons = ['activate', 'reactivate', 'invite', 'wallet', 'team'];
      // 金融相关按钮
      const financialButtons = ['wallet', 'grab-red-packet'];
      // 游戏化按钮
      const gamificationButtons = ['tasks', 'god-tasks', 'leaderboard'];
      
      if (primaryButtons.includes(buttonKey)) {
        return 'btn-primary';
      } else if (financialButtons.includes(buttonKey)) {
        return 'btn-financial';
      } else if (gamificationButtons.includes(buttonKey)) {
        return 'btn-gamification';
      }
      return 'btn-default';
    }
    
    /* 任务数据 */
    const newTasks = [
      { id: 1, title: '直接推荐1人', desc: '邀请1位好友注册并激活账号', done: false, reward: 10 },
      { id: 2, title: '帮助下级推荐1人', desc: '指导你的下级成功邀请1位新用户', done: false, reward: 10 },
      { id: 3, title: '教下级如何教他的下级推荐1人', desc: '培训下级的推广技巧，帮助三级推广', done: false, reward: 10 }
    ];
    
    // 答题任务数据
    const quizTasks = [
      { id: 'quiz1', title: '基础知识答题', desc: '完成20道基础题目，正确率达到80%', done: false, reward: 20, feeReduction: 0.02 }
    ];
    
    const godTasks = [
      { id: 1, title: '大神任务一：直推2人 × 2层 = 6人', desc: '建立2层团队结构，每层2人', done: false, reward: 50 },
      { id: 2, title: '大神任务二：直推3人 × 3层 = 39人', desc: '建立3层团队结构，每层3人', done: false, reward: 250 },
      { id: 3, title: '大神任务三：直推4人 × 4层 = 340人', desc: '建立4层团队结构，每层4人', done: false, reward: 1250 },
      { id: 4, title: '大神任务四：直推5人 × 5层 = 3905人', desc: '建立5层团队结构，每层5人', done: false, reward: 6250 },
      { id: 5, title: '大神任务五：直推6人 × 6层 = 55986人', desc: '建立6层团队结构，每层6人', done: false, reward: 31250 },
      { id: 6, title: '大神任务六：直推7人 × 7层 = 960799人', desc: '建立7层团队结构，每层7人', done: false, reward: 156250 }
    ];

    // ===== API 调用工具函数 =====
    const API_BASE_URL = 'http://localhost:3000';
    
    // 获取认证token
    function getAuthToken() {
      // 从localStorage获取真实的JWT token
      const token = localStorage.getItem('token') || localStorage.getItem('authToken');
      
      // 如果没有有效token，使用默认的模拟token
      if (!token || token === 'demo-token') {
        return 'mock-token-1';
      }
      
      return token;
    }
    
    // API请求封装
    async function apiRequest(endpoint, options = {}) {
      const token = getAuthToken();
      const url = `${API_BASE_URL}/api${endpoint}`;
      
      const config = {
        headers: {
          'Content-Type': 'application/json',
          ...(token && { 'Authorization': `Bearer ${token}` })
        },
        ...options
      };
      
      try {
        const response = await fetch(url, config);
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.message || `HTTP error! status: ${response.status}`);
        }
        
        return data;
      } catch (error) {
        console.error('API请求失败:', error);
        throw error;
      }
    }
    
    // 状态管理API调用
    const StateAPI = {
      // 获取用户状态
      async getStatus() {
        return await apiRequest('/state/status');
      },
      
      // 激活账号
      async activate() {
        return await apiRequest('/state/activate', {
          method: 'POST'
        });
      },
      
      // 复购
      async repurchase() {
        return await apiRequest('/state/repurchase', {
          method: 'POST'
        });
      },
      
      // 同步状态
      async syncState(localState) {
        return await apiRequest('/state/sync', {
          method: 'PUT',
          body: JSON.stringify(localState)
        });
      },
      
      // 切换状态（开发用）
      async switchState(newState) {
        return await apiRequest('/state/switch', {
          method: 'POST',
          body: JSON.stringify({ state: newState })
        });
      }
    };

    /* 全局状态变量 */
    let currentState = 1;
    let countdownStart = null; // 开启倒计时的时间戳
    let inviteStart = null;    // 邀请链接生效时间戳
    let countdownTimer = null;

    // 模拟用户钱包余额，用于红包和提现功能
    let walletBalance = 0;

    // 交易记录列表
    let transactions = [];

    // 提现手续费比例，默认为 5%（0.05），可通过答题任务降低，最低 1%（0.01）
    let withdrawFeeRate = 0.05;

    // 新增状态管理变量
    let userLevel = 0; // 用户等级 0:未激活 1:已激活
    let completedNewbieTasks = 0; // 已完成新手任务数量
    let quizCompleted = false; // 答题任务是否完成
    let godTasksUnlocked = false; // 大神任务是否解锁
    let teamMembers = 0; // 团队成员数量
    let totalEarnings = 0; // 总收益

    /**
     * 从 localStorage 初始化状态，包括余额、任务完成状态和交易记录。
     */
    function loadState() {
      const savedState = localStorage.getItem('appState');
      if (savedState) {
        try {
          const state = JSON.parse(savedState);
          currentState = state.currentState || 1;
          countdownStart = state.countdownStart;
          inviteStart = state.inviteStart;
          walletBalance = state.walletBalance || 0;
          transactions = state.transactions || [];
          userLevel = state.userLevel || 0;
          completedNewbieTasks = state.completedNewbieTasks || 0;
          quizCompleted = state.quizCompleted || false;
          godTasksUnlocked = state.godTasksUnlocked || false;
          teamMembers = state.teamMembers || 0;
          totalEarnings = state.totalEarnings || 0;
          withdrawFeeRate = state.withdrawFeeRate || 0.05;
          
          // 检查quiz完成状态，确保与quiz.html的状态同步
          const quizProgress = JSON.parse(localStorage.getItem('quizProgress') || '{}');
          if (quizProgress.correctCount >= 20) {
            quizCompleted = true;
            state.quizCompleted = true;
          }
          
          // 同步团队收益：总收益 = 团队人数 * 10
          const teamData = JSON.parse(localStorage.getItem('teamData') || '{}');
          if (teamData.totalMembers) {
            totalEarnings = teamData.totalMembers * 10;
            teamMembers = teamData.totalMembers;
          }
          
          // 恢复任务状态
          if (state.newTasks) {
            state.newTasks.forEach((task, index) => {
              if (newTasks[index]) newTasks[index].done = task.done;
            });
            // 同步completedNewbieTasks变量，确保与newTasks数组状态一致
            completedNewbieTasks = newTasks.filter(t => t.done).length;
          }
          if (state.quizTasks) {
            state.quizTasks.forEach((task, index) => {
              if (quizTasks[index]) quizTasks[index].done = task.done;
            });
          }
          if (state.godTasks) {
            state.godTasks.forEach((task, index) => {
              if (godTasks[index]) godTasks[index].done = task.done;
            });
          }
        } catch (e) {
          console.warn('无法解析 appState', e);
        }
      }
    }

    /**
     * 将当前状态保存到 localStorage。
     */
    function saveState() {
      // 同步团队收益：总收益 = 团队人数 * 10
      const teamData = JSON.parse(localStorage.getItem('teamData') || '{}');
      if (teamData.totalMembers) {
        totalEarnings = teamData.totalMembers * 10;
      }
      
      const state = {
        currentState,
        countdownStart,
        inviteStart,
        walletBalance,
        transactions,
        userLevel,
        completedNewbieTasks,
        quizCompleted,
        godTasksUnlocked,
        teamMembers,
        totalEarnings,
        withdrawFeeRate,
        newTasks: newTasks.map(t => ({ ...t })),
        quizTasks: quizTasks.map(t => ({ ...t })),
        godTasks: godTasks.map(t => ({ ...t }))
      };
      localStorage.setItem('appState', JSON.stringify(state));
    }

    // 与后端同步状态
    async function syncWithBackend() {
      try {
        console.log('正在与后端同步状态...');
        const response = await StateAPI.getStatus();
        
        if (response.success && response.data) {
          const backendState = response.data;
          
          // 更新前端状态
          currentState = backendState.status;
          
          // 如果后端有倒计时信息，同步倒计时
          if (backendState.countdown_end_time) {
            const endTime = new Date(backendState.countdown_end_time);
            const now = new Date();
            if (endTime > now) {
              countdownStart = now.getTime();
              // 计算倒计时开始时间（168小时前）
              const startTime = new Date(endTime.getTime() - 168 * 60 * 60 * 1000);
              countdownStart = startTime.getTime();
            }
          }
          
          // 同步其他数据
          if (backendState.balance !== undefined) {
            walletBalance = backendState.balance;
          }
          if (backendState.total_earnings !== undefined) {
            totalEarnings = backendState.total_earnings;
          }
          if (backendState.team_count !== undefined) {
            teamMembers = backendState.team_count;
          }
          
          console.log('后端状态同步成功:', backendState);
          
          // 保存同步后的状态
          saveState();
          
          // 重新渲染页面
          renderState();
        }
      } catch (error) {
        console.warn('后端状态同步失败，使用本地状态:', error.message);
        // 继续使用本地状态，不影响用户体验
      }
    }

    // 生成用户专属邀请码 - 从后端API获取
    async function generateUserInviteCode() {
      try {
        const response = await apiRequest('/user/invite-code');
        if (response.success && response.data.inviteCode) {
          return response.data.inviteCode;
        }
      } catch (error) {
        console.error('获取邀请码失败:', error);
      }
      
      // 如果API调用失败，使用邮箱生成备用邀请码
      const userEmail = localStorage.getItem('userEmail');
      if (userEmail) {
        const emailPrefix = userEmail.split('@')[0].substring(0, 6).toUpperCase();
        return emailPrefix + Date.now().toString().slice(-6);
      }
      return 'USER' + Date.now().toString().slice(-6);
    }

    // 通知系统增强
    let notifications = []; // 通知历史记录
    let unreadNotifications = 0; // 未读通知数量

    /**
     * 添加通知到历史记录
     * @param {string} type - 通知类型
     * @param {string} title - 通知标题
     * @param {string} message - 通知内容
     * @param {Object} data - 附加数据
     */
    function addNotification(type, title, message, data = {}) {
      const notification = {
        id: Date.now(),
        type,
        title,
        message,
        data,
        timestamp: new Date(),
        read: false
      };
      
      notifications.unshift(notification);
      unreadNotifications++;
      
      // 限制通知历史记录数量
      if (notifications.length > 50) {
        notifications = notifications.slice(0, 50);
      }
      
      // 保存到localStorage
      localStorage.setItem('notifications', JSON.stringify(notifications));
      localStorage.setItem('unreadNotifications', unreadNotifications.toString());
      
      // 更新通知按钮显示
      updateNotificationButton();
      
      // 显示浮动通知
      showFloatingNotification(notification);
    }

    /**
     * 显示浮动通知
     * @param {Object} notification - 通知对象
     */
    function showFloatingNotification(notification) {
      // 创建浮动通知元素
      const floatingNotification = document.createElement('div');
      floatingNotification.className = `floating-notification ${notification.type}`;
      floatingNotification.innerHTML = `
        <div class="notification-icon">
          ${getNotificationIcon(notification.type)}
        </div>
        <div class="notification-content">
          <div class="notification-title">${notification.title}</div>
          <div class="notification-message">${notification.message}</div>
        </div>
        <div class="notification-close" onclick="closeFloatingNotification(this)">×</div>
      `;
      
      // 添加到页面
      document.body.appendChild(floatingNotification);
      
      // 动画显示
      setTimeout(() => {
        floatingNotification.classList.add('show');
      }, 100);
      
      // 自动隐藏
      setTimeout(() => {
        closeFloatingNotification(floatingNotification);
      }, 5000);
      
      // 点击事件
      floatingNotification.addEventListener('click', () => {
        handleNotificationClick(notification);
        closeFloatingNotification(floatingNotification);
      });
    }

    /**
     * 关闭浮动通知
     * @param {Element} element - 通知元素或关闭按钮
     */
    function closeFloatingNotification(element) {
      const notification = element.classList.contains('floating-notification') ? element : element.closest('.floating-notification');
      if (notification) {
        notification.classList.remove('show');
        setTimeout(() => {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 300);
      }
    }

    /**
     * 获取通知图标
     * @param {string} type - 通知类型
     * @returns {string} 图标HTML
     */
    function getNotificationIcon(type) {
      const icons = {
        'redpacket_notification': '🧧',
        'balance_update': '💰',
        'task_reminder': '📋',
        'task_complete': '✅',
        'system_notification': '🔔',
        'team_update': '👥',
        'level_up': '🎉',
        'withdrawal_status': '💳',
        'deposit_confirmed': '💎'
      };
      return icons[type] || '🔔';
    }

    /**
     * 处理通知点击事件
     * @param {Object} notification - 通知对象
     */
    function handleNotificationClick(notification) {
      switch (notification.type) {
        case 'redpacket_notification':
          grabRedPacket();
          break;
        case 'task_reminder':
        case 'task_complete':
          showTasks();
          break;
        case 'balance_update':
        case 'withdrawal_status':
        case 'deposit_confirmed':
          showWallet();
          break;
        case 'team_update':
          showTeam();
          break;
        default:
          // 默认行为：标记为已读
          markNotificationAsRead(notification.id);
      }
    }

    /**
     * 标记通知为已读
     * @param {number} notificationId - 通知ID
     */
    function markNotificationAsRead(notificationId) {
      const notification = notifications.find(n => n.id === notificationId);
      if (notification && !notification.read) {
        notification.read = true;
        unreadNotifications = Math.max(0, unreadNotifications - 1);
        
        // 保存到localStorage
        localStorage.setItem('notifications', JSON.stringify(notifications));
        localStorage.setItem('unreadNotifications', unreadNotifications.toString());
        
        // 更新通知按钮显示
        updateNotificationButton();
      }
    }

    /**
     * 更新通知按钮显示
     */
    function updateNotificationButton() {
      const notificationButton = document.querySelector('.notification-button');
      if (notificationButton) {
        const badge = notificationButton.querySelector('.notification-badge');
        if (unreadNotifications > 0) {
          if (!badge) {
            const newBadge = document.createElement('span');
            newBadge.className = 'notification-badge';
            notificationButton.appendChild(newBadge);
          }
          notificationButton.querySelector('.notification-badge').textContent = unreadNotifications > 99 ? '99+' : unreadNotifications;
          notificationButton.classList.add('has-unread');
        } else {
          if (badge) {
            badge.remove();
          }
          notificationButton.classList.remove('has-unread');
        }
      }
    }

    /**
     * 显示通知中心
     */
    function showNotificationCenter() {
      // 标记所有通知为已读
      notifications.forEach(n => n.read = true);
      unreadNotifications = 0;
      localStorage.setItem('notifications', JSON.stringify(notifications));
      localStorage.setItem('unreadNotifications', '0');
      updateNotificationButton();
      
      // 构建通知列表HTML
      const notificationListHTML = notifications.length > 0 ? 
        notifications.map(notification => `
          <div class="notification-item ${notification.type}">
            <div class="notification-icon">${getNotificationIcon(notification.type)}</div>
            <div class="notification-content">
              <div class="notification-title">${notification.title}</div>
              <div class="notification-message">${notification.message}</div>
              <div class="notification-time">${formatNotificationTime(notification.timestamp)}</div>
            </div>
          </div>
        `).join('') :
        '<div class="no-notifications">暂无通知</div>';
      
      showDialog(
        '通知中心',
        `<div class="notification-center">${notificationListHTML}</div>`,
        [
          { text: '清空通知', action: () => clearAllNotifications() },
          { text: '关闭', action: 'close' }
        ],
        'notification'
      );
    }

    /**
     * 清空所有通知
     */
    function clearAllNotifications() {
      notifications = [];
      unreadNotifications = 0;
      localStorage.removeItem('notifications');
      localStorage.removeItem('unreadNotifications');
      updateNotificationButton();
      
      showDialog(
        '通知中心',
        '<div class="notification-center"><div class="no-notifications">暂无通知</div></div>',
        [{ text: '关闭', action: 'close' }],
        'notification'
      );
    }

    /**
     * 格式化通知时间
     * @param {Date} timestamp - 时间戳
     * @returns {string} 格式化的时间字符串
     */
    function formatNotificationTime(timestamp) {
      const now = new Date();
      const diff = now - new Date(timestamp);
      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(diff / 3600000);
      const days = Math.floor(diff / 86400000);
      
      if (minutes < 1) return '刚刚';
      if (minutes < 60) return `${minutes}分钟前`;
      if (hours < 24) return `${hours}小时前`;
      if (days < 7) return `${days}天前`;
      
      return new Date(timestamp).toLocaleDateString();
    }

    /**
     * 加载通知历史记录
     */
    function loadNotifications() {
      const savedNotifications = localStorage.getItem('notifications');
      const savedUnreadCount = localStorage.getItem('unreadNotifications');
      
      if (savedNotifications) {
        try {
          notifications = JSON.parse(savedNotifications);
          unreadNotifications = parseInt(savedUnreadCount) || 0;
        } catch (e) {
          console.warn('无法解析通知历史记录', e);
          notifications = [];
          unreadNotifications = 0;
        }
      }
      
      updateNotificationButton();
    }

    // WebSocket连接和实时通知功能
    let websocket = null;
    
    function initWebSocket() {
      // 获取JWT token
      const token = getAuthToken();
      if (!token) {
        console.log('未找到token，跳过WebSocket连接');
        return;
      }
      
      // 连接WebSocket服务器（使用正确的路径和token）
      websocket = new WebSocket(`ws://localhost:3000/ws?token=${encodeURIComponent(token)}`);
      
      websocket.onopen = function(event) {
        console.log('WebSocket连接已建立');
      };
      
      websocket.onmessage = function(event) {
        try {
          const data = JSON.parse(event.data);
          handleWebSocketMessage(data);
        } catch (error) {
          console.error('解析WebSocket消息失败:', error);
        }
      };
      
      websocket.onclose = function(event) {
        console.log('WebSocket连接已关闭');
        // 5秒后尝试重连
        setTimeout(initWebSocket, 5000);
      };
      
      websocket.onerror = function(error) {
        console.error('WebSocket错误:', error);
      };
    }
    
    function handleWebSocketMessage(data) {
      switch (data.type) {
        case 'redpacket_notification':
          // 红包通知
          addNotification(
            'redpacket_notification',
            '红包提醒',
            '新的红包活动开始了！快去抢红包吧！',
            data
          );
          showDialog(
            '红包提醒',
            `新的红包活动开始了！快去抢红包吧！`,
            [{ text: '立即抢红包', action: 'grabRedPacket' }, { text: '稍后再说', action: 'close' }],
            'redpacket'
          );
          break;
          
        case 'balance_update':
          // 余额更新通知
          addNotification(
            'balance_update',
            '余额变化',
            `${data.reason || '余额更新'}: ${data.newBalance} USDT`,
            data
          );
          updateWalletBalance(data.newBalance, data.reason);
          break;
          
        case 'task_reminder':
          // 任务提醒
          addNotification(
            'task_reminder',
            '任务提醒',
            data.message,
            data
          );
          showDialog(
            '任务提醒',
            data.message,
            [{ text: '查看任务', action: 'showTasks' }, { text: '稍后再说', action: 'close' }],
            'success'
          );
          break;
          
        case 'task_complete':
          // 任务完成通知
          addNotification(
            'task_complete',
            '任务完成',
            data.message || '恭喜您完成了一个任务！',
            data
          );
          // 播放成功音效
          playSound('success');
          break;
          
        case 'team_update':
          // 团队更新通知
          addNotification(
            'team_update',
            '团队更新',
            data.message || '您的团队有新的变化',
            data
          );
          break;
          
        case 'level_up':
          // 等级提升通知
          addNotification(
            'level_up',
            '等级提升',
            data.message || '恭喜您的等级提升了！',
            data
          );
          showDialog(
            '🎉 等级提升',
            data.message || '恭喜您的等级提升了！',
            [{ text: '太棒了！', action: 'close' }],
            'success'
          );
          break;
          
        case 'withdrawal_status':
          // 提现状态更新
          addNotification(
            'withdrawal_status',
            '提现状态更新',
            data.message || '您的提现状态已更新',
            data
          );
          break;
          
        case 'deposit_confirmed':
          // 入金确认
          addNotification(
            'deposit_confirmed',
            '入金确认',
            data.message || '您的入金已确认',
            data
          );
          break;
          
        case 'system_notification':
          // 系统通知
          addNotification(
            'system_notification',
            '系统通知',
            data.message,
            data
          );
          showDialog(
            '系统通知',
            data.message,
            [{ text: '确定', action: 'close' }],
            'success'
          );
          break;
          
        default:
          console.log('未知的WebSocket消息类型:', data.type);
      }
    }
    
    // 更新钱包余额函数
    function updateWalletBalance(newBalance, reason = '') {
      const oldBalance = walletBalance;
      walletBalance = newBalance;
      
      // 保存到localStorage
      localStorage.setItem('walletBalance', walletBalance.toString());
      
      // 重新渲染页面以更新显示
      renderState();
      
      // 显示余额变化通知
      if (reason) {
        const changeAmount = newBalance - oldBalance;
        const changeText = changeAmount > 0 ? `+${changeAmount}` : changeAmount.toString();
        showDialog(
          '余额变化',
          `${reason}\n余额变化: ${changeText}元\n当前余额: ${newBalance}元`,
          [{ text: '确定', action: 'close' }],
          'success'
        );
      }
    }
    
    // 显示任务页面函数
    function showTasks() {
      if (currentState === 1) {
        showDialog('任务系统', '请先激活账号后查看任务', [{ text: '知道了', action: 'close' }]);
        return;
      }

      // 获取任务数据
      const taskData = getTaskData();
      
      // 构建任务列表HTML
      let taskListHTML = `
        <div class="task-overview">
          <div class="task-stats">
            <div class="stat-item">
              <span class="stat-label">新手任务</span>
              <span class="stat-value">${taskData.completedNewbieTasks}/4</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">答题任务</span>
              <span class="stat-value">${taskData.quizCompleted ? '已完成' : '未完成'}</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">大神任务</span>
              <span class="stat-value">${taskData.godTasksCompleted}/6</span>
            </div>
          </div>
        </div>
        
        <div class="task-sections">
          <div class="task-section">
            <h4>🎯 新手任务 (${taskData.completedNewbieTasks}/4)</h4>
            <div class="task-list">
              ${taskData.newbieTasks.map(task => `
                <div class="task-item ${task.done ? 'completed' : (task.id === taskData.completedNewbieTasks + 1 ? 'current' : 'locked')}">
                  <div class="task-info">
                    <span class="task-title">${task.title}</span>
                    <span class="task-reward">+${task.reward} USDT</span>
                  </div>
                  <div class="task-status">
                    ${task.done ? '✅ 已完成' : (task.id === taskData.completedNewbieTasks + 1 ? '🔄 进行中' : '🔒 未开始')}
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
          
          <div class="task-section">
            <h4>📝 答题任务 ${taskData.completedNewbieTasks >= 1 ? '' : '(需完成新手任务1)'}</h4>
            <div class="task-list">
              <div class="task-item ${taskData.quizCompleted ? 'completed' : (taskData.completedNewbieTasks >= 1 ? 'available' : 'locked')}">
                <div class="task-info">
                  <span class="task-title">完成20道题目 (正确率≥80%)</span>
                  <span class="task-reward">降低提现手续费</span>
                </div>
                <div class="task-status">
                  ${taskData.quizCompleted ? '✅ 已完成' : (taskData.completedNewbieTasks >= 1 ? '📝 可答题' : '🔒 未解锁')}
                </div>
              </div>
            </div>
          </div>
          
          <div class="task-section">
            <h4>🏆 大神任务 ${taskData.godTasksUnlocked ? `(${taskData.godTasksCompleted}/6)` : '(需完成所有新手任务+答题任务)'}</h4>
            <div class="task-list">
              ${taskData.godTasks.map(task => `
                <div class="task-item ${task.done ? 'completed' : (taskData.godTasksUnlocked ? 'available' : 'locked')}">
                  <div class="task-info">
                    <span class="task-title">${task.title}</span>
                    <span class="task-reward">+${task.reward} USDT</span>
                  </div>
                  <div class="task-status">
                    ${task.done ? '✅ 已完成' : (taskData.godTasksUnlocked ? '🎯 可完成' : '🔒 未解锁')}
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        </div>
      `;

      // 构建按钮
      let buttons = [];
      
      // 如果有可执行的新手任务
      const nextNewbieTask = taskData.newbieTasks.find(t => !t.done && t.id === taskData.completedNewbieTasks + 1);
      if (nextNewbieTask) {
        buttons.push({ text: '执行当前任务', action: () => executeTask('newbie', nextNewbieTask.id) });
      }
      
      // 如果答题任务可用且未完成
      if (taskData.completedNewbieTasks >= 1 && !taskData.quizCompleted) {
        buttons.push({ text: '开始答题', action: () => startQuiz() });
      }
      
      // 如果大神任务已解锁
      if (taskData.godTasksUnlocked) {
        const nextGodTask = taskData.godTasks.find(t => !t.done);
        if (nextGodTask) {
          buttons.push({ text: '查看大神任务', action: () => executeTask('god', nextGodTask.id) });
        }
      }
      
      buttons.push({ text: '关闭', action: 'close' });

      // 显示任务对话框
      showDialog('任务中心', '', buttons, 'normal', null, taskListHTML);
    }

    /**
     * 获取任务数据
     */
    function getTaskData() {
      // 计算完成的新手任务数量
      const completedNewbieTasks = newTasks.filter(task => task.done).length;
      
      // 检查答题任务是否完成
      const quizCompleted = appState.quizCompleted || false;
      
      // 检查大神任务是否解锁（需要完成所有新手任务和答题任务）
      const godTasksUnlocked = completedNewbieTasks >= 3 && quizCompleted;
      
      // 计算完成的大神任务数量
      const godTasksCompleted = godTasks.filter(task => task.done).length;

      return {
        newbieTasks: newTasks,
        godTasks,
        completedNewbieTasks,
        quizCompleted,
        godTasksUnlocked,
        godTasksCompleted
      };
    }

    /**
     * 执行任务
     */
    function executeTask(taskType, taskId) {
      if (taskType === 'newbie') {
        openTasks();
      } else if (taskType === 'god') {
        openGodTasks();
      }
    }

    /**
     * 开始答题任务
     */
    function startQuiz() {
      // 检查是否已解锁答题任务
      const completedNewbieTasks = newTasks.filter(task => task.done).length;
      if (completedNewbieTasks < 1) {
        showDialog('答题任务未解锁', '请先完成至少一个新手任务后再开始答题。');
        return;
      }

      // 检查是否已完成答题任务
      const quizCorrect = parseInt(localStorage.getItem('quizCorrect')) || 0;
      if (quizCorrect >= 20) {
        showDialog('答题任务已完成', `您已完成答题任务，正确率：${quizCorrect}/20\n当前提现手续费：${(parseFloat(localStorage.getItem('withdrawFeeRate') || '0.05') * 100).toFixed(1)}%`);
        return;
      }

      // 保存当前状态到localStorage
      saveState();
      
      // 跳转到答题页面
      window.location.href = 'quiz.html';
    }

    /**
     * 隐藏加载屏幕并显示主应用
     * @param {number} minDisplayTime - 最小显示时间（毫秒），默认1500ms
     */
    function hideLoadingScreen(minDisplayTime = 1500) {
      const loadingScreen = document.getElementById('loadingScreen');
      const app = document.getElementById('app');
      
      // 记录页面加载开始时间
      const loadStartTime = window.loadStartTime || Date.now();
      const elapsedTime = Date.now() - loadStartTime;
      const remainingTime = Math.max(0, minDisplayTime - elapsedTime);
      
      setTimeout(() => {
        // 添加淡出动画
        loadingScreen.classList.add('hidden');
        
        // 显示主应用
        app.classList.remove('loading');
        
        // 300ms后完全移除加载屏幕
        setTimeout(() => {
          loadingScreen.style.display = 'none';
        }, 300);
      }, remainingTime);
    }

    async function init() {
      // 从 localStorage 加载历史状态
      loadState();
      
      // 检查用户是否已登录
      const isActivated = localStorage.getItem('isActivated') === 'true';
      const userToken = localStorage.getItem('userToken');
      
      if (!isActivated || !userToken) {
        // 未激活或无token，直接跳转到登录页面，不显示状态1
        hideLoadingScreen();
        showLoginRegister();
        return;
      }
      
      // 尝试从后端同步状态
      syncWithBackend();
      
      // 生成或获取用户邀请码
      let userInviteCode = localStorage.getItem('userInviteCode');
      if (!userInviteCode) {
        try {
          userInviteCode = await generateUserInviteCode();
          localStorage.setItem('userInviteCode', userInviteCode);
        } catch (error) {
          console.error('生成邀请码失败:', error);
          // 使用备用方案
          userInviteCode = 'USER' + Date.now().toString().slice(-6);
          localStorage.setItem('userInviteCode', userInviteCode);
        }
      }
      
      // 初始化音效系统
      initAudioSystem();
      
      // 初始化消息系统
      initMessages();
      
      // 初始化Bug报告系统
      initBugReports();
      
      // 初始化消息图标拖拽功能
      initMessageIconDrag();
      
      // 初始化WebSocket连接
      initWebSocket();
      
      // 加载通知历史
      loadNotifications();
      
      // 渲染状态并隐藏加载屏幕
      renderState();
      hideLoadingScreen();
      
      // 初始化设置面板事件监听器
      initSettingsEvents();
    }

    function renderState() {
      const state = STATES[currentState];
      // 注释掉状态标签和副标题的更新，因为这些元素已被隐藏
      // document.getElementById('stateLabel').innerText = state.name;
      // document.getElementById('subtitle').innerText = state.subtitle;
      // 渲染卡片内容
      document.getElementById('card').innerHTML = state.card();
      
      // 更新战绩卡数据
      updateStatsDisplay();
      
      // 渲染底部按钮
      const bottom = document.getElementById('bottomButtons');
      bottom.innerHTML = '';
      
      // 严格按状态控制按钮显示
      const buttonsToShow = getButtonsForState(currentState);
      
      // 如果按钮超过6个，添加many-buttons类
      if (buttonsToShow.length > 6) {
        bottom.classList.add('many-buttons');
      } else {
        bottom.classList.remove('many-buttons');
      }
      
      buttonsToShow.forEach(btnConfig => {
        const b = document.createElement('button');
        b.innerText = btnConfig.text;
        
        // 应用新的按钮分类系统
        const buttonCategory = getButtonCategory(btnConfig.key || btnConfig.text);
        b.classList.add(buttonCategory);
        
        // 保持原有颜色类（向后兼容）
        if (btnConfig.color) {
          b.classList.add(btnConfig.color);
        }
        
        b.onclick = btnConfig.action;
        
        // 设置 data-key 以便样式定制
        if (btnConfig.key) {
          b.dataset.key = btnConfig.key;
        }
        
        bottom.appendChild(b);
      });
      
      // 控制倒计时
      if (currentState === 2) {
        if (!countdownStart) {
          countdownStart = Date.now();
          inviteStart = countdownStart;
        }
        updateCountdown();
        countdownTimer = setInterval(updateCountdown, 1000);
      } else {
        if (countdownTimer) clearInterval(countdownTimer);
      }
      
      // 更新消息按钮状态
      updateMessageButton();
    }
    
    // 根据状态严格控制按钮显示
    function getButtonsForState(state) {
      const baseButtons = STATES[state].buttons;
      const result = [...baseButtons];
      

      
      return result;
    }
    
    // 更新战绩卡显示
    function updateStatsDisplay() {
      const taskProgressEl = document.getElementById('taskProgress');
      const teamCountEl = document.getElementById('teamCount');
      const totalEarningsEl = document.getElementById('totalEarnings');
      
      // 使用newTasks数组的实际完成状态，确保与内容栏显示一致
      const actualCompletedTasks = newTasks.filter(t => t.done).length;
      if (taskProgressEl) taskProgressEl.innerText = actualCompletedTasks;
      if (teamCountEl) teamCountEl.innerText = teamMembers;
      if (totalEarningsEl) totalEarningsEl.innerText = totalEarnings.toFixed(2);
    }

    function updateCountdown(wsData = null) {
      const total = 168 * 3600 * 1000; // 总时长：168小时
      let remaining;
      
      if (wsData && wsData.remaining !== undefined) {
        // 使用WebSocket推送的倒计时数据
        remaining = wsData.remaining;
      } else {
        // 使用本地计算的倒计时
        const now = Date.now();
        const elapsed = now - countdownStart;
        remaining = total - elapsed;
        if (remaining < 0) remaining = 0;
      }
      
      // 计算总小时数、分钟数、秒数
      const totalHours = Math.floor(remaining / (3600 * 1000));
      const mins = Math.floor((remaining % 3600000) / 60000);
      const secs = Math.floor((remaining % 60000) / 1000);
      
      // 格式化为 XX:XX:XX 格式（小时不补前导0）
      const timeStr = `${totalHours}:${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
      
      // 更新倒计时显示
      const countdownEl = document.getElementById('countdown');
      if (countdownEl) countdownEl.innerText = timeStr;
      
      // 更新进度条（倒计时进度：从满逐渐变空）
      const progressEl = document.getElementById('countdownProgress');
      const remainingDaysEl = document.getElementById('remainingDays');
      if (progressEl && remainingDaysEl) {
        // 倒计时进度条：显示剩余时间进度（从100%递减到0%，从满逐渐变空）
        const remainingProgress = (remaining / total);
        const remainingPercent = remainingProgress * 100;
        progressEl.style.width = `${remainingPercent}%`;
        
        // 计算剩余天数、小时数和分钟数
        const remainingDays = Math.floor(remaining / (24 * 3600 * 1000));
        const remainingHours = Math.floor((remaining % (24 * 3600 * 1000)) / (3600 * 1000));
        const remainingMinutes = Math.floor((remaining % (3600 * 1000)) / (60 * 1000));
        
        // 根据剩余时间显示不同格式
        if (remainingDays > 0) {
          remainingDaysEl.textContent = `剩余${remainingDays}天${remainingHours}小时${remainingMinutes}分`;
        } else {
          remainingDaysEl.textContent = `仅剩余${remainingHours}小时${remainingMinutes}分`;
        }
      }
      
      // 更新状态提示和动画效果
      const statusEl = document.getElementById('countdownStatus');
      const containerEl = document.querySelector('.countdown-container');
      
      if (statusEl && containerEl) {
        const hoursLeft = remaining / (3600 * 1000);
        
        if (hoursLeft <= 24) {
          // 最后24小时 - 紧急状态
          statusEl.innerHTML = '🚨 最后24小时！立即完成任务获得奖励';
          statusEl.style.background = 'rgba(255, 69, 58, 0.2)';
          statusEl.style.borderColor = 'rgba(255, 69, 58, 0.4)';
          statusEl.style.color = '#ff453a';
          containerEl.style.animation = 'urgentPulse 1.5s ease-in-out infinite';
          
          // 进度环变红色
          if (progressEl) {
            progressEl.style.stroke = '#ff453a';
            progressEl.style.filter = 'drop-shadow(0 0 8px #ff453a)';
          }
        } else if (hoursLeft <= 72) {
          // 最后72小时 - 警告状态
          statusEl.innerHTML = '⚠️ 时间紧迫，抓紧完成任务获得收益';
          statusEl.style.background = 'rgba(255, 193, 7, 0.2)';
          statusEl.style.borderColor = 'rgba(255, 193, 7, 0.4)';
          statusEl.style.color = '#ffc107';
          containerEl.style.animation = 'countdownPulse 2s ease-in-out infinite';
          
          // 进度环变橙色
          if (progressEl) {
            progressEl.style.stroke = '#ffc107';
            progressEl.style.filter = 'drop-shadow(0 0 8px #ffc107)';
          }
        } else {
          // 正常状态 - 不显示任何提示
          if (statusEl) {
            statusEl.style.display = 'none';
          }
          containerEl.style.animation = 'countdownPulse 3s ease-in-out infinite';
          
          // 进度环保持蓝色
          if (progressEl) {
            progressEl.style.stroke = 'var(--accent-color)';
            progressEl.style.filter = 'drop-shadow(0 0 8px var(--accent-color))';
          }
        }
      }
      
      // 更新邀请链接显示
      updateInviteDisplay();
      
      // 当倒计时结束，自动进入状态3
      if (remaining === 0 && currentState === 2) {
        currentState = 3;
        countdownStart = null;
        renderState();
      }
    }
    
    // 更新邀请链接显示
    function updateInviteDisplay() {
      // 更新邀请码和邀请链接内容
      const userInviteCode = localStorage.getItem('userInviteCode') || '';
      
      // 更新专属邀请码显示
      const inviteCodeEl = document.getElementById('myInviteCode');
      if (inviteCodeEl) {
        inviteCodeEl.textContent = userInviteCode;
      }
      
      // 更新邀请链接
      const inviteLinkEl = document.getElementById('inviteLink');
      if (inviteLinkEl) {
        inviteLinkEl.value = `https://gold7.com/login.html?invite=${userInviteCode}`;
      }
    }

    // 显示邀请链接弹窗
    function showInviteLink() {
      const userInviteCode = localStorage.getItem('userInviteCode') || 'ABC123';
      const inviteLink = `https://gold7.com/login.html?invite=${userInviteCode}`;
      
      // 计算邀请链接剩余有效期
      const detailedTime = getDetailedCountdown();
      
      const message = `🔗 您的专属邀请链接：\n${inviteLink}\n\n💎 邀请码：${userInviteCode}\n\n⏰ 有效期剩余：${detailedTime}\n\n💡 分享此链接邀请好友注册，获得丰厚奖励！`;
      
      const buttons = [
        {
          text: '复制链接',
          action: () => {
            if (navigator.clipboard) {
              navigator.clipboard.writeText(inviteLink).then(() => {
                showDialog('邀请链接已复制', `有效期剩余 ${detailedTime}`);
              }).catch(() => {
                fallbackCopy(inviteLink);
              });
            } else {
              fallbackCopy(inviteLink);
            }
          }
        },
        {
          text: '复制邀请码',
          action: () => {
            if (navigator.clipboard) {
              navigator.clipboard.writeText(userInviteCode).then(() => {
                showDialog('邀请码已复制', `专属邀请码: ${userInviteCode}\n有效期剩余 ${detailedTime}`);
              }).catch(() => {
                fallbackCopyCode(userInviteCode);
              });
            } else {
              fallbackCopyCode(userInviteCode);
            }
          }
        },
        {
          text: '关闭',
          style: 'secondary',
          action: 'close'
        }
      ];
      
      showDialog('邀请链接', message, buttons);
    }

    // 开发测试循环状态
    function cycleState() {
      currentState++;
      if (currentState > 3) currentState = 1;
      countdownStart = null;
      renderState();
    }

    // 切换到指定状态
    function switchToState(state) {
      if (state === '') return; // 如果选择了空选项，不执行任何操作
      
      currentState = parseInt(state);
      countdownStart = null;
      renderState();
      
      // 重置下拉菜单
      document.getElementById('stateSelect').value = '';
      
      // 自动关闭设置面板
      closeSettings();
    }

    // 激活账号/首次入金 - 集成真实Tatum支付流程
    async function activateAccount() {
      try {
        // 显示加载提示
        showDialog('正在处理', '正在生成支付信息，请稍候...', null, 'loading');
        
        // 调用真实的激活API
        const response = await apiRequest('/activation/activate', {
          method: 'POST'
        });
        
        if (response.success && response.data) {
          const activationData = response.data;
          
          // 关闭加载对话框
          closeDialog();
          
          // 显示支付信息界面
          showPaymentDialog(activationData);
          
        } else {
          throw new Error(response.message || '激活请求失败');
        }
        
      } catch (error) {
        console.error('激活API调用失败:', error);
        
        // 关闭加载对话框
        closeDialog();
        
        // 显示错误信息，不再自动跳转到状态2
        showDialog('激活失败', '无法连接到支付服务器，请稍后重试。如果问题持续存在，请联系客服。', null, 'error');
      }
    }

    // 再次入金（复购）
    async function repurchase() {
      // 使用回调机制，确保用户确认后才执行状态切换
      showDialog('再次激活', '请向系统提供的新USDT地址支付100 USDT以重新激活。重新激活后将开启新的168小时挑战期。', null, 'normal', async () => {
        try {
          // 尝试调用后端API
          const response = await StateAPI.repurchase();
          
          if (response.success) {
            // 使用后端返回的数据更新状态
            currentState = response.data.status;
            countdownStart = new Date(response.data.countdown_end_time).getTime() - (168 * 60 * 60 * 1000);
            inviteStart = countdownStart;
            
            // 记录交易
            transactions.push({ 
              type: '复购缴费', 
              amount: -100, 
              fee: 0, 
              net: -100, 
              time: new Date().toISOString(),
              desc: '复购激活缴费' 
            });
            
            // 设置激活时间供quiz.html使用
            localStorage.setItem('activationTime', new Date().toISOString());
            
            saveState();
            renderState();
            
            showDialog('复购成功', '复购激活成功！新的168小时挑战期已开始。');
          }
        } catch (error) {
          console.warn('后端API调用失败，使用本地模式:', error);
          
          // 回退到本地模式 - 移除延迟，立即执行
          // 复购记录交易
          transactions.push({ 
            type: '复购缴费', 
            amount: -100, 
            fee: 0, 
            net: -100, 
            time: new Date().toISOString(),
            desc: '复购激活缴费' 
          });
          
          // 更新状态
          currentState = 2;
          countdownStart = Date.now();
          inviteStart = countdownStart;
          
          // 设置激活时间供quiz.html使用
          localStorage.setItem('activationTime', new Date().toISOString());
          
          saveState();
          renderState();
          
          showDialog('复购成功', '复购激活成功！新的168小时挑战期已开始。');
        }
      });
    }

    // 任务按钮 - 实现按序触发逻辑
    function openTasks() {
      // 找到下一个未完成的任务（按ID顺序）
      const nextTask = newTasks.find(t => !t.done && t.id === completedNewbieTasks + 1);
      
      if (nextTask) {
        // 显示任务详情
        showDialog('当前任务', `任务${nextTask.id}：${nextTask.title}\n\n${nextTask.desc}\n\n完成奖励：${nextTask.reward} USDT\n\n点击确定标记完成`, [
          { text: '完成任务', action: () => completeNewbieTask(nextTask) },
          { text: '取消', action: 'close' }
        ]);
      } else if (completedNewbieTasks >= 3) {
        // 所有新手任务已完成，检查答题任务状态
        const quizCorrect = parseInt(localStorage.getItem('quizCorrect')) || 0;
        const quizCompleted = quizCorrect >= 20;
        
        if (!quizCompleted) {
          showDialog('答题任务', '所有新手任务已完成！\n\n答题任务可用，完成20题可降低提现手续费。\n\n当前手续费：' + ((withdrawFeeRate * 100).toFixed(1)) + '%', [
            { text: '开始答题', action: () => { saveState(); window.location.href = 'quiz.html'; } },
            { text: '稍后再说', action: 'close' }
          ]);
        } else {
          // 检查大神任务是否解锁
          const godTasksUnlocked = completedNewbieTasks >= 3 && quizCompleted;
          if (godTasksUnlocked) {
            const nextGodTask = godTasks.find(t => !t.done);
            if (nextGodTask) {
              showDialog('大神任务', '新手任务和答题任务已完成！\n\n大神任务已解锁，可获得更高奖励。', [
                { text: '查看大神任务', action: () => openGodTasks() },
                { text: '关闭', action: 'close' }
              ]);
            } else {
              showDialog('任务完成', '恭喜！所有任务已完成！\n\n继续邀请好友获得更多奖励。');
            }
          } else {
            showDialog('新手任务', '所有新手任务已完成！\n\n答题任务也已完成，手续费已降至最低。');
          }
        }
      } else {
        showDialog('任务系统', '请按顺序完成任务。当前可完成任务：' + (completedNewbieTasks + 1));
      }
    }

    /**
     * 完成新手任务
     */
    function completeNewbieTask(task) {
      // 模拟任务完成
      setTimeout(() => {
        task.done = true;
        // 同步completedNewbieTasks变量，确保与newTasks数组状态一致
        completedNewbieTasks = newTasks.filter(t => t.done).length;
        
        // 任务奖励
        walletBalance += task.reward;
        totalEarnings += task.reward;
        
        // 记录交易
        transactions.push({ 
          type: '任务奖励', 
          amount: task.reward, 
          fee: 0, 
          net: task.reward, 
          time: new Date().toISOString(),
          desc: `完成${task.title}` 
        });
        
        saveState();
        renderState();
        
        // 显示任务完成弹窗
        showDialog('任务完成', `恭喜完成任务：${task.title}！\n奖励：${task.reward} USDT\n当前余额：${walletBalance.toFixed(2)} USDT`);
        
        // 检查是否解锁答题任务
        if (completedNewbieTasks >= 1 && !quizCompleted) {
          setTimeout(() => {
            showDialog('解锁答题任务', '恭喜！解锁答题任务，完成可降低提现手续费！\n\n当前手续费：' + ((withdrawFeeRate * 100).toFixed(1)) + '%', [
              { text: '开始答题', action: () => { saveState(); window.location.href = 'quiz.html'; } },
              { text: '稍后再说', action: 'close' }
            ]);
          }, 2000);
        }
        
        // 检查是否解锁大神任务
        if (completedNewbieTasks >= 3) {
          const quizCorrect = parseInt(localStorage.getItem('quizCorrect')) || 0;
          const quizCompleted = quizCorrect >= 20;
          
          if (quizCompleted) {
            setTimeout(() => {
              showDialog('解锁大神任务', '恭喜！大神任务已解锁！\n\n完成大神任务可获得更高奖励。', [
                { text: '查看大神任务', action: () => openGodTasks() },
                { text: '稍后再说', action: 'close' }
              ]);
            }, 2000);
          }
        }
      }, 1500);
    }
    

    
    // 复制邀请链接
    function copyInvite() {
      const userInviteCode = localStorage.getItem('userInviteCode') || '';
      const link = `https://gold7.com/invite?code=${userInviteCode}`;
      navigator.clipboard.writeText(link).then(() => {
        showDialog('邀请链接已复制', `有效期剩余 ${document.getElementById('inviteLeft').innerText}。`);
      });
    }
    
    // 新的复制邀请链接函数
    function copyInviteLink() {
      const linkInput = document.getElementById('inviteLink');
      const link = linkInput.value;
      
      if (navigator.clipboard) {
        navigator.clipboard.writeText(link).then(() => {
          const detailedTime = getDetailedCountdown();
          showDialog('邀请链接已复制', `有效期剩余 ${detailedTime}`);
        }).catch(() => {
          fallbackCopy(link);
        });
      } else {
        fallbackCopy(link);
      }
    }
    
    // 复制专属邀请码函数
    function copyInviteCode() {
      const codeEl = document.getElementById('myInviteCode');
      const code = codeEl.textContent;
      
      if (navigator.clipboard) {
        navigator.clipboard.writeText(code).then(() => {
          const detailedTime = getDetailedCountdown();
          showDialog('邀请码已复制', `专属邀请码: ${code}\n有效期剩余 ${detailedTime}`);
        }).catch(() => {
          fallbackCopyCode(code);
        });
      } else {
        fallbackCopyCode(code);
      }
    }
    
    // 获取详细倒计时时间
    function getDetailedCountdown() {
      const total = 168 * 3600 * 1000;
      const now = Date.now();
      const inviteRemainingMs = Math.max(0, (inviteStart + total) - now);
      const days = Math.floor(inviteRemainingMs / (24 * 3600000));
      const hrs = Math.floor((inviteRemainingMs % (24 * 3600000)) / 3600000);
      const mins = Math.floor((inviteRemainingMs % 3600000) / 60000);
      
      let result = '';
      if (days > 0) result += `${days}天`;
      if (hrs > 0) result += `${hrs}小时`;
      if (mins > 0) result += `${mins}分钟`;
      if (result === '') result = '不足1分钟';
      
      return result;
    }
    
    // 降级复制方案
    function fallbackCopy(text) {
      const textArea = document.createElement('textarea');
      textArea.value = text;
      document.body.appendChild(textArea);
      textArea.select();
      try {
        document.execCommand('copy');
        const detailedTime = getDetailedCountdown();
        showDialog('邀请链接已复制', `有效期剩余 ${detailedTime}`);
      } catch (err) {
        showDialog('复制失败', '请手动复制链接');
      }
      document.body.removeChild(textArea);
    }
    
    // 降级复制邀请码方案
    function fallbackCopyCode(code) {
      const textArea = document.createElement('textarea');
      textArea.value = code;
      document.body.appendChild(textArea);
      textArea.select();
      try {
        document.execCommand('copy');
        const detailedTime = getDetailedCountdown();
        showDialog('邀请码已复制', `专属邀请码: ${code}\n有效期剩余 ${detailedTime}`);
      } catch (err) {
        showDialog('复制失败', '请手动复制邀请码');
      }
      document.body.removeChild(textArea);
    }
    /**
     * 抢红包功能
     * 检查时间窗口、用户资格，并处理抢红包逻辑
     */
    function grabRedPacket() {
      // 检查资格：仅状态2有红包按钮
      if (currentState !== 2) {
        showDialog('无抢红包资格', '只有在激活状态才可以抢红包。');
        return;
      }
      
      // 保存当前状态到localStorage
      saveState();
      
      // 跳转到红包页面
      window.location.href = 'redpacket.html';
    }
    
    /**
     * 获取当前红包时间窗口状态
     */
    function getCurrentRedPacketTimeWindow() {
      const now = new Date();
      const currentHour = now.getHours();
      const currentMinute = now.getMinutes();
      const currentSecond = now.getSeconds();
      
      // 红包时间：9:00, 12:00, 20:00，每次持续77秒
      const redPacketTimes = [
        { hour: 9, minute: 0 },
        { hour: 12, minute: 0 },
        { hour: 20, minute: 0 }
      ];
      
      for (const time of redPacketTimes) {
        if (currentHour === time.hour && currentMinute === time.minute && currentSecond < 77) {
          return {
            isActive: true,
            remainingSeconds: 77 - currentSecond,
            nextWindow: null
          };
        }
      }
      
      return {
        isActive: false,
        remainingSeconds: 0,
        nextWindow: getNextRedPacketTime()
      };
    }
    
    /**
     * 获取下一个红包时间
     */
    function getNextRedPacketTime() {
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      
      const redPacketTimes = [
        new Date(today.getTime() + 9 * 60 * 60 * 1000),   // 9:00
        new Date(today.getTime() + 12 * 60 * 60 * 1000),  // 12:00
        new Date(today.getTime() + 20 * 60 * 60 * 1000)   // 20:00
      ];
      
      // 找到下一个时间
      for (const time of redPacketTimes) {
        if (now < time) {
          return time.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
        }
      }
      
      // 如果今天的时间都过了，返回明天的第一个时间
      const tomorrow = new Date(today.getTime() + 24 * 60 * 60 * 1000);
      const tomorrowFirst = new Date(tomorrow.getTime() + 9 * 60 * 60 * 1000);
      return `明天 ${tomorrowFirst.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })}`;
    }
    
    /**
     * 执行抢红包操作
     */
    function performRedPacketGrab() {
      // 显示抢红包动画
      showDialog('抢红包中...', '正在为您抢夺红包，请稍候...', null, 'redpacket');
      
      // 模拟网络延迟
      setTimeout(() => {
        // 随机生成红包金额（1-100 USDT）
        const amount = Math.floor(Math.random() * 100) + 1;
        const isSuccess = Math.random() > 0.3; // 70%成功率
        
        if (isSuccess) {
          // 抢红包成功
          walletBalance += amount;
          
          // 记录红包收入
          const record = {
            id: Date.now(),
            amount: amount,
            timestamp: new Date().toISOString(),
            type: 'grab'
          };
          
          redPacketRecords.unshift(record);
          
          // 添加交易记录
          transactions.unshift({
            type: 'income',
            amount: amount,
            description: '抢红包收入',
            timestamp: new Date().toISOString()
          });
          
          // 生成团队消息
          generateTeamMessage('redpacket_success', {
            amount: amount
          });
          
          // 保存状态
          saveState();
          renderState();
          
          // 显示成功提示
          showDialog('抢红包成功！', `恭喜您抢到 ${amount} USDT！`, [{ text: '太棒了', action: 'close' }], 'success');
          
        } else {
          // 抢红包失败
          showDialog('手慢了', '红包被抢完了，下次要更快哦！', [{ text: '下次一定', action: 'close' }], 'info');
        }
      }, 2000);
    }
    
    // 红包记录数组
    let redPacketRecords = [];
    
    /**
     * 初始化红包记录
     */
    function initRedPacketRecords() {
      const saved = localStorage.getItem('redPacketRecords');
      if (saved) {
        redPacketRecords = JSON.parse(saved);
      }
    }
    
    /**
     * 保存红包记录
     */
    function saveRedPacketRecords() {
      localStorage.setItem('redPacketRecords', JSON.stringify(redPacketRecords));
    }
    /**
     * 我的团队功能
     * 显示团队结构、成员信息和分佣数据
     */
    function showTeam() {
      // 保存当前状态到localStorage
      saveState();
      
      // 跳转到团队页面
      window.location.href = 'team.html';
    }
    
    /**
     * 获取团队数据
     */
    function getTeamData() {
      // 从localStorage获取或生成团队数据
      let teamData = JSON.parse(localStorage.getItem('teamData') || '{}');
      
      if (!teamData.inviteCode) {
        teamData = {
          totalMembers: teamMembers || 0,
          directMembers: Math.floor((teamMembers || 0) * 0.3), // 30%为直推
          totalEarnings: totalEarnings || 0,
          inviteCode: generateInviteCode(),
          inviteLink: '',
          levels: generateTeamLevels()
        };
        
        teamData.inviteLink = `https://gold7.com/login.html?invite=${teamData.inviteCode}`;
        localStorage.setItem('teamData', JSON.stringify(teamData));
      }
      
      return teamData;
    }
    
    /**
     * 生成邀请码 - 从后端API获取
     */
    async function generateInviteCode() {
      try {
        const response = await apiRequest('/user/invite-code');
        if (response.success && response.data.inviteCode) {
          return response.data.inviteCode;
        }
      } catch (error) {
        console.error('获取邀请码失败:', error);
      }
      
      // 如果API调用失败，生成基于时间戳的备用邀请码
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      const timestamp = Date.now().toString();
      let result = '';
      for (let i = 0; i < 6; i++) {
        const index = parseInt(timestamp.charAt(i % timestamp.length)) % chars.length;
        result += chars.charAt(index);
      }
      return result + timestamp.slice(-2);
    }
    
    /**
     * 生成团队层级数据
     */
    function generateTeamLevels() {
      const levels = [];
      const totalMembers = teamMembers || 0;
      
      if (totalMembers === 0) return levels;
      
      // 按层级分配成员数量
      const levelNames = ['直推', '二级', '三级', '四级', '五级', '六级', '七级'];
      const levelRatios = [0.3, 0.25, 0.2, 0.15, 0.05, 0.03, 0.02]; // 各层级占比
      
      for (let i = 0; i < 7; i++) {
        const memberCount = Math.floor(totalMembers * levelRatios[i]);
        if (memberCount > 0) {
          levels.push({
            level: i + 1,
            name: levelNames[i],
            count: memberCount,
            commission: getCommissionRate(i + 1),
            earnings: (memberCount * 10 * getCommissionRate(i + 1)).toFixed(2)
          });
        }
      }
      
      return levels;
    }
    
    /**
     * 获取各层级分佣比例
     */
    function getCommissionRate(level) {
      const rates = [0.15, 0.10, 0.08, 0.05, 0.03, 0.02, 0.01]; // 15%, 10%, 8%, 5%, 3%, 2%, 1%
      return rates[level - 1] || 0;
    }
    
    /**
     * 生成团队层级HTML
     */
    function generateTeamLevelsHTML(levels) {
      if (!levels || levels.length === 0) {
        return '<div class="no-team">暂无团队成员</div>';
      }
      
      return levels.map(level => `
        <div class="level-item">
          <div class="level-header">
            <span class="level-name">${level.name}</span>
            <span class="level-count">${level.count}人</span>
            <span class="level-commission">10 USDT</span>
            <span class="level-earnings">${level.earnings} USDT</span>
          </div>
        </div>
      `).join('');
    }
    
    /**
     * 复制团队邀请链接
     */
    function copyTeamInviteLink() {
      const linkInput = document.getElementById('teamInviteLink');
      if (linkInput) {
        const link = linkInput.value;
        if (navigator.clipboard) {
          navigator.clipboard.writeText(link).then(() => {
            showDialog('复制成功', '邀请链接已复制到剪贴板', [{ text: '确定', action: 'close' }], 'success');
          }).catch(() => {
            fallbackCopyText(link, '邀请链接');
          });
        } else {
          fallbackCopyText(link, '邀请链接');
        }
      }
    }
    
    /**
     * 复制团队邀请码
     */
    function copyTeamInviteCode() {
      const codeEl = document.getElementById('teamInviteCode');
      if (codeEl) {
        const code = codeEl.textContent;
        if (navigator.clipboard) {
          navigator.clipboard.writeText(code).then(() => {
            showDialog('复制成功', `邀请码 ${code} 已复制到剪贴板`, [{ text: '确定', action: 'close' }], 'success');
          }).catch(() => {
            fallbackCopyText(code, '邀请码');
          });
        } else {
          fallbackCopyText(code, '邀请码');
        }
      }
    }
    
    /**
     * 降级复制方案
     */
    function fallbackCopyText(text, type) {
      const textArea = document.createElement('textarea');
      textArea.value = text;
      document.body.appendChild(textArea);
      textArea.select();
      try {
        document.execCommand('copy');
        showDialog('复制成功', `${type}已复制到剪贴板`, [{ text: '确定', action: 'close' }], 'success');
      } catch (err) {
        showDialog('复制失败', `请手动复制${type}`, [{ text: '确定', action: 'close' }], 'info');
      }
      document.body.removeChild(textArea);
    }
    /**
     * 我的钱包功能
     * 显示余额、交易记录和提现功能
     */
    function showWallet() {
      // 保存当前状态到localStorage
      saveState();
      
      // 跳转到钱包页面
      window.location.href = 'wallet.html';
    }
    
    /**
     * 获取钱包数据
     */
    function getWalletData() {
      const address = localStorage.getItem('walletAddress') || '未绑定';
      const displayAddress = address === '未绑定' ? '未绑定' : 
        `${address.substring(0, 8)}...${address.substring(address.length - 6)}`;
      
      return {
        balance: walletBalance || 0,
        address: displayAddress,
        withdrawFeeRate: withdrawFeeRate || 0.05,
        transactions: transactions.slice(0, 5) // 显示最近5条记录
      };
    }
    
    /**
     * 生成交易记录HTML
     */
    function generateTransactionListHTML(transactionList) {
      if (!transactionList || transactionList.length === 0) {
        return '<div class="no-transactions">暂无交易记录</div>';
      }
      
      return transactionList.map(tx => {
        const isIncome = tx.type === 'income' || tx.amount > 0;
        const amountClass = isIncome ? 'amount-positive' : 'amount-negative';
        const amountPrefix = isIncome ? '+' : '-';
        
        return `
          <div class="transaction-item">
            <div class="tx-info">
              <div class="tx-description">${tx.description || tx.type}</div>
              <div class="tx-time">${formatTransactionTime(tx.timestamp)}</div>
            </div>
            <div class="tx-amount ${amountClass}">
              ${amountPrefix}${Math.abs(tx.amount).toFixed(2)} USDT
            </div>
          </div>
        `;
      }).join('');
    }
    
    /**
     * 格式化交易时间
     */
    function formatTransactionTime(timestamp) {
      const date = new Date(timestamp);
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / (1000 * 60));
      const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
      const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
      
      if (diffMins < 1) return '刚刚';
      if (diffMins < 60) return `${diffMins}分钟前`;
      if (diffHours < 24) return `${diffHours}小时前`;
      if (diffDays < 7) return `${diffDays}天前`;
      
      return date.toLocaleDateString('zh-CN');
    }
    
    /**
     * 显示提现对话框
     */
    function showWithdrawDialog() {
      const maxWithdraw = Math.max(0, (walletBalance - 2) / (1 + withdrawFeeRate));
      
      const withdrawContent = `
        <div class="withdraw-form">
          <div class="form-group">
            <label>提现金额 (USDT)</label>
            <input type="number" id="withdrawAmount" placeholder="请输入提现金额" 
                   max="${maxWithdraw.toFixed(2)}" min="1" step="0.01">
            <div class="amount-tips">
              <button onclick="setWithdrawAmount(10)" class="quick-amount">10</button>
              <button onclick="setWithdrawAmount(50)" class="quick-amount">50</button>
              <button onclick="setWithdrawAmount(100)" class="quick-amount">100</button>
              <button onclick="setWithdrawAmount('max')" class="quick-amount">全部</button>
            </div>
          </div>
          
          <div class="fee-calculation">
            <div class="fee-row">
              <span>提现金额：</span>
              <span id="withdrawAmountDisplay">0.00 USDT</span>
            </div>
            <div class="fee-row">
              <span>手续费 (${(withdrawFeeRate * 100).toFixed(1)}%)：</span>
              <span id="percentFeeDisplay">0.00 USDT</span>
            </div>
            <div class="fee-row">
              <span>固定手续费：</span>
              <span>2.00 USDT</span>
            </div>
            <div class="fee-row total">
              <span>总扣除：</span>
              <span id="totalDeductDisplay">0.00 USDT</span>
            </div>
          </div>
          
          <div class="wallet-address-check">
            <div>提现地址：${localStorage.getItem('walletAddress') || '未绑定'}</div>
            ${!localStorage.getItem('walletAddress') ? 
              '<div class="address-warning">请先绑定钱包地址</div>' : ''}
          </div>
        </div>
      `;
      
      showDialog('提现申请', withdrawContent, [
        { text: '确认提现', action: () => processWithdraw(), style: 'primary' },
        { text: '取消', action: 'close' }
      ], 'withdraw');
      
      // 绑定输入事件
      setTimeout(() => {
        const amountInput = document.getElementById('withdrawAmount');
        if (amountInput) {
          amountInput.addEventListener('input', updateWithdrawCalculation);
        }
      }, 100);
    }
    
    /**
     * 设置提现金额
     */
    function setWithdrawAmount(amount) {
      const amountInput = document.getElementById('withdrawAmount');
      if (!amountInput) return;
      
      if (amount === 'max') {
        const maxWithdraw = Math.max(0, (walletBalance - 2) / (1 + withdrawFeeRate));
        amountInput.value = maxWithdraw.toFixed(2);
      } else {
        amountInput.value = amount;
      }
      
      updateWithdrawCalculation();
    }
    
    /**
     * 更新提现计算
     */
    function updateWithdrawCalculation() {
      const amountInput = document.getElementById('withdrawAmount');
      const amount = parseFloat(amountInput?.value || 0);
      
      const percentFee = amount * withdrawFeeRate;
      const fixedFee = 2;
      const totalDeduct = amount + percentFee + fixedFee;
      
      document.getElementById('withdrawAmountDisplay').textContent = `${amount.toFixed(2)} USDT`;
      document.getElementById('percentFeeDisplay').textContent = `${percentFee.toFixed(2)} USDT`;
      document.getElementById('totalDeductDisplay').textContent = `${totalDeduct.toFixed(2)} USDT`;
    }
    
    /**
     * 处理提现
     */
    function processWithdraw() {
      const amountInput = document.getElementById('withdrawAmount');
      const amount = parseFloat(amountInput?.value || 0);
      const walletAddress = localStorage.getItem('walletAddress');
      
      // 验证
      if (!walletAddress) {
        showDialog('提现失败', '请先绑定钱包地址', [{ text: '确定', action: 'close' }], 'error');
        return;
      }
      
      if (amount <= 0) {
        showDialog('提现失败', '请输入有效的提现金额', [{ text: '确定', action: 'close' }], 'error');
        return;
      }
      
      const percentFee = amount * withdrawFeeRate;
      const fixedFee = 2;
      const totalDeduct = amount + percentFee + fixedFee;
      
      if (totalDeduct > walletBalance) {
        showDialog('提现失败', '余额不足，请减少提现金额', [{ text: '确定', action: 'close' }], 'error');
        return;
      }
      
      // 执行提现
      walletBalance -= totalDeduct;
      
      // 添加提现记录
      transactions.unshift({
        type: 'withdraw',
        amount: -amount,
        description: '提现申请',
        timestamp: new Date().toISOString(),
        fee: percentFee + fixedFee,
        address: walletAddress,
        status: 'processing'
      });
      
      // 保存状态
      saveState();
      renderState();
      
      showDialog('提现成功', 
        `提现申请已提交\n提现金额：${amount.toFixed(2)} USDT\n手续费：${(percentFee + fixedFee).toFixed(2)} USDT\n预计24小时内到账`, 
        [{ text: '确定', action: 'close' }], 'success');
    }
    
    /**
     * 显示地址绑定对话框
     */
    function showAddressBinding() {
      const currentAddress = localStorage.getItem('walletAddress') || '';
      
      const addressContent = `
        <div class="address-form">
          <div class="form-group">
            <label>USDT TRC20 钱包地址</label>
            <input type="text" id="walletAddressInput" placeholder="请输入USDT TRC20钱包地址" 
                   value="${currentAddress}">
            <div class="address-tips">
              <div>• 仅支持USDT TRC20地址</div>
              <div>• 地址以T开头，长度为34位</div>
              <div>• 请确保地址正确，错误地址将导致资产丢失</div>
            </div>
          </div>
        </div>
      `;
      
      showDialog('绑定钱包地址', addressContent, [
        { text: '确认绑定', action: () => saveWalletAddress(), style: 'primary' },
        { text: '取消', action: 'close' }
      ], 'address');
    }
    
    /**
     * 保存钱包地址
     */
    function saveWalletAddress() {
      const addressInput = document.getElementById('walletAddressInput');
      const address = addressInput?.value.trim();
      
      if (!address) {
        showDialog('绑定失败', '请输入钱包地址', [{ text: '确定', action: 'close' }], 'error');
        return;
      }
      
      // 验证USDT TRC20地址格式
      if (!address.startsWith('T') || address.length !== 34) {
        showDialog('绑定失败', '请输入有效的USDT TRC20钱包地址', [{ text: '确定', action: 'close' }], 'error');
        return;
      }
      
      // 保存地址
      localStorage.setItem('walletAddress', address);
      
      showDialog('绑定成功', '钱包地址绑定成功！', [{ text: '确定', action: 'close' }], 'success');
    }
    // 排行榜
    /**
     * 排行榜系统 - 显示内嵌排行榜弹窗
     */
    function showRanking() {
      // 保存当前状态到localStorage
      saveState();
      
      // 直接跳转到排行榜页面
      window.location.href = 'ranking.html';
    }
    function showRedRanking() {
      showDialog('红包排行榜', '按红包收入USDT总额排行。');
    }
    function showGodRanking() {
      showDialog('大神排行榜', '按大神等级排行。');
    }
    /**
     * 大神任务系统
     */
    function openGodTasks() {
      // 检查大神任务是否解锁
      const completedNewbieTasks = newTasks.filter(task => task.done).length;
      const quizCorrect = parseInt(localStorage.getItem('quizCorrect')) || 0;
      const quizCompleted = quizCorrect >= 20;
      const godTasksUnlocked = completedNewbieTasks >= 3 && quizCompleted;
      
      if (!godTasksUnlocked) {
        showDialog('大神任务未解锁', '需要完成所有新手任务和答题任务才能解锁大神任务。', [
          { text: '知道了', action: 'close' }
        ]);
        return;
      }
      
      // 找到下一个未完成的大神任务
      const nextGodTask = godTasks.find(t => !t.done);
      
      if (nextGodTask) {
        // 显示大神任务详情
        showDialog('大神任务', `${nextGodTask.title}\n\n${nextGodTask.desc}\n\n完成奖励：${nextGodTask.reward} USDT\n\n点击确定标记完成`, [
          { text: '完成任务', action: () => completeGodTask(nextGodTask) },
          { text: '取消', action: 'close' }
        ]);
      } else {
        // 所有大神任务已完成
        const completedGodTasks = godTasks.filter(t => t.done).length;
        showDialog('大神任务', `恭喜！所有大神任务已完成！\n\n已完成：${completedGodTasks}/6\n\n继续邀请好友获得更多奖励。`, [
          { text: '知道了', action: 'close' }
        ]);
      }
    }

    /**
     * 完成大神任务
     */
    function completeGodTask(task) {
      // 模拟任务完成
      setTimeout(() => {
        task.done = true;
        
        // 任务奖励
        walletBalance += task.reward;
        totalEarnings += task.reward;
        
        // 记录交易
        transactions.push({ 
          type: '大神任务奖励', 
          amount: task.reward, 
          fee: 0, 
          net: task.reward, 
          time: new Date().toISOString(),
          desc: `完成${task.title}` 
        });
        
        saveState();
        renderState();
        
        // 显示任务完成弹窗
        const completedGodTasks = godTasks.filter(t => t.done).length;
        showDialog('大神任务完成', `恭喜完成大神任务：${task.title}！\n奖励：${task.reward} USDT\n当前余额：${walletBalance.toFixed(2)} USDT\n\n大神任务进度：${completedGodTasks}/6`);
        
        // 检查是否所有大神任务都完成了
        if (completedGodTasks >= 6) {
          setTimeout(() => {
            showDialog('全部完成', '🎉 恭喜！所有大神任务已完成！\n\n您已成为真正的大神！\n继续邀请好友获得更多奖励。', [
              { text: '太棒了！', action: 'close' }
            ]);
          }, 2000);
        }
      }, 1500);
    }
    /* 高级对话框 */
    // 弹窗队列管理
    let dialogQueue = [];
    let isDialogShowing = false;
    
    function showDialog(title, msg, buttons = null, type = 'normal', callback = null) {
      // 如果当前有弹窗正在显示，将新弹窗加入队列
      if (isDialogShowing) {
        dialogQueue.push({ title, msg, buttons, type, callback });
        return;
      }
      
      isDialogShowing = true;
      const dialog = document.getElementById('dialog');
      const dialogTitle = document.getElementById('dialogTitle');
      const dialogMsg = document.getElementById('dialogMsg');
      const dialogButtons = document.getElementById('dialogButtons');
      
      dialogTitle.innerText = title;
      dialogMsg.innerText = msg;
      
      // 根据类型添加特殊样式
       dialog.className = 'dialog';
       if (title.includes('任务完成') || title.includes('恭喜') || title.includes('成功') || title.includes('抢红包成功') || title.includes('激活成功') || type === 'success') {
         dialog.classList.add('success');
       }
       if (type === 'redpacket') {
         dialog.classList.add('redpacket');
       }
       if (type === 'countdown') {
         dialog.classList.add('countdown');
       }
      
      if (buttons && Array.isArray(buttons)) {
        // 自定义按钮
        dialogButtons.innerHTML = '';
        buttons.forEach(button => {
          const btn = document.createElement('button');
          btn.textContent = button.text;
          btn.className = button.style === 'danger' ? 'danger-btn' : (button.style === 'secondary' ? 'secondary-btn' : '');
          btn.onclick = () => {
            closeDialog(() => {
              // 处理WebSocket消息中的特殊动作
              if (button.action === 'grabRedPacket') {
                grabRedPacket();
              } else if (button.action === 'showTasks') {
                // 显示任务页面或任务弹窗
                showTasks();
              } else if (button.action === 'close') {
                // 仅关闭弹窗，无其他动作
              } else if (button.action) {
                button.action();
              }
              if (callback) {
                callback();
              }
            });
          };
          dialogButtons.appendChild(btn);
        });
      } else {
        // 默认确定按钮
        dialogButtons.innerHTML = '';
        const defaultBtn = document.createElement('button');
        defaultBtn.textContent = '确定';
        defaultBtn.onclick = () => {
          closeDialog(callback);
        };
        dialogButtons.appendChild(defaultBtn);
      }
      
      // 显示弹窗并添加动画
      dialog.style.display = 'flex';
      setTimeout(() => {
        dialog.classList.add('show');
      }, 10);
    }
    
    function closeDialog(callback = null) {
      const dialog = document.getElementById('dialog');
      dialog.classList.remove('show');
      setTimeout(() => {
        dialog.style.display = 'none';
        dialog.className = 'dialog'; // 重置类名
        isDialogShowing = false;
        
        if (callback) {
          callback();
        }
        
        // 处理队列中的下一个弹窗，添加500ms延迟避免视觉冲突
        if (dialogQueue.length > 0) {
          setTimeout(() => {
            const nextDialog = dialogQueue.shift();
            showDialog(nextDialog.title, nextDialog.msg, nextDialog.buttons, nextDialog.type, nextDialog.callback);
          }, 500);
        }
      }, 300);
    }

    /**
     * 显示支付对话框
     * @param {Object} activationData - 激活数据，包含钱包地址、金额、订单ID等
     */
    function showPaymentDialog(activationData) {
      const { walletAddress, amount, orderId, expiresAt } = activationData;
      
      // 创建支付对话框HTML
      const paymentDialogHTML = `
        <div id="paymentDialog" class="payment-dialog">
          <div class="payment-box">
            <div class="payment-header">
              <h3>💰 激活账号支付</h3>
              <button class="close-btn" onclick="closePaymentDialog()">×</button>
            </div>
            
            <div class="payment-info">
              <div class="amount-section">
                <div class="amount-label">支付金额</div>
                <div class="amount-value">${amount} USDT</div>
              </div>
              
              <div class="wallet-section">
                <div class="wallet-label">收款地址 (TRC20)</div>
                <div class="wallet-address" id="paymentWalletAddress">${walletAddress}</div>
                <button class="copy-btn" onclick="copyWalletAddress()">复制地址</button>
              </div>
              
              <div class="qr-section">
                <div class="qr-label">扫码支付</div>
                <div class="qr-code" id="paymentQRCode">
                  <canvas id="qrCanvas"></canvas>
                </div>
              </div>
              
              <div class="countdown-section">
                <div class="countdown-label">支付剩余时间</div>
                <div class="countdown-timer" id="paymentCountdown">30:00</div>
              </div>
              
              <div class="order-section">
                <div class="order-label">订单号</div>
                <div class="order-id">${orderId}</div>
              </div>
            </div>
            
            <div class="payment-status">
              <div class="status-indicator" id="paymentStatus">
                <div class="loading-spinner"></div>
                <span>等待支付中...</span>
              </div>
            </div>
            
            <div class="payment-tips">
              <p>⚠️ 请务必使用TRC20网络转账</p>
              <p>💡 支付完成后系统将自动确认</p>
              <p>🔄 支付状态每10秒自动检查一次</p>
            </div>
          </div>
        </div>
      `;
      
      // 添加到页面
      document.body.insertAdjacentHTML('beforeend', paymentDialogHTML);
      
      // 生成二维码
      generatePaymentQRCode(walletAddress, amount);
      
      // 开始倒计时
      startPaymentCountdown(expiresAt);
      
      // 开始监控支付状态
      startPaymentMonitoring(orderId);
      
      // 显示对话框
      const paymentDialog = document.getElementById('paymentDialog');
      setTimeout(() => {
        paymentDialog.classList.add('show');
      }, 100);
    }

    /**
     * 生成支付二维码
     * @param {string} walletAddress - 钱包地址
     * @param {number} amount - 支付金额
     */
    function generatePaymentQRCode(walletAddress, amount) {
      try {
        // 构建TRON支付链接
        const qrText = `tron:${walletAddress}?amount=${amount}&token=TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t`;
        const canvas = document.getElementById('qrCanvas');
        
        // 使用在线二维码生成服务作为临时解决方案
        const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(qrText)}`;
        
        // 创建二维码图片
        const qrImage = document.createElement('img');
        qrImage.src = qrCodeUrl;
        qrImage.style.width = '200px';
        qrImage.style.height = '200px';
        qrImage.alt = '支付二维码';
        
        // 替换canvas为图片
        const qrContainer = document.getElementById('paymentQRCode');
        qrContainer.innerHTML = '';
        qrContainer.appendChild(qrImage);
        
        // 添加提示信息
        const qrTip = document.createElement('div');
        qrTip.style.marginTop = '10px';
        qrTip.style.fontSize = '12px';
        qrTip.style.color = '#666';
        qrTip.textContent = `扫码支付 ${amount} USDT`;
        qrContainer.appendChild(qrTip);
        
      } catch (error) {
        console.error('生成二维码失败:', error);
        document.getElementById('paymentQRCode').innerHTML = '<div class="qr-error">二维码生成失败</div>';
      }
    }

    /**
     * 开始支付倒计时
     * @param {string} expiresAt - 过期时间
     */
    /**
     * 开始支付倒计时
     * @param {string|Date|number} expiresAt - 过期时间
     */
    function startPaymentCountdown(expiresAt) {
      const countdownElement = document.getElementById('paymentCountdown');
      
      // 处理不同格式的过期时间
      let expiryTime;
      if (!expiresAt) {
        // 如果没有提供过期时间，默认30分钟
        expiryTime = Date.now() + (30 * 60 * 1000);
      } else if (typeof expiresAt === 'number') {
        expiryTime = expiresAt;
      } else {
        expiryTime = new Date(expiresAt).getTime();
      }
      
      // 验证时间是否有效
      if (isNaN(expiryTime)) {
        console.warn('无效的过期时间，使用默认30分钟:', expiresAt);
        expiryTime = Date.now() + (30 * 60 * 1000);
      }
      
      const countdownInterval = setInterval(() => {
        const now = Date.now();
        const timeLeft = expiryTime - now;
        
        if (timeLeft <= 0) {
          clearInterval(countdownInterval);
          countdownElement.textContent = '已过期';
          countdownElement.style.color = '#ff4444';
          
          // 显示过期提示
          const statusElement = document.getElementById('paymentStatus');
          if (statusElement) {
            statusElement.innerHTML = '<span style="color: #ff4444;">⏰ 支付已过期</span>';
          }
          
          return;
        }
        
        const minutes = Math.floor(timeLeft / (1000 * 60));
        const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
        
        // 确保数字有效
        const displayMinutes = isNaN(minutes) ? 0 : minutes;
        const displaySeconds = isNaN(seconds) ? 0 : seconds;
        
        countdownElement.textContent = `${displayMinutes.toString().padStart(2, '0')}:${displaySeconds.toString().padStart(2, '0')}`;
      }, 1000);
      
      // 保存倒计时ID以便清理
      window.paymentCountdownInterval = countdownInterval;
    }

    /**
     * 开始监控支付状态
     * @param {string} orderId - 订单ID
     */
    function startPaymentMonitoring(orderId) {
      let checkCount = 0;
      const maxChecks = 180; // 最多检查30分钟（每10秒一次）
      
      const monitoringInterval = setInterval(async () => {
        checkCount++;
        
        if (checkCount > maxChecks) {
          clearInterval(monitoringInterval);
          const statusElement = document.getElementById('paymentStatus');
          statusElement.innerHTML = '<span style="color: #ff4444;">⏰ 监控超时</span>';
          return;
        }
        
        try {
          // 调用后端API检查支付状态
          const response = await fetch(`/api/activation/status/${orderId}`, {
            method: 'GET',
            headers: {
              'Authorization': `Bearer ${localStorage.getItem('authToken') || 'demo-token'}`,
              'Content-Type': 'application/json'
            }
          });
          
          if (response.ok) {
            const statusData = await response.json();
            const { status, txHash } = statusData;
            
            const statusElement = document.getElementById('paymentStatus');
            
            switch (status) {
              case 'pending':
                statusElement.innerHTML = '<div class="loading-spinner"></div><span>等待支付中...</span>';
                break;
              case 'confirming':
                statusElement.innerHTML = '<div class="loading-spinner"></div><span>🔄 交易确认中...</span>';
                break;
              case 'confirmed':
                // 支付成功
                clearInterval(monitoringInterval);
                if (window.paymentCountdownInterval) {
                  clearInterval(window.paymentCountdownInterval);
                }
                
                statusElement.innerHTML = '<span style="color: #00ff88;">✅ 支付成功！</span>';
                
                // 延迟关闭支付对话框并更新用户状态
                setTimeout(() => {
                  closePaymentDialog();
                  handlePaymentSuccess(txHash);
                }, 2000);
                break;
              case 'failed':
                clearInterval(monitoringInterval);
                statusElement.innerHTML = '<span style="color: #ff4444;">❌ 支付失败</span>';
                break;
            }
          }
        } catch (error) {
          console.error('检查支付状态失败:', error);
          // 继续监控，不中断
        }
      }, 10000); // 每10秒检查一次
      
      // 保存监控ID以便清理
      window.paymentMonitoringInterval = monitoringInterval;
    }

    /**
     * 处理支付成功
     * @param {string} txHash - 交易哈希
     */
    function handlePaymentSuccess(txHash) {
      // 更新用户状态到状态2
      currentState = 2;
      countdownStart = Date.now();
      inviteStart = Date.now();
      
      // 记录交易
      const transaction = {
        id: Date.now().toString(),
        type: 'activation',
        amount: 100,
        status: 'completed',
        txHash: txHash,
        timestamp: Date.now(),
        description: '账号激活'
      };
      
      transactions.unshift(transaction);
      
      // 保存状态
      saveState();
      
      // 重新渲染页面
      renderState();
      
      // 显示成功提示
      showDialog('激活成功', '🎉 恭喜！账号激活成功！\n\n您现在可以开始挑战任务，邀请好友获得奖励！', [
        { text: '开始挑战', action: 'close' }
      ], 'success');
    }

    /**
     * 复制钱包地址
     */
    function copyWalletAddress() {
      const walletAddress = document.getElementById('paymentWalletAddress').textContent;
      
      if (navigator.clipboard) {
        navigator.clipboard.writeText(walletAddress).then(() => {
          showDialog('复制成功', '钱包地址已复制到剪贴板');
        }).catch(() => {
          fallbackCopyWalletAddress(walletAddress);
        });
      } else {
        fallbackCopyWalletAddress(walletAddress);
      }
    }

    /**
     * 降级复制钱包地址方案
     * @param {string} address - 钱包地址
     */
    function fallbackCopyWalletAddress(address) {
      const textArea = document.createElement('textarea');
      textArea.value = address;
      document.body.appendChild(textArea);
      textArea.select();
      
      try {
        document.execCommand('copy');
        showDialog('复制成功', '钱包地址已复制到剪贴板');
      } catch (err) {
        showDialog('复制失败', '请手动复制钱包地址');
      }
      
      document.body.removeChild(textArea);
    }

    /**
     * 关闭支付对话框
     */
    function closePaymentDialog() {
      const paymentDialog = document.getElementById('paymentDialog');
      if (paymentDialog) {
        paymentDialog.classList.remove('show');
        
        // 清理定时器
        if (window.paymentCountdownInterval) {
          clearInterval(window.paymentCountdownInterval);
        }
        if (window.paymentMonitoringInterval) {
          clearInterval(window.paymentMonitoringInterval);
        }
        
        setTimeout(() => {
          paymentDialog.remove();
        }, 300);
      }
    }

    /**
     * 重置测试数据
     */
    /**
     * 重置用户数据 - 已移除功能
     */
    /*
    async function resetTestData() {
      if(confirm('确定要重置所有数据吗？此操作不可撤销。')) {
        try {
          // 调用后端API重置用户数据
          const response = await apiRequest('/api/user/reset', {
            method: 'POST'
          });
          
          if (response.success) {
            // 清空本地存储
            localStorage.removeItem('userTasks');
            localStorage.removeItem('quizCompleted');
            localStorage.removeItem('godTasksCompleted');
            localStorage.removeItem('userBalance');
            localStorage.removeItem('teamSize');
            localStorage.removeItem('quizIndex');
            localStorage.removeItem('quizCorrect');
            localStorage.removeItem('transactions');
            localStorage.removeItem('appState');
            localStorage.removeItem('teamData');
            localStorage.removeItem('recentRed');
            
            // 重置全局变量到初始状态
            transactions = [];
            userLevel = 0;
            completedNewbieTasks = 0;
            godTasksUnlocked = false;
            teamMembers = 0;
            totalEarnings = 0;
            withdrawFeeRate = 0.05;
            walletBalance = 0;
            countdownStart = null;
            inviteStart = null;
            
            // 重置到状态1
            currentState = 1;
            
            // 重新同步数据并渲染页面
            await syncWithBackend();
            renderState();
            
            showDialog('重置成功', '用户数据已重置，请重新开始挑战。');
          } else {
            throw new Error(response.message || '重置失败');
          }
        } catch (error) {
          console.error('重置数据失败:', error);
          showDialog('重置失败', '网络错误，请稍后重试。');
        }
      }
    }
    */

    /**
     * 强制风格选择弹窗
     */
    function showForceThemeSelection(teamSize, balance) {
      const themes = {
        'cyberpunk': { name: '赛博朋克', icon: '🌆', description: '未来科技感' },

        'business': { name: '商务蓝', icon: '💼', description: '专业稳重' },
        'dark-tech': { name: '暗黑科技', icon: '⚡', description: '神秘酷炫' },
        'fresh': { name: '清新绿', icon: '🌿', description: '自然清新' }
      };
      
      const themeOptionsHTML = Object.entries(themes).map(([key, theme]) => `
        <div class="force-theme-option" data-theme="${key}">
          <span class="force-theme-icon">${theme.icon}</span>
          <div class="force-theme-info">
            <div class="force-theme-name">${theme.name}</div>
            <div class="force-theme-desc">${theme.description}</div>
          </div>
        </div>
      `).join('');
      
      const modalHTML = `
        <div id="forceThemeModal" class="force-theme-modal">
          <div class="force-theme-content">
            <div class="force-theme-header">
              <h2>🎨 选择您的专属风格</h2>
              <p>数据重置成功！请选择一个风格主题继续使用</p>
            </div>
            <div class="force-theme-options">
              ${themeOptionsHTML}
            </div>
            <div class="force-theme-footer">
              <p class="force-theme-info-text">团队人数：${teamSize}人 | 余额：${balance} USDT | 所有任务已重置</p>
            </div>
          </div>
        </div>
      `;
      
      // 添加样式
      const styleHTML = `
        <style>
        .force-theme-modal {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.8);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 10000;
          backdrop-filter: blur(10px);
        }
        .force-theme-content {
          background: var(--bg-card);
          border-radius: 20px;
          padding: 24px;
          max-width: 400px;
          width: 90%;
          box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
          border: 1px solid var(--border-color);
        }
        .force-theme-header {
          text-align: center;
          margin-bottom: 20px;
        }
        .force-theme-header h2 {
          color: var(--text-primary);
          margin: 0 0 8px 0;
          font-size: 20px;
        }
        .force-theme-header p {
          color: var(--text-secondary);
          margin: 0;
          font-size: 14px;
        }
        .force-theme-options {
          display: flex;
          flex-direction: column;
          gap: 8px;
          margin-bottom: 20px;
        }
        .force-theme-option {
          display: flex;
          align-items: center;
          gap: 12px;
          padding: 12px;
          border: 2px solid var(--border-color);
          border-radius: 12px;
          cursor: pointer;
          transition: all 0.3s ease;
          background: var(--bg-secondary);
        }
        .force-theme-option:hover {
          border-color: var(--accent-color);
          transform: translateY(-2px);
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        .force-theme-option.selected {
          border-color: var(--accent-color);
          background: var(--btn-gradient);
          color: var(--text-primary);
        }
        .force-theme-icon {
          font-size: 24px;
          width: 32px;
          text-align: center;
        }
        .force-theme-info {
          flex: 1;
        }
        .force-theme-name {
          font-weight: 600;
          font-size: 16px;
          margin-bottom: 2px;
        }
        .force-theme-desc {
          font-size: 12px;
          opacity: 0.8;
        }
        .force-theme-footer {
          text-align: center;
        }
        .force-theme-info-text {
          font-size: 12px;
          color: var(--text-secondary);
          margin: 0;
        }
        </style>
      `;
      
      // 插入样式和模态框
      document.head.insertAdjacentHTML('beforeend', styleHTML);
      document.body.insertAdjacentHTML('beforeend', modalHTML);
      
      // 绑定事件
      const modal = document.getElementById('forceThemeModal');
      const options = document.querySelectorAll('.force-theme-option');
      
      options.forEach(option => {
        option.addEventListener('click', () => {
          const selectedTheme = option.getAttribute('data-theme');
          
          // 应用选中的主题
          if (window.themeSwitcher) {
            window.themeSwitcher.switchTheme(selectedTheme);
          } else {
            document.documentElement.setAttribute('data-theme', selectedTheme === 'cyberpunk' ? '' : selectedTheme);
            localStorage.setItem('selectedTheme', selectedTheme);
          }
          
          // 关闭模态框
          modal.remove();
          
          // 显示成功信息
          const themeName = themes[selectedTheme].name;
          showDialog('风格设置成功', `已切换至${themeName}风格\n团队人数：${teamSize}人\n余额：${balance} USDT\n所有任务已重置`);
        });
      });
    }

    /**
     * 模态弹窗管理
     */
    const modal = document.getElementById('modal');
    const modalClose = document.getElementById('modalClose');
    const modalBody = document.getElementById('modalBody');
    modalClose.addEventListener('click', () => {
      modal.style.display = 'none';
    });
    function openModal(type) {
      let html = '';
      if(type === 'task') {
        const currentTask = newTasks.find(t => !t.done);
        if(currentTask) {
          html += `<h3 style="margin-top:0;color:var(--brand)">${currentTask.title}</h3>`;
          html += `<p style="font-size:14px;color:var(--muted)">${currentTask.desc ? currentTask.desc : '完成此任务可推进进度。'}</p>`;
          html += `<button class="btn" id="modalTaskDone" style="margin-top:16px;width:100%">标记完成</button>`;
        } else {
          html += `<h3 style="margin-top:0;color:var(--brand)">所有新手任务已完成</h3>`;
          html += `<p style="font-size:14px;color:var(--muted)">无需再执行新手任务。</p>`;
        }
      } else if(type === 'wallet') {
        html += `<h3 style="margin-top:0;color:var(--brand)">我的钱包</h3>`;
        html += `<p style="font-size:14px;color:var(--muted)">当前余额：-- USDT</p>`;
        html += `<button class="btn" style="margin-top:16px;width:100%">提现</button>`;
      } else if(type === 'team') {
        html += `<h3 style="margin-top:0;color:var(--brand)">我的团队</h3>`;
        html += `<div style="font-size:14px;color:var(--muted)">
          <p>团队总人数：<span id="teamTotalCount">--</span></p>
          <p>直推人数：<span id="directCount">--</span></p>
          <p>团队业绩：<span id="teamPerformance">-- USDT</span></p>
        </div>`;
      } else if(type === 'ranking') {
        html += `<h3 style="margin-top:0;color:var(--brand)">排行榜</h3>`;
        html += `<div style="font-size:14px;color:var(--muted)">
          <div style="margin-bottom:16px">
            <h4 style="margin:0 0 8px 0;color:var(--brand)">团队排行</h4>
            <p>暂无数据</p>
          </div>
          <div style="margin-bottom:16px">
            <h4 style="margin:0 0 8px 0;color:var(--brand)">红包排行</h4>
            <p>暂无数据</p>
          </div>
          <div>
            <h4 style="margin:0 0 8px 0;color:var(--brand)">大神排行</h4>
            <p>暂无数据</p>
          </div>
        </div>`;
      }
      modalBody.innerHTML = html;
      modal.style.display = 'flex';
      // 绑定任务完成按钮
      const completeBtn = document.getElementById('modalTaskDone');
      if(completeBtn) {
        completeBtn.addEventListener('click', () => {
          const task = newTasks.find(t => !t.done);
          if(task) task.done = true;
          modal.style.display = 'none';
          renderState();
        });
      }
    }

    // 退出登录功能
    // 确认退出登录
    function confirmLogout() {
      // 先关闭设置界面
      closeSettings();
      
      // 然后显示确认退出对话框
      showDialog('确认退出', '退出登录将清除所有本地数据，确定要继续吗？', [
        {
          text: '取消',
          style: 'secondary',
          action: () => {}
        },
        {
          text: '确认退出',
          style: 'danger',
          action: logout
        }
      ]);
    }
    
    function logout() {
      // 清除所有用户相关的本地存储数据
      localStorage.removeItem('userEmail');
      localStorage.removeItem('userPassword');
      localStorage.removeItem('appState');
      localStorage.removeItem('userInviteCode');
      localStorage.removeItem('teamData');
      localStorage.removeItem('language');
      localStorage.removeItem('userStatus');
      localStorage.removeItem('inviteCode');
      
      // 直接跳转到登录页面
      window.location.href = 'login.html';
    }
    
    // 显示帮助信息

    
    // 显示Bug报告
    function showBugReport() {
      closeSettings();
      // 显示Bug报告弹窗
      const modal = document.getElementById('messageModal');
      modal.style.display = 'flex';
      // 直接切换到Bug报告标签页
      switchMessageTab('bug');
    }
    
    // 显示关于信息
    function showAbout() {
      closeSettings();
      showDialog('关于我们', '裂金7日 H5应用\n\n版本：v1.0.0\n更新时间：2024年1月\n\n开发团队致力于为用户提供\n最佳的互动体验');
    }

    // 设置面板功能已移至script开头

    // 主题切换功能
    function selectTheme(theme) {
      // 移除所有主题按钮的active状态
      document.querySelectorAll('.theme-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      
      // 激活选中的主题按钮
      event.target.classList.add('active');
      
      // 保存主题设置
      localStorage.setItem('theme', theme);
      
      // 应用主题（这里可以添加实际的主题切换逻辑）
      showDialog('主题设置', `已切换到${theme}主题`);
    }
    
    // Toggle开关功能
    function toggleSwitch(switchId) {
      const toggle = document.getElementById(switchId);
      const isChecked = toggle.checked;
      
      // 保存设置
      localStorage.setItem(switchId, isChecked);
      
      // 根据不同的开关执行不同的逻辑
      switch(switchId) {
        case 'soundToggle':
          showDialog('声音设置', isChecked ? '已开启声音效果' : '已关闭声音效果');
          break;
        case 'vibrationToggle':
          showDialog('震动设置', isChecked ? '已开启震动反馈' : '已关闭震动反馈');
          break;
        case 'notificationToggle':
          showDialog('通知设置', isChecked ? '已开启推送通知' : '已关闭推送通知');
          break;
      }
    }
    
    // 语言切换功能
    function changeLanguage() {
      const select = document.getElementById('languageSelect');
      const selectedLanguage = select.value;
      const selectedText = select.options[select.selectedIndex].text;
      
      localStorage.setItem('language', selectedLanguage);
      showDialog('语言设置', `已切换到：${selectedText}`);
    }

    // 初始化设置面板事件监听器
    function initSettingsEvents() {
      // 加载保存的设置
      loadSettingsFromStorage();
      
      // 语言选择器事件监听
      const languageSelect = document.getElementById('languageSelect');
      if (languageSelect) {
        languageSelect.addEventListener('change', changeLanguage);
      }
      
      // 初始化音效开关状态
      const soundToggle = document.getElementById('soundToggle');
      if (soundToggle) {
        const savedSoundEnabled = localStorage.getItem('soundEnabled');
        if (savedSoundEnabled !== null) {
          soundEnabled = savedSoundEnabled === 'true';
          soundToggle.checked = soundEnabled;
        }
      }
      
      // 点击模态框背景关闭设置面板
      document.addEventListener('click', function(e) {
        const settingsModal = document.getElementById('settingsModal');
        if (e.target === settingsModal) {
          closeSettings();
        }
      });
    }
    
    // 从本地存储加载设置
    function loadSettingsFromStorage() {
      // 加载主题设置
      const savedTheme = localStorage.getItem('theme') || 'light';
      const themeBtn = document.querySelector(`[onclick="selectTheme('${savedTheme}')"]`);
      if (themeBtn) {
        themeBtn.classList.add('active');
      }
      
      // 加载语言设置
      const savedLanguage = localStorage.getItem('language') || 'zh-CN';
      const languageSelect = document.getElementById('languageSelect');
      if (languageSelect) {
        languageSelect.value = savedLanguage;
      }
      
      // 加载开关设置
      const switches = ['soundToggle', 'vibrationToggle', 'notificationToggle'];
      switches.forEach(switchId => {
        const toggle = document.getElementById(switchId);
        if (toggle) {
          const savedState = localStorage.getItem(switchId);
          toggle.checked = savedState === 'true';
        }
      });
    }
    
    // 更新个人资料显示
    function updateProfileDisplay() {
      const userEmail = localStorage.getItem('userEmail') || 'user@example.com';
      const profileEmail = document.getElementById('profileEmail');
      if (profileEmail) {
        profileEmail.textContent = userEmail;
      }
      
      // 可以添加更多个人信息的更新逻辑
    }

    /**
     * 完成新手任务
     * @param {number} taskId - 任务ID
     */
    function completeNewbieTask(taskId) {
      const task = newTasks.find(t => t.id === taskId);
      if (!task) {
        showDialog('错误', '任务不存在！', [{ text: '确定', action: 'close' }], 'error');
        return false;
      }
      
      if (task.done) {
        showDialog('提示', '该任务已完成！', [{ text: '确定', action: 'close' }], 'info');
        return false;
      }
      
      // 检查任务完成条件（按顺序完成）
      const taskIndex = newTasks.findIndex(t => t.id === taskId);
      if (taskIndex > 0) {
        const previousTask = newTasks[taskIndex - 1];
        if (!previousTask.done) {
          showDialog('提示', '请先完成前面的任务！', [{ text: '确定', action: 'close' }], 'info');
          return false;
        }
      }
      
      // 标记任务完成
      task.done = true;
      completedNewbieTasks = newTasks.filter(t => t.done).length;
      
      // 更新钱包余额
      walletBalance += task.reward;
      
      // 添加交易记录
      transactions.unshift({
        type: 'income',
        amount: task.reward,
        description: `完成${task.title}`,
        timestamp: new Date().toISOString()
      });
      
      // 检查是否解锁答题任务
      if (completedNewbieTasks >= 1 && !quizCompleted) {
        // 第一个新手任务完成后解锁答题任务
        showDialog('恭喜', '解锁答题任务！完成答题可降低提现手续费。', [{ text: '去答题', action: () => { saveState(); window.location.href = 'quiz.html'; } }, { text: '稍后', action: 'close' }], 'success');
      }
      
      // 检查是否解锁大神任务
      if (completedNewbieTasks >= 3 && quizCompleted && !godTasksUnlocked) {
        godTasksUnlocked = true;
        showDialog('恭喜', '解锁大神任务！完成大神任务可获得更高奖励。', [{ text: '查看', action: () => window.location.href = 'tasks.html?tab=master' }, { text: '稍后', action: 'close' }], 'success');
      }
      
      // 生成团队消息
      generateTeamMessage('task_complete', {
        taskName: task.title,
        reward: task.reward
      });
      
      // 保存状态并重新渲染
      saveState();
      renderState();
      
      // 显示完成提示
      showDialog('任务完成', `恭喜完成"${task.title}"，获得${task.reward}元奖励！`, [{ text: '确定', action: 'close' }], 'success');
      
      return true;
    }
    
    /**
     * 完成答题任务
     * @param {number} correctAnswers - 正确答案数量
     */
    function completeQuizTask(correctAnswers = 20) {
      if (quizCompleted) {
        showDialog('提示', '答题任务已完成！', [{ text: '确定', action: 'close' }], 'info');
        return false;
      }
      
      // 检查是否完成至少一个新手任务
      if (completedNewbieTasks < 1) {
        showDialog('提示', '请先完成至少一个新手任务！', [{ text: '确定', action: 'close' }], 'info');
        return false;
      }
      
      // 检查答题数量
      if (correctAnswers < 20) {
        showDialog('提示', `答题正确率不足！需要答对20题，当前答对${correctAnswers}题。`, [{ text: '继续答题', action: () => { saveState(); window.location.href = 'quiz.html'; } }, { text: '稍后', action: 'close' }], 'info');
        return false;
      }
      
      // 标记答题任务完成
      quizCompleted = true;
      const quizTask = quizTasks[0];
      if (quizTask) {
        quizTask.done = true;
        
        // 更新钱包余额
        walletBalance += quizTask.reward;
        
        // 添加交易记录
        transactions.unshift({
          type: 'income',
          amount: quizTask.reward,
          description: `完成${quizTask.title}`,
          timestamp: new Date().toISOString()
        });
        
        // 降低提现手续费
        withdrawFeeRate = Math.max(0.01, withdrawFeeRate - quizTask.feeReduction);
      }
      
      // 检查是否解锁大神任务
      if (completedNewbieTasks >= 3 && !godTasksUnlocked) {
        godTasksUnlocked = true;
        showDialog('恭喜', '解锁大神任务！完成大神任务可获得更高奖励。', [{ text: '查看', action: () => window.location.href = 'tasks.html?tab=master' }, { text: '稍后', action: 'close' }], 'success');
      }
      
      // 生成团队消息
      generateTeamMessage('task_complete', {
        taskName: '答题任务',
        reward: quizTask ? quizTask.reward : 20
      });
      
      // 保存状态并重新渲染
      saveState();
      renderState();
      
      // 显示完成提示
      showDialog('答题完成', `恭喜完成答题任务，获得${quizTask ? quizTask.reward : 20}元奖励！提现手续费已降低至${(withdrawFeeRate * 100).toFixed(1)}%`, [{ text: '确定', action: 'close' }], 'success');
      
      return true;
    }
    
    /**
     * 完成大神任务
     * @param {number} taskId - 任务ID
     */
    function completeGodTask(taskId) {
      const task = godTasks.find(t => t.id === taskId);
      if (!task) {
        showDialog('错误', '任务不存在！', [{ text: '确定', action: 'close' }], 'error');
        return false;
      }
      
      if (task.done) {
        showDialog('提示', '该任务已完成！', [{ text: '确定', action: 'close' }], 'info');
        return false;
      }
      
      // 检查是否解锁大神任务
      if (!godTasksUnlocked) {
        showDialog('提示', '请先完成所有新手任务和答题任务！', [{ text: '确定', action: 'close' }], 'info');
        return false;
      }
      
      // 检查任务完成条件（按顺序完成）
      const taskIndex = godTasks.findIndex(t => t.id === taskId);
      if (taskIndex > 0) {
        const previousTask = godTasks[taskIndex - 1];
        if (!previousTask.done) {
          showDialog('提示', '请先完成前面的大神任务！', [{ text: '确定', action: 'close' }], 'info');
          return false;
        }
      }
      
      // 标记任务完成
      task.done = true;
      
      // 更新钱包余额
      walletBalance += task.reward;
      
      // 添加交易记录
      transactions.unshift({
        type: 'income',
        amount: task.reward,
        description: `完成${task.title}`,
        timestamp: new Date().toISOString()
      });
      
      // 生成团队消息
      generateTeamMessage('task_complete', {
        taskName: task.title,
        reward: task.reward
      });
      
      // 保存状态并重新渲染
      saveState();
      renderState();
      
      // 显示完成提示
      showDialog('大神任务完成', `恭喜完成"${task.title}"，获得${task.reward}元奖励！`, [{ text: '确定', action: 'close' }], 'success');
      
      return true;
    }
    
    /**
     * 获取当前可执行的任务
     */
    function getAvailableTasks() {
      const available = {
        newbie: [],
        quiz: [],
        god: []
      };
      
      // 新手任务：按顺序解锁
      for (let i = 0; i < newTasks.length; i++) {
        const task = newTasks[i];
        if (!task.done) {
          if (i === 0 || newTasks[i - 1].done) {
            available.newbie.push(task);
            break; // 只显示下一个可完成的任务
          }
        }
      }
      
      // 答题任务：完成至少一个新手任务后解锁
      if (completedNewbieTasks >= 1 && !quizCompleted) {
        available.quiz = quizTasks.filter(t => !t.done);
      }
      
      // 大神任务：完成所有新手任务和答题任务后解锁
      if (godTasksUnlocked) {
        for (let i = 0; i < godTasks.length; i++) {
          const task = godTasks[i];
          if (!task.done) {
            if (i === 0 || godTasks[i - 1].done) {
              available.god.push(task);
              break; // 只显示下一个可完成的任务
            }
          }
        }
      }
      
      return available;
    }
    
    /**
     * 获取任务完成进度
     */
    function getTaskProgress() {
      const newbieProgress = {
        completed: newTasks.filter(t => t.done).length,
        total: newTasks.length
      };
      
      const quizProgress = {
        completed: quizCompleted ? 1 : 0,
        total: 1
      };
      
      const godProgress = {
        completed: godTasks.filter(t => t.done).length,
        total: godTasks.length
      };
      
      return {
        newbie: newbieProgress,
        quiz: quizProgress,
        god: godProgress,
        overall: {
          completed: newbieProgress.completed + quizProgress.completed + godProgress.completed,
          total: newbieProgress.total + quizProgress.total + godProgress.total
        }
      };
    }


    


    // ==================== 消息系统 ====================
    
    // 音效管理
    let audioContext = null;
    let soundEnabled = true;
    
    // 初始化音效系统
    function initAudioSystem() {
      try {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        // 从本地存储读取音效设置
        const savedSoundSetting = localStorage.getItem('soundEnabled');
        if (savedSoundSetting !== null) {
          soundEnabled = JSON.parse(savedSoundSetting);
        }
      } catch (error) {
        console.warn('音效系统初始化失败:', error);
        soundEnabled = false;
      }
    }
    
    // 播放消息提示音
    function playMessageSound() {
      if (!soundEnabled) return;
      
      try {
        // 创建音频元素播放金币声效
        const audio = new Audio('金币声效.mp3');
        audio.volume = 0.5; // 设置音量为50%
        
        // 播放音效
        const playPromise = audio.play();
        
        // 处理播放Promise（现代浏览器要求）
        if (playPromise !== undefined) {
          playPromise.catch(error => {
            console.log('音效播放失败:', error);
          });
        }
        
      } catch (error) {
        console.warn('播放消息音效失败:', error);
      }
    }
    
    // 切换音效开关 - 已移除功能
    /*
    function toggleSound() {
      soundEnabled = !soundEnabled;
      localStorage.setItem('soundEnabled', JSON.stringify(soundEnabled));
      
      // 更新设置面板中的开关状态
      const soundToggle = document.querySelector('#soundToggle');
      if (soundToggle) {
        soundToggle.checked = soundEnabled;
      }
      
      // 播放测试音效（如果开启）
      if (soundEnabled) {
        playMessageSound();
      }
    }
    */
    
    // 消息数据管理
    let messages = {
      official: [],
      team: []
    };
    
    let messageReadStatus = {};
    
    // Bug报告数据管理
    let bugReports = [];
    
    // 初始化Bug报告数据
    function initBugReports() {
      const savedBugReports = localStorage.getItem('bugReports');
      if (savedBugReports) {
        bugReports = JSON.parse(savedBugReports);
      }
    }
    
    // 保存Bug报告数据
    function saveBugReports() {
      localStorage.setItem('bugReports', JSON.stringify(bugReports));
    }
    
    // 初始化消息数据
    function initMessages() {
      const savedMessages = localStorage.getItem('messages');
      const savedReadStatus = localStorage.getItem('messageReadStatus');
      
      if (savedMessages) {
        messages = JSON.parse(savedMessages);
      } else {
        // 初始化默认消息
        messages = {
          official: [
            {
              id: 'official_1',
              title: '欢迎加入平台',
              content: '欢迎您加入我们的平台！完成新手任务可获得丰厚奖励，快来体验吧！',
              time: new Date(Date.now() - 2 * 60 * 60 * 1000).toISOString(),
              category: '系统通知'
            },
            {
              id: 'official_2', 
              title: '抢红包活动开启',
              content: '每日三场红包雨活动已开启！时间：9:00、12:00、20:00，每场持续77秒，不要错过哦！',
              time: new Date(Date.now() - 1 * 60 * 60 * 1000).toISOString(),
              category: '活动公告'
            },
            {
              id: 'official_3',
              title: '平台升级公告',
              content: '为了给您提供更好的服务体验，平台将在今晚23:00-24:00进行系统维护升级，期间可能影响部分功能使用，敬请谅解！',
              time: new Date(Date.now() - 30 * 60 * 1000).toISOString(),
              category: '系统公告'
            }
          ],
          team: [
            {
              id: 'team_1',
              title: '团队收益提醒',
              content: '您的团队今日收益已更新，当前团队总收益：156.8元，继续努力！',
              time: new Date(Date.now() - 45 * 60 * 1000).toISOString(),
              category: '收益通知'
            }
          ]
        };
        saveMessages();
      }
      
      if (savedReadStatus) {
        messageReadStatus = JSON.parse(savedReadStatus);
      }
    }
    
    // 保存消息数据
    function saveMessages() {
      localStorage.setItem('messages', JSON.stringify(messages));
      localStorage.setItem('messageReadStatus', JSON.stringify(messageReadStatus));
    }
    
    // 添加新消息
    function addMessage(type, messageData) {
      const message = {
        id: `${type}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
        title: messageData.title,
        content: messageData.content,
        time: new Date().toISOString(),
        category: messageData.category || '系统消息'
      };
      
      messages[type].unshift(message);
      saveMessages();
      updateMessageButton();
      
      // 播放新消息音效
      playMessageSound();
      
      // 触发消息图标抖动效果
      const messageIcon = document.querySelector('.message-icon');
      if (messageIcon) {
        messageIcon.classList.add('shake');
        setTimeout(() => {
          messageIcon.classList.remove('shake');
        }, 600);
      }
    }
    
    // 生成团队消息
    function generateTeamMessage(action, data) {
      let title, content, category;
      
      switch (action) {
        case 'member_join':
          title = '新成员加入';
          content = `恭喜！您的团队新增了一名成员，当前团队人数：${data.teamSize}人`;
          category = '团队动态';
          break;
        case 'balance_change':
          title = '收益更新';
          content = `您的账户余额发生变化，当前余额：${data.balance}元`;
          category = '收益通知';
          break;
        case 'task_complete':
          title = '任务完成';
          content = `恭喜完成任务"${data.taskName}"，获得奖励${data.reward}元`;
          category = '任务奖励';
          break;
        default:
          return;
      }
      
      addMessage('team', { title, content, category });
    }
    
    // 显示消息弹窗
    function showMessages() {
      const modal = document.getElementById('messageModal');
      modal.style.display = 'flex';
      
      // 默认显示官方公告
      switchMessageTab('official');
    }
    
    // 隐藏消息弹窗
    function hideMessages() {
      const modal = document.getElementById('messageModal');
      modal.style.display = 'none';
    }
    
    // 关闭消息弹窗（与hideMessages功能相同，用于按钮点击）
    function closeMessages() {
      hideMessages();
    }
    
    // 切换消息标签页
    function switchMessageTab(type) {
      // 更新标签按钮状态
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      document.querySelector(`[onclick="switchMessageTab('${type}')"]`).classList.add('active');
      
      // 更新消息列表显示
      document.querySelectorAll('.message-list').forEach(list => {
        list.classList.remove('active');
      });
      document.getElementById(`${type}Messages`).classList.add('active');
      
      // 渲染对应内容
      if (type === 'bug') {
        renderBugReportList();
      } else {
        renderMessageList(type);
      }
    }
    
    // 渲染消息列表
    function renderMessageList(type) {
      const container = document.getElementById(`${type}Messages`);
      const messageList = messages[type];
      
      if (messageList.length === 0) {
        container.innerHTML = `
          <div class="empty-message">
            <div class="empty-icon">📭</div>
            <div class="empty-text">暂无${type === 'official' ? '官方公告' : '团队消息'}</div>
          </div>
        `;
        return;
      }
      
      container.innerHTML = messageList.map(message => {
        const isUnread = !messageReadStatus[message.id];
        const timeStr = formatMessageTime(message.time);
        
        // 为团队消息添加删除按钮
        const deleteButton = type === 'team' ? `
          <button class="delete-message-btn" onclick="event.stopPropagation(); deleteMessage('${type}', '${message.id}')" title="删除消息">
            🗑️
          </button>
        ` : '';
        
        return `
          <div class="message-item ${isUnread ? 'unread' : ''}" onclick="markMessageAsRead('${message.id}')">
            <div class="message-header-info">
              <h4 class="message-title-text">${message.title}</h4>
              <div class="message-header-right">
                <span class="message-time">${timeStr}</span>
                ${deleteButton}
              </div>
            </div>
            <p class="message-content-text">${message.content}</p>
            <span class="message-category">${message.category}</span>
          </div>
        `;
      }).join('');
    }
    
    // 格式化消息时间
    function formatMessageTime(timeStr) {
      const time = new Date(timeStr);
      const now = new Date();
      const diff = now - time;
      
      if (diff < 60 * 1000) {
        return '刚刚';
      } else if (diff < 60 * 60 * 1000) {
        return `${Math.floor(diff / (60 * 1000))}分钟前`;
      } else if (diff < 24 * 60 * 60 * 1000) {
        return `${Math.floor(diff / (60 * 60 * 1000))}小时前`;
      } else {
        return time.toLocaleDateString();
      }
    }
    
    // 标记消息为已读
    function markMessageAsRead(messageId) {
      messageReadStatus[messageId] = true;
      saveMessages();
      updateMessageButton();
      
      // 重新渲染当前标签页
      const activeTab = document.querySelector('.tab-btn.active');
      if (activeTab) {
        const type = activeTab.onclick.toString().includes('official') ? 'official' : 'team';
        renderMessageList(type);
      }
    }
    
    // 删除消息功能
    function deleteMessage(type, messageId) {
      // 显示确认对话框
      if (!confirm('确定要删除这条消息吗？此操作不可撤销。')) {
        return;
      }

      // 从对应类型的消息数组中找到并删除消息
      const messageList = messages[type];
      const index = messageList.findIndex(message => message.id === messageId);
      
      if (index !== -1) {
        // 删除消息
        messageList.splice(index, 1);
        
        // 删除对应的已读状态
        delete messageReadStatus[messageId];
        
        // 保存更新后的数据
        saveMessages();
        
        // 更新消息按钮状态
        updateMessageButton();
        
        // 重新渲染当前消息列表
        renderMessageList(type);
        
        // 显示删除成功提示
        alert('消息已删除！');
      } else {
        alert('未找到要删除的消息！');
      }
    }
    
    // 一键已读功能 - 标记所有消息为已读
    function markAllAsRead() {
      // 获取当前活跃的标签页类型
      const activeTab = document.querySelector('.tab-btn.active');
      if (!activeTab) return;
      
      // 检查是否在Bug报告页面
      if (activeTab.onclick.toString().includes('bug')) {
        // Bug报告页面不需要已读功能
        alert('Bug报告无需标记已读');
        return;
      }
      
      // 标记所有官方公告和团队消息为已读
      let totalMarked = 0;
      
      // 标记官方公告为已读
      messages.official.forEach(message => {
        if (!messageReadStatus[message.id]) {
          messageReadStatus[message.id] = true;
          totalMarked++;
        }
      });
      
      // 标记团队消息为已读
      messages.team.forEach(message => {
        if (!messageReadStatus[message.id]) {
          messageReadStatus[message.id] = true;
          totalMarked++;
        }
      });
      
      // 保存数据并更新界面
      saveMessages();
      updateMessageButton();
      updateTabUnreadCount();
      
      // 重新渲染当前显示的消息列表
      const currentType = activeTab.onclick.toString().includes('team') ? 'team' : 'official';
      renderMessageList(currentType);
      
      // 显示成功提示
      if (totalMarked > 0) {
        alert(`已将所有消息标记为已读（共${totalMarked}条）`);
      } else {
        alert('所有消息已经是已读状态');
      }
    }
    
    // 更新消息按钮状态（现在更新消息图标状态）
    function updateMessageButton() {
      const messageIcon = document.querySelector('.message-icon');
      const unreadDot = document.querySelector('#messageUnreadDot');
      
      if (!messageIcon || !unreadDot) return;
      
      // 检查是否有未读消息
      const hasUnread = [...messages.official, ...messages.team].some(msg => !messageReadStatus[msg.id]);
      
      if (hasUnread) {
        messageIcon.classList.add('has-unread');
        unreadDot.style.display = 'block';
      } else {
        messageIcon.classList.remove('has-unread');
        unreadDot.style.display = 'none';
      }
    }
    
    // 更新标签页未读计数
    function updateTabUnreadCount() {
      const officialCount = messages.official.filter(msg => !messageReadStatus[msg.id]).length;
      const teamCount = messages.team.filter(msg => !messageReadStatus[msg.id]).length;
      
      // 更新官方公告标签
      const officialTab = document.querySelector('[onclick="switchMessageTab(\'official\')"]');
      if (officialTab) {
        const countEl = officialTab.querySelector('.unread-count');
        if (officialCount > 0) {
          if (!countEl) {
            officialTab.innerHTML += `<span class="unread-count">${officialCount}</span>`;
          } else {
            countEl.textContent = officialCount;
          }
        } else if (countEl) {
          countEl.remove();
        }
      }
      
      // 更新团队消息标签
      const teamTab = document.querySelector('[onclick="switchMessageTab(\'team\')"]');
      if (teamTab) {
        const countEl = teamTab.querySelector('.unread-count');
        if (teamCount > 0) {
          if (!countEl) {
            teamTab.innerHTML += `<span class="unread-count">${teamCount}</span>`;
          } else {
            countEl.textContent = teamCount;
          }
        } else if (countEl) {
          countEl.remove();
        }
      }
    }

    // 发送随机官方公告

    
    // Bug报告相关函数
    
    // 提交Bug报告
    function submitBugReport(event) {
      event.preventDefault();
      
      const title = document.getElementById('bugTitle').value.trim();
      const description = document.getElementById('bugDescription').value.trim();
      const type = document.getElementById('bugType').value;
      
      if (!title || !description || !type) {
        alert('请填写完整的Bug报告信息');
        return;
      }
      
      const bugReport = {
        id: `bug_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
        title: title,
        description: description,
        type: type,
        time: new Date().toISOString(),
        status: '已提交'
      };
      
      bugReports.unshift(bugReport);
      saveBugReports();
      
      // 清空表单
      document.getElementById('bugTitle').value = '';
      document.getElementById('bugDescription').value = '';
      document.getElementById('bugType').value = '';
      
      // 重新渲染Bug报告列表
      renderBugReportList();
      
      // 显示成功提示
      alert('Bug报告提交成功！感谢您的反馈。');
    }
    
    // 渲染Bug报告列表
    function renderBugReportList() {
      const container = document.getElementById('bugReportList');
      
      if (bugReports.length === 0) {
        container.innerHTML = `
          <div class="empty-message">
            <div class="empty-icon">🐛</div>
            <div class="empty-text">暂无Bug报告</div>
          </div>
        `;
        return;
      }
      
      container.innerHTML = bugReports.map(bug => {
        const timeStr = formatMessageTime(bug.time);
        
        return `
          <div class="bug-item">
            <div class="bug-item-header">
              <h5 class="bug-title">${bug.title}</h5>
              <div class="bug-header-right">
                <span class="bug-time">${timeStr}</span>
                <button class="delete-bug-btn" onclick="deleteBugReport('${bug.id}')" title="删除Bug报告">
                  🗑️
                </button>
              </div>
            </div>
            <p class="bug-description">${bug.description}</p>
            <span class="bug-type">${bug.type}</span>
          </div>
        `;
      }).join('');
    }
    
    // 格式化时间（复用消息系统的函数）
    function formatBugTime(timeStr) {
      return formatMessageTime(timeStr);
    }

    // 删除Bug报告
    function deleteBugReport(bugId) {
      // 显示确认对话框
      if (!confirm('确定要删除这个Bug报告吗？此操作不可撤销。')) {
        return;
      }

      // 从数组中找到并删除对应的Bug报告
      const index = bugReports.findIndex(bug => bug.id === bugId);
      if (index !== -1) {
        bugReports.splice(index, 1);
        
        // 保存更新后的数据
        saveBugReports();
        
        // 重新渲染列表
        renderBugReportList();
        
        // 显示删除成功提示
        alert('Bug报告已删除！');
      } else {
        alert('未找到要删除的Bug报告！');
      }
    }

    // 消息图标拖拽功能
    function initMessageIconDrag() {
      const messageIcon = document.getElementById('messageIcon');
      if (!messageIcon) return;

      let isDragging = false;
      let startY = 0;
      let startTop = 0;
      let currentY = 0;

      // 清除localStorage中保存的位置，确保图标在左上角
      localStorage.removeItem('messageIconTop');
      localStorage.removeItem('messageIconLeft');
      
      // 确保图标在左上角，清除任何内联样式
      messageIcon.style.top = '';
      messageIcon.style.left = '';
      messageIcon.style.position = '';

      // 鼠标事件
      messageIcon.addEventListener('mousedown', startDrag);
      document.addEventListener('mousemove', drag);
      document.addEventListener('mouseup', endDrag);

      // 触摸事件
      messageIcon.addEventListener('touchstart', startDragTouch, { passive: false });
      document.addEventListener('touchmove', dragTouch, { passive: false });
      document.addEventListener('touchend', endDragTouch);

      function startDrag(e) {
        e.preventDefault();
        e.stopPropagation();
        isDragging = true;
        startY = e.clientY;
        startTop = parseInt(window.getComputedStyle(messageIcon).top, 10);
        messageIcon.classList.add('dragging');
      }

      function startDragTouch(e) {
        isDragging = true;
        startY = e.touches[0].clientY;
        startTop = parseInt(window.getComputedStyle(messageIcon).top, 10);
        currentY = 0; // 重置移动距离
      }

      function drag(e) {
        if (!isDragging) return;
        e.preventDefault();
        e.stopPropagation();
        
        currentY = e.clientY - startY;
        const newTop = startTop + currentY;
        
        // 边界检查
        const maxTop = window.innerHeight - messageIcon.offsetHeight;
        const constrainedTop = Math.max(0, Math.min(newTop, maxTop));
        
        // 使用requestAnimationFrame优化性能
        requestAnimationFrame(() => {
          messageIcon.style.top = constrainedTop + 'px';
        });
      }

      function dragTouch(e) {
        if (!isDragging) return;
        
        currentY = e.touches[0].clientY - startY;
        
        // 只有在移动距离超过阈值时才开始真正的拖动
        if (Math.abs(currentY) > 5) {
          e.preventDefault();
          e.stopPropagation();
          messageIcon.classList.add('dragging');
          
          const newTop = startTop + currentY;
          
          // 边界检查
          const maxTop = window.innerHeight - messageIcon.offsetHeight;
          const constrainedTop = Math.max(0, Math.min(newTop, maxTop));
          
          // 使用requestAnimationFrame优化性能
          requestAnimationFrame(() => {
            messageIcon.style.top = constrainedTop + 'px';
          });
        }
      }

      function endDrag(e) {
        if (!isDragging) return;
        isDragging = false;
        messageIcon.classList.remove('dragging');
        
        // 保存位置到localStorage
        const finalTop = parseInt(messageIcon.style.top, 10);
        localStorage.setItem('messageIconTop', finalTop);
        
        // 移除自动触发点击事件的逻辑，拖动后不自动打开消息中心
      }

      function endDragTouch(e) {
        if (!isDragging) return;
        isDragging = false;
        messageIcon.classList.remove('dragging');
        
        // 如果移动距离很小，说明是点击而不是拖动
        if (Math.abs(currentY) <= 5) {
          // 手动触发点击事件
          showMessages();
        } else {
          // 保存位置到localStorage
          const finalTop = parseInt(messageIcon.style.top, 10);
          localStorage.setItem('messageIconTop', finalTop);
        }
      }
    }

    // 时间调试功能
    let debugTimeOffset = 0; // 调试时间偏移量（毫秒）
    
    /**
     * 显示登录注册界面
     */
    function showLoginRegister() {
      // 跳转到登录注册页面
      window.location.href = 'login.html';
    }
    


    window.onload = init;
  </script>
  <script src="js/global-background.js"></script>
  <script src="js/performance-optimization.js"></script>
</body>
</html>