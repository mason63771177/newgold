<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‚®ç®±éªŒè¯ - Gold7 Game</title>
    <link rel="stylesheet" href="css/common.css">
    <style>.verify-container{align-items:center;background:linear-gradient(135deg,#667eea,#764ba2);display:flex;flex-direction:column;justify-content:center;min-height:100vh;padding:20px}.verify-card{background:#fff;border-radius:20px;box-shadow:0 20px 40px rgba(0,0,0,.1);max-width:500px;padding:40px;text-align:center;width:100%}.verify-icon{font-size:80px;margin-bottom:20px}.verify-title{color:#333;font-size:28px;font-weight:700;margin-bottom:15px}.verify-message{color:#666;font-size:16px;line-height:1.6;margin-bottom:30px}.verify-loading{align-items:center;display:flex;gap:10px;justify-content:center;margin:20px 0}.loading-spinner{animation:spin 1s linear infinite;border:2px solid #f3f3f3;border-radius:50%;border-top-color:gold;height:20px;width:20px}@keyframes spin{0%{transform:rotate(0deg)}to{transform:rotate(1turn)}}.btn{background:linear-gradient(45deg,gold,orange);border:none;border-radius:25px;color:#fff;cursor:pointer;display:inline-block;font-size:16px;font-weight:700;margin:10px;padding:12px 30px;text-decoration:none;transition:all .3s ease}.btn:hover{box-shadow:0 6px 20px rgba(255,215,0,.4);transform:translateY(-2px)}.btn-secondary{background:linear-gradient(45deg,#6c757d,#495057)}.btn-secondary:hover{box-shadow:0 6px 20px hsla(208,7%,46%,.4)}.success{color:#28a745}.error{color:#dc3545}.hidden{display:none}</style>
</head>
<body>
    <div class="verify-container">
        <div class="verify-card">
            <!-- åŠ è½½çŠ¶æ€ -->
            <div id="loadingState">
                <div class="verify-icon">ğŸ“§</div>
                <h1 class="verify-title">æ­£åœ¨éªŒè¯é‚®ç®±</h1>
                <div class="verify-loading">
                    <div class="loading-spinner"></div>
                    <span>è¯·ç¨å€™...</span>
                </div>
            </div>

            <!-- æˆåŠŸçŠ¶æ€ -->
            <div id="successState" class="hidden">
                <div class="verify-icon success">âœ…</div>
                <h1 class="verify-title success">é‚®ç®±éªŒè¯æˆåŠŸï¼</h1>
                <p class="verify-message">
                    æ­å–œæ‚¨ï¼æ‚¨çš„é‚®ç®±å·²æˆåŠŸéªŒè¯ï¼Œç°åœ¨å¯ä»¥æ­£å¸¸ä½¿ç”¨æ‰€æœ‰åŠŸèƒ½äº†ã€‚
                </p>
                <a href="login.html" class="btn">ç«‹å³ç™»å½•</a>
            </div>

            <!-- å¤±è´¥çŠ¶æ€ -->
            <div id="errorState" class="hidden">
                <div class="verify-icon error">âŒ</div>
                <h1 class="verify-title error">éªŒè¯å¤±è´¥</h1>
                <p class="verify-message" id="errorMessage">
                    éªŒè¯é“¾æ¥æ— æ•ˆæˆ–å·²è¿‡æœŸï¼Œè¯·é‡æ–°å‘é€éªŒè¯é‚®ä»¶ã€‚
                </p>
                <button onclick="resendVerification()" class="btn">é‡æ–°å‘é€éªŒè¯é‚®ä»¶</button>
                <a href="login.html" class="btn btn-secondary">è¿”å›ç™»å½•</a>
            </div>

            <!-- é‡æ–°å‘é€çŠ¶æ€ -->
            <div id="resendState" class="hidden">
                <div class="verify-icon">ğŸ“¨</div>
                <h1 class="verify-title">é‡æ–°å‘é€éªŒè¯é‚®ä»¶</h1>
                <p class="verify-message">
                    è¯·è¾“å…¥æ‚¨çš„é‚®ç®±åœ°å€ï¼Œæˆ‘ä»¬å°†é‡æ–°å‘é€éªŒè¯é‚®ä»¶ç»™æ‚¨ã€‚
                </p>
                <div style="margin: 20px 0;">
                    <input type="email" id="resendEmail" placeholder="è¯·è¾“å…¥é‚®ç®±åœ°å€" 
                           style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; margin-bottom: 15px;">
                    <button onclick="sendVerificationEmail()" class="btn" id="resendBtn">å‘é€éªŒè¯é‚®ä»¶</button>
                    <button onclick="showErrorState()" class="btn btn-secondary">è¿”å›</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ä»URLè·å–å‚æ•°
        function getUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            return {
                token: urlParams.get('token'),
                email: urlParams.get('email')
            };
        }

        // æ˜¾ç¤ºä¸åŒçŠ¶æ€
        function showState(stateName) {
            const states = ['loadingState', 'successState', 'errorState', 'resendState'];
            states.forEach(state => {
                document.getElementById(state).classList.add('hidden');
            });
            document.getElementById(stateName).classList.remove('hidden');
        }

        function showErrorState(message = 'éªŒè¯é“¾æ¥æ— æ•ˆæˆ–å·²è¿‡æœŸï¼Œè¯·é‡æ–°å‘é€éªŒè¯é‚®ä»¶ã€‚') {
            document.getElementById('errorMessage').textContent = message;
            showState('errorState');
        }

        // éªŒè¯é‚®ç®±
        async function verifyEmail() {
            const params = getUrlParams();
            
            if (!params.token || !params.email) {
                showErrorState('éªŒè¯é“¾æ¥æ ¼å¼é”™è¯¯ï¼Œç¼ºå°‘å¿…è¦å‚æ•°ã€‚');
                return;
            }

            try {
                const response = await fetch(`/api/auth/verify-email?token=${params.token}&email=${encodeURIComponent(params.email)}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (data.success) {
                    showState('successState');
                } else {
                    showErrorState(data.message || 'éªŒè¯å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚');
                }
            } catch (error) {
                console.error('éªŒè¯é‚®ç®±å¤±è´¥:', error);
                showErrorState('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•ã€‚');
            }
        }

        // é‡æ–°å‘é€éªŒè¯é‚®ä»¶
        function resendVerification() {
            const params = getUrlParams();
            if (params.email) {
                document.getElementById('resendEmail').value = params.email;
            }
            showState('resendState');
        }

        // å‘é€éªŒè¯é‚®ä»¶
        async function sendVerificationEmail() {
            const email = document.getElementById('resendEmail').value.trim();
            const resendBtn = document.getElementById('resendBtn');
            
            if (!email) {
                alert('è¯·è¾“å…¥é‚®ç®±åœ°å€');
                return;
            }

            if (!email.includes('@')) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€');
                return;
            }

            resendBtn.disabled = true;
            resendBtn.textContent = 'å‘é€ä¸­...';

            try {
                const response = await fetch('/api/auth/resend-verification', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email })
                });

                const data = await response.json();

                if (data.success) {
                    alert('éªŒè¯é‚®ä»¶å·²å‘é€ï¼Œè¯·æ£€æŸ¥æ‚¨çš„é‚®ç®±ï¼');
                    showErrorState('éªŒè¯é‚®ä»¶å·²é‡æ–°å‘é€ï¼Œè¯·æ£€æŸ¥æ‚¨çš„é‚®ç®±å¹¶ç‚¹å‡»éªŒè¯é“¾æ¥ã€‚');
                } else {
                    alert(data.message || 'å‘é€å¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            } catch (error) {
                console.error('å‘é€éªŒè¯é‚®ä»¶å¤±è´¥:', error);
                alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
            } finally {
                resendBtn.disabled = false;
                resendBtn.textContent = 'å‘é€éªŒè¯é‚®ä»¶';
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨éªŒè¯
        window.addEventListener('load', () => {
            verifyEmail();
        });
    </script>
</body>
</html>