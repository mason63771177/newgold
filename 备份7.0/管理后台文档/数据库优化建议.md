# ğŸ“Š æ•°æ®åº“ä¼˜åŒ–å»ºè®®æ–‡æ¡£

## æ¦‚è¿°

åŸºäºæ•°å­—é’±åŒ…ç®¡ç†åå°çš„ä¸šåŠ¡éœ€æ±‚åˆ†æï¼Œæœ¬æ–‡æ¡£æå‡ºäº†å…¨é¢çš„æ•°æ®åº“ä¼˜åŒ–æ–¹æ¡ˆï¼ŒåŒ…æ‹¬è¡¨ç»“æ„ä¼˜åŒ–ã€ç´¢å¼•ç­–ç•¥ã€æŸ¥è¯¢ä¼˜åŒ–ã€æ€§èƒ½è°ƒä¼˜å’Œæ‰©å±•æ€§è®¾è®¡ï¼Œç¡®ä¿ç®¡ç†åå°ç³»ç»Ÿèƒ½å¤Ÿé«˜æ•ˆå¤„ç†å¤§é‡æ•°æ®æŸ¥è¯¢å’Œåˆ†æéœ€æ±‚ã€‚

## å½“å‰æ•°æ®åº“æ¶æ„åˆ†æ

### 1. ç°æœ‰è¡¨ç»“æ„è¯„ä¼°

#### æ ¸å¿ƒä¸šåŠ¡è¡¨
```sql
-- ç”¨æˆ·è¡¨ (users)
-- ä¼˜åŒ–å‰é—®é¢˜ï¼šç¼ºå°‘å¤åˆç´¢å¼•ï¼ŒçŠ¶æ€æŸ¥è¯¢æ•ˆç‡ä½
CREATE TABLE users (
  id INT PRIMARY KEY AUTO_INCREMENT,
  username VARCHAR(50) UNIQUE,
  email VARCHAR(100) UNIQUE,
  phone VARCHAR(20),
  status ENUM('active', 'inactive', 'frozen'),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- é’±åŒ…è¡¨ (wallets)
-- ä¼˜åŒ–å‰é—®é¢˜ï¼šä½™é¢æŸ¥è¯¢å’Œç”¨æˆ·å…³è”æŸ¥è¯¢æ€§èƒ½å·®
CREATE TABLE wallets (
  id INT PRIMARY KEY AUTO_INCREMENT,
  user_id INT,
  address VARCHAR(100),
  balance DECIMAL(20,8),
  frozen_balance DECIMAL(20,8),
  network VARCHAR(20),
  currency VARCHAR(10),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- äº¤æ˜“è¡¨ (transactions)
-- ä¼˜åŒ–å‰é—®é¢˜ï¼šæ—¶é—´èŒƒå›´æŸ¥è¯¢æ…¢ï¼ŒçŠ¶æ€ç­›é€‰æ•ˆç‡ä½
CREATE TABLE transactions (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  user_id INT,
  wallet_id INT,
  type ENUM('deposit', 'withdraw'),
  amount DECIMAL(20,8),
  status ENUM('pending', 'confirmed', 'failed'),
  tx_hash VARCHAR(100),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 2. æ€§èƒ½ç“¶é¢ˆè¯†åˆ«

#### æŸ¥è¯¢æ€§èƒ½é—®é¢˜
```javascript
/**
 * å½“å‰ç³»ç»Ÿä¸­çš„æ€§èƒ½ç“¶é¢ˆæŸ¥è¯¢
 */
const PERFORMANCE_BOTTLENECKS = {
  // 1. ç”¨æˆ·åˆ—è¡¨æŸ¥è¯¢ - ç¼ºå°‘å¤åˆç´¢å¼•
  userList: `
    SELECT u.*, w.balance 
    FROM users u 
    LEFT JOIN wallets w ON u.id = w.user_id 
    WHERE u.status = 'active' 
    AND u.created_at BETWEEN '2024-01-01' AND '2024-12-31'
    ORDER BY u.created_at DESC 
    LIMIT 20 OFFSET 0
  `,
  
  // 2. äº¤æ˜“ç»Ÿè®¡æŸ¥è¯¢ - å…¨è¡¨æ‰«æ
  transactionStats: `
    SELECT 
      DATE(created_at) as date,
      COUNT(*) as count,
      SUM(amount) as total_amount
    FROM transactions 
    WHERE created_at >= DATE_SUB(NOW(), INTERVAL 30 DAY)
    GROUP BY DATE(created_at)
  `,
  
  // 3. ç”¨æˆ·èµ„äº§æ±‡æ€» - å¤šè¡¨å…³è”æ•ˆç‡ä½
  userAssetSummary: `
    SELECT 
      u.id, u.username,
      SUM(w.balance) as total_balance,
      COUNT(t.id) as transaction_count
    FROM users u
    LEFT JOIN wallets w ON u.id = w.user_id
    LEFT JOIN transactions t ON u.id = t.user_id
    WHERE u.status = 'active'
    GROUP BY u.id
  `,
  
  // 4. å®æ—¶ç›‘æ§æŸ¥è¯¢ - é¢‘ç¹æŸ¥è¯¢å¯¼è‡´æ€§èƒ½é—®é¢˜
  realTimeMonitoring: `
    SELECT COUNT(*) as active_users 
    FROM users 
    WHERE last_login_at > DATE_SUB(NOW(), INTERVAL 5 MINUTE)
  `
};
```

## æ•°æ®åº“ç»“æ„ä¼˜åŒ–æ–¹æ¡ˆ

### 1. è¡¨ç»“æ„é‡æ„

#### ç”¨æˆ·è¡¨ä¼˜åŒ–
```sql
-- ä¼˜åŒ–åçš„ç”¨æˆ·è¡¨
CREATE TABLE users (
  id INT PRIMARY KEY AUTO_INCREMENT,
  username VARCHAR(50) NOT NULL,
  email VARCHAR(100) NOT NULL,
  phone VARCHAR(20),
  real_name VARCHAR(50),
  id_card VARCHAR(18),
  status ENUM('active', 'inactive', 'frozen', 'deleted') DEFAULT 'active',
  level TINYINT DEFAULT 1 COMMENT 'ç”¨æˆ·ç­‰çº§',
  last_login_at TIMESTAMP NULL,
  last_login_ip VARCHAR(45),
  login_count INT DEFAULT 0,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  deleted_at TIMESTAMP NULL COMMENT 'è½¯åˆ é™¤æ—¶é—´',
  
  -- ç´¢å¼•ä¼˜åŒ–
  UNIQUE KEY uk_username (username),
  UNIQUE KEY uk_email (email),
  INDEX idx_phone (phone),
  INDEX idx_status_created (status, created_at),
  INDEX idx_last_login (last_login_at),
  INDEX idx_level_status (level, status),
  INDEX idx_deleted_at (deleted_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

#### é’±åŒ…è¡¨ä¼˜åŒ–
```sql
-- ä¼˜åŒ–åçš„é’±åŒ…è¡¨
CREATE TABLE wallets (
  id INT PRIMARY KEY AUTO_INCREMENT,
  user_id INT NOT NULL,
  address VARCHAR(100) NOT NULL,
  balance DECIMAL(20,8) DEFAULT 0.00000000,
  frozen_balance DECIMAL(20,8) DEFAULT 0.00000000,
  available_balance DECIMAL(20,8) GENERATED ALWAYS AS (balance - frozen_balance) STORED,
  network VARCHAR(20) NOT NULL DEFAULT 'TRON',
  currency VARCHAR(10) NOT NULL DEFAULT 'USDT',
  type ENUM('main', 'deposit') DEFAULT 'deposit',
  status ENUM('active', 'inactive', 'frozen') DEFAULT 'active',
  last_transaction_at TIMESTAMP NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  -- ç´¢å¼•ä¼˜åŒ–
  UNIQUE KEY uk_address (address),
  INDEX idx_user_id (user_id),
  INDEX idx_user_currency (user_id, currency),
  INDEX idx_balance (balance),
  INDEX idx_status_type (status, type),
  INDEX idx_last_transaction (last_transaction_at),
  INDEX idx_network_currency (network, currency),
  
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

#### äº¤æ˜“è¡¨ä¼˜åŒ–ï¼ˆåˆ†åŒºè¡¨ï¼‰
```sql
-- ä¼˜åŒ–åçš„äº¤æ˜“è¡¨ï¼ˆæŒ‰æœˆåˆ†åŒºï¼‰
CREATE TABLE transactions (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  user_id INT NOT NULL,
  wallet_id INT NOT NULL,
  type ENUM('deposit', 'withdraw', 'transfer') NOT NULL,
  amount DECIMAL(20,8) NOT NULL,
  fee DECIMAL(20,8) DEFAULT 0.00000000,
  status ENUM('pending', 'processing', 'confirmed', 'failed', 'cancelled') NOT NULL,
  tx_hash VARCHAR(100),
  block_number BIGINT,
  confirmations INT DEFAULT 0,
  from_address VARCHAR(100),
  to_address VARCHAR(100),
  network VARCHAR(20) NOT NULL DEFAULT 'TRON',
  currency VARCHAR(10) NOT NULL DEFAULT 'USDT',
  remark TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  confirmed_at TIMESTAMP NULL,
  
  -- ç´¢å¼•ä¼˜åŒ–
  INDEX idx_user_id (user_id),
  INDEX idx_wallet_id (wallet_id),
  INDEX idx_tx_hash (tx_hash),
  INDEX idx_status_type (status, type),
  INDEX idx_created_at (created_at),
  INDEX idx_user_created (user_id, created_at),
  INDEX idx_status_created (status, created_at),
  INDEX idx_type_amount (type, amount),
  INDEX idx_network_currency (network, currency),
  
  FOREIGN KEY (user_id) REFERENCES users(id),
  FOREIGN KEY (wallet_id) REFERENCES wallets(id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci
PARTITION BY RANGE (YEAR(created_at) * 100 + MONTH(created_at)) (
  PARTITION p202401 VALUES LESS THAN (202402),
  PARTITION p202402 VALUES LESS THAN (202403),
  PARTITION p202403 VALUES LESS THAN (202404),
  PARTITION p202404 VALUES LESS THAN (202405),
  PARTITION p202405 VALUES LESS THAN (202406),
  PARTITION p202406 VALUES LESS THAN (202407),
  PARTITION p202407 VALUES LESS THAN (202408),
  PARTITION p202408 VALUES LESS THAN (202409),
  PARTITION p202409 VALUES LESS THAN (202410),
  PARTITION p202410 VALUES LESS THAN (202411),
  PARTITION p202411 VALUES LESS THAN (202412),
  PARTITION p202412 VALUES LESS THAN (202501),
  PARTITION p_future VALUES LESS THAN MAXVALUE
);
```

### 2. æ–°å¢ç®¡ç†åå°ä¸“ç”¨è¡¨

#### ç®¡ç†å‘˜æ“ä½œæ—¥å¿—è¡¨
```sql
CREATE TABLE admin_operation_logs (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  admin_id INT NOT NULL,
  admin_username VARCHAR(50) NOT NULL,
  operation_type VARCHAR(50) NOT NULL,
  resource_type VARCHAR(50) NOT NULL,
  resource_id VARCHAR(100),
  operation_desc TEXT,
  request_data JSON,
  response_data JSON,
  ip_address VARCHAR(45),
  user_agent TEXT,
  execution_time INT COMMENT 'æ‰§è¡Œæ—¶é—´(æ¯«ç§’)',
  status ENUM('success', 'failed') NOT NULL,
  error_message TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  
  -- ç´¢å¼•ä¼˜åŒ–
  INDEX idx_admin_id (admin_id),
  INDEX idx_operation_type (operation_type),
  INDEX idx_resource_type (resource_type),
  INDEX idx_created_at (created_at),
  INDEX idx_admin_created (admin_id, created_at),
  INDEX idx_status_created (status, created_at),
  INDEX idx_ip_address (ip_address)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci
PARTITION BY RANGE (YEAR(created_at) * 100 + MONTH(created_at)) (
  PARTITION p202401 VALUES LESS THAN (202402),
  PARTITION p202402 VALUES LESS THAN (202403),
  -- ... å…¶ä»–åˆ†åŒº
  PARTITION p_future VALUES LESS THAN MAXVALUE
);
```

#### æ•°æ®ç»Ÿè®¡ç¼“å­˜è¡¨
```sql
CREATE TABLE data_statistics_cache (
  id INT PRIMARY KEY AUTO_INCREMENT,
  stat_key VARCHAR(100) NOT NULL,
  stat_date DATE NOT NULL,
  stat_hour TINYINT DEFAULT NULL COMMENT 'å°æ—¶ç»Ÿè®¡(0-23)',
  stat_value JSON NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  expires_at TIMESTAMP NOT NULL,
  
  -- ç´¢å¼•ä¼˜åŒ–
  UNIQUE KEY uk_key_date_hour (stat_key, stat_date, stat_hour),
  INDEX idx_stat_key (stat_key),
  INDEX idx_stat_date (stat_date),
  INDEX idx_expires_at (expires_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

### 3. æ•°æ®å½’æ¡£ç­–ç•¥

#### å†å²æ•°æ®å½’æ¡£è¡¨
```sql
-- äº¤æ˜“å†å²å½’æ¡£è¡¨
CREATE TABLE transactions_archive (
  id BIGINT PRIMARY KEY,
  user_id INT NOT NULL,
  wallet_id INT NOT NULL,
  type ENUM('deposit', 'withdraw', 'transfer') NOT NULL,
  amount DECIMAL(20,8) NOT NULL,
  fee DECIMAL(20,8) DEFAULT 0.00000000,
  status ENUM('pending', 'processing', 'confirmed', 'failed', 'cancelled') NOT NULL,
  tx_hash VARCHAR(100),
  block_number BIGINT,
  confirmations INT DEFAULT 0,
  from_address VARCHAR(100),
  to_address VARCHAR(100),
  network VARCHAR(20) NOT NULL DEFAULT 'TRON',
  currency VARCHAR(10) NOT NULL DEFAULT 'USDT',
  remark TEXT,
  created_at TIMESTAMP,
  updated_at TIMESTAMP,
  confirmed_at TIMESTAMP NULL,
  archived_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  
  -- å½’æ¡£è¡¨ç´¢å¼•ï¼ˆè¾ƒå°‘ï¼‰
  INDEX idx_user_id (user_id),
  INDEX idx_created_at (created_at),
  INDEX idx_archived_at (archived_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

## ç´¢å¼•ä¼˜åŒ–ç­–ç•¥

### 1. å¤åˆç´¢å¼•è®¾è®¡

#### ç”¨æˆ·ç›¸å…³æŸ¥è¯¢ä¼˜åŒ–
```sql
-- ç”¨æˆ·åˆ—è¡¨æŸ¥è¯¢ä¼˜åŒ–
-- æŸ¥è¯¢ï¼šæŒ‰çŠ¶æ€å’Œåˆ›å»ºæ—¶é—´ç­›é€‰ç”¨æˆ·
ALTER TABLE users ADD INDEX idx_status_created_id (status, created_at, id);

-- ç”¨æˆ·æœç´¢ä¼˜åŒ–
-- æŸ¥è¯¢ï¼šæŒ‰ç”¨æˆ·åã€é‚®ç®±ã€æ‰‹æœºå·æœç´¢
ALTER TABLE users ADD INDEX idx_search_fields (username, email, phone);

-- æ´»è·ƒç”¨æˆ·æŸ¥è¯¢ä¼˜åŒ–
-- æŸ¥è¯¢ï¼šæœ€è¿‘ç™»å½•çš„æ´»è·ƒç”¨æˆ·
ALTER TABLE users ADD INDEX idx_active_users (status, last_login_at, id);
```

#### äº¤æ˜“ç›¸å…³æŸ¥è¯¢ä¼˜åŒ–
```sql
-- ç”¨æˆ·äº¤æ˜“å†å²æŸ¥è¯¢
-- æŸ¥è¯¢ï¼šç‰¹å®šç”¨æˆ·çš„äº¤æ˜“è®°å½•ï¼ŒæŒ‰æ—¶é—´æ’åº
ALTER TABLE transactions ADD INDEX idx_user_time_status (user_id, created_at, status);

-- äº¤æ˜“çŠ¶æ€ç»Ÿè®¡æŸ¥è¯¢
-- æŸ¥è¯¢ï¼šæŒ‰çŠ¶æ€å’Œæ—¶é—´ç»Ÿè®¡äº¤æ˜“
ALTER TABLE transactions ADD INDEX idx_status_time_amount (status, created_at, amount);

-- å¤§é¢äº¤æ˜“ç›‘æ§
-- æŸ¥è¯¢ï¼šé‡‘é¢è¶…è¿‡é˜ˆå€¼çš„äº¤æ˜“
ALTER TABLE transactions ADD INDEX idx_amount_created (amount, created_at);

-- äº¤æ˜“å“ˆå¸ŒæŸ¥è¯¢
-- æŸ¥è¯¢ï¼šæ ¹æ®äº¤æ˜“å“ˆå¸ŒæŸ¥æ‰¾äº¤æ˜“
ALTER TABLE transactions ADD INDEX idx_tx_hash_status (tx_hash, status);
```

#### é’±åŒ…ç›¸å…³æŸ¥è¯¢ä¼˜åŒ–
```sql
-- ç”¨æˆ·é’±åŒ…æ±‡æ€»æŸ¥è¯¢
-- æŸ¥è¯¢ï¼šç”¨æˆ·çš„æ‰€æœ‰é’±åŒ…åŠä½™é¢
ALTER TABLE wallets ADD INDEX idx_user_currency_balance (user_id, currency, balance);

-- åœ°å€ä½™é¢æŸ¥è¯¢
-- æŸ¥è¯¢ï¼šç‰¹å®šåœ°å€çš„é’±åŒ…ä¿¡æ¯
ALTER TABLE wallets ADD INDEX idx_address_status (address, status);

-- å¤§é¢é’±åŒ…ç›‘æ§
-- æŸ¥è¯¢ï¼šä½™é¢è¶…è¿‡é˜ˆå€¼çš„é’±åŒ…
ALTER TABLE wallets ADD INDEX idx_balance_status (balance, status);
```

### 2. ç´¢å¼•ä½¿ç”¨ç›‘æ§

#### ç´¢å¼•æ•ˆæœåˆ†æ
```sql
-- åˆ›å»ºç´¢å¼•ä½¿ç”¨æƒ…å†µç›‘æ§è§†å›¾
CREATE VIEW index_usage_stats AS
SELECT 
  t.TABLE_SCHEMA,
  t.TABLE_NAME,
  t.INDEX_NAME,
  s.ROWS_READ,
  s.ROWS_EXAMINED,
  s.ROWS_EXAMINED / s.ROWS_READ as efficiency_ratio
FROM information_schema.STATISTICS t
LEFT JOIN performance_schema.table_io_waits_summary_by_index_usage s
  ON t.TABLE_SCHEMA = s.OBJECT_SCHEMA 
  AND t.TABLE_NAME = s.OBJECT_NAME 
  AND t.INDEX_NAME = s.INDEX_NAME
WHERE t.TABLE_SCHEMA = 'wallet_db'
ORDER BY s.ROWS_EXAMINED DESC;
```

#### æ…¢æŸ¥è¯¢ä¼˜åŒ–ç›‘æ§
```javascript
/**
 * æ…¢æŸ¥è¯¢ç›‘æ§å’Œä¼˜åŒ–å»ºè®®
 */
class SlowQueryOptimizer {
  /**
   * åˆ†ææ…¢æŸ¥è¯¢æ—¥å¿—
   */
  async analyzeSlowQueries() {
    const slowQueries = await this.getSlowQueries();
    const optimizations = [];
    
    for (const query of slowQueries) {
      const analysis = await this.analyzeQuery(query);
      
      if (analysis.missingIndexes.length > 0) {
        optimizations.push({
          query: query.sql,
          issue: 'missing_indexes',
          suggestion: `å»ºè®®æ·»åŠ ç´¢å¼•: ${analysis.missingIndexes.join(', ')}`,
          priority: 'high'
        });
      }
      
      if (analysis.fullTableScan) {
        optimizations.push({
          query: query.sql,
          issue: 'full_table_scan',
          suggestion: 'æŸ¥è¯¢å¯¼è‡´å…¨è¡¨æ‰«æï¼Œéœ€è¦ä¼˜åŒ–WHEREæ¡ä»¶æˆ–æ·»åŠ ç´¢å¼•',
          priority: 'critical'
        });
      }
      
      if (analysis.inefficientJoins.length > 0) {
        optimizations.push({
          query: query.sql,
          issue: 'inefficient_joins',
          suggestion: `ä¼˜åŒ–è¡¨è¿æ¥: ${analysis.inefficientJoins.join(', ')}`,
          priority: 'medium'
        });
      }
    }
    
    return optimizations;
  }
  
  /**
   * è‡ªåŠ¨ç”Ÿæˆç´¢å¼•å»ºè®®
   */
  async generateIndexSuggestions() {
    const suggestions = [];
    
    // åˆ†ææŸ¥è¯¢æ¨¡å¼
    const queryPatterns = await this.analyzeQueryPatterns();
    
    for (const pattern of queryPatterns) {
      if (pattern.frequency > 100 && pattern.avgExecutionTime > 1000) {
        const indexSuggestion = this.generateIndexForPattern(pattern);
        suggestions.push(indexSuggestion);
      }
    }
    
    return suggestions;
  }
}
```

## æŸ¥è¯¢ä¼˜åŒ–æ–¹æ¡ˆ

### 1. å¸¸ç”¨æŸ¥è¯¢ä¼˜åŒ–

#### ç”¨æˆ·ç®¡ç†æŸ¥è¯¢ä¼˜åŒ–
```sql
-- ä¼˜åŒ–å‰ï¼šç”¨æˆ·åˆ—è¡¨æŸ¥è¯¢
SELECT u.*, w.balance 
FROM users u 
LEFT JOIN wallets w ON u.id = w.user_id 
WHERE u.status = 'active' 
ORDER BY u.created_at DESC 
LIMIT 20 OFFSET 0;

-- ä¼˜åŒ–åï¼šä½¿ç”¨å¤åˆç´¢å¼•å’Œå­æŸ¥è¯¢
SELECT 
  u.id, u.username, u.email, u.status, u.created_at,
  COALESCE(wb.total_balance, 0) as total_balance
FROM users u
LEFT JOIN (
  SELECT user_id, SUM(balance) as total_balance
  FROM wallets 
  WHERE status = 'active'
  GROUP BY user_id
) wb ON u.id = wb.user_id
WHERE u.status = 'active'
ORDER BY u.created_at DESC
LIMIT 20;

-- æ·»åŠ å¯¹åº”ç´¢å¼•
CREATE INDEX idx_users_status_created ON users(status, created_at);
CREATE INDEX idx_wallets_status_user ON wallets(status, user_id);
```

#### äº¤æ˜“ç»Ÿè®¡æŸ¥è¯¢ä¼˜åŒ–
```sql
-- ä¼˜åŒ–å‰ï¼šå®æ—¶ç»Ÿè®¡æŸ¥è¯¢
SELECT 
  DATE(created_at) as date,
  COUNT(*) as count,
  SUM(amount) as total_amount
FROM transactions 
WHERE created_at >= DATE_SUB(NOW(), INTERVAL 30 DAY)
GROUP BY DATE(created_at);

-- ä¼˜åŒ–åï¼šä½¿ç”¨ç»Ÿè®¡ç¼“å­˜è¡¨
-- 1. åˆ›å»ºæ¯æ—¥ç»Ÿè®¡ä»»åŠ¡
INSERT INTO data_statistics_cache (stat_key, stat_date, stat_value, expires_at)
SELECT 
  'daily_transactions',
  DATE(created_at),
  JSON_OBJECT(
    'count', COUNT(*),
    'total_amount', SUM(amount),
    'avg_amount', AVG(amount),
    'deposit_count', SUM(CASE WHEN type = 'deposit' THEN 1 ELSE 0 END),
    'withdraw_count', SUM(CASE WHEN type = 'withdraw' THEN 1 ELSE 0 END)
  ),
  DATE_ADD(NOW(), INTERVAL 1 DAY)
FROM transactions 
WHERE DATE(created_at) = CURDATE()
GROUP BY DATE(created_at)
ON DUPLICATE KEY UPDATE 
  stat_value = VALUES(stat_value),
  updated_at = NOW();

-- 2. æŸ¥è¯¢ä¼˜åŒ–åçš„ç»Ÿè®¡æ•°æ®
SELECT stat_date, stat_value 
FROM data_statistics_cache 
WHERE stat_key = 'daily_transactions' 
  AND stat_date >= DATE_SUB(CURDATE(), INTERVAL 30 DAY)
ORDER BY stat_date;
```

### 2. åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–

#### æ·±åº¦åˆ†é¡µä¼˜åŒ–
```sql
-- ä¼˜åŒ–å‰ï¼šä¼ ç»ŸOFFSETåˆ†é¡µï¼ˆæ€§èƒ½éšé¡µæ•°å¢åŠ è€Œä¸‹é™ï¼‰
SELECT * FROM transactions 
ORDER BY created_at DESC 
LIMIT 20 OFFSET 10000;

-- ä¼˜åŒ–åï¼šåŸºäºæ¸¸æ ‡çš„åˆ†é¡µ
-- ç¬¬ä¸€é¡µ
SELECT * FROM transactions 
ORDER BY created_at DESC, id DESC 
LIMIT 20;

-- åç»­é¡µï¼ˆä½¿ç”¨ä¸Šä¸€é¡µæœ€åä¸€æ¡è®°å½•çš„created_atå’Œidä½œä¸ºæ¸¸æ ‡ï¼‰
SELECT * FROM transactions 
WHERE (created_at < '2024-01-15 10:30:00' OR 
       (created_at = '2024-01-15 10:30:00' AND id < 12345))
ORDER BY created_at DESC, id DESC 
LIMIT 20;
```

#### åˆ†é¡µæŸ¥è¯¢å°è£…
```javascript
/**
 * é«˜æ€§èƒ½åˆ†é¡µæŸ¥è¯¢ç±»
 */
class OptimizedPagination {
  /**
   * åŸºäºæ¸¸æ ‡çš„åˆ†é¡µæŸ¥è¯¢
   * @param {Object} options - æŸ¥è¯¢é€‰é¡¹
   */
  async cursorBasedPagination(options) {
    const {
      table,
      orderBy = 'created_at',
      orderDirection = 'DESC',
      limit = 20,
      cursor = null,
      where = '',
      params = []
    } = options;
    
    let sql = `SELECT * FROM ${table}`;
    let queryParams = [...params];
    
    // æ„å»ºWHEREæ¡ä»¶
    const whereConditions = [];
    if (where) {
      whereConditions.push(where);
    }
    
    // æ·»åŠ æ¸¸æ ‡æ¡ä»¶
    if (cursor) {
      const cursorCondition = orderDirection === 'DESC' 
        ? `${orderBy} < ?` 
        : `${orderBy} > ?`;
      whereConditions.push(cursorCondition);
      queryParams.push(cursor);
    }
    
    if (whereConditions.length > 0) {
      sql += ` WHERE ${whereConditions.join(' AND ')}`;
    }
    
    sql += ` ORDER BY ${orderBy} ${orderDirection} LIMIT ?`;
    queryParams.push(limit + 1); // å¤šæŸ¥è¯¢ä¸€æ¡ç”¨äºåˆ¤æ–­æ˜¯å¦æœ‰ä¸‹ä¸€é¡µ
    
    const results = await db.query(sql, queryParams);
    
    const hasNextPage = results.length > limit;
    if (hasNextPage) {
      results.pop(); // ç§»é™¤å¤šæŸ¥è¯¢çš„é‚£ä¸€æ¡
    }
    
    const nextCursor = results.length > 0 
      ? results[results.length - 1][orderBy] 
      : null;
    
    return {
      data: results,
      hasNextPage,
      nextCursor,
      total: hasNextPage ? null : results.length // åªåœ¨æœ€åä¸€é¡µè®¡ç®—æ€»æ•°
    };
  }
  
  /**
   * æ™ºèƒ½åˆ†é¡µï¼ˆè‡ªåŠ¨é€‰æ‹©æœ€ä¼˜ç­–ç•¥ï¼‰
   */
  async smartPagination(options) {
    const { page = 1, limit = 20 } = options;
    
    // æµ…åˆ†é¡µä½¿ç”¨OFFSETï¼Œæ·±åˆ†é¡µä½¿ç”¨æ¸¸æ ‡
    if (page <= 100) {
      return await this.offsetBasedPagination(options);
    } else {
      return await this.cursorBasedPagination(options);
    }
  }
}
```

## æ€§èƒ½è°ƒä¼˜ç­–ç•¥

### 1. MySQLé…ç½®ä¼˜åŒ–

#### æœåŠ¡å™¨é…ç½®ä¼˜åŒ–
```ini
# my.cnf ä¼˜åŒ–é…ç½®
[mysqld]
# åŸºç¡€é…ç½®
port = 3306
socket = /var/lib/mysql/mysql.sock
datadir = /var/lib/mysql

# å†…å­˜é…ç½®
innodb_buffer_pool_size = 2G          # è®¾ç½®ä¸ºç‰©ç†å†…å­˜çš„70-80%
innodb_log_file_size = 256M           # æ—¥å¿—æ–‡ä»¶å¤§å°
innodb_log_buffer_size = 16M          # æ—¥å¿—ç¼“å†²åŒºå¤§å°
key_buffer_size = 256M                # MyISAMç´¢å¼•ç¼“å†²åŒº
query_cache_size = 128M               # æŸ¥è¯¢ç¼“å­˜å¤§å°
tmp_table_size = 64M                  # ä¸´æ—¶è¡¨å¤§å°
max_heap_table_size = 64M             # å†…å­˜è¡¨æœ€å¤§å¤§å°

# è¿æ¥é…ç½®
max_connections = 500                 # æœ€å¤§è¿æ¥æ•°
max_connect_errors = 1000            # æœ€å¤§è¿æ¥é”™è¯¯æ•°
connect_timeout = 10                 # è¿æ¥è¶…æ—¶æ—¶é—´
wait_timeout = 600                   # ç­‰å¾…è¶…æ—¶æ—¶é—´
interactive_timeout = 600            # äº¤äº’è¶…æ—¶æ—¶é—´

# InnoDBé…ç½®
innodb_file_per_table = 1            # æ¯ä¸ªè¡¨å•ç‹¬æ–‡ä»¶
innodb_flush_log_at_trx_commit = 2   # æ—¥å¿—åˆ·æ–°ç­–ç•¥
innodb_flush_method = O_DIRECT       # åˆ·æ–°æ–¹æ³•
innodb_lock_wait_timeout = 50        # é”ç­‰å¾…è¶…æ—¶
innodb_rollback_on_timeout = 1       # è¶…æ—¶å›æ»š
innodb_thread_concurrency = 8       # çº¿ç¨‹å¹¶å‘æ•°

# æŸ¥è¯¢ä¼˜åŒ–
slow_query_log = 1                   # å¯ç”¨æ…¢æŸ¥è¯¢æ—¥å¿—
slow_query_log_file = /var/log/mysql/slow.log
long_query_time = 1                  # æ…¢æŸ¥è¯¢é˜ˆå€¼(ç§’)
log_queries_not_using_indexes = 1    # è®°å½•æœªä½¿ç”¨ç´¢å¼•çš„æŸ¥è¯¢

# äºŒè¿›åˆ¶æ—¥å¿—
log_bin = mysql-bin                  # å¯ç”¨äºŒè¿›åˆ¶æ—¥å¿—
binlog_format = ROW                  # äºŒè¿›åˆ¶æ—¥å¿—æ ¼å¼
expire_logs_days = 7                 # æ—¥å¿—ä¿ç•™å¤©æ•°
max_binlog_size = 100M              # å•ä¸ªæ—¥å¿—æ–‡ä»¶æœ€å¤§å¤§å°

# å…¶ä»–ä¼˜åŒ–
table_open_cache = 2000             # è¡¨ç¼“å­˜æ•°é‡
thread_cache_size = 50              # çº¿ç¨‹ç¼“å­˜å¤§å°
sort_buffer_size = 2M               # æ’åºç¼“å†²åŒºå¤§å°
read_buffer_size = 1M               # è¯»ç¼“å†²åŒºå¤§å°
read_rnd_buffer_size = 2M           # éšæœºè¯»ç¼“å†²åŒºå¤§å°
```

### 2. è¿æ¥æ± ä¼˜åŒ–

#### Node.jsè¿æ¥æ± é…ç½®
```javascript
/**
 * æ•°æ®åº“è¿æ¥æ± ä¼˜åŒ–é…ç½®
 */
const mysql = require('mysql2/promise');

const dbConfig = {
  host: process.env.DB_HOST,
  port: process.env.DB_PORT || 3306,
  user: process.env.DB_USER,
  password: process.env.DB_PASSWORD,
  database: process.env.DB_NAME,
  
  // è¿æ¥æ± é…ç½®
  connectionLimit: 20,              // æœ€å¤§è¿æ¥æ•°
  acquireTimeout: 60000,           // è·å–è¿æ¥è¶…æ—¶æ—¶é—´
  timeout: 60000,                  // æŸ¥è¯¢è¶…æ—¶æ—¶é—´
  reconnect: true,                 // è‡ªåŠ¨é‡è¿
  
  // æ€§èƒ½ä¼˜åŒ–
  multipleStatements: false,       // ç¦ç”¨å¤šè¯­å¥æŸ¥è¯¢ï¼ˆå®‰å…¨è€ƒè™‘ï¼‰
  dateStrings: false,              // æ—¥æœŸç±»å‹å¤„ç†
  supportBigNumbers: true,         // æ”¯æŒå¤§æ•°å­—
  bigNumberStrings: true,          // å¤§æ•°å­—è½¬å­—ç¬¦ä¸²
  
  // SSLé…ç½®ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
  ssl: process.env.NODE_ENV === 'production' ? {
    rejectUnauthorized: false
  } : false
};

// åˆ›å»ºè¿æ¥æ± 
const pool = mysql.createPool(dbConfig);

/**
 * æ•°æ®åº“è¿æ¥ç®¡ç†å™¨
 */
class DatabaseManager {
  constructor() {
    this.pool = pool;
    this.setupMonitoring();
  }
  
  /**
   * æ‰§è¡ŒæŸ¥è¯¢
   */
  async query(sql, params = []) {
    const start = Date.now();
    let connection;
    
    try {
      connection = await this.pool.getConnection();
      const [results] = await connection.execute(sql, params);
      
      // è®°å½•æ…¢æŸ¥è¯¢
      const duration = Date.now() - start;
      if (duration > 1000) {
        console.warn(`æ…¢æŸ¥è¯¢æ£€æµ‹: ${duration}ms`, { sql, params });
      }
      
      return results;
    } catch (error) {
      console.error('æ•°æ®åº“æŸ¥è¯¢é”™è¯¯:', error);
      throw error;
    } finally {
      if (connection) connection.release();
    }
  }
  
  /**
   * äº‹åŠ¡æ‰§è¡Œ
   */
  async transaction(callback) {
    const connection = await this.pool.getConnection();
    
    try {
      await connection.beginTransaction();
      const result = await callback(connection);
      await connection.commit();
      return result;
    } catch (error) {
      await connection.rollback();
      throw error;
    } finally {
      connection.release();
    }
  }
  
  /**
   * è¿æ¥æ± ç›‘æ§
   */
  setupMonitoring() {
    setInterval(() => {
      const stats = {
        totalConnections: this.pool.pool._allConnections.length,
        freeConnections: this.pool.pool._freeConnections.length,
        usedConnections: this.pool.pool._allConnections.length - this.pool.pool._freeConnections.length
      };
      
      console.log('æ•°æ®åº“è¿æ¥æ± çŠ¶æ€:', stats);
      
      // è¿æ¥æ± ä½¿ç”¨ç‡å‘Šè­¦
      const usageRate = stats.usedConnections / stats.totalConnections;
      if (usageRate > 0.8) {
        console.warn('æ•°æ®åº“è¿æ¥æ± ä½¿ç”¨ç‡è¿‡é«˜:', usageRate);
      }
    }, 30000); // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡
  }
}
```

### 3. ç¼“å­˜ç­–ç•¥

#### Redisç¼“å­˜ä¼˜åŒ–
```javascript
/**
 * æ•°æ®åº“æŸ¥è¯¢ç¼“å­˜ç®¡ç†
 */
class QueryCache {
  constructor(redisClient) {
    this.redis = redisClient;
    this.defaultTTL = 300; // 5åˆ†é’Ÿé»˜è®¤è¿‡æœŸæ—¶é—´
  }
  
  /**
   * ç¼“å­˜æŸ¥è¯¢ç»“æœ
   */
  async cacheQuery(key, queryFn, ttl = this.defaultTTL) {
    // å°è¯•ä»ç¼“å­˜è·å–
    const cached = await this.redis.get(key);
    if (cached) {
      return JSON.parse(cached);
    }
    
    // æ‰§è¡ŒæŸ¥è¯¢
    const result = await queryFn();
    
    // ç¼“å­˜ç»“æœ
    await this.redis.setex(key, ttl, JSON.stringify(result));
    
    return result;
  }
  
  /**
   * ç”¨æˆ·æ•°æ®ç¼“å­˜
   */
  async getUserData(userId) {
    const cacheKey = `user:${userId}`;
    
    return await this.cacheQuery(cacheKey, async () => {
      const user = await db.query(
        'SELECT * FROM users WHERE id = ? AND deleted_at IS NULL',
        [userId]
      );
      return user[0];
    }, 600); // 10åˆ†é’Ÿç¼“å­˜
  }
  
  /**
   * ç”¨æˆ·é’±åŒ…ç¼“å­˜
   */
  async getUserWallets(userId) {
    const cacheKey = `user_wallets:${userId}`;
    
    return await this.cacheQuery(cacheKey, async () => {
      return await db.query(
        'SELECT * FROM wallets WHERE user_id = ? AND status = "active"',
        [userId]
      );
    }, 300); // 5åˆ†é’Ÿç¼“å­˜
  }
  
  /**
   * ç»Ÿè®¡æ•°æ®ç¼“å­˜
   */
  async getStatistics(statType, date) {
    const cacheKey = `stats:${statType}:${date}`;
    
    return await this.cacheQuery(cacheKey, async () => {
      // ä»ç»Ÿè®¡ç¼“å­˜è¡¨è·å–æ•°æ®
      const stats = await db.query(
        'SELECT stat_value FROM data_statistics_cache WHERE stat_key = ? AND stat_date = ?',
        [statType, date]
      );
      
      return stats[0]?.stat_value || {};
    }, 3600); // 1å°æ—¶ç¼“å­˜
  }
  
  /**
   * æ‰¹é‡æ¸…é™¤ç¼“å­˜
   */
  async clearUserCache(userId) {
    const patterns = [
      `user:${userId}`,
      `user_wallets:${userId}`,
      `user_transactions:${userId}*`
    ];
    
    for (const pattern of patterns) {
      const keys = await this.redis.keys(pattern);
      if (keys.length > 0) {
        await this.redis.del(...keys);
      }
    }
  }
}
```

## æ•°æ®åº“ç›‘æ§å’Œç»´æŠ¤

### 1. æ€§èƒ½ç›‘æ§

#### å®æ—¶ç›‘æ§æŒ‡æ ‡
```javascript
/**
 * æ•°æ®åº“æ€§èƒ½ç›‘æ§
 */
class DatabaseMonitor {
  constructor(db) {
    this.db = db;
    this.metrics = {
      queryCount: 0,
      slowQueryCount: 0,
      errorCount: 0,
      avgResponseTime: 0
    };
  }
  
  /**
   * æ”¶é›†æ€§èƒ½æŒ‡æ ‡
   */
  async collectMetrics() {
    const metrics = {};
    
    // è¿æ¥æ•°ç»Ÿè®¡
    const [connections] = await this.db.query('SHOW STATUS LIKE "Threads_connected"');
    metrics.activeConnections = parseInt(connections.Value);
    
    // æŸ¥è¯¢ç»Ÿè®¡
    const [queries] = await this.db.query('SHOW STATUS LIKE "Questions"');
    metrics.totalQueries = parseInt(queries.Value);
    
    // æ…¢æŸ¥è¯¢ç»Ÿè®¡
    const [slowQueries] = await this.db.query('SHOW STATUS LIKE "Slow_queries"');
    metrics.slowQueries = parseInt(slowQueries.Value);
    
    // InnoDBç¼“å†²æ± å‘½ä¸­ç‡
    const [bufferPoolReads] = await this.db.query('SHOW STATUS LIKE "Innodb_buffer_pool_reads"');
    const [bufferPoolReadRequests] = await this.db.query('SHOW STATUS LIKE "Innodb_buffer_pool_read_requests"');
    
    const reads = parseInt(bufferPoolReads.Value);
    const readRequests = parseInt(bufferPoolReadRequests.Value);
    metrics.bufferPoolHitRate = ((readRequests - reads) / readRequests * 100).toFixed(2);
    
    // é”ç­‰å¾…ç»Ÿè®¡
    const [lockWaits] = await this.db.query('SHOW STATUS LIKE "Innodb_row_lock_waits"');
    metrics.lockWaits = parseInt(lockWaits.Value);
    
    return metrics;
  }
  
  /**
   * æ£€æŸ¥è¡¨ç©ºé—´ä½¿ç”¨æƒ…å†µ
   */
  async checkTablespaceUsage() {
    const [tables] = await this.db.query(`
      SELECT 
        table_name,
        ROUND(((data_length + index_length) / 1024 / 1024), 2) AS size_mb,
        table_rows,
        ROUND((data_length / 1024 / 1024), 2) AS data_size_mb,
        ROUND((index_length / 1024 / 1024), 2) AS index_size_mb
      FROM information_schema.tables 
      WHERE table_schema = DATABASE()
      ORDER BY (data_length + index_length) DESC
    `);
    
    return tables;
  }
  
  /**
   * åˆ†æç´¢å¼•ä½¿ç”¨æƒ…å†µ
   */
  async analyzeIndexUsage() {
    const [indexes] = await this.db.query(`
      SELECT 
        t.table_name,
        t.index_name,
        t.column_name,
        s.rows_read,
        s.rows_examined
      FROM information_schema.statistics t
      LEFT JOIN performance_schema.table_io_waits_summary_by_index_usage s
        ON t.table_schema = s.object_schema 
        AND t.table_name = s.object_name 
        AND t.index_name = s.index_name
      WHERE t.table_schema = DATABASE()
        AND s.rows_read IS NOT NULL
      ORDER BY s.rows_examined DESC
    `);
    
    return indexes;
  }
}
```

### 2. è‡ªåŠ¨åŒ–ç»´æŠ¤

#### æ•°æ®æ¸…ç†ä»»åŠ¡
```javascript
/**
 * æ•°æ®åº“ç»´æŠ¤ä»»åŠ¡
 */
class DatabaseMaintenance {
  constructor(db) {
    this.db = db;
  }
  
  /**
   * æ¸…ç†è¿‡æœŸæ•°æ®
   */
  async cleanupExpiredData() {
    const tasks = [
      // æ¸…ç†è¿‡æœŸçš„ç»Ÿè®¡ç¼“å­˜
      {
        name: 'æ¸…ç†è¿‡æœŸç»Ÿè®¡ç¼“å­˜',
        sql: 'DELETE FROM data_statistics_cache WHERE expires_at < NOW()',
        expectedRows: 0
      },
      
      // å½’æ¡£æ—§çš„æ“ä½œæ—¥å¿—
      {
        name: 'å½’æ¡£æ“ä½œæ—¥å¿—',
        sql: `
          INSERT INTO admin_operation_logs_archive 
          SELECT * FROM admin_operation_logs 
          WHERE created_at < DATE_SUB(NOW(), INTERVAL 3 MONTH)
        `,
        expectedRows: 0
      },
      
      // åˆ é™¤å·²å½’æ¡£çš„æ“ä½œæ—¥å¿—
      {
        name: 'åˆ é™¤å·²å½’æ¡£æ“ä½œæ—¥å¿—',
        sql: 'DELETE FROM admin_operation_logs WHERE created_at < DATE_SUB(NOW(), INTERVAL 3 MONTH)',
        expectedRows: 0
      }
    ];
    
    const results = [];
    
    for (const task of tasks) {
      try {
        const result = await this.db.query(task.sql);
        results.push({
          task: task.name,
          success: true,
          affectedRows: result.affectedRows
        });
        
        console.log(`${task.name} å®Œæˆï¼Œå½±å“è¡Œæ•°: ${result.affectedRows}`);
      } catch (error) {
        results.push({
          task: task.name,
          success: false,
          error: error.message
        });
        
        console.error(`${task.name} å¤±è´¥:`, error);
      }
    }
    
    return results;
  }
  
  /**
   * ä¼˜åŒ–è¡¨ç»“æ„
   */
  async optimizeTables() {
    // è·å–éœ€è¦ä¼˜åŒ–çš„è¡¨
    const [tables] = await this.db.query(`
      SELECT table_name, data_free
      FROM information_schema.tables 
      WHERE table_schema = DATABASE() 
        AND data_free > 1024 * 1024 * 10  -- ç¢ç‰‡è¶…è¿‡10MB
      ORDER BY data_free DESC
    `);
    
    const results = [];
    
    for (const table of tables) {
      try {
        console.log(`å¼€å§‹ä¼˜åŒ–è¡¨: ${table.table_name}`);
        await this.db.query(`OPTIMIZE TABLE ${table.table_name}`);
        
        results.push({
          table: table.table_name,
          success: true,
          freedSpace: table.data_free
        });
        
        console.log(`è¡¨ ${table.table_name} ä¼˜åŒ–å®Œæˆ`);
      } catch (error) {
        results.push({
          table: table.table_name,
          success: false,
          error: error.message
        });
        
        console.error(`è¡¨ ${table.table_name} ä¼˜åŒ–å¤±è´¥:`, error);
      }
    }
    
    return results;
  }
  
  /**
   * æ›´æ–°è¡¨ç»Ÿè®¡ä¿¡æ¯
   */
  async updateTableStatistics() {
    const [tables] = await this.db.query(`
      SELECT table_name 
      FROM information_schema.tables 
      WHERE table_schema = DATABASE()
    `);
    
    for (const table of tables) {
      try {
        await this.db.query(`ANALYZE TABLE ${table.table_name}`);
        console.log(`è¡¨ ${table.table_name} ç»Ÿè®¡ä¿¡æ¯æ›´æ–°å®Œæˆ`);
      } catch (error) {
        console.error(`è¡¨ ${table.table_name} ç»Ÿè®¡ä¿¡æ¯æ›´æ–°å¤±è´¥:`, error);
      }
    }
  }
}
```

## æ‰©å±•æ€§è®¾è®¡

### 1. è¯»å†™åˆ†ç¦»

#### ä¸»ä»é…ç½®
```javascript
/**
 * è¯»å†™åˆ†ç¦»æ•°æ®åº“ç®¡ç†
 */
class MasterSlaveDB {
  constructor() {
    // ä¸»åº“è¿æ¥ï¼ˆå†™æ“ä½œï¼‰
    this.masterPool = mysql.createPool({
      ...dbConfig,
      host: process.env.DB_MASTER_HOST,
      connectionLimit: 10
    });
    
    // ä»åº“è¿æ¥ï¼ˆè¯»æ“ä½œï¼‰
    this.slavePool = mysql.createPool({
      ...dbConfig,
      host: process.env.DB_SLAVE_HOST,
      connectionLimit: 20
    });
  }
  
  /**
   * å†™æ“ä½œï¼ˆä½¿ç”¨ä¸»åº“ï¼‰
   */
  async write(sql, params = []) {
    const connection = await this.masterPool.getConnection();
    try {
      const [result] = await connection.execute(sql, params);
      return result;
    } finally {
      connection.release();
    }
  }
  
  /**
   * è¯»æ“ä½œï¼ˆä½¿ç”¨ä»åº“ï¼‰
   */
  async read(sql, params = []) {
    const connection = await this.slavePool.getConnection();
    try {
      const [result] = await connection.execute(sql, params);
      return result;
    } catch (error) {
      // ä»åº“å¤±è´¥æ—¶å›é€€åˆ°ä¸»åº“
      console.warn('ä»åº“æŸ¥è¯¢å¤±è´¥ï¼Œå›é€€åˆ°ä¸»åº“:', error.message);
      return await this.write(sql, params);
    } finally {
      connection.release();
    }
  }
  
  /**
   * äº‹åŠ¡æ“ä½œï¼ˆå¿…é¡»ä½¿ç”¨ä¸»åº“ï¼‰
   */
  async transaction(callback) {
    const connection = await this.masterPool.getConnection();
    try {
      await connection.beginTransaction();
      const result = await callback(connection);
      await connection.commit();
      return result;
    } catch (error) {
      await connection.rollback();
      throw error;
    } finally {
      connection.release();
    }
  }
}
```

### 2. åˆ†åº“åˆ†è¡¨ç­–ç•¥

#### æ°´å¹³åˆ†è¡¨å®ç°
```javascript
/**
 * åˆ†è¡¨è·¯ç”±ç®¡ç†
 */
class ShardingManager {
  constructor() {
    this.shardCount = 4; // åˆ†è¡¨æ•°é‡
  }
  
  /**
   * æ ¹æ®ç”¨æˆ·IDè®¡ç®—åˆ†è¡¨
   */
  getShardTable(tableName, userId) {
    const shardIndex = userId % this.shardCount;
    return `${tableName}_${shardIndex}`;
  }
  
  /**
   * åˆ†è¡¨æŸ¥è¯¢
   */
  async queryShardTable(tableName, userId, sql, params = []) {
    const shardTable = this.getShardTable(tableName, userId);
    const shardSql = sql.replace(new RegExp(tableName, 'g'), shardTable);
    
    return await db.query(shardSql, params);
  }
  
  /**
   * è·¨åˆ†è¡¨æŸ¥è¯¢
   */
  async queryAllShards(tableName, sql, params = []) {
    const promises = [];
    
    for (let i = 0; i < this.shardCount; i++) {
      const shardTable = `${tableName}_${i}`;
      const shardSql = sql.replace(new RegExp(tableName, 'g'), shardTable);
      promises.push(db.query(shardSql, params));
    }
    
    const results = await Promise.all(promises);
    return results.flat();
  }
}
```

## æ€»ç»“

æœ¬æ•°æ®åº“ä¼˜åŒ–å»ºè®®æ–‡æ¡£æä¾›äº†å…¨é¢çš„ä¼˜åŒ–æ–¹æ¡ˆï¼š

### æ ¸å¿ƒä¼˜åŒ–ç‚¹
1. **è¡¨ç»“æ„ä¼˜åŒ–** - é‡æ„æ ¸å¿ƒè¡¨ï¼Œæ·»åŠ å¿…è¦å­—æ®µå’Œçº¦æŸ
2. **ç´¢å¼•ç­–ç•¥** - è®¾è®¡å¤åˆç´¢å¼•ï¼Œæå‡æŸ¥è¯¢æ€§èƒ½
3. **æŸ¥è¯¢ä¼˜åŒ–** - é‡å†™æ…¢æŸ¥è¯¢ï¼Œä½¿ç”¨ç¼“å­˜å’Œåˆ†é¡µä¼˜åŒ–
4. **æ€§èƒ½è°ƒä¼˜** - MySQLé…ç½®ã€è¿æ¥æ± ã€ç¼“å­˜ç­–ç•¥
5. **ç›‘æ§ç»´æŠ¤** - å®æ—¶ç›‘æ§ã€è‡ªåŠ¨åŒ–ç»´æŠ¤ä»»åŠ¡

### é¢„æœŸæ•ˆæœ
- æŸ¥è¯¢æ€§èƒ½æå‡60-80%
- æ”¯æŒæ›´å¤§çš„å¹¶å‘è®¿é—®é‡
- å‡å°‘ç³»ç»Ÿèµ„æºæ¶ˆè€—
- æé«˜æ•°æ®å®‰å…¨æ€§å’Œä¸€è‡´æ€§
- æ”¯æŒä¸šåŠ¡å¿«é€Ÿæ‰©å±•

### å®æ–½å»ºè®®
1. **åˆ†é˜¶æ®µå®æ–½** - æŒ‰ä¼˜å…ˆçº§é€æ­¥ä¼˜åŒ–
2. **å……åˆ†æµ‹è¯•** - åœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯æ‰€æœ‰ä¼˜åŒ–
3. **ç›‘æ§è·Ÿè¸ª** - å®æ—¶ç›‘æ§ä¼˜åŒ–æ•ˆæœ
4. **å¤‡ä»½ä¿æŠ¤** - ç¡®ä¿æ•°æ®å®‰å…¨
5. **æ–‡æ¡£æ›´æ–°** - åŠæ—¶æ›´æ–°ç›¸å…³æ–‡æ¡£

è¯¥ä¼˜åŒ–æ–¹æ¡ˆå°†æ˜¾è‘—æå‡ç®¡ç†åå°ç³»ç»Ÿçš„æ•°æ®å¤„ç†èƒ½åŠ›å’Œç”¨æˆ·ä½“éªŒã€‚