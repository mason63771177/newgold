<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ë£ÇÈáë7Êó• H5 È°µÈù¢</title>
  
  <!-- Google Tag Manager -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-K7WCTWLM');</script>
  <!-- End Google Tag Manager -->
  
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-QQ6GQ79K7G"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-QQ6GQ79K7G');
  </script>
  
  <!-- PWA Manifest -->
    <link rel="manifest" href="/newgold/assets/json/manifest-CmBET5qe.json">
    
    <!-- iOS Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Ë£ÇÈáë7Êó•">
    
    <!-- iOS Icons -->
    <link rel="apple-touch-icon" sizes="152x152" href="ÂõæÊ†áÊñá‰ª∂/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="ÂõæÊ†áÊñá‰ª∂/icon-192x192.png">
    
    <!-- Android Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="ÂõæÊ†áÊñá‰ª∂/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="ÂõæÊ†áÊñá‰ª∂/icon-512x512.png">
    
    <!-- Splash Screens -->
    <link rel="apple-touch-startup-image" href="ÂõæÊ†áÊñá‰ª∂/splash-390x844.png" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3)">
    <link rel="apple-touch-startup-image" href="ÂõæÊ†áÊñá‰ª∂/splash-414x896.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2)">
    
    <!-- Theme Color -->
  <meta name="theme-color" content="#0b0f14">
  <meta name="msapplication-navbutton-color" content="#0b0f14">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  
  <!-- ËÆ∞ÂΩïÈ°µÈù¢Âä†ËΩΩÂºÄÂßãÊó∂Èó¥ -->
  <script>
    window.loadStartTime = Date.now();
  </script>
    
  
  <style>body,html{color:var(--text-primary);font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,PingFang SC,Hiragino Sans GB,Microsoft YaHei,sans-serif;font-size:16px;height:100vh;margin:0;overflow:hidden;padding:0}.loading-screen,body,html{background:var(--bg-primary)}.loading-screen{align-items:center;display:flex;flex-direction:column;height:100%;justify-content:center;left:0;position:fixed;top:0;transition:opacity .3s ease-out;width:100%;z-index:9999}.loading-screen.hidden{opacity:0;pointer-events:none}.loading-logo{align-items:center;animation:pulse 2s ease-in-out infinite;display:flex;height:80px;justify-content:center;margin-bottom:20px;width:80px}.loading-logo img{border-radius:20px;height:100%;-o-object-fit:contain;object-fit:contain;width:100%}.loading-text{color:var(--text-secondary);font-size:16px;margin-bottom:30px}.loading-spinner{border-top:3px solid var(--border-color);border:3px solid var(--border-color);border-top-color:var(--accent-color);height:40px;width:40px}@keyframes spin{0%{transform:rotate(0deg)}to{transform:rotate(1turn)}}.app.loading{opacity:0;pointer-events:none}.app{display:flex;flex-direction:column;height:100vh;position:relative;z-index:1}.header{background:var(--bg-secondary);border-bottom:1px solid var(--border-color);flex:0 0 65px;flex-direction:column;padding-top:0;z-index:100}.header,.header-main{align-items:center;display:flex;justify-content:center;position:relative}.header-main{gap:15px;margin:0;padding:0 20px;width:100%}.status-info{align-items:center;display:none;gap:6px}.logo{background:var(--btn-gradient);-webkit-background-clip:text;background-clip:text;font-size:32px;font-weight:700;letter-spacing:1px;-webkit-text-fill-color:transparent}.logo,.logo-img{filter:var(--logo-filter)}.logo-img{height:80px;margin:0 auto;-o-object-fit:contain;object-fit:contain;width:80px}.state-label{color:var(--text-secondary);font-size:13px;font-weight:600}.message-icon{align-items:center;cursor:pointer;display:flex;height:48px;justify-content:center;left:10px!important;position:fixed!important;top:10px!important;touch-action:none;transition:all .3s ease;user-select:none;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;width:48px;z-index:101}.message-icon.dragging{cursor:grabbing;opacity:.8;transform:scale(1.1);transition:none}.message-icon:hover:not(.dragging){transform:scale(1.1)}.message-icon img,.message-icon svg{height:36px;transition:all .3s ease;width:36px}.message-icon:hover:not(.dragging) img,.message-icon:hover:not(.dragging) svg{filter:brightness(1.1)}.unread-dot{background:#f44;border:2px solid var(--bg-secondary);border-radius:50%;box-shadow:0 0 8px rgba(255,68,68,.6);height:14px;opacity:0;position:absolute;right:-3px;top:-3px;transform:scale(0);transition:all .3s ease;width:14px}.unread-dot.show{opacity:1;transform:scale(1)}.state-label{text-shadow:0 0 6px var(--accent-color)}.subtitle{color:var(--text-secondary);font-size:11px;opacity:.8}.test-btn{color:var(--accent-color);top:70px}.reset-btn,.test-btn{background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:6px;font-size:12px;padding:3px 6px;position:fixed;right:10px;z-index:998}.reset-btn{color:#ff6464;cursor:pointer;top:120px;transition:all .3s ease}.reset-btn:hover{background:linear-gradient(135deg,#ff6464,#f44);color:var(--text-primary);transform:translateY(-1px)}.settings-btn{background:hsla(0,0%,100%,.2)!important;border:1px solid hsla(0,0%,100%,.4)!important;border-radius:8px!important;box-shadow:0 2px 8px rgba(0,0,0,.3)!important;color:#fff!important;cursor:pointer!important;font-size:14px!important;opacity:.9!important;padding:6px 10px!important;position:fixed!important;right:10px!important;top:10px!important;transition:all .3s ease!important;z-index:999!important}.settings-btn:hover{background:hsla(0,0%,100%,.3)!important;border-color:hsla(0,0%,100%,.6)!important;box-shadow:0 4px 12px rgba(0,0,0,.4)!important;opacity:1!important;transform:scale(1.05)!important}.theme-demo-btn{background:var(--btn-gradient);border:none;border-radius:6px;box-shadow:var(--btn-shadow);color:var(--text-primary);cursor:pointer;font-size:12px;left:12px;padding:3px 6px;position:absolute;top:8px;transition:all .3s ease}.theme-demo-btn:hover{filter:brightness(1.1);transform:translateY(-1px)}.test-btn{cursor:pointer;transition:all .3s ease}.test-btn:hover{background:var(--btn-gradient);color:var(--text-primary)}.content{align-items:center;flex:1;overflow-x:hidden;overflow-y:auto;padding:16px 16px 100px}.card,.content{display:flex;flex-direction:column}.card{backdrop-filter:blur(16px);background:var(--bg-card);border:1px solid var(--border-color);border-radius:24px;box-shadow:var(--btn-shadow);justify-content:center;max-width:480px;padding:24px;width:100%}.section{margin-bottom:16px;position:relative}.section:last-child{margin-bottom:0}.section:not(:last-child):after{background:linear-gradient(90deg,transparent,var(--accent-color),transparent);bottom:-8px;content:"";height:1px;left:0;opacity:.4;position:absolute;right:0}.section-title{color:var(--text-secondary);font-size:16px;font-weight:600;margin-bottom:6px}.section-content{color:var(--text-primary);font-size:14px;line-height:1.4;opacity:.9}.task-list{list-style:none;margin:0;padding:0}.task-item{align-items:center;display:flex;justify-content:space-between;padding:8px 0}.task-item:not(:last-child){border-bottom:1px solid hsla(0,0%,100%,.05)}.task-title{color:#e0e5fb;flex:1;font-size:14px}.task-status{background:linear-gradient(45deg,#00eaff,#08f);border-radius:12px;box-shadow:0 0 6px rgba(0,136,255,.6);color:#031e2e;font-size:12px;padding:2px 6px}.task-status.done{background:linear-gradient(45deg,#9be15d,#00e3ae);box-shadow:0 0 6px rgba(0,227,174,.6)}.task-overview{background:linear-gradient(135deg,rgba(0,136,255,.1),rgba(0,234,255,.05));border:1px solid rgba(0,136,255,.2);border-radius:12px;margin-bottom:20px;padding:16px}.task-stats{display:grid;gap:12px;grid-template-columns:repeat(3,1fr)}.stat-item{background:hsla(0,0%,100%,.05);border:1px solid hsla(0,0%,100%,.1);border-radius:8px;padding:8px;text-align:center}.stat-label{color:var(--text-secondary);display:block;font-size:12px;margin-bottom:4px}.stat-value{color:var(--text-primary);display:block;font-size:16px;font-weight:600}.task-sections{display:flex;flex-direction:column;gap:16px}.task-section{background:hsla(0,0%,100%,.03);border:1px solid hsla(0,0%,100%,.08);border-radius:12px;padding:16px}.task-section h4{align-items:center;color:var(--text-primary);display:flex;font-size:16px;font-weight:600;gap:8px;margin:0 0 12px}.task-item.completed{background:linear-gradient(135deg,rgba(155,225,93,.15),rgba(0,227,174,.1));border-color:rgba(0,227,174,.3)}.task-item.current{background:linear-gradient(135deg,rgba(0,234,255,.15),rgba(0,136,255,.1));border-color:rgba(0,136,255,.4);box-shadow:0 0 12px rgba(0,136,255,.3)}.task-item.available{background:linear-gradient(135deg,rgba(255,193,7,.15),rgba(255,152,0,.1));border-color:rgba(255,193,7,.3)}.task-item.locked{background:hsla(0,0%,100%,.02);border-color:hsla(0,0%,100%,.05);opacity:.6}.task-info{display:flex;flex:1;flex-direction:column;gap:4px}.task-reward{color:var(--accent-color);font-size:12px;font-weight:600}.task-item.completed .task-status{background:linear-gradient(45deg,#9be15d,#00e3ae);box-shadow:0 0 6px rgba(0,227,174,.4);color:#031e2e}.task-item.current .task-status{background:linear-gradient(45deg,#00eaff,#08f);box-shadow:0 0 6px rgba(0,136,255,.4);color:#031e2e}.task-item.available .task-status{background:linear-gradient(45deg,#ffc107,#ff9800);box-shadow:0 0 6px rgba(255,193,7,.4);color:#1a1a1a}.task-item.locked .task-status{background:hsla(0,0%,100%,.1);color:var(--text-secondary)}.notification-center{max-height:400px;overflow-y:auto}.notification-item{align-items:flex-start;background:hsla(0,0%,100%,.05);border:1px solid hsla(0,0%,100%,.1);border-radius:8px;cursor:pointer;display:flex;gap:12px;margin-bottom:8px;padding:12px;transition:all .3s ease}.notification-item:hover{background:hsla(0,0%,100%,.08);transform:translateY(-1px)}.notification-item.redpacket_notification{background:linear-gradient(135deg,hsla(0,100%,71%,.1),rgba(255,193,7,.05));border-color:hsla(0,100%,71%,.3)}.notification-item.task_complete{background:linear-gradient(135deg,rgba(155,225,93,.1),rgba(0,227,174,.05));border-color:rgba(0,227,174,.3)}.notification-item.balance_update{background:linear-gradient(135deg,rgba(0,234,255,.1),rgba(0,136,255,.05));border-color:rgba(0,136,255,.3)}.notification-icon{font-size:20px;line-height:1;margin-top:2px}.notification-content{flex:1}.notification-title{color:var(--text-primary);font-size:14px;font-weight:600;margin-bottom:4px}.notification-message{color:var(--text-secondary);font-size:13px;line-height:1.4;margin-bottom:4px}.notification-time{color:var(--text-muted);font-size:11px}.no-notifications{color:var(--text-secondary);font-size:14px;padding:40px 20px;text-align:center}.floating-notification{animation:slideInRight .3s ease-out;backdrop-filter:blur(10px);background:rgba(0,0,0,.9);border:1px solid hsla(0,0%,100%,.2);border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,.5);cursor:pointer;max-width:300px;padding:16px;position:fixed;right:20px;top:20px;z-index:10000}@keyframes slideInRight{0%{opacity:0;transform:translateX(100%)}to{opacity:1;transform:translateX(0)}}.floating-notification.slide-out{animation:slideOutRight .3s ease-in forwards}@keyframes slideOutRight{0%{opacity:1;transform:translateX(0)}to{opacity:0;transform:translateX(100%)}}.floating-notification-header{align-items:center;display:flex;gap:8px;margin-bottom:8px}.floating-notification-icon{font-size:18px}.floating-notification-title{color:var(--text-primary);flex:1;font-size:14px;font-weight:600}.floating-notification-close{align-items:center;background:none;border:none;color:var(--text-secondary);cursor:pointer;display:flex;font-size:16px;height:20px;justify-content:center;padding:0;width:20px}.floating-notification-message{color:var(--text-secondary);font-size:13px;line-height:1.4}.reactivate-highlight{background:linear-gradient(135deg,hsla(0,100%,71%,.15),rgba(255,193,7,.15));border:2px solid hsla(0,100%,71%,.3);border-radius:12px;margin-bottom:16px;overflow:hidden;padding:20px;position:relative}.reactivate-highlight:before{animation:shimmer 2s infinite;background:linear-gradient(90deg,transparent,hsla(0,0%,100%,.1),transparent);content:"";height:100%;left:-100%;position:absolute;top:0;width:100%}@keyframes shimmer{0%{left:-100%}to{left:100%}}.reactivate-highlight .section-title{color:#ff6b6b;font-size:18px;font-weight:700;text-shadow:0 0 10px hsla(0,100%,71%,.5)}.reactivate-btn{background:linear-gradient(45deg,#ff6b6b,#ffc107);border:none;border-radius:25px;box-shadow:0 4px 15px hsla(0,100%,71%,.4);color:#fff;cursor:pointer;font-size:16px;font-weight:600;padding:12px 24px;text-shadow:0 1px 2px rgba(0,0,0,.3);transition:all .3s ease;width:100%}.reactivate-btn:hover{box-shadow:0 6px 20px hsla(0,100%,71%,.6);transform:translateY(-2px)}.reactivate-btn:active{transform:translateY(0)}.bottom{backdrop-filter:blur(16px);background:hsla(0,0%,100%,.06);border-radius:24px 24px 0 0;border-top:1px solid hsla(0,0%,100%,.12);bottom:0;box-shadow:inset 0 1px 0 hsla(0,0%,100%,.1),0 -4px 20px rgba(0,0,0,.1);display:flex;flex-wrap:wrap;gap:10px;left:0;margin:0 12px 12px;padding:12px 16px calc(20px + env(safe-area-inset-bottom, 0px));position:fixed;right:0;z-index:100}.bottom button{border:none;border-radius:18px;color:var(--text-primary);cursor:pointer;flex:1;font-size:13px;font-weight:700;min-height:36px;min-width:0;overflow:hidden;padding:10px 8px;position:relative;text-overflow:ellipsis;text-shadow:0 1px 2px rgba(0,0,0,.25);transition:all .15s cubic-bezier(.4,0,.2,1);white-space:nowrap}.bottom button,.bottom button.primary{background:var(--btn-gradient);border:1px solid hsla(0,0%,100%,.15);box-shadow:var(--btn-shadow)}.bottom button.primary{font-size:15px;font-weight:800;min-height:52px;padding:17px 14px}.bottom button.financial{background:var(--btn-gradient);border:1px solid hsla(0,0%,100%,.2);box-shadow:var(--btn-shadow);font-weight:800;position:relative}.bottom button.financial:before{content:"üîí";filter:drop-shadow(0 1px 2px rgba(0,0,0,.3));font-size:11px;opacity:.9;position:absolute;right:6px;top:3px}.bottom button.gaming{background:var(--btn-gradient);border:1px solid hsla(0,0%,100%,.15);box-shadow:var(--btn-shadow);position:relative}.bottom button.secondary{background-image:linear-gradient(135deg,#78909c,#546e7a,#455a64);border:1px solid hsla(0,0%,100%,.1);box-shadow:0 4px 20px rgba(120,144,156,.25),inset 0 1px 0 hsla(0,0%,100%,.25),0 2px 8px rgba(0,0,0,.1);font-size:13px}.bottom.many-buttons{gap:10px;justify-content:center;padding:16px 18px calc(26px + env(safe-area-inset-bottom, 0px))}.bottom.many-buttons button{border-radius:16px;flex:0 1 calc(33.333% - 7px);font-size:12px;margin:2px;min-height:44px;padding:14px 10px}.bottom button.blue,.bottom button.green,.bottom button.orange,.bottom button.purple,.bottom button.red{background:var(--btn-gradient);box-shadow:var(--btn-shadow),var(--btn-glow)}.bottom button:disabled{animation:none!important;cursor:default;filter:grayscale(.8) brightness(.7);opacity:.4;transform:none!important}.bottom button:not(:disabled):hover{filter:brightness(1.2) saturate(1.15);transform:translateY(-6px) scale(1.03);transition:all .2s cubic-bezier(.4,0,.2,1)}.bottom button.primary:not(:disabled):hover{animation:none;box-shadow:0 14px 40px rgba(74,144,226,.6),inset 0 1px 0 hsla(0,0%,100%,.5),0 5px 20px rgba(0,0,0,.25),0 0 0 1px rgba(74,144,226,.4)}.bottom button.financial:not(:disabled):hover{box-shadow:0 12px 36px rgba(212,175,55,.5),inset 0 1px 0 hsla(0,0%,100%,.55),0 4px 18px rgba(0,0,0,.25),0 0 0 1px rgba(212,175,55,.4)}.bottom button.gaming:not(:disabled):hover{animation:none;box-shadow:0 14px 40px rgba(156,39,176,.6),inset 0 1px 0 hsla(0,0%,100%,.45),0 5px 20px rgba(0,0,0,.25),0 0 0 1px rgba(156,39,176,.5)}.bottom button.secondary:not(:disabled):hover{box-shadow:0 8px 28px rgba(120,144,156,.4),inset 0 1px 0 hsla(0,0%,100%,.35),0 3px 14px rgba(0,0,0,.15)}.bottom button:not(:disabled):active{filter:brightness(.85) saturate(1.1);transform:translateY(-2px) scale(.97);transition:all .08s ease}@media (hover:none) and (pointer:coarse){.bottom button:not(:disabled):active{filter:brightness(.9);transform:scale(.95);transition:all .1s ease}}@keyframes countdownPulse{0%,to{box-shadow:0 8px 32px rgba(47,128,237,.2),inset 0 1px 0 hsla(0,0%,100%,.1)}50%{box-shadow:0 12px 40px rgba(47,128,237,.3),inset 0 1px 0 hsla(0,0%,100%,.15)}}@keyframes rotate{0%{transform:rotate(0deg)}to{transform:rotate(1turn)}}@keyframes blink{0%,to{opacity:1}50%{opacity:.3}}@keyframes urgentPulse{0%,to{border-color:#ff453a;box-shadow:0 8px 32px rgba(255,69,58,.3),inset 0 1px 0 hsla(0,0%,100%,.1)}50%{border-color:#ff6961;box-shadow:0 12px 40px rgba(255,69,58,.5),inset 0 1px 0 hsla(0,0%,100%,.15)}}@keyframes urgentBlink{0%,to{opacity:1}50%{opacity:.1}}@keyframes slideRight{0%{transform:translateX(-100%)}to{transform:translateX(400%)}}@media (max-width:480px){.countdown-container{margin:0 -4px 16px!important;padding:16px!important}.countdown-container .time-display{font-size:28px!important;letter-spacing:1px!important}.countdown-container .progress-ring,.countdown-container .progress-ring svg{height:70px!important;width:70px!important}.countdown-container .progress-ring circle{r:30!important;stroke-dasharray:188!important}.countdown-container .time-area{gap:12px!important}.countdown-container #countdownStatus{font-size:11px!important;padding:6px 10px!important}.grid-stats{gap:8px!important;grid-template-columns:1fr!important}.grid-stats,.stat-item{font-size:11px!important}.stat-item{padding:8px!important}.stat-value{font-size:13px!important}}@media (max-width:360px){.countdown-container{padding:12px!important}.countdown-container .time-display{font-size:24px!important}.countdown-container .progress-ring,.countdown-container .progress-ring svg{height:60px!important;width:60px!important}.countdown-container .progress-ring circle{r:25!important;stroke-dasharray:157!important}.countdown-container .time-labels{font-size:10px!important;gap:8px!important}}.bottom button[data-key=inviteNew],.bottom button[data-key=invite]{box-shadow:0 12px 32px rgba(86,204,242,.55),inset 0 1px 0 hsla(0,0%,100%,.3)}.bottom button.primary-highlight{animation:pulse-glow 2s ease-in-out infinite!important;background:linear-gradient(135deg,#0f8,#0c6,#094)!important;border:2px solid rgba(0,255,136,.6)!important;box-shadow:0 8px 24px rgba(0,255,136,.4),0 4px 12px rgba(0,204,102,.3),inset 0 1px 0 hsla(0,0%,100%,.4)!important;font-size:18px!important;font-weight:700!important;padding:16px 24px!important}.bottom button.primary-highlight:hover{box-shadow:0 12px 32px rgba(0,255,136,.5),0 6px 16px rgba(0,204,102,.4),inset 0 1px 0 hsla(0,0%,100%,.5)!important;transform:translateY(-4px)!important}@keyframes pulse-glow{0%,to{box-shadow:0 8px 24px rgba(0,255,136,.4),0 4px 12px rgba(0,204,102,.3),inset 0 1px 0 hsla(0,0%,100%,.4)}50%{box-shadow:0 12px 32px rgba(0,255,136,.6),0 6px 16px rgba(0,204,102,.5),inset 0 1px 0 hsla(0,0%,100%,.5)}}.dialog{align-items:center;backdrop-filter:blur(8px);background:rgba(0,0,0,.7);bottom:0;display:flex;justify-content:center;left:0;opacity:0;position:fixed;right:0;top:0;transition:all .3s cubic-bezier(.4,0,.2,1);visibility:hidden;z-index:1000}.dialog.show{opacity:1;visibility:visible}.dialog .dialog-box{background:var(--bg-card);border:1px solid var(--border-color);border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,.3),0 8px 24px rgba(0,0,0,.2);color:var(--text-primary);max-width:85%;min-width:280px;overflow:hidden;padding:28px 32px;position:relative;transform:scale(.7) translateY(20px);transition:all .4s cubic-bezier(.34,1.56,.64,1)}.dialog.show .dialog-box{transform:scale(1) translateY(0)}.dialog .dialog-box:before{background:linear-gradient(90deg,transparent,hsla(0,0%,100%,.1),transparent);content:"";height:100%;left:-100%;position:absolute;top:0;transition:left .6s;width:100%}.dialog.show .dialog-box:before{left:100%}.dialog .dialog-box h3{font-size:20px;font-weight:600;margin:0 0 16px;text-align:center}.payment-dialog{align-items:center;backdrop-filter:blur(12px);background:rgba(0,0,0,.8);bottom:0;display:flex;justify-content:center;left:0;opacity:0;position:fixed;right:0;top:0;transition:all .4s cubic-bezier(.4,0,.2,1);visibility:hidden;z-index:1001}.payment-dialog.show{opacity:1;visibility:visible}.payment-dialog .payment-box{background:linear-gradient(145deg,var(--bg-card),hsla(0,0%,100%,.05));border:2px solid rgba(47,128,237,.3);border-radius:24px;box-shadow:0 24px 80px rgba(0,0,0,.4),0 12px 32px rgba(0,0,0,.3);color:var(--text-primary);max-width:90%;overflow:hidden;padding:32px;position:relative;transform:scale(.8) translateY(30px);transition:all .5s cubic-bezier(.34,1.56,.64,1);width:400px}.payment-dialog.show .payment-box{transform:scale(1) translateY(0)}.payment-dialog .payment-box:before{animation:payment-border-glow 3s ease-in-out infinite;background:linear-gradient(45deg,var(--brand),var(--brand-2),var(--brand));border-radius:24px;bottom:-2px;content:"";left:-2px;position:absolute;right:-2px;top:-2px;z-index:-1}@keyframes payment-border-glow{0%,to{opacity:.5}50%{opacity:1}}.payment-header{margin-bottom:24px;position:relative;text-align:center}.payment-header h3{background:linear-gradient(135deg,var(--brand),var(--brand-2));-webkit-background-clip:text;font-size:22px;font-weight:700;margin:0 0 8px;-webkit-text-fill-color:transparent;background-clip:text}.payment-amount{animation:amount-pulse 2s ease-in-out infinite;color:#0f8;font-size:32px;font-weight:800;margin:8px 0;text-shadow:0 0 20px rgba(0,255,136,.3)}@keyframes amount-pulse{0%,to{transform:scale(1)}50%{transform:scale(1.05)}}.payment-field{margin-bottom:16px}.payment-field:last-child{margin-bottom:0}.payment-label{color:var(--text-secondary);display:block;font-size:14px;font-weight:600;margin-bottom:6px}.payment-value{align-items:center;background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:12px;display:flex;font-family:Courier New,monospace;font-size:14px;gap:8px;padding:12px 16px;word-break:break-all}.copy-btn{background:var(--brand);border:none;border-radius:8px;color:#fff;cursor:pointer;flex-shrink:0;font-size:12px;padding:6px 12px;transition:all .2s ease}.copy-btn:hover{background:var(--brand-2);transform:translateY(-1px)}.qr-container{background:#fff;border:2px solid var(--border-color);border-radius:16px;margin:20px 0;padding:20px;text-align:center}.qr-code{align-items:center;background:#f8f9fa;border-radius:12px;color:#666;display:flex;font-size:14px;height:200px;justify-content:center;margin:0 auto;width:200px}.countdown-container{background:linear-gradient(135deg,hsla(0,100%,71%,.1),rgba(255,193,7,.1));border:1px solid hsla(0,100%,71%,.2);border-radius:12px;margin:20px 0;padding:16px;text-align:center}.countdown-label{color:var(--text-secondary);font-size:14px;margin-bottom:8px}.countdown-time{color:#ff6b6b;font-family:Courier New,monospace;font-size:24px;font-weight:700;text-shadow:0 0 10px hsla(0,100%,71%,.3)}.payment-actions{display:flex;gap:12px;margin-top:24px}.payment-btn{border:none;border-radius:12px;cursor:pointer;flex:1;font-size:16px;font-weight:600;overflow:hidden;padding:14px 20px;position:relative;transition:all .3s ease}.payment-btn.primary{background:linear-gradient(135deg,var(--brand),var(--brand-2));box-shadow:0 8px 24px rgba(47,128,237,.3);color:#fff}.payment-btn.primary:hover{box-shadow:0 12px 32px rgba(47,128,237,.4);transform:translateY(-2px)}.payment-btn.secondary{background:var(--bg-secondary);border:1px solid var(--border-color);color:var(--text-primary)}.payment-btn.secondary:hover{background:var(--bg-card);transform:translateY(-1px)}.payment-status{border-radius:8px;font-size:14px;font-weight:500;margin-top:16px;padding:12px;text-align:center}.payment-status.waiting{background:rgba(255,193,7,.1);border:1px solid rgba(255,193,7,.2);color:#ffc107}.payment-status.success{background:rgba(40,167,69,.1);border:1px solid rgba(40,167,69,.2);color:#28a745}.payment-status.error{background:rgba(220,53,69,.1);border:1px solid rgba(220,53,69,.2);color:#dc3545}.payment-info{background:rgba(47,128,237,.1);border:1px solid rgba(47,128,237,.2);border-radius:16px;margin-bottom:20px;padding:20px}.amount-section,.countdown-section,.order-section,.qr-section,.wallet-section{margin-bottom:16px}.amount-section:last-child,.countdown-section:last-child,.order-section:last-child,.qr-section:last-child,.wallet-section:last-child{margin-bottom:0}.amount-label,.countdown-label,.order-label,.qr-label,.wallet-label{color:var(--text-secondary);display:block;font-size:14px;font-weight:600;margin-bottom:8px}.amount-value{animation:amount-pulse 2s ease-in-out infinite;color:#0f8;font-size:32px;font-weight:800;text-align:center;text-shadow:0 0 20px rgba(0,255,136,.3)}.wallet-address{background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:12px;font-family:Courier New,monospace;font-size:14px;margin-bottom:8px;padding:12px 16px;word-break:break-all}.qr-code{background:#fff;border:2px solid var(--border-color);border-radius:16px;margin:16px 0;padding:20px;text-align:center}.countdown-timer{color:#ff6b6b;font-size:24px;font-weight:700;text-align:center;text-shadow:0 0 10px hsla(0,100%,71%,.3)}.countdown-timer,.order-id{font-family:Courier New,monospace}.order-id{background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:12px;font-size:14px;padding:12px 16px;word-break:break-all}.status-indicator{align-items:center;background:rgba(255,193,7,.1);border:1px solid rgba(255,193,7,.2);border-radius:8px;color:#ffc107;display:flex;font-size:14px;font-weight:500;gap:8px;justify-content:center;padding:12px}.loading-spinner{animation:spin 1s linear infinite;border:2px solid rgba(255,193,7,.3);border-radius:50%;border-top-color:#ffc107;height:16px;width:16px}.payment-tips{background:rgba(255,193,7,.1);border:1px solid rgba(255,193,7,.2);border-radius:12px;margin-top:16px;padding:16px}.payment-tips p{color:var(--text-secondary);font-size:14px;margin:8px 0}.payment-tips p:first-child{margin-top:0}.payment-tips p:last-child{margin-bottom:0}.close-btn{align-items:center;background:none;border:none;border-radius:50%;color:var(--text-secondary);cursor:pointer;display:flex;font-size:24px;height:32px;justify-content:center;padding:4px;position:absolute;right:16px;top:16px;transition:all .2s ease;width:32px}.close-btn:hover{background:hsla(0,0%,100%,.1);color:var(--text-primary)}.modal{align-items:flex-start;background:transparent;display:flex;height:auto;justify-content:flex-start;left:20px;padding:0;position:fixed;top:20px;width:auto;z-index:1000}.modal-content{background:var(--bg-card);border:1px solid var(--border-color);border-radius:16px;box-shadow:0 8px 32px rgba(0,0,0,.3);max-height:90vh;overflow-y:auto;padding:24px;position:relative}.modal-close{align-items:center;background:none;border:none;border-radius:50%;color:var(--text-secondary);cursor:pointer;display:flex;flex-shrink:0;font-size:20px;height:32px;justify-content:center;padding:4px;transition:all .2s ease;width:32px}.modal-close:hover{background:hsla(0,0%,100%,.1);color:var(--text-primary)}.settings-panel{padding:0}.settings-header{border-bottom:2px solid var(--border-color);margin-bottom:24px;padding-bottom:20px;text-align:center}.settings-header h2{color:var(--text-primary);font-size:20px;font-weight:700;margin:0}.profile-card{align-items:center;background:linear-gradient(135deg,var(--brand),var(--brand-2));border-radius:16px;box-shadow:0 8px 24px rgba(47,128,237,.2);display:flex;gap:16px;margin-bottom:24px;padding:20px}.profile-avatar{flex-shrink:0}.avatar-circle{align-items:center;backdrop-filter:blur(10px);background:hsla(0,0%,100%,.2);border-radius:50%;display:flex;font-size:24px;height:50px;justify-content:center;width:50px}.profile-info{color:#fff;flex:1}.profile-name{font-size:16px;font-weight:600;margin-bottom:4px}.profile-code{font-size:13px;opacity:.9}.profile-level{flex-shrink:0}.level-badge{backdrop-filter:blur(10px);background:hsla(0,0%,100%,.2);border-radius:20px;color:#fff;font-size:12px;font-weight:600;padding:6px 12px}.settings-section{margin-bottom:24px}.settings-section h3{color:var(--text-primary);font-size:16px;font-weight:600;margin:0 0 12px}.settings-card{background:var(--bg-card);border:1px solid var(--border-color);border-radius:12px;overflow:hidden}.setting-item{align-items:center;border-bottom:1px solid var(--border-color);display:flex;padding:16px 20px;transition:background-color .2s ease}.setting-item:last-child{border-bottom:none}.setting-item.clickable{cursor:pointer}.setting-item.clickable:hover{background:rgba(47,128,237,.05)}.setting-info{flex:1}.setting-title{color:var(--text-primary);display:block;font-size:15px;font-weight:500;margin-bottom:2px}.setting-desc{display:block;font-size:13px}.arrow,.setting-desc{color:var(--text-secondary)}.arrow{font-size:18px;font-weight:700}.theme-btn{align-items:center;background:var(--brand);border:none;border-radius:8px;color:#fff;cursor:pointer;display:flex;font-size:14px;gap:8px;padding:8px 16px;transition:all .2s ease}.theme-btn:hover{box-shadow:0 4px 12px rgba(47,128,237,.3);transform:translateY(-1px)}.theme-preview{background:linear-gradient(45deg,#ff6b6b,#4ecdc4,#45b7d1);border-radius:4px;height:16px;width:16px}.modern-select{background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:8px;color:var(--text-primary);cursor:pointer;font-size:14px;min-width:140px;padding:8px 12px;transition:all .2s ease}.modern-select:focus{border-color:var(--brand);box-shadow:0 0 0 3px rgba(47,128,237,.1);outline:none}.toggle-switch{display:inline-block;height:28px;position:relative;width:50px}.toggle-switch input{height:0;opacity:0;width:0}.toggle-slider{background-color:#ccc;border-radius:28px;bottom:0;cursor:pointer;left:0;position:absolute;right:0;top:0;transition:.3s}.toggle-slider:before{background-color:#fff;border-radius:50%;bottom:4px;box-shadow:0 2px 4px rgba(0,0,0,.2);content:"";height:20px;left:4px;position:absolute;transition:.3s;width:20px}input:checked+.toggle-slider{background-color:var(--brand)}input:checked+.toggle-slider:before{transform:translateX(22px)}.action-btn{background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:6px;color:var(--text-primary);cursor:pointer;font-size:13px;padding:6px 12px;transition:all .2s ease}.action-btn:hover{background:var(--brand);border-color:var(--brand);color:#fff}.danger-zone{margin:32px 0 24px}.danger-zone h3{color:#ff6b6b;font-size:16px;font-weight:600;margin:0 0 12px}.danger-card{background:hsla(0,100%,71%,.05);border:1px solid hsla(0,100%,71%,.2);border-radius:12px;padding:20px}.danger-warning{align-items:flex-start;background:hsla(0,100%,71%,.1);border-radius:8px;display:flex;gap:12px;margin-bottom:16px;padding:12px}.warning-icon{flex-shrink:0;font-size:20px}.warning-text{color:var(--text-secondary);font-size:13px;line-height:1.4}.danger-btn{background:linear-gradient(135deg,#ff6b6b,#ee5a52);border:none;border-radius:8px;box-shadow:0 4px 12px hsla(0,100%,71%,.3);color:#fff;cursor:pointer;font-size:15px;font-weight:600;padding:12px 24px;transition:all .2s ease;width:100%}.danger-btn:hover{box-shadow:0 6px 16px hsla(0,100%,71%,.4);transform:translateY(-2px)}.danger-btn:active{transform:translateY(0)}.settings-footer{border-top:2px solid var(--border-color);margin-top:32px;padding-top:20px;text-align:center}.back-btn{background:linear-gradient(135deg,#4a90e2,#357abd);border:none;border-radius:10px;box-shadow:0 4px 12px rgba(74,144,226,.3);color:#fff;cursor:pointer;font-size:16px;font-weight:600;min-width:200px;padding:14px 32px;transition:all .2s ease}.back-btn:hover{box-shadow:0 6px 16px rgba(74,144,226,.4);transform:translateY(-2px)}.back-btn:active{transform:translateY(0)}.settings-select:focus{border-color:var(--brand);box-shadow:0 0 0 2px rgba(47,128,237,.2);outline:none}.dialog .dialog-box p{font-size:16px;line-height:1.6;margin:0 0 24px;text-align:center;white-space:pre-line}.dialog .dialog-box button{background:linear-gradient(135deg,var(--btn-primary),#06c);border:none;border-radius:12px;box-shadow:0 4px 16px rgba(0,102,204,.3);color:#fff;cursor:pointer;font-size:16px;font-weight:600;margin:0 6px;overflow:hidden;padding:14px 28px;position:relative;transition:all .3s cubic-bezier(.4,0,.2,1)}.dialog .dialog-box button:hover{box-shadow:0 8px 24px rgba(0,102,204,.4);transform:translateY(-2px)}.dialog .dialog-box button:active{box-shadow:var(--btn-shadow);color:var(--text-primary);cursor:pointer;font-weight:600;margin:0 5px;transform:translateY(0)}.dialog .dialog-box .secondary-btn{background:linear-gradient(135deg,#95a5a6,#7f8c8d);color:#fff}.dialog .dialog-box .danger-btn{background:linear-gradient(135deg,#e74c3c,#c0392b);color:#fff}#dialogButtons{display:flex;gap:12px;justify-content:center;margin-top:20px}.dialog.success .dialog-box{background:linear-gradient(135deg,var(--bg-card) 0,rgba(0,255,136,.05) 100%);border:2px solid rgba(0,255,136,.3);box-shadow:0 20px 60px rgba(0,255,136,.2),0 8px 24px rgba(0,0,0,.2)}.dialog.success .dialog-box h3{color:#0f8;text-shadow:0 0 10px rgba(0,255,136,.3)}.dialog.success .dialog-box:after{animation:celebrate .6s ease-out;content:"üéâ";font-size:24px;position:absolute;right:-10px;top:-10px}@keyframes celebrate{0%{opacity:0;transform:scale(0) rotate(0deg)}50%{opacity:1;transform:scale(1.2) rotate(180deg)}to{opacity:1;transform:scale(1) rotate(1turn)}}.dialog.success .dialog-box:before{background:linear-gradient(90deg,transparent,rgba(0,255,136,.2),transparent)}.dialog.success .dialog-box{animation:successPulse 2s ease-in-out infinite}@keyframes successPulse{0%,to{box-shadow:0 20px 60px rgba(0,255,136,.2),0 8px 24px rgba(0,0,0,.2)}50%{box-shadow:0 20px 60px rgba(0,255,136,.4),0 8px 24px rgba(0,255,136,.1)}}.dialog.success button{background:linear-gradient(135deg,#0f8,#0c6);box-shadow:0 4px 16px rgba(0,255,136,.4)}.dialog.success button:hover{box-shadow:0 8px 24px rgba(0,255,136,.6);transform:translateY(-3px)}.invite-highlight{background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:16px;box-shadow:var(--btn-glow);margin-top:12px;padding:12px}.invite-highlight .section-title{color:var(--accent-color)}.invite-link-container{align-items:center;display:flex;gap:8px}.invite-link-container input{flex:1;min-width:0}.invite-link-container button:hover{background:linear-gradient(135deg,#45a049,#3d8b40)!important;box-shadow:0 2px 4px rgba(0,0,0,.2);transform:translateY(-1px)}@media (max-width:768px){body,html{font-size:18px}.state-label{font-size:15px!important}.subtitle{font-size:13px!important}.bottom button,.btn,button{font-size:16px!important}.setting-title{font-size:17px!important}.setting-desc{font-size:15px!important}.modern-select,.theme-btn{font-size:16px!important}.reset-btn,.settings-btn,.test-btn{font-size:14px!important}.test-buttons{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}.test-btn.small{font-size:12px;min-width:60px;padding:6px 12px}.section-title{font-size:18px!important}.detail-row,.info,.txn-item{font-size:16px!important}.caption,.note{font-size:14px!important}#countdown,.countdown{font-size:26px!important}.amount,.balance,.price,.value{font-size:20px!important}#myInviteCode{font-size:18px!important}#inviteLink,.stats-card,button[onclick*=copy]{font-size:13px!important}.task-item{font-size:14px!important}.status-badge{font-size:12px!important}.countdown-container span[style*="font-size: 11px"]{font-size:14px!important}.countdown-container div[style*="font-size: 9px"]{font-size:12px!important}.countdown-container span[style*="font-size: 10px"]{font-size:13px!important}.grid-stats .stat-item div[style*="color: var(--text-secondary)"]{font-size:14px!important}.grid-stats .stat-value{font-size:16px!important}div[style*="font-size: 12px"][style*="üíé ÊàëÁöÑ‰∏ìÂ±ûÈÇÄËØ∑Á†Å"],div[style*="font-size: 12px"][style*="üîó ÈÇÄËØ∑ÈìæÊé•"]{font-size:15px!important}[style*="font-size: 9px"]{font-size:12px!important}[style*="font-size: 10px"]{font-size:13px!important}[style*="font-size: 11px"]{font-size:14px!important}[style*="font-size: 12px"]{font-size:15px!important}}.message-header{align-items:center;border-bottom:1px solid var(--border-color);display:flex;justify-content:space-between;padding:20px 20px 16px}.message-title{color:var(--text-primary);font-size:18px;font-weight:600;margin:0}.header-actions{gap:16px}.header-actions,.mark-all-read-btn-header{align-items:center;display:flex;flex-shrink:0}.mark-all-read-btn-header{background:rgba(47,128,237,.1);border:1px solid rgba(47,128,237,.2);border-radius:6px;color:var(--brand);cursor:pointer;font-size:13px;font-weight:500;height:28px;justify-content:center;min-width:36px;padding:6px 12px;transition:all .2s ease;white-space:nowrap}.mark-all-read-btn-header:hover{background:rgba(47,128,237,.15);border-color:rgba(47,128,237,.3);transform:translateY(-1px)}.mark-all-read-btn-header:active{background:rgba(47,128,237,.2);transform:translateY(0)}.message-tabs{background:var(--bg-secondary);border-radius:8px;display:flex;gap:4px;margin:16px 20px;padding:4px}.tab-btn{align-items:center;background:transparent;border:none;border-radius:6px;color:var(--text-secondary);cursor:pointer;display:flex;flex:1;font-size:14px;font-weight:500;gap:8px;justify-content:center;padding:12px 16px;position:relative;transition:all .2s ease}.tab-btn.active{background:var(--brand);box-shadow:0 2px 8px rgba(47,128,237,.3);color:#fff}.tab-btn:hover:not(.active){background:rgba(47,128,237,.1);color:var(--brand)}.message-actions{display:flex;justify-content:center;padding:0 20px 16px}.mark-all-read-btn{background:linear-gradient(135deg,#28a745,#20c997);border:none;border-radius:20px;box-shadow:0 2px 8px rgba(40,167,69,.3);color:#fff;cursor:pointer;font-size:13px;font-weight:500;padding:8px 16px;transition:all .2s ease}.mark-all-read-btn:hover{box-shadow:0 4px 12px rgba(40,167,69,.4);transform:translateY(-1px)}.mark-all-read-btn:active{transform:translateY(0)}.unread-count{align-items:center;background:#ff4757;border-radius:10px;color:#fff;display:flex;font-size:11px;font-weight:600;height:16px;justify-content:center;line-height:1;min-width:16px;padding:2px 6px}.message-content{height:400px;overflow-y:auto;padding:0 20px 20px}.message-list{display:none}.message-list.active{display:block}.empty-message{align-items:center;color:var(--text-secondary);display:flex;flex-direction:column;height:200px;justify-content:center}.empty-icon{font-size:48px;margin-bottom:12px;opacity:.6}.empty-text{font-size:14px;opacity:.8}.message-item{background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:12px;margin-bottom:12px;padding:16px;position:relative;transition:all .2s ease}.message-item:hover{box-shadow:0 4px 12px rgba(0,0,0,.1);transform:translateY(-1px)}.message-item.unread{background:rgba(47,128,237,.05);border-left:4px solid var(--brand)}.message-item.unread:before{background:#ff4757;border-radius:50%;content:"";height:8px;position:absolute;right:16px;top:16px;width:8px}.message-header-info{align-items:flex-start;display:flex;justify-content:space-between;margin-bottom:8px}.message-title-text{color:var(--text-primary);font-size:15px;font-weight:600;line-height:1.3;margin:0}.message-time{color:var(--text-secondary);font-size:12px;margin-left:12px;white-space:nowrap}.message-content-text{color:var(--text-secondary);font-size:14px;line-height:1.5;margin:0}.message-category{background:rgba(47,128,237,.1);border-radius:12px;color:var(--brand);display:inline-block;font-size:11px;font-weight:500;margin-top:8px;padding:2px 8px}@keyframes messageFlash{0%,to{background:var(--btn-gradient);box-shadow:0 2px 6px var(--accent-shadow);transform:scale(1)}50%{background:linear-gradient(45deg,#ff6b6b,#4ecdc4);box-shadow:0 4px 16px hsla(0,100%,71%,.4);transform:scale(1.05)}}.message-flash{animation:messageFlash 1.5s ease-in-out infinite}.bug-report-form{background:var(--bg-secondary);border-radius:12px;margin-bottom:20px;padding:20px}.bug-report-form h4{color:var(--text-primary);font-size:16px;font-weight:600;margin:0 0 16px}.form-group{margin-bottom:16px}.form-group label{color:var(--text-primary);display:block;font-size:14px;font-weight:500;margin-bottom:6px}.form-group input,.form-group select,.form-group textarea{background:hsla(0,0%,100%,.05);border:1px solid hsla(0,0%,100%,.1);border-radius:8px;box-sizing:border-box;color:var(--text-primary);font-size:14px;padding:10px 12px;transition:all .2s ease;width:100%}.form-group input:focus,.form-group select:focus,.form-group textarea:focus{border-color:var(--brand);box-shadow:0 0 0 2px rgba(47,128,237,.2);outline:none}.submit-bug-btn{background:linear-gradient(135deg,#ff6b6b,#ee5a52);border:none;border-radius:20px;box-shadow:0 2px 8px hsla(0,100%,71%,.3);color:#fff;cursor:pointer;font-size:14px;font-weight:500;padding:10px 20px;transition:all .2s ease;width:100%}.submit-bug-btn:hover{box-shadow:0 4px 12px hsla(0,100%,71%,.4);transform:translateY(-1px)}.bug-list-section{margin-top:20px}.bug-list-section h4{color:var(--text-primary);font-size:16px;font-weight:600;margin:0 0 12px}.bug-item{background:hsla(0,0%,100%,.05);border-left:3px solid #ff6b6b;border-radius:8px;margin-bottom:8px;padding:12px}.bug-item-header{align-items:flex-start;display:flex;justify-content:space-between;margin-bottom:8px}.bug-header-right{align-items:center;display:flex;gap:8px}.delete-bug-btn{align-items:center;background:hsla(0,100%,71%,.2);border:none;border-radius:4px;color:#ff6b6b;cursor:pointer;display:flex;font-size:14px;height:24px;justify-content:center;min-width:24px;padding:4px 6px;transition:all .2s ease}.delete-bug-btn:hover{background:hsla(0,100%,71%,.3);transform:scale(1.1)}.delete-bug-btn:active{transform:scale(.95)}.delete-message-btn{align-items:center;background:hsla(0,100%,71%,.2);border:none;border-radius:4px;color:#ff6b6b;cursor:pointer;display:flex;font-size:14px;height:24px;justify-content:center;margin-left:8px;min-width:24px;padding:4px 6px;transition:all .2s ease}.delete-message-btn:hover{background:hsla(0,100%,71%,.3);transform:scale(1.1)}.delete-message-btn:active{transform:scale(.95)}.message-header-right{align-items:center;display:flex;gap:8px}.bug-title{color:var(--text-primary);font-size:14px;font-weight:600;margin:0}.bug-time{font-size:12px}.bug-description,.bug-time{color:var(--text-secondary)}.bug-description{font-size:13px;line-height:1.4;margin:8px 0}.bug-type{background:hsla(0,100%,71%,.2);border-radius:12px;color:#ff6b6b;display:inline-block;font-size:11px;font-weight:500;padding:2px 8px}.bottom button[data-key=message]{position:relative}.bottom button[data-key=message].has-unread:after{animation:pulse 2s infinite;background:#ff4757;border:2px solid var(--bg-primary);border-radius:50%;content:"";height:8px;position:absolute;right:-2px;top:-2px;width:8px}@keyframes pulse{0%{opacity:1;transform:scale(1)}50%{opacity:.7;transform:scale(1.2)}to{opacity:1;transform:scale(1)}}</style>
  <link rel="stylesheet" crossorigin href="/newgold/assets/css/main-Z8MB1XKE.css">
  <link rel="stylesheet" crossorigin href="/newgold/assets/css/themes-Cd7cymCc.css">
  <link rel="stylesheet" crossorigin href="/newgold/assets/css/global-background-D97W4UkV.css">
</head>
<body>
  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-K7WCTWLM"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->
  
  <!-- Âä†ËΩΩÂ±èÂπï -->
  <div id="loadingScreen" class="loading-screen">
    <div class="loading-logo">
      <img src="/newgold/assets/images/logo_gold7-BN-9ArRY.png" alt="Ë£ÇÈáë7Êó•ÊåëÊàò" />
    </div>
    <div class="loading-text">Ê≠£Âú®Âä†ËΩΩ...</div>
    <div class="loading-spinner"></div>
  </div>
  
  <div id="app" class="app loading">
    <!-- Ê∂àÊÅØÂõæÊ†á - ÁßªÂà∞ÊúÄÂ§ñÂ±ÇÈÅøÂÖçflexÂ∏ÉÂ±ÄÂΩ±Âìç -->
    <div id="messageIcon" class="message-icon" onclick="showMessages()">
      <img src="/newgold/assets/images/message_optimized-mflW0grP.png" alt="Ê∂àÊÅØ" width="36" height="36" />
      <div id="messageUnreadDot" class="unread-dot" style="display: none;"></div>
    </div>
    
    <div class="header">
      <div class="header-main">
        <!-- ÊîæÂ§ßÁöÑlogo -->
        <img src="/newgold/assets/images/logo_gold7-BN-9ArRY.png" alt="Logo" class="logo-img" />
        <div class="status-info">
          <div id="stateLabel" class="state-label">Áä∂ÊÄÅ1</div>
          <div id="subtitle" class="subtitle">Ê¨¢ËøéÂä†ÂÖ•Ë£ÇÈáë7Êó•</div>
        </div>
      </div>
      <button class="settings-btn" onclick="console.log('ËÆæÁΩÆÊåâÈíÆË¢´ÁÇπÂáª'); openSettings();">‚öôÔ∏è</button>
    </div>
    <div class="content">
      <div id="card" class="card">
        <!-- Âä®ÊÄÅÂÜÖÂÆπÂ∞ÜÂú®ËøôÈáåÊ≥®ÂÖ• -->
      </div>
    </div>
    <div id="bottomButtons" class="bottom">
      <!-- Â∫ïÈÉ®ÊåâÈíÆÂä®ÊÄÅÁîüÊàê -->
    </div>
  </div>
  <!-- Ê®°ÊÄÅÂºπÁ™ó -->
  <div id="modal" class="modal" style="display:none;">
    <div class="modal-content">
      <button id="modalClose" class="modal-close">‚úï</button>
      <div id="modalBody"></div>
    </div>
  </div>
  <div id="dialog" class="dialog" style="display:none;">
    <div class="dialog-box">
      <h3 id="dialogTitle">ÊèêÁ§∫</h3>
      <p id="dialogMsg">ÂÜÖÂÆπ</p>
      <div id="dialogButtons">
        <button onclick="closeDialog()">Á°ÆÂÆö</button>
      </div>
    </div>
  </div>

  <!-- ËÆæÁΩÆÈù¢Êùø -->
  <div id="settingsModal" class="modal" style="display:none;">
    <div class="modal-content" style="max-width: 420px; width: 95%; max-height: 90vh; overflow-y: auto;">
      <button class="modal-close" onclick="closeSettings()">‚úï</button>
      <div class="settings-panel">
        <!-- Ê†áÈ¢ò -->
        <div class="settings-header">
          <h2>‚öôÔ∏è ËÆæÁΩÆ‰∏≠ÂøÉ</h2>
        </div>
        
        <!-- ‰∏™‰∫∫ËµÑÊñôÂç°Áâá -->
        <div class="profile-card">
          <div class="profile-avatar">
            <div class="avatar-circle">üë§</div>
          </div>
          <div class="profile-info">
            <div class="profile-name" id="userEmailDisplay">Êú™ÁôªÂΩï</div>
            <div class="profile-code">ÈÇÄËØ∑Á†ÅÔºö<span id="userInviteCodeDisplay">-</span></div>
          </div>
        </div>

        <!-- Â§ñËßÇËÆæÁΩÆ -->
        <div class="settings-section">
          <h3>üé® Â§ñËßÇËÆæÁΩÆ</h3>
          <div class="settings-card">

            <div class="setting-item">
              <div class="setting-info">
                <span class="setting-title">üåê ËØ≠Ë®Ä</span>
                <span class="setting-desc">ÈÄâÊã©ÁïåÈù¢ÊòæÁ§∫ËØ≠Ë®Ä</span>
              </div>
              <select id="languageSelect" class="modern-select">
                <option value="zh-CN" selected>üá®üá≥ ÁÆÄ‰Ωì‰∏≠Êñá</option>
                <option value="zh-TW">üá®üá≥ ÁπÅÈ´î‰∏≠Êñá</option>
                <option value="en-US">üá∫üá∏ English</option>
                <option value="ja-JP">üáØüáµ Êó•Êú¨Ë™û</option>
                <option value="ko-KR">üá∞üá∑ ÌïúÍµ≠Ïñ¥</option>
                <option value="th-TH">üáπüá≠ ‡πÑ‡∏ó‡∏¢</option>
                <option value="hi-IN">üáÆüá≥ ‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</option>
                <option value="vi-VN">üáªüá≥ Ti·∫øng Vi·ªát</option>
                <option value="km-KH">üá∞üá≠ ·ûÅ·üí·ûò·üÇ·ûö</option>
                <option value="ru-RU">üá∑üá∫ –†—É—Å—Å–∫–∏–π</option>
                <option value="mn-MN">üá≤üá≥ –ú–æ–Ω–≥–æ–ª</option>
                <option value="my-MM">üá≤üá≤ ·Äô·Äº·Äî·Ä∫·Äô·Ä¨</option>
                <option value="lo-LA">üá±üá¶ ‡∫•‡∫≤‡∫ß</option>
                <option value="ar-SA">üá∏üá¶ ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
              </select>
            </div>
          </div>
        </div>

        <!-- ÂäüËÉΩËÆæÁΩÆ -->
        <div class="settings-section">
          <h3>üîß ÂäüËÉΩËÆæÁΩÆ</h3>
          <div class="settings-card">



            <div class="setting-item">
              <div class="setting-info">
                <span class="setting-title">üîÑ Áä∂ÊÄÅÂàáÊç¢</span>
                <span class="setting-desc">ÂàáÊç¢Áî®Êà∑Áä∂ÊÄÅËøõË°åÊµãËØï</span>
              </div>
              <select id="stateSelect" class="modern-select" onchange="switchToState(this.value)">
                <option value="">ÈÄâÊã©Áä∂ÊÄÅ</option>
                <option value="1">Áä∂ÊÄÅ1 - Êñ∞ÊâãÊú™ÂÖ•Èáë</option>
                <option value="2">Áä∂ÊÄÅ2 - Êñ∞ÊâãÂ∑≤ÂÖ•Èáë</option>
                <option value="3">Áä∂ÊÄÅ3 - Êú¨ÊúüÊåëÊàòÁªìÊùü</option>
              </select>
            </div>

          </div>
        </div>

        <!-- Â∏ÆÂä©‰∏éÊîØÊåÅ -->
        <div class="settings-section">
          <h3>‚ùì Â∏ÆÂä©‰∏éÊîØÊåÅ</h3>
          <div class="settings-card">

            <div class="setting-item clickable" onclick="showBugReport()">
              <div class="setting-info">
                <span class="setting-title">üêõ BugÊä•Âëä</span>
                <span class="setting-desc">Êèê‰∫§BugÊä•ÂëäÂíåÈóÆÈ¢òÂèçÈ¶à</span>
              </div>
              <span class="arrow">‚Ä∫</span>
            </div>
            <div class="setting-item clickable" onclick="showAbout()">
              <div class="setting-info">
                <span class="setting-title">‚ÑπÔ∏è ÂÖ≥‰∫éÊàë‰ª¨</span>
                <span class="setting-desc">ÁâàÊú¨‰ø°ÊÅØÂíåÂºÄÂèëÂõ¢Èòü</span>
              </div>
              <span class="arrow">‚Ä∫</span>
            </div>
          </div>
        </div>

        <!-- Âç±Èô©Êìç‰ΩúÂå∫Âüü -->
        <div class="danger-zone">
          <div class="danger-card">
            <button class="danger-btn" onclick="confirmLogout()">
              üö™ ÈÄÄÂá∫ÁôªÂΩï
            </button>
          </div>
        </div>

        <!-- ËøîÂõûÊåâÈíÆ -->
        <div class="settings-footer">
          <button class="back-btn" onclick="closeSettings()">
            ‚Üê ËøîÂõû‰∏ªÈ°µ
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Ê∂àÊÅØÂºπÁ™ó -->
  <div id="messageModal" class="modal" style="display:none;">
    <div class="modal-content" style="max-width: 420px; width: 95%; max-height: 80vh; overflow: hidden;">
      <div class="message-header">
        <h3 class="message-title">üí¨ Ê∂àÊÅØ‰∏≠ÂøÉ</h3>
        <div class="header-actions">
          <button class="mark-all-read-btn-header" onclick="markAllAsRead()" title="Ê†áËÆ∞ÊâÄÊúâÊ∂àÊÅØ‰∏∫Â∑≤ËØª">
            ‚úì
          </button>
          <button class="modal-close" onclick="closeMessages()">‚úï</button>
        </div>
      </div>
      
      <!-- Ê†áÁ≠æÈ°µÂàáÊç¢ -->
      <div class="message-tabs">
        <button class="tab-btn active" onclick="switchMessageTab('official')" id="officialTab">
          üì¢ ÂÆòÊñπÂÖ¨Âëä
          <span class="unread-count" id="officialUnreadCount" style="display:none;">0</span>
        </button>
        <button class="tab-btn" onclick="switchMessageTab('team')" id="teamTab">
          üë• Âõ¢ÈòüÊ∂àÊÅØ
          <span class="unread-count" id="teamUnreadCount" style="display:none;">0</span>
        </button>
        <button class="tab-btn" onclick="switchMessageTab('bug')" id="bugTab">
          üêõ BugÊä•Âëä
        </button>
      </div>
      
      <!-- Ê∂àÊÅØÂàóË°®ÂÆπÂô® -->
      <div class="message-content">
        <!-- ÂÆòÊñπÂÖ¨ÂëäÂàóË°® -->
        <div id="officialMessages" class="message-list active">
          <div class="empty-message">
            <div class="empty-icon">üì≠</div>
            <div class="empty-text">ÊöÇÊó†ÂÆòÊñπÂÖ¨Âëä</div>
          </div>
        </div>
        
        <!-- Âõ¢ÈòüÊ∂àÊÅØÂàóË°® -->
        <div id="teamMessages" class="message-list">
          <div class="empty-message">
            <div class="empty-icon">üë•</div>
            <div class="empty-text">ÊöÇÊó†Âõ¢ÈòüÊ∂àÊÅØ</div>
          </div>
        </div>
        
        <!-- BugÊä•ÂëäÂàóË°® -->
        <div id="bugMessages" class="message-list">
          <div class="bug-report-form">
            <h4>üêõ Êèê‰∫§BugÊä•Âëä</h4>
            <form onsubmit="submitBugReport(event)">
              <div class="form-group">
                <label for="bugTitle">BugÊ†áÈ¢òÔºö</label>
                <input type="text" id="bugTitle" placeholder="ËØ∑ÁÆÄË¶ÅÊèèËø∞ÈÅáÂà∞ÁöÑÈóÆÈ¢ò" required>
              </div>
              <div class="form-group">
                <label for="bugDescription">ËØ¶ÁªÜÊèèËø∞Ôºö</label>
                <textarea id="bugDescription" rows="4" placeholder="ËØ∑ËØ¶ÁªÜÊèèËø∞ÈóÆÈ¢òÁöÑÂÖ∑‰ΩìÊÉÖÂÜµ„ÄÅÂ§çÁé∞Ê≠•È™§Á≠â" required></textarea>
              </div>
              <div class="form-group">
                <label for="bugType">ÈóÆÈ¢òÁ±ªÂûãÔºö</label>
                <select id="bugType" required>
                  <option value="">ËØ∑ÈÄâÊã©ÈóÆÈ¢òÁ±ªÂûã</option>
                  <option value="ÂäüËÉΩÂºÇÂ∏∏">ÂäüËÉΩÂºÇÂ∏∏</option>
                  <option value="ÁïåÈù¢ÊòæÁ§∫">ÁïåÈù¢ÊòæÁ§∫</option>
                  <option value="ÊÄßËÉΩÈóÆÈ¢ò">ÊÄßËÉΩÈóÆÈ¢ò</option>
                  <option value="ÂÖ∂‰ªñ">ÂÖ∂‰ªñ</option>
                </select>
              </div>
              <button type="submit" class="submit-bug-btn">üìù Êèê‰∫§Êä•Âëä</button>
            </form>
          </div>
          
          <div class="bug-list-section">
            <h4>üìã Â∑≤Êèê‰∫§ÁöÑBugÊä•Âëä</h4>
            <div id="bugReportList">
              <div class="empty-message">
                <div class="empty-icon">üêõ</div>
                <div class="empty-text">ÊöÇÊó†BugÊä•Âëä</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ËÆæÁΩÆÈù¢ÊùøÂäüËÉΩ - ÊèêÂâçÂÆö‰πâÁ°Æ‰øùonclickÂèØ‰ª•ÊâæÂà∞
    function openSettings() {
      console.log('openSettingsÂáΩÊï∞Ë¢´Ë∞ÉÁî®');
      const settingsModal = document.getElementById('settingsModal');
      console.log('settingsModalÂÖÉÁ¥†:', settingsModal);
      
      if (!settingsModal) {
        console.error('Êâæ‰∏çÂà∞settingsModalÂÖÉÁ¥†');
        alert('ËÆæÁΩÆÈù¢ÊùøÂÖÉÁ¥†Êú™ÊâæÂà∞ÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï');
        return;
      }
      
      settingsModal.style.display = 'flex';
      console.log('ËÆæÁΩÆÈù¢ÊùøÂ∑≤ÊòæÁ§∫');
      
      // Êõ¥Êñ∞‰∏™‰∫∫‰ø°ÊÅØÊòæÁ§∫
      updateSettingsInfo();
      
      // Âä†ËΩΩ‰øùÂ≠òÁöÑËÆæÁΩÆ
      loadSettingsFromStorage();
    }

    function closeSettings() {
      const settingsModal = document.getElementById('settingsModal');
      settingsModal.style.display = 'none';
    }

    function updateSettingsInfo() {
      const userEmail = localStorage.getItem('userEmail') || 'Êú™ÁôªÂΩï';
      const userInviteCode = localStorage.getItem('userInviteCode') || '-';
      const currentLanguage = localStorage.getItem('language') || 'zh-CN';
      
      document.getElementById('userEmailDisplay').textContent = userEmail;
      document.getElementById('userInviteCodeDisplay').textContent = userInviteCode;
      document.getElementById('languageSelect').value = currentLanguage;
    }

    /* Áä∂ÊÄÅÊï∞ÊçÆ‰∏éÈÄªËæëÂÆö‰πâ */
    // ‰ªé localStorage Âä†ËΩΩÂ∫îÁî®Áä∂ÊÄÅ
    const appState = JSON.parse(localStorage.getItem('appState') || '{}');
    
    const STATES = {
      1: {
        name: 'Áä∂ÊÄÅ1',
        subtitle: 'Êñ∞ÊâãÊú™ÂÖ•Èáë',
        card: function() {
          return `
            <div class="section reactivate-highlight">
              <div class="section-title">ÊøÄÊ¥ªË¥¶Âè∑</div>
              <div class="section-content" style="margin-bottom: 16px;">Á´ãÂç≥ÂÖ•Èáë100 USDTÔºåÂºÄÂêØ168Â∞èÊó∂ÊåëÊàòÊúüÔºåËß£ÈîÅ‰ªªÂä°Á≥ªÁªüÂíåÊî∂ÁõäÊú∫‰ºö„ÄÇ</div>
              <button class="reactivate-btn" onclick="activateAccount()">Á´ãÂç≥ÊøÄÊ¥ª 100 USDT</button>
            </div>
            <div class="section">
              <div class="section-title">Êî∂ÁõäÈ¢ÑËßà</div>
              <div class="section-content">Êü•ÁúãÂâç10ÂêçÊî∂ÁõäÊéíË°åÊ¶úÔºå‰∫ÜËß£ÊΩúÂú®Êî∂ÁõäÊú∫‰ºö„ÄÇ</div>
              <button onclick="showRanking()" style="margin-top: 12px; padding: 8px 16px; background: var(--btn-gradient); color: white; border: none; border-radius: 8px; font-size: 14px; cursor: pointer; width: 100%; font-weight: 500; box-shadow: 0 2px 6px var(--accent-shadow); transition: all 0.2s ease;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px var(--accent-shadow-hover)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 6px var(--accent-shadow)'">Êü•ÁúãÊéíË°åÊ¶ú</button>
            </div>
          `;
        },
        buttons: []
      },
      2: {
        name: 'Áä∂ÊÄÅ2',
        subtitle: '168Â∞èÊó∂ÂÄíËÆ°Êó∂‰∏≠',
        card: function() {
          // ÂΩìÂâçÊñ∞Êâã‰ªªÂä°ÔºöÂè™ÊòæÁ§∫Â∞öÊú™ÂÆåÊàêÁöÑÁ¨¨‰∏Ä‰∏™‰ªªÂä°
          const currentTask = newTasks.find(t => !t.done);
          let taskSection;
          if (currentTask) {
            taskSection = `
            <div class="section">
              <div class="section-title">ÂΩìÂâç‰ªªÂä°</div>
              <div class="section-content">${currentTask.title}</div>
            </div>
            `;
          } else {
            taskSection = `
            <div class="section">
              <div class="section-title">ÂΩìÂâç‰ªªÂä°</div>
              <div class="section-content">ÊâÄÊúâÊñ∞Êâã‰ªªÂä°Â∑≤ÂÆåÊàê</div>
            </div>
            `;
          }
          const completedTasks = newTasks.filter(t => t.done).length;
          
          // ÂèØÊé•ÁöÑ‰ªªÂä°Âå∫ÂüüÔºöÊòæÁ§∫ÊâÄÊúâÊú™ÂÆåÊàêÁöÑÊñ∞Êâã‰ªªÂä°
          const availableTasks = newTasks.filter(t => !t.done);
          let availableTasksSection = '';
          if (availableTasks.length > 0) {
            availableTasksSection = `
            <div class="section" style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; padding: 8px; margin-bottom: 8px; cursor: pointer;" onclick="window.location.href='tasks.html'">
              <div class="section-title" style="font-size: 14px; font-weight: bold; color: var(--accent-color); margin-bottom: 6px;">üìã ÂèØÊé•ÁöÑ‰ªªÂä°</div>
              <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">ÁÇπÂáªÊü•ÁúãËØ¶ÁªÜ‰ªªÂä°ÂàóË°®</div>
              <div style="display: flex; flex-direction: column; gap: 4px;">
                ${availableTasks.map(task => `
                  <div style="display: flex; justify-content: space-between; align-items: center; padding: 4px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                    <span style="font-size: 12px; color: var(--text);">${task.title}</span>
                    <span style="font-size: 10px; padding: 2px 6px; background: linear-gradient(45deg, #00eaff, #0088ff); color: #031e2e; border-radius: 8px;">ÂæÖÂÆåÊàê</span>
                  </div>
                `).join('')}
              </div>
            </div>
            `;
          }
          
          // Á≠îÈ¢ò‰ªªÂä°Âå∫ÂüüÔºöÂÆåÊàêËá≥Â∞ë‰∏Ä‰∏™Êñ∞Êâã‰ªªÂä°ÂêéÂá∫Áé∞Ôºå‰∏îÊú™ÂÆåÊàêÁ≠îÈ¢ò‰ªªÂä°
          const firstDone = newTasks[0] && newTasks[0].done;
          const quizCorrect = parseInt(localStorage.getItem('quizCorrect')) || 0;
          const quizCompleted = appState.quizCompleted || false;
          let quizSection = '';
          if (firstDone && !quizCompleted) {
            quizSection = `
            <div class="section" style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; padding: 8px; margin-bottom: 8px; box-shadow: var(--btn-glow); cursor: pointer;" onclick="window.location.href='quiz.html'">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <div style="font-size: 14px; font-weight: bold; color: var(--accent-color); margin-bottom: 2px;">üìù Á≠îÈ¢ò‰ªªÂä°</div>
                  <div style="font-size: 12px; color: var(--text-secondary);">Èôç‰ΩéÊèêÁé∞ÊâãÁª≠Ë¥π</div>
                </div>
                <div style="text-align: right;">
                  <div style="font-size: 12px; color: var(--text-secondary);">ËøõÂ∫¶</div>
                  <div style="font-weight: bold; color: var(--accent-color);">ËøõÂ∫¶: ${appState.quizCompleted ? 'Â∑≤ÂÆåÊàê' : 'ËøõË°å‰∏≠'}</div>
                </div>
              </div>
            </div>
            `;
          }
          
          // Â§ßÁ•û‰ªªÂä°Âå∫ÂüüÔºöÂÆåÊàêÊâÄÊúâÊñ∞Êâã‰ªªÂä°‰∏îÂÆåÊàêÁ≠îÈ¢ò‰ªªÂä°ÂêéÊòæÁ§∫
          const allNewTasksCompleted = newTasks.every(task => task.done);
          let masterTasksSection = '';
          if (allNewTasksCompleted && quizCompleted) {
            // Ëé∑ÂèñÂ§ßÁ•û‰ªªÂä°ÂÆåÊàêÁä∂ÊÄÅ
            const godTasksCompleted = parseInt(localStorage.getItem('godTasksCompleted')) || 0;
            const currentMasterTask = godTasks.find(task => !task.done);
            
            masterTasksSection = `
            <div class="section" style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; padding: 8px; margin-bottom: 8px; box-shadow: var(--btn-glow); cursor: pointer;" onclick="window.location.href='tasks.html?tab=master'">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <div style="font-size: 14px; font-weight: bold; color: var(--accent-color); margin-bottom: 2px;">üèÜ Â§ßÁ•û‰ªªÂä°</div>
                  <div style="font-size: 12px; color: var(--text-secondary);">${currentMasterTask ? currentMasterTask.title : 'ÊâÄÊúâÂ§ßÁ•û‰ªªÂä°Â∑≤ÂÆåÊàê'}</div>
                </div>
                <div style="text-align: right;">
                  <div style="font-size: 12px; color: var(--text-secondary);">ËøõÂ∫¶</div>
                  <div style="font-weight: bold; color: var(--accent-color);">${godTasksCompleted}/6</div>
                </div>
              </div>
            </div>
            `;
          }
          
          return `
            <!-- ‰ºòÂåñÂêéÁöÑÂÄíËÆ°Êó∂Âå∫Âüü -->
            <div class="section" style="margin-bottom: 16px;">
              <div class="countdown-container" style="
                background: linear-gradient(135deg, var(--bg-secondary) 0%, rgba(47, 128, 237, 0.1) 100%);
                border: 2px solid var(--accent-color);
                border-radius: 10px;
                padding: 6px 10px;
                position: relative;
                overflow: hidden;
                box-shadow: 0 8px 32px rgba(47, 128, 237, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.1);
                animation: countdownPulse 3s ease-in-out infinite;
              ">
                
                <!-- ÂÄíËÆ°Êó∂‰∏ª‰Ωì -->
                <div style="position: relative; z-index: 2;">
                  <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 4px;">
                    <div style="display: flex; align-items: center; gap: 4px;">
                      <div style="
                        width: 5px;
                        height: 5px;
                        background: var(--accent-color);
                        border-radius: 50%;
                        animation: blink 1.5s ease-in-out infinite;
                      "></div>
                      <span style="font-size: 11px; color: var(--accent-color); font-weight: 600;">‚ö° ÊåëÊàòÂÄíËÆ°Êó∂</span>
                    </div>
                    <div style="
                      background: rgba(47, 128, 237, 0.2);
                      padding: 1px 4px;
                      border-radius: 6px;
                      font-size: 9px;
                      color: var(--accent-color);
                      font-weight: 500;
                    ">168Â∞èÊó∂ÊåëÊàò</div>
                  </div>
                  
                  <!-- Êó∂Èó¥ÊòæÁ§∫Âå∫Âüü -->
                  <div class="time-area" style="display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 6px; margin-bottom: 2px;">
                    <!-- Êó∂Èó¥Êï∞Â≠ó -->
                    <div style="text-align: center;">
                      <div class="time-display" style="
                        font-size: 28px;
                        font-weight: 700;
                        color: var(--accent-color);
                        text-shadow: 0 0 20px rgba(47, 128, 237, 0.5);
                        font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
                        letter-spacing: 1px;
                        margin-bottom: 2px;
                      ">
                        <span id="countdown">--:--:--</span>
                      </div>
                    </div>
                    
                    <!-- Áõ¥Á∫øËøõÂ∫¶Êù° -->
                    <div style="width: 100%; margin-top: 4px;">
                      <div style="
                        width: 100%;
                        height: 4px;
                        background: rgba(47, 128, 237, 0.2);
                        border-radius: 2px;
                        overflow: hidden;
                        position: relative;
                      ">
                        <div 
                          id="countdownProgress" 
                          style="
                            height: 100%;
                            width: 100%;
                            background: var(--accent-color);
                            border-radius: 2px;
                            transition: width 1s ease-in-out;
                            box-shadow: 0 0 12px rgba(109, 213, 237, 0.6), 0 0 24px rgba(109, 213, 237, 0.3);
                            margin-left: auto;
                            position: relative;
                            overflow: hidden;
                          "
                        >
                          <div style="
                            position: absolute;
                            top: 0;
                            left: 0;
                            width: 30%;
                            height: 100%;
                            background: linear-gradient(90deg, transparent 0%, rgba(255, 255, 255, 0.3) 50%, transparent 100%);
                            animation: slideRight 3s linear infinite;
                          "></div>
                        </div>
                      </div>
                      <div style="
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        margin-top: 2px;
                        font-size: 10px;
                        color: var(--text-secondary);
                      ">
                        <span id="remainingDays" style="color: var(--accent-color); font-weight: 600;">Ââ©‰Ωô -- Â§©</span>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Áä∂ÊÄÅÊèêÁ§∫ -->
                  <div id="countdownStatus" style="
                    text-align: center;
                    font-size: 12px;
                    color: var(--text-secondary);
                    background: rgba(47, 128, 237, 0.1);
                    padding: 8px 12px;
                    border-radius: 12px;
                    border: 1px solid rgba(47, 128, 237, 0.2);
                    display: none;
                  ">
                  </div>
                </div>
              </div>
            </div>
            
            <!-- ÈÇÄËØ∑ÈìæÊé•Âå∫Âüü -->
            <div class="section invite-highlight" style="margin-bottom: 16px;">
              <div class="section-title">ÈÇÄËØ∑ÈìæÊé•</div>
              <div class="section-content">
                <!-- ‰∏ìÂ±ûÈÇÄËØ∑Á†ÅÂå∫Âüü -->
                <div style="margin-bottom: 12px; padding: 12px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 10px; box-shadow: 0 2px 8px var(--accent-shadow);">
                  <div style="font-size: 12px; color: var(--accent-color); margin-bottom: 8px; text-align: center; font-weight: 500;">üíé ÊàëÁöÑ‰∏ìÂ±ûÈÇÄËØ∑Á†Å</div>
                  <div style="display: flex; align-items: center; gap: 8px;">
                    <div style="flex: 1; font-weight: bold; color: var(--accent-color); font-size: 16px; text-align: center; padding: 10px; background: var(--input-bg); border-radius: 8px; border: 1px solid var(--border-color); box-shadow: inset 0 1px 3px var(--accent-shadow);" id="myInviteCode">--</div>
                    <button onclick="copyInviteCode()" style="padding: 10px 16px; background: var(--btn-gradient); color: white; border: none; border-radius: 8px; font-size: 11px; cursor: pointer; white-space: nowrap; font-weight: 600; box-shadow: 0 2px 6px var(--accent-shadow); transition: all 0.2s ease;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px var(--accent-shadow-hover)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 6px var(--accent-shadow)'">Â§çÂà∂Á†Å</button>
                  </div>
                </div>
                
                <!-- ÈÇÄËØ∑ÈìæÊé•Âå∫Âüü -->
                <div style="padding: 12px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 10px; box-shadow: 0 2px 8px var(--accent-shadow);">
                  <div style="font-size: 12px; color: var(--accent-color); margin-bottom: 8px; text-align: center; font-weight: 500;">üîó ÈÇÄËØ∑ÈìæÊé•</div>
                  <div class="invite-link-container" style="display: flex; gap: 8px;">
                    <input type="text" id="inviteLink" value="https://gold7.com/invite?code=--" readonly style="flex: 1; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--input-bg); font-size: 11px; color: var(--accent-color); box-shadow: inset 0 1px 3px var(--accent-shadow);">
                    <button onclick="copyInviteLink()" style="padding: 10px 16px; background: var(--btn-gradient); color: white; border: none; border-radius: 8px; font-size: 11px; cursor: pointer; white-space: nowrap; font-weight: 600; box-shadow: 0 2px 6px var(--accent-shadow); transition: all 0.2s ease;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px var(--accent-shadow-hover)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 6px var(--accent-shadow)'">Â§çÂà∂ÈìæÊé•</button>
                  </div>
                </div>
              </div>
            </div>
            
            ${availableTasksSection}
            ${quizSection}
            ${masterTasksSection}
            
            <!-- ÊàòÁª©Âç°Âå∫Âüü - ÁßªÂä®Âà∞ÊúÄ‰∏ãÊñπ -->
            <div class="section" style="margin-bottom: 16px;">
              <div style="
                background: var(--bg-secondary); 
                border-radius: 16px; 
                padding: 16px;
                border: 1px solid rgba(47, 128, 237, 0.1);
                box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
              ">
                <div style="
                  font-size: 14px; 
                  color: var(--accent-color); 
                  margin-bottom: 12px; 
                  text-align: center;
                  font-weight: 600;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  gap: 8px;
                ">
                  <span>üèÜ</span>
                  <span>ÊàëÁöÑÊàòÁª©</span>
                </div>
                <div class="grid-stats" style="
                   display: grid;
                   grid-template-columns: 1fr 1fr;
                   gap: 12px;
                   font-size: 12px;
                   line-height: 1.4;
                 ">
                   <!-- Êñ∞Êâã‰ªªÂä°Âç°Áâá - Â¢ûÂº∫Áâà -->
                   <div class="stat-item" style="
                     background: rgba(47, 128, 237, 0.05);
                     padding: 12px;
                     border-radius: 12px;
                     border: 1px solid rgba(47, 128, 237, 0.1);
                     position: relative;
                     transition: all 0.2s ease;
                   " onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 6px 20px rgba(47, 128, 237, 0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                     <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                       <div style="color: var(--text-secondary); font-size: 11px;">üìö Êñ∞Êâã‰ªªÂä°</div>
                       <div style="font-size: 10px; color: var(--accent-color); font-weight: 500;">
                         ${completedTasks === 3 ? '‚úÖ Â∑≤ÂÆåÊàê' : 'ËøõË°å‰∏≠'}
                       </div>
                     </div>
                     <div class="stat-value" style="color: var(--accent-color); font-weight: bold; font-size: 16px; margin-bottom: 4px;">
                       <span id="taskProgress">${completedTasks}</span>/3
                       <span style="font-size: 12px; color: var(--text-secondary); margin-left: 4px;">
                         (${Math.round(completedTasks/3*100)}%)
                       </span>
                     </div>
                     <div style="
                       width: 100%;
                       height: 4px;
                       background: rgba(47, 128, 237, 0.1);
                       border-radius: 2px;
                       overflow: hidden;
                       margin-bottom: 4px;
                     ">
                       <div style="
                         width: ${completedTasks/3*100}%;
                         height: 100%;
                         background: var(--accent-color);
                         border-radius: 2px;
                         transition: width 0.3s ease;
                       "></div>
                     </div>
                     <div style="font-size: 10px; color: var(--text-secondary);">
                       ${completedTasks < 3 ? `ËøòÈúÄÂÆåÊàê ${3-completedTasks} ‰∏™‰ªªÂä°` : 'üéâ ÂÖ®ÈÉ®ÂÆåÊàêÔºÅ'}
                     </div>
                   </div>
                   
                   <!-- Á≠îÈ¢òËøõÂ∫¶Âç°Áâá - Â¢ûÂº∫Áâà -->
                   <div class="stat-item" style="
                     background: rgba(47, 128, 237, 0.05);
                     padding: 12px;
                     border-radius: 12px;
                     border: 1px solid rgba(47, 128, 237, 0.1);
                     position: relative;
                     transition: all 0.2s ease;
                   " onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 6px 20px rgba(47, 128, 237, 0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                     <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                       <div style="color: var(--text-secondary); font-size: 11px;">üß† Á≠îÈ¢òËøõÂ∫¶</div>
                       <div style="font-size: 10px; color: var(--accent-color); font-weight: 500;">
                         ${quizCorrect >= 16 ? '‚úÖ ÈÄöËøá' : (completedTasks >= 1 ? 'ÂèØÁ≠îÈ¢ò' : 'üîí Êú™Ëß£ÈîÅ')}
                       </div>
                     </div>
                     <div class="stat-value" style="color: var(--accent-color); font-weight: bold; font-size: 16px; margin-bottom: 4px;">
                       ${quizCorrect}/20
                       <span style="font-size: 12px; color: var(--text-secondary); margin-left: 4px;">
                         (${Math.round(quizCorrect/20*100)}%)
                       </span>
                     </div>
                     <div style="
                       width: 100%;
                       height: 4px;
                       background: rgba(47, 128, 237, 0.1);
                       border-radius: 2px;
                       overflow: hidden;
                       margin-bottom: 4px;
                     ">
                       <div style="
                         width: ${quizCorrect/20*100}%;
                         height: 100%;
                         background: var(--accent-color);
                         border-radius: 2px;
                         transition: width 0.3s ease;
                       "></div>
                     </div>
                     <div style="font-size: 10px; color: var(--text-secondary);">
                       ${completedTasks < 1 ? 'ÈúÄÂÆåÊàêÊñ∞Êâã‰ªªÂä°1Ëß£ÈîÅ' : (quizCorrect < 16 ? `ÈúÄÁ≠îÂØπ ${16-quizCorrect} È¢òÈÄöËøá` : 'üéÅ ÈùûÂõ∫ÂÆöÂ∑≤ÊâãÁª≠Ë¥πÊ∞∏‰πÖÂ∑≤Èôç‰ΩéËá≥1%')}
                     </div>
                   </div>
                   
                   <!-- Âõ¢Èòü‰∫∫Êï∞Âç°Áâá - Â¢ûÂº∫Áâà -->
                   <div class="stat-item" style="
                     background: rgba(47, 128, 237, 0.05);
                     padding: 12px;
                     border-radius: 12px;
                     border: 1px solid rgba(47, 128, 237, 0.1);
                     position: relative;
                     transition: all 0.2s ease;
                   " onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 6px 20px rgba(47, 128, 237, 0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                     <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                       <div style="color: var(--text-secondary); font-size: 11px;">üë• Âõ¢ÈòüËßÑÊ®°</div>
                       <div style="font-size: 10px; color: var(--success-color); font-weight: 500;">
                         ${teamMembers > 0 ? '‚ÜóÔ∏è Â¢ûÈïø‰∏≠' : 'ÂæÖÂèëÂ±ï'}
                       </div>
                     </div>
                     <div class="stat-value" style="color: var(--accent-color); font-weight: bold; font-size: 16px; margin-bottom: 4px;">
                       <span id="teamCount">${teamMembers}</span>‰∫∫
                     </div>
                     <div style="font-size: 10px; color: var(--text-secondary); margin-bottom: 4px;">
                       ${teamMembers < 2 ? 'Ë∑ùÁ¶ªÂ§ßÁ•û‰ªªÂä°‰∏ÄËøòÈúÄ' + (2-teamMembers) + '‰∫∫' : 'Â∑≤ËææÊàêÂ§ßÁ•û‰ªªÂä°‰∏ÄÊù°‰ª∂ üéØ'}
                     </div>
                     <div style="font-size: 10px; color: var(--text-secondary);">
                       üí° ÈÇÄËØ∑Êõ¥Â§öÂ•ΩÂèãÂä†ÂÖ•Âõ¢Èòü
                     </div>
                   </div>
                   
                   <!-- ÊÄªÊî∂ÁõäÂç°Áâá - Â¢ûÂº∫Áâà -->
                   <div class="stat-item" style="
                     background: rgba(40, 167, 69, 0.1);
                     padding: 12px;
                     border-radius: 12px;
                     border: 1px solid rgba(40, 167, 69, 0.2);
                     position: relative;
                     transition: all 0.2s ease;
                   " onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 6px 20px rgba(40, 167, 69, 0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                     <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                       <div style="color: var(--text-secondary); font-size: 11px;">üí∞ ÊÄªÊî∂Áõä</div>
                       <div style="font-size: 10px; color: var(--success-color); font-weight: 500;">
                         ${totalEarnings > 0 ? 'üìà ÁõàÂà©‰∏≠' : 'ÂæÖÊøÄÊ¥ª'}
                       </div>
                     </div>
                     <div class="stat-value" style="color: var(--success-color); font-weight: bold; font-size: 16px; margin-bottom: 4px;">
                       <span id="totalEarnings">${totalEarnings.toFixed(2)}</span> USDT
                     </div>
                     <div style="font-size: 10px; color: var(--text-secondary); margin-bottom: 2px;">
                       Êî∂ÁõäÁéá: ${totalEarnings > 0 ? (totalEarnings/100*100).toFixed(1) + '%' : '0%'}
                       ${totalEarnings > 0 ? ' | Êó•Âùá: ' + (totalEarnings/7).toFixed(2) + ' USDT' : ''}
                     </div>
                     <div style="font-size: 10px; color: var(--text-secondary);">
                       ${totalEarnings === 0 ? 'üí° ÂÆåÊàê‰ªªÂä°ÂºÄÂßãËµöÂèñÊî∂Áõä' : 'üöÄ ÁªßÁª≠ÂÆåÊàê‰ªªÂä°ÊèêÂçáÊî∂Áõä'}
                     </div>
                   </div>
                 </div>
              </div>
            </div>
          `;
        },
        buttons: [
          { text: 'Âõ¢Èòü', color: 'orange', key: 'team', action: () => showTeam() },
          { text: 'Êä¢Á∫¢ÂåÖ', color: 'red', key: 'red', action: () => grabRedPacket() },
          { text: 'Èí±ÂåÖ', color: 'purple', key: 'wallet', action: () => showWallet() },
          { text: 'ÊéíË°åÊ¶ú', color: 'green', key: 'rank', action: () => showRanking() }
        ]
      },
      3: {
        name: 'Áä∂ÊÄÅ3',
        subtitle: 'ÂÄíËÆ°Êó∂ÁªìÊùüÊú™Â§çË¥≠',
        card: function() {
          const completedTasks = newTasks.filter(t => t.done).length;
          return `
            <div class="section reactivate-highlight">
              <div class="section-title">üî• ÂÜçÊ¨°ÊøÄÊ¥ª</div>
              <div class="section-content">
                <p style="margin-bottom: 12px;">ÈáçÊñ∞ÂºÄÂêØ168Â∞èÊó∂ÊåëÊàòÔºåÁªßÁª≠ËµöÂèñÊî∂ÁõäÔºÅ</p>
                <button class="reactivate-btn" onclick="repurchase()">Á´ãÂç≥ÊøÄÊ¥ª 100 USDT</button>
              </div>
            </div>
            <div class="section">
              <div class="section-title">ÊàòÁª©Âç°</div>
              <div class="section-content">Êú¨ÊúüÊî∂ÁõäÔºö<strong>${totalEarnings.toFixed(2)} USDT</strong><br/>Êñ∞Êâã‰ªªÂä°Ôºö${completedTasks}/3 ÂÆåÊàê<br/>Âõ¢Èòü‰∫∫Êï∞Ôºö${teamMembers}‰∫∫</div>
            </div>
            <div class="section">
              <div class="section-title">ÊàëÁöÑÂõ¢Èòü</div>
              <div class="section-content">Êü•Áúã‰∏ÉÂ±ÇÂõ¢ÈòüÁªìÊûÑÂíå‰∫∫Êï∞„ÄÇ</div>
            </div>
          `;
        },
        buttons: [
          { text: 'ÂÜçÊ¨°ÊøÄÊ¥ª', color: 'blue', key: 'reactivate', action: () => repurchase() },
          { text: 'Âõ¢Èòü', color: 'orange', key: 'team', action: () => showTeam() },
          { text: 'Èí±ÂåÖ', color: 'purple', key: 'wallet', action: () => showWallet() },
          { text: 'ÊéíË°åÊ¶ú', color: 'green', key: 'rank', action: () => showRanking() }
        ]
      }
    };

    /* ÊåâÈíÆÂàÜÁ±ªÁ≥ªÁªü */
    function getButtonCategory(buttonKey) {
      // ‰∏ªË¶ÅÂäüËÉΩÊåâÈíÆ
      const primaryButtons = ['activate', 'reactivate', 'invite', 'wallet', 'team'];
      // ÈáëËûçÁõ∏ÂÖ≥ÊåâÈíÆ
      const financialButtons = ['wallet', 'grab-red-packet'];
      // Ê∏∏ÊàèÂåñÊåâÈíÆ
      const gamificationButtons = ['tasks', 'god-tasks', 'leaderboard'];
      
      if (primaryButtons.includes(buttonKey)) {
        return 'btn-primary';
      } else if (financialButtons.includes(buttonKey)) {
        return 'btn-financial';
      } else if (gamificationButtons.includes(buttonKey)) {
        return 'btn-gamification';
      }
      return 'btn-default';
    }
    
    /* ‰ªªÂä°Êï∞ÊçÆ */
    const newTasks = [
      { id: 1, title: 'Áõ¥Êé•Êé®Ëçê1‰∫∫', desc: 'ÈÇÄËØ∑1‰ΩçÂ•ΩÂèãÊ≥®ÂÜåÂπ∂ÊøÄÊ¥ªË¥¶Âè∑', done: false, reward: 10 },
      { id: 2, title: 'Â∏ÆÂä©‰∏ãÁ∫ßÊé®Ëçê1‰∫∫', desc: 'ÊåáÂØº‰Ω†ÁöÑ‰∏ãÁ∫ßÊàêÂäüÈÇÄËØ∑1‰ΩçÊñ∞Áî®Êà∑', done: false, reward: 10 },
      { id: 3, title: 'Êïô‰∏ãÁ∫ßÂ¶Ç‰ΩïÊïô‰ªñÁöÑ‰∏ãÁ∫ßÊé®Ëçê1‰∫∫', desc: 'ÂüπËÆ≠‰∏ãÁ∫ßÁöÑÊé®ÂπøÊäÄÂ∑ßÔºåÂ∏ÆÂä©‰∏âÁ∫ßÊé®Âπø', done: false, reward: 10 }
    ];
    
    // Á≠îÈ¢ò‰ªªÂä°Êï∞ÊçÆ
    const quizTasks = [
      { id: 'quiz1', title: 'Âü∫Á°ÄÁü•ËØÜÁ≠îÈ¢ò', desc: 'ÂÆåÊàê20ÈÅìÂü∫Á°ÄÈ¢òÁõÆÔºåÊ≠£Á°ÆÁéáËææÂà∞80%', done: false, reward: 20, feeReduction: 0.02 }
    ];
    
    const godTasks = [
      { id: 1, title: 'Â§ßÁ•û‰ªªÂä°‰∏ÄÔºöÁõ¥Êé®2‰∫∫ √ó 2Â±Ç = 6‰∫∫', desc: 'Âª∫Á´ã2Â±ÇÂõ¢ÈòüÁªìÊûÑÔºåÊØèÂ±Ç2‰∫∫', done: false, reward: 50 },
      { id: 2, title: 'Â§ßÁ•û‰ªªÂä°‰∫åÔºöÁõ¥Êé®3‰∫∫ √ó 3Â±Ç = 39‰∫∫', desc: 'Âª∫Á´ã3Â±ÇÂõ¢ÈòüÁªìÊûÑÔºåÊØèÂ±Ç3‰∫∫', done: false, reward: 250 },
      { id: 3, title: 'Â§ßÁ•û‰ªªÂä°‰∏âÔºöÁõ¥Êé®4‰∫∫ √ó 4Â±Ç = 340‰∫∫', desc: 'Âª∫Á´ã4Â±ÇÂõ¢ÈòüÁªìÊûÑÔºåÊØèÂ±Ç4‰∫∫', done: false, reward: 1250 },
      { id: 4, title: 'Â§ßÁ•û‰ªªÂä°ÂõõÔºöÁõ¥Êé®5‰∫∫ √ó 5Â±Ç = 3905‰∫∫', desc: 'Âª∫Á´ã5Â±ÇÂõ¢ÈòüÁªìÊûÑÔºåÊØèÂ±Ç5‰∫∫', done: false, reward: 6250 },
      { id: 5, title: 'Â§ßÁ•û‰ªªÂä°‰∫îÔºöÁõ¥Êé®6‰∫∫ √ó 6Â±Ç = 55986‰∫∫', desc: 'Âª∫Á´ã6Â±ÇÂõ¢ÈòüÁªìÊûÑÔºåÊØèÂ±Ç6‰∫∫', done: false, reward: 31250 },
      { id: 6, title: 'Â§ßÁ•û‰ªªÂä°ÂÖ≠ÔºöÁõ¥Êé®7‰∫∫ √ó 7Â±Ç = 960799‰∫∫', desc: 'Âª∫Á´ã7Â±ÇÂõ¢ÈòüÁªìÊûÑÔºåÊØèÂ±Ç7‰∫∫', done: false, reward: 156250 }
    ];

    // ===== API Ë∞ÉÁî®Â∑•ÂÖ∑ÂáΩÊï∞ =====
    const API_BASE_URL = 'http://localhost:3000';
    
    // Ëé∑ÂèñËÆ§ËØÅtoken
    function getAuthToken() {
      // ‰ªélocalStorageËé∑ÂèñÁúüÂÆûÁöÑJWT token
      const token = localStorage.getItem('token') || localStorage.getItem('authToken');
      
      // Â¶ÇÊûúÊ≤°ÊúâÊúâÊïàtokenÔºå‰ΩøÁî®ÈªòËÆ§ÁöÑÊ®°Êãütoken
      if (!token || token === 'demo-token') {
        return 'mock-token-1';
      }
      
      return token;
    }
    
    // APIËØ∑Ê±ÇÂ∞ÅË£Ö
    async function apiRequest(endpoint, options = {}) {
      const token = getAuthToken();
      const url = `${API_BASE_URL}/api${endpoint}`;
      
      const config = {
        headers: {
          'Content-Type': 'application/json',
          ...(token && { 'Authorization': `Bearer ${token}` })
        },
        ...options
      };
      
      try {
        const response = await fetch(url, config);
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.message || `HTTP error! status: ${response.status}`);
        }
        
        return data;
      } catch (error) {
        console.error('APIËØ∑Ê±ÇÂ§±Ë¥•:', error);
        throw error;
      }
    }
    
    // Áä∂ÊÄÅÁÆ°ÁêÜAPIË∞ÉÁî®
    const StateAPI = {
      // Ëé∑ÂèñÁî®Êà∑Áä∂ÊÄÅ
      async getStatus() {
        return await apiRequest('/state/status');
      },
      
      // ÊøÄÊ¥ªË¥¶Âè∑
      async activate() {
        return await apiRequest('/state/activate', {
          method: 'POST'
        });
      },
      
      // Â§çË¥≠
      async repurchase() {
        return await apiRequest('/state/repurchase', {
          method: 'POST'
        });
      },
      
      // ÂêåÊ≠•Áä∂ÊÄÅ
      async syncState(localState) {
        return await apiRequest('/state/sync', {
          method: 'PUT',
          body: JSON.stringify(localState)
        });
      },
      
      // ÂàáÊç¢Áä∂ÊÄÅÔºàÂºÄÂèëÁî®Ôºâ
      async switchState(newState) {
        return await apiRequest('/state/switch', {
          method: 'POST',
          body: JSON.stringify({ state: newState })
        });
      }
    };

    /* ÂÖ®Â±ÄÁä∂ÊÄÅÂèòÈáè */
    let currentState = 1;
    let countdownStart = null; // ÂºÄÂêØÂÄíËÆ°Êó∂ÁöÑÊó∂Èó¥Êà≥
    let inviteStart = null;    // ÈÇÄËØ∑ÈìæÊé•ÁîüÊïàÊó∂Èó¥Êà≥
    let countdownTimer = null;

    // Ê®°ÊãüÁî®Êà∑Èí±ÂåÖ‰ΩôÈ¢ùÔºåÁî®‰∫éÁ∫¢ÂåÖÂíåÊèêÁé∞ÂäüËÉΩ
    let walletBalance = 0;

    // ‰∫§ÊòìËÆ∞ÂΩïÂàóË°®
    let transactions = [];

    // ÊèêÁé∞ÊâãÁª≠Ë¥πÊØî‰æãÔºåÈªòËÆ§‰∏∫ 5%Ôºà0.05ÔºâÔºåÂèØÈÄöËøáÁ≠îÈ¢ò‰ªªÂä°Èôç‰ΩéÔºåÊúÄ‰Ωé 1%Ôºà0.01Ôºâ
    let withdrawFeeRate = 0.05;

    // Êñ∞Â¢ûÁä∂ÊÄÅÁÆ°ÁêÜÂèòÈáè
    let userLevel = 0; // Áî®Êà∑Á≠âÁ∫ß 0:Êú™ÊøÄÊ¥ª 1:Â∑≤ÊøÄÊ¥ª
    let completedNewbieTasks = 0; // Â∑≤ÂÆåÊàêÊñ∞Êâã‰ªªÂä°Êï∞Èáè
    let quizCompleted = false; // Á≠îÈ¢ò‰ªªÂä°ÊòØÂê¶ÂÆåÊàê
    let godTasksUnlocked = false; // Â§ßÁ•û‰ªªÂä°ÊòØÂê¶Ëß£ÈîÅ
    let teamMembers = 0; // Âõ¢ÈòüÊàêÂëòÊï∞Èáè
    let totalEarnings = 0; // ÊÄªÊî∂Áõä

    /**
     * ‰ªé localStorage ÂàùÂßãÂåñÁä∂ÊÄÅÔºåÂåÖÊã¨‰ΩôÈ¢ù„ÄÅ‰ªªÂä°ÂÆåÊàêÁä∂ÊÄÅÂíå‰∫§ÊòìËÆ∞ÂΩï„ÄÇ
     */
    function loadState() {
      const savedState = localStorage.getItem('appState');
      if (savedState) {
        try {
          const state = JSON.parse(savedState);
          currentState = state.currentState || 1;
          countdownStart = state.countdownStart;
          inviteStart = state.inviteStart;
          walletBalance = state.walletBalance || 0;
          transactions = state.transactions || [];
          userLevel = state.userLevel || 0;
          completedNewbieTasks = state.completedNewbieTasks || 0;
          quizCompleted = state.quizCompleted || false;
          godTasksUnlocked = state.godTasksUnlocked || false;
          teamMembers = state.teamMembers || 0;
          totalEarnings = state.totalEarnings || 0;
          withdrawFeeRate = state.withdrawFeeRate || 0.05;
          
          // Ê£ÄÊü•quizÂÆåÊàêÁä∂ÊÄÅÔºåÁ°Æ‰øù‰∏équiz.htmlÁöÑÁä∂ÊÄÅÂêåÊ≠•
          const quizProgress = JSON.parse(localStorage.getItem('quizProgress') || '{}');
          if (quizProgress.correctCount >= 20) {
            quizCompleted = true;
            state.quizCompleted = true;
          }
          
          // ÂêåÊ≠•Âõ¢ÈòüÊî∂ÁõäÔºöÊÄªÊî∂Áõä = Âõ¢Èòü‰∫∫Êï∞ * 10
          const teamData = JSON.parse(localStorage.getItem('teamData') || '{}');
          if (teamData.totalMembers) {
            totalEarnings = teamData.totalMembers * 10;
            teamMembers = teamData.totalMembers;
          }
          
          // ÊÅ¢Â§ç‰ªªÂä°Áä∂ÊÄÅ
          if (state.newTasks) {
            state.newTasks.forEach((task, index) => {
              if (newTasks[index]) newTasks[index].done = task.done;
            });
            // ÂêåÊ≠•completedNewbieTasksÂèòÈáèÔºåÁ°Æ‰øù‰∏énewTasksÊï∞ÁªÑÁä∂ÊÄÅ‰∏ÄËá¥
            completedNewbieTasks = newTasks.filter(t => t.done).length;
          }
          if (state.quizTasks) {
            state.quizTasks.forEach((task, index) => {
              if (quizTasks[index]) quizTasks[index].done = task.done;
            });
          }
          if (state.godTasks) {
            state.godTasks.forEach((task, index) => {
              if (godTasks[index]) godTasks[index].done = task.done;
            });
          }
        } catch (e) {
          console.warn('Êó†Ê≥ïËß£Êûê appState', e);
        }
      }
    }

    /**
     * Â∞ÜÂΩìÂâçÁä∂ÊÄÅ‰øùÂ≠òÂà∞ localStorage„ÄÇ
     */
    function saveState() {
      // ÂêåÊ≠•Âõ¢ÈòüÊî∂ÁõäÔºöÊÄªÊî∂Áõä = Âõ¢Èòü‰∫∫Êï∞ * 10
      const teamData = JSON.parse(localStorage.getItem('teamData') || '{}');
      if (teamData.totalMembers) {
        totalEarnings = teamData.totalMembers * 10;
      }
      
      const state = {
        currentState,
        countdownStart,
        inviteStart,
        walletBalance,
        transactions,
        userLevel,
        completedNewbieTasks,
        quizCompleted,
        godTasksUnlocked,
        teamMembers,
        totalEarnings,
        withdrawFeeRate,
        newTasks: newTasks.map(t => ({ ...t })),
        quizTasks: quizTasks.map(t => ({ ...t })),
        godTasks: godTasks.map(t => ({ ...t }))
      };
      localStorage.setItem('appState', JSON.stringify(state));
    }

    // ‰∏éÂêéÁ´ØÂêåÊ≠•Áä∂ÊÄÅ
    async function syncWithBackend() {
      try {
        console.log('Ê≠£Âú®‰∏éÂêéÁ´ØÂêåÊ≠•Áä∂ÊÄÅ...');
        const response = await StateAPI.getStatus();
        
        if (response.success && response.data) {
          const backendState = response.data;
          
          // Êõ¥Êñ∞ÂâçÁ´ØÁä∂ÊÄÅ
          currentState = backendState.status;
          
          // Â¶ÇÊûúÂêéÁ´ØÊúâÂÄíËÆ°Êó∂‰ø°ÊÅØÔºåÂêåÊ≠•ÂÄíËÆ°Êó∂
          if (backendState.countdown_end_time) {
            const endTime = new Date(backendState.countdown_end_time);
            const now = new Date();
            if (endTime > now) {
              countdownStart = now.getTime();
              // ËÆ°ÁÆóÂÄíËÆ°Êó∂ÂºÄÂßãÊó∂Èó¥Ôºà168Â∞èÊó∂ÂâçÔºâ
              const startTime = new Date(endTime.getTime() - 168 * 60 * 60 * 1000);
              countdownStart = startTime.getTime();
            }
          }
          
          // ÂêåÊ≠•ÂÖ∂‰ªñÊï∞ÊçÆ
          if (backendState.balance !== undefined) {
            walletBalance = backendState.balance;
          }
          if (backendState.total_earnings !== undefined) {
            totalEarnings = backendState.total_earnings;
          }
          if (backendState.team_count !== undefined) {
            teamMembers = backendState.team_count;
          }
          
          console.log('ÂêéÁ´ØÁä∂ÊÄÅÂêåÊ≠•ÊàêÂäü:', backendState);
          
          // ‰øùÂ≠òÂêåÊ≠•ÂêéÁöÑÁä∂ÊÄÅ
          saveState();
          
          // ÈáçÊñ∞Ê∏≤ÊüìÈ°µÈù¢
          renderState();
        }
      } catch (error) {
        console.warn('ÂêéÁ´ØÁä∂ÊÄÅÂêåÊ≠•Â§±Ë¥•Ôºå‰ΩøÁî®Êú¨Âú∞Áä∂ÊÄÅ:', error.message);
        // ÁªßÁª≠‰ΩøÁî®Êú¨Âú∞Áä∂ÊÄÅÔºå‰∏çÂΩ±ÂìçÁî®Êà∑‰ΩìÈ™å
      }
    }

    // ÁîüÊàêÁî®Êà∑‰∏ìÂ±ûÈÇÄËØ∑Á†Å - ‰ªéÂêéÁ´ØAPIËé∑Âèñ
    async function generateUserInviteCode() {
      try {
        const response = await apiRequest('/user/invite-code');
        if (response.success && response.data.inviteCode) {
          return response.data.inviteCode;
        }
      } catch (error) {
        console.error('Ëé∑ÂèñÈÇÄËØ∑Á†ÅÂ§±Ë¥•:', error);
      }
      
      // Â¶ÇÊûúAPIË∞ÉÁî®Â§±Ë¥•Ôºå‰ΩøÁî®ÈÇÆÁÆ±ÁîüÊàêÂ§áÁî®ÈÇÄËØ∑Á†Å
      const userEmail = localStorage.getItem('userEmail');
      if (userEmail) {
        const emailPrefix = userEmail.split('@')[0].substring(0, 6).toUpperCase();
        return emailPrefix + Date.now().toString().slice(-6);
      }
      return 'USER' + Date.now().toString().slice(-6);
    }

    // ÈÄöÁü•Á≥ªÁªüÂ¢ûÂº∫
    let notifications = []; // ÈÄöÁü•ÂéÜÂè≤ËÆ∞ÂΩï
    let unreadNotifications = 0; // Êú™ËØªÈÄöÁü•Êï∞Èáè

    /**
     * Ê∑ªÂä†ÈÄöÁü•Âà∞ÂéÜÂè≤ËÆ∞ÂΩï
     * @param {string} type - ÈÄöÁü•Á±ªÂûã
     * @param {string} title - ÈÄöÁü•Ê†áÈ¢ò
     * @param {string} message - ÈÄöÁü•ÂÜÖÂÆπ
     * @param {Object} data - ÈôÑÂä†Êï∞ÊçÆ
     */
    function addNotification(type, title, message, data = {}) {
      const notification = {
        id: Date.now(),
        type,
        title,
        message,
        data,
        timestamp: new Date(),
        read: false
      };
      
      notifications.unshift(notification);
      unreadNotifications++;
      
      // ÈôêÂà∂ÈÄöÁü•ÂéÜÂè≤ËÆ∞ÂΩïÊï∞Èáè
      if (notifications.length > 50) {
        notifications = notifications.slice(0, 50);
      }
      
      // ‰øùÂ≠òÂà∞localStorage
      localStorage.setItem('notifications', JSON.stringify(notifications));
      localStorage.setItem('unreadNotifications', unreadNotifications.toString());
      
      // Êõ¥Êñ∞ÈÄöÁü•ÊåâÈíÆÊòæÁ§∫
      updateNotificationButton();
      
      // ÊòæÁ§∫ÊµÆÂä®ÈÄöÁü•
      showFloatingNotification(notification);
    }

    /**
     * ÊòæÁ§∫ÊµÆÂä®ÈÄöÁü•
     * @param {Object} notification - ÈÄöÁü•ÂØπË±°
     */
    function showFloatingNotification(notification) {
      // ÂàõÂª∫ÊµÆÂä®ÈÄöÁü•ÂÖÉÁ¥†
      const floatingNotification = document.createElement('div');
      floatingNotification.className = `floating-notification ${notification.type}`;
      floatingNotification.innerHTML = `
        <div class="notification-icon">
          ${getNotificationIcon(notification.type)}
        </div>
        <div class="notification-content">
          <div class="notification-title">${notification.title}</div>
          <div class="notification-message">${notification.message}</div>
        </div>
        <div class="notification-close" onclick="closeFloatingNotification(this)">√ó</div>
      `;
      
      // Ê∑ªÂä†Âà∞È°µÈù¢
      document.body.appendChild(floatingNotification);
      
      // Âä®ÁîªÊòæÁ§∫
      setTimeout(() => {
        floatingNotification.classList.add('show');
      }, 100);
      
      // Ëá™Âä®ÈöêËóè
      setTimeout(() => {
        closeFloatingNotification(floatingNotification);
      }, 5000);
      
      // ÁÇπÂáª‰∫ã‰ª∂
      floatingNotification.addEventListener('click', () => {
        handleNotificationClick(notification);
        closeFloatingNotification(floatingNotification);
      });
    }

    /**
     * ÂÖ≥Èó≠ÊµÆÂä®ÈÄöÁü•
     * @param {Element} element - ÈÄöÁü•ÂÖÉÁ¥†ÊàñÂÖ≥Èó≠ÊåâÈíÆ
     */
    function closeFloatingNotification(element) {
      const notification = element.classList.contains('floating-notification') ? element : element.closest('.floating-notification');
      if (notification) {
        notification.classList.remove('show');
        setTimeout(() => {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 300);
      }
    }

    /**
     * Ëé∑ÂèñÈÄöÁü•ÂõæÊ†á
     * @param {string} type - ÈÄöÁü•Á±ªÂûã
     * @returns {string} ÂõæÊ†áHTML
     */
    function getNotificationIcon(type) {
      const icons = {
        'redpacket_notification': 'üßß',
        'balance_update': 'üí∞',
        'task_reminder': 'üìã',
        'task_complete': '‚úÖ',
        'system_notification': 'üîî',
        'team_update': 'üë•',
        'level_up': 'üéâ',
        'withdrawal_status': 'üí≥',
        'deposit_confirmed': 'üíé'
      };
      return icons[type] || 'üîî';
    }

    /**
     * Â§ÑÁêÜÈÄöÁü•ÁÇπÂáª‰∫ã‰ª∂
     * @param {Object} notification - ÈÄöÁü•ÂØπË±°
     */
    function handleNotificationClick(notification) {
      switch (notification.type) {
        case 'redpacket_notification':
          grabRedPacket();
          break;
        case 'task_reminder':
        case 'task_complete':
          showTasks();
          break;
        case 'balance_update':
        case 'withdrawal_status':
        case 'deposit_confirmed':
          showWallet();
          break;
        case 'team_update':
          showTeam();
          break;
        default:
          // ÈªòËÆ§Ë°å‰∏∫ÔºöÊ†áËÆ∞‰∏∫Â∑≤ËØª
          markNotificationAsRead(notification.id);
      }
    }

    /**
     * Ê†áËÆ∞ÈÄöÁü•‰∏∫Â∑≤ËØª
     * @param {number} notificationId - ÈÄöÁü•ID
     */
    function markNotificationAsRead(notificationId) {
      const notification = notifications.find(n => n.id === notificationId);
      if (notification && !notification.read) {
        notification.read = true;
        unreadNotifications = Math.max(0, unreadNotifications - 1);
        
        // ‰øùÂ≠òÂà∞localStorage
        localStorage.setItem('notifications', JSON.stringify(notifications));
        localStorage.setItem('unreadNotifications', unreadNotifications.toString());
        
        // Êõ¥Êñ∞ÈÄöÁü•ÊåâÈíÆÊòæÁ§∫
        updateNotificationButton();
      }
    }

    /**
     * Êõ¥Êñ∞ÈÄöÁü•ÊåâÈíÆÊòæÁ§∫
     */
    function updateNotificationButton() {
      const notificationButton = document.querySelector('.notification-button');
      if (notificationButton) {
        const badge = notificationButton.querySelector('.notification-badge');
        if (unreadNotifications > 0) {
          if (!badge) {
            const newBadge = document.createElement('span');
            newBadge.className = 'notification-badge';
            notificationButton.appendChild(newBadge);
          }
          notificationButton.querySelector('.notification-badge').textContent = unreadNotifications > 99 ? '99+' : unreadNotifications;
          notificationButton.classList.add('has-unread');
        } else {
          if (badge) {
            badge.remove();
          }
          notificationButton.classList.remove('has-unread');
        }
      }
    }

    /**
     * ÊòæÁ§∫ÈÄöÁü•‰∏≠ÂøÉ
     */
    function showNotificationCenter() {
      // Ê†áËÆ∞ÊâÄÊúâÈÄöÁü•‰∏∫Â∑≤ËØª
      notifications.forEach(n => n.read = true);
      unreadNotifications = 0;
      localStorage.setItem('notifications', JSON.stringify(notifications));
      localStorage.setItem('unreadNotifications', '0');
      updateNotificationButton();
      
      // ÊûÑÂª∫ÈÄöÁü•ÂàóË°®HTML
      const notificationListHTML = notifications.length > 0 ? 
        notifications.map(notification => `
          <div class="notification-item ${notification.type}">
            <div class="notification-icon">${getNotificationIcon(notification.type)}</div>
            <div class="notification-content">
              <div class="notification-title">${notification.title}</div>
              <div class="notification-message">${notification.message}</div>
              <div class="notification-time">${formatNotificationTime(notification.timestamp)}</div>
            </div>
          </div>
        `).join('') :
        '<div class="no-notifications">ÊöÇÊó†ÈÄöÁü•</div>';
      
      showDialog(
        'ÈÄöÁü•‰∏≠ÂøÉ',
        `<div class="notification-center">${notificationListHTML}</div>`,
        [
          { text: 'Ê∏ÖÁ©∫ÈÄöÁü•', action: () => clearAllNotifications() },
          { text: 'ÂÖ≥Èó≠', action: 'close' }
        ],
        'notification'
      );
    }

    /**
     * Ê∏ÖÁ©∫ÊâÄÊúâÈÄöÁü•
     */
    function clearAllNotifications() {
      notifications = [];
      unreadNotifications = 0;
      localStorage.removeItem('notifications');
      localStorage.removeItem('unreadNotifications');
      updateNotificationButton();
      
      showDialog(
        'ÈÄöÁü•‰∏≠ÂøÉ',
        '<div class="notification-center"><div class="no-notifications">ÊöÇÊó†ÈÄöÁü•</div></div>',
        [{ text: 'ÂÖ≥Èó≠', action: 'close' }],
        'notification'
      );
    }

    /**
     * Ê†ºÂºèÂåñÈÄöÁü•Êó∂Èó¥
     * @param {Date} timestamp - Êó∂Èó¥Êà≥
     * @returns {string} Ê†ºÂºèÂåñÁöÑÊó∂Èó¥Â≠óÁ¨¶‰∏≤
     */
    function formatNotificationTime(timestamp) {
      const now = new Date();
      const diff = now - new Date(timestamp);
      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(diff / 3600000);
      const days = Math.floor(diff / 86400000);
      
      if (minutes < 1) return 'ÂàöÂàö';
      if (minutes < 60) return `${minutes}ÂàÜÈíüÂâç`;
      if (hours < 24) return `${hours}Â∞èÊó∂Ââç`;
      if (days < 7) return `${days}Â§©Ââç`;
      
      return new Date(timestamp).toLocaleDateString();
    }

    /**
     * Âä†ËΩΩÈÄöÁü•ÂéÜÂè≤ËÆ∞ÂΩï
     */
    function loadNotifications() {
      const savedNotifications = localStorage.getItem('notifications');
      const savedUnreadCount = localStorage.getItem('unreadNotifications');
      
      if (savedNotifications) {
        try {
          notifications = JSON.parse(savedNotifications);
          unreadNotifications = parseInt(savedUnreadCount) || 0;
        } catch (e) {
          console.warn('Êó†Ê≥ïËß£ÊûêÈÄöÁü•ÂéÜÂè≤ËÆ∞ÂΩï', e);
          notifications = [];
          unreadNotifications = 0;
        }
      }
      
      updateNotificationButton();
    }

    // WebSocketËøûÊé•ÂíåÂÆûÊó∂ÈÄöÁü•ÂäüËÉΩ
    let websocket = null;
    
    function initWebSocket() {
      // Ëé∑ÂèñJWT token
      const token = getAuthToken();
      if (!token) {
        console.log('Êú™ÊâæÂà∞tokenÔºåË∑≥ËøáWebSocketËøûÊé•');
        return;
      }
      
      // ËøûÊé•WebSocketÊúçÂä°Âô®Ôºà‰ΩøÁî®Ê≠£Á°ÆÁöÑË∑ØÂæÑÂíåtokenÔºâ
      websocket = new WebSocket(`ws://localhost:3000/ws?token=${encodeURIComponent(token)}`);
      
      websocket.onopen = function(event) {
        console.log('WebSocketËøûÊé•Â∑≤Âª∫Á´ã');
      };
      
      websocket.onmessage = function(event) {
        try {
          const data = JSON.parse(event.data);
          handleWebSocketMessage(data);
        } catch (error) {
          console.error('Ëß£ÊûêWebSocketÊ∂àÊÅØÂ§±Ë¥•:', error);
        }
      };
      
      websocket.onclose = function(event) {
        console.log('WebSocketËøûÊé•Â∑≤ÂÖ≥Èó≠');
        // 5ÁßíÂêéÂ∞ùËØïÈáçËøû
        setTimeout(initWebSocket, 5000);
      };
      
      websocket.onerror = function(error) {
        console.error('WebSocketÈîôËØØ:', error);
      };
    }
    
    function handleWebSocketMessage(data) {
      switch (data.type) {
        case 'redpacket_notification':
          // Á∫¢ÂåÖÈÄöÁü•
          addNotification(
            'redpacket_notification',
            'Á∫¢ÂåÖÊèêÈÜí',
            'Êñ∞ÁöÑÁ∫¢ÂåÖÊ¥ªÂä®ÂºÄÂßã‰∫ÜÔºÅÂø´ÂéªÊä¢Á∫¢ÂåÖÂêßÔºÅ',
            data
          );
          showDialog(
            'Á∫¢ÂåÖÊèêÈÜí',
            `Êñ∞ÁöÑÁ∫¢ÂåÖÊ¥ªÂä®ÂºÄÂßã‰∫ÜÔºÅÂø´ÂéªÊä¢Á∫¢ÂåÖÂêßÔºÅ`,
            [{ text: 'Á´ãÂç≥Êä¢Á∫¢ÂåÖ', action: 'grabRedPacket' }, { text: 'Á®çÂêéÂÜçËØ¥', action: 'close' }],
            'redpacket'
          );
          break;
          
        case 'balance_update':
          // ‰ΩôÈ¢ùÊõ¥Êñ∞ÈÄöÁü•
          addNotification(
            'balance_update',
            '‰ΩôÈ¢ùÂèòÂåñ',
            `${data.reason || '‰ΩôÈ¢ùÊõ¥Êñ∞'}: ${data.newBalance} USDT`,
            data
          );
          updateWalletBalance(data.newBalance, data.reason);
          break;
          
        case 'task_reminder':
          // ‰ªªÂä°ÊèêÈÜí
          addNotification(
            'task_reminder',
            '‰ªªÂä°ÊèêÈÜí',
            data.message,
            data
          );
          showDialog(
            '‰ªªÂä°ÊèêÈÜí',
            data.message,
            [{ text: 'Êü•Áúã‰ªªÂä°', action: 'showTasks' }, { text: 'Á®çÂêéÂÜçËØ¥', action: 'close' }],
            'success'
          );
          break;
          
        case 'task_complete':
          // ‰ªªÂä°ÂÆåÊàêÈÄöÁü•
          addNotification(
            'task_complete',
            '‰ªªÂä°ÂÆåÊàê',
            data.message || 'ÊÅ≠ÂñúÊÇ®ÂÆåÊàê‰∫Ü‰∏Ä‰∏™‰ªªÂä°ÔºÅ',
            data
          );
          // Êí≠ÊîæÊàêÂäüÈü≥Êïà
          playSound('success');
          break;
          
        case 'team_update':
          // Âõ¢ÈòüÊõ¥Êñ∞ÈÄöÁü•
          addNotification(
            'team_update',
            'Âõ¢ÈòüÊõ¥Êñ∞',
            data.message || 'ÊÇ®ÁöÑÂõ¢ÈòüÊúâÊñ∞ÁöÑÂèòÂåñ',
            data
          );
          break;
          
        case 'level_up':
          // Á≠âÁ∫ßÊèêÂçáÈÄöÁü•
          addNotification(
            'level_up',
            'Á≠âÁ∫ßÊèêÂçá',
            data.message || 'ÊÅ≠ÂñúÊÇ®ÁöÑÁ≠âÁ∫ßÊèêÂçá‰∫ÜÔºÅ',
            data
          );
          showDialog(
            'üéâ Á≠âÁ∫ßÊèêÂçá',
            data.message || 'ÊÅ≠ÂñúÊÇ®ÁöÑÁ≠âÁ∫ßÊèêÂçá‰∫ÜÔºÅ',
            [{ text: 'Â§™Ê£í‰∫ÜÔºÅ', action: 'close' }],
            'success'
          );
          break;
          
        case 'withdrawal_status':
          // ÊèêÁé∞Áä∂ÊÄÅÊõ¥Êñ∞
          addNotification(
            'withdrawal_status',
            'ÊèêÁé∞Áä∂ÊÄÅÊõ¥Êñ∞',
            data.message || 'ÊÇ®ÁöÑÊèêÁé∞Áä∂ÊÄÅÂ∑≤Êõ¥Êñ∞',
            data
          );
          break;
          
        case 'deposit_confirmed':
          // ÂÖ•ÈáëÁ°ÆËÆ§
          addNotification(
            'deposit_confirmed',
            'ÂÖ•ÈáëÁ°ÆËÆ§',
            data.message || 'ÊÇ®ÁöÑÂÖ•ÈáëÂ∑≤Á°ÆËÆ§',
            data
          );
          break;
          
        case 'system_notification':
          // Á≥ªÁªüÈÄöÁü•
          addNotification(
            'system_notification',
            'Á≥ªÁªüÈÄöÁü•',
            data.message,
            data
          );
          showDialog(
            'Á≥ªÁªüÈÄöÁü•',
            data.message,
            [{ text: 'Á°ÆÂÆö', action: 'close' }],
            'success'
          );
          break;
          
        default:
          console.log('Êú™Áü•ÁöÑWebSocketÊ∂àÊÅØÁ±ªÂûã:', data.type);
      }
    }
    
    // Êõ¥Êñ∞Èí±ÂåÖ‰ΩôÈ¢ùÂáΩÊï∞
    function updateWalletBalance(newBalance, reason = '') {
      const oldBalance = walletBalance;
      walletBalance = newBalance;
      
      // ‰øùÂ≠òÂà∞localStorage
      localStorage.setItem('walletBalance', walletBalance.toString());
      
      // ÈáçÊñ∞Ê∏≤ÊüìÈ°µÈù¢‰ª•Êõ¥Êñ∞ÊòæÁ§∫
      renderState();
      
      // ÊòæÁ§∫‰ΩôÈ¢ùÂèòÂåñÈÄöÁü•
      if (reason) {
        const changeAmount = newBalance - oldBalance;
        const changeText = changeAmount > 0 ? `+${changeAmount}` : changeAmount.toString();
        showDialog(
          '‰ΩôÈ¢ùÂèòÂåñ',
          `${reason}\n‰ΩôÈ¢ùÂèòÂåñ: ${changeText}ÂÖÉ\nÂΩìÂâç‰ΩôÈ¢ù: ${newBalance}ÂÖÉ`,
          [{ text: 'Á°ÆÂÆö', action: 'close' }],
          'success'
        );
      }
    }
    
    // ÊòæÁ§∫‰ªªÂä°È°µÈù¢ÂáΩÊï∞
    function showTasks() {
      if (currentState === 1) {
        showDialog('‰ªªÂä°Á≥ªÁªü', 'ËØ∑ÂÖàÊøÄÊ¥ªË¥¶Âè∑ÂêéÊü•Áúã‰ªªÂä°', [{ text: 'Áü•ÈÅì‰∫Ü', action: 'close' }]);
        return;
      }

      // Ëé∑Âèñ‰ªªÂä°Êï∞ÊçÆ
      const taskData = getTaskData();
      
      // ÊûÑÂª∫‰ªªÂä°ÂàóË°®HTML
      let taskListHTML = `
        <div class="task-overview">
          <div class="task-stats">
            <div class="stat-item">
              <span class="stat-label">Êñ∞Êâã‰ªªÂä°</span>
              <span class="stat-value">${taskData.completedNewbieTasks}/4</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Á≠îÈ¢ò‰ªªÂä°</span>
              <span class="stat-value">${taskData.quizCompleted ? 'Â∑≤ÂÆåÊàê' : 'Êú™ÂÆåÊàê'}</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Â§ßÁ•û‰ªªÂä°</span>
              <span class="stat-value">${taskData.godTasksCompleted}/6</span>
            </div>
          </div>
        </div>
        
        <div class="task-sections">
          <div class="task-section">
            <h4>üéØ Êñ∞Êâã‰ªªÂä° (${taskData.completedNewbieTasks}/4)</h4>
            <div class="task-list">
              ${taskData.newbieTasks.map(task => `
                <div class="task-item ${task.done ? 'completed' : (task.id === taskData.completedNewbieTasks + 1 ? 'current' : 'locked')}">
                  <div class="task-info">
                    <span class="task-title">${task.title}</span>
                    <span class="task-reward">+${task.reward} USDT</span>
                  </div>
                  <div class="task-status">
                    ${task.done ? '‚úÖ Â∑≤ÂÆåÊàê' : (task.id === taskData.completedNewbieTasks + 1 ? 'üîÑ ËøõË°å‰∏≠' : 'üîí Êú™ÂºÄÂßã')}
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
          
          <div class="task-section">
            <h4>üìù Á≠îÈ¢ò‰ªªÂä° ${taskData.completedNewbieTasks >= 1 ? '' : '(ÈúÄÂÆåÊàêÊñ∞Êâã‰ªªÂä°1)'}</h4>
            <div class="task-list">
              <div class="task-item ${taskData.quizCompleted ? 'completed' : (taskData.completedNewbieTasks >= 1 ? 'available' : 'locked')}">
                <div class="task-info">
                  <span class="task-title">ÂÆåÊàê20ÈÅìÈ¢òÁõÆ (Ê≠£Á°ÆÁéá‚â•80%)</span>
                  <span class="task-reward">Èôç‰ΩéÊèêÁé∞ÊâãÁª≠Ë¥π</span>
                </div>
                <div class="task-status">
                  ${taskData.quizCompleted ? '‚úÖ Â∑≤ÂÆåÊàê' : (taskData.completedNewbieTasks >= 1 ? 'üìù ÂèØÁ≠îÈ¢ò' : 'üîí Êú™Ëß£ÈîÅ')}
                </div>
              </div>
            </div>
          </div>
          
          <div class="task-section">
            <h4>üèÜ Â§ßÁ•û‰ªªÂä° ${taskData.godTasksUnlocked ? `(${taskData.godTasksCompleted}/6)` : '(ÈúÄÂÆåÊàêÊâÄÊúâÊñ∞Êâã‰ªªÂä°+Á≠îÈ¢ò‰ªªÂä°)'}</h4>
            <div class="task-list">
              ${taskData.godTasks.map(task => `
                <div class="task-item ${task.done ? 'completed' : (taskData.godTasksUnlocked ? 'available' : 'locked')}">
                  <div class="task-info">
                    <span class="task-title">${task.title}</span>
                    <span class="task-reward">+${task.reward} USDT</span>
                  </div>
                  <div class="task-status">
                    ${task.done ? '‚úÖ Â∑≤ÂÆåÊàê' : (taskData.godTasksUnlocked ? 'üéØ ÂèØÂÆåÊàê' : 'üîí Êú™Ëß£ÈîÅ')}
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        </div>
      `;

      // ÊûÑÂª∫ÊåâÈíÆ
      let buttons = [];
      
      // Â¶ÇÊûúÊúâÂèØÊâßË°åÁöÑÊñ∞Êâã‰ªªÂä°
      const nextNewbieTask = taskData.newbieTasks.find(t => !t.done && t.id === taskData.completedNewbieTasks + 1);
      if (nextNewbieTask) {
        buttons.push({ text: 'ÊâßË°åÂΩìÂâç‰ªªÂä°', action: () => executeTask('newbie', nextNewbieTask.id) });
      }
      
      // Â¶ÇÊûúÁ≠îÈ¢ò‰ªªÂä°ÂèØÁî®‰∏îÊú™ÂÆåÊàê
      if (taskData.completedNewbieTasks >= 1 && !taskData.quizCompleted) {
        buttons.push({ text: 'ÂºÄÂßãÁ≠îÈ¢ò', action: () => startQuiz() });
      }
      
      // Â¶ÇÊûúÂ§ßÁ•û‰ªªÂä°Â∑≤Ëß£ÈîÅ
      if (taskData.godTasksUnlocked) {
        const nextGodTask = taskData.godTasks.find(t => !t.done);
        if (nextGodTask) {
          buttons.push({ text: 'Êü•ÁúãÂ§ßÁ•û‰ªªÂä°', action: () => executeTask('god', nextGodTask.id) });
        }
      }
      
      buttons.push({ text: 'ÂÖ≥Èó≠', action: 'close' });

      // ÊòæÁ§∫‰ªªÂä°ÂØπËØùÊ°Ü
      showDialog('‰ªªÂä°‰∏≠ÂøÉ', '', buttons, 'normal', null, taskListHTML);
    }

    /**
     * Ëé∑Âèñ‰ªªÂä°Êï∞ÊçÆ
     */
    function getTaskData() {
      // ËÆ°ÁÆóÂÆåÊàêÁöÑÊñ∞Êâã‰ªªÂä°Êï∞Èáè
      const completedNewbieTasks = newTasks.filter(task => task.done).length;
      
      // Ê£ÄÊü•Á≠îÈ¢ò‰ªªÂä°ÊòØÂê¶ÂÆåÊàê
      const quizCompleted = appState.quizCompleted || false;
      
      // Ê£ÄÊü•Â§ßÁ•û‰ªªÂä°ÊòØÂê¶Ëß£ÈîÅÔºàÈúÄË¶ÅÂÆåÊàêÊâÄÊúâÊñ∞Êâã‰ªªÂä°ÂíåÁ≠îÈ¢ò‰ªªÂä°Ôºâ
      const godTasksUnlocked = completedNewbieTasks >= 3 && quizCompleted;
      
      // ËÆ°ÁÆóÂÆåÊàêÁöÑÂ§ßÁ•û‰ªªÂä°Êï∞Èáè
      const godTasksCompleted = godTasks.filter(task => task.done).length;

      return {
        newbieTasks: newTasks,
        godTasks,
        completedNewbieTasks,
        quizCompleted,
        godTasksUnlocked,
        godTasksCompleted
      };
    }

    /**
     * ÊâßË°å‰ªªÂä°
     */
    function executeTask(taskType, taskId) {
      if (taskType === 'newbie') {
        openTasks();
      } else if (taskType === 'god') {
        openGodTasks();
      }
    }

    /**
     * ÂºÄÂßãÁ≠îÈ¢ò‰ªªÂä°
     */
    function startQuiz() {
      // Ê£ÄÊü•ÊòØÂê¶Â∑≤Ëß£ÈîÅÁ≠îÈ¢ò‰ªªÂä°
      const completedNewbieTasks = newTasks.filter(task => task.done).length;
      if (completedNewbieTasks < 1) {
        showDialog('Á≠îÈ¢ò‰ªªÂä°Êú™Ëß£ÈîÅ', 'ËØ∑ÂÖàÂÆåÊàêËá≥Â∞ë‰∏Ä‰∏™Êñ∞Êâã‰ªªÂä°ÂêéÂÜçÂºÄÂßãÁ≠îÈ¢ò„ÄÇ');
        return;
      }

      // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÂÆåÊàêÁ≠îÈ¢ò‰ªªÂä°
      const quizCorrect = parseInt(localStorage.getItem('quizCorrect')) || 0;
      if (quizCorrect >= 20) {
        showDialog('Á≠îÈ¢ò‰ªªÂä°Â∑≤ÂÆåÊàê', `ÊÇ®Â∑≤ÂÆåÊàêÁ≠îÈ¢ò‰ªªÂä°ÔºåÊ≠£Á°ÆÁéáÔºö${quizCorrect}/20\nÂΩìÂâçÊèêÁé∞ÊâãÁª≠Ë¥πÔºö${(parseFloat(localStorage.getItem('withdrawFeeRate') || '0.05') * 100).toFixed(1)}%`);
        return;
      }

      // ‰øùÂ≠òÂΩìÂâçÁä∂ÊÄÅÂà∞localStorage
      saveState();
      
      // Ë∑≥ËΩ¨Âà∞Á≠îÈ¢òÈ°µÈù¢
      window.location.href = 'quiz.html';
    }

    /**
     * ÈöêËóèÂä†ËΩΩÂ±èÂπïÂπ∂ÊòæÁ§∫‰∏ªÂ∫îÁî®
     * @param {number} minDisplayTime - ÊúÄÂ∞èÊòæÁ§∫Êó∂Èó¥ÔºàÊØ´ÁßíÔºâÔºåÈªòËÆ§1500ms
     */
    function hideLoadingScreen(minDisplayTime = 1500) {
      const loadingScreen = document.getElementById('loadingScreen');
      const app = document.getElementById('app');
      
      // ËÆ∞ÂΩïÈ°µÈù¢Âä†ËΩΩÂºÄÂßãÊó∂Èó¥
      const loadStartTime = window.loadStartTime || Date.now();
      const elapsedTime = Date.now() - loadStartTime;
      const remainingTime = Math.max(0, minDisplayTime - elapsedTime);
      
      setTimeout(() => {
        // Ê∑ªÂä†Ê∑°Âá∫Âä®Áîª
        loadingScreen.classList.add('hidden');
        
        // ÊòæÁ§∫‰∏ªÂ∫îÁî®
        app.classList.remove('loading');
        
        // 300msÂêéÂÆåÂÖ®ÁßªÈô§Âä†ËΩΩÂ±èÂπï
        setTimeout(() => {
          loadingScreen.style.display = 'none';
        }, 300);
      }, remainingTime);
    }

    async function init() {
      // ‰ªé localStorage Âä†ËΩΩÂéÜÂè≤Áä∂ÊÄÅ
      loadState();
      
      // Ê£ÄÊü•Áî®Êà∑ÊòØÂê¶Â∑≤ÁôªÂΩï
      const isActivated = localStorage.getItem('isActivated') === 'true';
      const userToken = localStorage.getItem('userToken');
      
      if (!isActivated || !userToken) {
        // Êú™ÊøÄÊ¥ªÊàñÊó†tokenÔºåÁõ¥Êé•Ë∑≥ËΩ¨Âà∞ÁôªÂΩïÈ°µÈù¢Ôºå‰∏çÊòæÁ§∫Áä∂ÊÄÅ1
        hideLoadingScreen();
        showLoginRegister();
        return;
      }
      
      // Â∞ùËØï‰ªéÂêéÁ´ØÂêåÊ≠•Áä∂ÊÄÅ
      syncWithBackend();
      
      // ÁîüÊàêÊàñËé∑ÂèñÁî®Êà∑ÈÇÄËØ∑Á†Å
      let userInviteCode = localStorage.getItem('userInviteCode');
      if (!userInviteCode) {
        try {
          userInviteCode = await generateUserInviteCode();
          localStorage.setItem('userInviteCode', userInviteCode);
        } catch (error) {
          console.error('ÁîüÊàêÈÇÄËØ∑Á†ÅÂ§±Ë¥•:', error);
          // ‰ΩøÁî®Â§áÁî®ÊñπÊ°à
          userInviteCode = 'USER' + Date.now().toString().slice(-6);
          localStorage.setItem('userInviteCode', userInviteCode);
        }
      }
      
      // ÂàùÂßãÂåñÈü≥ÊïàÁ≥ªÁªü
      initAudioSystem();
      
      // ÂàùÂßãÂåñÊ∂àÊÅØÁ≥ªÁªü
      initMessages();
      
      // ÂàùÂßãÂåñBugÊä•ÂëäÁ≥ªÁªü
      initBugReports();
      
      // ÂàùÂßãÂåñÊ∂àÊÅØÂõæÊ†áÊãñÊãΩÂäüËÉΩ
      initMessageIconDrag();
      
      // ÂàùÂßãÂåñWebSocketËøûÊé•
      initWebSocket();
      
      // Âä†ËΩΩÈÄöÁü•ÂéÜÂè≤
      loadNotifications();
      
      // Ê∏≤ÊüìÁä∂ÊÄÅÂπ∂ÈöêËóèÂä†ËΩΩÂ±èÂπï
      renderState();
      hideLoadingScreen();
      
      // ÂàùÂßãÂåñËÆæÁΩÆÈù¢Êùø‰∫ã‰ª∂ÁõëÂê¨Âô®
      initSettingsEvents();
    }

    function renderState() {
      const state = STATES[currentState];
      // Ê≥®ÈáäÊéâÁä∂ÊÄÅÊ†áÁ≠æÂíåÂâØÊ†áÈ¢òÁöÑÊõ¥Êñ∞ÔºåÂõ†‰∏∫Ëøô‰∫õÂÖÉÁ¥†Â∑≤Ë¢´ÈöêËóè
      // document.getElementById('stateLabel').innerText = state.name;
      // document.getElementById('subtitle').innerText = state.subtitle;
      // Ê∏≤ÊüìÂç°ÁâáÂÜÖÂÆπ
      document.getElementById('card').innerHTML = state.card();
      
      // Êõ¥Êñ∞ÊàòÁª©Âç°Êï∞ÊçÆ
      updateStatsDisplay();
      
      // Ê∏≤ÊüìÂ∫ïÈÉ®ÊåâÈíÆ
      const bottom = document.getElementById('bottomButtons');
      bottom.innerHTML = '';
      
      // ‰∏•Ê†ºÊåâÁä∂ÊÄÅÊéßÂà∂ÊåâÈíÆÊòæÁ§∫
      const buttonsToShow = getButtonsForState(currentState);
      
      // Â¶ÇÊûúÊåâÈíÆË∂ÖËøá6‰∏™ÔºåÊ∑ªÂä†many-buttonsÁ±ª
      if (buttonsToShow.length > 6) {
        bottom.classList.add('many-buttons');
      } else {
        bottom.classList.remove('many-buttons');
      }
      
      buttonsToShow.forEach(btnConfig => {
        const b = document.createElement('button');
        b.innerText = btnConfig.text;
        
        // Â∫îÁî®Êñ∞ÁöÑÊåâÈíÆÂàÜÁ±ªÁ≥ªÁªü
        const buttonCategory = getButtonCategory(btnConfig.key || btnConfig.text);
        b.classList.add(buttonCategory);
        
        // ‰øùÊåÅÂéüÊúâÈ¢úËâ≤Á±ªÔºàÂêëÂêéÂÖºÂÆπÔºâ
        if (btnConfig.color) {
          b.classList.add(btnConfig.color);
        }
        
        b.onclick = btnConfig.action;
        
        // ËÆæÁΩÆ data-key ‰ª•‰æøÊ†∑ÂºèÂÆöÂà∂
        if (btnConfig.key) {
          b.dataset.key = btnConfig.key;
        }
        
        bottom.appendChild(b);
      });
      
      // ÊéßÂà∂ÂÄíËÆ°Êó∂
      if (currentState === 2) {
        if (!countdownStart) {
          countdownStart = Date.now();
          inviteStart = countdownStart;
        }
        updateCountdown();
        countdownTimer = setInterval(updateCountdown, 1000);
      } else {
        if (countdownTimer) clearInterval(countdownTimer);
      }
      
      // Êõ¥Êñ∞Ê∂àÊÅØÊåâÈíÆÁä∂ÊÄÅ
      updateMessageButton();
    }
    
    // Ê†πÊçÆÁä∂ÊÄÅ‰∏•Ê†ºÊéßÂà∂ÊåâÈíÆÊòæÁ§∫
    function getButtonsForState(state) {
      const baseButtons = STATES[state].buttons;
      const result = [...baseButtons];
      

      
      return result;
    }
    
    // Êõ¥Êñ∞ÊàòÁª©Âç°ÊòæÁ§∫
    function updateStatsDisplay() {
      const taskProgressEl = document.getElementById('taskProgress');
      const teamCountEl = document.getElementById('teamCount');
      const totalEarningsEl = document.getElementById('totalEarnings');
      
      // ‰ΩøÁî®newTasksÊï∞ÁªÑÁöÑÂÆûÈôÖÂÆåÊàêÁä∂ÊÄÅÔºåÁ°Æ‰øù‰∏éÂÜÖÂÆπÊ†èÊòæÁ§∫‰∏ÄËá¥
      const actualCompletedTasks = newTasks.filter(t => t.done).length;
      if (taskProgressEl) taskProgressEl.innerText = actualCompletedTasks;
      if (teamCountEl) teamCountEl.innerText = teamMembers;
      if (totalEarningsEl) totalEarningsEl.innerText = totalEarnings.toFixed(2);
    }

    function updateCountdown(wsData = null) {
      const total = 168 * 3600 * 1000; // ÊÄªÊó∂ÈïøÔºö168Â∞èÊó∂
      let remaining;
      
      if (wsData && wsData.remaining !== undefined) {
        // ‰ΩøÁî®WebSocketÊé®ÈÄÅÁöÑÂÄíËÆ°Êó∂Êï∞ÊçÆ
        remaining = wsData.remaining;
      } else {
        // ‰ΩøÁî®Êú¨Âú∞ËÆ°ÁÆóÁöÑÂÄíËÆ°Êó∂
        const now = Date.now();
        const elapsed = now - countdownStart;
        remaining = total - elapsed;
        if (remaining < 0) remaining = 0;
      }
      
      // ËÆ°ÁÆóÊÄªÂ∞èÊó∂Êï∞„ÄÅÂàÜÈíüÊï∞„ÄÅÁßíÊï∞
      const totalHours = Math.floor(remaining / (3600 * 1000));
      const mins = Math.floor((remaining % 3600000) / 60000);
      const secs = Math.floor((remaining % 60000) / 1000);
      
      // Ê†ºÂºèÂåñ‰∏∫ XX:XX:XX Ê†ºÂºèÔºàÂ∞èÊó∂‰∏çË°•ÂâçÂØº0Ôºâ
      const timeStr = `${totalHours}:${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
      
      // Êõ¥Êñ∞ÂÄíËÆ°Êó∂ÊòæÁ§∫
      const countdownEl = document.getElementById('countdown');
      if (countdownEl) countdownEl.innerText = timeStr;
      
      // Êõ¥Êñ∞ËøõÂ∫¶Êù°ÔºàÂÄíËÆ°Êó∂ËøõÂ∫¶Ôºö‰ªéÊª°ÈÄêÊ∏êÂèòÁ©∫Ôºâ
      const progressEl = document.getElementById('countdownProgress');
      const remainingDaysEl = document.getElementById('remainingDays');
      if (progressEl && remainingDaysEl) {
        // ÂÄíËÆ°Êó∂ËøõÂ∫¶Êù°ÔºöÊòæÁ§∫Ââ©‰ΩôÊó∂Èó¥ËøõÂ∫¶Ôºà‰ªé100%ÈÄíÂáèÂà∞0%Ôºå‰ªéÊª°ÈÄêÊ∏êÂèòÁ©∫Ôºâ
        const remainingProgress = (remaining / total);
        const remainingPercent = remainingProgress * 100;
        progressEl.style.width = `${remainingPercent}%`;
        
        // ËÆ°ÁÆóÂâ©‰ΩôÂ§©Êï∞„ÄÅÂ∞èÊó∂Êï∞ÂíåÂàÜÈíüÊï∞
        const remainingDays = Math.floor(remaining / (24 * 3600 * 1000));
        const remainingHours = Math.floor((remaining % (24 * 3600 * 1000)) / (3600 * 1000));
        const remainingMinutes = Math.floor((remaining % (3600 * 1000)) / (60 * 1000));
        
        // Ê†πÊçÆÂâ©‰ΩôÊó∂Èó¥ÊòæÁ§∫‰∏çÂêåÊ†ºÂºè
        if (remainingDays > 0) {
          remainingDaysEl.textContent = `Ââ©‰Ωô${remainingDays}Â§©${remainingHours}Â∞èÊó∂${remainingMinutes}ÂàÜ`;
        } else {
          remainingDaysEl.textContent = `‰ªÖÂâ©‰Ωô${remainingHours}Â∞èÊó∂${remainingMinutes}ÂàÜ`;
        }
      }
      
      // Êõ¥Êñ∞Áä∂ÊÄÅÊèêÁ§∫ÂíåÂä®ÁîªÊïàÊûú
      const statusEl = document.getElementById('countdownStatus');
      const containerEl = document.querySelector('.countdown-container');
      
      if (statusEl && containerEl) {
        const hoursLeft = remaining / (3600 * 1000);
        
        if (hoursLeft <= 24) {
          // ÊúÄÂêé24Â∞èÊó∂ - Á¥ßÊÄ•Áä∂ÊÄÅ
          statusEl.innerHTML = 'üö® ÊúÄÂêé24Â∞èÊó∂ÔºÅÁ´ãÂç≥ÂÆåÊàê‰ªªÂä°Ëé∑ÂæóÂ•ñÂä±';
          statusEl.style.background = 'rgba(255, 69, 58, 0.2)';
          statusEl.style.borderColor = 'rgba(255, 69, 58, 0.4)';
          statusEl.style.color = '#ff453a';
          containerEl.style.animation = 'urgentPulse 1.5s ease-in-out infinite';
          
          // ËøõÂ∫¶ÁéØÂèòÁ∫¢Ëâ≤
          if (progressEl) {
            progressEl.style.stroke = '#ff453a';
            progressEl.style.filter = 'drop-shadow(0 0 8px #ff453a)';
          }
        } else if (hoursLeft <= 72) {
          // ÊúÄÂêé72Â∞èÊó∂ - Ë≠¶ÂëäÁä∂ÊÄÅ
          statusEl.innerHTML = '‚ö†Ô∏è Êó∂Èó¥Á¥ßËø´ÔºåÊäìÁ¥ßÂÆåÊàê‰ªªÂä°Ëé∑ÂæóÊî∂Áõä';
          statusEl.style.background = 'rgba(255, 193, 7, 0.2)';
          statusEl.style.borderColor = 'rgba(255, 193, 7, 0.4)';
          statusEl.style.color = '#ffc107';
          containerEl.style.animation = 'countdownPulse 2s ease-in-out infinite';
          
          // ËøõÂ∫¶ÁéØÂèòÊ©ôËâ≤
          if (progressEl) {
            progressEl.style.stroke = '#ffc107';
            progressEl.style.filter = 'drop-shadow(0 0 8px #ffc107)';
          }
        } else {
          // Ê≠£Â∏∏Áä∂ÊÄÅ - ‰∏çÊòæÁ§∫‰ªª‰ΩïÊèêÁ§∫
          if (statusEl) {
            statusEl.style.display = 'none';
          }
          containerEl.style.animation = 'countdownPulse 3s ease-in-out infinite';
          
          // ËøõÂ∫¶ÁéØ‰øùÊåÅËìùËâ≤
          if (progressEl) {
            progressEl.style.stroke = 'var(--accent-color)';
            progressEl.style.filter = 'drop-shadow(0 0 8px var(--accent-color))';
          }
        }
      }
      
      // Êõ¥Êñ∞ÈÇÄËØ∑ÈìæÊé•ÊòæÁ§∫
      updateInviteDisplay();
      
      // ÂΩìÂÄíËÆ°Êó∂ÁªìÊùüÔºåËá™Âä®ËøõÂÖ•Áä∂ÊÄÅ3
      if (remaining === 0 && currentState === 2) {
        currentState = 3;
        countdownStart = null;
        renderState();
      }
    }
    
    // Êõ¥Êñ∞ÈÇÄËØ∑ÈìæÊé•ÊòæÁ§∫
    function updateInviteDisplay() {
      // Êõ¥Êñ∞ÈÇÄËØ∑Á†ÅÂíåÈÇÄËØ∑ÈìæÊé•ÂÜÖÂÆπ
      const userInviteCode = localStorage.getItem('userInviteCode') || '';
      
      // Êõ¥Êñ∞‰∏ìÂ±ûÈÇÄËØ∑Á†ÅÊòæÁ§∫
      const inviteCodeEl = document.getElementById('myInviteCode');
      if (inviteCodeEl) {
        inviteCodeEl.textContent = userInviteCode;
      }
      
      // Êõ¥Êñ∞ÈÇÄËØ∑ÈìæÊé•
      const inviteLinkEl = document.getElementById('inviteLink');
      if (inviteLinkEl) {
        inviteLinkEl.value = `https://gold7.com/login.html?invite=${userInviteCode}`;
      }
    }

    // ÊòæÁ§∫ÈÇÄËØ∑ÈìæÊé•ÂºπÁ™ó
    function showInviteLink() {
      const userInviteCode = localStorage.getItem('userInviteCode') || 'ABC123';
      const inviteLink = `https://gold7.com/login.html?invite=${userInviteCode}`;
      
      // ËÆ°ÁÆóÈÇÄËØ∑ÈìæÊé•Ââ©‰ΩôÊúâÊïàÊúü
      const detailedTime = getDetailedCountdown();
      
      const message = `üîó ÊÇ®ÁöÑ‰∏ìÂ±ûÈÇÄËØ∑ÈìæÊé•Ôºö\n${inviteLink}\n\nüíé ÈÇÄËØ∑Á†ÅÔºö${userInviteCode}\n\n‚è∞ ÊúâÊïàÊúüÂâ©‰ΩôÔºö${detailedTime}\n\nüí° ÂàÜ‰∫´Ê≠§ÈìæÊé•ÈÇÄËØ∑Â•ΩÂèãÊ≥®ÂÜåÔºåËé∑Âæó‰∏∞ÂéöÂ•ñÂä±ÔºÅ`;
      
      const buttons = [
        {
          text: 'Â§çÂà∂ÈìæÊé•',
          action: () => {
            if (navigator.clipboard) {
              navigator.clipboard.writeText(inviteLink).then(() => {
                showDialog('ÈÇÄËØ∑ÈìæÊé•Â∑≤Â§çÂà∂', `ÊúâÊïàÊúüÂâ©‰Ωô ${detailedTime}`);
              }).catch(() => {
                fallbackCopy(inviteLink);
              });
            } else {
              fallbackCopy(inviteLink);
            }
          }
        },
        {
          text: 'Â§çÂà∂ÈÇÄËØ∑Á†Å',
          action: () => {
            if (navigator.clipboard) {
              navigator.clipboard.writeText(userInviteCode).then(() => {
                showDialog('ÈÇÄËØ∑Á†ÅÂ∑≤Â§çÂà∂', `‰∏ìÂ±ûÈÇÄËØ∑Á†Å: ${userInviteCode}\nÊúâÊïàÊúüÂâ©‰Ωô ${detailedTime}`);
              }).catch(() => {
                fallbackCopyCode(userInviteCode);
              });
            } else {
              fallbackCopyCode(userInviteCode);
            }
          }
        },
        {
          text: 'ÂÖ≥Èó≠',
          style: 'secondary',
          action: 'close'
        }
      ];
      
      showDialog('ÈÇÄËØ∑ÈìæÊé•', message, buttons);
    }

    // ÂºÄÂèëÊµãËØïÂæ™ÁéØÁä∂ÊÄÅ
    function cycleState() {
      currentState++;
      if (currentState > 3) currentState = 1;
      countdownStart = null;
      renderState();
    }

    // ÂàáÊç¢Âà∞ÊåáÂÆöÁä∂ÊÄÅ
    function switchToState(state) {
      if (state === '') return; // Â¶ÇÊûúÈÄâÊã©‰∫ÜÁ©∫ÈÄâÈ°πÔºå‰∏çÊâßË°å‰ªª‰ΩïÊìç‰Ωú
      
      currentState = parseInt(state);
      countdownStart = null;
      renderState();
      
      // ÈáçÁΩÆ‰∏ãÊãâËèúÂçï
      document.getElementById('stateSelect').value = '';
      
      // Ëá™Âä®ÂÖ≥Èó≠ËÆæÁΩÆÈù¢Êùø
      closeSettings();
    }

    // ÊøÄÊ¥ªË¥¶Âè∑/È¶ñÊ¨°ÂÖ•Èáë - ÈõÜÊàêÁúüÂÆûTatumÊîØ‰ªòÊµÅÁ®ã
    async function activateAccount() {
      try {
        // ÊòæÁ§∫Âä†ËΩΩÊèêÁ§∫
        showDialog('Ê≠£Âú®Â§ÑÁêÜ', 'Ê≠£Âú®ÁîüÊàêÊîØ‰ªò‰ø°ÊÅØÔºåËØ∑Á®çÂÄô...', null, 'loading');
        
        // Ë∞ÉÁî®ÁúüÂÆûÁöÑÊøÄÊ¥ªAPI
        const response = await apiRequest('/activation/activate', {
          method: 'POST'
        });
        
        if (response.success && response.data) {
          const activationData = response.data;
          
          // ÂÖ≥Èó≠Âä†ËΩΩÂØπËØùÊ°Ü
          closeDialog();
          
          // ÊòæÁ§∫ÊîØ‰ªò‰ø°ÊÅØÁïåÈù¢
          showPaymentDialog(activationData);
          
        } else {
          throw new Error(response.message || 'ÊøÄÊ¥ªËØ∑Ê±ÇÂ§±Ë¥•');
        }
        
      } catch (error) {
        console.error('ÊøÄÊ¥ªAPIË∞ÉÁî®Â§±Ë¥•:', error);
        
        // ÂÖ≥Èó≠Âä†ËΩΩÂØπËØùÊ°Ü
        closeDialog();
        
        // ÊòæÁ§∫ÈîôËØØ‰ø°ÊÅØÔºå‰∏çÂÜçËá™Âä®Ë∑≥ËΩ¨Âà∞Áä∂ÊÄÅ2
        showDialog('ÊøÄÊ¥ªÂ§±Ë¥•', 'Êó†Ê≥ïËøûÊé•Âà∞ÊîØ‰ªòÊúçÂä°Âô®ÔºåËØ∑Á®çÂêéÈáçËØï„ÄÇÂ¶ÇÊûúÈóÆÈ¢òÊåÅÁª≠Â≠òÂú®ÔºåËØ∑ËÅîÁ≥ªÂÆ¢Êúç„ÄÇ', null, 'error');
      }
    }

    // ÂÜçÊ¨°ÂÖ•ÈáëÔºàÂ§çË¥≠Ôºâ
    async function repurchase() {
      // ‰ΩøÁî®ÂõûË∞ÉÊú∫Âà∂ÔºåÁ°Æ‰øùÁî®Êà∑Á°ÆËÆ§ÂêéÊâçÊâßË°åÁä∂ÊÄÅÂàáÊç¢
      showDialog('ÂÜçÊ¨°ÊøÄÊ¥ª', 'ËØ∑ÂêëÁ≥ªÁªüÊèê‰æõÁöÑÊñ∞USDTÂú∞ÂùÄÊîØ‰ªò100 USDT‰ª•ÈáçÊñ∞ÊøÄÊ¥ª„ÄÇÈáçÊñ∞ÊøÄÊ¥ªÂêéÂ∞ÜÂºÄÂêØÊñ∞ÁöÑ168Â∞èÊó∂ÊåëÊàòÊúü„ÄÇ', null, 'normal', async () => {
        try {
          // Â∞ùËØïË∞ÉÁî®ÂêéÁ´ØAPI
          const response = await StateAPI.repurchase();
          
          if (response.success) {
            // ‰ΩøÁî®ÂêéÁ´ØËøîÂõûÁöÑÊï∞ÊçÆÊõ¥Êñ∞Áä∂ÊÄÅ
            currentState = response.data.status;
            countdownStart = new Date(response.data.countdown_end_time).getTime() - (168 * 60 * 60 * 1000);
            inviteStart = countdownStart;
            
            // ËÆ∞ÂΩï‰∫§Êòì
            transactions.push({ 
              type: 'Â§çË¥≠Áº¥Ë¥π', 
              amount: -100, 
              fee: 0, 
              net: -100, 
              time: new Date().toISOString(),
              desc: 'Â§çË¥≠ÊøÄÊ¥ªÁº¥Ë¥π' 
            });
            
            // ËÆæÁΩÆÊøÄÊ¥ªÊó∂Èó¥‰æõquiz.html‰ΩøÁî®
            localStorage.setItem('activationTime', new Date().toISOString());
            
            saveState();
            renderState();
            
            showDialog('Â§çË¥≠ÊàêÂäü', 'Â§çË¥≠ÊøÄÊ¥ªÊàêÂäüÔºÅÊñ∞ÁöÑ168Â∞èÊó∂ÊåëÊàòÊúüÂ∑≤ÂºÄÂßã„ÄÇ');
          }
        } catch (error) {
          console.warn('ÂêéÁ´ØAPIË∞ÉÁî®Â§±Ë¥•Ôºå‰ΩøÁî®Êú¨Âú∞Ê®°Âºè:', error);
          
          // ÂõûÈÄÄÂà∞Êú¨Âú∞Ê®°Âºè - ÁßªÈô§Âª∂ËøüÔºåÁ´ãÂç≥ÊâßË°å
          // Â§çË¥≠ËÆ∞ÂΩï‰∫§Êòì
          transactions.push({ 
            type: 'Â§çË¥≠Áº¥Ë¥π', 
            amount: -100, 
            fee: 0, 
            net: -100, 
            time: new Date().toISOString(),
            desc: 'Â§çË¥≠ÊøÄÊ¥ªÁº¥Ë¥π' 
          });
          
          // Êõ¥Êñ∞Áä∂ÊÄÅ
          currentState = 2;
          countdownStart = Date.now();
          inviteStart = countdownStart;
          
          // ËÆæÁΩÆÊøÄÊ¥ªÊó∂Èó¥‰æõquiz.html‰ΩøÁî®
          localStorage.setItem('activationTime', new Date().toISOString());
          
          saveState();
          renderState();
          
          showDialog('Â§çË¥≠ÊàêÂäü', 'Â§çË¥≠ÊøÄÊ¥ªÊàêÂäüÔºÅÊñ∞ÁöÑ168Â∞èÊó∂ÊåëÊàòÊúüÂ∑≤ÂºÄÂßã„ÄÇ');
        }
      });
    }

    // ‰ªªÂä°ÊåâÈíÆ - ÂÆûÁé∞ÊåâÂ∫èËß¶ÂèëÈÄªËæë
    function openTasks() {
      // ÊâæÂà∞‰∏ã‰∏Ä‰∏™Êú™ÂÆåÊàêÁöÑ‰ªªÂä°ÔºàÊåâIDÈ°∫Â∫èÔºâ
      const nextTask = newTasks.find(t => !t.done && t.id === completedNewbieTasks + 1);
      
      if (nextTask) {
        // ÊòæÁ§∫‰ªªÂä°ËØ¶ÊÉÖ
        showDialog('ÂΩìÂâç‰ªªÂä°', `‰ªªÂä°${nextTask.id}Ôºö${nextTask.title}\n\n${nextTask.desc}\n\nÂÆåÊàêÂ•ñÂä±Ôºö${nextTask.reward} USDT\n\nÁÇπÂáªÁ°ÆÂÆöÊ†áËÆ∞ÂÆåÊàê`, [
          { text: 'ÂÆåÊàê‰ªªÂä°', action: () => completeNewbieTask(nextTask) },
          { text: 'ÂèñÊ∂à', action: 'close' }
        ]);
      } else if (completedNewbieTasks >= 3) {
        // ÊâÄÊúâÊñ∞Êâã‰ªªÂä°Â∑≤ÂÆåÊàêÔºåÊ£ÄÊü•Á≠îÈ¢ò‰ªªÂä°Áä∂ÊÄÅ
        const quizCorrect = parseInt(localStorage.getItem('quizCorrect')) || 0;
        const quizCompleted = quizCorrect >= 20;
        
        if (!quizCompleted) {
          showDialog('Á≠îÈ¢ò‰ªªÂä°', 'ÊâÄÊúâÊñ∞Êâã‰ªªÂä°Â∑≤ÂÆåÊàêÔºÅ\n\nÁ≠îÈ¢ò‰ªªÂä°ÂèØÁî®ÔºåÂÆåÊàê20È¢òÂèØÈôç‰ΩéÊèêÁé∞ÊâãÁª≠Ë¥π„ÄÇ\n\nÂΩìÂâçÊâãÁª≠Ë¥πÔºö' + ((withdrawFeeRate * 100).toFixed(1)) + '%', [
            { text: 'ÂºÄÂßãÁ≠îÈ¢ò', action: () => { saveState(); window.location.href = 'quiz.html'; } },
            { text: 'Á®çÂêéÂÜçËØ¥', action: 'close' }
          ]);
        } else {
          // Ê£ÄÊü•Â§ßÁ•û‰ªªÂä°ÊòØÂê¶Ëß£ÈîÅ
          const godTasksUnlocked = completedNewbieTasks >= 3 && quizCompleted;
          if (godTasksUnlocked) {
            const nextGodTask = godTasks.find(t => !t.done);
            if (nextGodTask) {
              showDialog('Â§ßÁ•û‰ªªÂä°', 'Êñ∞Êâã‰ªªÂä°ÂíåÁ≠îÈ¢ò‰ªªÂä°Â∑≤ÂÆåÊàêÔºÅ\n\nÂ§ßÁ•û‰ªªÂä°Â∑≤Ëß£ÈîÅÔºåÂèØËé∑ÂæóÊõ¥È´òÂ•ñÂä±„ÄÇ', [
                { text: 'Êü•ÁúãÂ§ßÁ•û‰ªªÂä°', action: () => openGodTasks() },
                { text: 'ÂÖ≥Èó≠', action: 'close' }
              ]);
            } else {
              showDialog('‰ªªÂä°ÂÆåÊàê', 'ÊÅ≠ÂñúÔºÅÊâÄÊúâ‰ªªÂä°Â∑≤ÂÆåÊàêÔºÅ\n\nÁªßÁª≠ÈÇÄËØ∑Â•ΩÂèãËé∑ÂæóÊõ¥Â§öÂ•ñÂä±„ÄÇ');
            }
          } else {
            showDialog('Êñ∞Êâã‰ªªÂä°', 'ÊâÄÊúâÊñ∞Êâã‰ªªÂä°Â∑≤ÂÆåÊàêÔºÅ\n\nÁ≠îÈ¢ò‰ªªÂä°‰πüÂ∑≤ÂÆåÊàêÔºåÊâãÁª≠Ë¥πÂ∑≤ÈôçËá≥ÊúÄ‰Ωé„ÄÇ');
          }
        }
      } else {
        showDialog('‰ªªÂä°Á≥ªÁªü', 'ËØ∑ÊåâÈ°∫Â∫èÂÆåÊàê‰ªªÂä°„ÄÇÂΩìÂâçÂèØÂÆåÊàê‰ªªÂä°Ôºö' + (completedNewbieTasks + 1));
      }
    }

    /**
     * ÂÆåÊàêÊñ∞Êâã‰ªªÂä°
     */
    function completeNewbieTask(task) {
      // Ê®°Êãü‰ªªÂä°ÂÆåÊàê
      setTimeout(() => {
        task.done = true;
        // ÂêåÊ≠•completedNewbieTasksÂèòÈáèÔºåÁ°Æ‰øù‰∏énewTasksÊï∞ÁªÑÁä∂ÊÄÅ‰∏ÄËá¥
        completedNewbieTasks = newTasks.filter(t => t.done).length;
        
        // ‰ªªÂä°Â•ñÂä±
        walletBalance += task.reward;
        totalEarnings += task.reward;
        
        // ËÆ∞ÂΩï‰∫§Êòì
        transactions.push({ 
          type: '‰ªªÂä°Â•ñÂä±', 
          amount: task.reward, 
          fee: 0, 
          net: task.reward, 
          time: new Date().toISOString(),
          desc: `ÂÆåÊàê${task.title}` 
        });
        
        saveState();
        renderState();
        
        // ÊòæÁ§∫‰ªªÂä°ÂÆåÊàêÂºπÁ™ó
        showDialog('‰ªªÂä°ÂÆåÊàê', `ÊÅ≠ÂñúÂÆåÊàê‰ªªÂä°Ôºö${task.title}ÔºÅ\nÂ•ñÂä±Ôºö${task.reward} USDT\nÂΩìÂâç‰ΩôÈ¢ùÔºö${walletBalance.toFixed(2)} USDT`);
        
        // Ê£ÄÊü•ÊòØÂê¶Ëß£ÈîÅÁ≠îÈ¢ò‰ªªÂä°
        if (completedNewbieTasks >= 1 && !quizCompleted) {
          setTimeout(() => {
            showDialog('Ëß£ÈîÅÁ≠îÈ¢ò‰ªªÂä°', 'ÊÅ≠ÂñúÔºÅËß£ÈîÅÁ≠îÈ¢ò‰ªªÂä°ÔºåÂÆåÊàêÂèØÈôç‰ΩéÊèêÁé∞ÊâãÁª≠Ë¥πÔºÅ\n\nÂΩìÂâçÊâãÁª≠Ë¥πÔºö' + ((withdrawFeeRate * 100).toFixed(1)) + '%', [
              { text: 'ÂºÄÂßãÁ≠îÈ¢ò', action: () => { saveState(); window.location.href = 'quiz.html'; } },
              { text: 'Á®çÂêéÂÜçËØ¥', action: 'close' }
            ]);
          }, 2000);
        }
        
        // Ê£ÄÊü•ÊòØÂê¶Ëß£ÈîÅÂ§ßÁ•û‰ªªÂä°
        if (completedNewbieTasks >= 3) {
          const quizCorrect = parseInt(localStorage.getItem('quizCorrect')) || 0;
          const quizCompleted = quizCorrect >= 20;
          
          if (quizCompleted) {
            setTimeout(() => {
              showDialog('Ëß£ÈîÅÂ§ßÁ•û‰ªªÂä°', 'ÊÅ≠ÂñúÔºÅÂ§ßÁ•û‰ªªÂä°Â∑≤Ëß£ÈîÅÔºÅ\n\nÂÆåÊàêÂ§ßÁ•û‰ªªÂä°ÂèØËé∑ÂæóÊõ¥È´òÂ•ñÂä±„ÄÇ', [
                { text: 'Êü•ÁúãÂ§ßÁ•û‰ªªÂä°', action: () => openGodTasks() },
                { text: 'Á®çÂêéÂÜçËØ¥', action: 'close' }
              ]);
            }, 2000);
          }
        }
      }, 1500);
    }
    

    
    // Â§çÂà∂ÈÇÄËØ∑ÈìæÊé•
    function copyInvite() {
      const userInviteCode = localStorage.getItem('userInviteCode') || '';
      const link = `https://gold7.com/invite?code=${userInviteCode}`;
      navigator.clipboard.writeText(link).then(() => {
        showDialog('ÈÇÄËØ∑ÈìæÊé•Â∑≤Â§çÂà∂', `ÊúâÊïàÊúüÂâ©‰Ωô ${document.getElementById('inviteLeft').innerText}„ÄÇ`);
      });
    }
    
    // Êñ∞ÁöÑÂ§çÂà∂ÈÇÄËØ∑ÈìæÊé•ÂáΩÊï∞
    function copyInviteLink() {
      const linkInput = document.getElementById('inviteLink');
      const link = linkInput.value;
      
      if (navigator.clipboard) {
        navigator.clipboard.writeText(link).then(() => {
          const detailedTime = getDetailedCountdown();
          showDialog('ÈÇÄËØ∑ÈìæÊé•Â∑≤Â§çÂà∂', `ÊúâÊïàÊúüÂâ©‰Ωô ${detailedTime}`);
        }).catch(() => {
          fallbackCopy(link);
        });
      } else {
        fallbackCopy(link);
      }
    }
    
    // Â§çÂà∂‰∏ìÂ±ûÈÇÄËØ∑Á†ÅÂáΩÊï∞
    function copyInviteCode() {
      const codeEl = document.getElementById('myInviteCode');
      const code = codeEl.textContent;
      
      if (navigator.clipboard) {
        navigator.clipboard.writeText(code).then(() => {
          const detailedTime = getDetailedCountdown();
          showDialog('ÈÇÄËØ∑Á†ÅÂ∑≤Â§çÂà∂', `‰∏ìÂ±ûÈÇÄËØ∑Á†Å: ${code}\nÊúâÊïàÊúüÂâ©‰Ωô ${detailedTime}`);
        }).catch(() => {
          fallbackCopyCode(code);
        });
      } else {
        fallbackCopyCode(code);
      }
    }
    
    // Ëé∑ÂèñËØ¶ÁªÜÂÄíËÆ°Êó∂Êó∂Èó¥
    function getDetailedCountdown() {
      const total = 168 * 3600 * 1000;
      const now = Date.now();
      const inviteRemainingMs = Math.max(0, (inviteStart + total) - now);
      const days = Math.floor(inviteRemainingMs / (24 * 3600000));
      const hrs = Math.floor((inviteRemainingMs % (24 * 3600000)) / 3600000);
      const mins = Math.floor((inviteRemainingMs % 3600000) / 60000);
      
      let result = '';
      if (days > 0) result += `${days}Â§©`;
      if (hrs > 0) result += `${hrs}Â∞èÊó∂`;
      if (mins > 0) result += `${mins}ÂàÜÈíü`;
      if (result === '') result = '‰∏çË∂≥1ÂàÜÈíü';
      
      return result;
    }
    
    // ÈôçÁ∫ßÂ§çÂà∂ÊñπÊ°à
    function fallbackCopy(text) {
      const textArea = document.createElement('textarea');
      textArea.value = text;
      document.body.appendChild(textArea);
      textArea.select();
      try {
        document.execCommand('copy');
        const detailedTime = getDetailedCountdown();
        showDialog('ÈÇÄËØ∑ÈìæÊé•Â∑≤Â§çÂà∂', `ÊúâÊïàÊúüÂâ©‰Ωô ${detailedTime}`);
      } catch (err) {
        showDialog('Â§çÂà∂Â§±Ë¥•', 'ËØ∑ÊâãÂä®Â§çÂà∂ÈìæÊé•');
      }
      document.body.removeChild(textArea);
    }
    
    // ÈôçÁ∫ßÂ§çÂà∂ÈÇÄËØ∑Á†ÅÊñπÊ°à
    function fallbackCopyCode(code) {
      const textArea = document.createElement('textarea');
      textArea.value = code;
      document.body.appendChild(textArea);
      textArea.select();
      try {
        document.execCommand('copy');
        const detailedTime = getDetailedCountdown();
        showDialog('ÈÇÄËØ∑Á†ÅÂ∑≤Â§çÂà∂', `‰∏ìÂ±ûÈÇÄËØ∑Á†Å: ${code}\nÊúâÊïàÊúüÂâ©‰Ωô ${detailedTime}`);
      } catch (err) {
        showDialog('Â§çÂà∂Â§±Ë¥•', 'ËØ∑ÊâãÂä®Â§çÂà∂ÈÇÄËØ∑Á†Å');
      }
      document.body.removeChild(textArea);
    }
    /**
     * Êä¢Á∫¢ÂåÖÂäüËÉΩ
     * Ê£ÄÊü•Êó∂Èó¥Á™óÂè£„ÄÅÁî®Êà∑ËµÑÊ†ºÔºåÂπ∂Â§ÑÁêÜÊä¢Á∫¢ÂåÖÈÄªËæë
     */
    function grabRedPacket() {
      // Ê£ÄÊü•ËµÑÊ†ºÔºö‰ªÖÁä∂ÊÄÅ2ÊúâÁ∫¢ÂåÖÊåâÈíÆ
      if (currentState !== 2) {
        showDialog('Êó†Êä¢Á∫¢ÂåÖËµÑÊ†º', 'Âè™ÊúâÂú®ÊøÄÊ¥ªÁä∂ÊÄÅÊâçÂèØ‰ª•Êä¢Á∫¢ÂåÖ„ÄÇ');
        return;
      }
      
      // ‰øùÂ≠òÂΩìÂâçÁä∂ÊÄÅÂà∞localStorage
      saveState();
      
      // Ë∑≥ËΩ¨Âà∞Á∫¢ÂåÖÈ°µÈù¢
      window.location.href = 'redpacket.html';
    }
    
    /**
     * Ëé∑ÂèñÂΩìÂâçÁ∫¢ÂåÖÊó∂Èó¥Á™óÂè£Áä∂ÊÄÅ
     */
    function getCurrentRedPacketTimeWindow() {
      const now = new Date();
      const currentHour = now.getHours();
      const currentMinute = now.getMinutes();
      const currentSecond = now.getSeconds();
      
      // Á∫¢ÂåÖÊó∂Èó¥Ôºö9:00, 12:00, 20:00ÔºåÊØèÊ¨°ÊåÅÁª≠77Áßí
      const redPacketTimes = [
        { hour: 9, minute: 0 },
        { hour: 12, minute: 0 },
        { hour: 20, minute: 0 }
      ];
      
      for (const time of redPacketTimes) {
        if (currentHour === time.hour && currentMinute === time.minute && currentSecond < 77) {
          return {
            isActive: true,
            remainingSeconds: 77 - currentSecond,
            nextWindow: null
          };
        }
      }
      
      return {
        isActive: false,
        remainingSeconds: 0,
        nextWindow: getNextRedPacketTime()
      };
    }
    
    /**
     * Ëé∑Âèñ‰∏ã‰∏Ä‰∏™Á∫¢ÂåÖÊó∂Èó¥
     */
    function getNextRedPacketTime() {
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      
      const redPacketTimes = [
        new Date(today.getTime() + 9 * 60 * 60 * 1000),   // 9:00
        new Date(today.getTime() + 12 * 60 * 60 * 1000),  // 12:00
        new Date(today.getTime() + 20 * 60 * 60 * 1000)   // 20:00
      ];
      
      // ÊâæÂà∞‰∏ã‰∏Ä‰∏™Êó∂Èó¥
      for (const time of redPacketTimes) {
        if (now < time) {
          return time.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
        }
      }
      
      // Â¶ÇÊûú‰ªäÂ§©ÁöÑÊó∂Èó¥ÈÉΩËøá‰∫ÜÔºåËøîÂõûÊòéÂ§©ÁöÑÁ¨¨‰∏Ä‰∏™Êó∂Èó¥
      const tomorrow = new Date(today.getTime() + 24 * 60 * 60 * 1000);
      const tomorrowFirst = new Date(tomorrow.getTime() + 9 * 60 * 60 * 1000);
      return `ÊòéÂ§© ${tomorrowFirst.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })}`;
    }
    
    /**
     * ÊâßË°åÊä¢Á∫¢ÂåÖÊìç‰Ωú
     */
    function performRedPacketGrab() {
      // ÊòæÁ§∫Êä¢Á∫¢ÂåÖÂä®Áîª
      showDialog('Êä¢Á∫¢ÂåÖ‰∏≠...', 'Ê≠£Âú®‰∏∫ÊÇ®Êä¢Â§∫Á∫¢ÂåÖÔºåËØ∑Á®çÂÄô...', null, 'redpacket');
      
      // Ê®°ÊãüÁΩëÁªúÂª∂Ëøü
      setTimeout(() => {
        // ÈöèÊú∫ÁîüÊàêÁ∫¢ÂåÖÈáëÈ¢ùÔºà1-100 USDTÔºâ
        const amount = Math.floor(Math.random() * 100) + 1;
        const isSuccess = Math.random() > 0.3; // 70%ÊàêÂäüÁéá
        
        if (isSuccess) {
          // Êä¢Á∫¢ÂåÖÊàêÂäü
          walletBalance += amount;
          
          // ËÆ∞ÂΩïÁ∫¢ÂåÖÊî∂ÂÖ•
          const record = {
            id: Date.now(),
            amount: amount,
            timestamp: new Date().toISOString(),
            type: 'grab'
          };
          
          redPacketRecords.unshift(record);
          
          // Ê∑ªÂä†‰∫§ÊòìËÆ∞ÂΩï
          transactions.unshift({
            type: 'income',
            amount: amount,
            description: 'Êä¢Á∫¢ÂåÖÊî∂ÂÖ•',
            timestamp: new Date().toISOString()
          });
          
          // ÁîüÊàêÂõ¢ÈòüÊ∂àÊÅØ
          generateTeamMessage('redpacket_success', {
            amount: amount
          });
          
          // ‰øùÂ≠òÁä∂ÊÄÅ
          saveState();
          renderState();
          
          // ÊòæÁ§∫ÊàêÂäüÊèêÁ§∫
          showDialog('Êä¢Á∫¢ÂåÖÊàêÂäüÔºÅ', `ÊÅ≠ÂñúÊÇ®Êä¢Âà∞ ${amount} USDTÔºÅ`, [{ text: 'Â§™Ê£í‰∫Ü', action: 'close' }], 'success');
          
        } else {
          // Êä¢Á∫¢ÂåÖÂ§±Ë¥•
          showDialog('ÊâãÊÖ¢‰∫Ü', 'Á∫¢ÂåÖË¢´Êä¢ÂÆå‰∫ÜÔºå‰∏ãÊ¨°Ë¶ÅÊõ¥Âø´Âì¶ÔºÅ', [{ text: '‰∏ãÊ¨°‰∏ÄÂÆö', action: 'close' }], 'info');
        }
      }, 2000);
    }
    
    // Á∫¢ÂåÖËÆ∞ÂΩïÊï∞ÁªÑ
    let redPacketRecords = [];
    
    /**
     * ÂàùÂßãÂåñÁ∫¢ÂåÖËÆ∞ÂΩï
     */
    function initRedPacketRecords() {
      const saved = localStorage.getItem('redPacketRecords');
      if (saved) {
        redPacketRecords = JSON.parse(saved);
      }
    }
    
    /**
     * ‰øùÂ≠òÁ∫¢ÂåÖËÆ∞ÂΩï
     */
    function saveRedPacketRecords() {
      localStorage.setItem('redPacketRecords', JSON.stringify(redPacketRecords));
    }
    /**
     * ÊàëÁöÑÂõ¢ÈòüÂäüËÉΩ
     * ÊòæÁ§∫Âõ¢ÈòüÁªìÊûÑ„ÄÅÊàêÂëò‰ø°ÊÅØÂíåÂàÜ‰Ω£Êï∞ÊçÆ
     */
    function showTeam() {
      // ‰øùÂ≠òÂΩìÂâçÁä∂ÊÄÅÂà∞localStorage
      saveState();
      
      // Ë∑≥ËΩ¨Âà∞Âõ¢ÈòüÈ°µÈù¢
      window.location.href = 'team.html';
    }
    
    /**
     * Ëé∑ÂèñÂõ¢ÈòüÊï∞ÊçÆ
     */
    function getTeamData() {
      // ‰ªélocalStorageËé∑ÂèñÊàñÁîüÊàêÂõ¢ÈòüÊï∞ÊçÆ
      let teamData = JSON.parse(localStorage.getItem('teamData') || '{}');
      
      if (!teamData.inviteCode) {
        teamData = {
          totalMembers: teamMembers || 0,
          directMembers: Math.floor((teamMembers || 0) * 0.3), // 30%‰∏∫Áõ¥Êé®
          totalEarnings: totalEarnings || 0,
          inviteCode: generateInviteCode(),
          inviteLink: '',
          levels: generateTeamLevels()
        };
        
        teamData.inviteLink = `https://gold7.com/login.html?invite=${teamData.inviteCode}`;
        localStorage.setItem('teamData', JSON.stringify(teamData));
      }
      
      return teamData;
    }
    
    /**
     * ÁîüÊàêÈÇÄËØ∑Á†Å - ‰ªéÂêéÁ´ØAPIËé∑Âèñ
     */
    async function generateInviteCode() {
      try {
        const response = await apiRequest('/user/invite-code');
        if (response.success && response.data.inviteCode) {
          return response.data.inviteCode;
        }
      } catch (error) {
        console.error('Ëé∑ÂèñÈÇÄËØ∑Á†ÅÂ§±Ë¥•:', error);
      }
      
      // Â¶ÇÊûúAPIË∞ÉÁî®Â§±Ë¥•ÔºåÁîüÊàêÂü∫‰∫éÊó∂Èó¥Êà≥ÁöÑÂ§áÁî®ÈÇÄËØ∑Á†Å
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      const timestamp = Date.now().toString();
      let result = '';
      for (let i = 0; i < 6; i++) {
        const index = parseInt(timestamp.charAt(i % timestamp.length)) % chars.length;
        result += chars.charAt(index);
      }
      return result + timestamp.slice(-2);
    }
    
    /**
     * ÁîüÊàêÂõ¢ÈòüÂ±ÇÁ∫ßÊï∞ÊçÆ
     */
    function generateTeamLevels() {
      const levels = [];
      const totalMembers = teamMembers || 0;
      
      if (totalMembers === 0) return levels;
      
      // ÊåâÂ±ÇÁ∫ßÂàÜÈÖçÊàêÂëòÊï∞Èáè
      const levelNames = ['Áõ¥Êé®', '‰∫åÁ∫ß', '‰∏âÁ∫ß', 'ÂõõÁ∫ß', '‰∫îÁ∫ß', 'ÂÖ≠Á∫ß', '‰∏ÉÁ∫ß'];
      const levelRatios = [0.3, 0.25, 0.2, 0.15, 0.05, 0.03, 0.02]; // ÂêÑÂ±ÇÁ∫ßÂç†ÊØî
      
      for (let i = 0; i < 7; i++) {
        const memberCount = Math.floor(totalMembers * levelRatios[i]);
        if (memberCount > 0) {
          levels.push({
            level: i + 1,
            name: levelNames[i],
            count: memberCount,
            commission: getCommissionRate(i + 1),
            earnings: (memberCount * 10 * getCommissionRate(i + 1)).toFixed(2)
          });
        }
      }
      
      return levels;
    }
    
    /**
     * Ëé∑ÂèñÂêÑÂ±ÇÁ∫ßÂàÜ‰Ω£ÊØî‰æã
     */
    function getCommissionRate(level) {
      const rates = [0.15, 0.10, 0.08, 0.05, 0.03, 0.02, 0.01]; // 15%, 10%, 8%, 5%, 3%, 2%, 1%
      return rates[level - 1] || 0;
    }
    
    /**
     * ÁîüÊàêÂõ¢ÈòüÂ±ÇÁ∫ßHTML
     */
    function generateTeamLevelsHTML(levels) {
      if (!levels || levels.length === 0) {
        return '<div class="no-team">ÊöÇÊó†Âõ¢ÈòüÊàêÂëò</div>';
      }
      
      return levels.map(level => `
        <div class="level-item">
          <div class="level-header">
            <span class="level-name">${level.name}</span>
            <span class="level-count">${level.count}‰∫∫</span>
            <span class="level-commission">10 USDT</span>
            <span class="level-earnings">${level.earnings} USDT</span>
          </div>
        </div>
      `).join('');
    }
    
    /**
     * Â§çÂà∂Âõ¢ÈòüÈÇÄËØ∑ÈìæÊé•
     */
    function copyTeamInviteLink() {
      const linkInput = document.getElementById('teamInviteLink');
      if (linkInput) {
        const link = linkInput.value;
        if (navigator.clipboard) {
          navigator.clipboard.writeText(link).then(() => {
            showDialog('Â§çÂà∂ÊàêÂäü', 'ÈÇÄËØ∑ÈìæÊé•Â∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø', [{ text: 'Á°ÆÂÆö', action: 'close' }], 'success');
          }).catch(() => {
            fallbackCopyText(link, 'ÈÇÄËØ∑ÈìæÊé•');
          });
        } else {
          fallbackCopyText(link, 'ÈÇÄËØ∑ÈìæÊé•');
        }
      }
    }
    
    /**
     * Â§çÂà∂Âõ¢ÈòüÈÇÄËØ∑Á†Å
     */
    function copyTeamInviteCode() {
      const codeEl = document.getElementById('teamInviteCode');
      if (codeEl) {
        const code = codeEl.textContent;
        if (navigator.clipboard) {
          navigator.clipboard.writeText(code).then(() => {
            showDialog('Â§çÂà∂ÊàêÂäü', `ÈÇÄËØ∑Á†Å ${code} Â∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø`, [{ text: 'Á°ÆÂÆö', action: 'close' }], 'success');
          }).catch(() => {
            fallbackCopyText(code, 'ÈÇÄËØ∑Á†Å');
          });
        } else {
          fallbackCopyText(code, 'ÈÇÄËØ∑Á†Å');
        }
      }
    }
    
    /**
     * ÈôçÁ∫ßÂ§çÂà∂ÊñπÊ°à
     */
    function fallbackCopyText(text, type) {
      const textArea = document.createElement('textarea');
      textArea.value = text;
      document.body.appendChild(textArea);
      textArea.select();
      try {
        document.execCommand('copy');
        showDialog('Â§çÂà∂ÊàêÂäü', `${type}Â∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø`, [{ text: 'Á°ÆÂÆö', action: 'close' }], 'success');
      } catch (err) {
        showDialog('Â§çÂà∂Â§±Ë¥•', `ËØ∑ÊâãÂä®Â§çÂà∂${type}`, [{ text: 'Á°ÆÂÆö', action: 'close' }], 'info');
      }
      document.body.removeChild(textArea);
    }
    /**
     * ÊàëÁöÑÈí±ÂåÖÂäüËÉΩ
     * ÊòæÁ§∫‰ΩôÈ¢ù„ÄÅ‰∫§ÊòìËÆ∞ÂΩïÂíåÊèêÁé∞ÂäüËÉΩ
     */
    function showWallet() {
      // ‰øùÂ≠òÂΩìÂâçÁä∂ÊÄÅÂà∞localStorage
      saveState();
      
      // Ë∑≥ËΩ¨Âà∞Èí±ÂåÖÈ°µÈù¢
      window.location.href = 'wallet.html';
    }
    
    /**
     * Ëé∑ÂèñÈí±ÂåÖÊï∞ÊçÆ
     */
    function getWalletData() {
      const address = localStorage.getItem('walletAddress') || 'Êú™ÁªëÂÆö';
      const displayAddress = address === 'Êú™ÁªëÂÆö' ? 'Êú™ÁªëÂÆö' : 
        `${address.substring(0, 8)}...${address.substring(address.length - 6)}`;
      
      return {
        balance: walletBalance || 0,
        address: displayAddress,
        withdrawFeeRate: withdrawFeeRate || 0.05,
        transactions: transactions.slice(0, 5) // ÊòæÁ§∫ÊúÄËøë5Êù°ËÆ∞ÂΩï
      };
    }
    
    /**
     * ÁîüÊàê‰∫§ÊòìËÆ∞ÂΩïHTML
     */
    function generateTransactionListHTML(transactionList) {
      if (!transactionList || transactionList.length === 0) {
        return '<div class="no-transactions">ÊöÇÊó†‰∫§ÊòìËÆ∞ÂΩï</div>';
      }
      
      return transactionList.map(tx => {
        const isIncome = tx.type === 'income' || tx.amount > 0;
        const amountClass = isIncome ? 'amount-positive' : 'amount-negative';
        const amountPrefix = isIncome ? '+' : '-';
        
        return `
          <div class="transaction-item">
            <div class="tx-info">
              <div class="tx-description">${tx.description || tx.type}</div>
              <div class="tx-time">${formatTransactionTime(tx.timestamp)}</div>
            </div>
            <div class="tx-amount ${amountClass}">
              ${amountPrefix}${Math.abs(tx.amount).toFixed(2)} USDT
            </div>
          </div>
        `;
      }).join('');
    }
    
    /**
     * Ê†ºÂºèÂåñ‰∫§ÊòìÊó∂Èó¥
     */
    function formatTransactionTime(timestamp) {
      const date = new Date(timestamp);
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / (1000 * 60));
      const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
      const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
      
      if (diffMins < 1) return 'ÂàöÂàö';
      if (diffMins < 60) return `${diffMins}ÂàÜÈíüÂâç`;
      if (diffHours < 24) return `${diffHours}Â∞èÊó∂Ââç`;
      if (diffDays < 7) return `${diffDays}Â§©Ââç`;
      
      return date.toLocaleDateString('zh-CN');
    }
    
    /**
     * ÊòæÁ§∫ÊèêÁé∞ÂØπËØùÊ°Ü
     */
    function showWithdrawDialog() {
      const maxWithdraw = Math.max(0, (walletBalance - 2) / (1 + withdrawFeeRate));
      
      const withdrawContent = `
        <div class="withdraw-form">
          <div class="form-group">
            <label>ÊèêÁé∞ÈáëÈ¢ù (USDT)</label>
            <input type="number" id="withdrawAmount" placeholder="ËØ∑ËæìÂÖ•ÊèêÁé∞ÈáëÈ¢ù" 
                   max="${maxWithdraw.toFixed(2)}" min="1" step="0.01">
            <div class="amount-tips">
              <button onclick="setWithdrawAmount(10)" class="quick-amount">10</button>
              <button onclick="setWithdrawAmount(50)" class="quick-amount">50</button>
              <button onclick="setWithdrawAmount(100)" class="quick-amount">100</button>
              <button onclick="setWithdrawAmount('max')" class="quick-amount">ÂÖ®ÈÉ®</button>
            </div>
          </div>
          
          <div class="fee-calculation">
            <div class="fee-row">
              <span>ÊèêÁé∞ÈáëÈ¢ùÔºö</span>
              <span id="withdrawAmountDisplay">0.00 USDT</span>
            </div>
            <div class="fee-row">
              <span>ÊâãÁª≠Ë¥π (${(withdrawFeeRate * 100).toFixed(1)}%)Ôºö</span>
              <span id="percentFeeDisplay">0.00 USDT</span>
            </div>
            <div class="fee-row">
              <span>Âõ∫ÂÆöÊâãÁª≠Ë¥πÔºö</span>
              <span>2.00 USDT</span>
            </div>
            <div class="fee-row total">
              <span>ÊÄªÊâ£Èô§Ôºö</span>
              <span id="totalDeductDisplay">0.00 USDT</span>
            </div>
          </div>
          
          <div class="wallet-address-check">
            <div>ÊèêÁé∞Âú∞ÂùÄÔºö${localStorage.getItem('walletAddress') || 'Êú™ÁªëÂÆö'}</div>
            ${!localStorage.getItem('walletAddress') ? 
              '<div class="address-warning">ËØ∑ÂÖàÁªëÂÆöÈí±ÂåÖÂú∞ÂùÄ</div>' : ''}
          </div>
        </div>
      `;
      
      showDialog('ÊèêÁé∞Áî≥ËØ∑', withdrawContent, [
        { text: 'Á°ÆËÆ§ÊèêÁé∞', action: () => processWithdraw(), style: 'primary' },
        { text: 'ÂèñÊ∂à', action: 'close' }
      ], 'withdraw');
      
      // ÁªëÂÆöËæìÂÖ•‰∫ã‰ª∂
      setTimeout(() => {
        const amountInput = document.getElementById('withdrawAmount');
        if (amountInput) {
          amountInput.addEventListener('input', updateWithdrawCalculation);
        }
      }, 100);
    }
    
    /**
     * ËÆæÁΩÆÊèêÁé∞ÈáëÈ¢ù
     */
    function setWithdrawAmount(amount) {
      const amountInput = document.getElementById('withdrawAmount');
      if (!amountInput) return;
      
      if (amount === 'max') {
        const maxWithdraw = Math.max(0, (walletBalance - 2) / (1 + withdrawFeeRate));
        amountInput.value = maxWithdraw.toFixed(2);
      } else {
        amountInput.value = amount;
      }
      
      updateWithdrawCalculation();
    }
    
    /**
     * Êõ¥Êñ∞ÊèêÁé∞ËÆ°ÁÆó
     */
    function updateWithdrawCalculation() {
      const amountInput = document.getElementById('withdrawAmount');
      const amount = parseFloat(amountInput?.value || 0);
      
      const percentFee = amount * withdrawFeeRate;
      const fixedFee = 2;
      const totalDeduct = amount + percentFee + fixedFee;
      
      document.getElementById('withdrawAmountDisplay').textContent = `${amount.toFixed(2)} USDT`;
      document.getElementById('percentFeeDisplay').textContent = `${percentFee.toFixed(2)} USDT`;
      document.getElementById('totalDeductDisplay').textContent = `${totalDeduct.toFixed(2)} USDT`;
    }
    
    /**
     * Â§ÑÁêÜÊèêÁé∞
     */
    function processWithdraw() {
      const amountInput = document.getElementById('withdrawAmount');
      const amount = parseFloat(amountInput?.value || 0);
      const walletAddress = localStorage.getItem('walletAddress');
      
      // È™åËØÅ
      if (!walletAddress) {
        showDialog('ÊèêÁé∞Â§±Ë¥•', 'ËØ∑ÂÖàÁªëÂÆöÈí±ÂåÖÂú∞ÂùÄ', [{ text: 'Á°ÆÂÆö', action: 'close' }], 'error');
        return;
      }
      
      if (amount <= 0) {
        showDialog('ÊèêÁé∞Â§±Ë¥•', 'ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÊèêÁé∞ÈáëÈ¢ù', [{ text: 'Á°ÆÂÆö', action: 'close' }], 'error');
        return;
      }
      
      const percentFee = amount * withdrawFeeRate;
      const fixedFee = 2;
      const totalDeduct = amount + percentFee + fixedFee;
      
      if (totalDeduct > walletBalance) {
        showDialog('ÊèêÁé∞Â§±Ë¥•', '‰ΩôÈ¢ù‰∏çË∂≥ÔºåËØ∑ÂáèÂ∞ëÊèêÁé∞ÈáëÈ¢ù', [{ text: 'Á°ÆÂÆö', action: 'close' }], 'error');
        return;
      }
      
      // ÊâßË°åÊèêÁé∞
      walletBalance -= totalDeduct;
      
      // Ê∑ªÂä†ÊèêÁé∞ËÆ∞ÂΩï
      transactions.unshift({
        type: 'withdraw',
        amount: -amount,
        description: 'ÊèêÁé∞Áî≥ËØ∑',
        timestamp: new Date().toISOString(),
        fee: percentFee + fixedFee,
        address: walletAddress,
        status: 'processing'
      });
      
      // ‰øùÂ≠òÁä∂ÊÄÅ
      saveState();
      renderState();
      
      showDialog('ÊèêÁé∞ÊàêÂäü', 
        `ÊèêÁé∞Áî≥ËØ∑Â∑≤Êèê‰∫§\nÊèêÁé∞ÈáëÈ¢ùÔºö${amount.toFixed(2)} USDT\nÊâãÁª≠Ë¥πÔºö${(percentFee + fixedFee).toFixed(2)} USDT\nÈ¢ÑËÆ°24Â∞èÊó∂ÂÜÖÂà∞Ë¥¶`, 
        [{ text: 'Á°ÆÂÆö', action: 'close' }], 'success');
    }
    
    /**
     * ÊòæÁ§∫Âú∞ÂùÄÁªëÂÆöÂØπËØùÊ°Ü
     */
    function showAddressBinding() {
      const currentAddress = localStorage.getItem('walletAddress') || '';
      
      const addressContent = `
        <div class="address-form">
          <div class="form-group">
            <label>USDT TRC20 Èí±ÂåÖÂú∞ÂùÄ</label>
            <input type="text" id="walletAddressInput" placeholder="ËØ∑ËæìÂÖ•USDT TRC20Èí±ÂåÖÂú∞ÂùÄ" 
                   value="${currentAddress}">
            <div class="address-tips">
              <div>‚Ä¢ ‰ªÖÊîØÊåÅUSDT TRC20Âú∞ÂùÄ</div>
              <div>‚Ä¢ Âú∞ÂùÄ‰ª•TÂºÄÂ§¥ÔºåÈïøÂ∫¶‰∏∫34‰Ωç</div>
              <div>‚Ä¢ ËØ∑Á°Æ‰øùÂú∞ÂùÄÊ≠£Á°ÆÔºåÈîôËØØÂú∞ÂùÄÂ∞ÜÂØºËá¥ËµÑ‰∫ß‰∏¢Â§±</div>
            </div>
          </div>
        </div>
      `;
      
      showDialog('ÁªëÂÆöÈí±ÂåÖÂú∞ÂùÄ', addressContent, [
        { text: 'Á°ÆËÆ§ÁªëÂÆö', action: () => saveWalletAddress(), style: 'primary' },
        { text: 'ÂèñÊ∂à', action: 'close' }
      ], 'address');
    }
    
    /**
     * ‰øùÂ≠òÈí±ÂåÖÂú∞ÂùÄ
     */
    function saveWalletAddress() {
      const addressInput = document.getElementById('walletAddressInput');
      const address = addressInput?.value.trim();
      
      if (!address) {
        showDialog('ÁªëÂÆöÂ§±Ë¥•', 'ËØ∑ËæìÂÖ•Èí±ÂåÖÂú∞ÂùÄ', [{ text: 'Á°ÆÂÆö', action: 'close' }], 'error');
        return;
      }
      
      // È™åËØÅUSDT TRC20Âú∞ÂùÄÊ†ºÂºè
      if (!address.startsWith('T') || address.length !== 34) {
        showDialog('ÁªëÂÆöÂ§±Ë¥•', 'ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑUSDT TRC20Èí±ÂåÖÂú∞ÂùÄ', [{ text: 'Á°ÆÂÆö', action: 'close' }], 'error');
        return;
      }
      
      // ‰øùÂ≠òÂú∞ÂùÄ
      localStorage.setItem('walletAddress', address);
      
      showDialog('ÁªëÂÆöÊàêÂäü', 'Èí±ÂåÖÂú∞ÂùÄÁªëÂÆöÊàêÂäüÔºÅ', [{ text: 'Á°ÆÂÆö', action: 'close' }], 'success');
    }
    // ÊéíË°åÊ¶ú
    /**
     * ÊéíË°åÊ¶úÁ≥ªÁªü - ÊòæÁ§∫ÂÜÖÂµåÊéíË°åÊ¶úÂºπÁ™ó
     */
    function showRanking() {
      // ‰øùÂ≠òÂΩìÂâçÁä∂ÊÄÅÂà∞localStorage
      saveState();
      
      // Áõ¥Êé•Ë∑≥ËΩ¨Âà∞ÊéíË°åÊ¶úÈ°µÈù¢
      window.location.href = 'ranking.html';
    }
    function showRedRanking() {
      showDialog('Á∫¢ÂåÖÊéíË°åÊ¶ú', 'ÊåâÁ∫¢ÂåÖÊî∂ÂÖ•USDTÊÄªÈ¢ùÊéíË°å„ÄÇ');
    }
    function showGodRanking() {
      showDialog('Â§ßÁ•ûÊéíË°åÊ¶ú', 'ÊåâÂ§ßÁ•ûÁ≠âÁ∫ßÊéíË°å„ÄÇ');
    }
    /**
     * Â§ßÁ•û‰ªªÂä°Á≥ªÁªü
     */
    function openGodTasks() {
      // Ê£ÄÊü•Â§ßÁ•û‰ªªÂä°ÊòØÂê¶Ëß£ÈîÅ
      const completedNewbieTasks = newTasks.filter(task => task.done).length;
      const quizCorrect = parseInt(localStorage.getItem('quizCorrect')) || 0;
      const quizCompleted = quizCorrect >= 20;
      const godTasksUnlocked = completedNewbieTasks >= 3 && quizCompleted;
      
      if (!godTasksUnlocked) {
        showDialog('Â§ßÁ•û‰ªªÂä°Êú™Ëß£ÈîÅ', 'ÈúÄË¶ÅÂÆåÊàêÊâÄÊúâÊñ∞Êâã‰ªªÂä°ÂíåÁ≠îÈ¢ò‰ªªÂä°ÊâçËÉΩËß£ÈîÅÂ§ßÁ•û‰ªªÂä°„ÄÇ', [
          { text: 'Áü•ÈÅì‰∫Ü', action: 'close' }
        ]);
        return;
      }
      
      // ÊâæÂà∞‰∏ã‰∏Ä‰∏™Êú™ÂÆåÊàêÁöÑÂ§ßÁ•û‰ªªÂä°
      const nextGodTask = godTasks.find(t => !t.done);
      
      if (nextGodTask) {
        // ÊòæÁ§∫Â§ßÁ•û‰ªªÂä°ËØ¶ÊÉÖ
        showDialog('Â§ßÁ•û‰ªªÂä°', `${nextGodTask.title}\n\n${nextGodTask.desc}\n\nÂÆåÊàêÂ•ñÂä±Ôºö${nextGodTask.reward} USDT\n\nÁÇπÂáªÁ°ÆÂÆöÊ†áËÆ∞ÂÆåÊàê`, [
          { text: 'ÂÆåÊàê‰ªªÂä°', action: () => completeGodTask(nextGodTask) },
          { text: 'ÂèñÊ∂à', action: 'close' }
        ]);
      } else {
        // ÊâÄÊúâÂ§ßÁ•û‰ªªÂä°Â∑≤ÂÆåÊàê
        const completedGodTasks = godTasks.filter(t => t.done).length;
        showDialog('Â§ßÁ•û‰ªªÂä°', `ÊÅ≠ÂñúÔºÅÊâÄÊúâÂ§ßÁ•û‰ªªÂä°Â∑≤ÂÆåÊàêÔºÅ\n\nÂ∑≤ÂÆåÊàêÔºö${completedGodTasks}/6\n\nÁªßÁª≠ÈÇÄËØ∑Â•ΩÂèãËé∑ÂæóÊõ¥Â§öÂ•ñÂä±„ÄÇ`, [
          { text: 'Áü•ÈÅì‰∫Ü', action: 'close' }
        ]);
      }
    }

    /**
     * ÂÆåÊàêÂ§ßÁ•û‰ªªÂä°
     */
    function completeGodTask(task) {
      // Ê®°Êãü‰ªªÂä°ÂÆåÊàê
      setTimeout(() => {
        task.done = true;
        
        // ‰ªªÂä°Â•ñÂä±
        walletBalance += task.reward;
        totalEarnings += task.reward;
        
        // ËÆ∞ÂΩï‰∫§Êòì
        transactions.push({ 
          type: 'Â§ßÁ•û‰ªªÂä°Â•ñÂä±', 
          amount: task.reward, 
          fee: 0, 
          net: task.reward, 
          time: new Date().toISOString(),
          desc: `ÂÆåÊàê${task.title}` 
        });
        
        saveState();
        renderState();
        
        // ÊòæÁ§∫‰ªªÂä°ÂÆåÊàêÂºπÁ™ó
        const completedGodTasks = godTasks.filter(t => t.done).length;
        showDialog('Â§ßÁ•û‰ªªÂä°ÂÆåÊàê', `ÊÅ≠ÂñúÂÆåÊàêÂ§ßÁ•û‰ªªÂä°Ôºö${task.title}ÔºÅ\nÂ•ñÂä±Ôºö${task.reward} USDT\nÂΩìÂâç‰ΩôÈ¢ùÔºö${walletBalance.toFixed(2)} USDT\n\nÂ§ßÁ•û‰ªªÂä°ËøõÂ∫¶Ôºö${completedGodTasks}/6`);
        
        // Ê£ÄÊü•ÊòØÂê¶ÊâÄÊúâÂ§ßÁ•û‰ªªÂä°ÈÉΩÂÆåÊàê‰∫Ü
        if (completedGodTasks >= 6) {
          setTimeout(() => {
            showDialog('ÂÖ®ÈÉ®ÂÆåÊàê', 'üéâ ÊÅ≠ÂñúÔºÅÊâÄÊúâÂ§ßÁ•û‰ªªÂä°Â∑≤ÂÆåÊàêÔºÅ\n\nÊÇ®Â∑≤Êàê‰∏∫ÁúüÊ≠£ÁöÑÂ§ßÁ•ûÔºÅ\nÁªßÁª≠ÈÇÄËØ∑Â•ΩÂèãËé∑ÂæóÊõ¥Â§öÂ•ñÂä±„ÄÇ', [
              { text: 'Â§™Ê£í‰∫ÜÔºÅ', action: 'close' }
            ]);
          }, 2000);
        }
      }, 1500);
    }
    /* È´òÁ∫ßÂØπËØùÊ°Ü */
    // ÂºπÁ™óÈòüÂàóÁÆ°ÁêÜ
    let dialogQueue = [];
    let isDialogShowing = false;
    
    function showDialog(title, msg, buttons = null, type = 'normal', callback = null) {
      // Â¶ÇÊûúÂΩìÂâçÊúâÂºπÁ™óÊ≠£Âú®ÊòæÁ§∫ÔºåÂ∞ÜÊñ∞ÂºπÁ™óÂä†ÂÖ•ÈòüÂàó
      if (isDialogShowing) {
        dialogQueue.push({ title, msg, buttons, type, callback });
        return;
      }
      
      isDialogShowing = true;
      const dialog = document.getElementById('dialog');
      const dialogTitle = document.getElementById('dialogTitle');
      const dialogMsg = document.getElementById('dialogMsg');
      const dialogButtons = document.getElementById('dialogButtons');
      
      dialogTitle.innerText = title;
      dialogMsg.innerText = msg;
      
      // Ê†πÊçÆÁ±ªÂûãÊ∑ªÂä†ÁâπÊÆäÊ†∑Âºè
       dialog.className = 'dialog';
       if (title.includes('‰ªªÂä°ÂÆåÊàê') || title.includes('ÊÅ≠Âñú') || title.includes('ÊàêÂäü') || title.includes('Êä¢Á∫¢ÂåÖÊàêÂäü') || title.includes('ÊøÄÊ¥ªÊàêÂäü') || type === 'success') {
         dialog.classList.add('success');
       }
       if (type === 'redpacket') {
         dialog.classList.add('redpacket');
       }
       if (type === 'countdown') {
         dialog.classList.add('countdown');
       }
      
      if (buttons && Array.isArray(buttons)) {
        // Ëá™ÂÆö‰πâÊåâÈíÆ
        dialogButtons.innerHTML = '';
        buttons.forEach(button => {
          const btn = document.createElement('button');
          btn.textContent = button.text;
          btn.className = button.style === 'danger' ? 'danger-btn' : (button.style === 'secondary' ? 'secondary-btn' : '');
          btn.onclick = () => {
            closeDialog(() => {
              // Â§ÑÁêÜWebSocketÊ∂àÊÅØ‰∏≠ÁöÑÁâπÊÆäÂä®‰Ωú
              if (button.action === 'grabRedPacket') {
                grabRedPacket();
              } else if (button.action === 'showTasks') {
                // ÊòæÁ§∫‰ªªÂä°È°µÈù¢Êàñ‰ªªÂä°ÂºπÁ™ó
                showTasks();
              } else if (button.action === 'close') {
                // ‰ªÖÂÖ≥Èó≠ÂºπÁ™óÔºåÊó†ÂÖ∂‰ªñÂä®‰Ωú
              } else if (button.action) {
                button.action();
              }
              if (callback) {
                callback();
              }
            });
          };
          dialogButtons.appendChild(btn);
        });
      } else {
        // ÈªòËÆ§Á°ÆÂÆöÊåâÈíÆ
        dialogButtons.innerHTML = '';
        const defaultBtn = document.createElement('button');
        defaultBtn.textContent = 'Á°ÆÂÆö';
        defaultBtn.onclick = () => {
          closeDialog(callback);
        };
        dialogButtons.appendChild(defaultBtn);
      }
      
      // ÊòæÁ§∫ÂºπÁ™óÂπ∂Ê∑ªÂä†Âä®Áîª
      dialog.style.display = 'flex';
      setTimeout(() => {
        dialog.classList.add('show');
      }, 10);
    }
    
    function closeDialog(callback = null) {
      const dialog = document.getElementById('dialog');
      dialog.classList.remove('show');
      setTimeout(() => {
        dialog.style.display = 'none';
        dialog.className = 'dialog'; // ÈáçÁΩÆÁ±ªÂêç
        isDialogShowing = false;
        
        if (callback) {
          callback();
        }
        
        // Â§ÑÁêÜÈòüÂàó‰∏≠ÁöÑ‰∏ã‰∏Ä‰∏™ÂºπÁ™óÔºåÊ∑ªÂä†500msÂª∂ËøüÈÅøÂÖçËßÜËßâÂÜ≤Á™Å
        if (dialogQueue.length > 0) {
          setTimeout(() => {
            const nextDialog = dialogQueue.shift();
            showDialog(nextDialog.title, nextDialog.msg, nextDialog.buttons, nextDialog.type, nextDialog.callback);
          }, 500);
        }
      }, 300);
    }

    /**
     * ÊòæÁ§∫ÊîØ‰ªòÂØπËØùÊ°Ü
     * @param {Object} activationData - ÊøÄÊ¥ªÊï∞ÊçÆÔºåÂåÖÂê´Èí±ÂåÖÂú∞ÂùÄ„ÄÅÈáëÈ¢ù„ÄÅËÆ¢ÂçïIDÁ≠â
     */
    function showPaymentDialog(activationData) {
      const { walletAddress, amount, orderId, expiresAt } = activationData;
      
      // ÂàõÂª∫ÊîØ‰ªòÂØπËØùÊ°ÜHTML
      const paymentDialogHTML = `
        <div id="paymentDialog" class="payment-dialog">
          <div class="payment-box">
            <div class="payment-header">
              <h3>üí∞ ÊøÄÊ¥ªË¥¶Âè∑ÊîØ‰ªò</h3>
              <button class="close-btn" onclick="closePaymentDialog()">√ó</button>
            </div>
            
            <div class="payment-info">
              <div class="amount-section">
                <div class="amount-label">ÊîØ‰ªòÈáëÈ¢ù</div>
                <div class="amount-value">${amount} USDT</div>
              </div>
              
              <div class="wallet-section">
                <div class="wallet-label">Êî∂Ê¨æÂú∞ÂùÄ (TRC20)</div>
                <div class="wallet-address" id="paymentWalletAddress">${walletAddress}</div>
                <button class="copy-btn" onclick="copyWalletAddress()">Â§çÂà∂Âú∞ÂùÄ</button>
              </div>
              
              <div class="qr-section">
                <div class="qr-label">Êâ´Á†ÅÊîØ‰ªò</div>
                <div class="qr-code" id="paymentQRCode">
                  <canvas id="qrCanvas"></canvas>
                </div>
              </div>
              
              <div class="countdown-section">
                <div class="countdown-label">ÊîØ‰ªòÂâ©‰ΩôÊó∂Èó¥</div>
                <div class="countdown-timer" id="paymentCountdown">30:00</div>
              </div>
              
              <div class="order-section">
                <div class="order-label">ËÆ¢ÂçïÂè∑</div>
                <div class="order-id">${orderId}</div>
              </div>
            </div>
            
            <div class="payment-status">
              <div class="status-indicator" id="paymentStatus">
                <div class="loading-spinner"></div>
                <span>Á≠âÂæÖÊîØ‰ªò‰∏≠...</span>
              </div>
            </div>
            
            <div class="payment-tips">
              <p>‚ö†Ô∏è ËØ∑Âä°ÂøÖ‰ΩøÁî®TRC20ÁΩëÁªúËΩ¨Ë¥¶</p>
              <p>üí° ÊîØ‰ªòÂÆåÊàêÂêéÁ≥ªÁªüÂ∞ÜËá™Âä®Á°ÆËÆ§</p>
              <p>üîÑ ÊîØ‰ªòÁä∂ÊÄÅÊØè10ÁßíËá™Âä®Ê£ÄÊü•‰∏ÄÊ¨°</p>
            </div>
          </div>
        </div>
      `;
      
      // Ê∑ªÂä†Âà∞È°µÈù¢
      document.body.insertAdjacentHTML('beforeend', paymentDialogHTML);
      
      // ÁîüÊàê‰∫åÁª¥Á†Å
      generatePaymentQRCode(walletAddress, amount);
      
      // ÂºÄÂßãÂÄíËÆ°Êó∂
      startPaymentCountdown(expiresAt);
      
      // ÂºÄÂßãÁõëÊéßÊîØ‰ªòÁä∂ÊÄÅ
      startPaymentMonitoring(orderId);
      
      // ÊòæÁ§∫ÂØπËØùÊ°Ü
      const paymentDialog = document.getElementById('paymentDialog');
      setTimeout(() => {
        paymentDialog.classList.add('show');
      }, 100);
    }

    /**
     * ÁîüÊàêÊîØ‰ªò‰∫åÁª¥Á†Å
     * @param {string} walletAddress - Èí±ÂåÖÂú∞ÂùÄ
     * @param {number} amount - ÊîØ‰ªòÈáëÈ¢ù
     */
    function generatePaymentQRCode(walletAddress, amount) {
      try {
        // ÊûÑÂª∫TRONÊîØ‰ªòÈìæÊé•
        const qrText = `tron:${walletAddress}?amount=${amount}&token=TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t`;
        const canvas = document.getElementById('qrCanvas');
        
        // ‰ΩøÁî®Âú®Á∫ø‰∫åÁª¥Á†ÅÁîüÊàêÊúçÂä°‰Ωú‰∏∫‰∏¥Êó∂Ëß£ÂÜ≥ÊñπÊ°à
        const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(qrText)}`;
        
        // ÂàõÂª∫‰∫åÁª¥Á†ÅÂõæÁâá
        const qrImage = document.createElement('img');
        qrImage.src = qrCodeUrl;
        qrImage.style.width = '200px';
        qrImage.style.height = '200px';
        qrImage.alt = 'ÊîØ‰ªò‰∫åÁª¥Á†Å';
        
        // ÊõøÊç¢canvas‰∏∫ÂõæÁâá
        const qrContainer = document.getElementById('paymentQRCode');
        qrContainer.innerHTML = '';
        qrContainer.appendChild(qrImage);
        
        // Ê∑ªÂä†ÊèêÁ§∫‰ø°ÊÅØ
        const qrTip = document.createElement('div');
        qrTip.style.marginTop = '10px';
        qrTip.style.fontSize = '12px';
        qrTip.style.color = '#666';
        qrTip.textContent = `Êâ´Á†ÅÊîØ‰ªò ${amount} USDT`;
        qrContainer.appendChild(qrTip);
        
      } catch (error) {
        console.error('ÁîüÊàê‰∫åÁª¥Á†ÅÂ§±Ë¥•:', error);
        document.getElementById('paymentQRCode').innerHTML = '<div class="qr-error">‰∫åÁª¥Á†ÅÁîüÊàêÂ§±Ë¥•</div>';
      }
    }

    /**
     * ÂºÄÂßãÊîØ‰ªòÂÄíËÆ°Êó∂
     * @param {string} expiresAt - ËøáÊúüÊó∂Èó¥
     */
    /**
     * ÂºÄÂßãÊîØ‰ªòÂÄíËÆ°Êó∂
     * @param {string|Date|number} expiresAt - ËøáÊúüÊó∂Èó¥
     */
    function startPaymentCountdown(expiresAt) {
      const countdownElement = document.getElementById('paymentCountdown');
      
      // Â§ÑÁêÜ‰∏çÂêåÊ†ºÂºèÁöÑËøáÊúüÊó∂Èó¥
      let expiryTime;
      if (!expiresAt) {
        // Â¶ÇÊûúÊ≤°ÊúâÊèê‰æõËøáÊúüÊó∂Èó¥ÔºåÈªòËÆ§30ÂàÜÈíü
        expiryTime = Date.now() + (30 * 60 * 1000);
      } else if (typeof expiresAt === 'number') {
        expiryTime = expiresAt;
      } else {
        expiryTime = new Date(expiresAt).getTime();
      }
      
      // È™åËØÅÊó∂Èó¥ÊòØÂê¶ÊúâÊïà
      if (isNaN(expiryTime)) {
        console.warn('Êó†ÊïàÁöÑËøáÊúüÊó∂Èó¥Ôºå‰ΩøÁî®ÈªòËÆ§30ÂàÜÈíü:', expiresAt);
        expiryTime = Date.now() + (30 * 60 * 1000);
      }
      
      const countdownInterval = setInterval(() => {
        const now = Date.now();
        const timeLeft = expiryTime - now;
        
        if (timeLeft <= 0) {
          clearInterval(countdownInterval);
          countdownElement.textContent = 'Â∑≤ËøáÊúü';
          countdownElement.style.color = '#ff4444';
          
          // ÊòæÁ§∫ËøáÊúüÊèêÁ§∫
          const statusElement = document.getElementById('paymentStatus');
          if (statusElement) {
            statusElement.innerHTML = '<span style="color: #ff4444;">‚è∞ ÊîØ‰ªòÂ∑≤ËøáÊúü</span>';
          }
          
          return;
        }
        
        const minutes = Math.floor(timeLeft / (1000 * 60));
        const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
        
        // Á°Æ‰øùÊï∞Â≠óÊúâÊïà
        const displayMinutes = isNaN(minutes) ? 0 : minutes;
        const displaySeconds = isNaN(seconds) ? 0 : seconds;
        
        countdownElement.textContent = `${displayMinutes.toString().padStart(2, '0')}:${displaySeconds.toString().padStart(2, '0')}`;
      }, 1000);
      
      // ‰øùÂ≠òÂÄíËÆ°Êó∂ID‰ª•‰æøÊ∏ÖÁêÜ
      window.paymentCountdownInterval = countdownInterval;
    }

    /**
     * ÂºÄÂßãÁõëÊéßÊîØ‰ªòÁä∂ÊÄÅ
     * @param {string} orderId - ËÆ¢ÂçïID
     */
    function startPaymentMonitoring(orderId) {
      let checkCount = 0;
      const maxChecks = 180; // ÊúÄÂ§öÊ£ÄÊü•30ÂàÜÈíüÔºàÊØè10Áßí‰∏ÄÊ¨°Ôºâ
      
      const monitoringInterval = setInterval(async () => {
        checkCount++;
        
        if (checkCount > maxChecks) {
          clearInterval(monitoringInterval);
          const statusElement = document.getElementById('paymentStatus');
          statusElement.innerHTML = '<span style="color: #ff4444;">‚è∞ ÁõëÊéßË∂ÖÊó∂</span>';
          return;
        }
        
        try {
          // Ë∞ÉÁî®ÂêéÁ´ØAPIÊ£ÄÊü•ÊîØ‰ªòÁä∂ÊÄÅ
          const response = await fetch(`/api/activation/status/${orderId}`, {
            method: 'GET',
            headers: {
              'Authorization': `Bearer ${localStorage.getItem('authToken') || 'demo-token'}`,
              'Content-Type': 'application/json'
            }
          });
          
          if (response.ok) {
            const statusData = await response.json();
            const { status, txHash } = statusData;
            
            const statusElement = document.getElementById('paymentStatus');
            
            switch (status) {
              case 'pending':
                statusElement.innerHTML = '<div class="loading-spinner"></div><span>Á≠âÂæÖÊîØ‰ªò‰∏≠...</span>';
                break;
              case 'confirming':
                statusElement.innerHTML = '<div class="loading-spinner"></div><span>üîÑ ‰∫§ÊòìÁ°ÆËÆ§‰∏≠...</span>';
                break;
              case 'confirmed':
                // ÊîØ‰ªòÊàêÂäü
                clearInterval(monitoringInterval);
                if (window.paymentCountdownInterval) {
                  clearInterval(window.paymentCountdownInterval);
                }
                
                statusElement.innerHTML = '<span style="color: #00ff88;">‚úÖ ÊîØ‰ªòÊàêÂäüÔºÅ</span>';
                
                // Âª∂ËøüÂÖ≥Èó≠ÊîØ‰ªòÂØπËØùÊ°ÜÂπ∂Êõ¥Êñ∞Áî®Êà∑Áä∂ÊÄÅ
                setTimeout(() => {
                  closePaymentDialog();
                  handlePaymentSuccess(txHash);
                }, 2000);
                break;
              case 'failed':
                clearInterval(monitoringInterval);
                statusElement.innerHTML = '<span style="color: #ff4444;">‚ùå ÊîØ‰ªòÂ§±Ë¥•</span>';
                break;
            }
          }
        } catch (error) {
          console.error('Ê£ÄÊü•ÊîØ‰ªòÁä∂ÊÄÅÂ§±Ë¥•:', error);
          // ÁªßÁª≠ÁõëÊéßÔºå‰∏ç‰∏≠Êñ≠
        }
      }, 10000); // ÊØè10ÁßíÊ£ÄÊü•‰∏ÄÊ¨°
      
      // ‰øùÂ≠òÁõëÊéßID‰ª•‰æøÊ∏ÖÁêÜ
      window.paymentMonitoringInterval = monitoringInterval;
    }

    /**
     * Â§ÑÁêÜÊîØ‰ªòÊàêÂäü
     * @param {string} txHash - ‰∫§ÊòìÂìàÂ∏å
     */
    function handlePaymentSuccess(txHash) {
      // Êõ¥Êñ∞Áî®Êà∑Áä∂ÊÄÅÂà∞Áä∂ÊÄÅ2
      currentState = 2;
      countdownStart = Date.now();
      inviteStart = Date.now();
      
      // ËÆ∞ÂΩï‰∫§Êòì
      const transaction = {
        id: Date.now().toString(),
        type: 'activation',
        amount: 100,
        status: 'completed',
        txHash: txHash,
        timestamp: Date.now(),
        description: 'Ë¥¶Âè∑ÊøÄÊ¥ª'
      };
      
      transactions.unshift(transaction);
      
      // ‰øùÂ≠òÁä∂ÊÄÅ
      saveState();
      
      // ÈáçÊñ∞Ê∏≤ÊüìÈ°µÈù¢
      renderState();
      
      // ÊòæÁ§∫ÊàêÂäüÊèêÁ§∫
      showDialog('ÊøÄÊ¥ªÊàêÂäü', 'üéâ ÊÅ≠ÂñúÔºÅË¥¶Âè∑ÊøÄÊ¥ªÊàêÂäüÔºÅ\n\nÊÇ®Áé∞Âú®ÂèØ‰ª•ÂºÄÂßãÊåëÊàò‰ªªÂä°ÔºåÈÇÄËØ∑Â•ΩÂèãËé∑ÂæóÂ•ñÂä±ÔºÅ', [
        { text: 'ÂºÄÂßãÊåëÊàò', action: 'close' }
      ], 'success');
    }

    /**
     * Â§çÂà∂Èí±ÂåÖÂú∞ÂùÄ
     */
    function copyWalletAddress() {
      const walletAddress = document.getElementById('paymentWalletAddress').textContent;
      
      if (navigator.clipboard) {
        navigator.clipboard.writeText(walletAddress).then(() => {
          showDialog('Â§çÂà∂ÊàêÂäü', 'Èí±ÂåÖÂú∞ÂùÄÂ∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø');
        }).catch(() => {
          fallbackCopyWalletAddress(walletAddress);
        });
      } else {
        fallbackCopyWalletAddress(walletAddress);
      }
    }

    /**
     * ÈôçÁ∫ßÂ§çÂà∂Èí±ÂåÖÂú∞ÂùÄÊñπÊ°à
     * @param {string} address - Èí±ÂåÖÂú∞ÂùÄ
     */
    function fallbackCopyWalletAddress(address) {
      const textArea = document.createElement('textarea');
      textArea.value = address;
      document.body.appendChild(textArea);
      textArea.select();
      
      try {
        document.execCommand('copy');
        showDialog('Â§çÂà∂ÊàêÂäü', 'Èí±ÂåÖÂú∞ÂùÄÂ∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø');
      } catch (err) {
        showDialog('Â§çÂà∂Â§±Ë¥•', 'ËØ∑ÊâãÂä®Â§çÂà∂Èí±ÂåÖÂú∞ÂùÄ');
      }
      
      document.body.removeChild(textArea);
    }

    /**
     * ÂÖ≥Èó≠ÊîØ‰ªòÂØπËØùÊ°Ü
     */
    function closePaymentDialog() {
      const paymentDialog = document.getElementById('paymentDialog');
      if (paymentDialog) {
        paymentDialog.classList.remove('show');
        
        // Ê∏ÖÁêÜÂÆöÊó∂Âô®
        if (window.paymentCountdownInterval) {
          clearInterval(window.paymentCountdownInterval);
        }
        if (window.paymentMonitoringInterval) {
          clearInterval(window.paymentMonitoringInterval);
        }
        
        setTimeout(() => {
          paymentDialog.remove();
        }, 300);
      }
    }

    /**
     * ÈáçÁΩÆÊµãËØïÊï∞ÊçÆ
     */
    /**
     * ÈáçÁΩÆÁî®Êà∑Êï∞ÊçÆ - Â∑≤ÁßªÈô§ÂäüËÉΩ
     */
    /*
    async function resetTestData() {
      if(confirm('Á°ÆÂÆöË¶ÅÈáçÁΩÆÊâÄÊúâÊï∞ÊçÆÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄ„ÄÇ')) {
        try {
          // Ë∞ÉÁî®ÂêéÁ´ØAPIÈáçÁΩÆÁî®Êà∑Êï∞ÊçÆ
          const response = await apiRequest('/api/user/reset', {
            method: 'POST'
          });
          
          if (response.success) {
            // Ê∏ÖÁ©∫Êú¨Âú∞Â≠òÂÇ®
            localStorage.removeItem('userTasks');
            localStorage.removeItem('quizCompleted');
            localStorage.removeItem('godTasksCompleted');
            localStorage.removeItem('userBalance');
            localStorage.removeItem('teamSize');
            localStorage.removeItem('quizIndex');
            localStorage.removeItem('quizCorrect');
            localStorage.removeItem('transactions');
            localStorage.removeItem('appState');
            localStorage.removeItem('teamData');
            localStorage.removeItem('recentRed');
            
            // ÈáçÁΩÆÂÖ®Â±ÄÂèòÈáèÂà∞ÂàùÂßãÁä∂ÊÄÅ
            transactions = [];
            userLevel = 0;
            completedNewbieTasks = 0;
            godTasksUnlocked = false;
            teamMembers = 0;
            totalEarnings = 0;
            withdrawFeeRate = 0.05;
            walletBalance = 0;
            countdownStart = null;
            inviteStart = null;
            
            // ÈáçÁΩÆÂà∞Áä∂ÊÄÅ1
            currentState = 1;
            
            // ÈáçÊñ∞ÂêåÊ≠•Êï∞ÊçÆÂπ∂Ê∏≤ÊüìÈ°µÈù¢
            await syncWithBackend();
            renderState();
            
            showDialog('ÈáçÁΩÆÊàêÂäü', 'Áî®Êà∑Êï∞ÊçÆÂ∑≤ÈáçÁΩÆÔºåËØ∑ÈáçÊñ∞ÂºÄÂßãÊåëÊàò„ÄÇ');
          } else {
            throw new Error(response.message || 'ÈáçÁΩÆÂ§±Ë¥•');
          }
        } catch (error) {
          console.error('ÈáçÁΩÆÊï∞ÊçÆÂ§±Ë¥•:', error);
          showDialog('ÈáçÁΩÆÂ§±Ë¥•', 'ÁΩëÁªúÈîôËØØÔºåËØ∑Á®çÂêéÈáçËØï„ÄÇ');
        }
      }
    }
    */

    /**
     * Âº∫Âà∂È£éÊ†ºÈÄâÊã©ÂºπÁ™ó
     */
    function showForceThemeSelection(teamSize, balance) {
      const themes = {
        'cyberpunk': { name: 'ËµõÂçöÊúãÂÖã', icon: 'üåÜ', description: 'Êú™Êù•ÁßëÊäÄÊÑü' },

        'business': { name: 'ÂïÜÂä°Ëìù', icon: 'üíº', description: '‰∏ì‰∏öÁ®≥Èáç' },
        'dark-tech': { name: 'ÊöóÈªëÁßëÊäÄ', icon: '‚ö°', description: 'Á•ûÁßòÈÖ∑ÁÇ´' },
        'fresh': { name: 'Ê∏ÖÊñ∞Áªø', icon: 'üåø', description: 'Ëá™ÁÑ∂Ê∏ÖÊñ∞' }
      };
      
      const themeOptionsHTML = Object.entries(themes).map(([key, theme]) => `
        <div class="force-theme-option" data-theme="${key}">
          <span class="force-theme-icon">${theme.icon}</span>
          <div class="force-theme-info">
            <div class="force-theme-name">${theme.name}</div>
            <div class="force-theme-desc">${theme.description}</div>
          </div>
        </div>
      `).join('');
      
      const modalHTML = `
        <div id="forceThemeModal" class="force-theme-modal">
          <div class="force-theme-content">
            <div class="force-theme-header">
              <h2>üé® ÈÄâÊã©ÊÇ®ÁöÑ‰∏ìÂ±ûÈ£éÊ†º</h2>
              <p>Êï∞ÊçÆÈáçÁΩÆÊàêÂäüÔºÅËØ∑ÈÄâÊã©‰∏Ä‰∏™È£éÊ†º‰∏ªÈ¢òÁªßÁª≠‰ΩøÁî®</p>
            </div>
            <div class="force-theme-options">
              ${themeOptionsHTML}
            </div>
            <div class="force-theme-footer">
              <p class="force-theme-info-text">Âõ¢Èòü‰∫∫Êï∞Ôºö${teamSize}‰∫∫ | ‰ΩôÈ¢ùÔºö${balance} USDT | ÊâÄÊúâ‰ªªÂä°Â∑≤ÈáçÁΩÆ</p>
            </div>
          </div>
        </div>
      `;
      
      // Ê∑ªÂä†Ê†∑Âºè
      const styleHTML = `
        <style>
        .force-theme-modal {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.8);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 10000;
          backdrop-filter: blur(10px);
        }
        .force-theme-content {
          background: var(--bg-card);
          border-radius: 20px;
          padding: 24px;
          max-width: 400px;
          width: 90%;
          box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
          border: 1px solid var(--border-color);
        }
        .force-theme-header {
          text-align: center;
          margin-bottom: 20px;
        }
        .force-theme-header h2 {
          color: var(--text-primary);
          margin: 0 0 8px 0;
          font-size: 20px;
        }
        .force-theme-header p {
          color: var(--text-secondary);
          margin: 0;
          font-size: 14px;
        }
        .force-theme-options {
          display: flex;
          flex-direction: column;
          gap: 8px;
          margin-bottom: 20px;
        }
        .force-theme-option {
          display: flex;
          align-items: center;
          gap: 12px;
          padding: 12px;
          border: 2px solid var(--border-color);
          border-radius: 12px;
          cursor: pointer;
          transition: all 0.3s ease;
          background: var(--bg-secondary);
        }
        .force-theme-option:hover {
          border-color: var(--accent-color);
          transform: translateY(-2px);
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        .force-theme-option.selected {
          border-color: var(--accent-color);
          background: var(--btn-gradient);
          color: var(--text-primary);
        }
        .force-theme-icon {
          font-size: 24px;
          width: 32px;
          text-align: center;
        }
        .force-theme-info {
          flex: 1;
        }
        .force-theme-name {
          font-weight: 600;
          font-size: 16px;
          margin-bottom: 2px;
        }
        .force-theme-desc {
          font-size: 12px;
          opacity: 0.8;
        }
        .force-theme-footer {
          text-align: center;
        }
        .force-theme-info-text {
          font-size: 12px;
          color: var(--text-secondary);
          margin: 0;
        }
        </style>
      `;
      
      // ÊèíÂÖ•Ê†∑ÂºèÂíåÊ®°ÊÄÅÊ°Ü
      document.head.insertAdjacentHTML('beforeend', styleHTML);
      document.body.insertAdjacentHTML('beforeend', modalHTML);
      
      // ÁªëÂÆö‰∫ã‰ª∂
      const modal = document.getElementById('forceThemeModal');
      const options = document.querySelectorAll('.force-theme-option');
      
      options.forEach(option => {
        option.addEventListener('click', () => {
          const selectedTheme = option.getAttribute('data-theme');
          
          // Â∫îÁî®ÈÄâ‰∏≠ÁöÑ‰∏ªÈ¢ò
          if (window.themeSwitcher) {
            window.themeSwitcher.switchTheme(selectedTheme);
          } else {
            document.documentElement.setAttribute('data-theme', selectedTheme === 'cyberpunk' ? '' : selectedTheme);
            localStorage.setItem('selectedTheme', selectedTheme);
          }
          
          // ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
          modal.remove();
          
          // ÊòæÁ§∫ÊàêÂäü‰ø°ÊÅØ
          const themeName = themes[selectedTheme].name;
          showDialog('È£éÊ†ºËÆæÁΩÆÊàêÂäü', `Â∑≤ÂàáÊç¢Ëá≥${themeName}È£éÊ†º\nÂõ¢Èòü‰∫∫Êï∞Ôºö${teamSize}‰∫∫\n‰ΩôÈ¢ùÔºö${balance} USDT\nÊâÄÊúâ‰ªªÂä°Â∑≤ÈáçÁΩÆ`);
        });
      });
    }

    /**
     * Ê®°ÊÄÅÂºπÁ™óÁÆ°ÁêÜ
     */
    const modal = document.getElementById('modal');
    const modalClose = document.getElementById('modalClose');
    const modalBody = document.getElementById('modalBody');
    modalClose.addEventListener('click', () => {
      modal.style.display = 'none';
    });
    function openModal(type) {
      let html = '';
      if(type === 'task') {
        const currentTask = newTasks.find(t => !t.done);
        if(currentTask) {
          html += `<h3 style="margin-top:0;color:var(--brand)">${currentTask.title}</h3>`;
          html += `<p style="font-size:14px;color:var(--muted)">${currentTask.desc ? currentTask.desc : 'ÂÆåÊàêÊ≠§‰ªªÂä°ÂèØÊé®ËøõËøõÂ∫¶„ÄÇ'}</p>`;
          html += `<button class="btn" id="modalTaskDone" style="margin-top:16px;width:100%">Ê†áËÆ∞ÂÆåÊàê</button>`;
        } else {
          html += `<h3 style="margin-top:0;color:var(--brand)">ÊâÄÊúâÊñ∞Êâã‰ªªÂä°Â∑≤ÂÆåÊàê</h3>`;
          html += `<p style="font-size:14px;color:var(--muted)">Êó†ÈúÄÂÜçÊâßË°åÊñ∞Êâã‰ªªÂä°„ÄÇ</p>`;
        }
      } else if(type === 'wallet') {
        html += `<h3 style="margin-top:0;color:var(--brand)">ÊàëÁöÑÈí±ÂåÖ</h3>`;
        html += `<p style="font-size:14px;color:var(--muted)">ÂΩìÂâç‰ΩôÈ¢ùÔºö-- USDT</p>`;
        html += `<button class="btn" style="margin-top:16px;width:100%">ÊèêÁé∞</button>`;
      } else if(type === 'team') {
        html += `<h3 style="margin-top:0;color:var(--brand)">ÊàëÁöÑÂõ¢Èòü</h3>`;
        html += `<div style="font-size:14px;color:var(--muted)">
          <p>Âõ¢ÈòüÊÄª‰∫∫Êï∞Ôºö<span id="teamTotalCount">--</span></p>
          <p>Áõ¥Êé®‰∫∫Êï∞Ôºö<span id="directCount">--</span></p>
          <p>Âõ¢Èòü‰∏öÁª©Ôºö<span id="teamPerformance">-- USDT</span></p>
        </div>`;
      } else if(type === 'ranking') {
        html += `<h3 style="margin-top:0;color:var(--brand)">ÊéíË°åÊ¶ú</h3>`;
        html += `<div style="font-size:14px;color:var(--muted)">
          <div style="margin-bottom:16px">
            <h4 style="margin:0 0 8px 0;color:var(--brand)">Âõ¢ÈòüÊéíË°å</h4>
            <p>ÊöÇÊó†Êï∞ÊçÆ</p>
          </div>
          <div style="margin-bottom:16px">
            <h4 style="margin:0 0 8px 0;color:var(--brand)">Á∫¢ÂåÖÊéíË°å</h4>
            <p>ÊöÇÊó†Êï∞ÊçÆ</p>
          </div>
          <div>
            <h4 style="margin:0 0 8px 0;color:var(--brand)">Â§ßÁ•ûÊéíË°å</h4>
            <p>ÊöÇÊó†Êï∞ÊçÆ</p>
          </div>
        </div>`;
      }
      modalBody.innerHTML = html;
      modal.style.display = 'flex';
      // ÁªëÂÆö‰ªªÂä°ÂÆåÊàêÊåâÈíÆ
      const completeBtn = document.getElementById('modalTaskDone');
      if(completeBtn) {
        completeBtn.addEventListener('click', () => {
          const task = newTasks.find(t => !t.done);
          if(task) task.done = true;
          modal.style.display = 'none';
          renderState();
        });
      }
    }

    // ÈÄÄÂá∫ÁôªÂΩïÂäüËÉΩ
    // Á°ÆËÆ§ÈÄÄÂá∫ÁôªÂΩï
    function confirmLogout() {
      // ÂÖàÂÖ≥Èó≠ËÆæÁΩÆÁïåÈù¢
      closeSettings();
      
      // ÁÑ∂ÂêéÊòæÁ§∫Á°ÆËÆ§ÈÄÄÂá∫ÂØπËØùÊ°Ü
      showDialog('Á°ÆËÆ§ÈÄÄÂá∫', 'ÈÄÄÂá∫ÁôªÂΩïÂ∞ÜÊ∏ÖÈô§ÊâÄÊúâÊú¨Âú∞Êï∞ÊçÆÔºåÁ°ÆÂÆöË¶ÅÁªßÁª≠ÂêóÔºü', [
        {
          text: 'ÂèñÊ∂à',
          style: 'secondary',
          action: () => {}
        },
        {
          text: 'Á°ÆËÆ§ÈÄÄÂá∫',
          style: 'danger',
          action: logout
        }
      ]);
    }
    
    function logout() {
      // Ê∏ÖÈô§ÊâÄÊúâÁî®Êà∑Áõ∏ÂÖ≥ÁöÑÊú¨Âú∞Â≠òÂÇ®Êï∞ÊçÆ
      localStorage.removeItem('userEmail');
      localStorage.removeItem('userPassword');
      localStorage.removeItem('appState');
      localStorage.removeItem('userInviteCode');
      localStorage.removeItem('teamData');
      localStorage.removeItem('language');
      localStorage.removeItem('userStatus');
      localStorage.removeItem('inviteCode');
      
      // Áõ¥Êé•Ë∑≥ËΩ¨Âà∞ÁôªÂΩïÈ°µÈù¢
      window.location.href = 'login.html';
    }
    
    // ÊòæÁ§∫Â∏ÆÂä©‰ø°ÊÅØ

    
    // ÊòæÁ§∫BugÊä•Âëä
    function showBugReport() {
      closeSettings();
      // ÊòæÁ§∫BugÊä•ÂëäÂºπÁ™ó
      const modal = document.getElementById('messageModal');
      modal.style.display = 'flex';
      // Áõ¥Êé•ÂàáÊç¢Âà∞BugÊä•ÂëäÊ†áÁ≠æÈ°µ
      switchMessageTab('bug');
    }
    
    // ÊòæÁ§∫ÂÖ≥‰∫é‰ø°ÊÅØ
    function showAbout() {
      closeSettings();
      showDialog('ÂÖ≥‰∫éÊàë‰ª¨', 'Ë£ÇÈáë7Êó• H5Â∫îÁî®\n\nÁâàÊú¨Ôºöv1.0.0\nÊõ¥Êñ∞Êó∂Èó¥Ôºö2024Âπ¥1Êúà\n\nÂºÄÂèëÂõ¢ÈòüËá¥Âäõ‰∫é‰∏∫Áî®Êà∑Êèê‰æõ\nÊúÄ‰Ω≥ÁöÑ‰∫íÂä®‰ΩìÈ™å');
    }

    // ËÆæÁΩÆÈù¢ÊùøÂäüËÉΩÂ∑≤ÁßªËá≥scriptÂºÄÂ§¥

    // ‰∏ªÈ¢òÂàáÊç¢ÂäüËÉΩ
    function selectTheme(theme) {
      // ÁßªÈô§ÊâÄÊúâ‰∏ªÈ¢òÊåâÈíÆÁöÑactiveÁä∂ÊÄÅ
      document.querySelectorAll('.theme-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      
      // ÊøÄÊ¥ªÈÄâ‰∏≠ÁöÑ‰∏ªÈ¢òÊåâÈíÆ
      event.target.classList.add('active');
      
      // ‰øùÂ≠ò‰∏ªÈ¢òËÆæÁΩÆ
      localStorage.setItem('theme', theme);
      
      // Â∫îÁî®‰∏ªÈ¢òÔºàËøôÈáåÂèØ‰ª•Ê∑ªÂä†ÂÆûÈôÖÁöÑ‰∏ªÈ¢òÂàáÊç¢ÈÄªËæëÔºâ
      showDialog('‰∏ªÈ¢òËÆæÁΩÆ', `Â∑≤ÂàáÊç¢Âà∞${theme}‰∏ªÈ¢ò`);
    }
    
    // ToggleÂºÄÂÖ≥ÂäüËÉΩ
    function toggleSwitch(switchId) {
      const toggle = document.getElementById(switchId);
      const isChecked = toggle.checked;
      
      // ‰øùÂ≠òËÆæÁΩÆ
      localStorage.setItem(switchId, isChecked);
      
      // Ê†πÊçÆ‰∏çÂêåÁöÑÂºÄÂÖ≥ÊâßË°å‰∏çÂêåÁöÑÈÄªËæë
      switch(switchId) {
        case 'soundToggle':
          showDialog('Â£∞Èü≥ËÆæÁΩÆ', isChecked ? 'Â∑≤ÂºÄÂêØÂ£∞Èü≥ÊïàÊûú' : 'Â∑≤ÂÖ≥Èó≠Â£∞Èü≥ÊïàÊûú');
          break;
        case 'vibrationToggle':
          showDialog('ÈúáÂä®ËÆæÁΩÆ', isChecked ? 'Â∑≤ÂºÄÂêØÈúáÂä®ÂèçÈ¶à' : 'Â∑≤ÂÖ≥Èó≠ÈúáÂä®ÂèçÈ¶à');
          break;
        case 'notificationToggle':
          showDialog('ÈÄöÁü•ËÆæÁΩÆ', isChecked ? 'Â∑≤ÂºÄÂêØÊé®ÈÄÅÈÄöÁü•' : 'Â∑≤ÂÖ≥Èó≠Êé®ÈÄÅÈÄöÁü•');
          break;
      }
    }
    
    // ËØ≠Ë®ÄÂàáÊç¢ÂäüËÉΩ
    function changeLanguage() {
      const select = document.getElementById('languageSelect');
      const selectedLanguage = select.value;
      const selectedText = select.options[select.selectedIndex].text;
      
      localStorage.setItem('language', selectedLanguage);
      showDialog('ËØ≠Ë®ÄËÆæÁΩÆ', `Â∑≤ÂàáÊç¢Âà∞Ôºö${selectedText}`);
    }

    // ÂàùÂßãÂåñËÆæÁΩÆÈù¢Êùø‰∫ã‰ª∂ÁõëÂê¨Âô®
    function initSettingsEvents() {
      // Âä†ËΩΩ‰øùÂ≠òÁöÑËÆæÁΩÆ
      loadSettingsFromStorage();
      
      // ËØ≠Ë®ÄÈÄâÊã©Âô®‰∫ã‰ª∂ÁõëÂê¨
      const languageSelect = document.getElementById('languageSelect');
      if (languageSelect) {
        languageSelect.addEventListener('change', changeLanguage);
      }
      
      // ÂàùÂßãÂåñÈü≥ÊïàÂºÄÂÖ≥Áä∂ÊÄÅ
      const soundToggle = document.getElementById('soundToggle');
      if (soundToggle) {
        const savedSoundEnabled = localStorage.getItem('soundEnabled');
        if (savedSoundEnabled !== null) {
          soundEnabled = savedSoundEnabled === 'true';
          soundToggle.checked = soundEnabled;
        }
      }
      
      // ÁÇπÂáªÊ®°ÊÄÅÊ°ÜËÉåÊôØÂÖ≥Èó≠ËÆæÁΩÆÈù¢Êùø
      document.addEventListener('click', function(e) {
        const settingsModal = document.getElementById('settingsModal');
        if (e.target === settingsModal) {
          closeSettings();
        }
      });
    }
    
    // ‰ªéÊú¨Âú∞Â≠òÂÇ®Âä†ËΩΩËÆæÁΩÆ
    function loadSettingsFromStorage() {
      // Âä†ËΩΩ‰∏ªÈ¢òËÆæÁΩÆ
      const savedTheme = localStorage.getItem('theme') || 'light';
      const themeBtn = document.querySelector(`[onclick="selectTheme('${savedTheme}')"]`);
      if (themeBtn) {
        themeBtn.classList.add('active');
      }
      
      // Âä†ËΩΩËØ≠Ë®ÄËÆæÁΩÆ
      const savedLanguage = localStorage.getItem('language') || 'zh-CN';
      const languageSelect = document.getElementById('languageSelect');
      if (languageSelect) {
        languageSelect.value = savedLanguage;
      }
      
      // Âä†ËΩΩÂºÄÂÖ≥ËÆæÁΩÆ
      const switches = ['soundToggle', 'vibrationToggle', 'notificationToggle'];
      switches.forEach(switchId => {
        const toggle = document.getElementById(switchId);
        if (toggle) {
          const savedState = localStorage.getItem(switchId);
          toggle.checked = savedState === 'true';
        }
      });
    }
    
    // Êõ¥Êñ∞‰∏™‰∫∫ËµÑÊñôÊòæÁ§∫
    function updateProfileDisplay() {
      const userEmail = localStorage.getItem('userEmail') || 'user@example.com';
      const profileEmail = document.getElementById('profileEmail');
      if (profileEmail) {
        profileEmail.textContent = userEmail;
      }
      
      // ÂèØ‰ª•Ê∑ªÂä†Êõ¥Â§ö‰∏™‰∫∫‰ø°ÊÅØÁöÑÊõ¥Êñ∞ÈÄªËæë
    }

    /**
     * ÂÆåÊàêÊñ∞Êâã‰ªªÂä°
     * @param {number} taskId - ‰ªªÂä°ID
     */
    function completeNewbieTask(taskId) {
      const task = newTasks.find(t => t.id === taskId);
      if (!task) {
        showDialog('ÈîôËØØ', '‰ªªÂä°‰∏çÂ≠òÂú®ÔºÅ', [{ text: 'Á°ÆÂÆö', action: 'close' }], 'error');
        return false;
      }
      
      if (task.done) {
        showDialog('ÊèêÁ§∫', 'ËØ•‰ªªÂä°Â∑≤ÂÆåÊàêÔºÅ', [{ text: 'Á°ÆÂÆö', action: 'close' }], 'info');
        return false;
      }
      
      // Ê£ÄÊü•‰ªªÂä°ÂÆåÊàêÊù°‰ª∂ÔºàÊåâÈ°∫Â∫èÂÆåÊàêÔºâ
      const taskIndex = newTasks.findIndex(t => t.id === taskId);
      if (taskIndex > 0) {
        const previousTask = newTasks[taskIndex - 1];
        if (!previousTask.done) {
          showDialog('ÊèêÁ§∫', 'ËØ∑ÂÖàÂÆåÊàêÂâçÈù¢ÁöÑ‰ªªÂä°ÔºÅ', [{ text: 'Á°ÆÂÆö', action: 'close' }], 'info');
          return false;
        }
      }
      
      // Ê†áËÆ∞‰ªªÂä°ÂÆåÊàê
      task.done = true;
      completedNewbieTasks = newTasks.filter(t => t.done).length;
      
      // Êõ¥Êñ∞Èí±ÂåÖ‰ΩôÈ¢ù
      walletBalance += task.reward;
      
      // Ê∑ªÂä†‰∫§ÊòìËÆ∞ÂΩï
      transactions.unshift({
        type: 'income',
        amount: task.reward,
        description: `ÂÆåÊàê${task.title}`,
        timestamp: new Date().toISOString()
      });
      
      // Ê£ÄÊü•ÊòØÂê¶Ëß£ÈîÅÁ≠îÈ¢ò‰ªªÂä°
      if (completedNewbieTasks >= 1 && !quizCompleted) {
        // Á¨¨‰∏Ä‰∏™Êñ∞Êâã‰ªªÂä°ÂÆåÊàêÂêéËß£ÈîÅÁ≠îÈ¢ò‰ªªÂä°
        showDialog('ÊÅ≠Âñú', 'Ëß£ÈîÅÁ≠îÈ¢ò‰ªªÂä°ÔºÅÂÆåÊàêÁ≠îÈ¢òÂèØÈôç‰ΩéÊèêÁé∞ÊâãÁª≠Ë¥π„ÄÇ', [{ text: 'ÂéªÁ≠îÈ¢ò', action: () => { saveState(); window.location.href = 'quiz.html'; } }, { text: 'Á®çÂêé', action: 'close' }], 'success');
      }
      
      // Ê£ÄÊü•ÊòØÂê¶Ëß£ÈîÅÂ§ßÁ•û‰ªªÂä°
      if (completedNewbieTasks >= 3 && quizCompleted && !godTasksUnlocked) {
        godTasksUnlocked = true;
        showDialog('ÊÅ≠Âñú', 'Ëß£ÈîÅÂ§ßÁ•û‰ªªÂä°ÔºÅÂÆåÊàêÂ§ßÁ•û‰ªªÂä°ÂèØËé∑ÂæóÊõ¥È´òÂ•ñÂä±„ÄÇ', [{ text: 'Êü•Áúã', action: () => window.location.href = 'tasks.html?tab=master' }, { text: 'Á®çÂêé', action: 'close' }], 'success');
      }
      
      // ÁîüÊàêÂõ¢ÈòüÊ∂àÊÅØ
      generateTeamMessage('task_complete', {
        taskName: task.title,
        reward: task.reward
      });
      
      // ‰øùÂ≠òÁä∂ÊÄÅÂπ∂ÈáçÊñ∞Ê∏≤Êüì
      saveState();
      renderState();
      
      // ÊòæÁ§∫ÂÆåÊàêÊèêÁ§∫
      showDialog('‰ªªÂä°ÂÆåÊàê', `ÊÅ≠ÂñúÂÆåÊàê"${task.title}"ÔºåËé∑Âæó${task.reward}ÂÖÉÂ•ñÂä±ÔºÅ`, [{ text: 'Á°ÆÂÆö', action: 'close' }], 'success');
      
      return true;
    }
    
    /**
     * ÂÆåÊàêÁ≠îÈ¢ò‰ªªÂä°
     * @param {number} correctAnswers - Ê≠£Á°ÆÁ≠îÊ°àÊï∞Èáè
     */
    function completeQuizTask(correctAnswers = 20) {
      if (quizCompleted) {
        showDialog('ÊèêÁ§∫', 'Á≠îÈ¢ò‰ªªÂä°Â∑≤ÂÆåÊàêÔºÅ', [{ text: 'Á°ÆÂÆö', action: 'close' }], 'info');
        return false;
      }
      
      // Ê£ÄÊü•ÊòØÂê¶ÂÆåÊàêËá≥Â∞ë‰∏Ä‰∏™Êñ∞Êâã‰ªªÂä°
      if (completedNewbieTasks < 1) {
        showDialog('ÊèêÁ§∫', 'ËØ∑ÂÖàÂÆåÊàêËá≥Â∞ë‰∏Ä‰∏™Êñ∞Êâã‰ªªÂä°ÔºÅ', [{ text: 'Á°ÆÂÆö', action: 'close' }], 'info');
        return false;
      }
      
      // Ê£ÄÊü•Á≠îÈ¢òÊï∞Èáè
      if (correctAnswers < 20) {
        showDialog('ÊèêÁ§∫', `Á≠îÈ¢òÊ≠£Á°ÆÁéá‰∏çË∂≥ÔºÅÈúÄË¶ÅÁ≠îÂØπ20È¢òÔºåÂΩìÂâçÁ≠îÂØπ${correctAnswers}È¢ò„ÄÇ`, [{ text: 'ÁªßÁª≠Á≠îÈ¢ò', action: () => { saveState(); window.location.href = 'quiz.html'; } }, { text: 'Á®çÂêé', action: 'close' }], 'info');
        return false;
      }
      
      // Ê†áËÆ∞Á≠îÈ¢ò‰ªªÂä°ÂÆåÊàê
      quizCompleted = true;
      const quizTask = quizTasks[0];
      if (quizTask) {
        quizTask.done = true;
        
        // Êõ¥Êñ∞Èí±ÂåÖ‰ΩôÈ¢ù
        walletBalance += quizTask.reward;
        
        // Ê∑ªÂä†‰∫§ÊòìËÆ∞ÂΩï
        transactions.unshift({
          type: 'income',
          amount: quizTask.reward,
          description: `ÂÆåÊàê${quizTask.title}`,
          timestamp: new Date().toISOString()
        });
        
        // Èôç‰ΩéÊèêÁé∞ÊâãÁª≠Ë¥π
        withdrawFeeRate = Math.max(0.01, withdrawFeeRate - quizTask.feeReduction);
      }
      
      // Ê£ÄÊü•ÊòØÂê¶Ëß£ÈîÅÂ§ßÁ•û‰ªªÂä°
      if (completedNewbieTasks >= 3 && !godTasksUnlocked) {
        godTasksUnlocked = true;
        showDialog('ÊÅ≠Âñú', 'Ëß£ÈîÅÂ§ßÁ•û‰ªªÂä°ÔºÅÂÆåÊàêÂ§ßÁ•û‰ªªÂä°ÂèØËé∑ÂæóÊõ¥È´òÂ•ñÂä±„ÄÇ', [{ text: 'Êü•Áúã', action: () => window.location.href = 'tasks.html?tab=master' }, { text: 'Á®çÂêé', action: 'close' }], 'success');
      }
      
      // ÁîüÊàêÂõ¢ÈòüÊ∂àÊÅØ
      generateTeamMessage('task_complete', {
        taskName: 'Á≠îÈ¢ò‰ªªÂä°',
        reward: quizTask ? quizTask.reward : 20
      });
      
      // ‰øùÂ≠òÁä∂ÊÄÅÂπ∂ÈáçÊñ∞Ê∏≤Êüì
      saveState();
      renderState();
      
      // ÊòæÁ§∫ÂÆåÊàêÊèêÁ§∫
      showDialog('Á≠îÈ¢òÂÆåÊàê', `ÊÅ≠ÂñúÂÆåÊàêÁ≠îÈ¢ò‰ªªÂä°ÔºåËé∑Âæó${quizTask ? quizTask.reward : 20}ÂÖÉÂ•ñÂä±ÔºÅÊèêÁé∞ÊâãÁª≠Ë¥πÂ∑≤Èôç‰ΩéËá≥${(withdrawFeeRate * 100).toFixed(1)}%`, [{ text: 'Á°ÆÂÆö', action: 'close' }], 'success');
      
      return true;
    }
    
    /**
     * ÂÆåÊàêÂ§ßÁ•û‰ªªÂä°
     * @param {number} taskId - ‰ªªÂä°ID
     */
    function completeGodTask(taskId) {
      const task = godTasks.find(t => t.id === taskId);
      if (!task) {
        showDialog('ÈîôËØØ', '‰ªªÂä°‰∏çÂ≠òÂú®ÔºÅ', [{ text: 'Á°ÆÂÆö', action: 'close' }], 'error');
        return false;
      }
      
      if (task.done) {
        showDialog('ÊèêÁ§∫', 'ËØ•‰ªªÂä°Â∑≤ÂÆåÊàêÔºÅ', [{ text: 'Á°ÆÂÆö', action: 'close' }], 'info');
        return false;
      }
      
      // Ê£ÄÊü•ÊòØÂê¶Ëß£ÈîÅÂ§ßÁ•û‰ªªÂä°
      if (!godTasksUnlocked) {
        showDialog('ÊèêÁ§∫', 'ËØ∑ÂÖàÂÆåÊàêÊâÄÊúâÊñ∞Êâã‰ªªÂä°ÂíåÁ≠îÈ¢ò‰ªªÂä°ÔºÅ', [{ text: 'Á°ÆÂÆö', action: 'close' }], 'info');
        return false;
      }
      
      // Ê£ÄÊü•‰ªªÂä°ÂÆåÊàêÊù°‰ª∂ÔºàÊåâÈ°∫Â∫èÂÆåÊàêÔºâ
      const taskIndex = godTasks.findIndex(t => t.id === taskId);
      if (taskIndex > 0) {
        const previousTask = godTasks[taskIndex - 1];
        if (!previousTask.done) {
          showDialog('ÊèêÁ§∫', 'ËØ∑ÂÖàÂÆåÊàêÂâçÈù¢ÁöÑÂ§ßÁ•û‰ªªÂä°ÔºÅ', [{ text: 'Á°ÆÂÆö', action: 'close' }], 'info');
          return false;
        }
      }
      
      // Ê†áËÆ∞‰ªªÂä°ÂÆåÊàê
      task.done = true;
      
      // Êõ¥Êñ∞Èí±ÂåÖ‰ΩôÈ¢ù
      walletBalance += task.reward;
      
      // Ê∑ªÂä†‰∫§ÊòìËÆ∞ÂΩï
      transactions.unshift({
        type: 'income',
        amount: task.reward,
        description: `ÂÆåÊàê${task.title}`,
        timestamp: new Date().toISOString()
      });
      
      // ÁîüÊàêÂõ¢ÈòüÊ∂àÊÅØ
      generateTeamMessage('task_complete', {
        taskName: task.title,
        reward: task.reward
      });
      
      // ‰øùÂ≠òÁä∂ÊÄÅÂπ∂ÈáçÊñ∞Ê∏≤Êüì
      saveState();
      renderState();
      
      // ÊòæÁ§∫ÂÆåÊàêÊèêÁ§∫
      showDialog('Â§ßÁ•û‰ªªÂä°ÂÆåÊàê', `ÊÅ≠ÂñúÂÆåÊàê"${task.title}"ÔºåËé∑Âæó${task.reward}ÂÖÉÂ•ñÂä±ÔºÅ`, [{ text: 'Á°ÆÂÆö', action: 'close' }], 'success');
      
      return true;
    }
    
    /**
     * Ëé∑ÂèñÂΩìÂâçÂèØÊâßË°åÁöÑ‰ªªÂä°
     */
    function getAvailableTasks() {
      const available = {
        newbie: [],
        quiz: [],
        god: []
      };
      
      // Êñ∞Êâã‰ªªÂä°ÔºöÊåâÈ°∫Â∫èËß£ÈîÅ
      for (let i = 0; i < newTasks.length; i++) {
        const task = newTasks[i];
        if (!task.done) {
          if (i === 0 || newTasks[i - 1].done) {
            available.newbie.push(task);
            break; // Âè™ÊòæÁ§∫‰∏ã‰∏Ä‰∏™ÂèØÂÆåÊàêÁöÑ‰ªªÂä°
          }
        }
      }
      
      // Á≠îÈ¢ò‰ªªÂä°ÔºöÂÆåÊàêËá≥Â∞ë‰∏Ä‰∏™Êñ∞Êâã‰ªªÂä°ÂêéËß£ÈîÅ
      if (completedNewbieTasks >= 1 && !quizCompleted) {
        available.quiz = quizTasks.filter(t => !t.done);
      }
      
      // Â§ßÁ•û‰ªªÂä°ÔºöÂÆåÊàêÊâÄÊúâÊñ∞Êâã‰ªªÂä°ÂíåÁ≠îÈ¢ò‰ªªÂä°ÂêéËß£ÈîÅ
      if (godTasksUnlocked) {
        for (let i = 0; i < godTasks.length; i++) {
          const task = godTasks[i];
          if (!task.done) {
            if (i === 0 || godTasks[i - 1].done) {
              available.god.push(task);
              break; // Âè™ÊòæÁ§∫‰∏ã‰∏Ä‰∏™ÂèØÂÆåÊàêÁöÑ‰ªªÂä°
            }
          }
        }
      }
      
      return available;
    }
    
    /**
     * Ëé∑Âèñ‰ªªÂä°ÂÆåÊàêËøõÂ∫¶
     */
    function getTaskProgress() {
      const newbieProgress = {
        completed: newTasks.filter(t => t.done).length,
        total: newTasks.length
      };
      
      const quizProgress = {
        completed: quizCompleted ? 1 : 0,
        total: 1
      };
      
      const godProgress = {
        completed: godTasks.filter(t => t.done).length,
        total: godTasks.length
      };
      
      return {
        newbie: newbieProgress,
        quiz: quizProgress,
        god: godProgress,
        overall: {
          completed: newbieProgress.completed + quizProgress.completed + godProgress.completed,
          total: newbieProgress.total + quizProgress.total + godProgress.total
        }
      };
    }


    


    // ==================== Ê∂àÊÅØÁ≥ªÁªü ====================
    
    // Èü≥ÊïàÁÆ°ÁêÜ
    let audioContext = null;
    let soundEnabled = true;
    
    // ÂàùÂßãÂåñÈü≥ÊïàÁ≥ªÁªü
    function initAudioSystem() {
      try {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        // ‰ªéÊú¨Âú∞Â≠òÂÇ®ËØªÂèñÈü≥ÊïàËÆæÁΩÆ
        const savedSoundSetting = localStorage.getItem('soundEnabled');
        if (savedSoundSetting !== null) {
          soundEnabled = JSON.parse(savedSoundSetting);
        }
      } catch (error) {
        console.warn('Èü≥ÊïàÁ≥ªÁªüÂàùÂßãÂåñÂ§±Ë¥•:', error);
        soundEnabled = false;
      }
    }
    
    // Êí≠ÊîæÊ∂àÊÅØÊèêÁ§∫Èü≥
    function playMessageSound() {
      if (!soundEnabled) return;
      
      try {
        // ÂàõÂª∫Èü≥È¢ëÂÖÉÁ¥†Êí≠ÊîæÈáëÂ∏ÅÂ£∞Êïà
        const audio = new Audio('ÈáëÂ∏ÅÂ£∞Êïà.mp3');
        audio.volume = 0.5; // ËÆæÁΩÆÈü≥Èáè‰∏∫50%
        
        // Êí≠ÊîæÈü≥Êïà
        const playPromise = audio.play();
        
        // Â§ÑÁêÜÊí≠ÊîæPromiseÔºàÁé∞‰ª£ÊµèËßàÂô®Ë¶ÅÊ±ÇÔºâ
        if (playPromise !== undefined) {
          playPromise.catch(error => {
            console.log('Èü≥ÊïàÊí≠ÊîæÂ§±Ë¥•:', error);
          });
        }
        
      } catch (error) {
        console.warn('Êí≠ÊîæÊ∂àÊÅØÈü≥ÊïàÂ§±Ë¥•:', error);
      }
    }
    
    // ÂàáÊç¢Èü≥ÊïàÂºÄÂÖ≥ - Â∑≤ÁßªÈô§ÂäüËÉΩ
    /*
    function toggleSound() {
      soundEnabled = !soundEnabled;
      localStorage.setItem('soundEnabled', JSON.stringify(soundEnabled));
      
      // Êõ¥Êñ∞ËÆæÁΩÆÈù¢Êùø‰∏≠ÁöÑÂºÄÂÖ≥Áä∂ÊÄÅ
      const soundToggle = document.querySelector('#soundToggle');
      if (soundToggle) {
        soundToggle.checked = soundEnabled;
      }
      
      // Êí≠ÊîæÊµãËØïÈü≥ÊïàÔºàÂ¶ÇÊûúÂºÄÂêØÔºâ
      if (soundEnabled) {
        playMessageSound();
      }
    }
    */
    
    // Ê∂àÊÅØÊï∞ÊçÆÁÆ°ÁêÜ
    let messages = {
      official: [],
      team: []
    };
    
    let messageReadStatus = {};
    
    // BugÊä•ÂëäÊï∞ÊçÆÁÆ°ÁêÜ
    let bugReports = [];
    
    // ÂàùÂßãÂåñBugÊä•ÂëäÊï∞ÊçÆ
    function initBugReports() {
      const savedBugReports = localStorage.getItem('bugReports');
      if (savedBugReports) {
        bugReports = JSON.parse(savedBugReports);
      }
    }
    
    // ‰øùÂ≠òBugÊä•ÂëäÊï∞ÊçÆ
    function saveBugReports() {
      localStorage.setItem('bugReports', JSON.stringify(bugReports));
    }
    
    // ÂàùÂßãÂåñÊ∂àÊÅØÊï∞ÊçÆ
    function initMessages() {
      const savedMessages = localStorage.getItem('messages');
      const savedReadStatus = localStorage.getItem('messageReadStatus');
      
      if (savedMessages) {
        messages = JSON.parse(savedMessages);
      } else {
        // ÂàùÂßãÂåñÈªòËÆ§Ê∂àÊÅØ
        messages = {
          official: [
            {
              id: 'official_1',
              title: 'Ê¨¢ËøéÂä†ÂÖ•Âπ≥Âè∞',
              content: 'Ê¨¢ËøéÊÇ®Âä†ÂÖ•Êàë‰ª¨ÁöÑÂπ≥Âè∞ÔºÅÂÆåÊàêÊñ∞Êâã‰ªªÂä°ÂèØËé∑Âæó‰∏∞ÂéöÂ•ñÂä±ÔºåÂø´Êù•‰ΩìÈ™åÂêßÔºÅ',
              time: new Date(Date.now() - 2 * 60 * 60 * 1000).toISOString(),
              category: 'Á≥ªÁªüÈÄöÁü•'
            },
            {
              id: 'official_2', 
              title: 'Êä¢Á∫¢ÂåÖÊ¥ªÂä®ÂºÄÂêØ',
              content: 'ÊØèÊó•‰∏âÂú∫Á∫¢ÂåÖÈõ®Ê¥ªÂä®Â∑≤ÂºÄÂêØÔºÅÊó∂Èó¥Ôºö9:00„ÄÅ12:00„ÄÅ20:00ÔºåÊØèÂú∫ÊåÅÁª≠77ÁßíÔºå‰∏çË¶ÅÈîôËøáÂì¶ÔºÅ',
              time: new Date(Date.now() - 1 * 60 * 60 * 1000).toISOString(),
              category: 'Ê¥ªÂä®ÂÖ¨Âëä'
            },
            {
              id: 'official_3',
              title: 'Âπ≥Âè∞ÂçáÁ∫ßÂÖ¨Âëä',
              content: '‰∏∫‰∫ÜÁªôÊÇ®Êèê‰æõÊõ¥Â•ΩÁöÑÊúçÂä°‰ΩìÈ™åÔºåÂπ≥Âè∞Â∞ÜÂú®‰ªäÊôö23:00-24:00ËøõË°åÁ≥ªÁªüÁª¥Êä§ÂçáÁ∫ßÔºåÊúüÈó¥ÂèØËÉΩÂΩ±ÂìçÈÉ®ÂàÜÂäüËÉΩ‰ΩøÁî®ÔºåÊï¨ËØ∑Ë∞ÖËß£ÔºÅ',
              time: new Date(Date.now() - 30 * 60 * 1000).toISOString(),
              category: 'Á≥ªÁªüÂÖ¨Âëä'
            }
          ],
          team: [
            {
              id: 'team_1',
              title: 'Âõ¢ÈòüÊî∂ÁõäÊèêÈÜí',
              content: 'ÊÇ®ÁöÑÂõ¢Èòü‰ªäÊó•Êî∂ÁõäÂ∑≤Êõ¥Êñ∞ÔºåÂΩìÂâçÂõ¢ÈòüÊÄªÊî∂ÁõäÔºö156.8ÂÖÉÔºåÁªßÁª≠Âä™ÂäõÔºÅ',
              time: new Date(Date.now() - 45 * 60 * 1000).toISOString(),
              category: 'Êî∂ÁõäÈÄöÁü•'
            }
          ]
        };
        saveMessages();
      }
      
      if (savedReadStatus) {
        messageReadStatus = JSON.parse(savedReadStatus);
      }
    }
    
    // ‰øùÂ≠òÊ∂àÊÅØÊï∞ÊçÆ
    function saveMessages() {
      localStorage.setItem('messages', JSON.stringify(messages));
      localStorage.setItem('messageReadStatus', JSON.stringify(messageReadStatus));
    }
    
    // Ê∑ªÂä†Êñ∞Ê∂àÊÅØ
    function addMessage(type, messageData) {
      const message = {
        id: `${type}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
        title: messageData.title,
        content: messageData.content,
        time: new Date().toISOString(),
        category: messageData.category || 'Á≥ªÁªüÊ∂àÊÅØ'
      };
      
      messages[type].unshift(message);
      saveMessages();
      updateMessageButton();
      
      // Êí≠ÊîæÊñ∞Ê∂àÊÅØÈü≥Êïà
      playMessageSound();
      
      // Ëß¶ÂèëÊ∂àÊÅØÂõæÊ†áÊäñÂä®ÊïàÊûú
      const messageIcon = document.querySelector('.message-icon');
      if (messageIcon) {
        messageIcon.classList.add('shake');
        setTimeout(() => {
          messageIcon.classList.remove('shake');
        }, 600);
      }
    }
    
    // ÁîüÊàêÂõ¢ÈòüÊ∂àÊÅØ
    function generateTeamMessage(action, data) {
      let title, content, category;
      
      switch (action) {
        case 'member_join':
          title = 'Êñ∞ÊàêÂëòÂä†ÂÖ•';
          content = `ÊÅ≠ÂñúÔºÅÊÇ®ÁöÑÂõ¢ÈòüÊñ∞Â¢û‰∫Ü‰∏ÄÂêçÊàêÂëòÔºåÂΩìÂâçÂõ¢Èòü‰∫∫Êï∞Ôºö${data.teamSize}‰∫∫`;
          category = 'Âõ¢ÈòüÂä®ÊÄÅ';
          break;
        case 'balance_change':
          title = 'Êî∂ÁõäÊõ¥Êñ∞';
          content = `ÊÇ®ÁöÑË¥¶Êà∑‰ΩôÈ¢ùÂèëÁîüÂèòÂåñÔºåÂΩìÂâç‰ΩôÈ¢ùÔºö${data.balance}ÂÖÉ`;
          category = 'Êî∂ÁõäÈÄöÁü•';
          break;
        case 'task_complete':
          title = '‰ªªÂä°ÂÆåÊàê';
          content = `ÊÅ≠ÂñúÂÆåÊàê‰ªªÂä°"${data.taskName}"ÔºåËé∑ÂæóÂ•ñÂä±${data.reward}ÂÖÉ`;
          category = '‰ªªÂä°Â•ñÂä±';
          break;
        default:
          return;
      }
      
      addMessage('team', { title, content, category });
    }
    
    // ÊòæÁ§∫Ê∂àÊÅØÂºπÁ™ó
    function showMessages() {
      const modal = document.getElementById('messageModal');
      modal.style.display = 'flex';
      
      // ÈªòËÆ§ÊòæÁ§∫ÂÆòÊñπÂÖ¨Âëä
      switchMessageTab('official');
    }
    
    // ÈöêËóèÊ∂àÊÅØÂºπÁ™ó
    function hideMessages() {
      const modal = document.getElementById('messageModal');
      modal.style.display = 'none';
    }
    
    // ÂÖ≥Èó≠Ê∂àÊÅØÂºπÁ™óÔºà‰∏éhideMessagesÂäüËÉΩÁõ∏ÂêåÔºåÁî®‰∫éÊåâÈíÆÁÇπÂáªÔºâ
    function closeMessages() {
      hideMessages();
    }
    
    // ÂàáÊç¢Ê∂àÊÅØÊ†áÁ≠æÈ°µ
    function switchMessageTab(type) {
      // Êõ¥Êñ∞Ê†áÁ≠æÊåâÈíÆÁä∂ÊÄÅ
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      document.querySelector(`[onclick="switchMessageTab('${type}')"]`).classList.add('active');
      
      // Êõ¥Êñ∞Ê∂àÊÅØÂàóË°®ÊòæÁ§∫
      document.querySelectorAll('.message-list').forEach(list => {
        list.classList.remove('active');
      });
      document.getElementById(`${type}Messages`).classList.add('active');
      
      // Ê∏≤ÊüìÂØπÂ∫îÂÜÖÂÆπ
      if (type === 'bug') {
        renderBugReportList();
      } else {
        renderMessageList(type);
      }
    }
    
    // Ê∏≤ÊüìÊ∂àÊÅØÂàóË°®
    function renderMessageList(type) {
      const container = document.getElementById(`${type}Messages`);
      const messageList = messages[type];
      
      if (messageList.length === 0) {
        container.innerHTML = `
          <div class="empty-message">
            <div class="empty-icon">üì≠</div>
            <div class="empty-text">ÊöÇÊó†${type === 'official' ? 'ÂÆòÊñπÂÖ¨Âëä' : 'Âõ¢ÈòüÊ∂àÊÅØ'}</div>
          </div>
        `;
        return;
      }
      
      container.innerHTML = messageList.map(message => {
        const isUnread = !messageReadStatus[message.id];
        const timeStr = formatMessageTime(message.time);
        
        // ‰∏∫Âõ¢ÈòüÊ∂àÊÅØÊ∑ªÂä†Âà†Èô§ÊåâÈíÆ
        const deleteButton = type === 'team' ? `
          <button class="delete-message-btn" onclick="event.stopPropagation(); deleteMessage('${type}', '${message.id}')" title="Âà†Èô§Ê∂àÊÅØ">
            üóëÔ∏è
          </button>
        ` : '';
        
        return `
          <div class="message-item ${isUnread ? 'unread' : ''}" onclick="markMessageAsRead('${message.id}')">
            <div class="message-header-info">
              <h4 class="message-title-text">${message.title}</h4>
              <div class="message-header-right">
                <span class="message-time">${timeStr}</span>
                ${deleteButton}
              </div>
            </div>
            <p class="message-content-text">${message.content}</p>
            <span class="message-category">${message.category}</span>
          </div>
        `;
      }).join('');
    }
    
    // Ê†ºÂºèÂåñÊ∂àÊÅØÊó∂Èó¥
    function formatMessageTime(timeStr) {
      const time = new Date(timeStr);
      const now = new Date();
      const diff = now - time;
      
      if (diff < 60 * 1000) {
        return 'ÂàöÂàö';
      } else if (diff < 60 * 60 * 1000) {
        return `${Math.floor(diff / (60 * 1000))}ÂàÜÈíüÂâç`;
      } else if (diff < 24 * 60 * 60 * 1000) {
        return `${Math.floor(diff / (60 * 60 * 1000))}Â∞èÊó∂Ââç`;
      } else {
        return time.toLocaleDateString();
      }
    }
    
    // Ê†áËÆ∞Ê∂àÊÅØ‰∏∫Â∑≤ËØª
    function markMessageAsRead(messageId) {
      messageReadStatus[messageId] = true;
      saveMessages();
      updateMessageButton();
      
      // ÈáçÊñ∞Ê∏≤ÊüìÂΩìÂâçÊ†áÁ≠æÈ°µ
      const activeTab = document.querySelector('.tab-btn.active');
      if (activeTab) {
        const type = activeTab.onclick.toString().includes('official') ? 'official' : 'team';
        renderMessageList(type);
      }
    }
    
    // Âà†Èô§Ê∂àÊÅØÂäüËÉΩ
    function deleteMessage(type, messageId) {
      // ÊòæÁ§∫Á°ÆËÆ§ÂØπËØùÊ°Ü
      if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°Ê∂àÊÅØÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄ„ÄÇ')) {
        return;
      }

      // ‰ªéÂØπÂ∫îÁ±ªÂûãÁöÑÊ∂àÊÅØÊï∞ÁªÑ‰∏≠ÊâæÂà∞Âπ∂Âà†Èô§Ê∂àÊÅØ
      const messageList = messages[type];
      const index = messageList.findIndex(message => message.id === messageId);
      
      if (index !== -1) {
        // Âà†Èô§Ê∂àÊÅØ
        messageList.splice(index, 1);
        
        // Âà†Èô§ÂØπÂ∫îÁöÑÂ∑≤ËØªÁä∂ÊÄÅ
        delete messageReadStatus[messageId];
        
        // ‰øùÂ≠òÊõ¥Êñ∞ÂêéÁöÑÊï∞ÊçÆ
        saveMessages();
        
        // Êõ¥Êñ∞Ê∂àÊÅØÊåâÈíÆÁä∂ÊÄÅ
        updateMessageButton();
        
        // ÈáçÊñ∞Ê∏≤ÊüìÂΩìÂâçÊ∂àÊÅØÂàóË°®
        renderMessageList(type);
        
        // ÊòæÁ§∫Âà†Èô§ÊàêÂäüÊèêÁ§∫
        alert('Ê∂àÊÅØÂ∑≤Âà†Èô§ÔºÅ');
      } else {
        alert('Êú™ÊâæÂà∞Ë¶ÅÂà†Èô§ÁöÑÊ∂àÊÅØÔºÅ');
      }
    }
    
    // ‰∏ÄÈîÆÂ∑≤ËØªÂäüËÉΩ - Ê†áËÆ∞ÊâÄÊúâÊ∂àÊÅØ‰∏∫Â∑≤ËØª
    function markAllAsRead() {
      // Ëé∑ÂèñÂΩìÂâçÊ¥ªË∑ÉÁöÑÊ†áÁ≠æÈ°µÁ±ªÂûã
      const activeTab = document.querySelector('.tab-btn.active');
      if (!activeTab) return;
      
      // Ê£ÄÊü•ÊòØÂê¶Âú®BugÊä•ÂëäÈ°µÈù¢
      if (activeTab.onclick.toString().includes('bug')) {
        // BugÊä•ÂëäÈ°µÈù¢‰∏çÈúÄË¶ÅÂ∑≤ËØªÂäüËÉΩ
        alert('BugÊä•ÂëäÊó†ÈúÄÊ†áËÆ∞Â∑≤ËØª');
        return;
      }
      
      // Ê†áËÆ∞ÊâÄÊúâÂÆòÊñπÂÖ¨ÂëäÂíåÂõ¢ÈòüÊ∂àÊÅØ‰∏∫Â∑≤ËØª
      let totalMarked = 0;
      
      // Ê†áËÆ∞ÂÆòÊñπÂÖ¨Âëä‰∏∫Â∑≤ËØª
      messages.official.forEach(message => {
        if (!messageReadStatus[message.id]) {
          messageReadStatus[message.id] = true;
          totalMarked++;
        }
      });
      
      // Ê†áËÆ∞Âõ¢ÈòüÊ∂àÊÅØ‰∏∫Â∑≤ËØª
      messages.team.forEach(message => {
        if (!messageReadStatus[message.id]) {
          messageReadStatus[message.id] = true;
          totalMarked++;
        }
      });
      
      // ‰øùÂ≠òÊï∞ÊçÆÂπ∂Êõ¥Êñ∞ÁïåÈù¢
      saveMessages();
      updateMessageButton();
      updateTabUnreadCount();
      
      // ÈáçÊñ∞Ê∏≤ÊüìÂΩìÂâçÊòæÁ§∫ÁöÑÊ∂àÊÅØÂàóË°®
      const currentType = activeTab.onclick.toString().includes('team') ? 'team' : 'official';
      renderMessageList(currentType);
      
      // ÊòæÁ§∫ÊàêÂäüÊèêÁ§∫
      if (totalMarked > 0) {
        alert(`Â∑≤Â∞ÜÊâÄÊúâÊ∂àÊÅØÊ†áËÆ∞‰∏∫Â∑≤ËØªÔºàÂÖ±${totalMarked}Êù°Ôºâ`);
      } else {
        alert('ÊâÄÊúâÊ∂àÊÅØÂ∑≤ÁªèÊòØÂ∑≤ËØªÁä∂ÊÄÅ');
      }
    }
    
    // Êõ¥Êñ∞Ê∂àÊÅØÊåâÈíÆÁä∂ÊÄÅÔºàÁé∞Âú®Êõ¥Êñ∞Ê∂àÊÅØÂõæÊ†áÁä∂ÊÄÅÔºâ
    function updateMessageButton() {
      const messageIcon = document.querySelector('.message-icon');
      const unreadDot = document.querySelector('#messageUnreadDot');
      
      if (!messageIcon || !unreadDot) return;
      
      // Ê£ÄÊü•ÊòØÂê¶ÊúâÊú™ËØªÊ∂àÊÅØ
      const hasUnread = [...messages.official, ...messages.team].some(msg => !messageReadStatus[msg.id]);
      
      if (hasUnread) {
        messageIcon.classList.add('has-unread');
        unreadDot.style.display = 'block';
      } else {
        messageIcon.classList.remove('has-unread');
        unreadDot.style.display = 'none';
      }
    }
    
    // Êõ¥Êñ∞Ê†áÁ≠æÈ°µÊú™ËØªËÆ°Êï∞
    function updateTabUnreadCount() {
      const officialCount = messages.official.filter(msg => !messageReadStatus[msg.id]).length;
      const teamCount = messages.team.filter(msg => !messageReadStatus[msg.id]).length;
      
      // Êõ¥Êñ∞ÂÆòÊñπÂÖ¨ÂëäÊ†áÁ≠æ
      const officialTab = document.querySelector('[onclick="switchMessageTab(\'official\')"]');
      if (officialTab) {
        const countEl = officialTab.querySelector('.unread-count');
        if (officialCount > 0) {
          if (!countEl) {
            officialTab.innerHTML += `<span class="unread-count">${officialCount}</span>`;
          } else {
            countEl.textContent = officialCount;
          }
        } else if (countEl) {
          countEl.remove();
        }
      }
      
      // Êõ¥Êñ∞Âõ¢ÈòüÊ∂àÊÅØÊ†áÁ≠æ
      const teamTab = document.querySelector('[onclick="switchMessageTab(\'team\')"]');
      if (teamTab) {
        const countEl = teamTab.querySelector('.unread-count');
        if (teamCount > 0) {
          if (!countEl) {
            teamTab.innerHTML += `<span class="unread-count">${teamCount}</span>`;
          } else {
            countEl.textContent = teamCount;
          }
        } else if (countEl) {
          countEl.remove();
        }
      }
    }

    // ÂèëÈÄÅÈöèÊú∫ÂÆòÊñπÂÖ¨Âëä

    
    // BugÊä•ÂëäÁõ∏ÂÖ≥ÂáΩÊï∞
    
    // Êèê‰∫§BugÊä•Âëä
    function submitBugReport(event) {
      event.preventDefault();
      
      const title = document.getElementById('bugTitle').value.trim();
      const description = document.getElementById('bugDescription').value.trim();
      const type = document.getElementById('bugType').value;
      
      if (!title || !description || !type) {
        alert('ËØ∑Â°´ÂÜôÂÆåÊï¥ÁöÑBugÊä•Âëä‰ø°ÊÅØ');
        return;
      }
      
      const bugReport = {
        id: `bug_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
        title: title,
        description: description,
        type: type,
        time: new Date().toISOString(),
        status: 'Â∑≤Êèê‰∫§'
      };
      
      bugReports.unshift(bugReport);
      saveBugReports();
      
      // Ê∏ÖÁ©∫Ë°®Âçï
      document.getElementById('bugTitle').value = '';
      document.getElementById('bugDescription').value = '';
      document.getElementById('bugType').value = '';
      
      // ÈáçÊñ∞Ê∏≤ÊüìBugÊä•ÂëäÂàóË°®
      renderBugReportList();
      
      // ÊòæÁ§∫ÊàêÂäüÊèêÁ§∫
      alert('BugÊä•ÂëäÊèê‰∫§ÊàêÂäüÔºÅÊÑüË∞¢ÊÇ®ÁöÑÂèçÈ¶à„ÄÇ');
    }
    
    // Ê∏≤ÊüìBugÊä•ÂëäÂàóË°®
    function renderBugReportList() {
      const container = document.getElementById('bugReportList');
      
      if (bugReports.length === 0) {
        container.innerHTML = `
          <div class="empty-message">
            <div class="empty-icon">üêõ</div>
            <div class="empty-text">ÊöÇÊó†BugÊä•Âëä</div>
          </div>
        `;
        return;
      }
      
      container.innerHTML = bugReports.map(bug => {
        const timeStr = formatMessageTime(bug.time);
        
        return `
          <div class="bug-item">
            <div class="bug-item-header">
              <h5 class="bug-title">${bug.title}</h5>
              <div class="bug-header-right">
                <span class="bug-time">${timeStr}</span>
                <button class="delete-bug-btn" onclick="deleteBugReport('${bug.id}')" title="Âà†Èô§BugÊä•Âëä">
                  üóëÔ∏è
                </button>
              </div>
            </div>
            <p class="bug-description">${bug.description}</p>
            <span class="bug-type">${bug.type}</span>
          </div>
        `;
      }).join('');
    }
    
    // Ê†ºÂºèÂåñÊó∂Èó¥ÔºàÂ§çÁî®Ê∂àÊÅØÁ≥ªÁªüÁöÑÂáΩÊï∞Ôºâ
    function formatBugTime(timeStr) {
      return formatMessageTime(timeStr);
    }

    // Âà†Èô§BugÊä•Âëä
    function deleteBugReport(bugId) {
      // ÊòæÁ§∫Á°ÆËÆ§ÂØπËØùÊ°Ü
      if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™BugÊä•ÂëäÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄ„ÄÇ')) {
        return;
      }

      // ‰ªéÊï∞ÁªÑ‰∏≠ÊâæÂà∞Âπ∂Âà†Èô§ÂØπÂ∫îÁöÑBugÊä•Âëä
      const index = bugReports.findIndex(bug => bug.id === bugId);
      if (index !== -1) {
        bugReports.splice(index, 1);
        
        // ‰øùÂ≠òÊõ¥Êñ∞ÂêéÁöÑÊï∞ÊçÆ
        saveBugReports();
        
        // ÈáçÊñ∞Ê∏≤ÊüìÂàóË°®
        renderBugReportList();
        
        // ÊòæÁ§∫Âà†Èô§ÊàêÂäüÊèêÁ§∫
        alert('BugÊä•ÂëäÂ∑≤Âà†Èô§ÔºÅ');
      } else {
        alert('Êú™ÊâæÂà∞Ë¶ÅÂà†Èô§ÁöÑBugÊä•ÂëäÔºÅ');
      }
    }

    // Ê∂àÊÅØÂõæÊ†áÊãñÊãΩÂäüËÉΩ
    function initMessageIconDrag() {
      const messageIcon = document.getElementById('messageIcon');
      if (!messageIcon) return;

      let isDragging = false;
      let startY = 0;
      let startTop = 0;
      let currentY = 0;

      // Ê∏ÖÈô§localStorage‰∏≠‰øùÂ≠òÁöÑ‰ΩçÁΩÆÔºåÁ°Æ‰øùÂõæÊ†áÂú®Â∑¶‰∏äËßí
      localStorage.removeItem('messageIconTop');
      localStorage.removeItem('messageIconLeft');
      
      // Á°Æ‰øùÂõæÊ†áÂú®Â∑¶‰∏äËßíÔºåÊ∏ÖÈô§‰ªª‰ΩïÂÜÖËÅîÊ†∑Âºè
      messageIcon.style.top = '';
      messageIcon.style.left = '';
      messageIcon.style.position = '';

      // Èº†Ê†á‰∫ã‰ª∂
      messageIcon.addEventListener('mousedown', startDrag);
      document.addEventListener('mousemove', drag);
      document.addEventListener('mouseup', endDrag);

      // Ëß¶Êë∏‰∫ã‰ª∂
      messageIcon.addEventListener('touchstart', startDragTouch, { passive: false });
      document.addEventListener('touchmove', dragTouch, { passive: false });
      document.addEventListener('touchend', endDragTouch);

      function startDrag(e) {
        e.preventDefault();
        e.stopPropagation();
        isDragging = true;
        startY = e.clientY;
        startTop = parseInt(window.getComputedStyle(messageIcon).top, 10);
        messageIcon.classList.add('dragging');
      }

      function startDragTouch(e) {
        isDragging = true;
        startY = e.touches[0].clientY;
        startTop = parseInt(window.getComputedStyle(messageIcon).top, 10);
        currentY = 0; // ÈáçÁΩÆÁßªÂä®Ë∑ùÁ¶ª
      }

      function drag(e) {
        if (!isDragging) return;
        e.preventDefault();
        e.stopPropagation();
        
        currentY = e.clientY - startY;
        const newTop = startTop + currentY;
        
        // ËæπÁïåÊ£ÄÊü•
        const maxTop = window.innerHeight - messageIcon.offsetHeight;
        const constrainedTop = Math.max(0, Math.min(newTop, maxTop));
        
        // ‰ΩøÁî®requestAnimationFrame‰ºòÂåñÊÄßËÉΩ
        requestAnimationFrame(() => {
          messageIcon.style.top = constrainedTop + 'px';
        });
      }

      function dragTouch(e) {
        if (!isDragging) return;
        
        currentY = e.touches[0].clientY - startY;
        
        // Âè™ÊúâÂú®ÁßªÂä®Ë∑ùÁ¶ªË∂ÖËøáÈòàÂÄºÊó∂ÊâçÂºÄÂßãÁúüÊ≠£ÁöÑÊãñÂä®
        if (Math.abs(currentY) > 5) {
          e.preventDefault();
          e.stopPropagation();
          messageIcon.classList.add('dragging');
          
          const newTop = startTop + currentY;
          
          // ËæπÁïåÊ£ÄÊü•
          const maxTop = window.innerHeight - messageIcon.offsetHeight;
          const constrainedTop = Math.max(0, Math.min(newTop, maxTop));
          
          // ‰ΩøÁî®requestAnimationFrame‰ºòÂåñÊÄßËÉΩ
          requestAnimationFrame(() => {
            messageIcon.style.top = constrainedTop + 'px';
          });
        }
      }

      function endDrag(e) {
        if (!isDragging) return;
        isDragging = false;
        messageIcon.classList.remove('dragging');
        
        // ‰øùÂ≠ò‰ΩçÁΩÆÂà∞localStorage
        const finalTop = parseInt(messageIcon.style.top, 10);
        localStorage.setItem('messageIconTop', finalTop);
        
        // ÁßªÈô§Ëá™Âä®Ëß¶ÂèëÁÇπÂáª‰∫ã‰ª∂ÁöÑÈÄªËæëÔºåÊãñÂä®Âêé‰∏çËá™Âä®ÊâìÂºÄÊ∂àÊÅØ‰∏≠ÂøÉ
      }

      function endDragTouch(e) {
        if (!isDragging) return;
        isDragging = false;
        messageIcon.classList.remove('dragging');
        
        // Â¶ÇÊûúÁßªÂä®Ë∑ùÁ¶ªÂæàÂ∞èÔºåËØ¥ÊòéÊòØÁÇπÂáªËÄå‰∏çÊòØÊãñÂä®
        if (Math.abs(currentY) <= 5) {
          // ÊâãÂä®Ëß¶ÂèëÁÇπÂáª‰∫ã‰ª∂
          showMessages();
        } else {
          // ‰øùÂ≠ò‰ΩçÁΩÆÂà∞localStorage
          const finalTop = parseInt(messageIcon.style.top, 10);
          localStorage.setItem('messageIconTop', finalTop);
        }
      }
    }

    // Êó∂Èó¥Ë∞ÉËØïÂäüËÉΩ
    let debugTimeOffset = 0; // Ë∞ÉËØïÊó∂Èó¥ÂÅèÁßªÈáèÔºàÊØ´ÁßíÔºâ
    
    /**
     * ÊòæÁ§∫ÁôªÂΩïÊ≥®ÂÜåÁïåÈù¢
     */
    function showLoginRegister() {
      // Ë∑≥ËΩ¨Âà∞ÁôªÂΩïÊ≥®ÂÜåÈ°µÈù¢
      window.location.href = 'login.html';
    }
    


    window.onload = init;
  </script>
  <script src="js/global-background.js"></script>
  <script src="js/performance-optimization.js"></script>
</body>
</html>