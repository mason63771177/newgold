# 数据库设计文档

## 数据库选择
- **主数据库**: MySQL 8.0
- **缓存数据库**: Redis 6.0
- **字符集**: utf8mb4
- **排序规则**: utf8mb4_unicode_ci

## 表结构设计

### 1. 用户表 (users)
```sql
CREATE TABLE `users` (
  `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT COMMENT '用户ID',
  `email` varchar(255) NOT NULL COMMENT '邮箱',
  `password_hash` varchar(255) NOT NULL COMMENT '密码哈希',
  `telegram_id` varchar(100) DEFAULT NULL COMMENT 'Telegram ID',
  `username` varchar(100) DEFAULT NULL COMMENT 'Telegram用户名',
  `invite_code` varchar(20) NOT NULL COMMENT '邀请码',
  `inviter_id` bigint(20) unsigned DEFAULT NULL COMMENT '邀请人ID',
  `inviter_telegram_id` varchar(100) DEFAULT NULL COMMENT '邀请人Telegram ID',
  `inviter_username` varchar(100) DEFAULT NULL COMMENT '邀请人用户名',
  `status` tinyint(4) NOT NULL DEFAULT 1 COMMENT '状态：1-新手 2-已入金 3-倒计时结束',
  `wallet_balance` decimal(15,8) NOT NULL DEFAULT 0.00000000 COMMENT '钱包余额',
  `fee_rate` decimal(5,2) NOT NULL DEFAULT 5.00 COMMENT '提现手续费率(%)',
  `repurchase_count` int(11) NOT NULL DEFAULT 0 COMMENT '入金次数',
  `enter_status_time` timestamp NULL DEFAULT NULL COMMENT '进入当前状态时间',
  `countdown_end_time` timestamp NULL DEFAULT NULL COMMENT '168小时倒计时结束时间',
  `invite_link_expire_time` timestamp NULL DEFAULT NULL COMMENT '邀请链接过期时间',
  `master_level` tinyint(4) NOT NULL DEFAULT 0 COMMENT '等级',
  `max_master_level` tinyint(4) NOT NULL DEFAULT 0 COMMENT '历史最高等级',
  `created_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_email` (`email`),
  UNIQUE KEY `uk_invite_code` (`invite_code`),
  KEY `idx_inviter_id` (`inviter_id`),
  KEY `idx_status` (`status`),
  KEY `idx_telegram_id` (`telegram_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户表';
```

### 2. 任务表 (tasks)
```sql
CREATE TABLE `tasks` (
  `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT COMMENT '任务ID',
  `user_id` bigint(20) unsigned NOT NULL COMMENT '用户ID',
  `task_type` enum('newbie','quiz','master') NOT NULL COMMENT '任务类型',
  `task_id` varchar(50) NOT NULL COMMENT '任务标识',
  `task_name` varchar(255) NOT NULL COMMENT '任务名称',
  `description` text COMMENT '任务描述',
  `target_count` int(11) DEFAULT NULL COMMENT '目标数量',
  `current_count` int(11) DEFAULT 0 COMMENT '当前进度',
  `reward_amount` decimal(15,8) DEFAULT NULL COMMENT '奖励金额',
  `status` enum('pending','in_progress','completed') NOT NULL DEFAULT 'pending' COMMENT '任务状态',
  `completed_at` timestamp NULL DEFAULT NULL COMMENT '完成时间',
  `created_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_task` (`user_id`, `task_type`, `task_id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_task_type` (`task_type`),
  KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='任务表';
```

### 3. 答题记录表 (quiz_records)
```sql
CREATE TABLE `quiz_records` (
  `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT COMMENT '记录ID',
  `user_id` bigint(20) unsigned NOT NULL COMMENT '用户ID',
  `question_id` varchar(50) NOT NULL COMMENT '题目ID',
  `question` text NOT NULL COMMENT '题目内容',
  `options` json NOT NULL COMMENT '选项',
  `correct_answer` varchar(10) NOT NULL COMMENT '正确答案',
  `user_answer` varchar(10) DEFAULT NULL COMMENT '用户答案',
  `is_correct` tinyint(1) DEFAULT NULL COMMENT '是否正确',
  `answered_at` timestamp NULL DEFAULT NULL COMMENT '答题时间',
  `created_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_question` (`user_id`, `question_id`),
  KEY `idx_user_id` (`user_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='答题记录表';
```

### 4. 红包活动表 (redpacket_events)
```sql
CREATE TABLE `redpacket_events` (
  `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT COMMENT '活动ID',
  `event_date` date NOT NULL COMMENT '活动日期',
  `event_time` time NOT NULL COMMENT '活动时间',
  `total_amount` decimal(15,8) NOT NULL COMMENT '红包总金额',
  `participant_count` int(11) NOT NULL DEFAULT 0 COMMENT '参与人数',
  `distributed_amount` decimal(15,8) NOT NULL DEFAULT 0.00000000 COMMENT '已分发金额',
  `status` enum('pending','active','completed') NOT NULL DEFAULT 'pending' COMMENT '活动状态',
  `start_time` timestamp NULL DEFAULT NULL COMMENT '开始时间',
  `end_time` timestamp NULL DEFAULT NULL COMMENT '结束时间',
  `created_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_date_time` (`event_date`, `event_time`),
  KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='红包活动表';
```

### 5. 红包记录表 (redpacket_records)
```sql
CREATE TABLE `redpacket_records` (
  `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT COMMENT '记录ID',
  `event_id` bigint(20) unsigned NOT NULL COMMENT '活动ID',
  `user_id` bigint(20) unsigned NOT NULL COMMENT '用户ID',
  `amount` decimal(15,8) NOT NULL COMMENT '红包金额',
  `grab_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '抢红包时间',
  `rank` int(11) DEFAULT NULL COMMENT '排名',
  `created_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_event_user` (`event_id`, `user_id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_grab_time` (`grab_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='红包记录表';
```

### 6. 钱包交易表 (wallet_transactions)
```sql
CREATE TABLE `wallet_transactions` (
  `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT COMMENT '交易ID',
  `user_id` bigint(20) unsigned NOT NULL COMMENT '用户ID',
  `transaction_id` varchar(100) NOT NULL COMMENT '交易流水号',
  `type` enum('activate','withdraw','redpacket','task','commission') NOT NULL COMMENT '交易类型',
  `amount` decimal(15,8) NOT NULL COMMENT '交易金额',
  `fee` decimal(15,8) DEFAULT 0.00000000 COMMENT '手续费',
  `balance_before` decimal(15,8) NOT NULL COMMENT '交易前余额',
  `balance_after` decimal(15,8) NOT NULL COMMENT '交易后余额',
  `status` enum('pending','completed','failed','cancelled') NOT NULL DEFAULT 'pending' COMMENT '交易状态',
  `description` varchar(255) DEFAULT NULL COMMENT '交易描述',
  `blockchain_tx_hash` varchar(255) DEFAULT NULL COMMENT '区块链交易哈希',
  `wallet_address` varchar(255) DEFAULT NULL COMMENT '钱包地址',
  `created_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_transaction_id` (`transaction_id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_type` (`type`),
  KEY `idx_status` (`status`),
  KEY `idx_created_at` (`created_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='钱包交易表';
```

### 7. 团队关系表 (team_relations)
```sql
CREATE TABLE `team_relations` (
  `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT COMMENT '关系ID',
  `user_id` bigint(20) unsigned NOT NULL COMMENT '用户ID',
  `ancestor_id` bigint(20) unsigned NOT NULL COMMENT '上级ID',
  `level` tinyint(4) NOT NULL COMMENT '层级(1-7)',
  `path` varchar(500) NOT NULL COMMENT '路径',
  `created_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_ancestor_level` (`user_id`, `ancestor_id`, `level`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_ancestor_id` (`ancestor_id`),
  KEY `idx_level` (`level`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='团队关系表';
```

### 8. 激活订单表 (activation_orders)
```sql
CREATE TABLE `activation_orders` (
  `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT COMMENT '订单ID',
  `user_id` bigint(20) unsigned NOT NULL COMMENT '用户ID',
  `order_id` varchar(100) NOT NULL COMMENT '订单号',
  `amount` decimal(15,8) NOT NULL DEFAULT 100.00000000 COMMENT '激活金额',
  `currency` varchar(10) NOT NULL DEFAULT 'USDT' COMMENT '币种',
  `wallet_address` varchar(255) NOT NULL COMMENT '收款钱包地址',
  `blockchain_tx_hash` varchar(255) DEFAULT NULL COMMENT '区块链交易哈希',
  `status` enum('pending','confirmed','failed','expired') NOT NULL DEFAULT 'pending' COMMENT '订单状态',
  `confirmed_at` timestamp NULL DEFAULT NULL COMMENT '确认时间',
  `expired_at` timestamp NULL DEFAULT NULL COMMENT '过期时间',
  `created_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_order_id` (`order_id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_status` (`status`),
  KEY `idx_wallet_address` (`wallet_address`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='激活订单表';
```

### 9. 系统配置表 (system_configs)
```sql
CREATE TABLE `system_configs` (
  `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT COMMENT '配置ID',
  `config_key` varchar(100) NOT NULL COMMENT '配置键',
  `config_value` text NOT NULL COMMENT '配置值',
  `description` varchar(255) DEFAULT NULL COMMENT '配置描述',
  `created_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_config_key` (`config_key`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='系统配置表';
```

### 10. 通知记录表 (notifications)
```sql
CREATE TABLE `notifications` (
  `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT COMMENT '通知ID',
  `user_id` bigint(20) unsigned NOT NULL COMMENT '用户ID',
  `type` varchar(50) NOT NULL COMMENT '通知类型',
  `title` varchar(255) NOT NULL COMMENT '通知标题',
  `content` text NOT NULL COMMENT '通知内容',
  `is_read` tinyint(1) NOT NULL DEFAULT 0 COMMENT '是否已读',
  `read_at` timestamp NULL DEFAULT NULL COMMENT '阅读时间',
  `created_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_type` (`type`),
  KEY `idx_is_read` (`is_read`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='通知记录表';
```

## 索引优化

### 复合索引
```sql
-- 用户状态查询优化
ALTER TABLE users ADD INDEX idx_status_countdown (status, countdown_end_time);

-- 团队统计优化
ALTER TABLE team_relations ADD INDEX idx_ancestor_level (ancestor_id, level);

-- 交易记录查询优化
ALTER TABLE wallet_transactions ADD INDEX idx_user_type_time (user_id, type, created_at);

-- 红包排行榜优化
ALTER TABLE redpacket_records ADD INDEX idx_user_amount (user_id, amount);

-- 任务进度查询优化
ALTER TABLE tasks ADD INDEX idx_user_type_status (user_id, task_type, status);
```

## 数据初始化

### 系统配置初始化
```sql
INSERT INTO system_configs (config_key, config_value, description) VALUES
('activation_amount', '100.00000000', '激活金额(USDT)'),
('countdown_hours', '168', '倒计时小时数'),
('commission_per_level', '10.00000000', '每层佣金(USDT)'),
('withdraw_fixed_fee', '2.00000000', '提现固定手续费(USDT)'),
('withdraw_min_amount', '20.00000000', '最小提现金额(USDT)'),
('withdraw_max_amount', '2000.00000000', '最大提现金额(USDT)'),
('daily_withdraw_limit', '50000.00000000', '每日提现限额(USDT)'),
('redpacket_times', '["09:00:00","12:00:00","20:00:00"]', '红包时间'),
('redpacket_duration', '77', '红包持续时间(秒)'),
('base_fee_rate', '5.00', '基础手续费率(%)'),
('min_fee_rate', '1.00', '最低手续费率(%)'),
('fee_reduction_per_question', '0.20', '每题减少手续费率(%)');
```

### 题库初始化
```sql
INSERT INTO quiz_records (user_id, question_id, question, options, correct_answer) VALUES
(0, 'Q001', '如何正确发展下线？', '["A. 诚实介绍项目", "B. 夸大收益", "C. 隐瞒风险", "D. 强制推荐"]', 'A'),
(0, 'Q002', '团队裂变的核心是什么？', '["A. 数量", "B. 质量", "C. 培训", "D. 激励"]', 'C'),
-- ... 更多题目
```

## Redis缓存设计

### 缓存键命名规范
```
user:info:{user_id}              # 用户信息
user:status:{user_id}            # 用户状态
user:balance:{user_id}           # 用户余额
team:count:{user_id}             # 团队人数
redpacket:event:{date}:{time}    # 红包活动
redpacket:pool:{event_id}        # 红包池
task:progress:{user_id}          # 任务进度
ranking:team:{type}:{period}     # 团队排行榜
ranking:redpacket:{period}       # 红包排行榜
ranking:master                   # 大神排行榜
```

### 缓存过期时间
- 用户信息: 30分钟
- 用户状态: 10分钟
- 团队统计: 1小时
- 排行榜: 30分钟
- 红包活动: 实时更新

## 数据备份策略

### 备份计划
- **全量备份**: 每日凌晨2点
- **增量备份**: 每4小时一次
- **日志备份**: 实时备份
- **保留周期**: 30天

### 备份脚本
```bash
#!/bin/bash
# 数据库备份脚本
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/backup/mysql"
DB_NAME="h5_game"

mysqldump -u root -p${MYSQL_PASSWORD} \
  --single-transaction \
  --routines \
  --triggers \
  ${DB_NAME} > ${BACKUP_DIR}/${DB_NAME}_${DATE}.sql

# 压缩备份文件
gzip ${BACKUP_DIR}/${DB_NAME}_${DATE}.sql

# 删除30天前的备份
find ${BACKUP_DIR} -name "*.sql.gz" -mtime +30 -delete
```

## 性能监控

### 慢查询监控
```sql
-- 开启慢查询日志
SET GLOBAL slow_query_log = 'ON';
SET GLOBAL long_query_time = 1;
SET GLOBAL log_queries_not_using_indexes = 'ON';
```

### 关键指标监控
- 连接数使用率
- 查询响应时间
- 锁等待时间
- 缓存命中率
- 磁盘I/O使用率