# 数字钱包管理后台技术架构设计文档

## 文档概述

### 文档信息
- **文档名称**: 数字钱包管理后台技术架构设计
- **版本**: v1.0
- **创建日期**: 2024年12月
- **负责人**: 产品经理 & 技术架构师
- **审核状态**: 待审核

### 项目背景
基于现有数字钱包系统，设计和构建功能完善的管理后台系统，为管理员和运营人员提供高效、安全、易用的管理工具。

## 1. 整体架构设计

### 1.1 系统架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        管理后台系统架构                          │
├─────────────────────────────────────────────────────────────────┤
│  前端层 (Frontend Layer)                                        │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │   管理员界面     │  │   运营人员界面   │  │   移动端管理     │ │
│  │   (Admin UI)    │  │  (Operator UI)  │  │  (Mobile Admin) │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
├─────────────────────────────────────────────────────────────────┤
│  网关层 (Gateway Layer)                                         │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │   Nginx 反向代理 │  │   API 网关       │  │   负载均衡器     │ │
│  │   (Reverse Proxy)│  │  (API Gateway)  │  │ (Load Balancer) │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
├─────────────────────────────────────────────────────────────────┤
│  应用层 (Application Layer)                                     │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │   管理后台API    │  │   认证授权服务   │  │   数据分析服务   │ │
│  │  (Admin API)    │  │  (Auth Service) │  │ (Analytics API) │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │   用户钱包API    │  │   监控告警服务   │  │   文件处理服务   │ │
│  │  (Wallet API)   │  │ (Monitor Service)│  │  (File Service) │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
├─────────────────────────────────────────────────────────────────┤
│  数据层 (Data Layer)                                            │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │   MySQL 主库     │  │   Redis 缓存     │  │   InfluxDB      │ │
│  │  (Primary DB)   │  │    (Cache)      │  │  (Time Series)  │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │   MySQL 从库     │  │   Elasticsearch │  │   文件存储       │ │
│  │  (Replica DB)   │  │   (Log Search)  │  │ (File Storage)  │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
├─────────────────────────────────────────────────────────────────┤
│  基础设施层 (Infrastructure Layer)                              │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │   Docker 容器    │  │   Kubernetes    │  │   云服务平台     │ │
│  │  (Containers)   │  │   (Orchestration)│  │ (Cloud Platform)│ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

### 1.2 技术选型原则

#### 技术选型标准
1. **稳定性优先**: 选择成熟稳定的技术栈
2. **安全性保障**: 满足金融级安全要求
3. **可扩展性**: 支持业务快速增长
4. **开发效率**: 提高开发和维护效率
5. **成本控制**: 合理控制技术成本

#### 现有技术栈分析
```javascript
/**
 * 现有技术栈评估
 */
const CURRENT_TECH_STACK = {
  // 前端技术
  frontend: {
    html: { version: 'HTML5', status: '成熟', recommendation: '保持' },
    css: { version: 'CSS3', status: '成熟', recommendation: '增强' },
    javascript: { version: 'ES6+', status: '原生', recommendation: '框架化' }
  },
  
  // 后端技术
  backend: {
    nodejs: { version: '16+', status: '成熟', recommendation: '保持' },
    express: { version: '4.x', status: '成熟', recommendation: '保持' },
    mysql: { version: '8.0', status: '成熟', recommendation: '优化' }
  },
  
  // 区块链集成
  blockchain: {
    tatum: { version: 'latest', status: '稳定', recommendation: '保持' },
    tron: { network: 'mainnet', status: '稳定', recommendation: '保持' }
  },
  
  // 安全组件
  security: {
    kms: { provider: 'AWS/Aliyun', status: '企业级', recommendation: '保持' },
    encryption: { algorithm: 'AES-256', status: '标准', recommendation: '保持' }
  }
};
```

## 2. 前端技术架构

### 2.1 前端技术选型

#### 核心框架选择
```javascript
/**
 * 前端技术栈升级方案
 */
const FRONTEND_TECH_STACK = {
  // 核心框架
  framework: {
    name: 'React',
    version: '18.x',
    reason: '组件化开发、生态丰富、团队熟悉度高'
  },
  
  // 状态管理
  stateManagement: {
    name: 'Redux Toolkit',
    version: '1.9.x',
    reason: '状态管理规范、调试工具完善'
  },
  
  // 路由管理
  routing: {
    name: 'React Router',
    version: '6.x',
    reason: '官方推荐、功能完善'
  },
  
  // UI组件库
  uiLibrary: {
    name: 'Ant Design',
    version: '5.x',
    reason: '企业级组件、中后台场景适配'
  },
  
  // 构建工具
  buildTool: {
    name: 'Vite',
    version: '4.x',
    reason: '快速构建、热更新、现代化'
  },
  
  // 代码质量
  codeQuality: {
    typescript: '5.x',
    eslint: '8.x',
    prettier: '2.x',
    husky: '8.x'
  }
};
```

### 2.2 前端项目结构

#### 目录结构设计
```
admin-frontend/
├── public/                     # 静态资源
│   ├── index.html
│   ├── favicon.ico
│   └── manifest.json
├── src/                        # 源代码
│   ├── components/             # 通用组件
│   │   ├── Layout/            # 布局组件
│   │   ├── Charts/            # 图表组件
│   │   ├── Forms/             # 表单组件
│   │   └── Common/            # 公共组件
│   ├── pages/                 # 页面组件
│   │   ├── Dashboard/         # 仪表板
│   │   ├── Users/             # 用户管理
│   │   ├── Wallets/           # 钱包管理
│   │   ├── Transactions/      # 交易管理
│   │   ├── Tasks/             # 任务管理
│   │   ├── RedPackets/        # 红包管理
│   │   ├── Teams/             # 团队管理
│   │   ├── Rankings/          # 排行榜管理
│   │   ├── Monitoring/        # 系统监控
│   │   └── Settings/          # 系统设置
│   ├── hooks/                 # 自定义Hooks
│   │   ├── useAuth.js         # 认证Hook
│   │   ├── useApi.js          # API调用Hook
│   │   └── useWebSocket.js    # WebSocket Hook
│   ├── services/              # API服务
│   │   ├── api.js             # API配置
│   │   ├── auth.js            # 认证服务
│   │   ├── users.js           # 用户服务
│   │   ├── wallets.js         # 钱包服务
│   │   └── monitoring.js      # 监控服务
│   ├── store/                 # 状态管理
│   │   ├── index.js           # Store配置
│   │   ├── slices/            # Redux Slices
│   │   └── middleware/        # 中间件
│   ├── utils/                 # 工具函数
│   │   ├── constants.js       # 常量定义
│   │   ├── helpers.js         # 辅助函数
│   │   ├── validators.js      # 验证函数
│   │   └── formatters.js      # 格式化函数
│   ├── styles/                # 样式文件
│   │   ├── globals.css        # 全局样式
│   │   ├── variables.css      # CSS变量
│   │   └── themes/            # 主题样式
│   ├── assets/                # 静态资源
│   │   ├── images/            # 图片资源
│   │   ├── icons/             # 图标资源
│   │   └── fonts/             # 字体资源
│   ├── config/                # 配置文件
│   │   ├── env.js             # 环境配置
│   │   └── routes.js          # 路由配置
│   ├── App.jsx                # 根组件
│   └── main.jsx               # 入口文件
├── tests/                     # 测试文件
│   ├── __mocks__/             # Mock文件
│   ├── components/            # 组件测试
│   └── utils/                 # 工具测试
├── docs/                      # 文档
├── .env.example               # 环境变量示例
├── .gitignore                 # Git忽略文件
├── package.json               # 依赖配置
├── vite.config.js             # Vite配置
├── tsconfig.json              # TypeScript配置
├── eslint.config.js           # ESLint配置
└── README.md                  # 项目说明
```

### 2.3 核心组件设计

#### 布局组件
```jsx
/**
 * 管理后台主布局组件
 */
import React, { useState, useEffect } from 'react';
import { Layout, Menu, Avatar, Dropdown, Badge, Breadcrumb } from 'antd';
import { 
  DashboardOutlined, 
  UserOutlined, 
  WalletOutlined,
  TransactionOutlined,
  TasksOutlined,
  GiftOutlined,
  TeamOutlined,
  TrophyOutlined,
  MonitorOutlined,
  SettingOutlined,
  LogoutOutlined,
  BellOutlined
} from '@ant-design/icons';
import { useNavigate, useLocation } from 'react-router-dom';
import { useSelector, useDispatch } from 'react-redux';

const { Header, Sider, Content } = Layout;

const AdminLayout = ({ children }) => {
  const [collapsed, setCollapsed] = useState(false);
  const [notifications, setNotifications] = useState([]);
  const navigate = useNavigate();
  const location = useLocation();
  const dispatch = useDispatch();
  
  const { user, permissions } = useSelector(state => state.auth);
  
  // 菜单配置
  const menuItems = [
    {
      key: '/dashboard',
      icon: <DashboardOutlined />,
      label: '仪表板',
      permission: 'dashboard.view'
    },
    {
      key: '/users',
      icon: <UserOutlined />,
      label: '用户管理',
      permission: 'users.view',
      children: [
        { key: '/users/list', label: '用户列表' },
        { key: '/users/analytics', label: '用户分析' }
      ]
    },
    {
      key: '/wallets',
      icon: <WalletOutlined />,
      label: '钱包管理',
      permission: 'wallets.view',
      children: [
        { key: '/wallets/overview', label: '钱包概览' },
        { key: '/wallets/addresses', label: '地址管理' },
        { key: '/wallets/balances', label: '余额监控' }
      ]
    },
    {
      key: '/transactions',
      icon: <TransactionOutlined />,
      label: '交易管理',
      permission: 'transactions.view',
      children: [
        { key: '/transactions/list', label: '交易记录' },
        { key: '/transactions/deposits', label: '充值管理' },
        { key: '/transactions/withdrawals', label: '提现管理' }
      ]
    },
    {
      key: '/tasks',
      icon: <TasksOutlined />,
      label: '任务管理',
      permission: 'tasks.view'
    },
    {
      key: '/red-packets',
      icon: <GiftOutlined />,
      label: '红包管理',
      permission: 'red_packets.view'
    },
    {
      key: '/teams',
      icon: <TeamOutlined />,
      label: '团队管理',
      permission: 'teams.view'
    },
    {
      key: '/rankings',
      icon: <TrophyOutlined />,
      label: '排行榜',
      permission: 'rankings.view'
    },
    {
      key: '/monitoring',
      icon: <MonitorOutlined />,
      label: '系统监控',
      permission: 'monitoring.view',
      children: [
        { key: '/monitoring/system', label: '系统状态' },
        { key: '/monitoring/alerts', label: '告警管理' },
        { key: '/monitoring/logs', label: '日志查看' }
      ]
    },
    {
      key: '/settings',
      icon: <SettingOutlined />,
      label: '系统设置',
      permission: 'settings.view',
      children: [
        { key: '/settings/admins', label: '管理员管理' },
        { key: '/settings/roles', label: '角色权限' },
        { key: '/settings/system', label: '系统参数' }
      ]
    }
  ];
  
  // 过滤有权限的菜单
  const filterMenuByPermission = (items) => {
    return items.filter(item => {
      if (item.permission && !permissions.includes(item.permission)) {
        return false;
      }
      if (item.children) {
        item.children = filterMenuByPermission(item.children);
      }
      return true;
    });
  };
  
  const filteredMenuItems = filterMenuByPermission(menuItems);
  
  // 用户下拉菜单
  const userMenuItems = [
    {
      key: 'profile',
      icon: <UserOutlined />,
      label: '个人资料'
    },
    {
      key: 'settings',
      icon: <SettingOutlined />,
      label: '账户设置'
    },
    {
      type: 'divider'
    },
    {
      key: 'logout',
      icon: <LogoutOutlined />,
      label: '退出登录',
      danger: true
    }
  ];
  
  // 处理菜单点击
  const handleMenuClick = ({ key }) => {
    navigate(key);
  };
  
  // 处理用户菜单点击
  const handleUserMenuClick = ({ key }) => {
    switch (key) {
      case 'profile':
        navigate('/profile');
        break;
      case 'settings':
        navigate('/account-settings');
        break;
      case 'logout':
        dispatch(logout());
        navigate('/login');
        break;
    }
  };
  
  // 生成面包屑
  const generateBreadcrumb = () => {
    const pathSnippets = location.pathname.split('/').filter(i => i);
    const breadcrumbItems = pathSnippets.map((snippet, index) => {
      const url = `/${pathSnippets.slice(0, index + 1).join('/')}`;
      const menuItem = findMenuItemByPath(url, menuItems);
      
      return {
        title: menuItem?.label || snippet,
        path: url
      };
    });
    
    return [{ title: '首页', path: '/' }, ...breadcrumbItems];
  };
  
  // 查找菜单项
  const findMenuItemByPath = (path, items) => {
    for (const item of items) {
      if (item.key === path) return item;
      if (item.children) {
        const found = findMenuItemByPath(path, item.children);
        if (found) return found;
      }
    }
    return null;
  };
  
  return (
    <Layout style={{ minHeight: '100vh' }}>
      <Sider 
        trigger={null} 
        collapsible 
        collapsed={collapsed}
        theme="dark"
        width={256}
      >
        <div className="logo" style={{ 
          height: 64, 
          margin: 16, 
          background: 'rgba(255, 255, 255, 0.3)',
          borderRadius: 6,
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          color: 'white',
          fontSize: 18,
          fontWeight: 'bold'
        }}>
          {collapsed ? '钱包' : '数字钱包管理'}
        </div>
        
        <Menu
          theme="dark"
          mode="inline"
          selectedKeys={[location.pathname]}
          items={filteredMenuItems}
          onClick={handleMenuClick}
        />
      </Sider>
      
      <Layout>
        <Header style={{ 
          padding: '0 24px', 
          background: '#fff',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'space-between',
          boxShadow: '0 1px 4px rgba(0,21,41,.08)'
        }}>
          <div style={{ display: 'flex', alignItems: 'center' }}>
            <Button
              type="text"
              icon={collapsed ? <MenuUnfoldOutlined /> : <MenuFoldOutlined />}
              onClick={() => setCollapsed(!collapsed)}
              style={{ fontSize: 16, width: 64, height: 64 }}
            />
            
            <Breadcrumb style={{ marginLeft: 16 }}>
              {generateBreadcrumb().map((item, index) => (
                <Breadcrumb.Item key={index}>
                  {index === generateBreadcrumb().length - 1 ? (
                    item.title
                  ) : (
                    <a onClick={() => navigate(item.path)}>{item.title}</a>
                  )}
                </Breadcrumb.Item>
              ))}
            </Breadcrumb>
          </div>
          
          <div style={{ display: 'flex', alignItems: 'center', gap: 16 }}>
            <Badge count={notifications.length} size="small">
              <Button 
                type="text" 
                icon={<BellOutlined />} 
                size="large"
              />
            </Badge>
            
            <Dropdown
              menu={{ items: userMenuItems, onClick: handleUserMenuClick }}
              placement="bottomRight"
            >
              <div style={{ 
                display: 'flex', 
                alignItems: 'center', 
                cursor: 'pointer',
                padding: '8px 12px',
                borderRadius: 6,
                transition: 'background-color 0.3s'
              }}>
                <Avatar 
                  src={user?.avatar} 
                  icon={<UserOutlined />} 
                  size="small"
                  style={{ marginRight: 8 }}
                />
                <span>{user?.name || '管理员'}</span>
              </div>
            </Dropdown>
          </div>
        </Header>
        
        <Content style={{ 
          margin: 24, 
          padding: 24, 
          background: '#fff',
          borderRadius: 8,
          minHeight: 'calc(100vh - 112px)'
        }}>
          {children}
        </Content>
      </Layout>
    </Layout>
  );
};

export default AdminLayout;
```

### 2.4 状态管理设计

#### Redux Store配置
```javascript
/**
 * Redux Store配置
 */
import { configureStore } from '@reduxjs/toolkit';
import { persistStore, persistReducer } from 'redux-persist';
import storage from 'redux-persist/lib/storage';

// Slices导入
import authSlice from './slices/authSlice';
import usersSlice from './slices/usersSlice';
import walletsSlice from './slices/walletsSlice';
import transactionsSlice from './slices/transactionsSlice';
import monitoringSlice from './slices/monitoringSlice';
import notificationsSlice from './slices/notificationsSlice';

// 持久化配置
const persistConfig = {
  key: 'root',
  storage,
  whitelist: ['auth'] // 只持久化认证信息
};

const rootReducer = {
  auth: persistReducer(persistConfig, authSlice),
  users: usersSlice,
  wallets: walletsSlice,
  transactions: transactionsSlice,
  monitoring: monitoringSlice,
  notifications: notificationsSlice
};

// 创建Store
export const store = configureStore({
  reducer: rootReducer,
  middleware: (getDefaultMiddleware) =>
    getDefaultMiddleware({
      serializableCheck: {
        ignoredActions: ['persist/PERSIST', 'persist/REHYDRATE']
      }
    }),
  devTools: process.env.NODE_ENV !== 'production'
});

export const persistor = persistStore(store);
export type RootState = ReturnType<typeof store.getState>;
export type AppDispatch = typeof store.dispatch;
```

## 3. 后端技术架构

### 3.1 后端技术选型

#### 技术栈保持与增强
```javascript
/**
 * 后端技术栈配置
 */
const BACKEND_TECH_STACK = {
  // 核心框架 (保持现有)
  runtime: {
    name: 'Node.js',
    version: '18.x LTS',
    reason: '现有技术栈、性能优秀、生态丰富'
  },
  
  // Web框架 (保持现有)
  framework: {
    name: 'Express.js',
    version: '4.18.x',
    reason: '轻量级、灵活、中间件丰富'
  },
  
  // 数据库 (优化现有)
  database: {
    primary: {
      name: 'MySQL',
      version: '8.0',
      reason: '现有数据、ACID特性、成熟稳定'
    },
    cache: {
      name: 'Redis',
      version: '7.x',
      reason: '高性能缓存、会话存储'
    },
    timeSeries: {
      name: 'InfluxDB',
      version: '2.x',
      reason: '监控数据、时序数据存储'
    },
    search: {
      name: 'Elasticsearch',
      version: '8.x',
      reason: '日志搜索、全文检索'
    }
  },
  
  // 新增组件
  messageQueue: {
    name: 'Bull Queue',
    version: '4.x',
    reason: '任务队列、异步处理'
  },
  
  validation: {
    name: 'Joi',
    version: '17.x',
    reason: '数据验证、API参数校验'
  },
  
  documentation: {
    name: 'Swagger/OpenAPI',
    version: '3.0',
    reason: 'API文档生成、接口测试'
  },
  
  testing: {
    name: 'Jest + Supertest',
    version: 'latest',
    reason: '单元测试、集成测试'
  }
};
```

### 3.2 后端项目结构

#### 目录结构设计
```
admin-backend/
├── src/                        # 源代码
│   ├── controllers/            # 控制器
│   │   ├── auth.controller.js  # 认证控制器
│   │   ├── users.controller.js # 用户控制器
│   │   ├── wallets.controller.js # 钱包控制器
│   │   ├── transactions.controller.js # 交易控制器
│   │   ├── tasks.controller.js # 任务控制器
│   │   ├── redPackets.controller.js # 红包控制器
│   │   ├── teams.controller.js # 团队控制器
│   │   ├── rankings.controller.js # 排行榜控制器
│   │   ├── monitoring.controller.js # 监控控制器
│   │   └── settings.controller.js # 设置控制器
│   ├── services/               # 业务服务
│   │   ├── auth.service.js     # 认证服务
│   │   ├── users.service.js    # 用户服务
│   │   ├── wallets.service.js  # 钱包服务
│   │   ├── transactions.service.js # 交易服务
│   │   ├── analytics.service.js # 分析服务
│   │   ├── notification.service.js # 通知服务
│   │   └── export.service.js   # 导出服务
│   ├── models/                 # 数据模型
│   │   ├── User.js             # 用户模型
│   │   ├── Wallet.js           # 钱包模型
│   │   ├── Transaction.js      # 交易模型
│   │   ├── Admin.js            # 管理员模型
│   │   ├── Role.js             # 角色模型
│   │   └── Permission.js       # 权限模型
│   ├── middleware/             # 中间件
│   │   ├── auth.middleware.js  # 认证中间件
│   │   ├── permission.middleware.js # 权限中间件
│   │   ├── validation.middleware.js # 验证中间件
│   │   ├── rateLimit.middleware.js # 限流中间件
│   │   ├── audit.middleware.js # 审计中间件
│   │   └── error.middleware.js # 错误处理中间件
│   ├── routes/                 # 路由定义
│   │   ├── index.js            # 路由入口
│   │   ├── auth.routes.js      # 认证路由
│   │   ├── users.routes.js     # 用户路由
│   │   ├── wallets.routes.js   # 钱包路由
│   │   ├── transactions.routes.js # 交易路由
│   │   ├── analytics.routes.js # 分析路由
│   │   └── monitoring.routes.js # 监控路由
│   ├── utils/                  # 工具函数
│   │   ├── database.js         # 数据库工具
│   │   ├── redis.js            # Redis工具
│   │   ├── encryption.js       # 加密工具
│   │   ├── validation.js       # 验证工具
│   │   ├── logger.js           # 日志工具
│   │   └── helpers.js          # 辅助函数
│   ├── config/                 # 配置文件
│   │   ├── database.js         # 数据库配置
│   │   ├── redis.js            # Redis配置
│   │   ├── auth.js             # 认证配置
│   │   ├── monitoring.js       # 监控配置
│   │   └── index.js            # 配置入口
│   ├── jobs/                   # 定时任务
│   │   ├── dataSync.job.js     # 数据同步任务
│   │   ├── cleanup.job.js      # 清理任务
│   │   └── monitoring.job.js   # 监控任务
│   ├── validators/             # 数据验证
│   │   ├── auth.validator.js   # 认证验证
│   │   ├── users.validator.js  # 用户验证
│   │   └── transactions.validator.js # 交易验证
│   └── app.js                  # 应用入口
├── tests/                      # 测试文件
│   ├── unit/                   # 单元测试
│   ├── integration/            # 集成测试
│   └── fixtures/               # 测试数据
├── docs/                       # API文档
│   ├── swagger.yaml            # Swagger配置
│   └── api/                    # API文档
├── scripts/                    # 脚本文件
│   ├── migrate.js              # 数据迁移
│   ├── seed.js                 # 数据填充
│   └── deploy.js               # 部署脚本
├── logs/                       # 日志文件
├── uploads/                    # 上传文件
├── .env.example                # 环境变量示例
├── .gitignore                  # Git忽略文件
├── package.json                # 依赖配置
├── jest.config.js              # Jest配置
├── nodemon.json                # Nodemon配置
└── README.md                   # 项目说明
```

### 3.3 核心服务设计

#### 认证授权服务
```javascript
/**
 * 认证授权服务
 */
const jwt = require('jsonwebtoken');
const bcrypt = require('bcryptjs');
const speakeasy = require('speakeasy');
const QRCode = require('qrcode');
const { Admin, Role, Permission } = require('../models');
const { redis } = require('../utils/redis');
const { logger } = require('../utils/logger');

class AuthService {
  /**
   * 管理员登录
   */
  async login(username, password, totpCode, ipAddress, userAgent) {
    try {
      // 查找管理员
      const admin = await Admin.findOne({
        where: { username, status: 'active' },
        include: [{
          model: Role,
          include: [Permission]
        }]
      });
      
      if (!admin) {
        await this.logFailedLogin(username, ipAddress, '用户不存在');
        throw new Error('用户名或密码错误');
      }
      
      // 检查密码
      const isPasswordValid = await bcrypt.compare(password, admin.password);
      if (!isPasswordValid) {
        await this.logFailedLogin(username, ipAddress, '密码错误');
        throw new Error('用户名或密码错误');
      }
      
      // 检查2FA
      if (admin.two_factor_enabled) {
        if (!totpCode) {
          throw new Error('请输入两步验证码');
        }
        
        const isValidTotp = speakeasy.totp.verify({
          secret: admin.two_factor_secret,
          encoding: 'base32',
          token: totpCode,
          window: 2
        });
        
        if (!isValidTotp) {
          await this.logFailedLogin(username, ipAddress, '2FA验证失败');
          throw new Error('两步验证码错误');
        }
      }
      
      // 生成JWT Token
      const payload = {
        adminId: admin.id,
        username: admin.username,
        roleId: admin.role_id,
        permissions: admin.Role.Permissions.map(p => p.code)
      };
      
      const accessToken = jwt.sign(payload, process.env.JWT_SECRET, {
        expiresIn: process.env.JWT_EXPIRES_IN || '8h'
      });
      
      const refreshToken = jwt.sign(
        { adminId: admin.id }, 
        process.env.JWT_REFRESH_SECRET,
        { expiresIn: '7d' }
      );
      
      // 存储刷新令牌
      await redis.setex(
        `refresh_token:${admin.id}`, 
        7 * 24 * 3600, 
        refreshToken
      );
      
      // 记录登录日志
      await this.logSuccessfulLogin(admin.id, ipAddress, userAgent);
      
      // 更新最后登录时间
      await admin.update({
        last_login_at: new Date(),
        last_login_ip: ipAddress
      });
      
      return {
        admin: {
          id: admin.id,
          username: admin.username,
          name: admin.name,
          email: admin.email,
          role: admin.Role.name,
          permissions: payload.permissions
        },
        tokens: {
          accessToken,
          refreshToken
        }
      };
      
    } catch (error) {
      logger.error('Login failed:', error);
      throw error;
    }
  }
  
  /**
   * 刷新访问令牌
   */
  async refreshToken(refreshToken) {
    try {
      const decoded = jwt.verify(refreshToken, process.env.JWT_REFRESH_SECRET);
      
      // 验证刷新令牌是否存在
      const storedToken = await redis.get(`refresh_token:${decoded.adminId}`);
      if (storedToken !== refreshToken) {
        throw new Error('刷新令牌无效');
      }
      
      // 获取管理员信息
      const admin = await Admin.findByPk(decoded.adminId, {
        include: [{
          model: Role,
          include: [Permission]
        }]
      });
      
      if (!admin || admin.status !== 'active') {
        throw new Error('管理员账户无效');
      }
      
      // 生成新的访问令牌
      const payload = {
        adminId: admin.id,
        username: admin.username,
        roleId: admin.role_id,
        permissions: admin.Role.Permissions.map(p => p.code)
      };
      
      const newAccessToken = jwt.sign(payload, process.env.JWT_SECRET, {
        expiresIn: process.env.JWT_EXPIRES_IN || '8h'
      });
      
      return { accessToken: newAccessToken };
      
    } catch (error) {
      logger.error('Token refresh failed:', error);
      throw new Error('刷新令牌失败');
    }
  }
  
  /**
   * 启用两步验证
   */
  async enableTwoFactor(adminId) {
    try {
      const admin = await Admin.findByPk(adminId);
      if (!admin) {
        throw new Error('管理员不存在');
      }
      
      // 生成密钥
      const secret = speakeasy.generateSecret({
        name: `数字钱包管理后台 (${admin.username})`,
        issuer: '数字钱包管理系统'
      });
      
      // 生成二维码
      const qrCodeUrl = await QRCode.toDataURL(secret.otpauth_url);
      
      // 临时存储密钥（等待验证）
      await redis.setex(
        `temp_2fa_secret:${adminId}`, 
        300, // 5分钟过期
        secret.base32
      );
      
      return {
        secret: secret.base32,
        qrCode: qrCodeUrl,
        manualEntryKey: secret.base32
      };
      
    } catch (error) {
      logger.error('Enable 2FA failed:', error);
      throw error;
    }
  }
  
  /**
   * 验证并确认两步验证
   */
  async confirmTwoFactor(adminId, token) {
    try {
      // 获取临时密钥
      const tempSecret = await redis.get(`temp_2fa_secret:${adminId}`);
      if (!tempSecret) {
        throw new Error('验证码已过期，请重新生成');
      }
      
      // 验证TOTP码
      const isValid = speakeasy.totp.verify({
        secret: tempSecret,
        encoding: 'base32',
        token: token,
        window: 2
      });
      
      if (!isValid) {
        throw new Error('验证码错误');
      }
      
      // 保存密钥到数据库
      await Admin.update({
        two_factor_secret: tempSecret,
        two_factor_enabled: true
      }, {
        where: { id: adminId }
      });
      
      // 删除临时密钥
      await redis.del(`temp_2fa_secret:${adminId}`);
      
      // 生成备用码
      const backupCodes = this.generateBackupCodes();
      await redis.setex(
        `backup_codes:${adminId}`,
        365 * 24 * 3600, // 1年
        JSON.stringify(backupCodes)
      );
      
      logger.info(`Two-factor authentication enabled for admin ${adminId}`);
      
      return { backupCodes };
      
    } catch (error) {
      logger.error('Confirm 2FA failed:', error);
      throw error;
    }
  }
  
  /**
   * 生成备用码
   */
  generateBackupCodes() {
    const codes = [];
    for (let i = 0; i < 10; i++) {
      codes.push(Math.random().toString(36).substring(2, 10).toUpperCase());
    }
    return codes;
  }
  
  /**
   * 记录登录失败日志
   */
  async logFailedLogin(username, ipAddress, reason) {
    // 实现登录失败日志记录
    logger.warn(`Failed login attempt: ${username} from ${ipAddress} - ${reason}`);
  }
  
  /**
   * 记录登录成功日志
   */
  async logSuccessfulLogin(adminId, ipAddress, userAgent) {
    // 实现登录成功日志记录
    logger.info(`Successful login: Admin ${adminId} from ${ipAddress}`);
  }
}

module.exports = new AuthService();
```

## 4. 数据库架构设计

### 4.1 数据库选型与配置

#### 主数据库配置
```javascript
/**
 * MySQL数据库配置
 */
const DATABASE_CONFIG = {
  // 主库配置
  primary: {
    host: process.env.DB_HOST || 'localhost',
    port: process.env.DB_PORT || 3306,
    database: process.env.DB_NAME || 'wallet_admin',
    username: process.env.DB_USER || 'root',
    password: process.env.DB_PASSWORD,
    dialect: 'mysql',
    timezone: '+08:00',
    
    // 连接池配置
    pool: {
      max: 20,
      min: 5,
      acquire: 30000,
      idle: 10000
    },
    
    // 性能优化
    dialectOptions: {
      charset: 'utf8mb4',
      collate: 'utf8mb4_unicode_ci',
      supportBigNumbers: true,
      bigNumberStrings: true,
      dateStrings: true,
      typeCast: true
    },
    
    // 日志配置
    logging: process.env.NODE_ENV === 'development' ? console.log : false,
    
    // 查询优化
    define: {
      timestamps: true,
      underscored: true,
      paranoid: true, // 软删除
      freezeTableName: true
    }
  },
  
  // 从库配置（读写分离）
  replica: {
    host: process.env.DB_REPLICA_HOST,
    port: process.env.DB_REPLICA_PORT || 3306,
    database: process.env.DB_NAME || 'wallet_admin',
    username: process.env.DB_REPLICA_USER,
    password: process.env.DB_REPLICA_PASSWORD,
    dialect: 'mysql',
    timezone: '+08:00'
  }
};
```

### 4.2 管理后台专用表设计

#### 管理员和权限表
```sql
-- 管理员表
CREATE TABLE `admins` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `username` varchar(50) NOT NULL COMMENT '用户名',
  `password` varchar(255) NOT NULL COMMENT '密码哈希',
  `name` varchar(100) NOT NULL COMMENT '姓名',
  `email` varchar(100) NOT NULL COMMENT '邮箱',
  `phone` varchar(20) DEFAULT NULL COMMENT '手机号',
  `avatar` varchar(255) DEFAULT NULL COMMENT '头像URL',
  `role_id` int(11) NOT NULL COMMENT '角色ID',
  `status` enum('active','inactive','locked') DEFAULT 'active' COMMENT '状态',
  `two_factor_enabled` tinyint(1) DEFAULT 0 COMMENT '是否启用2FA',
  `two_factor_secret` varchar(255) DEFAULT NULL COMMENT '2FA密钥',
  `last_login_at` datetime DEFAULT NULL COMMENT '最后登录时间',
  `last_login_ip` varchar(45) DEFAULT NULL COMMENT '最后登录IP',
  `login_attempts` int(11) DEFAULT 0 COMMENT '登录尝试次数',
  `locked_until` datetime DEFAULT NULL COMMENT '锁定到期时间',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `deleted_at` datetime DEFAULT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `username` (`username`),
  UNIQUE KEY `email` (`email`),
  KEY `idx_role_id` (`role_id`),
  KEY `idx_status` (`status`),
  KEY `idx_created_at` (`created_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='管理员表';

-- 角色表
CREATE TABLE `roles` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `name` varchar(50) NOT NULL COMMENT '角色名称',
  `code` varchar(50) NOT NULL COMMENT '角色代码',
  `description` text COMMENT '角色描述',
  `level` int(11) DEFAULT 1 COMMENT '角色级别',
  `status` enum('active','inactive') DEFAULT 'active' COMMENT '状态',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `deleted_at` datetime DEFAULT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `code` (`code`),
  KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='角色表';

-- 权限表
CREATE TABLE `permissions` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `name` varchar(100) NOT NULL COMMENT '权限名称',
  `code` varchar(100) NOT NULL COMMENT '权限代码',
  `module` varchar(50) NOT NULL COMMENT '所属模块',
  `action` varchar(50) NOT NULL COMMENT '操作类型',
  `resource` varchar(100) DEFAULT NULL COMMENT '资源标识',
  `description` text COMMENT '权限描述',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `code` (`code`),
  KEY `idx_module` (`module`),
  KEY `idx_action` (`action`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='权限表';

-- 角色权限关联表
CREATE TABLE `role_permissions` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `role_id` int(11) NOT NULL COMMENT '角色ID',
  `permission_id` int(11) NOT NULL COMMENT '权限ID',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `role_permission` (`role_id`,`permission_id`),
  KEY `idx_role_id` (`role_id`),
  KEY `idx_permission_id` (`permission_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='角色权限关联表';
```

#### 操作日志表
```sql
-- 管理员操作日志表
CREATE TABLE `admin_operation_logs` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `admin_id` int(11) NOT NULL COMMENT '管理员ID',
  `admin_name` varchar(100) NOT NULL COMMENT '管理员姓名',
  `module` varchar(50) NOT NULL COMMENT '操作模块',
  `action` varchar(100) NOT NULL COMMENT '操作动作',
  `resource_type` varchar(50) DEFAULT NULL COMMENT '资源类型',
  `resource_id` varchar(100) DEFAULT NULL COMMENT '资源ID',
  `description` text COMMENT '操作描述',
  `request_method` varchar(10) DEFAULT NULL COMMENT '请求方法',
  `request_url` varchar(500) DEFAULT NULL COMMENT '请求URL',
  `request_params` json DEFAULT NULL COMMENT '请求参数',
  `response_status` int(11) DEFAULT NULL COMMENT '响应状态码',
  `ip_address` varchar(45) DEFAULT NULL COMMENT 'IP地址',
  `user_agent` text COMMENT '用户代理',
  `execution_time` int(11) DEFAULT NULL COMMENT '执行时间(ms)',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_admin_id` (`admin_id`),
  KEY `idx_module_action` (`module`,`action`),
  KEY `idx_created_at` (`created_at`),
  KEY `idx_ip_address` (`ip_address`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='管理员操作日志表'
PARTITION BY RANGE (YEAR(created_at)) (
  PARTITION p2024 VALUES LESS THAN (2025),
  PARTITION p2025 VALUES LESS THAN (2026),
  PARTITION p_future VALUES LESS THAN MAXVALUE
);

-- 系统配置表
CREATE TABLE `system_configs` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `category` varchar(50) NOT NULL COMMENT '配置分类',
  `key` varchar(100) NOT NULL COMMENT '配置键',
  `value` text COMMENT '配置值',
  `type` enum('string','number','boolean','json') DEFAULT 'string' COMMENT '值类型',
  `description` text COMMENT '配置描述',
  `is_public` tinyint(1) DEFAULT 0 COMMENT '是否公开',
  `is_editable` tinyint(1) DEFAULT 1 COMMENT '是否可编辑',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `category_key` (`category`,`key`),
  KEY `idx_category` (`category`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='系统配置表';
```

### 4.3 数据统计表设计

#### 统计缓存表
```sql
-- 数据统计缓存表
CREATE TABLE `data_statistics_cache` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `metric_name` varchar(100) NOT NULL COMMENT '指标名称',
  `metric_type` varchar(50) NOT NULL COMMENT '指标类型',
  `dimension` varchar(100) DEFAULT NULL COMMENT '维度',
  `time_period` varchar(20) NOT NULL COMMENT '时间周期',
  `start_time` datetime NOT NULL COMMENT '开始时间',
  `end_time` datetime NOT NULL COMMENT '结束时间',
  `value` decimal(20,8) NOT NULL COMMENT '统计值',
  `extra_data` json DEFAULT NULL COMMENT '额外数据',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `metric_dimension_period` (`metric_name`,`dimension`,`time_period`,`start_time`),
  KEY `idx_metric_type` (`metric_type`),
  KEY `idx_time_period` (`time_period`),
  KEY `idx_start_time` (`start_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='数据统计缓存表';

-- 实时监控指标表
CREATE TABLE `monitoring_metrics` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `metric_name` varchar(100) NOT NULL COMMENT '指标名称',
  `metric_value` decimal(20,8) NOT NULL COMMENT '指标值',
  `metric_unit` varchar(20) DEFAULT NULL COMMENT '指标单位',
  `tags` json DEFAULT NULL COMMENT '标签',
  `timestamp` datetime NOT NULL COMMENT '时间戳',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_metric_name` (`metric_name`),
  KEY `idx_timestamp` (`timestamp`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='实时监控指标表'
PARTITION BY RANGE (UNIX_TIMESTAMP(timestamp)) (
  PARTITION p_current VALUES LESS THAN (UNIX_TIMESTAMP('2025-01-01')),
  PARTITION p_future VALUES LESS THAN MAXVALUE
);
```

## 5. 缓存架构设计

### 5.1 Redis缓存策略

#### 缓存配置
```javascript
/**
 * Redis缓存配置和策略
 */
const Redis = require('ioredis');

const REDIS_CONFIG = {
  // 主缓存实例
  primary: {
    host: process.env.REDIS_HOST || 'localhost',
    port: process.env.REDIS_PORT || 6379,
    password: process.env.REDIS_PASSWORD,
    db: 0,
    keyPrefix: 'wallet_admin:',
    
    // 连接配置
    connectTimeout: 10000,
    commandTimeout: 5000,
    retryDelayOnFailover: 100,
    maxRetriesPerRequest: 3,
    
    // 集群配置
    enableReadyCheck: true,
    lazyConnect: true
  },
  
  // 会话存储实例
  session: {
    host: process.env.REDIS_HOST || 'localhost',
    port: process.env.REDIS_PORT || 6379,
    password: process.env.REDIS_PASSWORD,
    db: 1,
    keyPrefix: 'session:'
  }
};

class CacheService {
  constructor() {
    this.redis = new Redis(REDIS_CONFIG.primary);
    this.sessionRedis = new Redis(REDIS_CONFIG.session);
    
    // 缓存策略配置
    this.cacheStrategies = {
      // 用户数据缓存
      users: {
        ttl: 3600, // 1小时
        prefix: 'user:',
        refreshThreshold: 300 // 5分钟内刷新
      },
      
      // 钱包数据缓存
      wallets: {
        ttl: 1800, // 30分钟
        prefix: 'wallet:',
        refreshThreshold: 180
      },
      
      // 交易统计缓存
      transactions: {
        ttl: 600, // 10分钟
        prefix: 'tx_stats:',
        refreshThreshold: 60
      },
      
      // 系统配置缓存
      configs: {
        ttl: 7200, // 2小时
        prefix: 'config:',
        refreshThreshold: 600
      },
      
      // API限流缓存
      rateLimit: {
        ttl: 3600,
        prefix: 'rate_limit:',
        refreshThreshold: 0
      }
    };
  }
  
  /**
   * 获取缓存数据
   */
  async get(key, strategy = 'default') {
    try {
      const fullKey = this.buildKey(key, strategy);
      const data = await this.redis.get(fullKey);
      
      if (data) {
        return JSON.parse(data);
      }
      
      return null;
    } catch (error) {
      console.error('Cache get error:', error);
      return null;
    }
  }
  
  /**
   * 设置缓存数据
   */
  async set(key, value, strategy = 'default', customTtl = null) {
    try {
      const fullKey = this.buildKey(key, strategy);
      const ttl = customTtl || this.cacheStrategies[strategy]?.ttl || 3600;
      
      await this.redis.setex(fullKey, ttl, JSON.stringify(value));
      return true;
    } catch (error) {
      console.error('Cache set error:', error);
      return false;
    }
  }
  
  /**
   * 删除缓存
   */
  async del(key, strategy = 'default') {
    try {
      const fullKey = this.buildKey(key, strategy);
      await this.redis.del(fullKey);
      return true;
    } catch (error) {
      console.error('Cache delete error:', error);
      return false;
    }
  }
  
  /**
   * 批量删除缓存
   */
  async delPattern(pattern, strategy = 'default') {
    try {
      const fullPattern = this.buildKey(pattern, strategy);
      const keys = await this.redis.keys(fullPattern);
      
      if (keys.length > 0) {
        await this.redis.del(...keys);
      }
      
      return keys.length;
    } catch (error) {
      console.error('Cache delete pattern error:', error);
      return 0;
    }
  }
  
  /**
   * 构建缓存键
   */
  buildKey(key, strategy) {
    const prefix = this.cacheStrategies[strategy]?.prefix || '';
    return `${prefix}${key}`;
  }
  
  /**
   * 缓存穿透保护
   */
  async getWithFallback(key, fallbackFn, strategy = 'default') {
    try {
      // 先尝试从缓存获取
      let data = await this.get(key, strategy);
      
      if (data === null) {
        // 缓存未命中，执行回调函数
        data = await fallbackFn();
        
        if (data !== null && data !== undefined) {
          // 将结果存入缓存
          await this.set(key, data, strategy);
        }
      }
      
      return data;
    } catch (error) {
      console.error('Cache fallback error:', error);
      // 缓存失败时直接执行回调
      return await fallbackFn();
    }
  }
  
  /**
   * 分布式锁
   */
  async acquireLock(lockKey, ttl = 30, retryTimes = 3) {
    const lockValue = `${Date.now()}_${Math.random()}`;
    
    for (let i = 0; i < retryTimes; i++) {
      const result = await this.redis.set(
        `lock:${lockKey}`, 
        lockValue, 
        'EX', 
        ttl, 
        'NX'
      );
      
      if (result === 'OK') {
        return lockValue;
      }
      
      // 等待一段时间后重试
      await new Promise(resolve => setTimeout(resolve, 100 * (i + 1)));
    }
    
    return null;
  }
  
  /**
   * 释放分布式锁
   */
  async releaseLock(lockKey, lockValue) {
    const script = `
      if redis.call("get", KEYS[1]) == ARGV[1] then
        return redis.call("del", KEYS[1])
      else
        return 0
      end
    `;
    
    return await this.redis.eval(script, 1, `lock:${lockKey}`, lockValue);
  }
}

module.exports = new CacheService();
```

## 6. 安全架构设计

### 6.1 安全防护体系

#### 多层安全防护
```javascript
/**
 * 安全防护配置
 */
const SECURITY_CONFIG = {
  // 认证安全
  authentication: {
    // JWT配置
    jwt: {
      secret: process.env.JWT_SECRET,
      expiresIn: '8h',
      refreshExpiresIn: '7d',
      algorithm: 'HS256'
    },
    
    // 密码策略
    password: {
      minLength: 8,
      requireUppercase: true,
      requireLowercase: true,
      requireNumbers: true,
      requireSpecialChars: true,
      maxAttempts: 5,
      lockoutDuration: 30 * 60 * 1000 // 30分钟
    },
    
    // 两步验证
    twoFactor: {
      issuer: '数字钱包管理系统',
      window: 2,
      backupCodesCount: 10
    }
  },
  
  // 访问控制
  accessControl: {
    // IP白名单
    ipWhitelist: {
      enabled: process.env.IP_WHITELIST_ENABLED === 'true',
      ips: process.env.ALLOWED_IPS?.split(',') || []
    },
    
    // 限流配置
    rateLimit: {
      windowMs: 15 * 60 * 1000, // 15分钟
      max: 100, // 最大请求数
      skipSuccessfulRequests: false,
      skipFailedRequests: false
    },
    
    // CORS配置
    cors: {
      origin: process.env.ALLOWED_ORIGINS?.split(',') || ['http://localhost:3000'],
      credentials: true,
      optionsSuccessStatus: 200
    }
  },
  
  // 数据保护
  dataProtection: {
    // 加密配置
    encryption: {
      algorithm: 'aes-256-gcm',
      keyLength: 32,
      ivLength: 16
    },
    
    // 数据脱敏
    dataMasking: {
      phone: { start: 3, end: 4 },
      email: { start: 2, end: '@' },
      idCard: { start: 6, end: 4 },
      bankCard: { start: 4, end: 4 }
    }
  },
  
  // 审计配置
  audit: {
    // 敏感操作
    sensitiveActions: [
      'user.delete',
      'wallet.transfer',
      'admin.create',
      'role.modify',
      'config.update'
    ],
    
    // 日志保留
    logRetention: {
      operation: 365, // 操作日志保留365天
      security: 730,  // 安全日志保留730天
      access: 90      // 访问日志保留90天
    }
  }
};
```

### 6.2 API安全中间件

#### 认证中间件
```javascript
/**
 * JWT认证中间件
 */
const jwt = require('jsonwebtoken');
const { Admin, Role, Permission } = require('../models');
const { redis } = require('../utils/redis');

const authMiddleware = async (req, res, next) => {
  try {
    const token = req.header('Authorization')?.replace('Bearer ', '');
    
    if (!token) {
      return res.status(401).json({
        success: false,
        message: '访问令牌缺失'
      });
    }
    
    // 验证JWT
    const decoded = jwt.verify(token, process.env.JWT_SECRET);
    
    // 检查令牌是否在黑名单中
    const isBlacklisted = await redis.get(`blacklist:${token}`);
    if (isBlacklisted) {
      return res.status(401).json({
        success: false,
        message: '令牌已失效'
      });
    }
    
    // 获取管理员信息
    const admin = await Admin.findByPk(decoded.adminId, {
      include: [{
        model: Role,
        include: [Permission]
      }]
    });
    
    if (!admin || admin.status !== 'active') {
      return res.status(401).json({
        success: false,
        message: '用户账户无效'
      });
    }
    
    // 将用户信息添加到请求对象
    req.admin = {
      id: admin.id,
      username: admin.username,
      name: admin.name,
      roleId: admin.role_id,
      permissions: admin.Role.Permissions.map(p => p.code)
    };
    
    next();
  } catch (error) {
    if (error.name === 'TokenExpiredError') {
      return res.status(401).json({
        success: false,
        message: '令牌已过期'
      });
    }
    
    return res.status(401).json({
      success: false,
      message: '令牌验证失败'
    });
  }
};
```

#### 权限控制中间件
```javascript
/**
 * 权限控制中间件
 */
const permissionMiddleware = (requiredPermission) => {
  return (req, res, next) => {
    try {
      if (!req.admin) {
        return res.status(401).json({
          success: false,
          message: '未认证用户'
        });
      }
      
      // 检查权限
      if (!req.admin.permissions.includes(requiredPermission)) {
        return res.status(403).json({
          success: false,
          message: '权限不足'
        });
      }
      
      next();
    } catch (error) {
      return res.status(500).json({
        success: false,
        message: '权限验证失败'
      });
    }
  };
};
```

## 7. 部署架构设计

### 7.1 容器化部署

#### Docker配置
```dockerfile
# 前端Dockerfile
FROM node:18-alpine AS builder

WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production

COPY . .
RUN npm run build

FROM nginx:alpine
COPY --from=builder /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/nginx.conf

EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
```

```dockerfile
# 后端Dockerfile
FROM node:18-alpine

WORKDIR /app

# 安装依赖
COPY package*.json ./
RUN npm ci --only=production

# 复制源代码
COPY . .

# 创建非root用户
RUN addgroup -g 1001 -S nodejs
RUN adduser -S nodejs -u 1001

# 设置权限
RUN chown -R nodejs:nodejs /app
USER nodejs

EXPOSE 3000

# 健康检查
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD curl -f http://localhost:3000/health || exit 1

CMD ["npm", "start"]
```

#### Docker Compose配置
```yaml
version: '3.8'

services:
  # 前端服务
  admin-frontend:
    build:
      context: ./admin-frontend
      dockerfile: Dockerfile
    ports:
      - "80:80"
    depends_on:
      - admin-backend
    networks:
      - wallet-admin-network
    restart: unless-stopped

  # 后端服务
  admin-backend:
    build:
      context: ./admin-backend
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - DB_HOST=mysql
      - REDIS_HOST=redis
    depends_on:
      - mysql
      - redis
    networks:
      - wallet-admin-network
    restart: unless-stopped
    volumes:
      - ./logs:/app/logs
      - ./uploads:/app/uploads

  # MySQL数据库
  mysql:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: wallet_admin
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./mysql/conf.d:/etc/mysql/conf.d
    networks:
      - wallet-admin-network
    restart: unless-stopped

  # Redis缓存
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - wallet-admin-network
    restart: unless-stopped
    command: redis-server --appendonly yes

  # InfluxDB时序数据库
  influxdb:
    image: influxdb:2.7
    ports:
      - "8086:8086"
    environment:
      - INFLUXDB_DB=monitoring
      - INFLUXDB_ADMIN_USER=${INFLUXDB_ADMIN_USER}
      - INFLUXDB_ADMIN_PASSWORD=${INFLUXDB_ADMIN_PASSWORD}
    volumes:
      - influxdb_data:/var/lib/influxdb2
    networks:
      - wallet-admin-network
    restart: unless-stopped

  # Elasticsearch日志存储
  elasticsearch:
    image: elasticsearch:8.11.0
    environment:
      - discovery.type=single-node
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
      - xpack.security.enabled=false
    ports:
      - "9200:9200"
    volumes:
      - elasticsearch_data:/usr/share/elasticsearch/data
    networks:
      - wallet-admin-network
    restart: unless-stopped

  # Grafana监控面板
  grafana:
    image: grafana/grafana:latest
    ports:
      - "3001:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD}
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/dashboards:/etc/grafana/provisioning/dashboards
      - ./grafana/datasources:/etc/grafana/provisioning/datasources
    networks:
      - wallet-admin-network
    restart: unless-stopped

volumes:
  mysql_data:
  redis_data:
  influxdb_data:
  elasticsearch_data:
  grafana_data:

networks:
  wallet-admin-network:
    driver: bridge
```

### 7.2 Nginx配置

#### 反向代理配置
```nginx
# nginx.conf
upstream admin_backend {
    server admin-backend:3000;
    keepalive 32;
}

server {
    listen 80;
    server_name admin.wallet.com;
    
    # 重定向到HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name admin.wallet.com;
    
    # SSL配置
    ssl_certificate /etc/ssl/certs/admin.wallet.com.crt;
    ssl_certificate_key /etc/ssl/private/admin.wallet.com.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    
    # 安全头
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'";
    
    # 限制请求大小
    client_max_body_size 10M;
    
    # API代理
    location /api/ {
        proxy_pass http://admin_backend/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # 超时设置
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }
    
    # 静态文件
    location / {
        root /usr/share/nginx/html;
        index index.html;
        try_files $uri $uri/ /index.html;
        
        # 缓存设置
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }
    
    # 健康检查
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
}
```

## 8. 监控和运维

### 8.1 系统监控配置

#### Prometheus配置
```yaml
# prometheus.yml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

rule_files:
  - "alert_rules.yml"

scrape_configs:
  - job_name: 'admin-backend'
    static_configs:
      - targets: ['admin-backend:3000']
    metrics_path: '/metrics'
    scrape_interval: 10s

  - job_name: 'mysql'
    static_configs:
      - targets: ['mysql:3306']

  - job_name: 'redis'
    static_configs:
      - targets: ['redis:6379']

alerting:
  alertmanagers:
    - static_configs:
        - targets:
          - alertmanager:9093
```

### 8.2 日志管理

#### 结构化日志配置
```javascript
/**
 * 日志配置
 */
const winston = require('winston');
const { ElasticsearchTransport } = require('winston-elasticsearch');

const loggerConfig = {
  level: process.env.LOG_LEVEL || 'info',
  format: winston.format.combine(
    winston.format.timestamp(),
    winston.format.errors({ stack: true }),
    winston.format.json()
  ),
  
  transports: [
    // 控制台输出
    new winston.transports.Console({
      format: winston.format.combine(
        winston.format.colorize(),
        winston.format.simple()
      )
    }),
    
    // 文件输出
    new winston.transports.File({
      filename: 'logs/error.log',
      level: 'error',
      maxsize: 5242880, // 5MB
      maxFiles: 5
    }),
    
    new winston.transports.File({
      filename: 'logs/combined.log',
      maxsize: 5242880,
      maxFiles: 5
    }),
    
    // Elasticsearch输出
    new ElasticsearchTransport({
      level: 'info',
      clientOpts: {
        node: process.env.ELASTICSEARCH_URL || 'http://elasticsearch:9200'
      },
      index: 'wallet-admin-logs'
    })
  ]
};

const logger = winston.createLogger(loggerConfig);

module.exports = logger;
```

## 9. 性能优化策略

### 9.1 前端性能优化

#### 代码分割和懒加载
```javascript
/**
 * 路由懒加载配置
 */
import { lazy, Suspense } from 'react';
import { Routes, Route } from 'react-router-dom';
import LoadingSpinner from '../components/LoadingSpinner';

// 懒加载页面组件
const Dashboard = lazy(() => import('../pages/Dashboard'));
const Users = lazy(() => import('../pages/Users'));
const Wallets = lazy(() => import('../pages/Wallets'));
const Transactions = lazy(() => import('../pages/Transactions'));
const Monitoring = lazy(() => import('../pages/Monitoring'));

const AppRoutes = () => {
  return (
    <Suspense fallback={<LoadingSpinner />}>
      <Routes>
        <Route path="/dashboard" element={<Dashboard />} />
        <Route path="/users/*" element={<Users />} />
        <Route path="/wallets/*" element={<Wallets />} />
        <Route path="/transactions/*" element={<Transactions />} />
        <Route path="/monitoring/*" element={<Monitoring />} />
      </Routes>
    </Suspense>
  );
};

export default AppRoutes;
```

### 9.2 后端性能优化

#### 数据库查询优化
```javascript
/**
 * 查询优化示例
 */
class OptimizedUserService {
  /**
   * 分页查询用户列表（优化版）
   */
  async getUserList(page = 1, limit = 20, filters = {}) {
    const offset = (page - 1) * limit;
    
    // 构建查询条件
    const whereClause = {};
    if (filters.status) whereClause.status = filters.status;
    if (filters.keyword) {
      whereClause[Op.or] = [
        { username: { [Op.like]: `%${filters.keyword}%` } },
        { email: { [Op.like]: `%${filters.keyword}%` } }
      ];
    }
    
    // 使用索引优化的查询
    const [users, total] = await Promise.all([
      User.findAll({
        where: whereClause,
        attributes: ['id', 'username', 'email', 'status', 'created_at'],
        limit,
        offset,
        order: [['created_at', 'DESC']],
        raw: true // 提高查询性能
      }),
      
      User.count({ where: whereClause })
    ]);
    
    return {
      users,
      pagination: {
        page,
        limit,
        total,
        pages: Math.ceil(total / limit)
      }
    };
  }
  
  /**
   * 批量获取用户钱包信息
   */
  async getUsersWithWallets(userIds) {
    // 使用 IN 查询替代循环查询
    const users = await User.findAll({
      where: { id: { [Op.in]: userIds } },
      include: [{
        model: Wallet,
        attributes: ['address', 'balance', 'status']
      }],
      attributes: ['id', 'username', 'email']
    });
    
    return users;
  }
}
```

## 10. 总结

### 10.1 技术架构优势

1. **渐进式升级**: 基于现有技术栈进行优化，降低迁移风险
2. **模块化设计**: 前后端分离，组件化开发，便于维护和扩展
3. **安全保障**: 多层安全防护，满足金融级安全要求
4. **高性能**: 缓存策略、数据库优化、CDN加速
5. **可扩展性**: 微服务架构，支持水平扩展
6. **监控完善**: 全链路监控，实时告警，快速定位问题

### 10.2 实施建议

1. **分阶段实施**: 按模块逐步开发，降低风险
2. **测试驱动**: 完善的测试体系，保证代码质量
3. **文档完善**: 详细的技术文档和API文档
4. **团队培训**: 新技术栈的学习和培训
5. **持续优化**: 根据业务发展持续优化架构

### 10.3 风险控制

1. **技术风险**: 充分的技术调研和POC验证
2. **安全风险**: 多重安全防护和定期安全审计
3. **性能风险**: 压力测试和性能监控
4. **运维风险**: 完善的部署和监控体系

---

**文档版本**: v1.0  
**最后更新**: 2024年12月  
**审核状态**: 待审核